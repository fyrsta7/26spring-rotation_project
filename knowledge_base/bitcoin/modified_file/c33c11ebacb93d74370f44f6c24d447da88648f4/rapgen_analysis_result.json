{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/bitcoin/modified_file/c33c11ebacb93d74370f44f6c24d447da88648f4",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/bitcoin/modified_file/c33c11ebacb93d74370f44f6c24d447da88648f4/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/bitcoin/modified_file/c33c11ebacb93d74370f44f6c24d447da88648f4/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/bitcoin/modified_file/c33c11ebacb93d74370f44f6c24d447da88648f4/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 349,
          "old_api": "GetChance",
          "new_api": "count",
          "old_text": "info.GetChance()",
          "new_text": "mapInfo.count(nId)",
          "old_line_content": "            if (GetRandInt(1 << 30) < fChanceFactor * info.GetChance() * (1 << 30))",
          "new_line_content": "            assert(mapInfo.count(nId) == 1);",
          "content_same": false
        },
        {
          "line": 362,
          "old_api": "count",
          "new_api": "insecure_rand",
          "old_text": "mapInfo.count(nId)",
          "new_text": "insecure_rand()",
          "old_line_content": "            assert(mapInfo.count(nId) == 1);",
          "new_line_content": "                nUBucket = (nUBucket + insecure_rand()) % ADDRMAN_NEW_BUCKET_COUNT;",
          "content_same": false
        },
        {
          "line": 418,
          "old_api": "GetBucketPosition",
          "new_api": "count",
          "old_text": "mapInfo[vvTried[n][i]].GetBucketPosition(nKey, false, n)",
          "new_text": "setTried.count(vvTried[n][i])",
          "old_line_content": "                 if (mapInfo[vvTried[n][i]].GetBucketPosition(nKey, false, n) != i)",
          "new_line_content": "                 if (!setTried.count(vvTried[n][i]))",
          "content_same": false
        },
        {
          "line": 420,
          "old_api": "erase",
          "new_api": "GetTriedBucket",
          "old_text": "setTried.erase(vvTried[n][i])",
          "new_text": "mapInfo[vvTried[n][i]].GetTriedBucket(nKey)",
          "old_line_content": "                 setTried.erase(vvTried[n][i]);",
          "new_line_content": "                 if (mapInfo[vvTried[n][i]].GetTriedBucket(nKey) != n)",
          "content_same": false
        },
        {
          "line": 442,
          "old_api": "IsNull",
          "new_api": "size",
          "old_text": "nKey.IsNull()",
          "new_text": "setTried.size()",
          "old_line_content": "    if (nKey.IsNull())",
          "new_line_content": "    if (setTried.size())",
          "content_same": false
        },
        {
          "line": 461,
          "old_api": "SwapRandom",
          "new_api": "size",
          "old_text": "SwapRandom(n, nRndPos)",
          "new_text": "vAddr.size()",
          "old_line_content": "        SwapRandom(n, nRndPos);",
          "new_line_content": "        if (vAddr.size() >= nNodes)",
          "content_same": false
        },
        {
          "line": 465,
          "old_api": "IsTerrible",
          "new_api": "SwapRandom",
          "old_text": "ai.IsTerrible()",
          "new_text": "SwapRandom(n, nRndPos)",
          "old_line_content": "        if (!ai.IsTerrible())",
          "new_line_content": "        SwapRandom(n, nRndPos);",
          "content_same": false
        },
        {
          "line": 466,
          "old_api": "push_back",
          "new_api": "count",
          "old_text": "vAddr.push_back(ai)",
          "new_text": "mapInfo.count(vRandom[n])",
          "old_line_content": "            vAddr.push_back(ai);",
          "new_line_content": "        assert(mapInfo.count(vRandom[n]) == 1);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 384,
          "old_api": null,
          "new_api": "end",
          "old_text": null,
          "new_text": "mapInfo.end()",
          "old_line_content": "            if (!info.nLastSuccess)",
          "new_line_content": "    for (std::map<int, CAddrInfo>::iterator it = mapInfo.begin(); it != mapInfo.end(); it++) {",
          "content_same": false
        },
        {
          "line": 392,
          "old_api": null,
          "new_api": "insert",
          "old_text": null,
          "new_text": "setTried.insert(n)",
          "old_line_content": "            if (!info.nRefCount)",
          "new_line_content": "            setTried.insert(n);",
          "content_same": false
        },
        {
          "line": 402,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "vRandom.size()",
          "old_line_content": "        if (info.nLastSuccess < 0)",
          "new_line_content": "        if (info.nRandomPos < 0 || info.nRandomPos >= vRandom.size() || vRandom[info.nRandomPos] != n)",
          "content_same": false
        },
        {
          "line": 410,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "setTried.size()",
          "old_line_content": "",
          "new_line_content": "    if (setTried.size() != nTried)",
          "content_same": false
        },
        {
          "line": 412,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "mapNew.size()",
          "old_line_content": "        for (int i = 0; i < ADDRMAN_BUCKET_SIZE; i++) {",
          "new_line_content": "    if (mapNew.size() != nNew)",
          "content_same": false
        },
        {
          "line": 422,
          "old_api": null,
          "new_api": "GetBucketPosition",
          "old_text": null,
          "new_text": "mapInfo[vvTried[n][i]].GetBucketPosition(nKey, false, n)",
          "old_line_content": "        }",
          "new_line_content": "                 if (mapInfo[vvTried[n][i]].GetBucketPosition(nKey, false, n) != i)",
          "content_same": false
        },
        {
          "line": 424,
          "old_api": null,
          "new_api": "erase",
          "old_text": null,
          "new_text": "setTried.erase(vvTried[n][i])",
          "old_line_content": "",
          "new_line_content": "                 setTried.erase(vvTried[n][i]);",
          "content_same": false
        },
        {
          "line": 432,
          "old_api": null,
          "new_api": "count",
          "old_text": null,
          "new_text": "mapNew.count(vvNew[n][i])",
          "old_line_content": "                if (--mapNew[vvNew[n][i]] == 0)",
          "new_line_content": "                if (!mapNew.count(vvNew[n][i]))",
          "content_same": false
        },
        {
          "line": 434,
          "old_api": null,
          "new_api": "GetBucketPosition",
          "old_text": null,
          "new_text": "mapInfo[vvNew[n][i]].GetBucketPosition(nKey, true, n)",
          "old_line_content": "            }",
          "new_line_content": "                if (mapInfo[vvNew[n][i]].GetBucketPosition(nKey, true, n) != i)",
          "content_same": false
        },
        {
          "line": 437,
          "old_api": null,
          "new_api": "erase",
          "old_text": null,
          "new_text": "mapNew.erase(vvNew[n][i])",
          "old_line_content": "",
          "new_line_content": "                    mapNew.erase(vvNew[n][i]);",
          "content_same": false
        },
        {
          "line": 444,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "mapNew.size()",
          "old_line_content": "",
          "new_line_content": "    if (mapNew.size())",
          "content_same": false
        },
        {
          "line": 446,
          "old_api": null,
          "new_api": "IsNull",
          "old_text": null,
          "new_text": "nKey.IsNull()",
          "old_line_content": "}",
          "new_line_content": "    if (nKey.IsNull())",
          "content_same": false
        },
        {
          "line": 455,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "vRandom.size()",
          "old_line_content": "    // gather a list of random nodes, skipping those of low quality",
          "new_line_content": "    unsigned int nNodes = ADDRMAN_GETADDR_MAX_PCT * vRandom.size() / 100;",
          "content_same": false
        },
        {
          "line": 464,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "vRandom.size()",
          "old_line_content": "        const CAddrInfo& ai = mapInfo[vRandom[n]];",
          "new_line_content": "        int nRndPos = GetRandInt(vRandom.size() - n) + n;",
          "content_same": false
        },
        {
          "line": 469,
          "old_api": null,
          "new_api": "IsTerrible",
          "old_text": null,
          "new_text": "ai.IsTerrible()",
          "old_line_content": "",
          "new_line_content": "        if (!ai.IsTerrible())",
          "content_same": false
        },
        {
          "line": 470,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "vAddr.push_back(ai)",
          "old_line_content": "void CAddrMan::Connected_(const CService& addr, int64_t nTime)",
          "new_line_content": "            vAddr.push_back(ai);",
          "content_same": false
        },
        {
          "line": 345,
          "old_api": null,
          "new_api": "insecure_rand",
          "old_text": null,
          "new_text": "insecure_rand()",
          "old_line_content": "                continue;",
          "new_line_content": "                nKBucket = (nKBucket + insecure_rand()) % ADDRMAN_TRIED_BUCKET_COUNT;",
          "content_same": false
        },
        {
          "line": 346,
          "old_api": null,
          "new_api": "insecure_rand",
          "old_text": null,
          "new_text": "insecure_rand()",
          "old_line_content": "            int nId = vvTried[nKBucket][nKBucketPos];",
          "new_line_content": "                nKBucketPos = (nKBucketPos + insecure_rand()) % ADDRMAN_BUCKET_SIZE;",
          "content_same": false
        },
        {
          "line": 476,
          "old_api": null,
          "new_api": "Find",
          "old_text": null,
          "new_text": "Find(addr)",
          "old_line_content": "        return;",
          "new_line_content": "    CAddrInfo* pinfo = Find(addr);",
          "content_same": false
        },
        {
          "line": 351,
          "old_api": null,
          "new_api": "GetChance",
          "old_text": null,
          "new_text": "info.GetChance()",
          "old_line_content": "            fChanceFactor *= 1.2;",
          "new_line_content": "            if (GetRandInt(1 << 30) < fChanceFactor * info.GetChance() * (1 << 30))",
          "content_same": false
        },
        {
          "line": 359,
          "old_api": null,
          "new_api": "GetRandInt",
          "old_text": null,
          "new_text": "GetRandInt(ADDRMAN_NEW_BUCKET_COUNT)",
          "old_line_content": "            if (vvNew[nUBucket][nUBucketPos] == -1)",
          "new_line_content": "            int nUBucket = GetRandInt(ADDRMAN_NEW_BUCKET_COUNT);",
          "content_same": false
        },
        {
          "line": 360,
          "old_api": null,
          "new_api": "GetRandInt",
          "old_text": null,
          "new_text": "GetRandInt(ADDRMAN_BUCKET_SIZE)",
          "old_line_content": "                continue;",
          "new_line_content": "            int nUBucketPos = GetRandInt(ADDRMAN_BUCKET_SIZE);",
          "content_same": false
        },
        {
          "line": 363,
          "old_api": null,
          "new_api": "insecure_rand",
          "old_text": null,
          "new_text": "insecure_rand()",
          "old_line_content": "            CAddrInfo& info = mapInfo[nId];",
          "new_line_content": "                nUBucketPos = (nUBucketPos + insecure_rand()) % ADDRMAN_BUCKET_SIZE;",
          "content_same": false
        },
        {
          "line": 366,
          "old_api": null,
          "new_api": "count",
          "old_text": null,
          "new_text": "mapInfo.count(nId)",
          "old_line_content": "            fChanceFactor *= 1.2;",
          "new_line_content": "            assert(mapInfo.count(nId) == 1);",
          "content_same": false
        },
        {
          "line": 368,
          "old_api": null,
          "new_api": "GetChance",
          "old_text": null,
          "new_text": "info.GetChance()",
          "old_line_content": "    }",
          "new_line_content": "            if (GetRandInt(1 << 30) < fChanceFactor * info.GetChance() * (1 << 30))",
          "content_same": false
        },
        {
          "line": 381,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "vRandom.size()",
          "old_line_content": "        int n = (*it).first;",
          "new_line_content": "    if (vRandom.size() != nTried + nNew)",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 388,
          "old_api": "insert",
          "new_api": null,
          "old_text": "setTried.insert(n)",
          "new_text": null,
          "old_line_content": "            setTried.insert(n);",
          "new_line_content": "            if (!info.nLastSuccess)",
          "content_same": false
        },
        {
          "line": 398,
          "old_api": "size",
          "new_api": null,
          "old_text": "vRandom.size()",
          "new_text": null,
          "old_line_content": "        if (info.nRandomPos < 0 || info.nRandomPos >= vRandom.size() || vRandom[info.nRandomPos] != n)",
          "new_line_content": "            mapNew[n] = info.nRefCount;",
          "content_same": false
        },
        {
          "line": 406,
          "old_api": "size",
          "new_api": null,
          "old_text": "setTried.size()",
          "new_text": null,
          "old_line_content": "    if (setTried.size() != nTried)",
          "new_line_content": "        if (info.nLastSuccess < 0)",
          "content_same": false
        },
        {
          "line": 408,
          "old_api": "size",
          "new_api": null,
          "old_text": "mapNew.size()",
          "new_text": null,
          "old_line_content": "    if (mapNew.size() != nNew)",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 414,
          "old_api": "count",
          "new_api": null,
          "old_text": "setTried.count(vvTried[n][i])",
          "new_text": null,
          "old_line_content": "                 if (!setTried.count(vvTried[n][i]))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 416,
          "old_api": "GetTriedBucket",
          "new_api": null,
          "old_text": "mapInfo[vvTried[n][i]].GetTriedBucket(nKey)",
          "new_text": null,
          "old_line_content": "                 if (mapInfo[vvTried[n][i]].GetTriedBucket(nKey) != n)",
          "new_line_content": "        for (int i = 0; i < ADDRMAN_BUCKET_SIZE; i++) {",
          "content_same": false
        },
        {
          "line": 428,
          "old_api": "count",
          "new_api": null,
          "old_text": "mapNew.count(vvNew[n][i])",
          "new_text": null,
          "old_line_content": "                if (!mapNew.count(vvNew[n][i]))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 430,
          "old_api": "GetBucketPosition",
          "new_api": null,
          "old_text": "mapInfo[vvNew[n][i]].GetBucketPosition(nKey, true, n)",
          "new_text": null,
          "old_line_content": "                if (mapInfo[vvNew[n][i]].GetBucketPosition(nKey, true, n) != i)",
          "new_line_content": "        for (int i = 0; i < ADDRMAN_BUCKET_SIZE; i++) {",
          "content_same": false
        },
        {
          "line": 433,
          "old_api": "erase",
          "new_api": null,
          "old_text": "mapNew.erase(vvNew[n][i])",
          "new_text": null,
          "old_line_content": "                    mapNew.erase(vvNew[n][i]);",
          "new_line_content": "                    return -12;",
          "content_same": false
        },
        {
          "line": 438,
          "old_api": "size",
          "new_api": null,
          "old_text": "setTried.size()",
          "new_text": null,
          "old_line_content": "    if (setTried.size())",
          "new_line_content": "            }",
          "content_same": false
        },
        {
          "line": 440,
          "old_api": "size",
          "new_api": null,
          "old_text": "mapNew.size()",
          "new_text": null,
          "old_line_content": "    if (mapNew.size())",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 451,
          "old_api": "size",
          "new_api": null,
          "old_text": "vRandom.size()",
          "new_text": null,
          "old_line_content": "    unsigned int nNodes = ADDRMAN_GETADDR_MAX_PCT * vRandom.size() / 100;",
          "new_line_content": "#endif",
          "content_same": false
        },
        {
          "line": 456,
          "old_api": "size",
          "new_api": null,
          "old_text": "vRandom.size()",
          "new_text": null,
          "old_line_content": "    for (unsigned int n = 0; n < vRandom.size(); n++) {",
          "new_line_content": "    if (nNodes > ADDRMAN_GETADDR_MAX)",
          "content_same": false
        },
        {
          "line": 457,
          "old_api": "size",
          "new_api": null,
          "old_text": "vAddr.size()",
          "new_text": null,
          "old_line_content": "        if (vAddr.size() >= nNodes)",
          "new_line_content": "        nNodes = ADDRMAN_GETADDR_MAX;",
          "content_same": false
        },
        {
          "line": 462,
          "old_api": "count",
          "new_api": null,
          "old_text": "mapInfo.count(vRandom[n])",
          "new_text": null,
          "old_line_content": "        assert(mapInfo.count(vRandom[n]) == 1);",
          "new_line_content": "            break;",
          "content_same": false
        },
        {
          "line": 472,
          "old_api": "Find",
          "new_api": null,
          "old_text": "Find(addr)",
          "new_text": null,
          "old_line_content": "    CAddrInfo* pinfo = Find(addr);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 347,
          "old_api": "count",
          "new_api": null,
          "old_text": "mapInfo.count(nId)",
          "new_text": null,
          "old_line_content": "            assert(mapInfo.count(nId) == 1);",
          "new_line_content": "            }",
          "content_same": false
        },
        {
          "line": 357,
          "old_api": "GetRandInt",
          "new_api": null,
          "old_text": "GetRandInt(ADDRMAN_NEW_BUCKET_COUNT)",
          "new_text": null,
          "old_line_content": "            int nUBucket = GetRandInt(ADDRMAN_NEW_BUCKET_COUNT);",
          "new_line_content": "        double fChanceFactor = 1.0;",
          "content_same": false
        },
        {
          "line": 358,
          "old_api": "GetRandInt",
          "new_api": null,
          "old_text": "GetRandInt(ADDRMAN_BUCKET_SIZE)",
          "new_text": null,
          "old_line_content": "            int nUBucketPos = GetRandInt(ADDRMAN_BUCKET_SIZE);",
          "new_line_content": "        while (1) {",
          "content_same": false
        },
        {
          "line": 364,
          "old_api": "GetChance",
          "new_api": null,
          "old_text": "info.GetChance()",
          "new_text": null,
          "old_line_content": "            if (GetRandInt(1 << 30) < fChanceFactor * info.GetChance() * (1 << 30))",
          "new_line_content": "            }",
          "content_same": false
        },
        {
          "line": 377,
          "old_api": "size",
          "new_api": null,
          "old_text": "vRandom.size()",
          "new_text": null,
          "old_line_content": "    if (vRandom.size() != nTried + nNew)",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 380,
          "old_api": "end",
          "new_api": null,
          "old_text": "mapInfo.end()",
          "new_text": null,
          "old_line_content": "    for (std::map<int, CAddrInfo>::iterator it = mapInfo.begin(); it != mapInfo.end(); it++) {",
          "new_line_content": "",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 8,
      "total_additions": 26,
      "total_deletions": 22,
      "total_api_changes": 56
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 10,
        "api_related_lines": 56,
        "non_api_lines": 2,
        "non_api_line_numbers": [
          344,
          361
        ]
      }
    },
    "api_calls_before": 120,
    "api_calls_after": 124,
    "diff_info": {
      "added_lines": 8,
      "removed_lines": 4,
      "total_diff_lines": 31
    }
  }
}