{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/85bc0de2fb1a3140dfc115b8126e143f722ef58c",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/85bc0de2fb1a3140dfc115b8126e143f722ef58c/before.h",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/85bc0de2fb1a3140dfc115b8126e143f722ef58c/after.h",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/85bc0de2fb1a3140dfc115b8126e143f722ef58c/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [],
      "additions": [
        {
          "line": 160,
          "old_api": null,
          "new_api": "slow",
          "old_text": null,
          "new_text": "slow(v)",
          "old_line_content": "    return instance;",
          "new_line_content": "    FOLLY_LIKELY(!!cache) ? mutate(v, {cache, true}) : slow(v);",
          "content_same": false
        },
        {
          "line": 217,
          "old_api": null,
          "new_api": "Counter::sub(1)",
          "old_text": null,
          "new_text": "Counter::sub(1)",
          "old_line_content": "",
          "new_line_content": "    Counter::sub(1);",
          "content_same": false
        },
        {
          "line": 166,
          "old_api": null,
          "new_api": "thread_local",
          "old_text": null,
          "new_text": "thread_local",
          "old_line_content": "  }",
          "new_line_content": "    static thread_local CounterAndCache instance;",
          "content_same": false
        },
        {
          "line": 171,
          "old_api": null,
          "new_api": "thread_local",
          "old_text": null,
          "new_text": "thread_local",
          "old_line_content": "    }",
          "new_line_content": "    static thread_local LocalLifetime lifetime;",
          "content_same": false
        },
        {
          "line": 187,
          "old_api": null,
          "new_api": "counterSlow",
          "old_text": null,
          "new_text": "counterSlow(state)",
          "old_line_content": "template <typename Counted>",
          "new_line_content": "    auto const counter = FOLLY_LIKELY(!!cache) ? cache : counterSlow(state);",
          "content_same": false
        },
        {
          "line": 176,
          "old_api": null,
          "new_api": "threadlocal_detail::StaticMetaBase::dying()",
          "old_text": null,
          "new_text": "threadlocal_detail::StaticMetaBase::dying()",
          "old_line_content": "",
          "new_line_content": "    if (threadlocal_detail::StaticMetaBase::dying()) {",
          "content_same": false
        },
        {
          "line": 177,
          "old_api": null,
          "new_api": "Global::instance()",
          "old_text": null,
          "new_text": "Global::instance()",
          "old_line_content": "  FOLLY_ALWAYS_INLINE static CounterRefAndLocal counter() {",
          "new_line_content": "      return &Global::instance().fallback;",
          "content_same": false
        },
        {
          "line": 179,
          "old_api": null,
          "new_api": "track",
          "old_text": null,
          "new_text": "lifetime().track(state)",
          "old_line_content": "    auto const cache = state.cache; // a copy! null before/after LocalLifetime",
          "new_line_content": "    lifetime().track(state); // idempotent",
          "content_same": false
        },
        {
          "line": 148,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "c.load(std::memory_order_relaxed)",
          "old_line_content": "      // splitting load/store on the local counter is faster than fetch-and-add",
          "new_line_content": "      c.store(c.load(std::memory_order_relaxed) + v, std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 181,
          "old_api": null,
          "new_api": "Global::instance()",
          "old_text": null,
          "new_text": "Global::instance()",
          "old_line_content": "    // cache is a stale nullptr after the first call to counterSlow(); this is",
          "new_line_content": "    return FOLLY_LIKELY(!!cache) ? cache : &Global::instance().fallback;",
          "content_same": false
        },
        {
          "line": 212,
          "old_api": null,
          "new_api": "Counter::add(1)",
          "old_text": null,
          "new_text": "Counter::add(1)",
          "old_line_content": "",
          "new_line_content": "    Counter::add(1);",
          "content_same": false
        },
        {
          "line": 151,
          "old_api": null,
          "new_api": "fetch_add",
          "old_text": null,
          "new_text": "c.fetch_add(v, std::memory_order_relaxed)",
          "old_line_content": "      // but is not allowed on the global counter because mutations may be lost",
          "new_line_content": "      c.fetch_add(v, std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 244,
          "old_api": null,
          "new_api": "SingletonRelaxedCountable<Counted>::Counter::count()",
          "old_text": null,
          "new_text": "SingletonRelaxedCountable<Counted>::Counter::count()",
          "old_line_content": "",
          "new_line_content": "    return SingletonRelaxedCountable<Counted>::Counter::count();",
          "content_same": false
        },
        {
          "line": 185,
          "old_api": null,
          "new_api": "local",
          "old_text": null,
          "new_text": "local()",
          "old_line_content": "};",
          "new_line_content": "    auto& state = local();",
          "content_same": false
        },
        {
          "line": 155,
          "old_api": null,
          "new_api": "counter",
          "old_text": null,
          "new_text": "counter()",
          "old_line_content": "",
          "new_line_content": "  FOLLY_NOINLINE static void mutate_slow(Signed v) { mutate(v, counter()); }",
          "content_same": false
        },
        {
          "line": 158,
          "old_api": null,
          "new_api": "local",
          "old_text": null,
          "new_text": "local()",
          "old_line_content": "    // https://gcc.gnu.org/bugzilla/show_bug.cgi?id=66944",
          "new_line_content": "    auto const cache = local().cache; // a copy! null before/after LocalLifetime",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 164,
          "old_api": "thread_local",
          "new_api": null,
          "old_text": "thread_local",
          "new_text": null,
          "old_line_content": "    static thread_local LocalLifetime lifetime;",
          "new_line_content": "    // this is a member function local instead of a class member because of",
          "content_same": false
        },
        {
          "line": 169,
          "old_api": "threadlocal_detail::StaticMetaBase::dying()",
          "new_api": null,
          "old_text": "threadlocal_detail::StaticMetaBase::dying()",
          "new_text": null,
          "old_line_content": "    if (threadlocal_detail::StaticMetaBase::dying()) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 170,
          "old_api": "Global::instance()",
          "new_api": null,
          "old_text": "Global::instance()",
          "new_text": null,
          "old_line_content": "      return &Global::instance().fallback;",
          "new_line_content": "  FOLLY_EXPORT FOLLY_ALWAYS_INLINE static LocalLifetime& lifetime() {",
          "content_same": false
        },
        {
          "line": 172,
          "old_api": "track",
          "new_api": null,
          "old_text": "lifetime().track(state)",
          "new_text": null,
          "old_line_content": "    lifetime().track(state); // idempotent",
          "new_line_content": "    return lifetime;",
          "content_same": false
        },
        {
          "line": 205,
          "old_api": "Counter::add(1)",
          "new_api": null,
          "old_text": "Counter::add(1)",
          "new_text": null,
          "old_line_content": "    Counter::add(1);",
          "new_line_content": "//  This type is a convenience interface around SingletonRelaxedCounter.",
          "content_same": false
        },
        {
          "line": 174,
          "old_api": "Global::instance()",
          "new_api": null,
          "old_text": "Global::instance()",
          "new_text": null,
          "old_line_content": "    return FOLLY_LIKELY(!!cache) ? cache : &Global::instance().fallback;",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 237,
          "old_api": "SingletonRelaxedCountable<Counted>::Counter::count()",
          "new_api": null,
          "old_text": "SingletonRelaxedCountable<Counted>::Counter::count()",
          "new_text": null,
          "old_line_content": "    return SingletonRelaxedCountable<Counted>::Counter::count();",
          "new_line_content": "//",
          "content_same": false
        },
        {
          "line": 145,
          "old_api": "counter",
          "new_api": null,
          "old_text": "counter()",
          "new_text": null,
          "old_line_content": "    auto cl = counter();",
          "new_line_content": "    auto& c = *cl.counter;",
          "content_same": false
        },
        {
          "line": 178,
          "old_api": "local",
          "new_api": null,
          "old_text": "local()",
          "new_text": null,
          "old_line_content": "    auto& state = local();",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 210,
          "old_api": "Counter::sub(1)",
          "new_api": null,
          "old_text": "Counter::sub(1)",
          "new_text": null,
          "old_line_content": "    Counter::sub(1);",
          "new_line_content": "    static_assert(",
          "content_same": false
        },
        {
          "line": 180,
          "old_api": "counterSlow",
          "new_api": null,
          "old_text": "counterSlow(state)",
          "new_text": null,
          "old_line_content": "    auto const counter = FOLLY_LIKELY(!!cache) ? cache : counterSlow(state);",
          "new_line_content": "    auto const cache = state.cache;",
          "content_same": false
        },
        {
          "line": 149,
          "old_api": "load",
          "new_api": null,
          "old_text": "c.load(std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "      c.store(c.load(std::memory_order_relaxed) + v, std::memory_order_relaxed);",
          "new_line_content": "    } else {",
          "content_same": false
        },
        {
          "line": 152,
          "old_api": "fetch_add",
          "new_api": null,
          "old_text": "c.fetch_add(v, std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "      c.fetch_add(v, std::memory_order_relaxed);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 159,
          "old_api": "thread_local",
          "new_api": null,
          "old_text": "thread_local",
          "new_text": null,
          "old_line_content": "    static thread_local CounterAndCache instance;",
          "new_line_content": "    // fun-ref to trick compiler into emitting a tail call",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 0,
      "total_additions": 16,
      "total_deletions": 14,
      "total_api_changes": 30
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 10,
        "api_related_lines": 30,
        "non_api_lines": 5,
        "non_api_line_numbers": [
          161,
          162,
          144,
          156,
          157
        ]
      }
    },
    "api_calls_before": 29,
    "api_calls_after": 34,
    "diff_info": {
      "added_lines": 9,
      "removed_lines": 2,
      "total_diff_lines": 30
    }
  }
}