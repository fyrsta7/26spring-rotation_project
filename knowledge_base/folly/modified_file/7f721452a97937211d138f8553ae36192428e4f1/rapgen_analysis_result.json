{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/7f721452a97937211d138f8553ae36192428e4f1",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/7f721452a97937211d138f8553ae36192428e4f1/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/7f721452a97937211d138f8553ae36192428e4f1/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/7f721452a97937211d138f8553ae36192428e4f1/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 190,
          "old_api": "get",
          "new_api": "getStaticContext",
          "old_text": "newCtx.get()",
          "new_text": "getStaticContext()",
          "old_line_content": "      folly, request_context_switch_before, staticCtx.get(), newCtx.get());",
          "new_line_content": "  auto& staticCtx = getStaticContext();",
          "content_same": false
        },
        {
          "line": 195,
          "old_api": "rlock",
          "new_api": "get",
          "old_text": "newCtx->state_.rlock()",
          "new_text": "FOLLY_SDT(\n      folly, request_context_switch_before, staticCtx.get(), newCtx.get())",
          "old_line_content": "    auto newLock = newCtx->state_.rlock();",
          "new_line_content": "  FOLLY_SDT(",
          "content_same": false
        },
        {
          "line": 196,
          "old_api": "rlock",
          "new_api": "get",
          "old_text": "curCtx->state_.rlock()",
          "new_text": "newCtx.get()",
          "old_line_content": "    auto curLock = curCtx->state_.rlock();",
          "new_line_content": "      folly, request_context_switch_before, staticCtx.get(), newCtx.get());",
          "content_same": false
        },
        {
          "line": 202,
          "old_api": "onSet",
          "new_api": "rlock",
          "old_text": "exec_set_difference(\n        newData, curData, [](RequestData* data) { data->onSet(); })",
          "new_text": "curCtx->state_.rlock()",
          "old_line_content": "    exec_set_difference(",
          "new_line_content": "    auto curLock = curCtx->state_.rlock();",
          "content_same": false
        },
        {
          "line": 224,
          "old_api": "std::make_shared<RequestContext>()",
          "new_api": "SingletonT::get()",
          "old_text": "std::make_shared<RequestContext>()",
          "new_text": "SingletonT::get()",
          "old_line_content": "  auto child = std::make_shared<RequestContext>();",
          "new_line_content": "  return SingletonT::get();",
          "content_same": false
        },
        {
          "line": 230,
          "old_api": "size",
          "new_api": "std::make_shared<RequestContext>()",
          "old_text": "parentLock->requestData_.size()",
          "new_text": "std::make_shared<RequestContext>()",
          "old_line_content": "    childLock->requestData_.reserve(parentLock->requestData_.size());",
          "new_line_content": "  auto child = std::make_shared<RequestContext>();",
          "content_same": false
        },
        {
          "line": 233,
          "old_api": "get",
          "new_api": "rlock",
          "old_text": "entry.second.get()",
          "new_text": "parent->state_.rlock()",
          "old_line_content": "          entry.first, RequestData::constructPtr(entry.second.get())));",
          "new_line_content": "    auto parentLock = parent->state_.rlock();",
          "content_same": false
        },
        {
          "line": 238,
          "old_api": "std::swap(child, parent)",
          "new_api": "get",
          "old_text": "std::swap(child, parent)",
          "new_text": "std::make_pair(\n          entry.first, RequestData::constructPtr(entry.second.get()))",
          "old_line_content": "  std::swap(child, parent);",
          "new_line_content": "      childLock->requestData_.insert(std::make_pair(",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 229,
          "old_api": null,
          "new_api": "getStaticContext",
          "old_text": null,
          "new_text": "getStaticContext()",
          "old_line_content": "    childLock->callbackData_ = parentLock->callbackData_;",
          "new_line_content": "  auto& parent = getStaticContext();",
          "content_same": false
        },
        {
          "line": 201,
          "old_api": null,
          "new_api": "rlock",
          "old_text": null,
          "new_text": "newCtx->state_.rlock()",
          "old_line_content": "    staticCtx = newCtx;",
          "new_line_content": "    auto newLock = newCtx->state_.rlock();",
          "content_same": false
        },
        {
          "line": 234,
          "old_api": null,
          "new_api": "wlock",
          "old_text": null,
          "new_text": "child->state_.wlock()",
          "old_line_content": "    }",
          "new_line_content": "    auto childLock = child->state_.wlock();",
          "content_same": false
        },
        {
          "line": 236,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "parentLock->requestData_.size()",
          "old_line_content": "",
          "new_line_content": "    childLock->requestData_.reserve(parentLock->requestData_.size());",
          "content_same": false
        },
        {
          "line": 205,
          "old_api": null,
          "new_api": "onUnset",
          "old_text": null,
          "new_text": "exec_set_difference(\n        curData, newData, [](RequestData* data) { data->onUnset(); })",
          "old_line_content": "    if (curCtx) {",
          "new_line_content": "    exec_set_difference(",
          "content_same": false
        },
        {
          "line": 173,
          "old_api": null,
          "new_api": "exec",
          "old_text": null,
          "new_text": "exec(*diter)",
          "old_line_content": "      ++oiter;",
          "new_line_content": "      exec(*diter);",
          "content_same": false
        },
        {
          "line": 239,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "entry.second.get()",
          "old_line_content": "  return child;",
          "new_line_content": "          entry.first, RequestData::constructPtr(entry.second.get())));",
          "content_same": false
        },
        {
          "line": 208,
          "old_api": null,
          "new_api": "onSet",
          "old_text": null,
          "new_text": "exec_set_difference(\n        newData, curData, [](RequestData* data) { data->onSet(); })",
          "old_line_content": "    staticCtx = newCtx;",
          "new_line_content": "    exec_set_difference(",
          "content_same": false
        },
        {
          "line": 209,
          "old_api": null,
          "new_api": "onSet",
          "old_text": null,
          "new_text": "data->onSet()",
          "old_line_content": "    if (newCtx) {",
          "new_line_content": "        newData, curData, [](RequestData* data) { data->onSet(); });",
          "content_same": false
        },
        {
          "line": 179,
          "old_api": null,
          "new_api": "exec",
          "old_text": null,
          "new_text": "exec(*diter)",
          "old_line_content": "}",
          "new_line_content": "      exec(*diter);",
          "content_same": false
        },
        {
          "line": 212,
          "old_api": null,
          "new_api": "onUnset",
          "old_text": null,
          "new_text": "curCtx->onUnset()",
          "old_line_content": "  }",
          "new_line_content": "      curCtx->onUnset();",
          "content_same": false
        },
        {
          "line": 244,
          "old_api": null,
          "new_api": "std::swap(child, parent)",
          "old_text": null,
          "new_text": "std::swap(child, parent)",
          "old_line_content": "  if (!context) {",
          "new_line_content": "  std::swap(child, parent);",
          "content_same": false
        },
        {
          "line": 216,
          "old_api": null,
          "new_api": "onSet",
          "old_text": null,
          "new_text": "newCtx->onSet()",
          "old_line_content": "std::shared_ptr<RequestContext>& RequestContext::getStaticContext() {",
          "new_line_content": "      newCtx->onSet();",
          "content_same": false
        },
        {
          "line": 249,
          "old_api": null,
          "new_api": "getStaticContext",
          "old_text": null,
          "new_text": "getStaticContext()",
          "old_line_content": "}",
          "new_line_content": "  auto& context = getStaticContext();",
          "content_same": false
        },
        {
          "line": 252,
          "old_api": null,
          "new_api": "std::addressof(defaultContext)",
          "old_text": null,
          "new_text": "std::addressof(defaultContext)",
          "old_line_content": "",
          "new_line_content": "    return std::addressof(defaultContext);",
          "content_same": false
        },
        {
          "line": 254,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "context.get()",
          "old_line_content": "",
          "new_line_content": "  return context.get();",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 248,
          "old_api": "get",
          "new_api": null,
          "old_text": "context.get()",
          "new_text": null,
          "old_line_content": "  return context.get();",
          "new_line_content": "RequestContext* RequestContext::get() {",
          "content_same": false
        },
        {
          "line": 227,
          "old_api": "rlock",
          "new_api": null,
          "old_text": "parent->state_.rlock()",
          "new_text": null,
          "old_line_content": "    auto parentLock = parent->state_.rlock();",
          "new_line_content": "/* static */ std::shared_ptr<RequestContext>",
          "content_same": false
        },
        {
          "line": 228,
          "old_api": "wlock",
          "new_api": null,
          "old_text": "child->state_.wlock()",
          "new_text": null,
          "old_line_content": "    auto childLock = child->state_.wlock();",
          "new_line_content": "RequestContext::setShallowCopyContext() {",
          "content_same": false
        },
        {
          "line": 199,
          "old_api": "onUnset",
          "new_api": null,
          "old_text": "exec_set_difference(\n        curData, newData, [](RequestData* data) { data->onUnset(); })",
          "new_text": null,
          "old_line_content": "    exec_set_difference(",
          "new_line_content": "  if (newCtx && curCtx) {",
          "content_same": false
        },
        {
          "line": 200,
          "old_api": "onUnset",
          "new_api": null,
          "old_text": "data->onUnset()",
          "new_text": null,
          "old_line_content": "        curData, newData, [](RequestData* data) { data->onUnset(); });",
          "new_line_content": "    // Only call set/unset for all request data that differs",
          "content_same": false
        },
        {
          "line": 232,
          "old_api": "get",
          "new_api": null,
          "old_text": "std::make_pair(\n          entry.first, RequestData::constructPtr(entry.second.get()))",
          "new_text": null,
          "old_line_content": "      childLock->requestData_.insert(std::make_pair(",
          "new_line_content": "  if (parent) {",
          "content_same": false
        },
        {
          "line": 170,
          "old_api": "exec",
          "new_api": null,
          "old_text": "exec(*diter)",
          "new_text": null,
          "old_line_content": "      exec(*diter);",
          "new_line_content": "    // 1) empty other, switching to default context",
          "content_same": false
        },
        {
          "line": 203,
          "old_api": "onSet",
          "new_api": null,
          "old_text": "data->onSet()",
          "new_text": null,
          "old_line_content": "        newData, curData, [](RequestData* data) { data->onSet(); });",
          "new_line_content": "    auto& newData = newLock->callbackData_;",
          "content_same": false
        },
        {
          "line": 210,
          "old_api": "onSet",
          "new_api": null,
          "old_text": "newCtx->onSet()",
          "new_text": null,
          "old_line_content": "      newCtx->onSet();",
          "new_line_content": "  } else {",
          "content_same": false
        },
        {
          "line": 243,
          "old_api": "getStaticContext",
          "new_api": null,
          "old_text": "getStaticContext()",
          "new_text": null,
          "old_line_content": "  auto& context = getStaticContext();",
          "new_line_content": "  // Do not use setContext to avoid global set/unset",
          "content_same": false
        },
        {
          "line": 246,
          "old_api": "std::addressof(defaultContext)",
          "new_api": null,
          "old_text": "std::addressof(defaultContext)",
          "new_text": null,
          "old_line_content": "    return std::addressof(defaultContext);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 184,
          "old_api": "getStaticContext",
          "new_api": null,
          "old_text": "getStaticContext()",
          "new_text": null,
          "old_line_content": "  auto& staticCtx = getStaticContext();",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 218,
          "old_api": "SingletonT::get()",
          "new_api": null,
          "old_text": "SingletonT::get()",
          "new_text": null,
          "old_line_content": "  return SingletonT::get();",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 189,
          "old_api": "get",
          "new_api": null,
          "old_text": "FOLLY_SDT(\n      folly, request_context_switch_before, staticCtx.get(), newCtx.get())",
          "new_text": null,
          "old_line_content": "  FOLLY_SDT(",
          "new_line_content": "    std::shared_ptr<RequestContext> newCtx) {",
          "content_same": false
        },
        {
          "line": 223,
          "old_api": "getStaticContext",
          "new_api": null,
          "old_text": "getStaticContext()",
          "new_text": null,
          "old_line_content": "  auto& parent = getStaticContext();",
          "new_line_content": "  using SingletonT = SingletonThreadLocal<std::shared_ptr<RequestContext>>;",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 8,
      "total_additions": 16,
      "total_deletions": 15,
      "total_api_changes": 39
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 10,
        "api_related_lines": 39,
        "non_api_lines": 8,
        "non_api_line_numbers": [
          169,
          171,
          172,
          174,
          175,
          176,
          178,
          181
        ]
      }
    },
    "api_calls_before": 78,
    "api_calls_after": 79,
    "diff_info": {
      "added_lines": 9,
      "removed_lines": 3,
      "total_diff_lines": 28
    }
  }
}