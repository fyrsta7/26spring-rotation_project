{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/4e34617690866005b42031376c093b4a3fd970c3",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/4e34617690866005b42031376c093b4a3fd970c3/before.h",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/4e34617690866005b42031376c093b4a3fd970c3/after.h",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/folly/modified_file/4e34617690866005b42031376c093b4a3fd970c3/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 306,
          "old_api": "word_type",
          "new_api": "__builtin_constant_p",
          "old_text": "word_type(bit)",
          "new_text": "__builtin_constant_p(adjust)",
          "old_line_content": "  return op(reinterpret_cast<word_type*>(address), word_type(bit), order);",
          "new_line_content": "  if (!__builtin_constant_p(adjust)) {",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 385,
          "old_api": null,
          "new_api": "atomic_fetch_bit_op_native_",
          "old_text": null,
          "new_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "old_line_content": "bool atomic_fetch_reset_native(",
          "new_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "content_same": false
        },
        {
          "line": 393,
          "old_api": null,
          "new_api": "atomic_fetch_reset_fallback",
          "old_text": null,
          "new_text": "atomic_fetch_reset_fallback(atomic, bit, order)",
          "old_line_content": "    std::atomic<Integer>& atomic, std::size_t bit, std::memory_order order) {",
          "new_line_content": "  return atomic_fetch_reset_fallback(atomic, bit, order);",
          "content_same": false
        },
        {
          "line": 401,
          "old_api": null,
          "new_api": "atomic_fetch_bit_op_native_",
          "old_text": null,
          "new_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "old_line_content": "    atomic_ref<Integer>& atomic, std::size_t bit, std::memory_order order) {",
          "new_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "content_same": false
        },
        {
          "line": 407,
          "old_api": null,
          "new_api": "atomic",
          "old_text": null,
          "new_text": "atomic.atomic()",
          "old_line_content": "inline bool atomic_fetch_flip_native(",
          "new_line_content": "  return atomic_fetch_flip_native(atomic.atomic(), bit, order);",
          "content_same": false
        },
        {
          "line": 418,
          "old_api": null,
          "new_api": "atomic_fetch_bit_op_native_",
          "old_text": null,
          "new_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "old_line_content": "bool atomic_fetch_flip_native(",
          "new_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "content_same": false
        },
        {
          "line": 426,
          "old_api": null,
          "new_api": "atomic_fetch_flip_fallback",
          "old_text": null,
          "new_text": "atomic_fetch_flip_fallback(atomic, bit, order)",
          "old_line_content": "#else",
          "new_line_content": "  return atomic_fetch_flip_fallback(atomic, bit, order);",
          "content_same": false
        },
        {
          "line": 434,
          "old_api": null,
          "new_api": "constexpr",
          "old_text": null,
          "new_text": "constexpr",
          "old_line_content": "    atomic_fetch_reset_native{};",
          "new_line_content": "FOLLY_INLINE_VARIABLE constexpr atomic_fetch_set_native_fn",
          "content_same": false
        },
        {
          "line": 307,
          "old_api": null,
          "new_api": "fb",
          "old_text": null,
          "new_text": "fb(atomic, bit, order)",
          "old_line_content": "}",
          "new_line_content": "    return fb(atomic, bit, order);",
          "content_same": false
        },
        {
          "line": 438,
          "old_api": null,
          "new_api": "constexpr",
          "old_text": null,
          "new_text": "constexpr",
          "old_line_content": "    atomic_fetch_flip_native{};",
          "new_line_content": "FOLLY_INLINE_VARIABLE constexpr atomic_fetch_reset_native_fn",
          "content_same": false
        },
        {
          "line": 311,
          "old_api": null,
          "new_api": "word_type",
          "old_text": null,
          "new_text": "word_type(bit)",
          "old_line_content": "FOLLY_ERASE bool atomic_fetch_bit_op_native_(",
          "new_line_content": "  return op(reinterpret_cast<word_type*>(address), word_type(bit), order);",
          "content_same": false
        },
        {
          "line": 442,
          "old_api": null,
          "new_api": "constexpr",
          "old_text": null,
          "new_text": "constexpr",
          "old_line_content": "template <typename Atomic>",
          "new_line_content": "FOLLY_INLINE_VARIABLE constexpr atomic_fetch_flip_native_fn",
          "content_same": false
        },
        {
          "line": 323,
          "old_api": null,
          "new_api": "fb",
          "old_text": null,
          "new_text": "fb(atomic, bit, order)",
          "old_line_content": "#endif",
          "new_line_content": "    return fb(atomic, bit, order);",
          "content_same": false
        },
        {
          "line": 452,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(bit < (sizeof(Integer) * 8))",
          "old_line_content": "",
          "new_line_content": "  assert(bit < (sizeof(Integer) * 8));",
          "content_same": false
        },
        {
          "line": 325,
          "old_api": null,
          "new_api": "reinterpret_cast<std::atomic<Integer>**>(&atomic)",
          "old_text": null,
          "new_text": "reinterpret_cast<std::atomic<Integer>**>(&atomic)",
          "old_line_content": "template <typename Integer>",
          "new_line_content": "  auto& ref = **reinterpret_cast<std::atomic<Integer>**>(&atomic);",
          "content_same": false
        },
        {
          "line": 326,
          "old_api": null,
          "new_api": "atomic_fetch_bit_op_native_",
          "old_text": null,
          "new_text": "atomic_fetch_bit_op_native_(ref, bit, order, op, fb)",
          "old_line_content": "inline bool atomic_fetch_set_native(",
          "new_line_content": "  return atomic_fetch_bit_op_native_(ref, bit, order, op, fb);",
          "content_same": false
        },
        {
          "line": 461,
          "old_api": null,
          "new_api": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "old_text": null,
          "new_text": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "old_line_content": "bool atomic_fetch_reset_fn::operator()(",
          "new_line_content": "  detail::atomic_fetch_bit_op_check_(atomic, bit);",
          "content_same": false
        },
        {
          "line": 462,
          "old_api": null,
          "new_api": "detail::atomic_fetch_set_native(atomic, bit, mo)",
          "old_text": null,
          "new_text": "detail::atomic_fetch_set_native(atomic, bit, mo)",
          "old_line_content": "    Atomic& atomic, std::size_t bit, std::memory_order mo) const {",
          "new_line_content": "  return detail::atomic_fetch_set_native(atomic, bit, mo);",
          "content_same": false
        },
        {
          "line": 335,
          "old_api": null,
          "new_api": "atomic_fetch_bit_op_native_",
          "old_text": null,
          "new_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "old_line_content": "    atomic_ref<Integer>& atomic, std::size_t bit, std::memory_order order) {",
          "new_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "content_same": false
        },
        {
          "line": 468,
          "old_api": null,
          "new_api": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "old_text": null,
          "new_text": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "old_line_content": "bool atomic_fetch_flip_fn::operator()(",
          "new_line_content": "  detail::atomic_fetch_bit_op_check_(atomic, bit);",
          "content_same": false
        },
        {
          "line": 341,
          "old_api": null,
          "new_api": "atomic",
          "old_text": null,
          "new_text": "atomic.atomic()",
          "old_line_content": "inline bool atomic_fetch_set_native(",
          "new_line_content": "  return atomic_fetch_set_native(atomic.atomic(), bit, order);",
          "content_same": false
        },
        {
          "line": 469,
          "old_api": null,
          "new_api": "detail::atomic_fetch_reset_native(atomic, bit, mo)",
          "old_text": null,
          "new_text": "detail::atomic_fetch_reset_native(atomic, bit, mo)",
          "old_line_content": "    Atomic& atomic, std::size_t bit, std::memory_order mo) const {",
          "new_line_content": "  return detail::atomic_fetch_reset_native(atomic, bit, mo);",
          "content_same": false
        },
        {
          "line": 475,
          "old_api": null,
          "new_api": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "old_text": null,
          "new_text": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "old_line_content": "atomic_value_type_t<Atomic> atomic_fetch_modify_fn::operator()(",
          "new_line_content": "  detail::atomic_fetch_bit_op_check_(atomic, bit);",
          "content_same": false
        },
        {
          "line": 476,
          "old_api": null,
          "new_api": "detail::atomic_fetch_flip_native(atomic, bit, mo)",
          "old_text": null,
          "new_text": "detail::atomic_fetch_flip_native(atomic, bit, mo)",
          "old_line_content": "    Atomic& atomic, Op op, std::memory_order const mo) const {",
          "new_line_content": "  return detail::atomic_fetch_flip_native(atomic, bit, mo);",
          "content_same": false
        },
        {
          "line": 352,
          "old_api": null,
          "new_api": "atomic_fetch_bit_op_native_",
          "old_text": null,
          "new_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "old_line_content": "inline bool atomic_fetch_set_native(",
          "new_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "content_same": false
        },
        {
          "line": 482,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "atomic.load(std::memory_order_relaxed)",
          "old_line_content": "}",
          "new_line_content": "  auto curr = atomic.load(std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 484,
          "old_api": null,
          "new_api": "op",
          "old_text": null,
          "new_text": "op(cref)",
          "old_line_content": "} // namespace folly",
          "new_line_content": "  while (FOLLY_UNLIKELY(!atomic.compare_exchange_weak(curr, op(cref), mo)))",
          "content_same": false
        },
        {
          "line": 360,
          "old_api": null,
          "new_api": "atomic_fetch_set_fallback",
          "old_text": null,
          "new_text": "atomic_fetch_set_fallback(atomic, bit, order)",
          "old_line_content": "    std::atomic<Integer>& atomic, std::size_t bit, std::memory_order order) {",
          "new_line_content": "  return atomic_fetch_set_fallback(atomic, bit, order);",
          "content_same": false
        },
        {
          "line": 368,
          "old_api": null,
          "new_api": "atomic_fetch_bit_op_native_",
          "old_text": null,
          "new_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "old_line_content": "    atomic_ref<Integer>& atomic, std::size_t bit, std::memory_order order) {",
          "new_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "content_same": false
        },
        {
          "line": 374,
          "old_api": null,
          "new_api": "atomic",
          "old_text": null,
          "new_text": "atomic.atomic()",
          "old_line_content": "inline bool atomic_fetch_reset_native(",
          "new_line_content": "  return atomic_fetch_reset_native(atomic.atomic(), bit, order);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 388,
          "old_api": "atomic_fetch_reset_fallback",
          "new_api": null,
          "old_text": "atomic_fetch_reset_fallback(atomic, bit, order)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_reset_fallback(atomic, bit, order);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 396,
          "old_api": "atomic_fetch_bit_op_native_",
          "new_api": null,
          "old_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "new_line_content": "template <typename Integer>",
          "content_same": false
        },
        {
          "line": 402,
          "old_api": "atomic",
          "new_api": null,
          "old_text": "atomic.atomic()",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_flip_native(atomic.atomic(), bit, order);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 413,
          "old_api": "atomic_fetch_bit_op_native_",
          "new_api": null,
          "old_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "new_line_content": "    std::atomic_ref<Integer>& atomic,",
          "content_same": false
        },
        {
          "line": 421,
          "old_api": "atomic_fetch_flip_fallback",
          "new_api": null,
          "old_text": "atomic_fetch_flip_fallback(atomic, bit, order)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_flip_fallback(atomic, bit, order);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 429,
          "old_api": "constexpr",
          "new_api": null,
          "old_text": "constexpr",
          "new_text": null,
          "old_line_content": "FOLLY_INLINE_VARIABLE constexpr atomic_fetch_set_native_fn",
          "new_line_content": "#endif",
          "content_same": false
        },
        {
          "line": 433,
          "old_api": "constexpr",
          "new_api": null,
          "old_text": "constexpr",
          "new_text": null,
          "old_line_content": "FOLLY_INLINE_VARIABLE constexpr atomic_fetch_reset_native_fn",
          "new_line_content": "using atomic_fetch_set_native_fn = detail::atomic_fetch_set_fallback_fn;",
          "content_same": false
        },
        {
          "line": 437,
          "old_api": "constexpr",
          "new_api": null,
          "old_text": "constexpr",
          "new_text": null,
          "old_line_content": "FOLLY_INLINE_VARIABLE constexpr atomic_fetch_flip_native_fn",
          "new_line_content": "using atomic_fetch_reset_native_fn = detail::atomic_fetch_reset_fallback_fn;",
          "content_same": false
        },
        {
          "line": 318,
          "old_api": "fb",
          "new_api": null,
          "old_text": "fb(atomic, bit, order)",
          "new_text": null,
          "old_line_content": "    return fb(atomic, bit, order);",
          "new_line_content": "    std::size_t bit,",
          "content_same": false
        },
        {
          "line": 447,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(bit < (sizeof(Integer) * 8))",
          "new_text": null,
          "old_line_content": "  assert(bit < (sizeof(Integer) * 8));",
          "new_line_content": "template <typename Atomic>",
          "content_same": false
        },
        {
          "line": 320,
          "old_api": "reinterpret_cast<std::atomic<Integer>**>(&atomic)",
          "new_api": null,
          "old_text": "reinterpret_cast<std::atomic<Integer>**>(&atomic)",
          "new_text": null,
          "old_line_content": "  auto& ref = **reinterpret_cast<std::atomic<Integer>**>(&atomic);",
          "new_line_content": "    Op op,",
          "content_same": false
        },
        {
          "line": 321,
          "old_api": "atomic_fetch_bit_op_native_",
          "new_api": null,
          "old_text": "atomic_fetch_bit_op_native_(ref, bit, order, op, fb)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_bit_op_native_(ref, bit, order, op, fb);",
          "new_line_content": "    Fb fb) {",
          "content_same": false
        },
        {
          "line": 456,
          "old_api": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "new_api": null,
          "old_text": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "new_text": null,
          "old_line_content": "  detail::atomic_fetch_bit_op_check_(atomic, bit);",
          "new_line_content": "} // namespace detail",
          "content_same": false
        },
        {
          "line": 457,
          "old_api": "detail::atomic_fetch_set_native(atomic, bit, mo)",
          "new_api": null,
          "old_text": "detail::atomic_fetch_set_native(atomic, bit, mo)",
          "new_text": null,
          "old_line_content": "  return detail::atomic_fetch_set_native(atomic, bit, mo);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 330,
          "old_api": "atomic_fetch_bit_op_native_",
          "new_api": null,
          "old_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "new_line_content": "template <typename Integer>",
          "content_same": false
        },
        {
          "line": 463,
          "old_api": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "new_api": null,
          "old_text": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "new_text": null,
          "old_line_content": "  detail::atomic_fetch_bit_op_check_(atomic, bit);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 336,
          "old_api": "atomic",
          "new_api": null,
          "old_text": "atomic.atomic()",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_set_native(atomic.atomic(), bit, order);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 464,
          "old_api": "detail::atomic_fetch_reset_native(atomic, bit, mo)",
          "new_api": null,
          "old_text": "detail::atomic_fetch_reset_native(atomic, bit, mo)",
          "new_text": null,
          "old_line_content": "  return detail::atomic_fetch_reset_native(atomic, bit, mo);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 470,
          "old_api": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "new_api": null,
          "old_text": "detail::atomic_fetch_bit_op_check_(atomic, bit)",
          "new_text": null,
          "old_line_content": "  detail::atomic_fetch_bit_op_check_(atomic, bit);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 471,
          "old_api": "detail::atomic_fetch_flip_native(atomic, bit, mo)",
          "new_api": null,
          "old_text": "detail::atomic_fetch_flip_native(atomic, bit, mo)",
          "new_text": null,
          "old_line_content": "  return detail::atomic_fetch_flip_native(atomic, bit, mo);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 347,
          "old_api": "atomic_fetch_bit_op_native_",
          "new_api": null,
          "old_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "new_line_content": "    std::atomic_ref<Integer>& atomic,",
          "content_same": false
        },
        {
          "line": 477,
          "old_api": "load",
          "new_api": null,
          "old_text": "atomic.load(std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "  auto curr = atomic.load(std::memory_order_relaxed);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 479,
          "old_api": "op",
          "new_api": null,
          "old_text": "op(cref)",
          "new_text": null,
          "old_line_content": "  while (FOLLY_UNLIKELY(!atomic.compare_exchange_weak(curr, op(cref), mo)))",
          "new_line_content": "template <typename Atomic, typename Op>",
          "content_same": false
        },
        {
          "line": 355,
          "old_api": "atomic_fetch_set_fallback",
          "new_api": null,
          "old_text": "atomic_fetch_set_fallback(atomic, bit, order)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_set_fallback(atomic, bit, order);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 363,
          "old_api": "atomic_fetch_bit_op_native_",
          "new_api": null,
          "old_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "new_line_content": "template <typename Integer>",
          "content_same": false
        },
        {
          "line": 369,
          "old_api": "atomic",
          "new_api": null,
          "old_text": "atomic.atomic()",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_reset_native(atomic.atomic(), bit, order);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 380,
          "old_api": "atomic_fetch_bit_op_native_",
          "new_api": null,
          "old_text": "atomic_fetch_bit_op_native_(atomic, bit, order, op, fb)",
          "new_text": null,
          "old_line_content": "  return atomic_fetch_bit_op_native_(atomic, bit, order, op, fb);",
          "new_line_content": "    std::atomic_ref<Integer>& atomic,",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 1,
      "total_additions": 29,
      "total_deletions": 27,
      "total_api_changes": 57
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 5,
        "api_related_lines": 57,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          304,
          305,
          308
        ]
      }
    },
    "api_calls_before": 98,
    "api_calls_after": 100,
    "diff_info": {
      "added_lines": 5,
      "removed_lines": 0,
      "total_diff_lines": 17
    }
  }
}