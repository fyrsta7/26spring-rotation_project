{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/9ef9c154f6a509ecbc297322d85f6b88ec4a35bb",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/9ef9c154f6a509ecbc297322d85f6b88ec4a35bb/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/9ef9c154f6a509ecbc297322d85f6b88ec4a35bb/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/9ef9c154f6a509ecbc297322d85f6b88ec4a35bb/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 238,
          "old_api": "getReferencedFunctionOrNull",
          "new_api": "invalidateAnalysis",
          "old_text": "as.getReferencedFunctionOrNull()",
          "new_text": "invalidateAnalysis(func, SILAnalysis::InvalidationKind::Everything)",
          "old_line_content": "          if (SILFunction *callee = as.getReferencedFunctionOrNull()) {",
          "new_line_content": "        invalidateAnalysis(func, SILAnalysis::InvalidationKind::Everything);",
          "content_same": false
        },
        {
          "line": 297,
          "old_api": "getReferencedFunctionOrNull",
          "new_api": "ApplySite::isa(inst)",
          "old_text": "newFAS.getReferencedFunctionOrNull()",
          "new_text": "ApplySite::isa(inst)",
          "old_line_content": "    SILFunction *callee = newFAS.getReferencedFunctionOrNull();",
          "new_line_content": "  if (auto as = ApplySite::isa(inst)) {",
          "content_same": false
        },
        {
          "line": 302,
          "old_api": "loadFunction",
          "new_api": "getInstruction",
          "old_text": "getModule()->loadFunction(callee, SILModule::LinkingMode::LinkAll)",
          "new_text": "as.getInstruction()",
          "old_line_content": "      getModule()->loadFunction(callee, SILModule::LinkingMode::LinkAll);",
          "new_line_content": "    deleter.forceDelete(as.getInstruction());",
          "content_same": false
        },
        {
          "line": 308,
          "old_api": "SILInliner::inlineFullApply(newFAS, SILInliner::InlineKind::MandatoryInline,\n                                funcBuilder, deleter)",
          "new_api": "isTransparent",
          "old_text": "SILInliner::inlineFullApply(newFAS, SILInliner::InlineKind::MandatoryInline,\n                                funcBuilder, deleter)",
          "new_text": "callee->isTransparent()",
          "old_line_content": "    SILInliner::inlineFullApply(newFAS, SILInliner::InlineKind::MandatoryInline,",
          "new_line_content": "    if (!callee || callee->isTransparent() == IsNotTransparent)",
          "content_same": false
        },
        {
          "line": 312,
          "old_api": "dyn_cast<BuiltinInst>(inst)",
          "new_api": "loadFunction",
          "old_text": "dyn_cast<BuiltinInst>(inst)",
          "new_text": "getModule()->loadFunction(callee, SILModule::LinkingMode::LinkAll)",
          "old_line_content": "  if (auto *bi = dyn_cast<BuiltinInst>(inst)) {",
          "new_line_content": "      getModule()->loadFunction(callee, SILModule::LinkingMode::LinkAll);",
          "content_same": false
        },
        {
          "line": 314,
          "old_api": "getBuiltinInfo",
          "new_api": "isExternalDeclaration",
          "old_text": "bi->getBuiltinInfo()",
          "new_text": "callee->isExternalDeclaration()",
          "old_line_content": "    if (bi->getBuiltinInfo().ID != BuiltinValueKind::CanBeObjCClass)",
          "new_line_content": "    if (callee->isExternalDeclaration())",
          "content_same": false
        },
        {
          "line": 318,
          "old_api": "optimizeBuiltinCanBeObjCClass",
          "new_api": "SILInliner::inlineFullApply(newFAS, SILInliner::InlineKind::MandatoryInline,\n                                funcBuilder, deleter)",
          "old_text": "optimizeBuiltinCanBeObjCClass(bi, builder)",
          "new_text": "SILInliner::inlineFullApply(newFAS, SILInliner::InlineKind::MandatoryInline,\n                                funcBuilder, deleter)",
          "old_line_content": "    IntegerLiteralInst *lit = optimizeBuiltinCanBeObjCClass(bi, builder);",
          "new_line_content": "    SILInliner::inlineFullApply(newFAS, SILInliner::InlineKind::MandatoryInline,",
          "content_same": false
        },
        {
          "line": 322,
          "old_api": "replaceAllUsesWith",
          "new_api": "dyn_cast<BuiltinInst>(inst)",
          "old_text": "bi->replaceAllUsesWith(lit)",
          "new_text": "dyn_cast<BuiltinInst>(inst)",
          "old_line_content": "    bi->replaceAllUsesWith(lit);",
          "new_line_content": "  if (auto *bi = dyn_cast<BuiltinInst>(inst)) {",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 270,
          "old_api": null,
          "new_api": "optimizeMemoryAccesses",
          "old_text": null,
          "new_text": "optimizeMemoryAccesses(*func)",
          "old_line_content": "      continue;",
          "new_line_content": "  if (optimizeMemoryAccesses(*func)) {",
          "content_same": false
        },
        {
          "line": 271,
          "old_api": null,
          "new_api": "eliminateDeadAllocations",
          "old_text": null,
          "new_text": "eliminateDeadAllocations(*func)",
          "old_line_content": "  ",
          "new_line_content": "    eliminateDeadAllocations(*func);",
          "content_same": false
        },
        {
          "line": 277,
          "old_api": null,
          "new_api": "llvm::reverse(*func)",
          "old_text": null,
          "new_text": "llvm::reverse(*func)",
          "old_line_content": "",
          "new_line_content": "  for (SILBasicBlock &block : llvm::reverse(*func)) {",
          "content_same": false
        },
        {
          "line": 279,
          "old_api": null,
          "new_api": "isNonErrorHandling",
          "old_text": null,
          "new_text": "neBlocks.isNonErrorHandling(&block)",
          "old_line_content": "    changed = true;",
          "new_line_content": "    if (!rrBlocks.reachesReturn(&block) || !neBlocks.isNonErrorHandling(&block))",
          "content_same": false
        },
        {
          "line": 282,
          "old_api": null,
          "new_api": "updatingReverseRange",
          "old_text": null,
          "new_text": "deleter.updatingReverseRange(&block)",
          "old_line_content": "}",
          "new_line_content": "    for (SILInstruction *inst : deleter.updatingReverseRange(&block)) {",
          "content_same": false
        },
        {
          "line": 283,
          "old_api": null,
          "new_api": "optimizeInst",
          "old_text": null,
          "new_text": "optimizeInst(inst, funcBuilder, deleter, cha)",
          "old_line_content": "",
          "new_line_content": "      changed |= optimizeInst(inst, funcBuilder, deleter, cha);",
          "content_same": false
        },
        {
          "line": 286,
          "old_api": null,
          "new_api": "cleanupDeadInstructions",
          "old_text": null,
          "new_text": "deleter.cleanupDeadInstructions()",
          "old_line_content": "             InstructionDeleter &deleter, ClassHierarchyAnalysis *cha) {",
          "new_line_content": "  deleter.cleanupDeadInstructions();",
          "content_same": false
        },
        {
          "line": 288,
          "old_api": null,
          "new_api": "specializeAppliesInFunction",
          "old_text": null,
          "new_text": "specializeAppliesInFunction(*func, this, /*isMandatory*/ true)",
          "old_line_content": "    // Specialization opens opportunities to devirtualize method calls.",
          "new_line_content": "  if (specializeAppliesInFunction(*func, this, /*isMandatory*/ true))",
          "content_same": false
        },
        {
          "line": 299,
          "old_api": null,
          "new_api": "tryDevirtualizeApply",
          "old_text": null,
          "new_text": "tryDevirtualizeApply(as, cha)",
          "old_line_content": "      return true;",
          "new_line_content": "    ApplySite newAS = tryDevirtualizeApply(as, cha).first;",
          "content_same": false
        },
        {
          "line": 303,
          "old_api": null,
          "new_api": "getInstruction",
          "old_text": null,
          "new_text": "newAS.getInstruction()",
          "old_line_content": "",
          "new_line_content": "    auto newFAS = FullApplySite::isa(newAS.getInstruction());",
          "content_same": false
        },
        {
          "line": 307,
          "old_api": null,
          "new_api": "getReferencedFunctionOrNull",
          "old_text": null,
          "new_text": "newFAS.getReferencedFunctionOrNull()",
          "old_line_content": "    // If the de-virtualized callee is a transparent function, inline it.",
          "new_line_content": "    SILFunction *callee = newFAS.getReferencedFunctionOrNull();",
          "content_same": false
        },
        {
          "line": 311,
          "old_api": null,
          "new_api": "isExternalDeclaration",
          "old_text": null,
          "new_text": "callee->isExternalDeclaration()",
          "old_line_content": "  }",
          "new_line_content": "    if (callee->isExternalDeclaration())",
          "content_same": false
        },
        {
          "line": 324,
          "old_api": null,
          "new_api": "getBuiltinInfo",
          "old_text": null,
          "new_text": "bi->getBuiltinInfo()",
          "old_line_content": "                               /*EnableDiagnostics*/ false);",
          "new_line_content": "    if (bi->getBuiltinInfo().ID != BuiltinValueKind::CanBeObjCClass)",
          "content_same": false
        },
        {
          "line": 328,
          "old_api": null,
          "new_api": "optimizeBuiltinCanBeObjCClass",
          "old_text": null,
          "new_text": "optimizeBuiltinCanBeObjCClass(bi, builder)",
          "old_line_content": "    return true;",
          "new_line_content": "    IntegerLiteralInst *lit = optimizeBuiltinCanBeObjCClass(bi, builder);",
          "content_same": false
        },
        {
          "line": 332,
          "old_api": null,
          "new_api": "replaceAllUsesWith",
          "old_text": null,
          "new_text": "bi->replaceAllUsesWith(lit)",
          "old_line_content": "",
          "new_line_content": "    bi->replaceAllUsesWith(lit);",
          "content_same": false
        },
        {
          "line": 333,
          "old_api": null,
          "new_api": "getOptions",
          "old_text": null,
          "new_text": "getOptions()",
          "old_line_content": "} // end anonymous namespace",
          "new_line_content": "    ConstantFolder constFolder(funcBuilder, getOptions().AssertConfig,",
          "content_same": false
        },
        {
          "line": 335,
          "old_api": null,
          "new_api": "addToWorklist",
          "old_text": null,
          "new_text": "constFolder.addToWorklist(lit)",
          "old_line_content": "SILTransform *swift::createGenericSpecializer() {",
          "new_line_content": "    constFolder.addToWorklist(lit);",
          "content_same": false
        },
        {
          "line": 336,
          "old_api": null,
          "new_api": "processWorkList",
          "old_text": null,
          "new_text": "constFolder.processWorkList()",
          "old_line_content": "  return new GenericSpecializer();",
          "new_line_content": "    constFolder.processWorkList();",
          "content_same": false
        },
        {
          "line": 337,
          "old_api": null,
          "new_api": "forceDelete",
          "old_text": null,
          "new_text": "deleter.forceDelete(bi)",
          "old_line_content": "}",
          "new_line_content": "    deleter.forceDelete(bi);",
          "content_same": false
        },
        {
          "line": 236,
          "old_api": null,
          "new_api": "optimize",
          "old_text": null,
          "new_text": "optimize(func, cha)",
          "old_line_content": "      for (SILInstruction &inst : block) {",
          "new_line_content": "      bool changed = optimize(func, cha);",
          "content_same": false
        },
        {
          "line": 247,
          "old_api": null,
          "new_api": "ApplySite::isa(&inst)",
          "old_text": null,
          "new_text": "ApplySite::isa(&inst)",
          "old_line_content": "",
          "new_line_content": "        if (auto as = ApplySite::isa(&inst)) {",
          "content_same": false
        },
        {
          "line": 248,
          "old_api": null,
          "new_api": "getReferencedFunctionOrNull",
          "old_text": null,
          "new_text": "as.getReferencedFunctionOrNull()",
          "old_line_content": "/// Specialize generic calls in \\p func and do some other related optimizations:",
          "new_line_content": "          if (SILFunction *callee = as.getReferencedFunctionOrNull()) {",
          "content_same": false
        },
        {
          "line": 249,
          "old_api": null,
          "new_api": "insert",
          "old_text": null,
          "new_text": "visited.insert(callee)",
          "old_line_content": "/// devirtualization and constant-folding of the Builtin.canBeClass.",
          "new_line_content": "            if (visited.insert(callee).second)",
          "content_same": false
        },
        {
          "line": 250,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "workList.push_back(callee)",
          "old_line_content": "bool MandatoryGenericSpecializer::optimize(SILFunction *func,",
          "new_line_content": "              workList.push_back(callee);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 260,
          "old_api": "optimizeMemoryAccesses",
          "new_api": null,
          "old_text": "optimizeMemoryAccesses(*func)",
          "new_text": null,
          "old_line_content": "  if (optimizeMemoryAccesses(*func)) {",
          "new_line_content": "bool MandatoryGenericSpecializer::optimize(SILFunction *func,",
          "content_same": false
        },
        {
          "line": 261,
          "old_api": "eliminateDeadAllocations",
          "new_api": null,
          "old_text": "eliminateDeadAllocations(*func)",
          "new_text": null,
          "old_line_content": "    eliminateDeadAllocations(*func);",
          "new_line_content": "                                           ClassHierarchyAnalysis *cha) {",
          "content_same": false
        },
        {
          "line": 267,
          "old_api": "llvm::reverse(*func)",
          "new_api": null,
          "old_text": "llvm::reverse(*func)",
          "new_text": null,
          "old_line_content": "  for (SILBasicBlock &block : llvm::reverse(*func)) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 269,
          "old_api": "isNonErrorHandling",
          "new_api": null,
          "old_text": "neBlocks.isNonErrorHandling(&block)",
          "new_text": null,
          "old_line_content": "    if (!rrBlocks.reachesReturn(&block) || !neBlocks.isNonErrorHandling(&block))",
          "new_line_content": "  // instructions.",
          "content_same": false
        },
        {
          "line": 272,
          "old_api": "updatingReverseRange",
          "new_api": null,
          "old_text": "deleter.updatingReverseRange(&block)",
          "new_text": null,
          "old_line_content": "    for (SILInstruction *inst : deleter.updatingReverseRange(&block)) {",
          "new_line_content": "    changed = true;",
          "content_same": false
        },
        {
          "line": 273,
          "old_api": "optimizeInst",
          "new_api": null,
          "old_text": "optimizeInst(inst, funcBuilder, deleter, cha)",
          "new_text": null,
          "old_line_content": "      changed |= optimizeInst(inst, funcBuilder, deleter, cha);",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 276,
          "old_api": "cleanupDeadInstructions",
          "new_api": null,
          "old_text": "deleter.cleanupDeadInstructions()",
          "new_text": null,
          "old_line_content": "  deleter.cleanupDeadInstructions();",
          "new_line_content": "  // splitting, which would be quadratic.",
          "content_same": false
        },
        {
          "line": 278,
          "old_api": "specializeAppliesInFunction",
          "new_api": null,
          "old_text": "specializeAppliesInFunction(*func, this, /*isMandatory*/ true)",
          "new_text": null,
          "old_line_content": "  if (specializeAppliesInFunction(*func, this, /*isMandatory*/ true))",
          "new_line_content": "    // Only consider blocks which are not on a \"throw\" path.",
          "content_same": false
        },
        {
          "line": 287,
          "old_api": "ApplySite::isa(inst)",
          "new_api": null,
          "old_text": "ApplySite::isa(inst)",
          "new_text": null,
          "old_line_content": "  if (auto as = ApplySite::isa(inst)) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 289,
          "old_api": "tryDevirtualizeApply",
          "new_api": null,
          "old_text": "tryDevirtualizeApply(as, cha)",
          "new_text": null,
          "old_line_content": "    ApplySite newAS = tryDevirtualizeApply(as, cha).first;",
          "new_line_content": "    changed = true;",
          "content_same": false
        },
        {
          "line": 292,
          "old_api": "getInstruction",
          "new_api": null,
          "old_text": "as.getInstruction()",
          "new_text": null,
          "old_line_content": "    deleter.forceDelete(as.getInstruction());",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 293,
          "old_api": "getInstruction",
          "new_api": null,
          "old_text": "newAS.getInstruction()",
          "new_text": null,
          "old_line_content": "    auto newFAS = FullApplySite::isa(newAS.getInstruction());",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 298,
          "old_api": "isTransparent",
          "new_api": null,
          "old_text": "callee->isTransparent()",
          "new_text": null,
          "old_line_content": "    if (!callee || callee->isTransparent() == IsNotTransparent)",
          "new_line_content": "    // Specialization opens opportunities to devirtualize method calls.",
          "content_same": false
        },
        {
          "line": 301,
          "old_api": "isExternalDeclaration",
          "new_api": null,
          "old_text": "callee->isExternalDeclaration()",
          "new_text": null,
          "old_line_content": "    if (callee->isExternalDeclaration())",
          "new_line_content": "      return false;",
          "content_same": false
        },
        {
          "line": 304,
          "old_api": "isExternalDeclaration",
          "new_api": null,
          "old_text": "callee->isExternalDeclaration()",
          "new_text": null,
          "old_line_content": "    if (callee->isExternalDeclaration())",
          "new_line_content": "    if (!newFAS)",
          "content_same": false
        },
        {
          "line": 323,
          "old_api": "getOptions",
          "new_api": null,
          "old_text": "getOptions()",
          "new_text": null,
          "old_line_content": "    ConstantFolder constFolder(funcBuilder, getOptions().AssertConfig,",
          "new_line_content": "    // Constant-fold the Builtin.canBeClass. This is essential for Array code.",
          "content_same": false
        },
        {
          "line": 325,
          "old_api": "addToWorklist",
          "new_api": null,
          "old_text": "constFolder.addToWorklist(lit)",
          "new_text": null,
          "old_line_content": "    constFolder.addToWorklist(lit);",
          "new_line_content": "      return false;",
          "content_same": false
        },
        {
          "line": 326,
          "old_api": "processWorkList",
          "new_api": null,
          "old_text": "constFolder.processWorkList()",
          "new_text": null,
          "old_line_content": "    constFolder.processWorkList();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 327,
          "old_api": "forceDelete",
          "new_api": null,
          "old_text": "deleter.forceDelete(bi)",
          "new_text": null,
          "old_line_content": "    deleter.forceDelete(bi);",
          "new_line_content": "    SILBuilderWithScope builder(bi);",
          "content_same": false
        },
        {
          "line": 229,
          "old_api": "optimize",
          "new_api": null,
          "old_text": "optimize(func, cha)",
          "new_text": null,
          "old_line_content": "    bool changed = optimize(func, cha);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 232,
          "old_api": "invalidateAnalysis",
          "new_api": null,
          "old_text": "invalidateAnalysis(func, SILAnalysis::InvalidationKind::Everything)",
          "new_text": null,
          "old_line_content": "      invalidateAnalysis(func, SILAnalysis::InvalidationKind::Everything);",
          "new_line_content": "    // This should always happen, but to be on the save side, limit the number",
          "content_same": false
        },
        {
          "line": 237,
          "old_api": "ApplySite::isa(&inst)",
          "new_api": null,
          "old_text": "ApplySite::isa(&inst)",
          "new_text": null,
          "old_line_content": "        if (auto as = ApplySite::isa(&inst)) {",
          "new_line_content": "      if (changed) {",
          "content_same": false
        },
        {
          "line": 239,
          "old_api": "insert",
          "new_api": null,
          "old_text": "visited.insert(callee)",
          "new_text": null,
          "old_line_content": "            if (visited.insert(callee).second)",
          "new_line_content": "      } else {",
          "content_same": false
        },
        {
          "line": 240,
          "old_api": "push_back",
          "new_api": null,
          "old_text": "workList.push_back(callee)",
          "new_text": null,
          "old_line_content": "              workList.push_back(callee);",
          "new_line_content": "        break;",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 8,
      "total_additions": 24,
      "total_deletions": 24,
      "total_api_changes": 56
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 14,
        "api_related_lines": 56,
        "non_api_lines": 7,
        "non_api_line_numbers": [
          230,
          231,
          233,
          234,
          235,
          241,
          242
        ]
      }
    },
    "api_calls_before": 107,
    "api_calls_after": 107,
    "diff_info": {
      "added_lines": 13,
      "removed_lines": 3,
      "total_diff_lines": 29
    }
  }
}