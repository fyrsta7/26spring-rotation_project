{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/422764545c720f696bf7061513eac30941d39cf4",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/422764545c720f696bf7061513eac30941d39cf4/before.h",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/422764545c720f696bf7061513eac30941d39cf4/after.h",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/422764545c720f696bf7061513eac30941d39cf4/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 96,
          "old_api": "static_cast<const Impl*>(this)",
          "new_api": "static_cast<Impl*>(this)",
          "old_text": "static_cast<const Impl*>(this)",
          "new_text": "static_cast<Impl*>(this)",
          "old_line_content": "  const Impl *asImpl() const { return static_cast<const Impl*>(this); }",
          "new_line_content": "  Impl *asImpl() { return static_cast<Impl*>(this); }",
          "content_same": false
        },
        {
          "line": 124,
          "old_api": "getNumArguments",
          "new_api": "reinterpret_cast<void * const *>(this)",
          "old_text": "asImpl()->getNumArguments()",
          "new_text": "reinterpret_cast<void * const *>(this)",
          "old_line_content": "      - asImpl()->getNumArguments();",
          "new_line_content": "    return reinterpret_cast<void * const *>(this)",
          "content_same": false
        },
        {
          "line": 211,
          "old_api": "assert",
          "new_api": "entryBuilder",
          "old_text": "assert(entry)",
          "new_text": "entryBuilder()",
          "old_line_content": "    assert(entry);",
          "new_line_content": "    Entry *entry = entryBuilder();",
          "content_same": false
        },
        {
          "line": 218,
          "old_api": "assert",
          "new_api": "getNumArguments",
          "old_text": "assert(key == newKey)",
          "new_text": "entry->getNumArguments()",
          "old_line_content": "    assert(key == newKey);",
          "new_line_content": "    auto newKey = EntryRef<Entry>::forEntry(entry, entry->getNumArguments());",
          "content_same": false
        },
        {
          "line": 233,
          "old_api": "Entry::getName()",
          "new_api": "printf",
          "old_text": "Entry::getName()",
          "new_text": "printf(\"%s(%p): created %p\\n\",\n           Entry::getName(), this, entry)",
          "old_line_content": "           Entry::getName(), this, entry);",
          "new_line_content": "    printf(\"%s(%p): created %p\\n\",",
          "content_same": false
        },
        {
          "line": 245,
          "old_api": "Entry::getName()",
          "new_api": "printf",
          "old_text": "Entry::getName()",
          "new_text": "printf(\"%s(%p): looking for entry with %zu arguments:\\n\",\n           Entry::getName(), this, numArguments)",
          "old_line_content": "           Entry::getName(), this, numArguments);",
          "new_line_content": "    printf(\"%s(%p): looking for entry with %zu arguments:\\n\",",
          "content_same": false
        },
        {
          "line": 252,
          "old_api": "hash",
          "new_api": "EntryRef<Entry>::forArguments(arguments,numArguments)",
          "old_text": "key.hash()",
          "new_text": "EntryRef<Entry>::forArguments(arguments,numArguments)",
          "old_line_content": "    size_t hash = key.hash();",
          "new_line_content": "    EntryRef<Entry> key = EntryRef<Entry>::forArguments(arguments,numArguments);",
          "content_same": false
        },
        {
          "line": 256,
          "old_api": "Entry::getName()",
          "new_api": "printf",
          "old_text": "Entry::getName()",
          "new_text": "printf(\"%s(%p): generated hash %llx\\n\",\n           Entry::getName(), this, hash)",
          "old_line_content": "           Entry::getName(), this, hash);",
          "new_line_content": "    printf(\"%s(%p): generated hash %llx\\n\",",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 129,
          "old_api": null,
          "new_api": "asImpl",
          "old_text": null,
          "new_text": "asImpl()",
          "old_line_content": "  }",
          "new_line_content": "    return reinterpret_cast<T *>(asImpl() + 1);",
          "content_same": false
        },
        {
          "line": 257,
          "old_api": null,
          "new_api": "Entry::getName()",
          "old_text": null,
          "new_text": "Entry::getName()",
          "old_line_content": "#endif",
          "new_line_content": "           Entry::getName(), this, hash);",
          "content_same": false
        },
        {
          "line": 133,
          "old_api": null,
          "new_api": "const_cast<CacheEntry*>(this)->getData<T>()",
          "old_text": null,
          "new_text": "const_cast<CacheEntry*>(this)->getData<T>()",
          "old_line_content": "  }",
          "new_line_content": "    return const_cast<CacheEntry*>(this)->getData<T>();",
          "content_same": false
        },
        {
          "line": 262,
          "old_api": null,
          "new_api": "findValueByKey",
          "old_text": null,
          "new_text": "Map->findValueByKey(hash)",
          "old_line_content": "      if (MappedValue->Key == key) return MappedValue->Value;",
          "new_line_content": "    while (EntryPair *MappedValue = Map->findValueByKey(hash)) {",
          "content_same": false
        },
        {
          "line": 138,
          "old_api": null,
          "new_api": "reinterpret_cast<const Impl *>(argsBuffer + numArguments)",
          "old_text": null,
          "new_text": "reinterpret_cast<const Impl *>(argsBuffer + numArguments)",
          "old_line_content": "  }",
          "new_line_content": "    return reinterpret_cast<const Impl *>(argsBuffer + numArguments);",
          "content_same": false
        },
        {
          "line": 270,
          "old_api": null,
          "new_api": "addMetadataEntry",
          "old_text": null,
          "new_text": "addMetadataEntry(key, entryBuilder)",
          "old_line_content": "  }",
          "new_line_content": "    return addMetadataEntry(key, entryBuilder);",
          "content_same": false
        },
        {
          "line": 189,
          "old_api": null,
          "new_api": "__attribute__ ((noinline))",
          "old_text": null,
          "new_text": "__attribute__ ((noinline))",
          "old_line_content": "  const Entry *addMetadataEntry(EntryRef<Entry> key,",
          "new_line_content": "  __attribute__ ((noinline))",
          "content_same": false
        },
        {
          "line": 194,
          "old_api": null,
          "new_api": "hash",
          "old_text": null,
          "new_text": "key.hash()",
          "old_line_content": "",
          "new_line_content": "    size_t hash = key.hash();",
          "content_same": false
        },
        {
          "line": 198,
          "old_api": null,
          "new_api": "findValueByKey",
          "old_text": null,
          "new_text": "Map->findValueByKey(hash)",
          "old_line_content": "      if (MappedValue->Key == key) return MappedValue->Value;",
          "new_line_content": "    while (EntryPair *MappedValue = Map->findValueByKey(hash)) {",
          "content_same": false
        },
        {
          "line": 212,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(entry)",
          "old_line_content": "",
          "new_line_content": "    assert(entry);",
          "content_same": false
        },
        {
          "line": 219,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(key == newKey)",
          "old_line_content": "",
          "new_line_content": "    assert(key == newKey);",
          "content_same": false
        },
        {
          "line": 120,
          "old_api": null,
          "new_api": "getNumArguments",
          "old_text": null,
          "new_text": "asImpl()->getNumArguments()",
          "old_line_content": "  }",
          "new_line_content": "    return reinterpret_cast<void**>(this) - asImpl()->getNumArguments();",
          "content_same": false
        },
        {
          "line": 222,
          "old_api": null,
          "new_api": "EntryPair",
          "old_text": null,
          "new_text": "EntryPair(newKey, entry)",
          "old_line_content": "",
          "new_line_content": "    auto E = EntryPair(newKey, entry);",
          "content_same": false
        },
        {
          "line": 97,
          "old_api": null,
          "new_api": "static_cast<const Impl*>(this)",
          "old_text": null,
          "new_text": "static_cast<const Impl*>(this)",
          "old_line_content": "",
          "new_line_content": "  const Impl *asImpl() const { return static_cast<const Impl*>(this); }",
          "content_same": false
        },
        {
          "line": 226,
          "old_api": null,
          "new_api": "tryToAllocateNewNode",
          "old_text": null,
          "new_text": "Map->tryToAllocateNewNode(hash, E)",
          "old_line_content": "      // Implement a closed hash table. If we have a hash collision increase",
          "new_line_content": "    while (!Map->tryToAllocateNewNode(hash, E)) {",
          "content_same": false
        },
        {
          "line": 106,
          "old_api": null,
          "new_api": "alloc",
          "old_text": null,
          "new_text": "allocator.alloc(sizeof(Impl)  +\n                                   numArguments * sizeof(void*) +\n                                   payloadSize)",
          "old_line_content": "                                   numArguments * sizeof(void*) +",
          "new_line_content": "    void *buffer = allocator.alloc(sizeof(Impl)  +",
          "content_same": false
        },
        {
          "line": 234,
          "old_api": null,
          "new_api": "Entry::getName()",
          "old_text": null,
          "new_text": "Entry::getName()",
          "old_line_content": "#endif",
          "new_line_content": "           Entry::getName(), this, entry);",
          "content_same": false
        },
        {
          "line": 236,
          "old_api": null,
          "new_api": "getEntry",
          "old_text": null,
          "new_text": "newKey.getEntry()",
          "old_line_content": "  }",
          "new_line_content": "    return newKey.getEntry();",
          "content_same": false
        },
        {
          "line": 113,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy(buffer, arguments,\n           numArguments * sizeof(void*))",
          "old_line_content": "           numArguments * sizeof(void*));",
          "new_line_content": "    memcpy(buffer, arguments,",
          "content_same": false
        },
        {
          "line": 125,
          "old_api": null,
          "new_api": "getNumArguments",
          "old_text": null,
          "new_text": "asImpl()->getNumArguments()",
          "old_line_content": "  }",
          "new_line_content": "      - asImpl()->getNumArguments();",
          "content_same": false
        },
        {
          "line": 246,
          "old_api": null,
          "new_api": "Entry::getName()",
          "old_text": null,
          "new_text": "Entry::getName()",
          "old_line_content": "    for (size_t i = 0; i < numArguments; i++) {",
          "new_line_content": "           Entry::getName(), this, numArguments);",
          "content_same": false
        },
        {
          "line": 248,
          "old_api": null,
          "new_api": "Entry::getName()",
          "old_text": null,
          "new_text": "Entry::getName()",
          "old_line_content": "    }",
          "new_line_content": "      printf(\"%s(%p):     %p\\n\", Entry::getName(), this, arguments[i]);",
          "content_same": false
        },
        {
          "line": 253,
          "old_api": null,
          "new_api": "hash",
          "old_text": null,
          "new_text": "key.hash()",
          "old_line_content": "",
          "new_line_content": "    size_t hash = key.hash();",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 128,
          "old_api": "asImpl",
          "new_api": null,
          "old_text": "asImpl()",
          "new_text": null,
          "old_line_content": "    return reinterpret_cast<T *>(asImpl() + 1);",
          "new_line_content": "  template <class T> T *getData() {",
          "content_same": false
        },
        {
          "line": 132,
          "old_api": "const_cast<CacheEntry*>(this)->getData<T>()",
          "new_api": null,
          "old_text": "const_cast<CacheEntry*>(this)->getData<T>()",
          "new_text": null,
          "old_line_content": "    return const_cast<CacheEntry*>(this)->getData<T>();",
          "new_line_content": "  template <class T> const T *getData() const {",
          "content_same": false
        },
        {
          "line": 261,
          "old_api": "findValueByKey",
          "new_api": null,
          "old_text": "Map->findValueByKey(hash)",
          "new_text": null,
          "old_line_content": "    while (EntryPair *MappedValue = Map->findValueByKey(hash)) {",
          "new_line_content": "    // Find the bucket for the metadata entry.",
          "content_same": false
        },
        {
          "line": 137,
          "old_api": "reinterpret_cast<const Impl *>(argsBuffer + numArguments)",
          "new_api": null,
          "old_text": "reinterpret_cast<const Impl *>(argsBuffer + numArguments)",
          "new_text": null,
          "old_line_content": "    return reinterpret_cast<const Impl *>(argsBuffer + numArguments);",
          "new_line_content": "                                         unsigned numArguments) {",
          "content_same": false
        },
        {
          "line": 269,
          "old_api": "addMetadataEntry",
          "new_api": null,
          "old_text": "addMetadataEntry(key, entryBuilder)",
          "new_text": null,
          "old_line_content": "    return addMetadataEntry(key, entryBuilder);",
          "new_line_content": "    // We did not find a key so we will need to create one and store it.",
          "content_same": false
        },
        {
          "line": 188,
          "old_api": "__attribute__ ((noinline))",
          "new_api": null,
          "old_text": "__attribute__ ((noinline))",
          "new_text": null,
          "old_line_content": "  __attribute__ ((noinline))",
          "new_line_content": "  /// and profile.",
          "content_same": false
        },
        {
          "line": 193,
          "old_api": "hash",
          "new_api": null,
          "old_text": "key.hash()",
          "new_text": null,
          "old_line_content": "    size_t hash = key.hash();",
          "new_line_content": "    std::unique_lock<std::mutex> ConstructionGuard(*Lock);",
          "content_same": false
        },
        {
          "line": 197,
          "old_api": "findValueByKey",
          "new_api": null,
          "old_text": "Map->findValueByKey(hash)",
          "new_text": null,
          "old_line_content": "    while (EntryPair *MappedValue = Map->findValueByKey(hash)) {",
          "new_line_content": "    // while we were asleep so do a search before constructing a new value.",
          "content_same": false
        },
        {
          "line": 210,
          "old_api": "entryBuilder",
          "new_api": null,
          "old_text": "entryBuilder()",
          "new_text": null,
          "old_line_content": "    Entry *entry = entryBuilder();",
          "new_line_content": "    // once because of the lock above.",
          "content_same": false
        },
        {
          "line": 119,
          "old_api": "getNumArguments",
          "new_api": null,
          "old_text": "asImpl()->getNumArguments()",
          "new_text": null,
          "old_line_content": "    return reinterpret_cast<void**>(this) - asImpl()->getNumArguments();",
          "new_line_content": "  void **getArgumentsBuffer() {",
          "content_same": false
        },
        {
          "line": 217,
          "old_api": "getNumArguments",
          "new_api": null,
          "old_text": "entry->getNumArguments()",
          "new_text": null,
          "old_line_content": "    auto newKey = EntryRef<Entry>::forEntry(entry, entry->getNumArguments());",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 221,
          "old_api": "EntryPair",
          "new_api": null,
          "old_text": "EntryPair(newKey, entry)",
          "new_text": null,
          "old_line_content": "    auto E = EntryPair(newKey, entry);",
          "new_line_content": "    // Construct a new entry.",
          "content_same": false
        },
        {
          "line": 95,
          "old_api": "static_cast<Impl*>(this)",
          "new_api": null,
          "old_text": "static_cast<Impl*>(this)",
          "new_text": null,
          "old_line_content": "  Impl *asImpl() { return static_cast<Impl*>(this); }",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 225,
          "old_api": "tryToAllocateNewNode",
          "new_api": null,
          "old_text": "Map->tryToAllocateNewNode(hash, E)",
          "new_text": null,
          "old_line_content": "    while (!Map->tryToAllocateNewNode(hash, E)) {",
          "new_line_content": "    // while we were asleep so do a search before constructing a new value.",
          "content_same": false
        },
        {
          "line": 232,
          "old_api": "printf",
          "new_api": null,
          "old_text": "printf(\"%s(%p): created %p\\n\",\n           Entry::getName(), this, entry)",
          "new_text": null,
          "old_line_content": "    printf(\"%s(%p): created %p\\n\",",
          "new_line_content": "#if SWIFT_DEBUG_RUNTIME",
          "content_same": false
        },
        {
          "line": 105,
          "old_api": "alloc",
          "new_api": null,
          "old_text": "allocator.alloc(sizeof(Impl)  +\n                                   numArguments * sizeof(void*) +\n                                   payloadSize)",
          "new_text": null,
          "old_line_content": "    void *buffer = allocator.alloc(sizeof(Impl)  +",
          "new_line_content": "                        size_t numArguments, size_t payloadSize) {",
          "content_same": false
        },
        {
          "line": 235,
          "old_api": "getEntry",
          "new_api": null,
          "old_text": "newKey.getEntry()",
          "new_text": null,
          "old_line_content": "    return newKey.getEntry();",
          "new_line_content": "#endif",
          "content_same": false
        },
        {
          "line": 123,
          "old_api": "reinterpret_cast<void * const *>(this)",
          "new_api": null,
          "old_text": "reinterpret_cast<void * const *>(this)",
          "new_text": null,
          "old_line_content": "    return reinterpret_cast<void * const *>(this)",
          "new_line_content": "  void * const *getArgumentsBuffer() const {",
          "content_same": false
        },
        {
          "line": 112,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy(buffer, arguments,\n           numArguments * sizeof(void*))",
          "new_text": null,
          "old_line_content": "    memcpy(buffer, arguments,",
          "new_line_content": "    // Copy the arguments into the right place for the key.",
          "content_same": false
        },
        {
          "line": 244,
          "old_api": "printf",
          "new_api": null,
          "old_text": "printf(\"%s(%p): looking for entry with %zu arguments:\\n\",\n           Entry::getName(), this, numArguments)",
          "new_text": null,
          "old_line_content": "    printf(\"%s(%p): looking for entry with %zu arguments:\\n\",",
          "new_line_content": "#if SWIFT_DEBUG_RUNTIME",
          "content_same": false
        },
        {
          "line": 247,
          "old_api": "Entry::getName()",
          "new_api": null,
          "old_text": "Entry::getName()",
          "new_text": null,
          "old_line_content": "      printf(\"%s(%p):     %p\\n\", Entry::getName(), this, arguments[i]);",
          "new_line_content": "    for (size_t i = 0; i < numArguments; i++) {",
          "content_same": false
        },
        {
          "line": 251,
          "old_api": "EntryRef<Entry>::forArguments(arguments,numArguments)",
          "new_api": null,
          "old_text": "EntryRef<Entry>::forArguments(arguments,numArguments)",
          "new_text": null,
          "old_line_content": "    EntryRef<Entry> key = EntryRef<Entry>::forArguments(arguments,numArguments);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 255,
          "old_api": "printf",
          "new_api": null,
          "old_text": "printf(\"%s(%p): generated hash %llx\\n\",\n           Entry::getName(), this, hash)",
          "new_text": null,
          "old_line_content": "    printf(\"%s(%p): generated hash %llx\\n\",",
          "new_line_content": "#if SWIFT_DEBUG_RUNTIME",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 8,
      "total_additions": 23,
      "total_deletions": 23,
      "total_api_changes": 54
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 3,
        "api_related_lines": 54,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          74,
          75,
          69
        ]
      }
    },
    "api_calls_before": 46,
    "api_calls_after": 46,
    "diff_info": {
      "added_lines": 3,
      "removed_lines": 2,
      "total_diff_lines": 21
    }
  }
}