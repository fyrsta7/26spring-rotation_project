{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/c31e5c755c19f55cc56f2146133afe48de996eef",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/c31e5c755c19f55cc56f2146133afe48de996eef/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/c31e5c755c19f55cc56f2146133afe48de996eef/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/swift/modified_file/c31e5c755c19f55cc56f2146133afe48de996eef/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 130,
          "old_api": "push_back",
          "new_api": "getOperandNumber",
          "old_text": "Users.push_back(User)",
          "new_text": "UI->getOperandNumber()",
          "old_line_content": "      Users.push_back(User);",
          "new_line_content": "        (isa<AssignInst>(User) && UI->getOperandNumber() == 1)) {",
          "content_same": false
        },
        {
          "line": 137,
          "old_api": "push_back",
          "new_api": "isa<DeallocBoxInst>(User)",
          "old_text": "Releases.push_back(User)",
          "new_text": "isa<DeallocBoxInst>(User)",
          "old_line_content": "      Releases.push_back(User);",
          "new_line_content": "    if (isa<StrongReleaseInst>(User) || isa<DeallocBoxInst>(User)) {",
          "content_same": false
        },
        {
          "line": 146,
          "old_api": "isa<ProjectExistentialInst>(User)",
          "new_api": "isa<TupleElementAddrInst>(User)",
          "old_text": "isa<ProjectExistentialInst>(User)",
          "new_text": "isa<TupleElementAddrInst>(User)",
          "old_line_content": "        isa<ProjectExistentialInst>(User)) {",
          "new_line_content": "    if (isa<StructElementAddrInst>(User) || isa<TupleElementAddrInst>(User) ||",
          "content_same": false
        },
        {
          "line": 147,
          "old_api": "push_back",
          "new_api": "isa<ProjectExistentialInst>(User)",
          "old_text": "Users.push_back(User)",
          "new_text": "isa<ProjectExistentialInst>(User)",
          "old_line_content": "      Users.push_back(User);",
          "new_line_content": "        isa<ProjectExistentialInst>(User)) {",
          "content_same": false
        },
        {
          "line": 148,
          "old_api": "checkAllocBoxUses",
          "new_api": "push_back",
          "old_text": "checkAllocBoxUses(ABI, User, Users, Releases)",
          "new_text": "Users.push_back(User)",
          "old_line_content": "      if (checkAllocBoxUses(ABI, User, Users, Releases))",
          "new_line_content": "      Users.push_back(User);",
          "content_same": false
        },
        {
          "line": 156,
          "old_api": "isIndirect",
          "new_api": "dyn_cast<ApplyInst>(User)",
          "old_text": "apply->getFunctionTypeInfo()\n            ->getParameters()[UI->getOperandNumber()-1].isIndirect()",
          "new_text": "dyn_cast<ApplyInst>(User)",
          "old_line_content": "      if (apply->getFunctionTypeInfo()",
          "new_line_content": "    if (auto apply = dyn_cast<ApplyInst>(User)) {",
          "content_same": false
        },
        {
          "line": 157,
          "old_api": "getOperandNumber",
          "new_api": "isIndirect",
          "old_text": "UI->getOperandNumber()",
          "new_text": "apply->getFunctionTypeInfo()\n            ->getParameters()[UI->getOperandNumber()-1].isIndirect()",
          "old_line_content": "            ->getParameters()[UI->getOperandNumber()-1].isIndirect())",
          "new_line_content": "      if (apply->getFunctionTypeInfo()",
          "content_same": false
        },
        {
          "line": 161,
          "old_api": "isIndirect",
          "new_api": "dyn_cast<PartialApplyInst>(User)",
          "old_text": "partialApply->getFunctionTypeInfo()\n            ->getParameters()[UI->getOperandNumber()-1].isIndirect()",
          "new_text": "dyn_cast<PartialApplyInst>(User)",
          "old_line_content": "      if (partialApply->getFunctionTypeInfo()",
          "new_line_content": "    if (auto partialApply = dyn_cast<PartialApplyInst>(User)) {",
          "content_same": false
        },
        {
          "line": 162,
          "old_api": "getOperandNumber",
          "new_api": "isIndirect",
          "old_text": "UI->getOperandNumber()",
          "new_text": "partialApply->getFunctionTypeInfo()\n            ->getParameters()[UI->getOperandNumber()-1].isIndirect()",
          "old_line_content": "            ->getParameters()[UI->getOperandNumber()-1].isIndirect())",
          "new_line_content": "      if (partialApply->getFunctionTypeInfo()",
          "content_same": false
        },
        {
          "line": 205,
          "old_api": "isTrivial",
          "new_api": "getElementType",
          "old_text": "lowering.isTrivial()",
          "new_text": "ABI->getElementType()",
          "old_line_content": "  if (LastRelease == nullptr && !lowering.isTrivial()) {",
          "new_line_content": "    ABI->getModule().Types.getTypeLowering(ABI->getElementType());",
          "content_same": false
        },
        {
          "line": 215,
          "old_api": "llvm::errs()",
          "new_api": "getUses",
          "old_text": "llvm::errs()",
          "new_text": "DEBUG({\n    llvm::errs() << \"*** Promoting alloc_box to stack: \" << *ABI;\n    for (auto UI : ABI->getUses())\n      llvm::errs() << \"    User: \" << *UI->getUser();\n  })",
          "old_line_content": "    llvm::errs() << \"*** Promoting alloc_box to stack: \" << *ABI;",
          "new_line_content": "  DEBUG({",
          "content_same": false
        },
        {
          "line": 216,
          "old_api": "getUses",
          "new_api": "llvm::errs()",
          "old_text": "ABI->getUses()",
          "new_text": "llvm::errs()",
          "old_line_content": "    for (auto UI : ABI->getUses())",
          "new_line_content": "    llvm::errs() << \"*** Promoting alloc_box to stack: \" << *ABI;",
          "content_same": false
        },
        {
          "line": 217,
          "old_api": "getUser",
          "new_api": "getUses",
          "old_text": "UI->getUser()",
          "new_text": "ABI->getUses()",
          "old_line_content": "      llvm::errs() << \"    User: \" << *UI->getUser();",
          "new_line_content": "    for (auto UI : ABI->getUses())",
          "content_same": false
        },
        {
          "line": 223,
          "old_api": "getElementType",
          "new_api": "SILBasicBlock::iterator(ABI)",
          "old_text": "ABI->getElementType()",
          "new_text": "SILBasicBlock::iterator(ABI)",
          "old_line_content": "  auto *ASI = B1.createAllocStack(ABI->getLoc(), ABI->getElementType());",
          "new_line_content": "  SILBuilder B1(ABI->getParent(), ++SILBasicBlock::iterator(ABI));",
          "content_same": false
        },
        {
          "line": 224,
          "old_api": "getDebugScope",
          "new_api": "getElementType",
          "old_text": "ABI->getDebugScope()",
          "new_text": "ABI->getElementType()",
          "old_line_content": "  ASI->setDebugScope(ABI->getDebugScope());",
          "new_line_content": "  auto *ASI = B1.createAllocStack(ABI->getLoc(), ABI->getElementType());",
          "content_same": false
        },
        {
          "line": 235,
          "old_api": "getAddressResult",
          "new_api": "isa<DeallocBoxInst>(LastRelease)",
          "old_text": "ASI->getAddressResult()",
          "new_text": "isa<DeallocBoxInst>(LastRelease)",
          "old_line_content": "      B2.emitDestroyAddr(ABI->getLoc(), ASI->getAddressResult());",
          "new_line_content": "    if (!lowering.isTrivial() && !isa<DeallocBoxInst>(LastRelease))",
          "content_same": false
        },
        {
          "line": 240,
          "old_api": "getContainerResult",
          "new_api": "setInsertionPoint",
          "old_text": "ASI->getContainerResult()",
          "new_text": "B2.setInsertionPoint(LastRelease)",
          "old_line_content": "    B2.createDeallocStack(LastRelease->getLoc(), ASI->getContainerResult());",
          "new_line_content": "    B2.setInsertionPoint(LastRelease);",
          "content_same": false
        },
        {
          "line": 247,
          "old_api": "use_begin",
          "new_api": "use_empty",
          "old_text": "ABI->use_begin()",
          "new_text": "ABI->use_empty()",
          "old_line_content": "    auto *User = (*ABI->use_begin())->getUser();",
          "new_line_content": "  while (!ABI->use_empty()) {",
          "content_same": false
        },
        {
          "line": 248,
          "old_api": "isa<StrongRetainInst>(User)",
          "new_api": "use_begin",
          "old_text": "isa<StrongRetainInst>(User)",
          "new_text": "ABI->use_begin()",
          "old_line_content": "    assert(isa<StrongReleaseInst>(User) || isa<StrongRetainInst>(User) ||",
          "new_line_content": "    auto *User = (*ABI->use_begin())->getUser();",
          "content_same": false
        },
        {
          "line": 249,
          "old_api": "isa<DeallocBoxInst>(User)",
          "new_api": "isa<StrongRetainInst>(User)",
          "old_text": "isa<DeallocBoxInst>(User)",
          "new_text": "isa<StrongRetainInst>(User)",
          "old_line_content": "           isa<DeallocBoxInst>(User));",
          "new_line_content": "    assert(isa<StrongReleaseInst>(User) || isa<StrongRetainInst>(User) ||",
          "content_same": false
        },
        {
          "line": 272,
          "old_api": "optimizeAllocBox",
          "new_api": "dyn_cast<AllocBoxInst>(I)",
          "old_text": "optimizeAllocBox(ABI, PostDomInfo)",
          "new_text": "dyn_cast<AllocBoxInst>(I)",
          "old_line_content": "          if (optimizeAllocBox(ABI, PostDomInfo)) {",
          "new_line_content": "        if (auto *ABI = dyn_cast<AllocBoxInst>(I))",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 131,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "Users.push_back(User)",
          "old_line_content": "      continue;",
          "new_line_content": "      Users.push_back(User);",
          "content_same": false
        },
        {
          "line": 139,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "Users.push_back(User)",
          "old_line_content": "      continue;",
          "new_line_content": "      Users.push_back(User);",
          "content_same": false
        },
        {
          "line": 270,
          "old_api": null,
          "new_api": "end",
          "old_text": null,
          "new_text": "BB.end()",
          "old_line_content": "      while (I != E) {",
          "new_line_content": "      auto I = BB.begin(), E = BB.end();",
          "content_same": false
        },
        {
          "line": 273,
          "old_api": null,
          "new_api": "optimizeAllocBox",
          "old_text": null,
          "new_text": "optimizeAllocBox(ABI, PostDomInfo)",
          "old_line_content": "            ++NumStackPromoted;",
          "new_line_content": "          if (optimizeAllocBox(ABI, PostDomInfo)) {",
          "content_same": false
        },
        {
          "line": 149,
          "old_api": null,
          "new_api": "checkAllocBoxUses",
          "old_text": null,
          "new_text": "checkAllocBoxUses(ABI, User, Users, Releases)",
          "old_line_content": "        return true;",
          "new_line_content": "      if (checkAllocBoxUses(ABI, User, Users, Releases))",
          "content_same": false
        },
        {
          "line": 277,
          "old_api": null,
          "new_api": "eraseFromParent",
          "old_text": null,
          "new_text": "ABI->eraseFromParent()",
          "old_line_content": "            continue;",
          "new_line_content": "            ABI->eraseFromParent();",
          "content_same": false
        },
        {
          "line": 158,
          "old_api": null,
          "new_api": "getOperandNumber",
          "old_text": null,
          "new_text": "UI->getOperandNumber()",
          "old_line_content": "        continue;",
          "new_line_content": "            ->getParameters()[UI->getOperandNumber()-1].isIndirect())",
          "content_same": false
        },
        {
          "line": 163,
          "old_api": null,
          "new_api": "getOperandNumber",
          "old_text": null,
          "new_text": "UI->getOperandNumber()",
          "old_line_content": "        continue;",
          "new_line_content": "            ->getParameters()[UI->getOperandNumber()-1].isIndirect())",
          "content_same": false
        },
        {
          "line": 169,
          "old_api": null,
          "new_api": "llvm::errs()",
          "old_text": null,
          "new_text": "llvm::errs()",
          "old_line_content": "          << \"    Due to user: \" << *User << \"\\n\");",
          "new_line_content": "    DEBUG(llvm::errs() << \"*** Failed to promote alloc_box: \" << *ABI",
          "content_same": false
        },
        {
          "line": 190,
          "old_api": null,
          "new_api": "checkAllocBoxUses",
          "old_text": null,
          "new_text": "checkAllocBoxUses(ABI, ABI, Users, Releases)",
          "old_line_content": "    return false;",
          "new_line_content": "  if (checkAllocBoxUses(ABI, ABI, Users, Releases))",
          "content_same": false
        },
        {
          "line": 198,
          "old_api": null,
          "new_api": "getLastRelease",
          "old_text": null,
          "new_text": "getLastRelease(ABI, Users, Releases, PDI)",
          "old_line_content": "  ",
          "new_line_content": "  SILInstruction *LastRelease = getLastRelease(ABI, Users, Releases, PDI);",
          "content_same": false
        },
        {
          "line": 206,
          "old_api": null,
          "new_api": "isTrivial",
          "old_text": null,
          "new_text": "lowering.isTrivial()",
          "old_line_content": "    // If we can't tell where the last release is, we don't know where to insert",
          "new_line_content": "  if (LastRelease == nullptr && !lowering.isTrivial()) {",
          "content_same": false
        },
        {
          "line": 209,
          "old_api": null,
          "new_api": "llvm::errs()",
          "old_text": null,
          "new_text": "llvm::errs()",
          "old_line_content": "          << \"    Cannot determine location of the last release!\\n\"",
          "new_line_content": "    DEBUG(llvm::errs() << \"*** Failed to promote alloc_box: \" << *ABI",
          "content_same": false
        },
        {
          "line": 211,
          "old_api": null,
          "new_api": "getParent",
          "old_text": null,
          "new_text": "ABI->getParent()->getParent()",
          "old_line_content": "    return false;",
          "new_line_content": "          << *ABI->getParent()->getParent() << \"\\n\");",
          "content_same": false
        },
        {
          "line": 218,
          "old_api": null,
          "new_api": "getUser",
          "old_text": null,
          "new_text": "UI->getUser()",
          "old_line_content": "  });",
          "new_line_content": "      llvm::errs() << \"    User: \" << *UI->getUser();",
          "content_same": false
        },
        {
          "line": 225,
          "old_api": null,
          "new_api": "getDebugScope",
          "old_text": null,
          "new_text": "ABI->getDebugScope()",
          "old_line_content": "   ",
          "new_line_content": "  ASI->setDebugScope(ABI->getDebugScope());",
          "content_same": false
        },
        {
          "line": 228,
          "old_api": null,
          "new_api": "getAddressResult",
          "old_text": null,
          "new_text": "ASI->getAddressResult()",
          "old_line_content": "  ",
          "new_line_content": "  SILValue(ABI, 1).replaceAllUsesWith(ASI->getAddressResult());",
          "content_same": false
        },
        {
          "line": 236,
          "old_api": null,
          "new_api": "getAddressResult",
          "old_text": null,
          "new_text": "ASI->getAddressResult()",
          "old_line_content": "",
          "new_line_content": "      B2.emitDestroyAddr(ABI->getLoc(), ASI->getAddressResult());",
          "content_same": false
        },
        {
          "line": 241,
          "old_api": null,
          "new_api": "getContainerResult",
          "old_text": null,
          "new_text": "ASI->getContainerResult()",
          "old_line_content": "  }",
          "new_line_content": "    B2.createDeallocStack(LastRelease->getLoc(), ASI->getContainerResult());",
          "content_same": false
        },
        {
          "line": 250,
          "old_api": null,
          "new_api": "isa<DeallocBoxInst>(User)",
          "old_text": null,
          "new_text": "isa<DeallocBoxInst>(User)",
          "old_line_content": "    ",
          "new_line_content": "           isa<DeallocBoxInst>(User));",
          "content_same": false
        },
        {
          "line": 252,
          "old_api": null,
          "new_api": "eraseFromParent",
          "old_text": null,
          "new_text": "User->eraseFromParent()",
          "old_line_content": "  }",
          "new_line_content": "    User->eraseFromParent();",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 136,
          "old_api": "isa<DeallocBoxInst>(User)",
          "new_api": null,
          "old_text": "isa<DeallocBoxInst>(User)",
          "new_text": null,
          "old_line_content": "    if (isa<StrongReleaseInst>(User) || isa<DeallocBoxInst>(User)) {",
          "new_line_content": "    // gets released.",
          "content_same": false
        },
        {
          "line": 269,
          "old_api": "end",
          "new_api": null,
          "old_text": "BB.end()",
          "new_text": null,
          "old_line_content": "      auto I = BB.begin(), E = BB.end();",
          "new_line_content": "    for (auto &BB : Fn) {",
          "content_same": false
        },
        {
          "line": 271,
          "old_api": "dyn_cast<AllocBoxInst>(I)",
          "new_api": null,
          "old_text": "dyn_cast<AllocBoxInst>(I)",
          "new_text": null,
          "old_line_content": "        if (auto *ABI = dyn_cast<AllocBoxInst>(I))",
          "new_line_content": "      while (I != E) {",
          "content_same": false
        },
        {
          "line": 145,
          "old_api": "isa<TupleElementAddrInst>(User)",
          "new_api": null,
          "old_text": "isa<TupleElementAddrInst>(User)",
          "new_text": null,
          "old_line_content": "    if (isa<StructElementAddrInst>(User) || isa<TupleElementAddrInst>(User) ||",
          "new_line_content": "    // don't escape and collect all of the uses of the value.",
          "content_same": false
        },
        {
          "line": 276,
          "old_api": "eraseFromParent",
          "new_api": null,
          "old_text": "ABI->eraseFromParent()",
          "new_text": null,
          "old_line_content": "            ABI->eraseFromParent();",
          "new_line_content": "            ++I;",
          "content_same": false
        },
        {
          "line": 155,
          "old_api": "dyn_cast<ApplyInst>(User)",
          "new_api": null,
          "old_text": "dyn_cast<ApplyInst>(User)",
          "new_text": null,
          "old_line_content": "    if (auto apply = dyn_cast<ApplyInst>(User)) {",
          "new_line_content": "    // it is passed through [inout] arguments or for indirect returns.",
          "content_same": false
        },
        {
          "line": 160,
          "old_api": "dyn_cast<PartialApplyInst>(User)",
          "new_api": null,
          "old_text": "dyn_cast<PartialApplyInst>(User)",
          "new_text": null,
          "old_line_content": "    if (auto partialApply = dyn_cast<PartialApplyInst>(User)) {",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 168,
          "old_api": "llvm::errs()",
          "new_api": null,
          "old_text": "llvm::errs()",
          "new_text": null,
          "old_line_content": "    DEBUG(llvm::errs() << \"*** Failed to promote alloc_box: \" << *ABI",
          "new_line_content": "    // Otherwise, this looks like it escapes.",
          "content_same": false
        },
        {
          "line": 189,
          "old_api": "checkAllocBoxUses",
          "new_api": null,
          "old_text": "checkAllocBoxUses(ABI, ABI, Users, Releases)",
          "new_text": null,
          "old_line_content": "  if (checkAllocBoxUses(ABI, ABI, Users, Releases))",
          "new_line_content": "  // not, we can turn it into an alloc_stack.",
          "content_same": false
        },
        {
          "line": 197,
          "old_api": "getLastRelease",
          "new_api": null,
          "old_text": "getLastRelease(ABI, Users, Releases, PDI)",
          "new_text": null,
          "old_line_content": "  SILInstruction *LastRelease = getLastRelease(ABI, Users, Releases, PDI);",
          "new_line_content": "  // mattering in the future, this can be generalized.",
          "content_same": false
        },
        {
          "line": 204,
          "old_api": "getElementType",
          "new_api": null,
          "old_text": "ABI->getElementType()",
          "new_text": null,
          "old_line_content": "    ABI->getModule().Types.getTypeLowering(ABI->getElementType());",
          "new_line_content": "  auto &lowering =",
          "content_same": false
        },
        {
          "line": 208,
          "old_api": "llvm::errs()",
          "new_api": null,
          "old_text": "llvm::errs()",
          "new_text": null,
          "old_line_content": "    DEBUG(llvm::errs() << \"*** Failed to promote alloc_box: \" << *ABI",
          "new_line_content": "    // the destroy_addr for this box.",
          "content_same": false
        },
        {
          "line": 210,
          "old_api": "getParent",
          "new_api": null,
          "old_text": "ABI->getParent()->getParent()",
          "new_text": null,
          "old_line_content": "          << *ABI->getParent()->getParent() << \"\\n\");",
          "new_line_content": "          << \"    Cannot determine location of the last release!\\n\"",
          "content_same": false
        },
        {
          "line": 214,
          "old_api": "getUses",
          "new_api": null,
          "old_text": "DEBUG({\n    llvm::errs() << \"*** Promoting alloc_box to stack: \" << *ABI;\n    for (auto UI : ABI->getUses())\n      llvm::errs() << \"    User: \" << *UI->getUser();\n  })",
          "new_text": null,
          "old_line_content": "  DEBUG({",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 222,
          "old_api": "SILBasicBlock::iterator(ABI)",
          "new_api": null,
          "old_text": "SILBasicBlock::iterator(ABI)",
          "new_text": null,
          "old_line_content": "  SILBuilder B1(ABI->getParent(), ++SILBasicBlock::iterator(ABI));",
          "new_line_content": "  // alloc_stack.  Start by inserting the alloc stack after the alloc_box.",
          "content_same": false
        },
        {
          "line": 227,
          "old_api": "getAddressResult",
          "new_api": null,
          "old_text": "ASI->getAddressResult()",
          "new_text": null,
          "old_line_content": "  SILValue(ABI, 1).replaceAllUsesWith(ASI->getAddressResult());",
          "new_line_content": "  // Replace all uses of the pointer operand with the spiffy new AllocStack.",
          "content_same": false
        },
        {
          "line": 234,
          "old_api": "isa<DeallocBoxInst>(LastRelease)",
          "new_api": null,
          "old_text": "isa<DeallocBoxInst>(LastRelease)",
          "new_text": null,
          "old_line_content": "    if (!lowering.isTrivial() && !isa<DeallocBoxInst>(LastRelease))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 239,
          "old_api": "setInsertionPoint",
          "new_api": null,
          "old_text": "B2.setInsertionPoint(LastRelease)",
          "new_text": null,
          "old_line_content": "    B2.setInsertionPoint(LastRelease);",
          "new_line_content": "    // multiple blocks.",
          "content_same": false
        },
        {
          "line": 246,
          "old_api": "use_empty",
          "new_api": null,
          "old_text": "ABI->use_empty()",
          "new_text": null,
          "old_line_content": "  while (!ABI->use_empty()) {",
          "new_line_content": "  // pointer).",
          "content_same": false
        },
        {
          "line": 251,
          "old_api": "eraseFromParent",
          "new_api": null,
          "old_text": "User->eraseFromParent()",
          "new_text": null,
          "old_line_content": "    User->eraseFromParent();",
          "new_line_content": "    ",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 21,
      "total_additions": 21,
      "total_deletions": 20,
      "total_api_changes": 62
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 2,
        "api_related_lines": 62,
        "non_api_lines": 1,
        "non_api_line_numbers": [
          129
        ]
      }
    },
    "api_calls_before": 109,
    "api_calls_after": 111,
    "diff_info": {
      "added_lines": 2,
      "removed_lines": 1,
      "total_diff_lines": 15
    }
  }
}