{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mpv/modified_file/20eead18130fd460d8e9eff50ce14afd3646faab",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mpv/modified_file/20eead18130fd460d8e9eff50ce14afd3646faab/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mpv/modified_file/20eead18130fd460d8e9eff50ce14afd3646faab/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mpv/modified_file/20eead18130fd460d8e9eff50ce14afd3646faab/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 100,
          "old_api": "poll",
          "new_api": "mp_cancel_get_fd",
          "old_text": "poll(fds, c >= 0 ? 2 : 1, -1)",
          "new_text": "mp_cancel_get_fd(p->cancel)",
          "old_line_content": "        poll(fds, c >= 0 ? 2 : 1, -1);",
          "new_line_content": "        int c = mp_cancel_get_fd(p->cancel);",
          "content_same": false
        },
        {
          "line": 112,
          "old_api": "get_size",
          "new_api": "read",
          "old_text": "get_size(s)",
          "new_text": "read(p->fd, buffer, max_len)",
          "old_line_content": "        int64_t size = get_size(s);",
          "new_line_content": "        int r = read(p->fd, buffer, max_len);",
          "content_same": false
        },
        {
          "line": 159,
          "old_api": "strlen",
          "new_api": "bstrto0",
          "old_text": "strlen(filename)",
          "new_text": "bstrto0(talloc_ctx, url)",
          "old_line_content": "        memmove(filename, filename + 1, strlen(filename)); // including \\0",
          "new_line_content": "    char *filename = bstrto0(talloc_ctx, url);",
          "content_same": false
        },
        {
          "line": 229,
          "old_api": "_get_osfhandle",
          "new_api": "GetProcAddress",
          "old_text": "_get_osfhandle(fd)",
          "new_text": "GetProcAddress(ntdll, \"NtQueryVolumeInformationFile\")",
          "old_line_content": "    HANDLE h = (HANDLE)_get_osfhandle(fd);",
          "new_line_content": "        GetProcAddress(ntdll, \"NtQueryVolumeInformationFile\");",
          "content_same": false
        },
        {
          "line": 275,
          "old_api": "MP_ERR",
          "new_api": "strncmp",
          "old_text": "MP_ERR(stream, \"Invalid FD: %s\\n\", stream->url)",
          "new_text": "strncmp(stream->url, \"fdclose://\", 10)",
          "old_line_content": "            MP_ERR(stream, \"Invalid FD: %s\\n\", stream->url);",
          "new_line_content": "    bool is_fdclose = strncmp(stream->url, \"fdclose://\", 10) == 0;",
          "content_same": false
        },
        {
          "line": 280,
          "old_api": "strcmp",
          "new_api": "MP_ERR",
          "old_text": "strcmp(filename, \"-\")",
          "new_text": "MP_ERR(stream, \"Invalid FD: %s\\n\", stream->url)",
          "old_line_content": "    } else if (!strcmp(filename, \"-\")) {",
          "new_line_content": "            MP_ERR(stream, \"Invalid FD: %s\\n\", stream->url);",
          "content_same": false
        },
        {
          "line": 285,
          "old_api": "MP_INFO",
          "new_api": "strcmp",
          "old_text": "MP_INFO(stream, \"Writing to stdout...\\n\")",
          "new_text": "strcmp(filename, \"-\")",
          "old_line_content": "            MP_INFO(stream, \"Writing to stdout...\\n\");",
          "new_line_content": "    } else if (!strcmp(filename, \"-\")) {",
          "content_same": false
        },
        {
          "line": 316,
          "old_api": "fcntl",
          "new_api": "MP_INFO",
          "old_text": "fcntl(p->fd, F_GETFL)",
          "new_text": "MP_INFO(stream, \"This is a directory - adding to playlist.\\n\")",
          "old_line_content": "            int val = fcntl(p->fd, F_GETFL) & ~(unsigned)O_NONBLOCK;",
          "new_line_content": "            MP_INFO(stream, \"This is a directory - adding to playlist.\\n\");",
          "content_same": false
        },
        {
          "line": 317,
          "old_api": "fcntl",
          "new_api": "S_ISREG",
          "old_text": "fcntl(p->fd, F_SETFL, val)",
          "new_text": "S_ISREG(st.st_mode)",
          "old_line_content": "            fcntl(p->fd, F_SETFL, val);",
          "new_line_content": "        } else if (S_ISREG(st.st_mode)) {",
          "content_same": false
        },
        {
          "line": 346,
          "old_api": "mp_cancel_new",
          "new_api": "check_stream_network",
          "old_text": "mp_cancel_new(p)",
          "new_text": "check_stream_network(p->fd)",
          "old_line_content": "    p->cancel = mp_cancel_new(p);",
          "new_line_content": "    if (check_stream_network(p->fd))",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 257,
          "old_api": null,
          "new_api": "talloc_ptrtype",
          "old_text": null,
          "new_text": "talloc_ptrtype(stream, p)",
          "old_line_content": "    stream->priv = p;",
          "new_line_content": "    struct priv *p = talloc_ptrtype(stream, p);",
          "content_same": false
        },
        {
          "line": 137,
          "old_api": null,
          "new_api": "write",
          "old_text": null,
          "new_text": "write(p->fd, buffer, len)",
          "old_line_content": "    struct priv *p = s->priv;",
          "new_line_content": "    return write(p->fd, buffer, len);",
          "content_same": false
        },
        {
          "line": 268,
          "old_api": null,
          "new_api": "bstr0",
          "old_text": null,
          "new_text": "bstr0(stream->url)",
          "old_line_content": "    }",
          "new_line_content": "    char *filename = mp_file_url_to_filename(stream, bstr0(stream->url));",
          "content_same": false
        },
        {
          "line": 143,
          "old_api": null,
          "new_api": "lseek",
          "old_text": null,
          "new_text": "lseek(p->fd, newpos, SEEK_SET)",
          "old_line_content": "    struct priv *p = s->priv;",
          "new_line_content": "    return lseek(p->fd, newpos, SEEK_SET) != (off_t)-1;",
          "content_same": false
        },
        {
          "line": 276,
          "old_api": null,
          "new_api": "strncmp",
          "old_text": null,
          "new_text": "strncmp(stream->url, \"fd://\", 5)",
          "old_line_content": "            return STREAM_ERROR;",
          "new_line_content": "    if (strncmp(stream->url, \"fd://\", 5) == 0 || is_fdclose) {",
          "content_same": false
        },
        {
          "line": 277,
          "old_api": null,
          "new_api": "strstr",
          "old_text": null,
          "new_text": "strstr(stream->url, \"://\")",
          "old_line_content": "        }",
          "new_line_content": "        char *begin = strstr(stream->url, \"://\") + 3, *end = NULL;",
          "content_same": false
        },
        {
          "line": 150,
          "old_api": null,
          "new_api": "close",
          "old_text": null,
          "new_text": "close(p->fd)",
          "old_line_content": "{",
          "new_line_content": "        close(p->fd);",
          "content_same": false
        },
        {
          "line": 278,
          "old_api": null,
          "new_api": "strtol",
          "old_text": null,
          "new_text": "strtol(begin, &end, 0)",
          "old_line_content": "        if (is_fdclose)",
          "new_line_content": "        p->fd = strtol(begin, &end, 0);",
          "content_same": false
        },
        {
          "line": 156,
          "old_api": null,
          "new_api": "mp_split_proto",
          "old_text": null,
          "new_text": "mp_split_proto(url, &url)",
          "old_line_content": "#if HAVE_DOS_PATHS",
          "new_line_content": "    bstr proto = mp_split_proto(url, &url);",
          "content_same": false
        },
        {
          "line": 157,
          "old_api": null,
          "new_api": "bstrcasecmp0",
          "old_text": null,
          "new_text": "bstrcasecmp0(proto, \"file\")",
          "old_line_content": "    // extract '/' from '/x:/path'",
          "new_line_content": "    if (bstrcasecmp0(proto, \"file\") != 0)",
          "content_same": false
        },
        {
          "line": 287,
          "old_api": null,
          "new_api": "MP_INFO",
          "old_text": null,
          "new_text": "MP_INFO(stream, \"Reading from stdin...\\n\")",
          "old_line_content": "        }",
          "new_line_content": "            MP_INFO(stream, \"Reading from stdin...\\n\");",
          "content_same": false
        },
        {
          "line": 160,
          "old_api": null,
          "new_api": "mp_url_unescape_inplace",
          "old_text": null,
          "new_text": "mp_url_unescape_inplace(filename)",
          "old_line_content": "#endif",
          "new_line_content": "    mp_url_unescape_inplace(filename);",
          "content_same": false
        },
        {
          "line": 290,
          "old_api": null,
          "new_api": "MP_INFO",
          "old_text": null,
          "new_text": "MP_INFO(stream, \"Writing to stdout...\\n\")",
          "old_line_content": "            p->appending = true;",
          "new_line_content": "            MP_INFO(stream, \"Writing to stdout...\\n\");",
          "content_same": false
        },
        {
          "line": 164,
          "old_api": null,
          "new_api": "strlen",
          "old_text": null,
          "new_text": "strlen(filename)",
          "old_line_content": "// Return talloc_strdup's filesystem path if local, otherwise NULL.",
          "new_line_content": "        memmove(filename, filename + 1, strlen(filename)); // including \\0",
          "content_same": false
        },
        {
          "line": 294,
          "old_api": null,
          "new_api": "bstr0",
          "old_text": null,
          "new_text": "bstr0(stream->url)",
          "old_line_content": "        openmode |= S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH;",
          "new_line_content": "        if (bstr_startswith0(bstr0(stream->url), \"appending://\"))",
          "content_same": false
        },
        {
          "line": 173,
          "old_api": null,
          "new_api": "mp_split_proto",
          "old_text": null,
          "new_text": "mp_split_proto(url, &(bstr){0})",
          "old_line_content": "}",
          "new_line_content": "    if (mp_split_proto(url, &(bstr){0}).len) {",
          "content_same": false
        },
        {
          "line": 174,
          "old_api": null,
          "new_api": "mp_file_url_to_filename",
          "old_text": null,
          "new_text": "mp_file_url_to_filename(talloc_ctx, url)",
          "old_line_content": "",
          "new_line_content": "        return mp_file_url_to_filename(talloc_ctx, url);",
          "content_same": false
        },
        {
          "line": 303,
          "old_api": null,
          "new_api": "open",
          "old_text": null,
          "new_text": "open(filename, m | O_BINARY, openmode)",
          "old_line_content": "        }",
          "new_line_content": "        p->fd = open(filename, m | O_BINARY, openmode);",
          "content_same": false
        },
        {
          "line": 176,
          "old_api": null,
          "new_api": "bstrto0",
          "old_text": null,
          "new_text": "bstrto0(talloc_ctx, url)",
          "old_line_content": "static bool check_stream_network(int fd)",
          "new_line_content": "        return bstrto0(talloc_ctx, url);",
          "content_same": false
        },
        {
          "line": 305,
          "old_api": null,
          "new_api": "MP_ERR",
          "old_text": null,
          "new_text": "MP_ERR(stream, \"Cannot open file '%s': %s\\n\",\n                   filename, mp_strerror(errno))",
          "old_line_content": "    }",
          "new_line_content": "            MP_ERR(stream, \"Cannot open file '%s': %s\\n\",",
          "content_same": false
        },
        {
          "line": 306,
          "old_api": null,
          "new_api": "mp_strerror",
          "old_text": null,
          "new_text": "mp_strerror(errno)",
          "old_line_content": "",
          "new_line_content": "                   filename, mp_strerror(errno));",
          "content_same": false
        },
        {
          "line": 313,
          "old_api": null,
          "new_api": "fstat",
          "old_text": null,
          "new_text": "fstat(p->fd, &st)",
          "old_line_content": "            p->regular_file = true;",
          "new_line_content": "    if (fstat(p->fd, &st) == 0) {",
          "content_same": false
        },
        {
          "line": 186,
          "old_api": null,
          "new_api": "fstatfs",
          "old_text": null,
          "new_text": "fstatfs(fd, &fs)",
          "old_line_content": "",
          "new_line_content": "    if (fstatfs(fd, &fs) == 0)",
          "content_same": false
        },
        {
          "line": 314,
          "old_api": null,
          "new_api": "S_ISDIR",
          "old_text": null,
          "new_text": "S_ISDIR(st.st_mode)",
          "old_line_content": "#ifndef __MINGW32__",
          "new_line_content": "        if (S_ISDIR(st.st_mode)) {",
          "content_same": false
        },
        {
          "line": 188,
          "old_api": null,
          "new_api": "strcmp",
          "old_text": null,
          "new_text": "strcmp(stypes[i], fs.f_fstypename)",
          "old_line_content": "#elif HAVE_LINUX_FSTATFS",
          "new_line_content": "            if (strcmp(stypes[i], fs.f_fstypename) == 0)",
          "content_same": false
        },
        {
          "line": 321,
          "old_api": null,
          "new_api": "fcntl",
          "old_text": null,
          "new_text": "fcntl(p->fd, F_GETFL)",
          "old_line_content": "        }",
          "new_line_content": "            int val = fcntl(p->fd, F_GETFL) & ~(unsigned)O_NONBLOCK;",
          "content_same": false
        },
        {
          "line": 322,
          "old_api": null,
          "new_api": "fcntl",
          "old_text": null,
          "new_text": "fcntl(p->fd, F_SETFL, val)",
          "old_line_content": "    }",
          "new_line_content": "            fcntl(p->fd, F_SETFL, val);",
          "content_same": false
        },
        {
          "line": 330,
          "old_api": null,
          "new_api": "setmode",
          "old_text": null,
          "new_text": "setmode(p->fd, O_BINARY)",
          "old_line_content": "    if (len != (off_t)-1) {",
          "new_line_content": "    setmode(p->fd, O_BINARY);",
          "content_same": false
        },
        {
          "line": 333,
          "old_api": null,
          "new_api": "lseek",
          "old_text": null,
          "new_text": "lseek(p->fd, 0, SEEK_END)",
          "old_line_content": "    }",
          "new_line_content": "    off_t len = lseek(p->fd, 0, SEEK_END);",
          "content_same": false
        },
        {
          "line": 334,
          "old_api": null,
          "new_api": "lseek",
          "old_text": null,
          "new_text": "lseek(p->fd, 0, SEEK_SET)",
          "old_line_content": "",
          "new_line_content": "    lseek(p->fd, 0, SEEK_SET);",
          "content_same": false
        },
        {
          "line": 208,
          "old_api": null,
          "new_api": "fstatfs",
          "old_text": null,
          "new_text": "fstatfs(fd, &fs)",
          "old_line_content": "    }",
          "new_line_content": "    if (fstatfs(fd, &fs) == 0) {",
          "content_same": false
        },
        {
          "line": 82,
          "old_api": null,
          "new_api": "fstat",
          "old_text": null,
          "new_text": "fstat(p->fd, &st)",
          "old_line_content": "        p->cached_size = size < 0 ? -1 : size;",
          "new_line_content": "        if (fstat(p->fd, &st) == 0) {",
          "content_same": false
        },
        {
          "line": 220,
          "old_api": null,
          "new_api": "NTSTATUS (NTAPI *pNtQueryVolumeInformationFile)(HANDLE,\n        PIO_STATUS_BLOCK, PVOID, ULONG, FS_INFORMATION_CLASS)",
          "old_text": null,
          "new_text": "NTSTATUS (NTAPI *pNtQueryVolumeInformationFile)(HANDLE,\n        PIO_STATUS_BLOCK, PVOID, ULONG, FS_INFORMATION_CLASS)",
          "old_line_content": "    // if it's removed from a future version of Windows.",
          "new_line_content": "    NTSTATUS (NTAPI *pNtQueryVolumeInformationFile)(HANDLE,",
          "content_same": false
        },
        {
          "line": 349,
          "old_api": null,
          "new_api": "get_size",
          "old_text": null,
          "new_text": "get_size(stream)",
          "old_line_content": "",
          "new_line_content": "    p->orig_size = get_size(stream);",
          "content_same": false
        },
        {
          "line": 351,
          "old_api": null,
          "new_api": "mp_cancel_new",
          "old_text": null,
          "new_text": "mp_cancel_new(p)",
          "old_line_content": "}",
          "new_line_content": "    p->cancel = mp_cancel_new(p);",
          "content_same": false
        },
        {
          "line": 353,
          "old_api": null,
          "new_api": "mp_cancel_set_parent",
          "old_text": null,
          "new_text": "mp_cancel_set_parent(p->cancel, stream->cancel)",
          "old_line_content": "const stream_info_t stream_info_file = {",
          "new_line_content": "        mp_cancel_set_parent(p->cancel, stream->cancel);",
          "content_same": false
        },
        {
          "line": 226,
          "old_api": null,
          "new_api": "GetModuleHandleW",
          "old_text": null,
          "new_text": "GetModuleHandleW(L\"ntdll.dll\")",
          "old_line_content": "    if (!pNtQueryVolumeInformationFile)",
          "new_line_content": "    HMODULE ntdll = GetModuleHandleW(L\"ntdll.dll\");",
          "content_same": false
        },
        {
          "line": 105,
          "old_api": null,
          "new_api": "poll",
          "old_text": null,
          "new_text": "poll(fds, c >= 0 ? 2 : 1, -1)",
          "old_line_content": "",
          "new_line_content": "        poll(fds, c >= 0 ? 2 : 1, -1);",
          "content_same": false
        },
        {
          "line": 234,
          "old_api": null,
          "new_api": "_get_osfhandle",
          "old_text": null,
          "new_text": "_get_osfhandle(fd)",
          "old_line_content": "    IO_STATUS_BLOCK io;",
          "new_line_content": "    HANDLE h = (HANDLE)_get_osfhandle(fd);",
          "content_same": false
        },
        {
          "line": 240,
          "old_api": null,
          "new_api": "pNtQueryVolumeInformationFile",
          "old_text": null,
          "new_text": "pNtQueryVolumeInformationFile(h, &io, &info,\n        sizeof(info), FileFsDeviceInformation)",
          "old_line_content": "    return info.DeviceType == FILE_DEVICE_NETWORK_FILE_SYSTEM ||",
          "new_line_content": "    NTSTATUS status = pNtQueryVolumeInformationFile(h, &io, &info,",
          "content_same": false
        },
        {
          "line": 242,
          "old_api": null,
          "new_api": "NT_SUCCESS",
          "old_text": null,
          "new_text": "NT_SUCCESS(status)",
          "old_line_content": "}",
          "new_line_content": "    if (!NT_SUCCESS(status))",
          "content_same": false
        },
        {
          "line": 117,
          "old_api": null,
          "new_api": "get_size",
          "old_text": null,
          "new_text": "get_size(s)",
          "old_line_content": "        }",
          "new_line_content": "        int64_t size = get_size(s);",
          "content_same": false
        },
        {
          "line": 119,
          "old_api": null,
          "new_api": "MP_WARN",
          "old_text": null,
          "new_text": "MP_WARN(s, \"File is apparently being appended to, will keep \"\n                    \"retrying with timeouts.\\n\")",
          "old_line_content": "        if (!p->appending || p->use_poll)",
          "new_line_content": "            MP_WARN(s, \"File is apparently being appended to, will keep \"",
          "content_same": false
        },
        {
          "line": 127,
          "old_api": null,
          "new_api": "mp_cancel_wait",
          "old_text": null,
          "new_text": "mp_cancel_wait(p->cancel, RETRY_TIMEOUT)",
          "old_line_content": "}",
          "new_line_content": "        if (mp_cancel_wait(p->cancel, RETRY_TIMEOUT))",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 132,
          "old_api": "write",
          "new_api": null,
          "old_text": "write(p->fd, buffer, len)",
          "new_text": null,
          "old_line_content": "    return write(p->fd, buffer, len);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 263,
          "old_api": "bstr0",
          "new_api": null,
          "old_text": "bstr0(stream->url)",
          "new_text": null,
          "old_line_content": "    char *filename = mp_file_url_to_filename(stream, bstr0(stream->url));",
          "new_line_content": "    stream->is_local_file = true;",
          "content_same": false
        },
        {
          "line": 138,
          "old_api": "lseek",
          "new_api": null,
          "old_text": "lseek(p->fd, newpos, SEEK_SET)",
          "new_text": null,
          "old_line_content": "    return lseek(p->fd, newpos, SEEK_SET) != (off_t)-1;",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 270,
          "old_api": "strncmp",
          "new_api": null,
          "old_text": "strncmp(stream->url, \"fdclose://\", 10)",
          "new_text": null,
          "old_line_content": "    bool is_fdclose = strncmp(stream->url, \"fdclose://\", 10) == 0;",
          "new_line_content": "        stream->path = filename;",
          "content_same": false
        },
        {
          "line": 271,
          "old_api": "strncmp",
          "new_api": null,
          "old_text": "strncmp(stream->url, \"fd://\", 5)",
          "new_text": null,
          "old_line_content": "    if (strncmp(stream->url, \"fd://\", 5) == 0 || is_fdclose) {",
          "new_line_content": "    } else {",
          "content_same": false
        },
        {
          "line": 272,
          "old_api": "strstr",
          "new_api": null,
          "old_text": "strstr(stream->url, \"://\")",
          "new_text": null,
          "old_line_content": "        char *begin = strstr(stream->url, \"://\") + 3, *end = NULL;",
          "new_line_content": "        filename = stream->path;",
          "content_same": false
        },
        {
          "line": 145,
          "old_api": "close",
          "new_api": null,
          "old_text": "close(p->fd)",
          "new_text": null,
          "old_line_content": "        close(p->fd);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 273,
          "old_api": "strtol",
          "new_api": null,
          "old_text": "strtol(begin, &end, 0)",
          "new_text": null,
          "old_line_content": "        p->fd = strtol(begin, &end, 0);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 151,
          "old_api": "mp_split_proto",
          "new_api": null,
          "old_text": "mp_split_proto(url, &url)",
          "new_text": null,
          "old_line_content": "    bstr proto = mp_split_proto(url, &url);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 152,
          "old_api": "bstrcasecmp0",
          "new_api": null,
          "old_text": "bstrcasecmp0(proto, \"file\")",
          "new_text": null,
          "old_line_content": "    if (bstrcasecmp0(proto, \"file\") != 0)",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 282,
          "old_api": "MP_INFO",
          "new_api": null,
          "old_text": "MP_INFO(stream, \"Reading from stdin...\\n\")",
          "new_text": null,
          "old_line_content": "            MP_INFO(stream, \"Reading from stdin...\\n\");",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 154,
          "old_api": "bstrto0",
          "new_api": null,
          "old_text": "bstrto0(talloc_ctx, url)",
          "new_text": null,
          "old_line_content": "    char *filename = bstrto0(talloc_ctx, url);",
          "new_line_content": "char *mp_file_url_to_filename(void *talloc_ctx, bstr url)",
          "content_same": false
        },
        {
          "line": 155,
          "old_api": "mp_url_unescape_inplace",
          "new_api": null,
          "old_text": "mp_url_unescape_inplace(filename)",
          "new_text": null,
          "old_line_content": "    mp_url_unescape_inplace(filename);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 289,
          "old_api": "bstr0",
          "new_api": null,
          "old_text": "bstr0(stream->url)",
          "new_text": null,
          "old_line_content": "        if (bstr_startswith0(bstr0(stream->url), \"appending://\"))",
          "new_line_content": "        } else {",
          "content_same": false
        },
        {
          "line": 168,
          "old_api": "mp_split_proto",
          "new_api": null,
          "old_text": "mp_split_proto(url, &(bstr){0})",
          "new_text": null,
          "old_line_content": "    if (mp_split_proto(url, &(bstr){0}).len) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 169,
          "old_api": "mp_file_url_to_filename",
          "new_api": null,
          "old_text": "mp_file_url_to_filename(talloc_ctx, url)",
          "new_text": null,
          "old_line_content": "        return mp_file_url_to_filename(talloc_ctx, url);",
          "new_line_content": "// Return talloc_strdup's filesystem path if local, otherwise NULL.",
          "content_same": false
        },
        {
          "line": 298,
          "old_api": "open",
          "new_api": null,
          "old_text": "open(filename, m | O_BINARY, openmode)",
          "new_text": null,
          "old_line_content": "        p->fd = open(filename, m | O_BINARY, openmode);",
          "new_line_content": "#ifndef __MINGW32__",
          "content_same": false
        },
        {
          "line": 171,
          "old_api": "bstrto0",
          "new_api": null,
          "old_text": "bstrto0(talloc_ctx, url)",
          "new_text": null,
          "old_line_content": "        return bstrto0(talloc_ctx, url);",
          "new_line_content": "char *mp_file_get_path(void *talloc_ctx, bstr url)",
          "content_same": false
        },
        {
          "line": 300,
          "old_api": "MP_ERR",
          "new_api": null,
          "old_text": "MP_ERR(stream, \"Cannot open file '%s': %s\\n\",\n                   filename, mp_strerror(errno))",
          "new_text": null,
          "old_line_content": "            MP_ERR(stream, \"Cannot open file '%s': %s\\n\",",
          "new_line_content": "        if (!write)",
          "content_same": false
        },
        {
          "line": 301,
          "old_api": "mp_strerror",
          "new_api": null,
          "old_text": "mp_strerror(errno)",
          "new_text": null,
          "old_line_content": "                   filename, mp_strerror(errno));",
          "new_line_content": "            m |= O_NONBLOCK;",
          "content_same": false
        },
        {
          "line": 308,
          "old_api": "fstat",
          "new_api": null,
          "old_text": "fstat(p->fd, &st)",
          "new_text": null,
          "old_line_content": "    if (fstat(p->fd, &st) == 0) {",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 181,
          "old_api": "fstatfs",
          "new_api": null,
          "old_text": "fstatfs(fd, &fs)",
          "new_text": null,
          "old_line_content": "    if (fstatfs(fd, &fs) == 0)",
          "new_line_content": "static bool check_stream_network(int fd)",
          "content_same": false
        },
        {
          "line": 309,
          "old_api": "S_ISDIR",
          "new_api": null,
          "old_text": "S_ISDIR(st.st_mode)",
          "new_text": null,
          "old_line_content": "        if (S_ISDIR(st.st_mode)) {",
          "new_line_content": "        p->close = true;",
          "content_same": false
        },
        {
          "line": 183,
          "old_api": "strcmp",
          "new_api": null,
          "old_text": "strcmp(stypes[i], fs.f_fstypename)",
          "new_text": null,
          "old_line_content": "            if (strcmp(stypes[i], fs.f_fstypename) == 0)",
          "new_line_content": "    struct statfs fs;",
          "content_same": false
        },
        {
          "line": 311,
          "old_api": "MP_INFO",
          "new_api": null,
          "old_text": "MP_INFO(stream, \"This is a directory - adding to playlist.\\n\")",
          "new_text": null,
          "old_line_content": "            MP_INFO(stream, \"This is a directory - adding to playlist.\\n\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 312,
          "old_api": "S_ISREG",
          "new_api": null,
          "old_text": "S_ISREG(st.st_mode)",
          "new_text": null,
          "old_line_content": "        } else if (S_ISREG(st.st_mode)) {",
          "new_line_content": "    struct stat st;",
          "content_same": false
        },
        {
          "line": 325,
          "old_api": "setmode",
          "new_api": null,
          "old_text": "setmode(p->fd, O_BINARY)",
          "new_text": null,
          "old_line_content": "    setmode(p->fd, O_BINARY);",
          "new_line_content": "            p->use_poll = true;",
          "content_same": false
        },
        {
          "line": 328,
          "old_api": "lseek",
          "new_api": null,
          "old_text": "lseek(p->fd, 0, SEEK_END)",
          "new_text": null,
          "old_line_content": "    off_t len = lseek(p->fd, 0, SEEK_END);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 329,
          "old_api": "lseek",
          "new_api": null,
          "old_text": "lseek(p->fd, 0, SEEK_SET)",
          "new_text": null,
          "old_line_content": "    lseek(p->fd, 0, SEEK_SET);",
          "new_line_content": "#ifdef __MINGW32__",
          "content_same": false
        },
        {
          "line": 203,
          "old_api": "fstatfs",
          "new_api": null,
          "old_text": "fstatfs(fd, &fs)",
          "new_text": null,
          "old_line_content": "    if (fstatfs(fd, &fs) == 0) {",
          "new_line_content": "        0xAAD7AAEA  /*PANFS*/,  0x50495045  /*PIPEFS*/, 0x517B      /*SMB*/,",
          "content_same": false
        },
        {
          "line": 80,
          "old_api": "lseek",
          "new_api": null,
          "old_text": "lseek(p->fd, 0, SEEK_END)",
          "new_text": null,
          "old_line_content": "        off_t size = lseek(p->fd, 0, SEEK_END);",
          "new_line_content": "        int64_t size = -1;",
          "content_same": false
        },
        {
          "line": 81,
          "old_api": "lseek",
          "new_api": null,
          "old_text": "lseek(p->fd, s->pos, SEEK_SET)",
          "new_text": null,
          "old_line_content": "        lseek(p->fd, s->pos, SEEK_SET);",
          "new_line_content": "        struct stat st;",
          "content_same": false
        },
        {
          "line": 341,
          "old_api": "check_stream_network",
          "new_api": null,
          "old_text": "check_stream_network(p->fd)",
          "new_text": null,
          "old_line_content": "    if (check_stream_network(p->fd))",
          "new_line_content": "    stream->fill_buffer = fill_buffer;",
          "content_same": false
        },
        {
          "line": 215,
          "old_api": "NTSTATUS (NTAPI *pNtQueryVolumeInformationFile)(HANDLE,\n        PIO_STATUS_BLOCK, PVOID, ULONG, FS_INFORMATION_CLASS)",
          "new_api": null,
          "old_text": "NTSTATUS (NTAPI *pNtQueryVolumeInformationFile)(HANDLE,\n        PIO_STATUS_BLOCK, PVOID, ULONG, FS_INFORMATION_CLASS)",
          "new_text": null,
          "old_line_content": "    NTSTATUS (NTAPI *pNtQueryVolumeInformationFile)(HANDLE,",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 344,
          "old_api": "get_size",
          "new_api": null,
          "old_text": "get_size(stream)",
          "new_text": null,
          "old_line_content": "    p->orig_size = get_size(stream);",
          "new_line_content": "    stream->close = s_close;",
          "content_same": false
        },
        {
          "line": 348,
          "old_api": "mp_cancel_set_parent",
          "new_api": null,
          "old_text": "mp_cancel_set_parent(p->cancel, stream->cancel)",
          "new_text": null,
          "old_line_content": "        mp_cancel_set_parent(p->cancel, stream->cancel);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 221,
          "old_api": "GetModuleHandleW",
          "new_api": null,
          "old_text": "GetModuleHandleW(L\"ntdll.dll\")",
          "new_text": null,
          "old_line_content": "    HMODULE ntdll = GetModuleHandleW(L\"ntdll.dll\");",
          "new_line_content": "        PIO_STATUS_BLOCK, PVOID, ULONG, FS_INFORMATION_CLASS) = NULL;",
          "content_same": false
        },
        {
          "line": 95,
          "old_api": "mp_cancel_get_fd",
          "new_api": null,
          "old_text": "mp_cancel_get_fd(p->cancel)",
          "new_text": null,
          "old_line_content": "        int c = mp_cancel_get_fd(p->cancel);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 224,
          "old_api": "GetProcAddress",
          "new_api": null,
          "old_text": "GetProcAddress(ntdll, \"NtQueryVolumeInformationFile\")",
          "new_text": null,
          "old_line_content": "        GetProcAddress(ntdll, \"NtQueryVolumeInformationFile\");",
          "new_line_content": "    // been present since Windows XP, however this code should fail gracefully",
          "content_same": false
        },
        {
          "line": 107,
          "old_api": "read",
          "new_api": null,
          "old_text": "read(p->fd, buffer, max_len)",
          "new_text": null,
          "old_line_content": "        int r = read(p->fd, buffer, max_len);",
          "new_line_content": "            return -1;",
          "content_same": false
        },
        {
          "line": 235,
          "old_api": "pNtQueryVolumeInformationFile",
          "new_api": null,
          "old_text": "pNtQueryVolumeInformationFile(h, &io, &info,\n        sizeof(info), FileFsDeviceInformation)",
          "new_text": null,
          "old_line_content": "    NTSTATUS status = pNtQueryVolumeInformationFile(h, &io, &info,",
          "new_line_content": "    if (h == INVALID_HANDLE_VALUE)",
          "content_same": false
        },
        {
          "line": 237,
          "old_api": "NT_SUCCESS",
          "new_api": null,
          "old_text": "NT_SUCCESS(status)",
          "new_text": null,
          "old_line_content": "    if (!NT_SUCCESS(status))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 114,
          "old_api": "MP_WARN",
          "new_api": null,
          "old_text": "MP_WARN(s, \"File is apparently being appended to, will keep \"\n                    \"retrying with timeouts.\\n\")",
          "new_text": null,
          "old_line_content": "            MP_WARN(s, \"File is apparently being appended to, will keep \"",
          "new_line_content": "            return r;",
          "content_same": false
        },
        {
          "line": 122,
          "old_api": "mp_cancel_wait",
          "new_api": null,
          "old_text": "mp_cancel_wait(p->cancel, RETRY_TIMEOUT)",
          "new_text": null,
          "old_line_content": "        if (mp_cancel_wait(p->cancel, RETRY_TIMEOUT))",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 252,
          "old_api": "talloc_ptrtype",
          "new_api": null,
          "old_text": "talloc_ptrtype(stream, p)",
          "new_text": null,
          "old_line_content": "    struct priv *p = talloc_ptrtype(stream, p);",
          "new_line_content": "}",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 10,
      "total_additions": 44,
      "total_deletions": 45,
      "total_api_changes": 99
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 8,
        "api_related_lines": 99,
        "non_api_lines": 5,
        "non_api_line_numbers": [
          83,
          84,
          85,
          86,
          87
        ]
      }
    },
    "api_calls_before": 59,
    "api_calls_after": 58,
    "diff_info": {
      "added_lines": 8,
      "removed_lines": 3,
      "total_diff_lines": 23
    }
  }
}