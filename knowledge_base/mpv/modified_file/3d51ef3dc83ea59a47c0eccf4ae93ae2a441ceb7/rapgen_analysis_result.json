{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mpv/modified_file/3d51ef3dc83ea59a47c0eccf4ae93ae2a441ceb7",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mpv/modified_file/3d51ef3dc83ea59a47c0eccf4ae93ae2a441ceb7/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mpv/modified_file/3d51ef3dc83ea59a47c0eccf4ae93ae2a441ceb7/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mpv/modified_file/3d51ef3dc83ea59a47c0eccf4ae93ae2a441ceb7/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 419,
          "old_api": "stream_seek_unbuffered",
          "new_api": "stream_control",
          "old_text": "stream_seek_unbuffered(s, pos)",
          "new_text": "stream_control(s, STREAM_CTRL_RECONNECT, NULL)",
          "old_line_content": "        if (stream_seek_unbuffered(s, pos) < 0 && s->pos == pos)",
          "new_line_content": "        int r = stream_control(s, STREAM_CTRL_RECONNECT, NULL);",
          "content_same": false
        },
        {
          "line": 436,
          "old_api": "talloc_strdup",
          "new_api": "talloc_free",
          "old_text": "talloc_strdup(NULL, filename)",
          "new_text": "talloc_free(s->capture_filename)",
          "old_line_content": "                s->capture_filename = talloc_strdup(NULL, filename);",
          "new_line_content": "        talloc_free(s->capture_filename);",
          "content_same": false
        },
        {
          "line": 492,
          "old_api": "MPMIN",
          "new_api": "stream_capture_write",
          "old_text": "MPMIN(len, s->read_chunk)",
          "new_text": "stream_capture_write(s, buf, len)",
          "old_line_content": "    len = MPMIN(len, s->read_chunk);",
          "new_line_content": "    stream_capture_write(s, buf, len);",
          "content_same": false
        },
        {
          "line": 518,
          "old_api": "stream_read_unbuffered",
          "new_api": "assert",
          "old_text": "stream_read_unbuffered(s, buf, buf_size)",
          "new_text": "assert(buf_size >= 0)",
          "old_line_content": "            return stream_read_unbuffered(s, buf, buf_size);",
          "new_line_content": "    assert(buf_size >= 0);",
          "content_same": false
        },
        {
          "line": 564,
          "old_api": "assert",
          "new_api": "memmove",
          "old_text": "assert(buf_valid + chunk <= TOTAL_BUFFER_SIZE)",
          "new_text": "memmove(s->buffer, &s->buffer[s->buf_pos], buf_valid)",
          "old_line_content": "            assert(buf_valid + chunk <= TOTAL_BUFFER_SIZE);",
          "new_line_content": "        memmove(s->buffer, &s->buffer[s->buf_pos], buf_valid);",
          "content_same": false
        },
        {
          "line": 688,
          "old_api": "MP_ERR",
          "new_api": "MP_TRACE",
          "old_text": "MP_ERR(s, \"Invalid seek to negative position %llx!\\n\", (long long)pos)",
          "new_text": "MP_TRACE(s, \"seek to 0x%llX\\n\", (long long)pos)",
          "old_line_content": "        MP_ERR(s, \"Invalid seek to negative position %llx!\\n\", (long long)pos);",
          "new_line_content": "    MP_TRACE(s, \"seek to 0x%llX\\n\", (long long)pos);",
          "content_same": false
        },
        {
          "line": 751,
          "old_api": "talloc_free",
          "new_api": "stream_set_capture_file",
          "old_text": "talloc_free(s)",
          "new_text": "stream_set_capture_file(s, NULL)",
          "old_line_content": "    talloc_free(s);",
          "new_line_content": "    stream_set_capture_file(s, NULL);",
          "content_same": false
        },
        {
          "line": 773,
          "old_api": "talloc_zero",
          "new_api": "stream_check_interrupt_cb",
          "old_text": "talloc_zero(NULL, struct mpv_global)",
          "new_text": "stream_check_interrupt_cb(stream_check_interrupt_ctx, time)",
          "old_line_content": "    struct mpv_global *dummy = talloc_zero(NULL, struct mpv_global);",
          "new_line_content": "    return stream_check_interrupt_cb(stream_check_interrupt_ctx, time);",
          "content_same": false
        },
        {
          "line": 778,
          "old_api": "stream_control",
          "new_api": "assert",
          "old_text": "stream_control(s, STREAM_CTRL_SET_CONTENTS, &(bstr){data, len})",
          "new_text": "assert(len >= 0)",
          "old_line_content": "    stream_control(s, STREAM_CTRL_SET_CONTENTS, &(bstr){data, len});",
          "new_line_content": "    assert(len >= 0);",
          "content_same": false
        },
        {
          "line": 961,
          "old_api": "talloc_free",
          "new_api": "talloc_realloc_size",
          "old_text": "talloc_free(buf)",
          "new_text": "talloc_realloc_size(talloc_ctx, buf, bufsize)",
          "old_line_content": "            talloc_free(buf);",
          "new_line_content": "        buf = talloc_realloc_size(talloc_ctx, buf, bufsize);",
          "content_same": false
        },
        {
          "line": 967,
          "old_api": "memset",
          "new_api": "talloc_free",
          "old_text": "memset(&buf[total_read], 0, padding)",
          "new_text": "talloc_free(buf)",
          "old_line_content": "    memset(&buf[total_read], 0, padding);",
          "new_line_content": "            talloc_free(buf);",
          "content_same": false
        },
        {
          "line": 973,
          "old_api": "stream_control",
          "new_api": "memset",
          "old_text": "stream_control(s, STREAM_CTRL_MANAGES_TIMELINE, NULL)",
          "new_text": "memset(&buf[total_read], 0, padding)",
          "old_line_content": "    return stream_control(s, STREAM_CTRL_MANAGES_TIMELINE, NULL) == STREAM_OK;",
          "new_line_content": "    memset(&buf[total_read], 0, padding);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 517,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(s->buf_pos <= s->buf_len)",
          "old_line_content": "        if (!s->sector_size && buf_size >= STREAM_BUFFER_SIZE)",
          "new_line_content": "    assert(s->buf_pos <= s->buf_len);",
          "content_same": false
        },
        {
          "line": 524,
          "old_api": null,
          "new_api": "stream_read_unbuffered",
          "old_text": null,
          "new_text": "stream_read_unbuffered(s, buf, buf_size)",
          "old_line_content": "    s->buf_pos += len;",
          "new_line_content": "            return stream_read_unbuffered(s, buf, buf_size);",
          "content_same": false
        },
        {
          "line": 525,
          "old_api": null,
          "new_api": "stream_fill_buffer",
          "old_text": null,
          "new_text": "stream_fill_buffer(s)",
          "old_line_content": "    if (len > 0)",
          "new_line_content": "        if (!stream_fill_buffer(s))",
          "content_same": false
        },
        {
          "line": 528,
          "old_api": null,
          "new_api": "FFMIN",
          "old_text": null,
          "new_text": "FFMIN(buf_size, s->buf_len - s->buf_pos)",
          "old_line_content": "}",
          "new_line_content": "    int len = FFMIN(buf_size, s->buf_len - s->buf_pos);",
          "content_same": false
        },
        {
          "line": 529,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy(buf, &s->buffer[s->buf_pos], len)",
          "old_line_content": "",
          "new_line_content": "    memcpy(buf, &s->buffer[s->buf_pos], len);",
          "content_same": false
        },
        {
          "line": 540,
          "old_api": null,
          "new_api": "stream_read_partial",
          "old_text": null,
          "new_text": "stream_read_partial(s, mem, len)",
          "old_line_content": "    total -= len;",
          "new_line_content": "        int read = stream_read_partial(s, mem, len);",
          "content_same": false
        },
        {
          "line": 559,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(len >= 0)",
          "old_line_content": "        // Fill rest of the buffer.",
          "new_line_content": "    assert(len >= 0);",
          "content_same": false
        },
        {
          "line": 560,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(len <= STREAM_MAX_BUFFER_SIZE)",
          "old_line_content": "        while (buf_valid < len) {",
          "new_line_content": "    assert(len <= STREAM_MAX_BUFFER_SIZE);",
          "content_same": false
        },
        {
          "line": 567,
          "old_api": null,
          "new_api": "MPMAX",
          "old_text": null,
          "new_text": "MPMAX(len - buf_valid, STREAM_BUFFER_SIZE)",
          "old_line_content": "                break; // EOF",
          "new_line_content": "            int chunk = MPMAX(len - buf_valid, STREAM_BUFFER_SIZE);",
          "content_same": false
        },
        {
          "line": 570,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(buf_valid + chunk <= TOTAL_BUFFER_SIZE)",
          "old_line_content": "        s->buf_pos = 0;",
          "new_line_content": "            assert(buf_valid + chunk <= TOTAL_BUFFER_SIZE);",
          "content_same": false
        },
        {
          "line": 571,
          "old_api": null,
          "new_api": "stream_read_unbuffered",
          "old_text": null,
          "new_text": "stream_read_unbuffered(s, &s->buffer[buf_valid], chunk)",
          "old_line_content": "        s->buf_len = buf_valid;",
          "new_line_content": "            int read = stream_read_unbuffered(s, &s->buffer[buf_valid], chunk);",
          "content_same": false
        },
        {
          "line": 582,
          "old_api": null,
          "new_api": "FFMIN",
          "old_text": null,
          "new_text": "FFMIN(len, s->buf_len - s->buf_pos)",
          "old_line_content": "    if (!s->write_buffer)",
          "new_line_content": "                  .len = FFMIN(len, s->buf_len - s->buf_pos)};",
          "content_same": false
        },
        {
          "line": 590,
          "old_api": null,
          "new_api": "write_buffer",
          "old_text": null,
          "new_text": "s->write_buffer(s, buf, len)",
          "old_line_content": "}",
          "new_line_content": "    rd = s->write_buffer(s, buf, len);",
          "content_same": false
        },
        {
          "line": 594,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(rd == len && \"stream_write_buffer(): unexpected short write\")",
          "old_line_content": "    while (len > 0) {",
          "new_line_content": "    assert(rd == len && \"stream_write_buffer(): unexpected short write\");",
          "content_same": false
        },
        {
          "line": 603,
          "old_api": null,
          "new_api": "stream_fill_buffer_by",
          "old_text": null,
          "new_text": "stream_fill_buffer_by(s, len)",
          "old_line_content": "        s->buf_pos += x;",
          "new_line_content": "            if (!stream_fill_buffer_by(s, len))",
          "content_same": false
        },
        {
          "line": 629,
          "old_api": null,
          "new_api": "MP_ERR",
          "old_text": null,
          "new_text": "MP_ERR(s, \"Can not seek in this stream\\n\")",
          "old_line_content": "        }",
          "new_line_content": "            MP_ERR(s, \"Can not seek in this stream\\n\");",
          "content_same": false
        },
        {
          "line": 633,
          "old_api": null,
          "new_api": "MP_ERR",
          "old_text": null,
          "new_text": "MP_ERR(s, \"Cannot seek backward in linear streams!\\n\")",
          "old_line_content": "        }",
          "new_line_content": "            MP_ERR(s, \"Cannot seek backward in linear streams!\\n\");",
          "content_same": false
        },
        {
          "line": 636,
          "old_api": null,
          "new_api": "seek",
          "old_text": null,
          "new_text": "s->seek(s, newpos)",
          "old_line_content": "    s->eof = 0; // EOF reset when seek succeeds.",
          "new_line_content": "        if (s->seek(s, newpos) <= 0) {",
          "content_same": false
        },
        {
          "line": 637,
          "old_api": null,
          "new_api": "MP_ERR",
          "old_text": null,
          "new_text": "MP_ERR(s, \"Seek failed\\n\")",
          "old_line_content": "    return -1;",
          "new_line_content": "            MP_ERR(s, \"Seek failed\\n\");",
          "content_same": false
        },
        {
          "line": 650,
          "old_api": null,
          "new_api": "stream_drop_buffers",
          "old_text": null,
          "new_text": "stream_drop_buffers(s)",
          "old_line_content": "    }",
          "new_line_content": "    stream_drop_buffers(s);",
          "content_same": false
        },
        {
          "line": 653,
          "old_api": null,
          "new_api": "seek",
          "old_text": null,
          "new_text": "s->seek(s, pos)",
          "old_line_content": "    if (s->sector_size)",
          "new_line_content": "        if (!(s->flags & MP_STREAM_SEEK) || !s->seek(s, pos))",
          "content_same": false
        },
        {
          "line": 662,
          "old_api": null,
          "new_api": "MP_TRACE",
          "old_text": null,
          "new_text": "MP_TRACE(s, \"Seek from %\" PRId64 \" to %\" PRId64\n             \" (with offset %d)\\n\", s->pos, pos, (int)(pos - newpos))",
          "old_line_content": "        // skipping is handled by generic code below",
          "new_line_content": "    MP_TRACE(s, \"Seek from %\" PRId64 \" to %\" PRId64",
          "content_same": false
        },
        {
          "line": 669,
          "old_api": null,
          "new_api": "stream_seek_unbuffered",
          "old_text": null,
          "new_text": "stream_seek_unbuffered(s, newpos)",
          "old_line_content": "",
          "new_line_content": "    } else if (stream_seek_unbuffered(s, newpos) >= 0) {",
          "content_same": false
        },
        {
          "line": 673,
          "old_api": null,
          "new_api": "stream_skip_read",
          "old_text": null,
          "new_text": "stream_skip_read(s, pos - s->pos)",
          "old_line_content": "    s->eof = 0; // eof should be set only on read",
          "new_line_content": "    if (pos >= s->pos && stream_skip_read(s, pos - s->pos) > 0)",
          "content_same": false
        },
        {
          "line": 681,
          "old_api": null,
          "new_api": "MP_VERBOSE",
          "old_text": null,
          "new_text": "MP_VERBOSE(s, \"Seek to/past EOF: no buffer preloaded.\\n\")",
          "old_line_content": "",
          "new_line_content": "    MP_VERBOSE(s, \"Seek to/past EOF: no buffer preloaded.\\n\");",
          "content_same": false
        },
        {
          "line": 690,
          "old_api": null,
          "new_api": "stream_tell",
          "old_text": null,
          "new_text": "stream_tell(s)",
          "old_line_content": "    }",
          "new_line_content": "    if (pos == stream_tell(s))",
          "content_same": false
        },
        {
          "line": 694,
          "old_api": null,
          "new_api": "MP_ERR",
          "old_text": null,
          "new_text": "MP_ERR(s, \"Invalid seek to negative position %llx!\\n\", (long long)pos)",
          "old_line_content": "            s->buf_pos = x;",
          "new_line_content": "        MP_ERR(s, \"Invalid seek to negative position %llx!\\n\", (long long)pos);",
          "content_same": false
        },
        {
          "line": 706,
          "old_api": null,
          "new_api": "stream_seek_long",
          "old_text": null,
          "new_text": "stream_seek_long(s, pos)",
          "old_line_content": "    if (len < 0)",
          "new_line_content": "    return stream_seek_long(s, pos);",
          "content_same": false
        },
        {
          "line": 711,
          "old_api": null,
          "new_api": "stream_tell",
          "old_text": null,
          "new_text": "stream_tell(s)",
          "old_line_content": "        // absolutely nothing, so test by doing a real read of the last byte.",
          "new_line_content": "    int64_t target = stream_tell(s) + len;",
          "content_same": false
        },
        {
          "line": 713,
          "old_api": null,
          "new_api": "stream_seek",
          "old_text": null,
          "new_text": "stream_seek(s, target)",
          "old_line_content": "        if (r) {",
          "new_line_content": "        return stream_seek(s, target);",
          "content_same": false
        },
        {
          "line": 718,
          "old_api": null,
          "new_api": "stream_seek",
          "old_text": null,
          "new_text": "stream_seek(s, target - 1)",
          "old_line_content": "    }",
          "new_line_content": "        int r = stream_seek(s, target - 1);",
          "content_same": false
        },
        {
          "line": 720,
          "old_api": null,
          "new_api": "stream_read_char",
          "old_text": null,
          "new_text": "stream_read_char(s)",
          "old_line_content": "}",
          "new_line_content": "            stream_read_char(s);",
          "content_same": false
        },
        {
          "line": 721,
          "old_api": null,
          "new_api": "stream_tell",
          "old_text": null,
          "new_text": "stream_tell(s)",
          "old_line_content": "",
          "new_line_content": "            return !stream_eof(s) && stream_tell(s) == target;",
          "content_same": false
        },
        {
          "line": 725,
          "old_api": null,
          "new_api": "stream_skip_read",
          "old_text": null,
          "new_text": "stream_skip_read(s, len)",
          "old_line_content": "        return STREAM_UNSUPPORTED;",
          "new_line_content": "    return stream_skip_read(s, len);",
          "content_same": false
        },
        {
          "line": 732,
          "old_api": null,
          "new_api": "control",
          "old_text": null,
          "new_text": "s->control(s, cmd, arg)",
          "old_line_content": "        return;",
          "new_line_content": "    return s->control(s, cmd, arg);",
          "content_same": false
        },
        {
          "line": 740,
          "old_api": null,
          "new_api": "stream_control",
          "old_text": null,
          "new_text": "stream_control(s, STREAM_CTRL_GET_SIZE, &size)",
          "old_line_content": "void free_stream(stream_t *s)",
          "new_line_content": "    if (stream_control(s, STREAM_CTRL_GET_SIZE, &size) == STREAM_OK) {",
          "content_same": false
        },
        {
          "line": 754,
          "old_api": null,
          "new_api": "close",
          "old_text": null,
          "new_text": "s->close(s)",
          "old_line_content": "void stream_set_interrupt_callback(int (*cb)(struct input_ctx *, int),",
          "new_line_content": "        s->close(s);",
          "content_same": false
        },
        {
          "line": 755,
          "old_api": null,
          "new_api": "free_stream",
          "old_text": null,
          "new_text": "free_stream(s->uncached_stream)",
          "old_line_content": "                                   struct input_ctx *ctx)",
          "new_line_content": "    free_stream(s->uncached_stream);",
          "content_same": false
        },
        {
          "line": 756,
          "old_api": null,
          "new_api": "free_stream",
          "old_text": null,
          "new_text": "free_stream(s->source)",
          "old_line_content": "{",
          "new_line_content": "    free_stream(s->source);",
          "content_same": false
        },
        {
          "line": 757,
          "old_api": null,
          "new_api": "talloc_free",
          "old_text": null,
          "new_text": "talloc_free(s)",
          "old_line_content": "    stream_check_interrupt_cb = cb;",
          "new_line_content": "    talloc_free(s);",
          "content_same": false
        },
        {
          "line": 770,
          "old_api": null,
          "new_api": "mp_sleep_us",
          "old_text": null,
          "new_text": "mp_sleep_us(time * 1000)",
          "old_line_content": "stream_t *open_memory_stream(void *data, int len)",
          "new_line_content": "        mp_sleep_us(time * 1000);",
          "content_same": false
        },
        {
          "line": 779,
          "old_api": null,
          "new_api": "talloc_zero",
          "old_text": null,
          "new_text": "talloc_zero(NULL, struct mpv_global)",
          "old_line_content": "    return s;",
          "new_line_content": "    struct mpv_global *dummy = talloc_zero(NULL, struct mpv_global);",
          "content_same": false
        },
        {
          "line": 781,
          "old_api": null,
          "new_api": "stream_open",
          "old_text": null,
          "new_text": "stream_open(\"memory://\", dummy)",
          "old_line_content": "",
          "new_line_content": "    stream_t *s = stream_open(\"memory://\", dummy);",
          "content_same": false
        },
        {
          "line": 782,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(s)",
          "old_line_content": "static int stream_enable_cache(stream_t **stream, int64_t size, int64_t min,",
          "new_line_content": "    assert(s);",
          "content_same": false
        },
        {
          "line": 783,
          "old_api": null,
          "new_api": "talloc_steal",
          "old_text": null,
          "new_text": "talloc_steal(s, dummy)",
          "old_line_content": "                               int64_t seek_limit);",
          "new_line_content": "    talloc_steal(s, dummy);",
          "content_same": false
        },
        {
          "line": 784,
          "old_api": null,
          "new_api": "stream_control",
          "old_text": null,
          "new_text": "stream_control(s, STREAM_CTRL_SET_CONTENTS, &(bstr){data, len})",
          "old_line_content": "",
          "new_line_content": "    stream_control(s, STREAM_CTRL_SET_CONTENTS, &(bstr){data, len});",
          "content_same": false
        },
        {
          "line": 804,
          "old_api": null,
          "new_api": "stream_enable_cache",
          "old_text": null,
          "new_text": "stream_enable_cache(stream, stream_cache_size,\n                               stream_cache_size *\n                               (stream_cache_min_percent / 100.0),\n                               stream_cache_size *\n                               (stream_cache_seek_min_percent / 100.0))",
          "old_line_content": "",
          "new_line_content": "    return stream_enable_cache(stream, stream_cache_size,",
          "content_same": false
        },
        {
          "line": 819,
          "old_api": null,
          "new_api": "new_stream",
          "old_text": null,
          "new_text": "new_stream()",
          "old_line_content": "",
          "new_line_content": "    stream_t *cache = new_stream();",
          "content_same": false
        },
        {
          "line": 826,
          "old_api": null,
          "new_api": "talloc_strdup",
          "old_text": null,
          "new_text": "talloc_strdup(cache, orig->url)",
          "old_line_content": "    cache->global = orig->global;",
          "new_line_content": "    cache->url = talloc_strdup(cache, orig->url);",
          "content_same": false
        },
        {
          "line": 827,
          "old_api": null,
          "new_api": "talloc_strdup",
          "old_text": null,
          "new_text": "talloc_strdup(cache, orig->mime_type)",
          "old_line_content": "    cache->start_pos = orig->start_pos;",
          "new_line_content": "    cache->mime_type = talloc_strdup(cache, orig->mime_type);",
          "content_same": false
        },
        {
          "line": 828,
          "old_api": null,
          "new_api": "talloc_strdup",
          "old_text": null,
          "new_text": "talloc_strdup(cache, orig->demuxer)",
          "old_line_content": "    cache->end_pos = orig->end_pos;",
          "new_line_content": "    cache->demuxer = talloc_strdup(cache, orig->demuxer);",
          "content_same": false
        },
        {
          "line": 829,
          "old_api": null,
          "new_api": "talloc_strdup",
          "old_text": null,
          "new_text": "talloc_strdup(cache, orig->lavf_type)",
          "old_line_content": "",
          "new_line_content": "    cache->lavf_type = talloc_strdup(cache, orig->lavf_type);",
          "content_same": false
        },
        {
          "line": 836,
          "old_api": null,
          "new_api": "mp_log_new",
          "old_text": null,
          "new_text": "mp_log_new(cache, cache->global->log, \"cache\")",
          "old_line_content": "    } else {",
          "new_line_content": "    cache->log = mp_log_new(cache, cache->global->log, \"cache\");",
          "content_same": false
        },
        {
          "line": 838,
          "old_api": null,
          "new_api": "stream_cache_init",
          "old_text": null,
          "new_text": "stream_cache_init(cache, orig, size, min, seek_limit)",
          "old_line_content": "    }",
          "new_line_content": "    int res = stream_cache_init(cache, orig, size, min, seek_limit);",
          "content_same": false
        },
        {
          "line": 841,
          "old_api": null,
          "new_api": "free_stream",
          "old_text": null,
          "new_text": "free_stream(cache)",
          "old_line_content": "",
          "new_line_content": "        free_stream(cache);",
          "content_same": false
        },
        {
          "line": 850,
          "old_api": null,
          "new_api": "stream_read_char",
          "old_text": null,
          "new_text": "stream_read_char(s)",
          "old_line_content": "",
          "new_line_content": "    unsigned int y = stream_read_char(s);",
          "content_same": false
        },
        {
          "line": 851,
          "old_api": null,
          "new_api": "stream_read_char",
          "old_text": null,
          "new_text": "stream_read_char(s)",
          "old_line_content": "// Read characters until the next '\\n' (including), or until the buffer in s is",
          "new_line_content": "    y = (y << 8) | stream_read_char(s);",
          "content_same": false
        },
        {
          "line": 853,
          "old_api": null,
          "new_api": "bswap_16",
          "old_text": null,
          "new_text": "bswap_16(y)",
          "old_line_content": "static int read_characters(stream_t *s, uint8_t *dst, int dstsize, int utf16)",
          "new_line_content": "        y = bswap_16(y);",
          "content_same": false
        },
        {
          "line": 868,
          "old_api": null,
          "new_api": "stream_read_word_endian",
          "old_text": null,
          "new_text": "stream_read_word_endian(s, utf16 == 2)",
          "old_line_content": "        }",
          "new_line_content": "            GET_UTF16(c, stream_read_word_endian(s, utf16 == 2), return -1;)",
          "content_same": false
        },
        {
          "line": 871,
          "old_api": null,
          "new_api": "PUT_UTF8",
          "old_text": null,
          "new_text": "PUT_UTF8(c, tmp, *cur++ = tmp;)",
          "old_line_content": "        if (s->buf_pos >= s->buf_len)",
          "new_line_content": "            PUT_UTF8(c, tmp, *cur++ = tmp;)",
          "content_same": false
        },
        {
          "line": 878,
          "old_api": null,
          "new_api": "stream_fill_buffer",
          "old_text": null,
          "new_text": "stream_fill_buffer(s)",
          "old_line_content": "            return -1; // line too long",
          "new_line_content": "            stream_fill_buffer(s);",
          "content_same": false
        },
        {
          "line": 881,
          "old_api": null,
          "new_api": "memchr",
          "old_text": null,
          "new_text": "memchr(src, '\\n', src_len)",
          "old_line_content": "        return len;",
          "new_line_content": "        uint8_t *end = memchr(src, '\\n', src_len);",
          "content_same": false
        },
        {
          "line": 885,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy(dst, src, len)",
          "old_line_content": "// On error, or if the line is larger than max-1, return NULL and unset s->eof.",
          "new_line_content": "        memcpy(dst, src, len);",
          "content_same": false
        },
        {
          "line": 904,
          "old_api": null,
          "new_api": "read_characters",
          "old_text": null,
          "new_text": "read_characters(s, &mem[read], max - read - 1, utf16)",
          "old_line_content": "        read += l;",
          "new_line_content": "        int l = read_characters(s, &mem[read], max - read - 1, utf16);",
          "content_same": false
        },
        {
          "line": 905,
          "old_api": null,
          "new_api": "memchr",
          "old_text": null,
          "new_text": "memchr(&mem[read], '\\0', l)",
          "old_line_content": "        if (l == 0 || (read > 0 && mem[read - 1] == '\\n'))",
          "new_line_content": "        if (l < 0 || memchr(&mem[read], '\\0', l)) {",
          "content_same": false
        },
        {
          "line": 906,
          "old_api": null,
          "new_api": "MP_WARN",
          "old_text": null,
          "new_text": "MP_WARN(s, \"error reading line\\n\")",
          "old_line_content": "            break;",
          "new_line_content": "            MP_WARN(s, \"error reading line\\n\");",
          "content_same": false
        },
        {
          "line": 405,
          "old_api": null,
          "new_api": "MP_WARN",
          "old_text": null,
          "new_text": "MP_WARN(s, \"Connection lost! Attempting to reconnect (%d)...\\n\", retry + 1)",
          "old_line_content": "",
          "new_line_content": "        MP_WARN(s, \"Connection lost! Attempting to reconnect (%d)...\\n\", retry + 1);",
          "content_same": false
        },
        {
          "line": 408,
          "old_api": null,
          "new_api": "mp_sleep_us",
          "old_text": null,
          "new_text": "mp_sleep_us(sleep_ms * 1000)",
          "old_line_content": "",
          "new_line_content": "            mp_sleep_us(sleep_ms * 1000);",
          "content_same": false
        },
        {
          "line": 409,
          "old_api": null,
          "new_api": "MPMIN",
          "old_text": null,
          "new_text": "MPMIN(sleep_ms * 2, RECONNECT_SLEEP_MAX_MS)",
          "old_line_content": "        s->eof = 1;",
          "new_line_content": "            sleep_ms = MPMIN(sleep_ms * 2, RECONNECT_SLEEP_MAX_MS);",
          "content_same": false
        },
        {
          "line": 412,
          "old_api": null,
          "new_api": "stream_check_interrupt",
          "old_text": null,
          "new_text": "stream_check_interrupt(0)",
          "old_line_content": "",
          "new_line_content": "        if (stream_check_interrupt(0))",
          "content_same": false
        },
        {
          "line": 925,
          "old_api": null,
          "new_api": "stream_peek",
          "old_text": null,
          "new_text": "stream_peek(s, 4)",
          "old_line_content": "    }",
          "new_line_content": "    bstr data = stream_peek(s, 4);",
          "content_same": false
        },
        {
          "line": 927,
          "old_api": null,
          "new_api": "bstr_startswith0",
          "old_text": null,
          "new_text": "bstr_startswith0(data, bom[n])",
          "old_line_content": "}",
          "new_line_content": "        if (bstr_startswith0(data, bom[n])) {",
          "content_same": false
        },
        {
          "line": 928,
          "old_api": null,
          "new_api": "strlen",
          "old_text": null,
          "new_text": "strlen(bom[n])",
          "old_line_content": "",
          "new_line_content": "            stream_skip(s, strlen(bom[n]));",
          "content_same": false
        },
        {
          "line": 425,
          "old_api": null,
          "new_api": "stream_seek_unbuffered",
          "old_text": null,
          "new_text": "stream_seek_unbuffered(s, pos)",
          "old_line_content": "void stream_set_capture_file(stream_t *s, const char *filename)",
          "new_line_content": "        if (stream_seek_unbuffered(s, pos) < 0 && s->pos == pos)",
          "content_same": false
        },
        {
          "line": 433,
          "old_api": null,
          "new_api": "bstr0",
          "old_text": null,
          "new_text": "bstr0(filename)",
          "old_line_content": "        if (filename) {",
          "new_line_content": "    if (!bstr_equals(bstr0(s->capture_filename), bstr0(filename))) {",
          "content_same": false
        },
        {
          "line": 435,
          "old_api": null,
          "new_api": "fclose",
          "old_text": null,
          "new_text": "fclose(s->capture_file)",
          "old_line_content": "            if (s->capture_file) {",
          "new_line_content": "            fclose(s->capture_file);",
          "content_same": false
        },
        {
          "line": 948,
          "old_api": null,
          "new_api": "abort",
          "old_text": null,
          "new_text": "abort()",
          "old_line_content": "    if (s->end_pos > max_size)",
          "new_line_content": "        abort();",
          "content_same": false
        },
        {
          "line": 440,
          "old_api": null,
          "new_api": "fopen",
          "old_text": null,
          "new_text": "fopen(filename, \"wb\")",
          "old_line_content": "        }",
          "new_line_content": "            s->capture_file = fopen(filename, \"wb\");",
          "content_same": false
        },
        {
          "line": 442,
          "old_api": null,
          "new_api": "talloc_strdup",
          "old_text": null,
          "new_text": "talloc_strdup(NULL, filename)",
          "old_line_content": "}",
          "new_line_content": "                s->capture_filename = talloc_strdup(NULL, filename);",
          "content_same": false
        },
        {
          "line": 444,
          "old_api": null,
          "new_api": "strerror",
          "old_text": null,
          "new_text": "strerror(errno)",
          "old_line_content": "static void stream_capture_write(stream_t *s, void *buf, size_t len)",
          "new_line_content": "                MP_ERR(s, \"Error opening capture file: %s\\n\", strerror(errno));",
          "content_same": false
        },
        {
          "line": 962,
          "old_api": null,
          "new_api": "stream_read",
          "old_text": null,
          "new_text": "stream_read(s, buf + total_read, bufsize - total_read)",
          "old_line_content": "            return (struct bstr){NULL, 0};",
          "new_line_content": "        int readsize = stream_read(s, buf + total_read, bufsize - total_read);",
          "content_same": false
        },
        {
          "line": 453,
          "old_api": null,
          "new_api": "fwrite",
          "old_text": null,
          "new_text": "fwrite(buf, len, 1, s->capture_file)",
          "old_line_content": "",
          "new_line_content": "        if (fwrite(buf, len, 1, s->capture_file) < 1) {",
          "content_same": false
        },
        {
          "line": 454,
          "old_api": null,
          "new_api": "strerror",
          "old_text": null,
          "new_text": "strerror(errno)",
          "old_line_content": "// Read function bypassing the local stream buffer. This will not write into",
          "new_line_content": "            MP_ERR(s, \"Error writing capture file: %s\\n\", strerror(errno));",
          "content_same": false
        },
        {
          "line": 455,
          "old_api": null,
          "new_api": "stream_set_capture_file",
          "old_text": null,
          "new_text": "stream_set_capture_file(s, NULL)",
          "old_line_content": "// s->buffer, but into buf[0..len] instead.",
          "new_line_content": "            stream_set_capture_file(s, NULL);",
          "content_same": false
        },
        {
          "line": 970,
          "old_api": null,
          "new_api": "FFMIN",
          "old_text": null,
          "new_text": "FFMIN(bufsize + (bufsize >> 1), max_size + padding)",
          "old_line_content": "",
          "new_line_content": "        bufsize = FFMIN(bufsize + (bufsize >> 1), max_size + padding);",
          "content_same": false
        },
        {
          "line": 972,
          "old_api": null,
          "new_api": "talloc_realloc_size",
          "old_text": null,
          "new_text": "talloc_realloc_size(talloc_ctx, buf, total_read + padding)",
          "old_line_content": "{",
          "new_line_content": "    buf = talloc_realloc_size(talloc_ctx, buf, total_read + padding);",
          "content_same": false
        },
        {
          "line": 979,
          "old_api": null,
          "new_api": "stream_control",
          "old_text": null,
          "new_text": "stream_control(s, STREAM_CTRL_MANAGES_TIMELINE, NULL)",
          "old_line_content": "",
          "new_line_content": "    return stream_control(s, STREAM_CTRL_MANAGES_TIMELINE, NULL) == STREAM_OK;",
          "content_same": false
        },
        {
          "line": 469,
          "old_api": null,
          "new_api": "fill_buffer",
          "old_text": null,
          "new_text": "s->fill_buffer(s, buf, len)",
          "old_line_content": "            goto eof_out;",
          "new_line_content": "    len = s->fill_buffer ? s->fill_buffer(s, buf, len) : -1;",
          "content_same": false
        },
        {
          "line": 479,
          "old_api": null,
          "new_api": "stream_reconnect",
          "old_text": null,
          "new_text": "stream_reconnect(s)",
          "old_line_content": "eof_out:",
          "new_line_content": "        if (!stream_reconnect(s))",
          "content_same": false
        },
        {
          "line": 483,
          "old_api": null,
          "new_api": "stream_read_unbuffered",
          "old_text": null,
          "new_text": "stream_read_unbuffered(s, buf, orig_len)",
          "old_line_content": "    // When reading succeeded we are obviously not at eof.",
          "new_line_content": "        return stream_read_unbuffered(s, buf, orig_len);",
          "content_same": false
        },
        {
          "line": 498,
          "old_api": null,
          "new_api": "MPMIN",
          "old_text": null,
          "new_text": "MPMIN(len, s->read_chunk)",
          "old_line_content": "    s->buf_len = len;",
          "new_line_content": "    len = MPMIN(len, s->read_chunk);",
          "content_same": false
        },
        {
          "line": 499,
          "old_api": null,
          "new_api": "MPMAX",
          "old_text": null,
          "new_text": "MPMAX(len, STREAM_BUFFER_SIZE)",
          "old_line_content": "    return s->buf_len;",
          "new_line_content": "    len = MPMAX(len, STREAM_BUFFER_SIZE);",
          "content_same": false
        },
        {
          "line": 502,
          "old_api": null,
          "new_api": "stream_read_unbuffered",
          "old_text": null,
          "new_text": "stream_read_unbuffered(s, s->buffer, len)",
          "old_line_content": "int stream_fill_buffer(stream_t *s)",
          "new_line_content": "    len = stream_read_unbuffered(s, s->buffer, len);",
          "content_same": false
        },
        {
          "line": 510,
          "old_api": null,
          "new_api": "stream_fill_buffer_by",
          "old_text": null,
          "new_text": "stream_fill_buffer_by(s, STREAM_BUFFER_SIZE)",
          "old_line_content": "{",
          "new_line_content": "    return stream_fill_buffer_by(s, STREAM_BUFFER_SIZE);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 512,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(buf_size >= 0)",
          "new_text": null,
          "old_line_content": "    assert(buf_size >= 0);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 519,
          "old_api": "stream_fill_buffer",
          "new_api": null,
          "old_text": "stream_fill_buffer(s)",
          "new_text": null,
          "old_line_content": "        if (!stream_fill_buffer(s))",
          "new_line_content": "    if (s->buf_pos == s->buf_len && buf_size > 0) {",
          "content_same": false
        },
        {
          "line": 522,
          "old_api": "FFMIN",
          "new_api": null,
          "old_text": "FFMIN(buf_size, s->buf_len - s->buf_pos)",
          "new_text": null,
          "old_line_content": "    int len = FFMIN(buf_size, s->buf_len - s->buf_pos);",
          "new_line_content": "        // Also, small reads will be more efficient with buffering & copying",
          "content_same": false
        },
        {
          "line": 523,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy(buf, &s->buffer[s->buf_pos], len)",
          "new_text": null,
          "old_line_content": "    memcpy(buf, &s->buffer[s->buf_pos], len);",
          "new_line_content": "        if (!s->sector_size && buf_size >= STREAM_BUFFER_SIZE)",
          "content_same": false
        },
        {
          "line": 534,
          "old_api": "stream_read_partial",
          "new_api": null,
          "old_text": "stream_read_partial(s, mem, len)",
          "new_text": null,
          "old_line_content": "        int read = stream_read_partial(s, mem, len);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 553,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(len >= 0)",
          "new_text": null,
          "old_line_content": "    assert(len >= 0);",
          "new_line_content": "// pointer to the internal buffer, starting from the current read position.",
          "content_same": false
        },
        {
          "line": 554,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(len <= STREAM_MAX_BUFFER_SIZE)",
          "new_text": null,
          "old_line_content": "    assert(len <= STREAM_MAX_BUFFER_SIZE);",
          "new_line_content": "// Can read ahead at most STREAM_MAX_BUFFER_SIZE bytes.",
          "content_same": false
        },
        {
          "line": 558,
          "old_api": "memmove",
          "new_api": null,
          "old_text": "memmove(s->buffer, &s->buffer[s->buf_pos], buf_valid)",
          "new_text": null,
          "old_line_content": "        memmove(s->buffer, &s->buffer[s->buf_pos], buf_valid);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 561,
          "old_api": "MPMAX",
          "new_api": null,
          "old_text": "MPMAX(len - buf_valid, STREAM_BUFFER_SIZE)",
          "new_text": null,
          "old_line_content": "            int chunk = MPMAX(len - buf_valid, STREAM_BUFFER_SIZE);",
          "new_line_content": "    if (s->buf_len - s->buf_pos < len) {",
          "content_same": false
        },
        {
          "line": 565,
          "old_api": "stream_read_unbuffered",
          "new_api": null,
          "old_text": "stream_read_unbuffered(s, &s->buffer[buf_valid], chunk)",
          "new_text": null,
          "old_line_content": "            int read = stream_read_unbuffered(s, &s->buffer[buf_valid], chunk);",
          "new_line_content": "        // Fill rest of the buffer.",
          "content_same": false
        },
        {
          "line": 576,
          "old_api": "FFMIN",
          "new_api": null,
          "old_text": "FFMIN(len, s->buf_len - s->buf_pos)",
          "new_text": null,
          "old_line_content": "                  .len = FFMIN(len, s->buf_len - s->buf_pos)};",
          "new_line_content": "        s->buf_pos = 0;",
          "content_same": false
        },
        {
          "line": 584,
          "old_api": "write_buffer",
          "new_api": null,
          "old_text": "s->write_buffer(s, buf, len)",
          "new_text": null,
          "old_line_content": "    rd = s->write_buffer(s, buf, len);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 588,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(rd == len && \"stream_write_buffer(): unexpected short write\")",
          "new_text": null,
          "old_line_content": "    assert(rd == len && \"stream_write_buffer(): unexpected short write\");",
          "new_line_content": "    if (!s->write_buffer)",
          "content_same": false
        },
        {
          "line": 597,
          "old_api": "stream_fill_buffer_by",
          "new_api": null,
          "old_text": "stream_fill_buffer_by(s, len)",
          "new_text": null,
          "old_line_content": "            if (!stream_fill_buffer_by(s, len))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 623,
          "old_api": "MP_ERR",
          "new_api": null,
          "old_text": "MP_ERR(s, \"Can not seek in this stream\\n\")",
          "new_text": null,
          "old_line_content": "            MP_ERR(s, \"Can not seek in this stream\\n\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 627,
          "old_api": "MP_ERR",
          "new_api": null,
          "old_text": "MP_ERR(s, \"Cannot seek backward in linear streams!\\n\")",
          "new_text": null,
          "old_line_content": "            MP_ERR(s, \"Cannot seek backward in linear streams!\\n\");",
          "new_line_content": "    if (newpos != s->pos) {",
          "content_same": false
        },
        {
          "line": 630,
          "old_api": "seek",
          "new_api": null,
          "old_text": "s->seek(s, newpos)",
          "new_text": null,
          "old_line_content": "        if (s->seek(s, newpos) <= 0) {",
          "new_line_content": "            return 0;",
          "content_same": false
        },
        {
          "line": 631,
          "old_api": "MP_ERR",
          "new_api": null,
          "old_text": "MP_ERR(s, \"Seek failed\\n\")",
          "new_text": null,
          "old_line_content": "            MP_ERR(s, \"Seek failed\\n\");",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 644,
          "old_api": "stream_drop_buffers",
          "new_api": null,
          "old_text": "stream_drop_buffers(s)",
          "new_text": null,
          "old_line_content": "    stream_drop_buffers(s);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 647,
          "old_api": "seek",
          "new_api": null,
          "old_text": "s->seek(s, pos)",
          "new_text": null,
          "old_line_content": "        if (!(s->flags & MP_STREAM_SEEK) || !s->seek(s, pos))",
          "new_line_content": "// Unlike stream_seek_unbuffered(), it still fills the local buffer.",
          "content_same": false
        },
        {
          "line": 656,
          "old_api": "MP_TRACE",
          "new_api": null,
          "old_text": "MP_TRACE(s, \"Seek from %\" PRId64 \" to %\" PRId64\n             \" (with offset %d)\\n\", s->pos, pos, (int)(pos - newpos))",
          "new_text": null,
          "old_line_content": "    MP_TRACE(s, \"Seek from %\" PRId64 \" to %\" PRId64",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 663,
          "old_api": "stream_seek_unbuffered",
          "new_api": null,
          "old_text": "stream_seek_unbuffered(s, newpos)",
          "new_text": null,
          "old_line_content": "    } else if (stream_seek_unbuffered(s, newpos) >= 0) {",
          "new_line_content": "             \" (with offset %d)\\n\", s->pos, pos, (int)(pos - newpos));",
          "content_same": false
        },
        {
          "line": 667,
          "old_api": "stream_skip_read",
          "new_api": null,
          "old_text": "stream_skip_read(s, pos - s->pos)",
          "new_text": null,
          "old_line_content": "    if (pos >= s->pos && stream_skip_read(s, pos - s->pos) > 0)",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 675,
          "old_api": "MP_VERBOSE",
          "new_api": null,
          "old_text": "MP_VERBOSE(s, \"Seek to/past EOF: no buffer preloaded.\\n\")",
          "new_text": null,
          "old_line_content": "    MP_VERBOSE(s, \"Seek to/past EOF: no buffer preloaded.\\n\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 682,
          "old_api": "MP_TRACE",
          "new_api": null,
          "old_text": "MP_TRACE(s, \"seek to 0x%llX\\n\", (long long)pos)",
          "new_text": null,
          "old_line_content": "    MP_TRACE(s, \"seek to 0x%llX\\n\", (long long)pos);",
          "new_line_content": "    return 1;",
          "content_same": false
        },
        {
          "line": 684,
          "old_api": "stream_tell",
          "new_api": null,
          "old_text": "stream_tell(s)",
          "new_text": null,
          "old_line_content": "    if (pos == stream_tell(s))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 700,
          "old_api": "stream_seek_long",
          "new_api": null,
          "old_text": "stream_seek_long(s, pos)",
          "new_text": null,
          "old_line_content": "    return stream_seek_long(s, pos);",
          "new_line_content": "            s->buf_pos = x;",
          "content_same": false
        },
        {
          "line": 705,
          "old_api": "stream_tell",
          "new_api": null,
          "old_text": "stream_tell(s)",
          "new_text": null,
          "old_line_content": "    int64_t target = stream_tell(s) + len;",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 707,
          "old_api": "stream_seek",
          "new_api": null,
          "old_text": "stream_seek(s, target)",
          "new_text": null,
          "old_line_content": "        return stream_seek(s, target);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 712,
          "old_api": "stream_seek",
          "new_api": null,
          "old_text": "stream_seek(s, target - 1)",
          "new_text": null,
          "old_line_content": "        int r = stream_seek(s, target - 1);",
          "new_line_content": "    if (len < 0)",
          "content_same": false
        },
        {
          "line": 714,
          "old_api": "stream_read_char",
          "new_api": null,
          "old_text": "stream_read_char(s)",
          "new_text": null,
          "old_line_content": "            stream_read_char(s);",
          "new_line_content": "    if (len > 2 * STREAM_BUFFER_SIZE && (s->flags & MP_STREAM_SEEK_FW)) {",
          "content_same": false
        },
        {
          "line": 715,
          "old_api": "stream_tell",
          "new_api": null,
          "old_text": "stream_tell(s)",
          "new_text": null,
          "old_line_content": "            return !stream_eof(s) && stream_tell(s) == target;",
          "new_line_content": "        // Seek to 1 byte before target - this is the only way to distinguish",
          "content_same": false
        },
        {
          "line": 719,
          "old_api": "stream_skip_read",
          "new_api": null,
          "old_text": "stream_skip_read(s, len)",
          "new_text": null,
          "old_line_content": "    return stream_skip_read(s, len);",
          "new_line_content": "        if (r) {",
          "content_same": false
        },
        {
          "line": 726,
          "old_api": "control",
          "new_api": null,
          "old_text": "s->control(s, cmd, arg)",
          "new_text": null,
          "old_line_content": "    return s->control(s, cmd, arg);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 734,
          "old_api": "stream_control",
          "new_api": null,
          "old_text": "stream_control(s, STREAM_CTRL_GET_SIZE, &size)",
          "new_text": null,
          "old_line_content": "    if (stream_control(s, STREAM_CTRL_GET_SIZE, &size) == STREAM_OK) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 745,
          "old_api": "stream_set_capture_file",
          "new_api": null,
          "old_text": "stream_set_capture_file(s, NULL)",
          "new_text": null,
          "old_line_content": "    stream_set_capture_file(s, NULL);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 748,
          "old_api": "close",
          "new_api": null,
          "old_text": "s->close(s)",
          "new_text": null,
          "old_line_content": "        s->close(s);",
          "new_line_content": "    if (!s)",
          "content_same": false
        },
        {
          "line": 749,
          "old_api": "free_stream",
          "new_api": null,
          "old_text": "free_stream(s->uncached_stream)",
          "new_text": null,
          "old_line_content": "    free_stream(s->uncached_stream);",
          "new_line_content": "        return;",
          "content_same": false
        },
        {
          "line": 750,
          "old_api": "free_stream",
          "new_api": null,
          "old_text": "free_stream(s->source)",
          "new_text": null,
          "old_line_content": "    free_stream(s->source);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 764,
          "old_api": "mp_sleep_us",
          "new_api": null,
          "old_text": "mp_sleep_us(time * 1000)",
          "new_text": null,
          "old_line_content": "        mp_sleep_us(time * 1000);",
          "new_line_content": "    stream_check_interrupt_ctx = ctx;",
          "content_same": false
        },
        {
          "line": 767,
          "old_api": "stream_check_interrupt_cb",
          "new_api": null,
          "old_text": "stream_check_interrupt_cb(stream_check_interrupt_ctx, time)",
          "new_text": null,
          "old_line_content": "    return stream_check_interrupt_cb(stream_check_interrupt_ctx, time);",
          "new_line_content": "int stream_check_interrupt(int time)",
          "content_same": false
        },
        {
          "line": 772,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(len >= 0)",
          "new_text": null,
          "old_line_content": "    assert(len >= 0);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 775,
          "old_api": "stream_open",
          "new_api": null,
          "old_text": "stream_open(\"memory://\", dummy)",
          "new_text": null,
          "old_line_content": "    stream_t *s = stream_open(\"memory://\", dummy);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 776,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(s)",
          "new_text": null,
          "old_line_content": "    assert(s);",
          "new_line_content": "stream_t *open_memory_stream(void *data, int len)",
          "content_same": false
        },
        {
          "line": 777,
          "old_api": "talloc_steal",
          "new_api": null,
          "old_text": "talloc_steal(s, dummy)",
          "new_text": null,
          "old_line_content": "    talloc_steal(s, dummy);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 798,
          "old_api": "stream_enable_cache",
          "new_api": null,
          "old_text": "stream_enable_cache(stream, stream_cache_size,\n                               stream_cache_size *\n                               (stream_cache_min_percent / 100.0),\n                               stream_cache_size *\n                               (stream_cache_seek_min_percent / 100.0))",
          "new_text": null,
          "old_line_content": "    return stream_enable_cache(stream, stream_cache_size,",
          "new_line_content": "                                float stream_cache_seek_min_percent)",
          "content_same": false
        },
        {
          "line": 813,
          "old_api": "new_stream",
          "new_api": null,
          "old_text": "new_stream()",
          "new_text": null,
          "old_line_content": "    stream_t *cache = new_stream();",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 820,
          "old_api": "talloc_strdup",
          "new_api": null,
          "old_text": "talloc_strdup(cache, orig->url)",
          "new_text": null,
          "old_line_content": "    cache->url = talloc_strdup(cache, orig->url);",
          "new_line_content": "    cache->uncached_type = orig->type;",
          "content_same": false
        },
        {
          "line": 821,
          "old_api": "talloc_strdup",
          "new_api": null,
          "old_text": "talloc_strdup(cache, orig->mime_type)",
          "new_text": null,
          "old_line_content": "    cache->mime_type = talloc_strdup(cache, orig->mime_type);",
          "new_line_content": "    cache->uncached_stream = orig;",
          "content_same": false
        },
        {
          "line": 822,
          "old_api": "talloc_strdup",
          "new_api": null,
          "old_text": "talloc_strdup(cache, orig->demuxer)",
          "new_text": null,
          "old_line_content": "    cache->demuxer = talloc_strdup(cache, orig->demuxer);",
          "new_line_content": "    cache->flags |= MP_STREAM_SEEK;",
          "content_same": false
        },
        {
          "line": 823,
          "old_api": "talloc_strdup",
          "new_api": null,
          "old_text": "talloc_strdup(cache, orig->lavf_type)",
          "new_text": null,
          "old_line_content": "    cache->lavf_type = talloc_strdup(cache, orig->lavf_type);",
          "new_line_content": "    cache->mode = STREAM_READ;",
          "content_same": false
        },
        {
          "line": 830,
          "old_api": "mp_log_new",
          "new_api": null,
          "old_text": "mp_log_new(cache, cache->global->log, \"cache\")",
          "new_text": null,
          "old_line_content": "    cache->log = mp_log_new(cache, cache->global->log, \"cache\");",
          "new_line_content": "    cache->safe_origin = orig->safe_origin;",
          "content_same": false
        },
        {
          "line": 832,
          "old_api": "stream_cache_init",
          "new_api": null,
          "old_text": "stream_cache_init(cache, orig, size, min, seek_limit)",
          "new_text": null,
          "old_line_content": "    int res = stream_cache_init(cache, orig, size, min, seek_limit);",
          "new_line_content": "    cache->global = orig->global;",
          "content_same": false
        },
        {
          "line": 835,
          "old_api": "free_stream",
          "new_api": null,
          "old_text": "free_stream(cache)",
          "new_text": null,
          "old_line_content": "        free_stream(cache);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 844,
          "old_api": "stream_read_char",
          "new_api": null,
          "old_text": "stream_read_char(s)",
          "new_text": null,
          "old_line_content": "    unsigned int y = stream_read_char(s);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 845,
          "old_api": "stream_read_char",
          "new_api": null,
          "old_text": "stream_read_char(s)",
          "new_text": null,
          "old_line_content": "    y = (y << 8) | stream_read_char(s);",
          "new_line_content": "    return res;",
          "content_same": false
        },
        {
          "line": 847,
          "old_api": "bswap_16",
          "new_api": null,
          "old_text": "bswap_16(y)",
          "new_text": null,
          "old_line_content": "        y = bswap_16(y);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 862,
          "old_api": "stream_read_word_endian",
          "new_api": null,
          "old_text": "stream_read_word_endian(s, utf16 == 2)",
          "new_text": null,
          "old_line_content": "            GET_UTF16(c, stream_read_word_endian(s, utf16 == 2), return -1;)",
          "new_line_content": "        uint8_t *cur = dst;",
          "content_same": false
        },
        {
          "line": 865,
          "old_api": "PUT_UTF8",
          "new_api": null,
          "old_text": "PUT_UTF8(c, tmp, *cur++ = tmp;)",
          "new_text": null,
          "old_line_content": "            PUT_UTF8(c, tmp, *cur++ = tmp;)",
          "new_line_content": "                return -1; // line too long",
          "content_same": false
        },
        {
          "line": 872,
          "old_api": "stream_fill_buffer",
          "new_api": null,
          "old_text": "stream_fill_buffer(s)",
          "new_text": null,
          "old_line_content": "            stream_fill_buffer(s);",
          "new_line_content": "            if (c == '\\n')",
          "content_same": false
        },
        {
          "line": 875,
          "old_api": "memchr",
          "new_api": null,
          "old_text": "memchr(src, '\\n', src_len)",
          "new_text": null,
          "old_line_content": "        uint8_t *end = memchr(src, '\\n', src_len);",
          "new_line_content": "        return cur - dst;",
          "content_same": false
        },
        {
          "line": 879,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy(dst, src, len)",
          "new_text": null,
          "old_line_content": "        memcpy(dst, src, len);",
          "new_line_content": "        uint8_t *src = s->buffer + s->buf_pos;",
          "content_same": false
        },
        {
          "line": 898,
          "old_api": "read_characters",
          "new_api": null,
          "old_text": "read_characters(s, &mem[read], max - read - 1, utf16)",
          "new_text": null,
          "old_line_content": "        int l = read_characters(s, &mem[read], max - read - 1, utf16);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 899,
          "old_api": "memchr",
          "new_api": null,
          "old_text": "memchr(&mem[read], '\\0', l)",
          "new_text": null,
          "old_line_content": "        if (l < 0 || memchr(&mem[read], '\\0', l)) {",
          "new_line_content": "    if (max < 1)",
          "content_same": false
        },
        {
          "line": 900,
          "old_api": "MP_WARN",
          "new_api": null,
          "old_text": "MP_WARN(s, \"error reading line\\n\")",
          "new_text": null,
          "old_line_content": "            MP_WARN(s, \"error reading line\\n\");",
          "new_line_content": "        return NULL;",
          "content_same": false
        },
        {
          "line": 404,
          "old_api": "MP_WARN",
          "new_api": null,
          "old_text": "MP_WARN(s, \"Connection lost! Attempting to reconnect (%d)...\\n\", retry + 1)",
          "new_text": null,
          "old_line_content": "        MP_WARN(s, \"Connection lost! Attempting to reconnect (%d)...\\n\", retry + 1);",
          "new_line_content": "    for (int retry = 0; retry < MAX_RECONNECT_RETRIES; retry++) {",
          "content_same": false
        },
        {
          "line": 406,
          "old_api": "stream_check_interrupt",
          "new_api": null,
          "old_text": "stream_check_interrupt(retry ? RECONNECT_SLEEP_MS : 0)",
          "new_text": null,
          "old_line_content": "        if (stream_check_interrupt(retry ? RECONNECT_SLEEP_MS : 0))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 919,
          "old_api": "stream_peek",
          "new_api": null,
          "old_text": "stream_peek(s, 4)",
          "new_text": null,
          "old_line_content": "    bstr data = stream_peek(s, 4);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 921,
          "old_api": "bstr_startswith0",
          "new_api": null,
          "old_text": "bstr_startswith0(data, bom[n])",
          "new_text": null,
          "old_line_content": "        if (bstr_startswith0(data, bom[n])) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 922,
          "old_api": "strlen",
          "new_api": null,
          "old_text": "strlen(bom[n])",
          "new_text": null,
          "old_line_content": "            stream_skip(s, strlen(bom[n]));",
          "new_line_content": "// Return utf16 argument for stream_read_line",
          "content_same": false
        },
        {
          "line": 413,
          "old_api": "stream_control",
          "new_api": null,
          "old_text": "stream_control(s, STREAM_CTRL_RECONNECT, NULL)",
          "new_text": null,
          "old_line_content": "        int r = stream_control(s, STREAM_CTRL_RECONNECT, NULL);",
          "new_line_content": "            return 0;",
          "content_same": false
        },
        {
          "line": 427,
          "old_api": "bstr0",
          "new_api": null,
          "old_text": "bstr0(filename)",
          "new_text": null,
          "old_line_content": "    if (!bstr_equals(bstr0(s->capture_filename), bstr0(filename))) {",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 429,
          "old_api": "fclose",
          "new_api": null,
          "old_text": "fclose(s->capture_file)",
          "new_text": null,
          "old_line_content": "            fclose(s->capture_file);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 430,
          "old_api": "talloc_free",
          "new_api": null,
          "old_text": "talloc_free(s->capture_filename)",
          "new_text": null,
          "old_line_content": "        talloc_free(s->capture_filename);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 942,
          "old_api": "abort",
          "new_api": null,
          "old_text": "abort()",
          "new_text": null,
          "old_line_content": "        abort();",
          "new_line_content": "// For convenience, the returned buffer is padded with a 0 byte. The padding",
          "content_same": false
        },
        {
          "line": 434,
          "old_api": "fopen",
          "new_api": null,
          "old_text": "fopen(filename, \"wb\")",
          "new_text": null,
          "old_line_content": "            s->capture_file = fopen(filename, \"wb\");",
          "new_line_content": "        if (s->capture_file)",
          "content_same": false
        },
        {
          "line": 438,
          "old_api": "strerror",
          "new_api": null,
          "old_text": "strerror(errno)",
          "new_text": null,
          "old_line_content": "                MP_ERR(s, \"Error opening capture file: %s\\n\", strerror(errno));",
          "new_line_content": "        s->capture_filename = NULL;",
          "content_same": false
        },
        {
          "line": 955,
          "old_api": "talloc_realloc_size",
          "new_api": null,
          "old_text": "talloc_realloc_size(talloc_ctx, buf, bufsize)",
          "new_text": null,
          "old_line_content": "        buf = talloc_realloc_size(talloc_ctx, buf, bufsize);",
          "new_line_content": "        return (struct bstr){NULL, 0};",
          "content_same": false
        },
        {
          "line": 956,
          "old_api": "stream_read",
          "new_api": null,
          "old_text": "stream_read(s, buf + total_read, bufsize - total_read)",
          "new_text": null,
          "old_line_content": "        int readsize = stream_read(s, buf + total_read, bufsize - total_read);",
          "new_line_content": "    if (s->end_pos > 0)",
          "content_same": false
        },
        {
          "line": 447,
          "old_api": "fwrite",
          "new_api": null,
          "old_text": "fwrite(buf, len, 1, s->capture_file)",
          "new_text": null,
          "old_line_content": "        if (fwrite(buf, len, 1, s->capture_file) < 1) {",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 448,
          "old_api": "strerror",
          "new_api": null,
          "old_text": "strerror(errno)",
          "new_text": null,
          "old_line_content": "            MP_ERR(s, \"Error writing capture file: %s\\n\", strerror(errno));",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 449,
          "old_api": "stream_set_capture_file",
          "new_api": null,
          "old_text": "stream_set_capture_file(s, NULL)",
          "new_text": null,
          "old_line_content": "            stream_set_capture_file(s, NULL);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 964,
          "old_api": "FFMIN",
          "new_api": null,
          "old_text": "FFMIN(bufsize + (bufsize >> 1), max_size + padding)",
          "new_text": null,
          "old_line_content": "        bufsize = FFMIN(bufsize + (bufsize >> 1), max_size + padding);",
          "new_line_content": "        if (total_read < bufsize)",
          "content_same": false
        },
        {
          "line": 966,
          "old_api": "talloc_realloc_size",
          "new_api": null,
          "old_text": "talloc_realloc_size(talloc_ctx, buf, total_read + padding)",
          "new_text": null,
          "old_line_content": "    buf = talloc_realloc_size(talloc_ctx, buf, total_read + padding);",
          "new_line_content": "        if (bufsize > max_size) {",
          "content_same": false
        },
        {
          "line": 463,
          "old_api": "fill_buffer",
          "new_api": null,
          "old_text": "s->fill_buffer(s, buf, len)",
          "new_text": null,
          "old_line_content": "    len = s->fill_buffer ? s->fill_buffer(s, buf, len) : -1;",
          "new_line_content": "// Partial reads are possible, even if EOF is not reached.",
          "content_same": false
        },
        {
          "line": 473,
          "old_api": "stream_reconnect",
          "new_api": null,
          "old_text": "stream_reconnect(s)",
          "new_text": null,
          "old_line_content": "        if (!stream_reconnect(s))",
          "new_line_content": "        // do not retry if this looks like proper eof",
          "content_same": false
        },
        {
          "line": 477,
          "old_api": "stream_read_unbuffered",
          "new_api": null,
          "old_text": "stream_read_unbuffered(s, buf, orig_len)",
          "new_text": null,
          "old_line_content": "        return stream_read_unbuffered(s, buf, orig_len);",
          "new_line_content": "        // just in case this is an error e.g. due to network",
          "content_same": false
        },
        {
          "line": 486,
          "old_api": "stream_capture_write",
          "new_api": null,
          "old_text": "stream_capture_write(s, buf, len)",
          "new_text": null,
          "old_line_content": "    stream_capture_write(s, buf, len);",
          "new_line_content": "        s->eof = 1;",
          "content_same": false
        },
        {
          "line": 493,
          "old_api": "MPMAX",
          "new_api": null,
          "old_text": "MPMAX(len, STREAM_BUFFER_SIZE)",
          "new_text": null,
          "old_line_content": "    len = MPMAX(len, STREAM_BUFFER_SIZE);",
          "new_line_content": "    return len;",
          "content_same": false
        },
        {
          "line": 496,
          "old_api": "stream_read_unbuffered",
          "new_api": null,
          "old_text": "stream_read_unbuffered(s, s->buffer, len)",
          "new_text": null,
          "old_line_content": "    len = stream_read_unbuffered(s, s->buffer, len);",
          "new_line_content": "static int stream_fill_buffer_by(stream_t *s, int64_t len)",
          "content_same": false
        },
        {
          "line": 504,
          "old_api": "stream_fill_buffer_by",
          "new_api": null,
          "old_text": "stream_fill_buffer_by(s, STREAM_BUFFER_SIZE)",
          "new_text": null,
          "old_line_content": "    return stream_fill_buffer_by(s, STREAM_BUFFER_SIZE);",
          "new_line_content": "    s->buf_len = len;",
          "content_same": false
        },
        {
          "line": 511,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(s->buf_pos <= s->buf_len)",
          "new_text": null,
          "old_line_content": "    assert(s->buf_pos <= s->buf_len);",
          "new_line_content": "}",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 12,
      "total_additions": 94,
      "total_deletions": 92,
      "total_api_changes": 198
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 9,
        "api_related_lines": 198,
        "non_api_lines": 5,
        "non_api_line_numbers": [
          397,
          403,
          407,
          410,
          411
        ]
      }
    },
    "api_calls_before": 165,
    "api_calls_after": 167,
    "diff_info": {
      "added_lines": 8,
      "removed_lines": 2,
      "total_diff_lines": 30
    }
  }
}