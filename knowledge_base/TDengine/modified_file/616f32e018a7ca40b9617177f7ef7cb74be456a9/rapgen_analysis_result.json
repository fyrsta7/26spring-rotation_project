{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/TDengine/modified_file/616f32e018a7ca40b9617177f7ef7cb74be456a9",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/TDengine/modified_file/616f32e018a7ca40b9617177f7ef7cb74be456a9/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/TDengine/modified_file/616f32e018a7ca40b9617177f7ef7cb74be456a9/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/TDengine/modified_file/616f32e018a7ca40b9617177f7ef7cb74be456a9/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 744,
          "old_api": "calloc",
          "new_api": "malloc",
          "old_text": "calloc(1, sizeof(SHashNode) + keyLen + dsize)",
          "new_text": "malloc(sizeof(SHashNode) + keyLen + dsize)",
          "old_line_content": "  SHashNode *pNewNode = calloc(1, sizeof(SHashNode) + keyLen + dsize);",
          "new_line_content": "  SHashNode *pNewNode = malloc(sizeof(SHashNode) + keyLen + dsize);",
          "content_same": false
        },
        {
          "line": 890,
          "old_api": "taosWUnLockLatch",
          "new_api": "GET_HASH_NODE_DATA",
          "old_text": "taosWUnLockLatch(&pe->latch)",
          "new_text": "GET_HASH_NODE_DATA(pNode)",
          "old_line_content": "      taosWUnLockLatch(&pe->latch);",
          "new_line_content": "    data = GET_HASH_NODE_DATA(pNode);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 896,
          "old_api": null,
          "new_api": "__rd_unlock",
          "old_text": null,
          "new_text": "__rd_unlock(&pHashObj->lock, pHashObj->type)",
          "old_line_content": "",
          "new_line_content": "  __rd_unlock(&pHashObj->lock, pHashObj->type);",
          "content_same": false
        },
        {
          "line": 905,
          "old_api": null,
          "new_api": "__rd_lock",
          "old_text": null,
          "new_text": "__rd_lock(&pHashObj->lock, pHashObj->type)",
          "old_line_content": "  int slot;",
          "new_line_content": "  __rd_lock(&pHashObj->lock, pHashObj->type);",
          "content_same": false
        },
        {
          "line": 778,
          "old_api": null,
          "new_api": "taosHashGetSize",
          "old_text": null,
          "new_text": "taosHashGetSize(pHashObj)",
          "old_line_content": "",
          "new_line_content": "  return (pHashObj->capacity * (sizeof(SHashEntry) + POINTER_BYTES)) + sizeof(SHashNode) * taosHashGetSize(pHashObj) + sizeof(SHashObj);",
          "content_same": false
        },
        {
          "line": 908,
          "old_api": null,
          "new_api": "taosHashReleaseNode",
          "old_text": null,
          "new_text": "taosHashReleaseNode(pHashObj, p, &slot)",
          "old_line_content": "  SHashEntry *pe = pHashObj->hashList[slot];",
          "new_line_content": "  taosHashReleaseNode(pHashObj, p, &slot);",
          "content_same": false
        },
        {
          "line": 782,
          "old_api": null,
          "new_api": "GET_HASH_PNODE",
          "old_text": null,
          "new_text": "GET_HASH_PNODE(data)",
          "old_line_content": "}",
          "new_line_content": "  SHashNode * node = GET_HASH_PNODE(data);",
          "content_same": false
        },
        {
          "line": 783,
          "old_api": null,
          "new_api": "GET_HASH_NODE_KEY",
          "old_text": null,
          "new_text": "GET_HASH_NODE_KEY(node)",
          "old_line_content": "",
          "new_line_content": "  return GET_HASH_NODE_KEY(node);",
          "content_same": false
        },
        {
          "line": 912,
          "old_api": null,
          "new_api": "taosWUnLockLatch",
          "old_text": null,
          "new_text": "taosWUnLockLatch(&pe->latch)",
          "old_line_content": "",
          "new_line_content": "    taosWUnLockLatch(&pe->latch);",
          "content_same": false
        },
        {
          "line": 787,
          "old_api": null,
          "new_api": "GET_HASH_PNODE",
          "old_text": null,
          "new_text": "GET_HASH_PNODE(data)",
          "old_line_content": "}",
          "new_line_content": "  SHashNode * node = GET_HASH_PNODE(data);",
          "content_same": false
        },
        {
          "line": 915,
          "old_api": null,
          "new_api": "__rd_unlock",
          "old_text": null,
          "new_text": "__rd_unlock(&pHashObj->lock, pHashObj->type)",
          "old_line_content": "",
          "new_line_content": "  __rd_unlock(&pHashObj->lock, pHashObj->type);",
          "content_same": false
        },
        {
          "line": 795,
          "old_api": null,
          "new_api": "GET_HASH_PNODE",
          "old_text": null,
          "new_text": "GET_HASH_PNODE(p)",
          "old_line_content": "",
          "new_line_content": "  SHashNode *pOld = (SHashNode *)GET_HASH_PNODE(p);",
          "content_same": false
        },
        {
          "line": 798,
          "old_api": null,
          "new_api": "HASH_INDEX",
          "old_text": null,
          "new_text": "HASH_INDEX(pOld->hashVal, pHashObj->capacity)",
          "old_line_content": "",
          "new_line_content": "  *slot = HASH_INDEX(pOld->hashVal, pHashObj->capacity);",
          "content_same": false
        },
        {
          "line": 803,
          "old_api": null,
          "new_api": "taosWLockLatch",
          "old_text": null,
          "new_text": "taosWLockLatch(&pe->latch)",
          "old_line_content": "",
          "new_line_content": "    taosWLockLatch(&pe->latch);",
          "content_same": false
        },
        {
          "line": 832,
          "old_api": null,
          "new_api": "atomic_sub_fetch_64",
          "old_text": null,
          "new_text": "atomic_sub_fetch_64(&pHashObj->size, 1)",
          "old_line_content": "    } ",
          "new_line_content": "      atomic_sub_fetch_64(&pHashObj->size, 1);",
          "content_same": false
        },
        {
          "line": 833,
          "old_api": null,
          "new_api": "FREE_HASH_NODE",
          "old_text": null,
          "new_text": "FREE_HASH_NODE(pHashObj, pOld)",
          "old_line_content": "  } else {",
          "new_line_content": "      FREE_HASH_NODE(pHashObj, pOld);",
          "content_same": false
        },
        {
          "line": 836,
          "old_api": null,
          "new_api": "uError",
          "old_text": null,
          "new_text": "uError(\"pNode:%p data:%p is not there!!!\", pNode, p)",
          "old_line_content": "",
          "new_line_content": "    uError(\"pNode:%p data:%p is not there!!!\", pNode, p);",
          "content_same": false
        },
        {
          "line": 849,
          "old_api": null,
          "new_api": "__rd_lock",
          "old_text": null,
          "new_text": "__rd_lock(&pHashObj->lock, pHashObj->type)",
          "old_line_content": "  SHashNode *pNode = NULL;",
          "new_line_content": "  __rd_lock(&pHashObj->lock, pHashObj->type);",
          "content_same": false
        },
        {
          "line": 853,
          "old_api": null,
          "new_api": "taosHashReleaseNode",
          "old_text": null,
          "new_text": "taosHashReleaseNode(pHashObj, p, &slot)",
          "old_line_content": "      SHashEntry *pe = pHashObj->hashList[slot];",
          "new_line_content": "    pNode = taosHashReleaseNode(pHashObj, p, &slot);",
          "content_same": false
        },
        {
          "line": 857,
          "old_api": null,
          "new_api": "taosWUnLockLatch",
          "old_text": null,
          "new_text": "taosWUnLockLatch(&pe->latch)",
          "old_line_content": "",
          "new_line_content": "        taosWUnLockLatch(&pe->latch);",
          "content_same": false
        },
        {
          "line": 870,
          "old_api": null,
          "new_api": "taosWLockLatch",
          "old_text": null,
          "new_text": "taosWLockLatch(&pe->latch)",
          "old_line_content": "",
          "new_line_content": "        taosWLockLatch(&pe->latch);",
          "content_same": false
        },
        {
          "line": 882,
          "old_api": null,
          "new_api": "taosWUnLockLatch",
          "old_text": null,
          "new_text": "taosWUnLockLatch(&pe->latch)",
          "old_line_content": "    }",
          "new_line_content": "        taosWUnLockLatch(&pe->latch);",
          "content_same": false
        },
        {
          "line": 758,
          "old_api": null,
          "new_api": "GET_HASH_NODE_DATA",
          "old_text": null,
          "new_text": "GET_HASH_NODE_DATA(pNewNode)",
          "old_line_content": "",
          "new_line_content": "  memcpy(GET_HASH_NODE_DATA(pNewNode), pData, dsize);",
          "content_same": false
        },
        {
          "line": 759,
          "old_api": null,
          "new_api": "GET_HASH_NODE_KEY",
          "old_text": null,
          "new_text": "GET_HASH_NODE_KEY(pNewNode)",
          "old_line_content": "  return pNewNode;",
          "new_line_content": "  memcpy(GET_HASH_NODE_KEY(pNewNode), key, keyLen);",
          "content_same": false
        },
        {
          "line": 892,
          "old_api": null,
          "new_api": "taosWUnLockLatch",
          "old_text": null,
          "new_text": "taosWUnLockLatch(&pe->latch)",
          "old_line_content": "  }",
          "new_line_content": "      taosWUnLockLatch(&pe->latch);",
          "content_same": false
        },
        {
          "line": 765,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(pNode != NULL && pEntry != NULL)",
          "old_line_content": "  pNode->next = pEntry->next;",
          "new_line_content": "  assert(pNode != NULL && pEntry != NULL);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 903,
          "old_api": "__rd_lock",
          "new_api": null,
          "old_text": "__rd_lock(&pHashObj->lock, pHashObj->type)",
          "new_text": null,
          "old_line_content": "  __rd_lock(&pHashObj->lock, pHashObj->type);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 776,
          "old_api": "taosHashGetSize",
          "new_api": null,
          "old_text": "taosHashGetSize(pHashObj)",
          "new_text": null,
          "old_line_content": "  return (pHashObj->capacity * (sizeof(SHashEntry) + POINTER_BYTES)) + sizeof(SHashNode) * taosHashGetSize(pHashObj) + sizeof(SHashObj);",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 906,
          "old_api": "taosHashReleaseNode",
          "new_api": null,
          "old_text": "taosHashReleaseNode(pHashObj, p, &slot)",
          "new_text": null,
          "old_line_content": "  taosHashReleaseNode(pHashObj, p, &slot);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 780,
          "old_api": "GET_HASH_PNODE",
          "new_api": null,
          "old_text": "GET_HASH_PNODE(data)",
          "new_text": null,
          "old_line_content": "  SHashNode * node = GET_HASH_PNODE(data);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 781,
          "old_api": "GET_HASH_NODE_KEY",
          "new_api": null,
          "old_text": "GET_HASH_NODE_KEY(node)",
          "new_text": null,
          "old_line_content": "  return GET_HASH_NODE_KEY(node);",
          "new_line_content": "FORCE_INLINE void *taosHashGetDataKey(SHashObj *pHashObj, void *data) {",
          "content_same": false
        },
        {
          "line": 910,
          "old_api": "taosWUnLockLatch",
          "new_api": null,
          "old_text": "taosWUnLockLatch(&pe->latch)",
          "new_text": null,
          "old_line_content": "    taosWUnLockLatch(&pe->latch);",
          "new_line_content": "  SHashEntry *pe = pHashObj->hashList[slot];",
          "content_same": false
        },
        {
          "line": 785,
          "old_api": "GET_HASH_PNODE",
          "new_api": null,
          "old_text": "GET_HASH_PNODE(data)",
          "new_text": null,
          "old_line_content": "  SHashNode * node = GET_HASH_PNODE(data);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 913,
          "old_api": "__rd_unlock",
          "new_api": null,
          "old_text": "__rd_unlock(&pHashObj->lock, pHashObj->type)",
          "new_text": null,
          "old_line_content": "  __rd_unlock(&pHashObj->lock, pHashObj->type);",
          "new_line_content": "  } ",
          "content_same": false
        },
        {
          "line": 793,
          "old_api": "GET_HASH_PNODE",
          "new_api": null,
          "old_text": "GET_HASH_PNODE(p)",
          "new_text": null,
          "old_line_content": "  SHashNode *pOld = (SHashNode *)GET_HASH_PNODE(p);",
          "new_line_content": "static void *taosHashReleaseNode(SHashObj *pHashObj, void *p, int *slot) {",
          "content_same": false
        },
        {
          "line": 796,
          "old_api": "HASH_INDEX",
          "new_api": null,
          "old_text": "HASH_INDEX(pOld->hashVal, pHashObj->capacity)",
          "new_text": null,
          "old_line_content": "  *slot = HASH_INDEX(pOld->hashVal, pHashObj->capacity);",
          "new_line_content": "  SHashNode *prevNode = NULL;",
          "content_same": false
        },
        {
          "line": 801,
          "old_api": "taosWLockLatch",
          "new_api": null,
          "old_text": "taosWLockLatch(&pe->latch)",
          "new_text": null,
          "old_line_content": "    taosWLockLatch(&pe->latch);",
          "new_line_content": "  // lock entry",
          "content_same": false
        },
        {
          "line": 830,
          "old_api": "atomic_sub_fetch_64",
          "new_api": null,
          "old_text": "atomic_sub_fetch_64(&pHashObj->size, 1)",
          "new_text": null,
          "old_line_content": "      atomic_sub_fetch_64(&pHashObj->size, 1);",
          "new_line_content": "   ",
          "content_same": false
        },
        {
          "line": 831,
          "old_api": "FREE_HASH_NODE",
          "new_api": null,
          "old_text": "FREE_HASH_NODE(pHashObj, pOld)",
          "new_text": null,
          "old_line_content": "      FREE_HASH_NODE(pHashObj, pOld);",
          "new_line_content": "      pe->num--;",
          "content_same": false
        },
        {
          "line": 834,
          "old_api": "uError",
          "new_api": null,
          "old_text": "uError(\"pNode:%p data:%p is not there!!!\", pNode, p)",
          "new_text": null,
          "old_line_content": "    uError(\"pNode:%p data:%p is not there!!!\", pNode, p);",
          "new_line_content": "    } ",
          "content_same": false
        },
        {
          "line": 847,
          "old_api": "__rd_lock",
          "new_api": null,
          "old_text": "__rd_lock(&pHashObj->lock, pHashObj->type)",
          "new_text": null,
          "old_line_content": "  __rd_lock(&pHashObj->lock, pHashObj->type);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 851,
          "old_api": "taosHashReleaseNode",
          "new_api": null,
          "old_text": "taosHashReleaseNode(pHashObj, p, &slot)",
          "new_text": null,
          "old_line_content": "    pNode = taosHashReleaseNode(pHashObj, p, &slot);",
          "new_line_content": "  SHashNode *pNode = NULL;",
          "content_same": false
        },
        {
          "line": 855,
          "old_api": "taosWUnLockLatch",
          "new_api": null,
          "old_text": "taosWUnLockLatch(&pe->latch)",
          "new_text": null,
          "old_line_content": "        taosWUnLockLatch(&pe->latch);",
          "new_line_content": "      SHashEntry *pe = pHashObj->hashList[slot];",
          "content_same": false
        },
        {
          "line": 868,
          "old_api": "taosWLockLatch",
          "new_api": null,
          "old_text": "taosWLockLatch(&pe->latch)",
          "new_text": null,
          "old_line_content": "        taosWLockLatch(&pe->latch);",
          "new_line_content": "      // lock entry",
          "content_same": false
        },
        {
          "line": 880,
          "old_api": "taosWUnLockLatch",
          "new_api": null,
          "old_text": "taosWUnLockLatch(&pe->latch)",
          "new_text": null,
          "old_line_content": "        taosWUnLockLatch(&pe->latch);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 756,
          "old_api": "GET_HASH_NODE_DATA",
          "new_api": null,
          "old_text": "GET_HASH_NODE_DATA(pNewNode)",
          "new_text": null,
          "old_line_content": "  memcpy(GET_HASH_NODE_DATA(pNewNode), pData, dsize);",
          "new_line_content": "  pNewNode->next    = NULL;",
          "content_same": false
        },
        {
          "line": 757,
          "old_api": "GET_HASH_NODE_KEY",
          "new_api": null,
          "old_text": "GET_HASH_NODE_KEY(pNewNode)",
          "new_text": null,
          "old_line_content": "  memcpy(GET_HASH_NODE_KEY(pNewNode), key, keyLen);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 888,
          "old_api": "GET_HASH_NODE_DATA",
          "new_api": null,
          "old_text": "GET_HASH_NODE_DATA(pNode)",
          "new_text": null,
          "old_line_content": "    data = GET_HASH_NODE_DATA(pNode);",
          "new_line_content": "    SHashEntry *pe = pHashObj->hashList[slot];",
          "content_same": false
        },
        {
          "line": 763,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(pNode != NULL && pEntry != NULL)",
          "new_text": null,
          "old_line_content": "  assert(pNode != NULL && pEntry != NULL);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 894,
          "old_api": "__rd_unlock",
          "new_api": null,
          "old_text": "__rd_unlock(&pHashObj->lock, pHashObj->type)",
          "new_text": null,
          "old_line_content": "  __rd_unlock(&pHashObj->lock, pHashObj->type);",
          "new_line_content": "  }",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 2,
      "total_additions": 24,
      "total_deletions": 24,
      "total_api_changes": 50
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 5,
        "api_related_lines": 50,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          754,
          755,
          751
        ]
      }
    },
    "api_calls_before": 187,
    "api_calls_after": 187,
    "diff_info": {
      "added_lines": 5,
      "removed_lines": 3,
      "total_diff_lines": 28
    }
  }
}