{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/taichi/modified_file/c3221b5c703875daad5b7b1480860169f3936b7c",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/taichi/modified_file/c3221b5c703875daad5b7b1480860169f3936b7c/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/taichi/modified_file/c3221b5c703875daad5b7b1480860169f3936b7c/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/taichi/modified_file/c3221b5c703875daad5b7b1480860169f3936b7c/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 159,
          "old_api": "size",
          "new_api": "TC_INFO",
          "old_text": "ptr->ch.size()",
          "new_text": "TC_INFO(\"Optimized load to vloadu\")",
          "old_line_content": "          vload->ch.resize(ptr->ch.size());",
          "new_line_content": "          TC_INFO(\"Optimized load to vloadu\");",
          "content_same": false
        },
        {
          "line": 160,
          "old_api": "size",
          "new_api": "Expr::create(NodeType::vload, addr_node)",
          "old_text": "ptr->ch.size()",
          "new_text": "Expr::create(NodeType::vload, addr_node)",
          "old_line_content": "          for (int i = 1; i < (int)ptr->ch.size(); i++) {",
          "new_line_content": "          auto vload = Expr::create(NodeType::vload, addr_node);",
          "content_same": false
        },
        {
          "line": 161,
          "old_api": "Expr::copy_from(ptr->ch[i])",
          "new_api": "size",
          "old_text": "Expr::copy_from(ptr->ch[i])",
          "new_text": "ptr->ch.size()",
          "old_line_content": "            auto c = Expr::copy_from(ptr->ch[i]);",
          "new_line_content": "          vload->ch.resize(ptr->ch.size());",
          "content_same": false
        },
        {
          "line": 162,
          "old_api": "TC_ASSERT",
          "new_api": "size",
          "old_text": "TC_ASSERT(c->lanes == 8)",
          "new_text": "ptr->ch.size()",
          "old_line_content": "            TC_ASSERT(c->lanes == 8);",
          "new_line_content": "          for (int i = 1; i < (int)ptr->ch.size(); i++) {",
          "content_same": false
        },
        {
          "line": 164,
          "old_api": "set_lanes",
          "new_api": "TC_ASSERT",
          "old_text": "c->set_lanes(1)",
          "new_text": "TC_ASSERT(c->lanes == kernel->program.config.simd_width)",
          "old_line_content": "              c->set_lanes(1);",
          "new_line_content": "            TC_ASSERT(c->lanes == kernel->program.config.simd_width);",
          "content_same": false
        },
        {
          "line": 173,
          "old_api": "size",
          "new_api": "TC_INFO",
          "old_text": "ptr->ch.size()",
          "new_text": "TC_INFO(\"Optimized store to vstoreu\")",
          "old_line_content": "          vstore->ch.resize(ptr->ch.size() + 1);",
          "new_line_content": "          TC_INFO(\"Optimized store to vstoreu\");",
          "content_same": false
        },
        {
          "line": 174,
          "old_api": "size",
          "new_api": "Expr::create(NodeType::vstore, addr_node, expr->ch[1])",
          "old_text": "ptr->ch.size()",
          "new_text": "Expr::create(NodeType::vstore, addr_node, expr->ch[1])",
          "old_line_content": "          for (int i = 1; i < (int)ptr->ch.size(); i++) {",
          "new_line_content": "          auto vstore = Expr::create(NodeType::vstore, addr_node, expr->ch[1]);",
          "content_same": false
        },
        {
          "line": 175,
          "old_api": "Expr::copy_from(ptr->ch[i])",
          "new_api": "size",
          "old_text": "Expr::copy_from(ptr->ch[i])",
          "new_text": "ptr->ch.size()",
          "old_line_content": "            auto c = Expr::copy_from(ptr->ch[i]);",
          "new_line_content": "          vstore->ch.resize(ptr->ch.size() + 1);",
          "content_same": false
        },
        {
          "line": 176,
          "old_api": "TC_ASSERT",
          "new_api": "size",
          "old_text": "TC_ASSERT(c->lanes == 8)",
          "new_text": "ptr->ch.size()",
          "old_line_content": "            TC_ASSERT(c->lanes == 8);",
          "new_line_content": "          for (int i = 1; i < (int)ptr->ch.size(); i++) {",
          "content_same": false
        },
        {
          "line": 178,
          "old_api": "set_lanes",
          "new_api": "TC_ASSERT",
          "old_text": "c->set_lanes(1)",
          "new_text": "TC_ASSERT(c->lanes == kernel->program.config.simd_width)",
          "old_line_content": "              c->set_lanes(1);",
          "new_line_content": "            TC_ASSERT(c->lanes == kernel->program.config.simd_width);",
          "content_same": false
        },
        {
          "line": 224,
          "old_api": "size",
          "new_api": "TC_INFO",
          "old_text": "ptr->ch.size()",
          "new_text": "TC_INFO(\"Optimized store to gather\")",
          "old_line_content": "      gather->ch.resize(ptr->ch.size());",
          "new_line_content": "      TC_INFO(\"Optimized store to gather\");  // gather",
          "content_same": false
        },
        {
          "line": 225,
          "old_api": "size",
          "new_api": "Expr::create(NodeType::gather, addr_node)",
          "old_text": "ptr->ch.size()",
          "new_text": "Expr::create(NodeType::gather, addr_node)",
          "old_line_content": "      for (int i = 1; i < (int)ptr->ch.size(); i++) {",
          "new_line_content": "      Expr gather = Expr::create(NodeType::gather, addr_node);",
          "content_same": false
        },
        {
          "line": 226,
          "old_api": "Expr::copy_from(ptr->ch[i])",
          "new_api": "size",
          "old_text": "Expr::copy_from(ptr->ch[i])",
          "new_text": "ptr->ch.size()",
          "old_line_content": "        auto c = Expr::copy_from(ptr->ch[i]);",
          "new_line_content": "      gather->ch.resize(ptr->ch.size());",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 163,
          "old_api": null,
          "new_api": "Expr::copy_from(ptr->ch[i])",
          "old_text": null,
          "new_text": "Expr::copy_from(ptr->ch[i])",
          "old_line_content": "            if (c->type == NodeType::index)",
          "new_line_content": "            auto c = Expr::copy_from(ptr->ch[i]);",
          "content_same": false
        },
        {
          "line": 166,
          "old_api": null,
          "new_api": "set_lanes",
          "old_text": null,
          "new_text": "c->set_lanes(1)",
          "old_line_content": "          }",
          "new_line_content": "              c->set_lanes(1);",
          "content_same": false
        },
        {
          "line": 169,
          "old_api": null,
          "new_api": "set_similar",
          "old_text": null,
          "new_text": "vload->set_similar(expr)",
          "old_line_content": "          return true;",
          "new_line_content": "          vload->set_similar(expr);",
          "content_same": false
        },
        {
          "line": 170,
          "old_api": null,
          "new_api": "set",
          "old_text": null,
          "new_text": "expr.set(vload)",
          "old_line_content": "        } else {",
          "new_line_content": "          expr.set(vload);",
          "content_same": false
        },
        {
          "line": 177,
          "old_api": null,
          "new_api": "Expr::copy_from(ptr->ch[i])",
          "old_text": null,
          "new_text": "Expr::copy_from(ptr->ch[i])",
          "old_line_content": "            if (c->type == NodeType::index)",
          "new_line_content": "            auto c = Expr::copy_from(ptr->ch[i]);",
          "content_same": false
        },
        {
          "line": 180,
          "old_api": null,
          "new_api": "set_lanes",
          "old_text": null,
          "new_text": "c->set_lanes(1)",
          "old_line_content": "          }",
          "new_line_content": "              c->set_lanes(1);",
          "content_same": false
        },
        {
          "line": 183,
          "old_api": null,
          "new_api": "set_similar",
          "old_text": null,
          "new_text": "vstore->set_similar(expr)",
          "old_line_content": "          return true;",
          "new_line_content": "          vstore->set_similar(expr);",
          "content_same": false
        },
        {
          "line": 184,
          "old_api": null,
          "new_api": "set",
          "old_text": null,
          "new_text": "expr.set(vstore)",
          "old_line_content": "        }",
          "new_line_content": "          expr.set(vstore);",
          "content_same": false
        },
        {
          "line": 198,
          "old_api": null,
          "new_api": "_pointer",
          "old_text": null,
          "new_text": "expr._pointer()",
          "old_line_content": "",
          "new_line_content": "    auto &ptr = expr._pointer();",
          "content_same": false
        },
        {
          "line": 199,
          "old_api": null,
          "new_api": "_pointer",
          "old_text": null,
          "new_text": "expr._pointer()._address()",
          "old_line_content": "    for (int i = 0; i < addr_node->lanes; i++) {",
          "new_line_content": "    auto &addr_node = expr._pointer()._address();",
          "content_same": false
        },
        {
          "line": 202,
          "old_api": null,
          "new_api": "snode_ptr",
          "old_text": null,
          "new_text": "addr_node->snode_ptr(0)",
          "old_line_content": "    }",
          "new_line_content": "      if (addr_node->snode_ptr(i) != addr_node->snode_ptr(0))",
          "content_same": false
        },
        {
          "line": 207,
          "old_api": null,
          "new_api": "_pointer",
          "old_text": null,
          "new_text": "expr._pointer()->ch.back()",
          "old_line_content": "    if (index_node->type != NodeType::index) {",
          "new_line_content": "    auto &index_node = expr._pointer()->ch.back();",
          "content_same": false
        },
        {
          "line": 220,
          "old_api": null,
          "new_api": "snode_ptr",
          "old_text": null,
          "new_text": "addr_node->snode_ptr(0)",
          "old_line_content": "",
          "new_line_content": "    auto snode = addr_node->snode_ptr(0);",
          "content_same": false
        },
        {
          "line": 227,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "ptr->ch.size()",
          "old_line_content": "        gather->ch[i] = c;",
          "new_line_content": "      for (int i = 1; i < (int)ptr->ch.size(); i++) {",
          "content_same": false
        },
        {
          "line": 228,
          "old_api": null,
          "new_api": "Expr::copy_from(ptr->ch[i])",
          "old_text": null,
          "new_text": "Expr::copy_from(ptr->ch[i])",
          "old_line_content": "      }",
          "new_line_content": "        auto c = Expr::copy_from(ptr->ch[i]);",
          "content_same": false
        },
        {
          "line": 231,
          "old_api": null,
          "new_api": "set_similar",
          "old_text": null,
          "new_text": "gather->set_similar(expr)",
          "old_line_content": "      return true;",
          "new_line_content": "      gather->set_similar(expr);",
          "content_same": false
        },
        {
          "line": 232,
          "old_api": null,
          "new_api": "set",
          "old_text": null,
          "new_text": "expr.set(gather)",
          "old_line_content": "    }",
          "new_line_content": "      expr.set(gather);",
          "content_same": false
        },
        {
          "line": 239,
          "old_api": null,
          "new_api": "run",
          "old_text": null,
          "new_text": "ContinuousMemOptimizer().run(ker, expr)",
          "old_line_content": "}",
          "new_line_content": "  ContinuousMemOptimizer().run(ker, expr);",
          "content_same": false
        },
        {
          "line": 240,
          "old_api": null,
          "new_api": "run",
          "old_text": null,
          "new_text": "GatherMemOptimizer().run(ker, expr)",
          "old_line_content": "",
          "new_line_content": "  GatherMemOptimizer().run(ker, expr);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 157,
          "old_api": "TC_INFO",
          "new_api": null,
          "old_text": "TC_INFO(\"Optimized load to vloadu\")",
          "new_text": null,
          "old_line_content": "          TC_INFO(\"Optimized load to vloadu\");",
          "new_line_content": "        // replace load with vload",
          "content_same": false
        },
        {
          "line": 158,
          "old_api": "Expr::create(NodeType::vload, addr_node)",
          "new_api": null,
          "old_text": "Expr::create(NodeType::vload, addr_node)",
          "new_text": null,
          "old_line_content": "          auto vload = Expr::create(NodeType::vload, addr_node);",
          "new_line_content": "        if (expr->type == NodeType::load) {",
          "content_same": false
        },
        {
          "line": 167,
          "old_api": "set_similar",
          "new_api": null,
          "old_text": "vload->set_similar(expr)",
          "new_text": null,
          "old_line_content": "          vload->set_similar(expr);",
          "new_line_content": "            vload->ch[i] = c;",
          "content_same": false
        },
        {
          "line": 168,
          "old_api": "set",
          "new_api": null,
          "old_text": "expr.set(vload)",
          "new_text": null,
          "old_line_content": "          expr.set(vload);",
          "new_line_content": "          }",
          "content_same": false
        },
        {
          "line": 171,
          "old_api": "TC_INFO",
          "new_api": null,
          "old_text": "TC_INFO(\"Optimized store to vstoreu\")",
          "new_text": null,
          "old_line_content": "          TC_INFO(\"Optimized store to vstoreu\");",
          "new_line_content": "          return true;",
          "content_same": false
        },
        {
          "line": 172,
          "old_api": "Expr::create(NodeType::vstore, addr_node, expr->ch[1])",
          "new_api": null,
          "old_text": "Expr::create(NodeType::vstore, addr_node, expr->ch[1])",
          "new_text": null,
          "old_line_content": "          auto vstore = Expr::create(NodeType::vstore, addr_node, expr->ch[1]);",
          "new_line_content": "        } else {",
          "content_same": false
        },
        {
          "line": 181,
          "old_api": "set_similar",
          "new_api": null,
          "old_text": "vstore->set_similar(expr)",
          "new_text": null,
          "old_line_content": "          vstore->set_similar(expr);",
          "new_line_content": "            vstore->ch[i + 1] = c;",
          "content_same": false
        },
        {
          "line": 182,
          "old_api": "set",
          "new_api": null,
          "old_text": "expr.set(vstore)",
          "new_text": null,
          "old_line_content": "          expr.set(vstore);",
          "new_line_content": "          }",
          "content_same": false
        },
        {
          "line": 196,
          "old_api": "_pointer",
          "new_api": null,
          "old_text": "expr._pointer()",
          "new_text": null,
          "old_line_content": "    auto &ptr = expr._pointer();",
          "new_line_content": "    if (expr->type != NodeType::load)",
          "content_same": false
        },
        {
          "line": 197,
          "old_api": "_pointer",
          "new_api": null,
          "old_text": "expr._pointer()._address()",
          "new_text": null,
          "old_line_content": "    auto &addr_node = expr._pointer()._address();",
          "new_line_content": "      return false;",
          "content_same": false
        },
        {
          "line": 200,
          "old_api": "snode_ptr",
          "new_api": null,
          "old_text": "addr_node->snode_ptr(0)",
          "new_text": null,
          "old_line_content": "      if (addr_node->snode_ptr(i) != addr_node->snode_ptr(0))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 205,
          "old_api": "_pointer",
          "new_api": null,
          "old_text": "expr._pointer()->ch.back()",
          "new_text": null,
          "old_line_content": "    auto &index_node = expr._pointer()->ch.back();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 218,
          "old_api": "snode_ptr",
          "new_api": null,
          "old_text": "addr_node->snode_ptr(0)",
          "new_text": null,
          "old_line_content": "    auto snode = addr_node->snode_ptr(0);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 222,
          "old_api": "TC_INFO",
          "new_api": null,
          "old_text": "TC_INFO(\"Optimized store to gather\")",
          "new_text": null,
          "old_line_content": "      TC_INFO(\"Optimized store to gather\");  // gather",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 223,
          "old_api": "Expr::create(NodeType::gather, addr_node)",
          "new_api": null,
          "old_text": "Expr::create(NodeType::gather, addr_node)",
          "new_text": null,
          "old_line_content": "      Expr gather = Expr::create(NodeType::gather, addr_node);",
          "new_line_content": "    if (snode->parent->type == SNodeType::fixed) {",
          "content_same": false
        },
        {
          "line": 229,
          "old_api": "set_similar",
          "new_api": null,
          "old_text": "gather->set_similar(expr)",
          "new_text": null,
          "old_line_content": "      gather->set_similar(expr);",
          "new_line_content": "        gather->ch[i] = c;",
          "content_same": false
        },
        {
          "line": 230,
          "old_api": "set",
          "new_api": null,
          "old_text": "expr.set(gather)",
          "new_text": null,
          "old_line_content": "      expr.set(gather);",
          "new_line_content": "      }",
          "content_same": false
        },
        {
          "line": 237,
          "old_api": "run",
          "new_api": null,
          "old_text": "ContinuousMemOptimizer().run(ker, expr)",
          "new_text": null,
          "old_line_content": "  ContinuousMemOptimizer().run(ker, expr);",
          "new_line_content": "};",
          "content_same": false
        },
        {
          "line": 238,
          "old_api": "run",
          "new_api": null,
          "old_text": "GatherMemOptimizer().run(ker, expr)",
          "new_text": null,
          "old_line_content": "  GatherMemOptimizer().run(ker, expr);",
          "new_line_content": "void apply_optimizers(Kernel &ker, Expr &expr) {",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 13,
      "total_additions": 19,
      "total_deletions": 19,
      "total_api_changes": 51
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 9,
        "api_related_lines": 51,
        "non_api_lines": 5,
        "non_api_line_numbers": [
          147,
          148,
          149,
          150,
          151
        ]
      }
    },
    "api_calls_before": 76,
    "api_calls_after": 76,
    "diff_info": {
      "added_lines": 7,
      "removed_lines": 5,
      "total_diff_lines": 38
    }
  }
}