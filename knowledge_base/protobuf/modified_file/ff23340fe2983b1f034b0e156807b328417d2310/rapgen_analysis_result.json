{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/protobuf/modified_file/ff23340fe2983b1f034b0e156807b328417d2310",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/protobuf/modified_file/ff23340fe2983b1f034b0e156807b328417d2310/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/protobuf/modified_file/ff23340fe2983b1f034b0e156807b328417d2310/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/protobuf/modified_file/ff23340fe2983b1f034b0e156807b328417d2310/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 76,
          "old_api": "upb_string_getref",
          "new_api": "upb_string_len",
          "old_text": "upb_string_getref(target_str)",
          "new_text": "upb_string_len(target_str)",
          "old_line_content": "  str->src = upb_string_getref(target_str);",
          "new_line_content": "  assert(start + len <= upb_string_len(target_str));",
          "content_same": false
        },
        {
          "line": 89,
          "old_api": "va_end",
          "new_api": "upb_string_size",
          "old_text": "va_end(args_copy)",
          "new_text": "upb_string_size(str)",
          "old_line_content": "  va_end(args_copy);",
          "new_line_content": "  uint32_t size = UPB_MAX(upb_string_size(str), 16);",
          "content_same": false
        },
        {
          "line": 114,
          "old_api": "upb_string_new",
          "new_api": "va_end",
          "old_text": "upb_string_new()",
          "new_text": "va_end(args)",
          "old_line_content": "  upb_string *str = upb_string_new();",
          "new_line_content": "  va_end(args);",
          "content_same": false
        },
        {
          "line": 120,
          "old_api": "upb_string_len",
          "new_api": "upb_strcpy",
          "old_text": "upb_string_len(s)",
          "new_text": "upb_strcpy(str, s)",
          "old_line_content": "  uint32_t old_size = upb_string_len(s);",
          "new_line_content": "  upb_strcpy(str, s);",
          "content_same": false
        },
        {
          "line": 128,
          "old_api": "fopen",
          "new_api": "upb_string_getrwbuf",
          "old_text": "fopen(filename, \"rb\")",
          "new_text": "upb_string_getrwbuf(s, new_size)",
          "old_line_content": "  FILE *f = fopen(filename, \"rb\");",
          "new_line_content": "  char *buf = upb_string_getrwbuf(s, new_size);",
          "content_same": false
        },
        {
          "line": 133,
          "old_api": "fseek",
          "new_api": "fopen",
          "old_text": "fseek(f, 0, SEEK_SET)",
          "new_text": "fopen(filename, \"rb\")",
          "old_line_content": "  if(fseek(f, 0, SEEK_SET) != 0) goto error;",
          "new_line_content": "  FILE *f = fopen(filename, \"rb\");",
          "content_same": false
        },
        {
          "line": 135,
          "old_api": "upb_string_getrwbuf",
          "new_api": "fseek",
          "old_text": "upb_string_getrwbuf(s, size)",
          "new_text": "fseek(f, 0, SEEK_END)",
          "old_line_content": "  char *buf = upb_string_getrwbuf(s, size);",
          "new_line_content": "  if(fseek(f, 0, SEEK_END) != 0) goto error;",
          "content_same": false
        },
        {
          "line": 136,
          "old_api": "fread",
          "new_api": "ftell",
          "old_text": "fread(buf, size, 1, f)",
          "new_text": "ftell(f)",
          "old_line_content": "  if(fread(buf, size, 1, f) != 1) goto error;",
          "new_line_content": "  long size = ftell(f);",
          "content_same": false
        },
        {
          "line": 141,
          "old_api": "fclose",
          "new_api": "fread",
          "old_text": "fclose(f)",
          "new_text": "fread(buf, size, 1, f)",
          "old_line_content": "  fclose(f);",
          "new_line_content": "  if(fread(buf, size, 1, f) != 1) goto error;",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 129,
          "old_api": null,
          "new_api": "upb_string_getrobuf",
          "old_text": null,
          "new_text": "upb_string_getrobuf(append)",
          "old_line_content": "  if(!f) return NULL;",
          "new_line_content": "  memcpy(buf + old_size, upb_string_getrobuf(append), append_size);",
          "content_same": false
        },
        {
          "line": 138,
          "old_api": null,
          "new_api": "fseek",
          "old_text": null,
          "new_text": "fseek(f, 0, SEEK_SET)",
          "old_line_content": "  return s;",
          "new_line_content": "  if(fseek(f, 0, SEEK_SET) != 0) goto error;",
          "content_same": false
        },
        {
          "line": 139,
          "old_api": null,
          "new_api": "upb_string_new",
          "old_text": null,
          "new_text": "upb_string_new()",
          "old_line_content": "",
          "new_line_content": "  upb_string *s = upb_string_new();",
          "content_same": false
        },
        {
          "line": 140,
          "old_api": null,
          "new_api": "upb_string_getrwbuf",
          "old_text": null,
          "new_text": "upb_string_getrwbuf(s, size)",
          "old_line_content": "error:",
          "new_line_content": "  char *buf = upb_string_getrwbuf(s, size);",
          "content_same": false
        },
        {
          "line": 142,
          "old_api": null,
          "new_api": "fclose",
          "old_text": null,
          "new_text": "fclose(f)",
          "old_line_content": "  return NULL;",
          "new_line_content": "  fclose(f);",
          "content_same": false
        },
        {
          "line": 146,
          "old_api": null,
          "new_api": "fclose",
          "old_text": null,
          "new_text": "fclose(f)",
          "old_line_content": "",
          "new_line_content": "  fclose(f);",
          "content_same": false
        },
        {
          "line": 150,
          "old_api": null,
          "new_api": "upb_string_recycle",
          "old_text": null,
          "new_text": "upb_string_recycle(_str)",
          "old_line_content": "",
          "new_line_content": "void upb_string_noninlinerecycle(upb_string **_str) { return upb_string_recycle(_str); }",
          "content_same": false
        },
        {
          "line": 81,
          "old_api": null,
          "new_api": "upb_string_getref",
          "old_text": null,
          "new_text": "upb_string_getref(target_str)",
          "old_line_content": "void upb_string_vprintf(upb_string *str, const char *format, va_list args) {",
          "new_line_content": "  str->src = upb_string_getref(target_str);",
          "content_same": false
        },
        {
          "line": 82,
          "old_api": null,
          "new_api": "upb_string_getrobuf",
          "old_text": null,
          "new_text": "upb_string_getrobuf(target_str)",
          "old_line_content": "  // Try once without reallocating.  We have to va_copy because we might have",
          "new_line_content": "  str->ptr = upb_string_getrobuf(target_str) + start;",
          "content_same": false
        },
        {
          "line": 90,
          "old_api": null,
          "new_api": "upb_string_getrwbuf",
          "old_text": null,
          "new_text": "upb_string_getrwbuf(str, size)",
          "old_line_content": "",
          "new_line_content": "  char *buf = upb_string_getrwbuf(str, size);",
          "content_same": false
        },
        {
          "line": 92,
          "old_api": null,
          "new_api": "va_copy",
          "old_text": null,
          "new_text": "va_copy(args_copy, args)",
          "old_line_content": "    // Need to reallocate.  We reallocate even if the sizes were equal,",
          "new_line_content": "  va_copy(args_copy, args);",
          "content_same": false
        },
        {
          "line": 93,
          "old_api": null,
          "new_api": "vsnprintf",
          "old_text": null,
          "new_text": "vsnprintf(buf, size, format, args_copy)",
          "old_line_content": "    // because snprintf excludes the terminating NULL from its count.",
          "new_line_content": "  uint32_t true_size = vsnprintf(buf, size, format, args_copy);",
          "content_same": false
        },
        {
          "line": 94,
          "old_api": null,
          "new_api": "va_end",
          "old_text": null,
          "new_text": "va_end(args_copy)",
          "old_line_content": "    // We don't care about the terminating NULL, but snprintf might",
          "new_line_content": "  va_end(args_copy);",
          "content_same": false
        },
        {
          "line": 102,
          "old_api": null,
          "new_api": "upb_string_recycle",
          "old_text": null,
          "new_text": "upb_string_recycle(&str)",
          "old_line_content": "}",
          "new_line_content": "    upb_string_recycle(&str);",
          "content_same": false
        },
        {
          "line": 103,
          "old_api": null,
          "new_api": "upb_string_getrwbuf",
          "old_text": null,
          "new_text": "upb_string_getrwbuf(str, true_size + 1)",
          "old_line_content": "",
          "new_line_content": "    buf = upb_string_getrwbuf(str, true_size + 1);",
          "content_same": false
        },
        {
          "line": 104,
          "old_api": null,
          "new_api": "vsnprintf",
          "old_text": null,
          "new_text": "vsnprintf(buf, true_size + 1, format, args)",
          "old_line_content": "upb_string *upb_string_asprintf(const char *format, ...) {",
          "new_line_content": "    vsnprintf(buf, true_size + 1, format, args);",
          "content_same": false
        },
        {
          "line": 110,
          "old_api": null,
          "new_api": "upb_string_new",
          "old_text": null,
          "new_text": "upb_string_new()",
          "old_line_content": "  return str;",
          "new_line_content": "  upb_string *str = upb_string_new();",
          "content_same": false
        },
        {
          "line": 112,
          "old_api": null,
          "new_api": "va_start",
          "old_text": null,
          "new_text": "va_start(args, format)",
          "old_line_content": "",
          "new_line_content": "  va_start(args, format);",
          "content_same": false
        },
        {
          "line": 113,
          "old_api": null,
          "new_api": "upb_string_vprintf",
          "old_text": null,
          "new_text": "upb_string_vprintf(str, format, args)",
          "old_line_content": "upb_string *upb_strdup(upb_string *s) {",
          "new_line_content": "  upb_string_vprintf(str, format, args);",
          "content_same": false
        },
        {
          "line": 119,
          "old_api": null,
          "new_api": "upb_string_new",
          "old_text": null,
          "new_text": "upb_string_new()",
          "old_line_content": "void upb_strcat(upb_string *s, upb_string *append) {",
          "new_line_content": "  upb_string *str = upb_string_new();",
          "content_same": false
        },
        {
          "line": 125,
          "old_api": null,
          "new_api": "upb_string_len",
          "old_text": null,
          "new_text": "upb_string_len(s)",
          "old_line_content": "}",
          "new_line_content": "  uint32_t old_size = upb_string_len(s);",
          "content_same": false
        },
        {
          "line": 126,
          "old_api": null,
          "new_api": "upb_string_len",
          "old_text": null,
          "new_text": "upb_string_len(append)",
          "old_line_content": "",
          "new_line_content": "  uint32_t append_size = upb_string_len(append);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 130,
          "old_api": "fseek",
          "new_api": null,
          "old_text": "fseek(f, 0, SEEK_END)",
          "new_text": null,
          "old_line_content": "  if(fseek(f, 0, SEEK_END) != 0) goto error;",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 131,
          "old_api": "ftell",
          "new_api": null,
          "old_text": "ftell(f)",
          "new_text": null,
          "old_line_content": "  long size = ftell(f);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 134,
          "old_api": "upb_string_new",
          "new_api": null,
          "old_text": "upb_string_new()",
          "new_text": null,
          "old_line_content": "  upb_string *s = upb_string_new();",
          "new_line_content": "  if(!f) return NULL;",
          "content_same": false
        },
        {
          "line": 137,
          "old_api": "fclose",
          "new_api": null,
          "old_text": "fclose(f)",
          "new_text": null,
          "old_line_content": "  fclose(f);",
          "new_line_content": "  if(size < 0) goto error;",
          "content_same": false
        },
        {
          "line": 145,
          "old_api": "upb_string_recycle",
          "new_api": null,
          "old_text": "upb_string_recycle(_str)",
          "new_text": null,
          "old_line_content": "void upb_string_noninlinerecycle(upb_string **_str) { return upb_string_recycle(_str); }",
          "new_line_content": "error:",
          "content_same": false
        },
        {
          "line": 77,
          "old_api": "upb_string_getrobuf",
          "new_api": null,
          "old_text": "upb_string_getrobuf(target_str)",
          "new_text": null,
          "old_line_content": "  str->ptr = upb_string_getrobuf(target_str) + start;",
          "new_line_content": "  if (target_str->src) {",
          "content_same": false
        },
        {
          "line": 84,
          "old_api": "upb_string_size",
          "new_api": null,
          "old_text": "upb_string_size(str)",
          "new_text": null,
          "old_line_content": "  uint32_t size = UPB_MAX(upb_string_size(str), 16);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 85,
          "old_api": "upb_string_getrwbuf",
          "new_api": null,
          "old_text": "upb_string_getrwbuf(str, size)",
          "new_text": null,
          "old_line_content": "  char *buf = upb_string_getrwbuf(str, size);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 87,
          "old_api": "va_copy",
          "new_api": null,
          "old_text": "va_copy(args_copy, args)",
          "new_text": null,
          "old_line_content": "  va_copy(args_copy, args);",
          "new_line_content": "  // Try once without reallocating.  We have to va_copy because we might have",
          "content_same": false
        },
        {
          "line": 88,
          "old_api": "vsnprintf",
          "new_api": null,
          "old_text": "vsnprintf(buf, size, format, args_copy)",
          "new_text": null,
          "old_line_content": "  uint32_t true_size = vsnprintf(buf, size, format, args_copy);",
          "new_line_content": "  // to call vsnprintf again.",
          "content_same": false
        },
        {
          "line": 97,
          "old_api": "upb_string_recycle",
          "new_api": null,
          "old_text": "upb_string_recycle(&str)",
          "new_text": null,
          "old_line_content": "    upb_string_recycle(&str);",
          "new_line_content": "    // Need to reallocate.  We reallocate even if the sizes were equal,",
          "content_same": false
        },
        {
          "line": 98,
          "old_api": "upb_string_getrwbuf",
          "new_api": null,
          "old_text": "upb_string_getrwbuf(str, true_size + 1)",
          "new_text": null,
          "old_line_content": "    buf = upb_string_getrwbuf(str, true_size + 1);",
          "new_line_content": "    // because snprintf excludes the terminating NULL from its count.",
          "content_same": false
        },
        {
          "line": 99,
          "old_api": "vsnprintf",
          "new_api": null,
          "old_text": "vsnprintf(buf, true_size + 1, format, args)",
          "new_text": null,
          "old_line_content": "    vsnprintf(buf, true_size + 1, format, args);",
          "new_line_content": "    // We don't care about the terminating NULL, but snprintf might",
          "content_same": false
        },
        {
          "line": 105,
          "old_api": "upb_string_new",
          "new_api": null,
          "old_text": "upb_string_new()",
          "new_text": null,
          "old_line_content": "  upb_string *str = upb_string_new();",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 107,
          "old_api": "va_start",
          "new_api": null,
          "old_text": "va_start(args, format)",
          "new_text": null,
          "old_line_content": "  va_start(args, format);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 108,
          "old_api": "upb_string_vprintf",
          "new_api": null,
          "old_text": "upb_string_vprintf(str, format, args)",
          "new_text": null,
          "old_line_content": "  upb_string_vprintf(str, format, args);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 109,
          "old_api": "va_end",
          "new_api": null,
          "old_text": "va_end(args)",
          "new_text": null,
          "old_line_content": "  va_end(args);",
          "new_line_content": "upb_string *upb_string_asprintf(const char *format, ...) {",
          "content_same": false
        },
        {
          "line": 115,
          "old_api": "upb_strcpy",
          "new_api": null,
          "old_text": "upb_strcpy(str, s)",
          "new_text": null,
          "old_line_content": "  upb_strcpy(str, s);",
          "new_line_content": "  return str;",
          "content_same": false
        },
        {
          "line": 121,
          "old_api": "upb_string_len",
          "new_api": null,
          "old_text": "upb_string_len(append)",
          "new_text": null,
          "old_line_content": "  uint32_t append_size = upb_string_len(append);",
          "new_line_content": "  return str;",
          "content_same": false
        },
        {
          "line": 123,
          "old_api": "upb_string_getrwbuf",
          "new_api": null,
          "old_text": "upb_string_getrwbuf(s, new_size)",
          "new_text": null,
          "old_line_content": "  char *buf = upb_string_getrwbuf(s, new_size);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 124,
          "old_api": "upb_string_getrobuf",
          "new_api": null,
          "old_text": "upb_string_getrobuf(append)",
          "new_text": null,
          "old_line_content": "  memcpy(buf + old_size, upb_string_getrobuf(append), append_size);",
          "new_line_content": "void upb_strcat(upb_string *s, upb_string *append) {",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 9,
      "total_additions": 22,
      "total_deletions": 21,
      "total_api_changes": 52
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 5,
        "api_related_lines": 52,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          80,
          78,
          79
        ]
      }
    },
    "api_calls_before": 43,
    "api_calls_after": 45,
    "diff_info": {
      "added_lines": 5,
      "removed_lines": 0,
      "total_diff_lines": 17
    }
  }
}