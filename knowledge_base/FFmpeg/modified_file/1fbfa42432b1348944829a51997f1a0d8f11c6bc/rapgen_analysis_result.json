{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/1fbfa42432b1348944829a51997f1a0d8f11c6bc",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/1fbfa42432b1348944829a51997f1a0d8f11c6bc/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/1fbfa42432b1348944829a51997f1a0d8f11c6bc/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/1fbfa42432b1348944829a51997f1a0d8f11c6bc/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 490,
          "old_api": "dv_extract_timecode",
          "new_api": "av_log",
          "old_text": "dv_extract_timecode(&c->dv_demux, partial_frame, timecode)",
          "new_text": "av_log(s, AV_LOG_ERROR, \"Detected timecode is invalid\\n\")",
          "old_line_content": "    ret = dv_extract_timecode(&c->dv_demux, partial_frame, timecode);",
          "new_line_content": "        av_log(s, AV_LOG_ERROR, \"Detected timecode is invalid\\n\");",
          "content_same": false
        },
        {
          "line": 508,
          "old_api": "dv_init_demux",
          "new_api": "avio_feof",
          "old_text": "dv_init_demux(s, &c->dv_demux)",
          "new_text": "avio_feof(s->pb)",
          "old_line_content": "    if ((ret = dv_init_demux(s, &c->dv_demux)) < 0)",
          "new_line_content": "        if (avio_feof(s->pb)) {",
          "content_same": false
        },
        {
          "line": 513,
          "old_api": "avio_feof",
          "new_api": "avio_tell",
          "old_text": "avio_feof(s->pb)",
          "new_text": "avio_tell(s->pb)",
          "old_line_content": "        if (avio_feof(s->pb)) {",
          "new_line_content": "            marker_pos = avio_tell(s->pb);",
          "content_same": false
        },
        {
          "line": 514,
          "old_api": "av_log",
          "new_api": "avio_tell",
          "old_text": "av_log(s, AV_LOG_ERROR, \"Cannot find DV header.\\n\")",
          "new_text": "avio_tell(s->pb)",
          "old_line_content": "            av_log(s, AV_LOG_ERROR, \"Cannot find DV header.\\n\");",
          "new_line_content": "        if (state == 0xff3f0701 && avio_tell(s->pb) - marker_pos == 80) {",
          "content_same": false
        },
        {
          "line": 519,
          "old_api": "avio_tell",
          "new_api": "avio_r8",
          "old_text": "avio_tell(s->pb)",
          "new_text": "avio_r8(s->pb)",
          "old_line_content": "        if (state == 0xff3f0701 && avio_tell(s->pb) - marker_pos == 80) {",
          "new_line_content": "        state = (state << 8) | avio_r8(s->pb);",
          "content_same": false
        },
        {
          "line": 521,
          "old_api": "avio_rb32",
          "new_api": "AV_WB32",
          "old_text": "avio_rb32(s->pb)",
          "new_text": "AV_WB32(c->buf, state)",
          "old_line_content": "            state = avio_rb32(s->pb);",
          "new_line_content": "    AV_WB32(c->buf, state);",
          "content_same": false
        },
        {
          "line": 524,
          "old_api": "avio_r8",
          "new_api": "avio_seek",
          "old_text": "avio_r8(s->pb)",
          "new_text": "avio_seek(s->pb, -DV_PROFILE_BYTES, SEEK_CUR)",
          "old_line_content": "        state = (state << 8) | avio_r8(s->pb);",
          "new_line_content": "        avio_seek(s->pb, -DV_PROFILE_BYTES, SEEK_CUR) < 0) {",
          "content_same": false
        },
        {
          "line": 528,
          "old_api": "avio_read",
          "new_api": "av_dv_frame_profile",
          "old_text": "avio_read(s->pb, c->buf + 4, DV_PROFILE_BYTES - 4)",
          "new_text": "av_dv_frame_profile(c->dv_demux.sys,\n                                           c->buf,\n                                           DV_PROFILE_BYTES)",
          "old_line_content": "    if (avio_read(s->pb, c->buf + 4, DV_PROFILE_BYTES - 4) != DV_PROFILE_BYTES - 4 ||",
          "new_line_content": "    c->dv_demux.sys = av_dv_frame_profile(c->dv_demux.sys,",
          "content_same": false
        },
        {
          "line": 537,
          "old_api": "av_log",
          "new_api": "av_rescale_q",
          "old_text": "av_log(s, AV_LOG_ERROR,\n               \"Can't determine profile of DV input stream.\\n\")",
          "new_text": "av_rescale_q(c->dv_demux.sys->frame_size,\n                               (AVRational) { 8, 1 },\n                               c->dv_demux.sys->time_base)",
          "old_line_content": "        av_log(s, AV_LOG_ERROR,",
          "new_line_content": "    s->bit_rate = av_rescale_q(c->dv_demux.sys->frame_size,",
          "content_same": false
        },
        {
          "line": 542,
          "old_api": "av_rescale_q",
          "new_api": "dv_read_timecode",
          "old_text": "av_rescale_q(c->dv_demux.sys->frame_size,\n                               (AVRational) { 8, 1 },\n                               c->dv_demux.sys->time_base)",
          "new_text": "dv_read_timecode(s)",
          "old_line_content": "    s->bit_rate = av_rescale_q(c->dv_demux.sys->frame_size,",
          "new_line_content": "        dv_read_timecode(s);",
          "content_same": false
        },
        {
          "line": 583,
          "old_api": "dv_frame_offset",
          "new_api": "ff_dv_offset_reset",
          "old_text": "dv_frame_offset(s, c, timestamp, flags)",
          "new_text": "ff_dv_offset_reset(c, offset / c->sys->frame_size)",
          "old_line_content": "    int64_t offset    = dv_frame_offset(s, c, timestamp, flags);",
          "new_line_content": "    ff_dv_offset_reset(c, offset / c->sys->frame_size);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 515,
          "old_api": null,
          "new_api": "avio_seek",
          "old_text": null,
          "new_text": "avio_seek(s->pb, -163, SEEK_CUR)",
          "old_line_content": "            return AVERROR_INVALIDDATA;",
          "new_line_content": "            avio_seek(s->pb, -163, SEEK_CUR);",
          "content_same": false
        },
        {
          "line": 516,
          "old_api": null,
          "new_api": "avio_rb32",
          "old_text": null,
          "new_text": "avio_rb32(s->pb)",
          "old_line_content": "        }",
          "new_line_content": "            state = avio_rb32(s->pb);",
          "content_same": false
        },
        {
          "line": 523,
          "old_api": null,
          "new_api": "avio_read",
          "old_text": null,
          "new_text": "avio_read(s->pb, c->buf + 4, DV_PROFILE_BYTES - 4)",
          "old_line_content": "        }",
          "new_line_content": "    if (avio_read(s->pb, c->buf + 4, DV_PROFILE_BYTES - 4) != DV_PROFILE_BYTES - 4 ||",
          "content_same": false
        },
        {
          "line": 525,
          "old_api": null,
          "new_api": "AVERROR",
          "old_text": null,
          "new_text": "AVERROR(EIO)",
          "old_line_content": "    }",
          "new_line_content": "        return AVERROR(EIO);",
          "content_same": false
        },
        {
          "line": 532,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(s, AV_LOG_ERROR,\n               \"Can't determine profile of DV input stream.\\n\")",
          "old_line_content": "",
          "new_line_content": "        av_log(s, AV_LOG_ERROR,",
          "content_same": false
        },
        {
          "line": 552,
          "old_api": null,
          "new_api": "avpriv_dv_get_packet",
          "old_text": null,
          "new_text": "avpriv_dv_get_packet(&c->dv_demux, pkt)",
          "old_line_content": "static int dv_read_packet(AVFormatContext *s, AVPacket *pkt)",
          "new_line_content": "    size = avpriv_dv_get_packet(&c->dv_demux, pkt);",
          "content_same": false
        },
        {
          "line": 556,
          "old_api": null,
          "new_api": "avio_tell",
          "old_text": null,
          "new_text": "avio_tell(s->pb)",
          "old_line_content": "",
          "new_line_content": "        int64_t pos = avio_tell(s->pb);",
          "content_same": false
        },
        {
          "line": 558,
          "old_api": null,
          "new_api": "AVERROR",
          "old_text": null,
          "new_text": "AVERROR(EIO)",
          "old_line_content": "",
          "new_line_content": "            return AVERROR(EIO);",
          "content_same": false
        },
        {
          "line": 560,
          "old_api": null,
          "new_api": "avio_read",
          "old_text": null,
          "new_text": "avio_read(s->pb, c->buf, size)",
          "old_line_content": "        int ret;",
          "new_line_content": "        ret = avio_read(s->pb, c->buf, size);",
          "content_same": false
        },
        {
          "line": 564,
          "old_api": null,
          "new_api": "AVERROR",
          "old_text": null,
          "new_text": "AVERROR(EIO)",
          "old_line_content": "        size = c->dv_demux.sys->frame_size;",
          "new_line_content": "            return AVERROR(EIO);",
          "content_same": false
        },
        {
          "line": 567,
          "old_api": null,
          "new_api": "avpriv_dv_produce_packet",
          "old_text": null,
          "new_text": "avpriv_dv_produce_packet(&c->dv_demux, pkt, c->buf, size, pos)",
          "old_line_content": "            return ret;",
          "new_line_content": "        size = avpriv_dv_produce_packet(&c->dv_demux, pkt, c->buf, size, pos);",
          "content_same": false
        },
        {
          "line": 578,
          "old_api": null,
          "new_api": "dv_frame_offset",
          "old_text": null,
          "new_text": "dv_frame_offset(s, c, timestamp, flags)",
          "old_line_content": "static int dv_read_seek(AVFormatContext *s, int stream_index,",
          "new_line_content": "    int64_t offset    = dv_frame_offset(s, c, timestamp, flags);",
          "content_same": false
        },
        {
          "line": 580,
          "old_api": null,
          "new_api": "avio_seek",
          "old_text": null,
          "new_text": "avio_seek(s->pb, offset, SEEK_SET)",
          "old_line_content": "{",
          "new_line_content": "    if (avio_seek(s->pb, offset, SEEK_SET) < 0)",
          "content_same": false
        },
        {
          "line": 599,
          "old_api": null,
          "new_api": "AV_RB32",
          "old_text": null,
          "new_text": "AV_RB32(p->buf+i)",
          "old_line_content": "",
          "new_line_content": "        unsigned state = AV_RB32(p->buf+i);",
          "content_same": false
        },
        {
          "line": 477,
          "old_api": null,
          "new_api": "avio_read",
          "old_text": null,
          "new_text": "avio_read(s->pb, partial_frame, PARTIAL_FRAME_SIZE)",
          "old_line_content": "    RawDVContext *c = s->priv_data;",
          "new_line_content": "    ret = avio_read(s->pb, partial_frame, PARTIAL_FRAME_SIZE);",
          "content_same": false
        },
        {
          "line": 503,
          "old_api": null,
          "new_api": "dv_init_demux",
          "old_text": null,
          "new_text": "dv_init_demux(s, &c->dv_demux)",
          "old_line_content": "{",
          "new_line_content": "    if ((ret = dv_init_demux(s, &c->dv_demux)) < 0)",
          "content_same": false
        },
        {
          "line": 486,
          "old_api": null,
          "new_api": "dv_extract_timecode",
          "old_text": null,
          "new_text": "dv_extract_timecode(&c->dv_demux, partial_frame, timecode)",
          "old_line_content": "        ret = -1;",
          "new_line_content": "    ret = dv_extract_timecode(&c->dv_demux, partial_frame, timecode);",
          "content_same": false
        },
        {
          "line": 488,
          "old_api": null,
          "new_api": "av_dict_set",
          "old_text": null,
          "new_text": "av_dict_set(&s->metadata, \"timecode\", timecode, 0)",
          "old_line_content": "    }",
          "new_line_content": "        av_dict_set(&s->metadata, \"timecode\", timecode, 0);",
          "content_same": false
        },
        {
          "line": 493,
          "old_api": null,
          "new_api": "avio_seek",
          "old_text": null,
          "new_text": "avio_seek(s->pb, pos, SEEK_SET)",
          "old_line_content": "    else",
          "new_line_content": "    avio_seek(s->pb, pos, SEEK_SET);",
          "content_same": false
        },
        {
          "line": 631,
          "old_api": null,
          "new_api": "NULL_IF_CONFIG_SMALL",
          "old_text": null,
          "new_text": "NULL_IF_CONFIG_SMALL(\"DV (Digital Video)\")",
          "old_line_content": "    return 0;",
          "new_line_content": "    .long_name      = NULL_IF_CONFIG_SMALL(\"DV (Digital Video)\"),",
          "content_same": false
        },
        {
          "line": 506,
          "old_api": null,
          "new_api": "avio_rb32",
          "old_text": null,
          "new_text": "avio_rb32(s->pb)",
          "old_line_content": "    int ret;",
          "new_line_content": "    state = avio_rb32(s->pb);",
          "content_same": false
        },
        {
          "line": 509,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(s, AV_LOG_ERROR, \"Cannot find DV header.\\n\")",
          "old_line_content": "        return ret;",
          "new_line_content": "            av_log(s, AV_LOG_ERROR, \"Cannot find DV header.\\n\");",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 518,
          "old_api": "avio_tell",
          "new_api": null,
          "old_text": "avio_tell(s->pb)",
          "new_text": null,
          "old_line_content": "            marker_pos = avio_tell(s->pb);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 520,
          "old_api": "avio_seek",
          "new_api": null,
          "old_text": "avio_seek(s->pb, -163, SEEK_CUR)",
          "new_text": null,
          "old_line_content": "            avio_seek(s->pb, -163, SEEK_CUR);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 526,
          "old_api": "AV_WB32",
          "new_api": null,
          "old_text": "AV_WB32(c->buf, state)",
          "new_text": null,
          "old_line_content": "    AV_WB32(c->buf, state);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 529,
          "old_api": "avio_seek",
          "new_api": null,
          "old_text": "avio_seek(s->pb, -DV_PROFILE_BYTES, SEEK_CUR)",
          "new_text": null,
          "old_line_content": "        avio_seek(s->pb, -DV_PROFILE_BYTES, SEEK_CUR) < 0) {",
          "new_line_content": "                                           c->buf,",
          "content_same": false
        },
        {
          "line": 530,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(EIO)",
          "new_text": null,
          "old_line_content": "        return AVERROR(EIO);",
          "new_line_content": "                                           DV_PROFILE_BYTES);",
          "content_same": false
        },
        {
          "line": 533,
          "old_api": "av_dv_frame_profile",
          "new_api": null,
          "old_text": "av_dv_frame_profile(c->dv_demux.sys,\n                                           c->buf,\n                                           DV_PROFILE_BYTES)",
          "new_text": null,
          "old_line_content": "    c->dv_demux.sys = av_dv_frame_profile(c->dv_demux.sys,",
          "new_line_content": "               \"Can't determine profile of DV input stream.\\n\");",
          "content_same": false
        },
        {
          "line": 547,
          "old_api": "dv_read_timecode",
          "new_api": null,
          "old_text": "dv_read_timecode(s)",
          "new_text": null,
          "old_line_content": "        dv_read_timecode(s);",
          "new_line_content": "static int dv_read_packet(AVFormatContext *s, AVPacket *pkt)",
          "content_same": false
        },
        {
          "line": 557,
          "old_api": "avpriv_dv_get_packet",
          "new_api": null,
          "old_text": "avpriv_dv_get_packet(&c->dv_demux, pkt)",
          "new_text": null,
          "old_line_content": "    size = avpriv_dv_get_packet(&c->dv_demux, pkt);",
          "new_line_content": "        if (!c->dv_demux.sys)",
          "content_same": false
        },
        {
          "line": 561,
          "old_api": "avio_tell",
          "new_api": null,
          "old_text": "avio_tell(s->pb)",
          "new_text": null,
          "old_line_content": "        int64_t pos = avio_tell(s->pb);",
          "new_line_content": "        if (ret < 0) {",
          "content_same": false
        },
        {
          "line": 563,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(EIO)",
          "new_text": null,
          "old_line_content": "            return AVERROR(EIO);",
          "new_line_content": "        } else if (ret == 0) {",
          "content_same": false
        },
        {
          "line": 565,
          "old_api": "avio_read",
          "new_api": null,
          "old_text": "avio_read(s->pb, c->buf, size)",
          "new_text": null,
          "old_line_content": "        ret = avio_read(s->pb, c->buf, size);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 569,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(EIO)",
          "new_text": null,
          "old_line_content": "            return AVERROR(EIO);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 572,
          "old_api": "avpriv_dv_produce_packet",
          "new_api": null,
          "old_text": "avpriv_dv_produce_packet(&c->dv_demux, pkt, c->buf, size, pos)",
          "new_text": null,
          "old_line_content": "        size = avpriv_dv_produce_packet(&c->dv_demux, pkt, c->buf, size, pos);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 585,
          "old_api": "avio_seek",
          "new_api": null,
          "old_text": "avio_seek(s->pb, offset, SEEK_SET)",
          "new_text": null,
          "old_line_content": "    if (avio_seek(s->pb, offset, SEEK_SET) < 0)",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 588,
          "old_api": "ff_dv_offset_reset",
          "new_api": null,
          "old_text": "ff_dv_offset_reset(c, offset / c->sys->frame_size)",
          "new_text": null,
          "old_line_content": "    ff_dv_offset_reset(c, offset / c->sys->frame_size);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 474,
          "old_api": "av_mallocz",
          "new_api": null,
          "old_text": "av_mallocz(sizeof(*partial_frame) *\n                                        partial_frame_size)",
          "new_text": null,
          "old_line_content": "    uint8_t *partial_frame = av_mallocz(sizeof(*partial_frame) *",
          "new_line_content": "    uint8_t partial_frame[PARTIAL_FRAME_SIZE];",
          "content_same": false
        },
        {
          "line": 604,
          "old_api": "AV_RB32",
          "new_api": null,
          "old_text": "AV_RB32(p->buf+i)",
          "new_text": null,
          "old_line_content": "        unsigned state = AV_RB32(p->buf+i);",
          "new_line_content": "                secondary_matches++;",
          "content_same": false
        },
        {
          "line": 479,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(ENOMEM)",
          "new_text": null,
          "old_line_content": "        return AVERROR(ENOMEM);",
          "new_line_content": "        goto finish;",
          "content_same": false
        },
        {
          "line": 481,
          "old_api": "avio_read",
          "new_api": null,
          "old_text": "avio_read(s->pb, partial_frame, partial_frame_size)",
          "new_text": null,
          "old_line_content": "    ret = avio_read(s->pb, partial_frame, partial_frame_size);",
          "new_line_content": "    if (ret < PARTIAL_FRAME_SIZE) {",
          "content_same": false
        },
        {
          "line": 492,
          "old_api": "av_dict_set",
          "new_api": null,
          "old_text": "av_dict_set(&s->metadata, \"timecode\", timecode, 0)",
          "new_text": null,
          "old_line_content": "        av_dict_set(&s->metadata, \"timecode\", timecode, 0);",
          "new_line_content": "finish:",
          "content_same": false
        },
        {
          "line": 494,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(s, AV_LOG_ERROR, \"Detected timecode is invalid\\n\")",
          "new_text": null,
          "old_line_content": "        av_log(s, AV_LOG_ERROR, \"Detected timecode is invalid\\n\");",
          "new_line_content": "    return ret;",
          "content_same": false
        },
        {
          "line": 497,
          "old_api": "av_free",
          "new_api": null,
          "old_text": "av_free(partial_frame)",
          "new_text": null,
          "old_line_content": "    av_free(partial_frame);",
          "new_line_content": "static int dv_read_header(AVFormatContext *s)",
          "content_same": false
        },
        {
          "line": 498,
          "old_api": "avio_seek",
          "new_api": null,
          "old_text": "avio_seek(s->pb, pos, SEEK_SET)",
          "new_text": null,
          "old_line_content": "    avio_seek(s->pb, pos, SEEK_SET);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 636,
          "old_api": "NULL_IF_CONFIG_SMALL",
          "new_api": null,
          "old_text": "NULL_IF_CONFIG_SMALL(\"DV (Digital Video)\")",
          "new_text": null,
          "old_line_content": "    .long_name      = NULL_IF_CONFIG_SMALL(\"DV (Digital Video)\"),",
          "new_line_content": "    .read_seek      = dv_read_seek,",
          "content_same": false
        },
        {
          "line": 511,
          "old_api": "avio_rb32",
          "new_api": null,
          "old_text": "avio_rb32(s->pb)",
          "new_text": null,
          "old_line_content": "    state = avio_rb32(s->pb);",
          "new_line_content": "        }",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 11,
      "total_additions": 22,
      "total_deletions": 25,
      "total_api_changes": 58
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 10,
        "api_related_lines": 58,
        "non_api_lines": 5,
        "non_api_line_numbers": [
          485,
          473,
          475,
          476,
          478
        ]
      }
    },
    "api_calls_before": 71,
    "api_calls_after": 68,
    "diff_info": {
      "added_lines": 4,
      "removed_lines": 9,
      "total_diff_lines": 37
    }
  }
}