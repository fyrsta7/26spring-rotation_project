{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/7fabef1f014eea1c7b4a0eed789b7a4e8c76ad5f",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/7fabef1f014eea1c7b4a0eed789b7a4e8c76ad5f/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/7fabef1f014eea1c7b4a0eed789b7a4e8c76ad5f/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/7fabef1f014eea1c7b4a0eed789b7a4e8c76ad5f/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 190,
          "old_api": "av_log",
          "new_api": "get_buffer",
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"get_buffer() failed\\n\")",
          "new_text": "avctx->get_buffer(avctx, f)",
          "old_line_content": "        av_log(avctx, AV_LOG_ERROR, \"get_buffer() failed\\n\");",
          "new_line_content": "    if (avctx->get_buffer(avctx, f)) {",
          "content_same": false
        },
        {
          "line": 236,
          "old_api": "av_log",
          "new_api": "AV_RL32",
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"Fraps: error in data stream\\n\")",
          "new_text": "AV_RL32(buf)",
          "old_line_content": "            av_log(avctx, AV_LOG_ERROR, \"Fraps: error in data stream\\n\");",
          "new_line_content": "        if (AV_RL32(buf) != FPS_TAG || buf_size < planes*1024 + 24) {",
          "content_same": false
        },
        {
          "line": 252,
          "old_api": "fraps2_decode_plane",
          "new_api": "AVERROR",
          "old_text": "fraps2_decode_plane(s, f->data[i], f->linesize[i], avctx->width >> is_chroma,\n                    avctx->height >> is_chroma, buf + offs[i], offs[i + 1] - offs[i], is_chroma, 1)",
          "new_text": "AVERROR(ENOMEM)",
          "old_line_content": "            if(fraps2_decode_plane(s, f->data[i], f->linesize[i], avctx->width >> is_chroma,",
          "new_line_content": "                return AVERROR(ENOMEM);",
          "content_same": false
        },
        {
          "line": 263,
          "old_api": "av_log",
          "new_api": "AV_RL32",
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"Fraps: error in data stream\\n\")",
          "new_text": "AV_RL32(buf)",
          "old_line_content": "            av_log(avctx, AV_LOG_ERROR, \"Fraps: error in data stream\\n\");",
          "new_line_content": "        if (AV_RL32(buf) != FPS_TAG || buf_size < planes*1024 + 24) {",
          "content_same": false
        },
        {
          "line": 278,
          "old_api": "fraps2_decode_plane",
          "new_api": "AVERROR",
          "old_text": "fraps2_decode_plane(s, f->data[0] + i + (f->linesize[0] * (avctx->height - 1)), -f->linesize[0],\n                    avctx->width, avctx->height, buf + offs[i], offs[i + 1] - offs[i], 0, 3)",
          "new_text": "AVERROR(ENOMEM)",
          "old_line_content": "            if(fraps2_decode_plane(s, f->data[0] + i + (f->linesize[0] * (avctx->height - 1)), -f->linesize[0],",
          "new_line_content": "                return AVERROR(ENOMEM);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 264,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"Fraps: error in data stream\\n\")",
          "old_line_content": "            return -1;",
          "new_line_content": "            av_log(avctx, AV_LOG_ERROR, \"Fraps: error in data stream\\n\");",
          "content_same": false
        },
        {
          "line": 268,
          "old_api": null,
          "new_api": "AV_RL32",
          "old_text": null,
          "new_text": "AV_RL32(buf + 4 + i * 4)",
          "old_line_content": "            if(offs[i] >= buf_size || (i && offs[i] <= offs[i - 1] + 1024)) {",
          "new_line_content": "            offs[i] = AV_RL32(buf + 4 + i * 4);",
          "content_same": false
        },
        {
          "line": 270,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"Fraps: plane %i offset is out of bounds\\n\", i)",
          "old_line_content": "                return -1;",
          "new_line_content": "                av_log(avctx, AV_LOG_ERROR, \"Fraps: plane %i offset is out of bounds\\n\", i);",
          "content_same": false
        },
        {
          "line": 146,
          "old_api": null,
          "new_api": "AV_RL32",
          "old_text": null,
          "new_text": "AV_RL32(buf)",
          "old_line_content": "    version = header & 0xff;",
          "new_line_content": "    header = AV_RL32(buf);",
          "content_same": false
        },
        {
          "line": 276,
          "old_api": null,
          "new_api": "av_fast_padded_malloc",
          "old_text": null,
          "new_text": "av_fast_padded_malloc(&s->tmpbuf, &s->tmpbuf_size, offs[i + 1] - offs[i] - 1024)",
          "old_line_content": "            if (!s->tmpbuf)",
          "new_line_content": "            av_fast_padded_malloc(&s->tmpbuf, &s->tmpbuf_size, offs[i + 1] - offs[i] - 1024);",
          "content_same": false
        },
        {
          "line": 151,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR,\n               \"This file is encoded with Fraps version %d. \" \\\n               \"This codec can only decode versions <= 5.\\n\", version)",
          "old_line_content": "               \"This file is encoded with Fraps version %d. \" \\",
          "new_line_content": "        av_log(avctx, AV_LOG_ERROR,",
          "content_same": false
        },
        {
          "line": 279,
          "old_api": null,
          "new_api": "fraps2_decode_plane",
          "old_text": null,
          "new_text": "fraps2_decode_plane(s, f->data[0] + i + (f->linesize[0] * (avctx->height - 1)), -f->linesize[0],\n                    avctx->width, avctx->height, buf + offs[i], offs[i + 1] - offs[i], 0, 3)",
          "old_line_content": "                    avctx->width, avctx->height, buf + offs[i], offs[i + 1] - offs[i], 0, 3) < 0) {",
          "new_line_content": "            if(fraps2_decode_plane(s, f->data[0] + i + (f->linesize[0] * (avctx->height - 1)), -f->linesize[0],",
          "content_same": false
        },
        {
          "line": 281,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"Error decoding plane %i\\n\", i)",
          "old_line_content": "                return -1;",
          "new_line_content": "                av_log(avctx, AV_LOG_ERROR, \"Error decoding plane %i\\n\", i);",
          "content_same": false
        },
        {
          "line": 166,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR,\n                   \"Invalid frame length %d (should be %d)\\n\",\n                   buf_size, needed_size)",
          "old_line_content": "                   \"Invalid frame length %d (should be %d)\\n\",",
          "new_line_content": "            av_log(avctx, AV_LOG_ERROR,",
          "content_same": false
        },
        {
          "line": 185,
          "old_api": null,
          "new_api": "release_buffer",
          "old_text": null,
          "new_text": "avctx->release_buffer(avctx, &s->frame)",
          "old_line_content": "    f->pict_type = AV_PICTURE_TYPE_I;",
          "new_line_content": "        avctx->release_buffer(avctx, &s->frame);",
          "content_same": false
        },
        {
          "line": 316,
          "old_api": null,
          "new_api": "release_buffer",
          "old_text": null,
          "new_text": "avctx->release_buffer(avctx, &s->frame)",
          "old_line_content": "",
          "new_line_content": "        avctx->release_buffer(avctx, &s->frame);",
          "content_same": false
        },
        {
          "line": 318,
          "old_api": null,
          "new_api": "av_freep",
          "old_text": null,
          "new_text": "av_freep(&s->tmpbuf)",
          "old_line_content": "AVCodec ff_fraps_decoder = {",
          "new_line_content": "    av_freep(&s->tmpbuf);",
          "content_same": false
        },
        {
          "line": 191,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"get_buffer() failed\\n\")",
          "old_line_content": "        return -1;",
          "new_line_content": "        av_log(avctx, AV_LOG_ERROR, \"get_buffer() failed\\n\");",
          "content_same": false
        },
        {
          "line": 200,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"Invalid frame size %dx%d\\n\",\n                   avctx->width, avctx->height)",
          "old_line_content": "                   avctx->width, avctx->height);",
          "new_line_content": "            av_log(avctx, AV_LOG_ERROR, \"Invalid frame size %dx%d\\n\",",
          "content_same": false
        },
        {
          "line": 332,
          "old_api": null,
          "new_api": "NULL_IF_CONFIG_SMALL",
          "old_text": null,
          "new_text": "NULL_IF_CONFIG_SMALL(\"Fraps\")",
          "old_line_content": "",
          "new_line_content": "    .long_name = NULL_IF_CONFIG_SMALL(\"Fraps\"),",
          "content_same": false
        },
        {
          "line": 225,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy(&f->data[0][ (avctx->height-y)*f->linesize[0] ],\n                   &buf[y*avctx->width*3],\n                   3*avctx->width)",
          "old_line_content": "                   &buf[y*avctx->width*3],",
          "new_line_content": "            memcpy(&f->data[0][ (avctx->height-y)*f->linesize[0] ],",
          "content_same": false
        },
        {
          "line": 237,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"Fraps: error in data stream\\n\")",
          "old_line_content": "            return -1;",
          "new_line_content": "            av_log(avctx, AV_LOG_ERROR, \"Fraps: error in data stream\\n\");",
          "content_same": false
        },
        {
          "line": 241,
          "old_api": null,
          "new_api": "AV_RL32",
          "old_text": null,
          "new_text": "AV_RL32(buf + 4 + i * 4)",
          "old_line_content": "            if(offs[i] >= buf_size || (i && offs[i] <= offs[i - 1] + 1024)) {",
          "new_line_content": "            offs[i] = AV_RL32(buf + 4 + i * 4);",
          "content_same": false
        },
        {
          "line": 243,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"Fraps: plane %i offset is out of bounds\\n\", i)",
          "old_line_content": "                return -1;",
          "new_line_content": "                av_log(avctx, AV_LOG_ERROR, \"Fraps: plane %i offset is out of bounds\\n\", i);",
          "content_same": false
        },
        {
          "line": 250,
          "old_api": null,
          "new_api": "av_fast_padded_malloc",
          "old_text": null,
          "new_text": "av_fast_padded_malloc(&s->tmpbuf, &s->tmpbuf_size, offs[i + 1] - offs[i] - 1024)",
          "old_line_content": "            if (!s->tmpbuf)",
          "new_line_content": "            av_fast_padded_malloc(&s->tmpbuf, &s->tmpbuf_size, offs[i + 1] - offs[i] - 1024);",
          "content_same": false
        },
        {
          "line": 253,
          "old_api": null,
          "new_api": "fraps2_decode_plane",
          "old_text": null,
          "new_text": "fraps2_decode_plane(s, f->data[i], f->linesize[i], avctx->width >> is_chroma,\n                    avctx->height >> is_chroma, buf + offs[i], offs[i + 1] - offs[i], is_chroma, 1)",
          "old_line_content": "                    avctx->height >> is_chroma, buf + offs[i], offs[i + 1] - offs[i], is_chroma, 1) < 0) {",
          "new_line_content": "            if(fraps2_decode_plane(s, f->data[i], f->linesize[i], avctx->width >> is_chroma,",
          "content_same": false
        },
        {
          "line": 255,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"Error decoding plane %i\\n\", i)",
          "old_line_content": "                return -1;",
          "new_line_content": "                av_log(avctx, AV_LOG_ERROR, \"Error decoding plane %i\\n\", i);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 262,
          "old_api": "AV_RL32",
          "new_api": null,
          "old_text": "AV_RL32(buf)",
          "new_text": null,
          "old_line_content": "        if (AV_RL32(buf) != FPS_TAG || buf_size < planes*1024 + 24) {",
          "new_line_content": "        /* Virtually the same as version 4, but is for RGB24 */",
          "content_same": false
        },
        {
          "line": 267,
          "old_api": "AV_RL32",
          "new_api": null,
          "old_text": "AV_RL32(buf + 4 + i * 4)",
          "new_text": null,
          "old_line_content": "            offs[i] = AV_RL32(buf + 4 + i * 4);",
          "new_line_content": "        for(i = 0; i < planes; i++) {",
          "content_same": false
        },
        {
          "line": 269,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"Fraps: plane %i offset is out of bounds\\n\", i)",
          "new_text": null,
          "old_line_content": "                av_log(avctx, AV_LOG_ERROR, \"Fraps: plane %i offset is out of bounds\\n\", i);",
          "new_line_content": "            if(offs[i] >= buf_size || (i && offs[i] <= offs[i - 1] + 1024)) {",
          "content_same": false
        },
        {
          "line": 145,
          "old_api": "AV_RL32",
          "new_api": null,
          "old_text": "AV_RL32(buf)",
          "new_text": null,
          "old_line_content": "    header = AV_RL32(buf);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 275,
          "old_api": "av_fast_padded_malloc",
          "new_api": null,
          "old_text": "av_fast_padded_malloc(&s->tmpbuf, &s->tmpbuf_size, offs[i + 1] - offs[i] - 1024)",
          "new_text": null,
          "old_line_content": "            av_fast_padded_malloc(&s->tmpbuf, &s->tmpbuf_size, offs[i + 1] - offs[i] - 1024);",
          "new_line_content": "        for(i = 0; i < planes; i++){",
          "content_same": false
        },
        {
          "line": 277,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(ENOMEM)",
          "new_text": null,
          "old_line_content": "                return AVERROR(ENOMEM);",
          "new_line_content": "            if (!s->tmpbuf)",
          "content_same": false
        },
        {
          "line": 150,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR,\n               \"This file is encoded with Fraps version %d. \" \\\n               \"This codec can only decode versions <= 5.\\n\", version)",
          "new_text": null,
          "old_line_content": "        av_log(avctx, AV_LOG_ERROR,",
          "new_line_content": "    if (version > 5) {",
          "content_same": false
        },
        {
          "line": 280,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"Error decoding plane %i\\n\", i)",
          "new_text": null,
          "old_line_content": "                av_log(avctx, AV_LOG_ERROR, \"Error decoding plane %i\\n\", i);",
          "new_line_content": "                    avctx->width, avctx->height, buf + offs[i], offs[i + 1] - offs[i], 0, 3) < 0) {",
          "content_same": false
        },
        {
          "line": 165,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR,\n                   \"Invalid frame length %d (should be %d)\\n\",\n                   buf_size, needed_size)",
          "new_text": null,
          "old_line_content": "            av_log(avctx, AV_LOG_ERROR,",
          "new_line_content": "        if (buf_size != needed_size && buf_size != header_size) {",
          "content_same": false
        },
        {
          "line": 311,
          "old_api": "release_buffer",
          "new_api": null,
          "old_text": "avctx->release_buffer(avctx, &s->frame)",
          "new_text": null,
          "old_line_content": "        avctx->release_buffer(avctx, &s->frame);",
          "new_line_content": "static av_cold int decode_end(AVCodecContext *avctx)",
          "content_same": false
        },
        {
          "line": 184,
          "old_api": "release_buffer",
          "new_api": null,
          "old_text": "avctx->release_buffer(avctx, &s->frame)",
          "new_text": null,
          "old_line_content": "        avctx->release_buffer(avctx, &s->frame);",
          "new_line_content": "    if (s->frame.data[0])",
          "content_same": false
        },
        {
          "line": 313,
          "old_api": "av_freep",
          "new_api": null,
          "old_text": "av_freep(&s->tmpbuf)",
          "new_text": null,
          "old_line_content": "    av_freep(&s->tmpbuf);",
          "new_line_content": "    FrapsContext *s = (FrapsContext*)avctx->priv_data;",
          "content_same": false
        },
        {
          "line": 189,
          "old_api": "get_buffer",
          "new_api": null,
          "old_text": "avctx->get_buffer(avctx, f)",
          "new_text": null,
          "old_line_content": "    if (avctx->get_buffer(avctx, f)) {",
          "new_line_content": "    f->buffer_hints = FF_BUFFER_HINTS_VALID;",
          "content_same": false
        },
        {
          "line": 199,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"Invalid frame size %dx%d\\n\",\n                   avctx->width, avctx->height)",
          "new_text": null,
          "old_line_content": "            av_log(avctx, AV_LOG_ERROR, \"Invalid frame size %dx%d\\n\",",
          "new_line_content": "        if ( (avctx->width % 8) != 0 || (avctx->height % 2) != 0 ) {",
          "content_same": false
        },
        {
          "line": 327,
          "old_api": "NULL_IF_CONFIG_SMALL",
          "new_api": null,
          "old_text": "NULL_IF_CONFIG_SMALL(\"Fraps\")",
          "new_text": null,
          "old_line_content": "    .long_name = NULL_IF_CONFIG_SMALL(\"Fraps\"),",
          "new_line_content": "    .priv_data_size = sizeof(FrapsContext),",
          "content_same": false
        },
        {
          "line": 224,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy(&f->data[0][ (avctx->height-y)*f->linesize[0] ],\n                   &buf[y*avctx->width*3],\n                   3*avctx->width)",
          "new_text": null,
          "old_line_content": "            memcpy(&f->data[0][ (avctx->height-y)*f->linesize[0] ],",
          "new_line_content": "        for(y=0; y<avctx->height; y++)",
          "content_same": false
        },
        {
          "line": 235,
          "old_api": "AV_RL32",
          "new_api": null,
          "old_text": "AV_RL32(buf)",
          "new_text": null,
          "old_line_content": "        if (AV_RL32(buf) != FPS_TAG || buf_size < planes*1024 + 24) {",
          "new_line_content": "         */",
          "content_same": false
        },
        {
          "line": 240,
          "old_api": "AV_RL32",
          "new_api": null,
          "old_text": "AV_RL32(buf + 4 + i * 4)",
          "new_text": null,
          "old_line_content": "            offs[i] = AV_RL32(buf + 4 + i * 4);",
          "new_line_content": "        for(i = 0; i < planes; i++) {",
          "content_same": false
        },
        {
          "line": 242,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"Fraps: plane %i offset is out of bounds\\n\", i)",
          "new_text": null,
          "old_line_content": "                av_log(avctx, AV_LOG_ERROR, \"Fraps: plane %i offset is out of bounds\\n\", i);",
          "new_line_content": "            if(offs[i] >= buf_size || (i && offs[i] <= offs[i - 1] + 1024)) {",
          "content_same": false
        },
        {
          "line": 249,
          "old_api": "av_fast_padded_malloc",
          "new_api": null,
          "old_text": "av_fast_padded_malloc(&s->tmpbuf, &s->tmpbuf_size, offs[i + 1] - offs[i] - 1024)",
          "new_text": null,
          "old_line_content": "            av_fast_padded_malloc(&s->tmpbuf, &s->tmpbuf_size, offs[i + 1] - offs[i] - 1024);",
          "new_line_content": "            is_chroma = !!i;",
          "content_same": false
        },
        {
          "line": 251,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(ENOMEM)",
          "new_text": null,
          "old_line_content": "                return AVERROR(ENOMEM);",
          "new_line_content": "            if (!s->tmpbuf)",
          "content_same": false
        },
        {
          "line": 254,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"Error decoding plane %i\\n\", i)",
          "new_text": null,
          "old_line_content": "                av_log(avctx, AV_LOG_ERROR, \"Error decoding plane %i\\n\", i);",
          "new_line_content": "                    avctx->height >> is_chroma, buf + offs[i], offs[i + 1] - offs[i], is_chroma, 1) < 0) {",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 5,
      "total_additions": 22,
      "total_deletions": 22,
      "total_api_changes": 49
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 10,
        "api_related_lines": 49,
        "non_api_lines": 10,
        "non_api_line_numbers": [
          288,
          289,
          290,
          291,
          292,
          294,
          143,
          285,
          286,
          287
        ]
      }
    },
    "api_calls_before": 37,
    "api_calls_after": 37,
    "diff_info": {
      "added_lines": 8,
      "removed_lines": 3,
      "total_diff_lines": 33
    }
  }
}