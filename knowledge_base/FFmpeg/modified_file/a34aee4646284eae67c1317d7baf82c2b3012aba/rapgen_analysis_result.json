{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/a34aee4646284eae67c1317d7baf82c2b3012aba",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/a34aee4646284eae67c1317d7baf82c2b3012aba/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/a34aee4646284eae67c1317d7baf82c2b3012aba/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/a34aee4646284eae67c1317d7baf82c2b3012aba/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 837,
          "old_api": "get_delay",
          "new_api": "av_log",
          "old_text": "s->resampler->get_delay(s, base)",
          "new_text": "av_log(s, AV_LOG_VERBOSE, \"adding %d audio samples of silence\\n\", count)",
          "old_line_content": "        return s->resampler->get_delay(s, base);",
          "new_line_content": "    av_log(s, AV_LOG_VERBOSE, \"adding %d audio samples of silence\\n\", count);",
          "content_same": false
        },
        {
          "line": 859,
          "old_api": "set_compensation",
          "new_api": "swr_init",
          "old_text": "s->resampler->set_compensation(s->resample, sample_delta, compensation_distance)",
          "new_text": "swr_init(s)",
          "old_line_content": "        return s->resampler->set_compensation(s->resample, sample_delta, compensation_distance);",
          "new_line_content": "        ret = swr_init(s);",
          "content_same": false
        },
        {
          "line": 876,
          "old_api": "swr_drop_output   (s, -delta / s-> in_sample_rate)",
          "new_api": "swr_get_delay",
          "old_text": "swr_drop_output   (s, -delta / s-> in_sample_rate)",
          "new_text": "swr_get_delay(s, s->in_sample_rate * (int64_t)s->out_sample_rate)",
          "old_line_content": "                else          ret = swr_drop_output   (s, -delta / s-> in_sample_rate);",
          "new_line_content": "        int64_t delta = pts - swr_get_delay(s, s->in_sample_rate * (int64_t)s->out_sample_rate) - s->outpts;",
          "content_same": false
        },
        {
          "line": 883,
          "old_api": "av_clipf",
          "new_api": "swr_drop_output   (s, -delta / s-> in_sample_rate)",
          "old_text": "av_clipf(fdelta, -max_soft_compensation, max_soft_compensation)",
          "new_text": "swr_drop_output   (s, -delta / s-> in_sample_rate)",
          "old_line_content": "                int comp = av_clipf(fdelta, -max_soft_compensation, max_soft_compensation) * duration ;",
          "new_line_content": "                else          ret = swr_drop_output   (s, -delta / s-> in_sample_rate);",
          "content_same": false
        },
        {
          "line": 885,
          "old_api": "swr_set_compensation",
          "new_api": "av_log",
          "old_text": "swr_set_compensation(s, comp, duration)",
          "new_text": "av_log(s, AV_LOG_ERROR, \"Failed to compensate for timestamp delta of %f\\n\", fdelta)",
          "old_line_content": "                swr_set_compensation(s, comp, duration);",
          "new_line_content": "                    av_log(s, AV_LOG_ERROR, \"Failed to compensate for timestamp delta of %f\\n\", fdelta);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 832,
          "old_api": null,
          "new_api": "memset",
          "old_text": null,
          "new_text": "memset(s->silence.ch[i], s->silence.bps==1 ? 0x80 : 0, count*s->silence.bps)",
          "old_line_content": "    return ret;",
          "new_line_content": "        memset(s->silence.ch[i], s->silence.bps==1 ? 0x80 : 0, count*s->silence.bps);",
          "content_same": false
        },
        {
          "line": 864,
          "old_api": null,
          "new_api": "AVERROR",
          "old_text": null,
          "new_text": "AVERROR(EINVAL)",
          "old_line_content": "    if(pts == INT64_MIN)",
          "new_line_content": "        return AVERROR(EINVAL);",
          "content_same": false
        },
        {
          "line": 834,
          "old_api": null,
          "new_api": "memset",
          "old_text": null,
          "new_text": "memset(s->silence.ch[0], s->silence.bps==1 ? 0x80 : 0, count*s->silence.bps*s->silence.ch_count)",
          "old_line_content": "",
          "new_line_content": "        memset(s->silence.ch[0], s->silence.bps==1 ? 0x80 : 0, count*s->silence.bps*s->silence.ch_count);",
          "content_same": false
        },
        {
          "line": 866,
          "old_api": null,
          "new_api": "set_compensation",
          "old_text": null,
          "new_text": "s->resampler->set_compensation(s->resample, sample_delta, compensation_distance)",
          "old_line_content": "    if(s->min_compensation >= FLT_MAX) {",
          "new_line_content": "        return s->resampler->set_compensation(s->resample, sample_delta, compensation_distance);",
          "content_same": false
        },
        {
          "line": 836,
          "old_api": null,
          "new_api": "reversefill_audiodata",
          "old_text": null,
          "new_text": "reversefill_audiodata(&s->silence, tmp_arg)",
          "old_line_content": "    if (s->resampler && s->resample){",
          "new_line_content": "    reversefill_audiodata(&s->silence, tmp_arg);",
          "content_same": false
        },
        {
          "line": 838,
          "old_api": null,
          "new_api": "swr_convert",
          "old_text": null,
          "new_text": "swr_convert(s, NULL, 0, (const uint8_t**)tmp_arg, count)",
          "old_line_content": "    }else{",
          "new_line_content": "    ret = swr_convert(s, NULL, 0, (const uint8_t**)tmp_arg, count);",
          "content_same": false
        },
        {
          "line": 892,
          "old_api": null,
          "new_api": "swr_set_compensation",
          "old_text": null,
          "new_text": "swr_set_compensation(s, comp, duration)",
          "old_line_content": "",
          "new_line_content": "                swr_set_compensation(s, comp, duration);",
          "content_same": false
        },
        {
          "line": 874,
          "old_api": null,
          "new_api": "swr_get_delay",
          "old_text": null,
          "new_text": "swr_get_delay(s, s->in_sample_rate * (int64_t)s->out_sample_rate)",
          "old_line_content": "                int ret;",
          "new_line_content": "        return (s->outpts = pts - swr_get_delay(s, s->in_sample_rate * (int64_t)s->out_sample_rate));",
          "content_same": false
        },
        {
          "line": 844,
          "old_api": null,
          "new_api": "get_delay",
          "old_text": null,
          "new_text": "s->resampler->get_delay(s, base)",
          "old_line_content": "    int ret;",
          "new_line_content": "        return s->resampler->get_delay(s, base);",
          "content_same": false
        },
        {
          "line": 879,
          "old_api": null,
          "new_api": "fabs",
          "old_text": null,
          "new_text": "fabs(fdelta)",
          "old_line_content": "                }",
          "new_line_content": "        if(fabs(fdelta) > s->min_compensation) {",
          "content_same": false
        },
        {
          "line": 880,
          "old_api": null,
          "new_api": "fabs",
          "old_text": null,
          "new_text": "fabs(fdelta)",
          "old_line_content": "            } else if(s->soft_compensation_duration && s->max_soft_compensation) {",
          "new_line_content": "            if(!s->outpts || fabs(fdelta) > s->min_hard_compensation){",
          "content_same": false
        },
        {
          "line": 882,
          "old_api": null,
          "new_api": "swr_inject_silence",
          "old_text": null,
          "new_text": "swr_inject_silence(s,  delta / s->out_sample_rate)",
          "old_line_content": "                double max_soft_compensation = s->max_soft_compensation / (s->max_soft_compensation < 0 ? -s->in_sample_rate : 1);",
          "new_line_content": "                if(delta > 0) ret = swr_inject_silence(s,  delta / s->out_sample_rate);",
          "content_same": false
        },
        {
          "line": 854,
          "old_api": null,
          "new_api": "AVERROR",
          "old_text": null,
          "new_text": "AVERROR(EINVAL)",
          "old_line_content": "            return ret;",
          "new_line_content": "        return AVERROR(EINVAL);",
          "content_same": false
        },
        {
          "line": 823,
          "old_api": null,
          "new_api": "swr_inject_silence",
          "old_text": null,
          "new_text": "swr_inject_silence(s, MAX_SILENCE_STEP)",
          "old_line_content": "",
          "new_line_content": "        if ((ret = swr_inject_silence(s, MAX_SILENCE_STEP)) < 0)",
          "content_same": false
        },
        {
          "line": 856,
          "old_api": null,
          "new_api": "AVERROR",
          "old_text": null,
          "new_text": "AVERROR(EINVAL)",
          "old_line_content": "    if (!s->resampler->set_compensation){",
          "new_line_content": "        return AVERROR(EINVAL);",
          "content_same": false
        },
        {
          "line": 890,
          "old_api": null,
          "new_api": "av_clipf",
          "old_text": null,
          "new_text": "av_clipf(fdelta, -max_soft_compensation, max_soft_compensation)",
          "old_line_content": "    }",
          "new_line_content": "                int comp = av_clipf(fdelta, -max_soft_compensation, max_soft_compensation) * duration ;",
          "content_same": false
        },
        {
          "line": 891,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(s, AV_LOG_VERBOSE, \"compensating audio timestamp drift:%f compensation:%d in:%d\\n\", fdelta, comp, duration)",
          "old_line_content": "}",
          "new_line_content": "                av_log(s, AV_LOG_VERBOSE, \"compensating audio timestamp drift:%f compensation:%d in:%d\\n\", fdelta, comp, duration);",
          "content_same": false
        },
        {
          "line": 828,
          "old_api": null,
          "new_api": "swri_realloc_audio",
          "old_text": null,
          "new_text": "swri_realloc_audio(&s->silence, count)",
          "old_line_content": "",
          "new_line_content": "    if((ret=swri_realloc_audio(&s->silence, count))<0)",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 867,
          "old_api": "swr_get_delay",
          "new_api": null,
          "old_text": "swr_get_delay(s, s->in_sample_rate * (int64_t)s->out_sample_rate)",
          "new_text": null,
          "old_line_content": "        return (s->outpts = pts - swr_get_delay(s, s->in_sample_rate * (int64_t)s->out_sample_rate));",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 869,
          "old_api": "swr_get_delay",
          "new_api": null,
          "old_text": "swr_get_delay(s, s->in_sample_rate * (int64_t)s->out_sample_rate)",
          "new_text": null,
          "old_line_content": "        int64_t delta = pts - swr_get_delay(s, s->in_sample_rate * (int64_t)s->out_sample_rate) - s->outpts;",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 872,
          "old_api": "fabs",
          "new_api": null,
          "old_text": "fabs(fdelta)",
          "new_text": null,
          "old_line_content": "        if(fabs(fdelta) > s->min_compensation) {",
          "new_line_content": "        return s->outpts;",
          "content_same": false
        },
        {
          "line": 873,
          "old_api": "fabs",
          "new_api": null,
          "old_text": "fabs(fdelta)",
          "new_text": null,
          "old_line_content": "            if(!s->outpts || fabs(fdelta) > s->min_hard_compensation){",
          "new_line_content": "    if(s->min_compensation >= FLT_MAX) {",
          "content_same": false
        },
        {
          "line": 875,
          "old_api": "swr_inject_silence",
          "new_api": null,
          "old_text": "swr_inject_silence(s,  delta / s->out_sample_rate)",
          "new_text": null,
          "old_line_content": "                if(delta > 0) ret = swr_inject_silence(s,  delta / s->out_sample_rate);",
          "new_line_content": "    } else {",
          "content_same": false
        },
        {
          "line": 878,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(s, AV_LOG_ERROR, \"Failed to compensate for timestamp delta of %f\\n\", fdelta)",
          "new_text": null,
          "old_line_content": "                    av_log(s, AV_LOG_ERROR, \"Failed to compensate for timestamp delta of %f\\n\", fdelta);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 847,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(EINVAL)",
          "new_text": null,
          "old_line_content": "        return AVERROR(EINVAL);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 849,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(EINVAL)",
          "new_text": null,
          "old_line_content": "        return AVERROR(EINVAL);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 852,
          "old_api": "swr_init",
          "new_api": null,
          "old_text": "swr_init(s)",
          "new_text": null,
          "old_line_content": "        ret = swr_init(s);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 821,
          "old_api": "swri_realloc_audio",
          "new_api": null,
          "old_text": "swri_realloc_audio(&s->silence, count)",
          "new_text": null,
          "old_line_content": "    if((ret=swri_realloc_audio(&s->silence, count))<0)",
          "new_line_content": "#define MAX_SILENCE_STEP 16384",
          "content_same": false
        },
        {
          "line": 884,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(s, AV_LOG_VERBOSE, \"compensating audio timestamp drift:%f compensation:%d in:%d\\n\", fdelta, comp, duration)",
          "new_text": null,
          "old_line_content": "                av_log(s, AV_LOG_VERBOSE, \"compensating audio timestamp drift:%f compensation:%d in:%d\\n\", fdelta, comp, duration);",
          "new_line_content": "                if(ret<0){",
          "content_same": false
        },
        {
          "line": 857,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(EINVAL)",
          "new_text": null,
          "old_line_content": "        return AVERROR(EINVAL);",
          "new_line_content": "    if (!s->resample) {",
          "content_same": false
        },
        {
          "line": 825,
          "old_api": "memset",
          "new_api": null,
          "old_text": "memset(s->silence.ch[i], s->silence.bps==1 ? 0x80 : 0, count*s->silence.bps)",
          "new_text": null,
          "old_line_content": "        memset(s->silence.ch[i], s->silence.bps==1 ? 0x80 : 0, count*s->silence.bps);",
          "new_line_content": "        count -= MAX_SILENCE_STEP;",
          "content_same": false
        },
        {
          "line": 827,
          "old_api": "memset",
          "new_api": null,
          "old_text": "memset(s->silence.ch[0], s->silence.bps==1 ? 0x80 : 0, count*s->silence.bps*s->silence.ch_count)",
          "new_text": null,
          "old_line_content": "        memset(s->silence.ch[0], s->silence.bps==1 ? 0x80 : 0, count*s->silence.bps*s->silence.ch_count);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 829,
          "old_api": "reversefill_audiodata",
          "new_api": null,
          "old_text": "reversefill_audiodata(&s->silence, tmp_arg)",
          "new_text": null,
          "old_line_content": "    reversefill_audiodata(&s->silence, tmp_arg);",
          "new_line_content": "        return ret;",
          "content_same": false
        },
        {
          "line": 830,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(s, AV_LOG_VERBOSE, \"adding %d audio samples of silence\\n\", count)",
          "new_text": null,
          "old_line_content": "    av_log(s, AV_LOG_VERBOSE, \"adding %d audio samples of silence\\n\", count);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 831,
          "old_api": "swr_convert",
          "new_api": null,
          "old_text": "swr_convert(s, NULL, 0, (const uint8_t**)tmp_arg, count)",
          "new_text": null,
          "old_line_content": "    ret = swr_convert(s, NULL, 0, (const uint8_t**)tmp_arg, count);",
          "new_line_content": "    if(s->silence.planar) for(i=0; i<s->silence.ch_count; i++) {",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 5,
      "total_additions": 18,
      "total_deletions": 17,
      "total_api_changes": 40
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 7,
        "api_related_lines": 40,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          824,
          826,
          822
        ]
      }
    },
    "api_calls_before": 242,
    "api_calls_after": 243,
    "diff_info": {
      "added_lines": 7,
      "removed_lines": 0,
      "total_diff_lines": 19
    }
  }
}