{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/dbac849c4db9c9378ab6e55f4f489debf2659b04",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/dbac849c4db9c9378ab6e55f4f489debf2659b04/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/dbac849c4db9c9378ab6e55f4f489debf2659b04/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/dbac849c4db9c9378ab6e55f4f489debf2659b04/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 619,
          "old_api": "ff_thread_get_buffer",
          "new_api": "AV_RL32",
          "old_text": "ff_thread_get_buffer(avctx, &frame, 0)",
          "new_text": "AV_RL32(buf + 9)",
          "old_line_content": "        if ((ret = ff_thread_get_buffer(avctx, &frame, 0)) < 0)",
          "new_line_content": "        offs[3] = AV_RL32(buf + 9);",
          "content_same": false
        },
        {
          "line": 637,
          "old_api": "av_log",
          "new_api": "AVERROR",
          "old_text": "av_log(avctx, AV_LOG_ERROR,\n                        \"Invalid frame offsets\\n\")",
          "new_text": "AVERROR(ENOMEM)",
          "old_line_content": "                av_log(avctx, AV_LOG_ERROR,",
          "new_line_content": "            return AVERROR(ENOMEM);",
          "content_same": false
        },
        {
          "line": 643,
          "old_api": "lag_decode_arith_plane",
          "new_api": "av_log",
          "old_text": "lag_decode_arith_plane(l, srcs[i],\n                                   avctx->width, avctx->height,\n                                   -l->rgb_stride, buf + offs[i],\n                                   buf_size - offs[i])",
          "new_text": "av_log(avctx, AV_LOG_ERROR,\n                        \"Invalid frame offsets\\n\")",
          "old_line_content": "            lag_decode_arith_plane(l, srcs[i],",
          "new_line_content": "                av_log(avctx, AV_LOG_ERROR,",
          "content_same": false
        },
        {
          "line": 681,
          "old_api": "av_log",
          "new_api": "ff_thread_get_buffer",
          "old_text": "av_log(avctx, AV_LOG_ERROR,\n                   \"Invalid frame offsets\\n\")",
          "new_text": "ff_thread_get_buffer(avctx, &frame, 0)",
          "old_line_content": "            av_log(avctx, AV_LOG_ERROR,",
          "new_line_content": "        if ((ret = ff_thread_get_buffer(avctx, &frame, 0)) < 0)",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 771,
          "old_api": null,
          "new_api": "NULL_IF_CONFIG_SMALL",
          "old_text": null,
          "new_text": "NULL_IF_CONFIG_SMALL(\"Lagarith lossless\")",
          "old_line_content": "    .close          = lag_decode_end,",
          "new_line_content": "    .long_name      = NULL_IF_CONFIG_SMALL(\"Lagarith lossless\"),",
          "content_same": false
        },
        {
          "line": 764,
          "old_api": null,
          "new_api": "av_freep",
          "old_text": null,
          "new_text": "av_freep(&l->rgb_planes)",
          "old_line_content": "    .name           = \"lagarith\",",
          "new_line_content": "    av_freep(&l->rgb_planes);",
          "content_same": false
        },
        {
          "line": 776,
          "old_api": null,
          "new_api": "ONLY_IF_THREADS_ENABLED",
          "old_text": null,
          "new_text": "ONLY_IF_THREADS_ENABLED(lag_decode_init_thread_copy)",
          "old_line_content": "",
          "new_line_content": "    .init_thread_copy = ONLY_IF_THREADS_ENABLED(lag_decode_init_thread_copy),",
          "content_same": false
        },
        {
          "line": 649,
          "old_api": null,
          "new_api": "lag_decode_arith_plane",
          "old_text": null,
          "new_text": "lag_decode_arith_plane(l, srcs[i],\n                                   avctx->width, avctx->height,\n                                   -l->rgb_stride, buf + offs[i],\n                                   buf_size - offs[i])",
          "old_line_content": "            srcs[i] = l->rgb_planes + i * l->rgb_stride * avctx->height;",
          "new_line_content": "            lag_decode_arith_plane(l, srcs[i],",
          "content_same": false
        },
        {
          "line": 666,
          "old_api": null,
          "new_api": "MKBETAG",
          "old_text": null,
          "new_text": "MKBETAG(a, r, g, b)",
          "old_line_content": "            }",
          "new_line_content": "                    AV_WN32(dst + i * 4, MKBETAG(a, r, g, b));",
          "content_same": false
        },
        {
          "line": 687,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR,\n                   \"Invalid frame offsets\\n\")",
          "old_line_content": "                               p->linesize[0], buf + offset_ry,",
          "new_line_content": "            av_log(avctx, AV_LOG_ERROR,",
          "content_same": false
        },
        {
          "line": 695,
          "old_api": null,
          "new_api": "lag_decode_arith_plane",
          "old_text": null,
          "new_text": "lag_decode_arith_plane(l, p->data[1], (avctx->width + 1) / 2,\n                               avctx->height, p->linesize[1],\n                               buf + offset_gu, buf_size - offset_gu)",
          "old_line_content": "        break;",
          "new_line_content": "        lag_decode_arith_plane(l, p->data[1], (avctx->width + 1) / 2,",
          "content_same": false
        },
        {
          "line": 698,
          "old_api": null,
          "new_api": "lag_decode_arith_plane",
          "old_text": null,
          "new_text": "lag_decode_arith_plane(l, p->data[2], (avctx->width + 1) / 2,\n                               avctx->height, p->linesize[2],\n                               buf + offset_bv, buf_size - offset_bv)",
          "old_line_content": "",
          "new_line_content": "        lag_decode_arith_plane(l, p->data[2], (avctx->width + 1) / 2,",
          "content_same": false
        },
        {
          "line": 705,
          "old_api": null,
          "new_api": "ff_thread_get_buffer",
          "old_text": null,
          "new_text": "ff_thread_get_buffer(avctx, &frame, 0)",
          "old_line_content": "        if (offset_ry >= buf_size ||",
          "new_line_content": "        if ((ret = ff_thread_get_buffer(avctx, &frame, 0)) < 0)",
          "content_same": false
        },
        {
          "line": 579,
          "old_api": null,
          "new_api": "AV_WN64",
          "old_text": null,
          "new_text": "AV_WN64(dst + i * 16    , c)",
          "old_line_content": "        }",
          "new_line_content": "                AV_WN64(dst + i * 16    , c);",
          "content_same": false
        },
        {
          "line": 580,
          "old_api": null,
          "new_api": "AV_WN64",
          "old_text": null,
          "new_text": "AV_WN64(dst + i * 16 + 8, c)",
          "old_line_content": "        } else {",
          "new_line_content": "                AV_WN64(dst + i * 16 + 8, c);",
          "content_same": false
        },
        {
          "line": 583,
          "old_api": null,
          "new_api": "AV_WN32",
          "old_text": null,
          "new_text": "AV_WN32(dst + i * 4, offset_gu)",
          "old_line_content": "                dst += p->linesize[0];",
          "new_line_content": "                AV_WN32(dst + i * 4, offset_gu);",
          "content_same": false
        },
        {
          "line": 714,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR,\n                   \"Invalid frame offsets\\n\")",
          "old_line_content": "                               p->linesize[0], buf + offset_ry,",
          "new_line_content": "            av_log(avctx, AV_LOG_ERROR,",
          "content_same": false
        },
        {
          "line": 588,
          "old_api": null,
          "new_api": "memset",
          "old_text": null,
          "new_text": "memset(dst, buf[1], avctx->width * planes)",
          "old_line_content": "        if (avctx->bits_per_coded_sample == 24) {",
          "new_line_content": "                memset(dst, buf[1], avctx->width * planes);",
          "content_same": false
        },
        {
          "line": 722,
          "old_api": null,
          "new_api": "lag_decode_arith_plane",
          "old_text": null,
          "new_text": "lag_decode_arith_plane(l, p->data[2], (avctx->width + 1) / 2,\n                               (avctx->height + 1) / 2, p->linesize[2],\n                               buf + offset_gu, buf_size - offset_gu)",
          "old_line_content": "        break;",
          "new_line_content": "        lag_decode_arith_plane(l, p->data[2], (avctx->width + 1) / 2,",
          "content_same": false
        },
        {
          "line": 725,
          "old_api": null,
          "new_api": "lag_decode_arith_plane",
          "old_text": null,
          "new_text": "lag_decode_arith_plane(l, p->data[1], (avctx->width + 1) / 2,\n                               (avctx->height + 1) / 2, p->linesize[1],\n                               buf + offset_bv, buf_size - offset_bv)",
          "old_line_content": "               \"Unsupported Lagarith frame type: %#\"PRIx8\"\\n\", frametype);",
          "new_line_content": "        lag_decode_arith_plane(l, p->data[1], (avctx->width + 1) / 2,",
          "content_same": false
        },
        {
          "line": 601,
          "old_api": null,
          "new_api": "ff_thread_get_buffer",
          "old_text": null,
          "new_text": "ff_thread_get_buffer(avctx, &frame,0)",
          "old_line_content": "                if (avctx->bits_per_coded_sample == 24) {",
          "new_line_content": "        if ((ret = ff_thread_get_buffer(avctx, &frame,0)) < 0)",
          "content_same": false
        },
        {
          "line": 730,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR,\n               \"Unsupported Lagarith frame type: %#\"PRIx8\"\\n\", frametype)",
          "old_line_content": "",
          "new_line_content": "        av_log(avctx, AV_LOG_ERROR,",
          "content_same": false
        },
        {
          "line": 608,
          "old_api": null,
          "new_api": "AV_WB24",
          "old_text": null,
          "new_text": "AV_WB24(dst + i * 3, offset_gu)",
          "old_line_content": "        break;",
          "new_line_content": "                    AV_WB24(dst + i * 3, offset_gu);",
          "content_same": false
        },
        {
          "line": 610,
          "old_api": null,
          "new_api": "AV_WN32",
          "old_text": null,
          "new_text": "AV_WN32(dst + i * 4, offset_gu)",
          "old_line_content": "        avctx->pix_fmt = AV_PIX_FMT_RGB32;",
          "new_line_content": "                    AV_WN32(dst + i * 4, offset_gu);",
          "content_same": false
        },
        {
          "line": 745,
          "old_api": null,
          "new_api": "ff_llviddsp_init",
          "old_text": null,
          "new_text": "ff_llviddsp_init(&l->llviddsp)",
          "old_line_content": "static av_cold int lag_decode_init_thread_copy(AVCodecContext *avctx)",
          "new_line_content": "    ff_llviddsp_init(&l->llviddsp);",
          "content_same": false
        },
        {
          "line": 625,
          "old_api": null,
          "new_api": "ff_thread_get_buffer",
          "old_text": null,
          "new_text": "ff_thread_get_buffer(avctx, &frame, 0)",
          "old_line_content": "",
          "new_line_content": "        if ((ret = ff_thread_get_buffer(avctx, &frame, 0)) < 0)",
          "content_same": false
        },
        {
          "line": 632,
          "old_api": null,
          "new_api": "FFALIGN",
          "old_text": null,
          "new_text": "FFALIGN(avctx->width, 16)",
          "old_line_content": "        }",
          "new_line_content": "        l->rgb_stride = FFALIGN(avctx->width, 16);",
          "content_same": false
        },
        {
          "line": 633,
          "old_api": null,
          "new_api": "av_fast_malloc",
          "old_text": null,
          "new_text": "av_fast_malloc(&l->rgb_planes, &l->rgb_planes_allocated,\n                       l->rgb_stride * avctx->height * planes + 1)",
          "old_line_content": "        for (i = 0; i < planes; i++)",
          "new_line_content": "        av_fast_malloc(&l->rgb_planes, &l->rgb_planes_allocated,",
          "content_same": false
        },
        {
          "line": 636,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(avctx, AV_LOG_ERROR, \"cannot allocate temporary buffer\\n\")",
          "old_line_content": "            if (buf_size <= offs[i]) {",
          "new_line_content": "            av_log(avctx, AV_LOG_ERROR, \"cannot allocate temporary buffer\\n\");",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 770,
          "old_api": "ONLY_IF_THREADS_ENABLED",
          "new_api": null,
          "old_text": "ONLY_IF_THREADS_ENABLED(lag_decode_init_thread_copy)",
          "new_text": null,
          "old_line_content": "    .init_thread_copy = ONLY_IF_THREADS_ENABLED(lag_decode_init_thread_copy),",
          "new_line_content": "    .name           = \"lagarith\",",
          "content_same": false
        },
        {
          "line": 660,
          "old_api": "MKBETAG",
          "new_api": null,
          "old_text": "MKBETAG(a, r, g, b)",
          "new_text": null,
          "old_line_content": "                    AV_WN32(dst + i * 4, MKBETAG(a, r, g, b));",
          "new_line_content": "                g = srcs[1][i];",
          "content_same": false
        },
        {
          "line": 675,
          "old_api": "ff_thread_get_buffer",
          "new_api": null,
          "old_text": "ff_thread_get_buffer(avctx, &frame, 0)",
          "new_text": null,
          "old_line_content": "        if ((ret = ff_thread_get_buffer(avctx, &frame, 0)) < 0)",
          "new_line_content": "                srcs[i] += l->rgb_stride;",
          "content_same": false
        },
        {
          "line": 686,
          "old_api": "lag_decode_arith_plane",
          "new_api": null,
          "old_text": "lag_decode_arith_plane(l, p->data[0], avctx->width, avctx->height,\n                               p->linesize[0], buf + offset_ry,\n                               buf_size - offset_ry)",
          "new_text": null,
          "old_line_content": "        lag_decode_arith_plane(l, p->data[0], avctx->width, avctx->height,",
          "new_line_content": "            offset_bv >= buf_size) {",
          "content_same": false
        },
        {
          "line": 689,
          "old_api": "lag_decode_arith_plane",
          "new_api": null,
          "old_text": "lag_decode_arith_plane(l, p->data[1], (avctx->width + 1) / 2,\n                               avctx->height, p->linesize[1],\n                               buf + offset_gu, buf_size - offset_gu)",
          "new_text": null,
          "old_line_content": "        lag_decode_arith_plane(l, p->data[1], (avctx->width + 1) / 2,",
          "new_line_content": "            return AVERROR_INVALIDDATA;",
          "content_same": false
        },
        {
          "line": 699,
          "old_api": "ff_thread_get_buffer",
          "new_api": null,
          "old_text": "ff_thread_get_buffer(avctx, &frame, 0)",
          "new_text": null,
          "old_line_content": "        if ((ret = ff_thread_get_buffer(avctx, &frame, 0)) < 0)",
          "new_line_content": "                               avctx->height, p->linesize[2],",
          "content_same": false
        },
        {
          "line": 577,
          "old_api": "AV_WN32",
          "new_api": null,
          "old_text": "AV_WN32(dst + i * 4, offset_gu)",
          "new_text": null,
          "old_line_content": "                AV_WN32(dst + i * 4, offset_gu);",
          "new_line_content": "        for (j = 0; j < avctx->height; j++) {",
          "content_same": false
        },
        {
          "line": 708,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR,\n                   \"Invalid frame offsets\\n\")",
          "new_text": null,
          "old_line_content": "            av_log(avctx, AV_LOG_ERROR,",
          "new_line_content": "            return AVERROR_INVALIDDATA;",
          "content_same": false
        },
        {
          "line": 582,
          "old_api": "memset",
          "new_api": null,
          "old_text": "memset(dst, buf[1], avctx->width * planes)",
          "new_text": null,
          "old_line_content": "                memset(dst, buf[1], avctx->width * planes);",
          "new_line_content": "            for (i = 4*qwidth; i < avctx->width; i++)",
          "content_same": false
        },
        {
          "line": 713,
          "old_api": "lag_decode_arith_plane",
          "new_api": null,
          "old_text": "lag_decode_arith_plane(l, p->data[0], avctx->width, avctx->height,\n                               p->linesize[0], buf + offset_ry,\n                               buf_size - offset_ry)",
          "new_text": null,
          "old_line_content": "        lag_decode_arith_plane(l, p->data[0], avctx->width, avctx->height,",
          "new_line_content": "            offset_bv >= buf_size) {",
          "content_same": false
        },
        {
          "line": 716,
          "old_api": "lag_decode_arith_plane",
          "new_api": null,
          "old_text": "lag_decode_arith_plane(l, p->data[2], (avctx->width + 1) / 2,\n                               (avctx->height + 1) / 2, p->linesize[2],\n                               buf + offset_gu, buf_size - offset_gu)",
          "new_text": null,
          "old_line_content": "        lag_decode_arith_plane(l, p->data[2], (avctx->width + 1) / 2,",
          "new_line_content": "            return AVERROR_INVALIDDATA;",
          "content_same": false
        },
        {
          "line": 595,
          "old_api": "ff_thread_get_buffer",
          "new_api": null,
          "old_text": "ff_thread_get_buffer(avctx, &frame,0)",
          "new_text": null,
          "old_line_content": "        if ((ret = ff_thread_get_buffer(avctx, &frame,0)) < 0)",
          "new_line_content": "            avctx->pix_fmt = AV_PIX_FMT_RGB24;",
          "content_same": false
        },
        {
          "line": 724,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR,\n               \"Unsupported Lagarith frame type: %#\"PRIx8\"\\n\", frametype)",
          "new_text": null,
          "old_line_content": "        av_log(avctx, AV_LOG_ERROR,",
          "new_line_content": "                               buf + offset_gu, buf_size - offset_gu);",
          "content_same": false
        },
        {
          "line": 602,
          "old_api": "AV_WB24",
          "new_api": null,
          "old_text": "AV_WB24(dst + i * 3, offset_gu)",
          "new_text": null,
          "old_line_content": "                    AV_WB24(dst + i * 3, offset_gu);",
          "new_line_content": "            return ret;",
          "content_same": false
        },
        {
          "line": 604,
          "old_api": "AV_WN32",
          "new_api": null,
          "old_text": "AV_WN32(dst + i * 4, offset_gu)",
          "new_text": null,
          "old_line_content": "                    AV_WN32(dst + i * 4, offset_gu);",
          "new_line_content": "        dst = p->data[0];",
          "content_same": false
        },
        {
          "line": 739,
          "old_api": "ff_llviddsp_init",
          "new_api": null,
          "old_text": "ff_llviddsp_init(&l->llviddsp)",
          "new_text": null,
          "old_line_content": "    ff_llviddsp_init(&l->llviddsp);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 613,
          "old_api": "AV_RL32",
          "new_api": null,
          "old_text": "AV_RL32(buf + 9)",
          "new_text": null,
          "old_line_content": "        offs[3] = AV_RL32(buf + 9);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 626,
          "old_api": "FFALIGN",
          "new_api": null,
          "old_text": "FFALIGN(avctx->width, 16)",
          "new_text": null,
          "old_line_content": "        l->rgb_stride = FFALIGN(avctx->width, 16);",
          "new_line_content": "            return ret;",
          "content_same": false
        },
        {
          "line": 627,
          "old_api": "av_fast_malloc",
          "new_api": null,
          "old_text": "av_fast_malloc(&l->rgb_planes, &l->rgb_planes_allocated,\n                       l->rgb_stride * avctx->height * planes + 1)",
          "new_text": null,
          "old_line_content": "        av_fast_malloc(&l->rgb_planes, &l->rgb_planes_allocated,",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 630,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(avctx, AV_LOG_ERROR, \"cannot allocate temporary buffer\\n\")",
          "new_text": null,
          "old_line_content": "            av_log(avctx, AV_LOG_ERROR, \"cannot allocate temporary buffer\\n\");",
          "new_line_content": "        offs[2] = offset_ry;",
          "content_same": false
        },
        {
          "line": 631,
          "old_api": "AVERROR",
          "new_api": null,
          "old_text": "AVERROR(ENOMEM)",
          "new_text": null,
          "old_line_content": "            return AVERROR(ENOMEM);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 758,
          "old_api": "av_freep",
          "new_api": null,
          "old_text": "av_freep(&l->rgb_planes)",
          "new_text": null,
          "old_line_content": "    av_freep(&l->rgb_planes);",
          "new_line_content": "#endif",
          "content_same": false
        },
        {
          "line": 765,
          "old_api": "NULL_IF_CONFIG_SMALL",
          "new_api": null,
          "old_text": "NULL_IF_CONFIG_SMALL(\"Lagarith lossless\")",
          "new_text": null,
          "old_line_content": "    .long_name      = NULL_IF_CONFIG_SMALL(\"Lagarith lossless\"),",
          "new_line_content": "",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 4,
      "total_additions": 25,
      "total_deletions": 23,
      "total_api_changes": 52
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 7,
        "api_related_lines": 52,
        "non_api_lines": 4,
        "non_api_line_numbers": [
          576,
          578,
          581,
          575
        ]
      }
    },
    "api_calls_before": 82,
    "api_calls_after": 84,
    "diff_info": {
      "added_lines": 7,
      "removed_lines": 1,
      "total_diff_lines": 21
    }
  }
}