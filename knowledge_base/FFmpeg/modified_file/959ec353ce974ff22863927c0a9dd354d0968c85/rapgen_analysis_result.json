{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/959ec353ce974ff22863927c0a9dd354d0968c85",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/959ec353ce974ff22863927c0a9dd354d0968c85/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/959ec353ce974ff22863927c0a9dd354d0968c85/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/959ec353ce974ff22863927c0a9dd354d0968c85/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 437,
          "old_api": "MIN",
          "new_api": "MAX",
          "old_text": "MIN(w, w - offx),\n",
          "new_text": "MAX(0, -offy),\n",
          "old_line_content": "                    .endx         = FFMIN(w, w - offx),",
          "new_line_content": "                    .starty       = FFMAX(0, -offy),",
          "content_same": false
        },
        {
          "line": 447,
          "old_api": "_filter_get_nb_threads",
          "new_api": "_filter_execute",
          "old_text": "_filter_get_nb_threads(ctx)))",
          "new_text": "_filter_execute(ctx, nlmeans_slice, &td, NULL,\n                                  FFMIN(td.endy - td.starty, ff_filter_get_nb_threads(ctx)));\n",
          "old_line_content": "                                  FFMIN(td.endy - td.starty, ff_filter_get_nb_threads(ctx)));",
          "new_line_content": "                ff_filter_execute(ctx, nlmeans_slice, &td, NULL,",
          "content_same": false
        },
        {
          "line": 467,
          "old_api": "ERROR",
          "new_api": "_frame_free",
          "old_text": "ERROR(ENOMEM);\n",
          "new_text": "_frame_free(&in);\n",
          "old_line_content": "        return AVERROR(ENOMEM);",
          "new_line_content": "        av_frame_free(&in);",
          "content_same": false
        },
        {
          "line": 482,
          "old_api": "_filter_frame",
          "new_api": "_frame_free",
          "old_text": "_filter_frame(outlink, out);\n",
          "new_text": "_frame_free(&in);\n",
          "old_line_content": "    return ff_filter_frame(outlink, out);",
          "new_line_content": "    av_frame_free(&in);",
          "content_same": false
        },
        {
          "line": 508,
          "old_api": "_calloc",
          "new_api": "g",
          "old_text": "_calloc(s->max_meaningful_diff, sizeof(*s->weight_lut));\n",
          "new_text": "g(255.) /",
          "old_line_content": "    s->weight_lut = av_calloc(s->max_meaningful_diff, sizeof(*s->weight_lut));",
          "new_line_content": "    s->max_meaningful_diff = log(255.) / s->pdiff_scale;",
          "content_same": false
        },
        {
          "line": 568,
          "old_api": "LTER_OUTPUTS",
          "new_api": "LTER_INPUTS",
          "old_text": "LTER_OUTPUTS(nlmeans_outputs),\n",
          "new_text": "LTER_INPUTS(nlmeans_inputs),\n",
          "old_line_content": "    FILTER_OUTPUTS(nlmeans_outputs),",
          "new_line_content": "    FILTER_INPUTS(nlmeans_inputs),",
          "content_same": false
        },
        {
          "line": 569,
          "old_api": "LTER_PIXFMTS_ARRAY",
          "new_api": "LTER_OUTPUTS",
          "old_text": "LTER_PIXFMTS_ARRAY(pix_fmts),\n",
          "new_text": "LTER_OUTPUTS(nlmeans_outputs),\n",
          "old_line_content": "    FILTER_PIXFMTS_ARRAY(pix_fmts),",
          "new_line_content": "    FILTER_OUTPUTS(nlmeans_outputs),",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 513,
          "old_api": null,
          "new_api": "p",
          "old_text": null,
          "new_text": "p(-i * s->pdiff_scale);\n",
          "old_line_content": "",
          "new_line_content": "        s->weight_lut[i] = exp(-i * s->pdiff_scale);",
          "content_same": false
        },
        {
          "line": 516,
          "old_api": null,
          "new_api": "ECK_ODD_FIELD",
          "old_text": null,
          "new_text": "ECK_ODD_FIELD(patch_size,      \"Luma patch\");\n",
          "old_line_content": "",
          "new_line_content": "    CHECK_ODD_FIELD(patch_size,      \"Luma patch\");",
          "content_same": false
        },
        {
          "line": 522,
          "old_api": null,
          "new_api": "ECK_ODD_FIELD",
          "old_text": null,
          "new_text": "ECK_ODD_FIELD(patch_size_uv,    \"Chroma patch\");\n",
          "old_line_content": "",
          "new_line_content": "    CHECK_ODD_FIELD(patch_size_uv,    \"Chroma patch\");",
          "content_same": false
        },
        {
          "line": 529,
          "old_api": null,
          "new_api": "_log",
          "old_text": null,
          "new_text": "_log(ctx, AV_LOG_INFO, \"Research window: %dx%d / %dx%d, patch size: %dx%d / %dx%d\\n\",\n           s->research_size, s->research_size, s->research_size_uv, s->research_size_uv,\n           s->patch_size,    s->patch_size,    s->patch_size_uv,    s->patch_size_uv);\n",
          "old_line_content": "           s->research_size, s->research_size, s->research_size_uv, s->research_size_uv,",
          "new_line_content": "    av_log(ctx, AV_LOG_INFO, \"Research window: %dx%d / %dx%d, patch size: %dx%d / %dx%d\\n\",",
          "content_same": false
        },
        {
          "line": 533,
          "old_api": null,
          "new_api": "_nlmeans_init",
          "old_text": null,
          "new_text": "_nlmeans_init(&s->dsp);\n",
          "old_line_content": "",
          "new_line_content": "    ff_nlmeans_init(&s->dsp);",
          "content_same": false
        },
        {
          "line": 409,
          "old_api": null,
          "new_api": "_clip_uint8",
          "old_text": null,
          "new_text": "_clip_uint8(wa[x].sum / wa[x].total_weight + 0.5f);\n",
          "old_line_content": "        }",
          "new_line_content": "            dst[x] = av_clip_uint8(wa[x].sum / wa[x].total_weight + 0.5f);",
          "content_same": false
        },
        {
          "line": 543,
          "old_api": null,
          "new_api": "_freep",
          "old_text": null,
          "new_text": "_freep(&s->wa);\n",
          "old_line_content": "}",
          "new_line_content": "    av_freep(&s->wa);",
          "content_same": false
        },
        {
          "line": 428,
          "old_api": null,
          "new_api": "mset",
          "old_text": null,
          "new_text": "mset(s->wa, 0, s->wa_linesize * h * sizeof(*s->wa));\n",
          "old_line_content": "",
          "new_line_content": "    memset(s->wa, 0, s->wa_linesize * h * sizeof(*s->wa));",
          "content_same": false
        },
        {
          "line": 564,
          "old_api": null,
          "new_api": "LL_IF_CONFIG_SMALL",
          "old_text": null,
          "new_text": "LL_IF_CONFIG_SMALL(\"Non-local means denoiser.\"),\n",
          "old_line_content": "    .priv_size     = sizeof(NLMeansContext),",
          "new_line_content": "    .description   = NULL_IF_CONFIG_SMALL(\"Non-local means denoiser.\"),",
          "content_same": false
        },
        {
          "line": 439,
          "old_api": null,
          "new_api": "MIN",
          "old_text": null,
          "new_text": "MIN(h, h - offy),\n",
          "old_line_content": "                    .ii_start     = centered_ii + offy*s->ii_lz_32 + offx,",
          "new_line_content": "                    .endy         = FFMIN(h, h - offy),",
          "content_same": false
        },
        {
          "line": 570,
          "old_api": null,
          "new_api": "LTER_PIXFMTS_ARRAY",
          "old_text": null,
          "new_text": "LTER_PIXFMTS_ARRAY(pix_fmts),\n",
          "old_line_content": "    .priv_class    = &nlmeans_class,",
          "new_line_content": "    FILTER_PIXFMTS_ARRAY(pix_fmts),",
          "content_same": false
        },
        {
          "line": 444,
          "old_api": null,
          "new_api": "mpute_ssd_integral_image",
          "old_text": null,
          "new_text": "mpute_ssd_integral_image(&s->dsp, s->ii, s->ii_lz_32,\n                                           src, src_linesize,\n                                           offx, offy, e, w, h);\n",
          "old_line_content": "                                           src, src_linesize,",
          "new_line_content": "                compute_ssd_integral_image(&s->dsp, s->ii, s->ii_lz_32,",
          "content_same": false
        },
        {
          "line": 448,
          "old_api": null,
          "new_api": "_filter_get_nb_threads",
          "old_text": null,
          "new_text": "_filter_get_nb_threads(ctx)))",
          "old_line_content": "            }",
          "new_line_content": "                                  FFMIN(td.endy - td.starty, ff_filter_get_nb_threads(ctx)));",
          "content_same": false
        },
        {
          "line": 453,
          "old_api": null,
          "new_api": "ight_averages",
          "old_text": null,
          "new_text": "ight_averages(dst, dst_linesize, src, src_linesize,\n                    s->wa, s->wa_linesize, w, h);\n",
          "old_line_content": "                    s->wa, s->wa_linesize, w, h);",
          "new_line_content": "    weight_averages(dst, dst_linesize, src, src_linesize,",
          "content_same": false
        },
        {
          "line": 465,
          "old_api": null,
          "new_api": "_get_video_buffer",
          "old_text": null,
          "new_text": "_get_video_buffer(outlink, outlink->w, outlink->h);\n",
          "old_line_content": "    if (!out) {",
          "new_line_content": "    AVFrame *out = ff_get_video_buffer(outlink, outlink->w, outlink->h);",
          "content_same": false
        },
        {
          "line": 468,
          "old_api": null,
          "new_api": "ERROR",
          "old_text": null,
          "new_text": "ERROR(ENOMEM);\n",
          "old_line_content": "    }",
          "new_line_content": "        return AVERROR(ENOMEM);",
          "content_same": false
        },
        {
          "line": 470,
          "old_api": null,
          "new_api": "_frame_copy_props",
          "old_text": null,
          "new_text": "_frame_copy_props(out, in);\n",
          "old_line_content": "",
          "new_line_content": "    av_frame_copy_props(out, in);",
          "content_same": false
        },
        {
          "line": 477,
          "old_api": null,
          "new_api": "means_plane",
          "old_text": null,
          "new_text": "means_plane(ctx, w, h, p, r,\n                      out->data[i], out->linesize[i],\n                      in->data[i],  in->linesize[i]);\n",
          "old_line_content": "                      out->data[i], out->linesize[i],",
          "new_line_content": "        nlmeans_plane(ctx, w, h, p, r,",
          "content_same": false
        },
        {
          "line": 483,
          "old_api": null,
          "new_api": "_filter_frame",
          "old_text": null,
          "new_text": "_filter_frame(outlink, out);\n",
          "old_line_content": "}",
          "new_line_content": "    return ff_filter_frame(outlink, out);",
          "content_same": false
        },
        {
          "line": 499,
          "old_api": null,
          "new_api": "_nlmeans_init_aarch64",
          "old_text": null,
          "new_text": "_nlmeans_init_aarch64(dsp);\n",
          "old_line_content": "}",
          "new_line_content": "        ff_nlmeans_init_aarch64(dsp);",
          "content_same": false
        },
        {
          "line": 509,
          "old_api": null,
          "new_api": "_calloc",
          "old_text": null,
          "new_text": "_calloc(s->max_meaningful_diff, sizeof(*s->weight_lut));\n",
          "old_line_content": "    if (!s->weight_lut)",
          "new_line_content": "    s->weight_lut = av_calloc(s->max_meaningful_diff, sizeof(*s->weight_lut));",
          "content_same": false
        },
        {
          "line": 511,
          "old_api": null,
          "new_api": "ERROR",
          "old_text": null,
          "new_text": "ERROR(ENOMEM);\n",
          "old_line_content": "    for (int i = 0; i < s->max_meaningful_diff; i++)",
          "new_line_content": "        return AVERROR(ENOMEM);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 512,
          "old_api": "p",
          "new_api": null,
          "old_text": "p(-i * s->pdiff_scale);\n",
          "new_text": null,
          "old_line_content": "        s->weight_lut[i] = exp(-i * s->pdiff_scale);",
          "new_line_content": "    for (int i = 0; i < s->max_meaningful_diff; i++)",
          "content_same": false
        },
        {
          "line": 514,
          "old_api": "ECK_ODD_FIELD",
          "new_api": null,
          "old_text": "ECK_ODD_FIELD(research_size,   \"Luma research window\");\n",
          "new_text": null,
          "old_line_content": "    CHECK_ODD_FIELD(research_size,   \"Luma research window\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 520,
          "old_api": "ECK_ODD_FIELD",
          "new_api": null,
          "old_text": "ECK_ODD_FIELD(research_size_uv, \"Chroma research window\");\n",
          "new_text": null,
          "old_line_content": "    CHECK_ODD_FIELD(research_size_uv, \"Chroma research window\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 528,
          "old_api": "_log",
          "new_api": null,
          "old_text": "_log(ctx, AV_LOG_INFO, \"Research window: %dx%d / %dx%d, patch size: %dx%d / %dx%d\\n\",\n           s->research_size, s->research_size, s->research_size_uv, s->research_size_uv,\n           s->patch_size,    s->patch_size,    s->patch_size_uv,    s->patch_size_uv);\n",
          "new_text": null,
          "old_line_content": "    av_log(ctx, AV_LOG_INFO, \"Research window: %dx%d / %dx%d, patch size: %dx%d / %dx%d\\n\",",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 532,
          "old_api": "_nlmeans_init",
          "new_api": null,
          "old_text": "_nlmeans_init(&s->dsp);\n",
          "new_text": null,
          "old_line_content": "    ff_nlmeans_init(&s->dsp);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 408,
          "old_api": "_clip_uint8",
          "new_api": null,
          "old_text": "_clip_uint8(wa[x].sum / wa[x].total_weight + 0.5f);\n",
          "new_text": null,
          "old_line_content": "            dst[x] = av_clip_uint8(wa[x].sum / wa[x].total_weight + 0.5f);",
          "new_line_content": "            wa[x].sum += 1.f * src[x];",
          "content_same": false
        },
        {
          "line": 540,
          "old_api": "_freep",
          "new_api": null,
          "old_text": "_freep(&s->weight_lut);\n",
          "new_text": null,
          "old_line_content": "    av_freep(&s->weight_lut);",
          "new_line_content": "    NLMeansContext *s = ctx->priv;",
          "content_same": false
        },
        {
          "line": 427,
          "old_api": "mset",
          "new_api": null,
          "old_text": "mset(s->wa, 0, s->wa_linesize * h * sizeof(*s->wa));\n",
          "new_text": null,
          "old_line_content": "    memset(s->wa, 0, s->wa_linesize * h * sizeof(*s->wa));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 435,
          "old_api": "MAX",
          "new_api": null,
          "old_text": "MAX(0, -offx),\n",
          "new_text": null,
          "old_line_content": "                    .startx       = FFMAX(0, -offx),",
          "new_line_content": "                    .src_linesize = src_linesize,",
          "content_same": false
        },
        {
          "line": 563,
          "old_api": "LL_IF_CONFIG_SMALL",
          "new_api": null,
          "old_text": "LL_IF_CONFIG_SMALL(\"Non-local means denoiser.\"),\n",
          "new_text": null,
          "old_line_content": "    .description   = NULL_IF_CONFIG_SMALL(\"Non-local means denoiser.\"),",
          "new_line_content": "    .name          = \"nlmeans\",",
          "content_same": false
        },
        {
          "line": 567,
          "old_api": "LTER_INPUTS",
          "new_api": null,
          "old_text": "LTER_INPUTS(nlmeans_inputs),\n",
          "new_text": null,
          "old_line_content": "    FILTER_INPUTS(nlmeans_inputs),",
          "new_line_content": "    .uninit        = uninit,",
          "content_same": false
        },
        {
          "line": 443,
          "old_api": "mpute_ssd_integral_image",
          "new_api": null,
          "old_text": "mpute_ssd_integral_image(&s->dsp, s->ii, s->ii_lz_32,\n                                           src, src_linesize,\n                                           offx, offy, e, w, h);\n",
          "new_text": null,
          "old_line_content": "                compute_ssd_integral_image(&s->dsp, s->ii, s->ii_lz_32,",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 446,
          "old_api": "_filter_execute",
          "new_api": null,
          "old_text": "_filter_execute(ctx, nlmeans_slice, &td, NULL,\n                                  FFMIN(td.endy - td.starty, ff_filter_get_nb_threads(ctx)));\n",
          "new_text": null,
          "old_line_content": "                ff_filter_execute(ctx, nlmeans_slice, &td, NULL,",
          "new_line_content": "                                           offx, offy, e, w, h);",
          "content_same": false
        },
        {
          "line": 452,
          "old_api": "ight_averages",
          "new_api": null,
          "old_text": "ight_averages(dst, dst_linesize, src, src_linesize,\n                    s->wa, s->wa_linesize, w, h);\n",
          "new_text": null,
          "old_line_content": "    weight_averages(dst, dst_linesize, src, src_linesize,",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 464,
          "old_api": "_get_video_buffer",
          "new_api": null,
          "old_text": "_get_video_buffer(outlink, outlink->w, outlink->h);\n",
          "new_text": null,
          "old_line_content": "    AVFrame *out = ff_get_video_buffer(outlink, outlink->w, outlink->h);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 466,
          "old_api": "_frame_free",
          "new_api": null,
          "old_text": "_frame_free(&in);\n",
          "new_text": null,
          "old_line_content": "        av_frame_free(&in);",
          "new_line_content": "    if (!out) {",
          "content_same": false
        },
        {
          "line": 469,
          "old_api": "_frame_copy_props",
          "new_api": null,
          "old_text": "_frame_copy_props(out, in);\n",
          "new_text": null,
          "old_line_content": "    av_frame_copy_props(out, in);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 476,
          "old_api": "means_plane",
          "new_api": null,
          "old_text": "means_plane(ctx, w, h, p, r,\n                      out->data[i], out->linesize[i],\n                      in->data[i],  in->linesize[i]);\n",
          "new_text": null,
          "old_line_content": "        nlmeans_plane(ctx, w, h, p, r,",
          "new_line_content": "        const int r = i ? s->research_hsize_uv : s->research_hsize;",
          "content_same": false
        },
        {
          "line": 481,
          "old_api": "_frame_free",
          "new_api": null,
          "old_text": "_frame_free(&in);\n",
          "new_text": null,
          "old_line_content": "    av_frame_free(&in);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 498,
          "old_api": "_nlmeans_init_aarch64",
          "new_api": null,
          "old_text": "_nlmeans_init_aarch64(dsp);\n",
          "new_text": null,
          "old_line_content": "        ff_nlmeans_init_aarch64(dsp);",
          "new_line_content": "    if (ARCH_AARCH64)",
          "content_same": false
        },
        {
          "line": 507,
          "old_api": "g",
          "new_api": null,
          "old_text": "g(255.) /",
          "new_text": null,
          "old_line_content": "    s->max_meaningful_diff = log(255.) / s->pdiff_scale;",
          "new_line_content": "    s->pdiff_scale = 1. / (h * h);",
          "content_same": false
        },
        {
          "line": 510,
          "old_api": "ERROR",
          "new_api": null,
          "old_text": "ERROR(ENOMEM);\n",
          "new_text": null,
          "old_line_content": "        return AVERROR(ENOMEM);",
          "new_line_content": "    if (!s->weight_lut)",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 7,
      "total_additions": 22,
      "total_deletions": 22,
      "total_api_changes": 51
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 3,
        "api_related_lines": 51,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          347,
          388,
          389
        ]
      }
    },
    "api_calls_before": 75,
    "api_calls_after": 75,
    "diff_info": {
      "added_lines": 2,
      "removed_lines": 1,
      "total_diff_lines": 22
    }
  }
}