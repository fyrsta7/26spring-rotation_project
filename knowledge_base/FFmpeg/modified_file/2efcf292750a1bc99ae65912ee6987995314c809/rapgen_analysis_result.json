{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/2efcf292750a1bc99ae65912ee6987995314c809",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/2efcf292750a1bc99ae65912ee6987995314c809/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/2efcf292750a1bc99ae65912ee6987995314c809/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/FFmpeg/modified_file/2efcf292750a1bc99ae65912ee6987995314c809/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 165,
          "old_api": "FFMAX",
          "new_api": "sqrt",
          "old_text": "FFMAX(maxff, ff)",
          "new_text": "sqrt(2*ff/LEN)",
          "old_line_content": "            maxff= FFMAX(maxff, ff);",
          "new_line_content": "            ff= sqrt(2*ff/LEN);",
          "content_same": false
        },
        {
          "line": 170,
          "old_api": "av_log",
          "new_api": "FFMIN",
          "old_text": "av_log(NULL, AV_LOG_ERROR, \"i:%4d ss:%f ff:%13.6e-%13.6e sf:%13.6e-%13.6e\\n\", i, ss, maxff, minff, maxsf, minsf)",
          "new_text": "FFMIN(minsf, sf)",
          "old_line_content": "                av_log(NULL, AV_LOG_ERROR, \"i:%4d ss:%f ff:%13.6e-%13.6e sf:%13.6e-%13.6e\\n\", i, ss, maxff, minff, maxsf, minsf);",
          "new_line_content": "            minsf= FFMIN(minsf, sf);",
          "content_same": false
        },
        {
          "line": 190,
          "old_api": "av_build_filter",
          "new_api": "ceil",
          "old_text": "av_build_filter(c->filter_bank, factor, c->filter_length, phase_count, 1<<FILTER_SHIFT, WINDOW_TYPE)",
          "new_text": "ceil(filter_size/factor)",
          "old_line_content": "    av_build_filter(c->filter_bank, factor, c->filter_length, phase_count, 1<<FILTER_SHIFT, WINDOW_TYPE);",
          "new_line_content": "    c->filter_length= FFMAX((int)ceil(filter_size/factor), 1);",
          "content_same": false
        },
        {
          "line": 191,
          "old_api": "memcpy",
          "new_api": "av_mallocz",
          "old_text": "memcpy(&c->filter_bank[c->filter_length*phase_count+1], c->filter_bank, (c->filter_length-1)*sizeof(FELEM))",
          "new_text": "av_mallocz(c->filter_length*(phase_count+1)*sizeof(FELEM))",
          "old_line_content": "    memcpy(&c->filter_bank[c->filter_length*phase_count+1], c->filter_bank, (c->filter_length-1)*sizeof(FELEM));",
          "new_line_content": "    c->filter_bank= av_mallocz(c->filter_length*(phase_count+1)*sizeof(FELEM));",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 260,
          "old_api": null,
          "new_api": "lrintf",
          "old_text": null,
          "new_text": "lrintf(val)",
          "old_line_content": "        val = (val + (1<<(FILTER_SHIFT-1)))>>FILTER_SHIFT;",
          "new_line_content": "        dst[dst_index] = av_clip_int16(lrintf(val));",
          "content_same": false
        },
        {
          "line": 139,
          "old_api": null,
          "new_api": "lrintf",
          "old_text": null,
          "new_text": "lrintf(tab[i] * scale / norm)",
          "old_line_content": "        }",
          "new_line_content": "            filter[ph * tap_count + i] = av_clip(lrintf(tab[i] * scale / norm), FELEM_MIN, FELEM_MAX);",
          "content_same": false
        },
        {
          "line": 280,
          "old_api": null,
          "new_api": "FFMAX",
          "old_text": null,
          "new_text": "FFMAX(index, 0)",
          "old_line_content": "",
          "new_line_content": "    *consumed= FFMAX(index, 0) >> c->phase_shift;",
          "content_same": false
        },
        {
          "line": 153,
          "old_api": null,
          "new_api": "cos",
          "old_text": null,
          "new_text": "cos(i*j*M_PI/LEN)",
          "old_line_content": "                double sum=0;",
          "new_line_content": "                sine[j]= cos(i*j*M_PI/LEN);",
          "content_same": false
        },
        {
          "line": 285,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(compensation_distance > 0)",
          "old_line_content": "    if(update_ctx){",
          "new_line_content": "        assert(compensation_distance > 0);",
          "content_same": false
        },
        {
          "line": 164,
          "old_api": null,
          "new_api": "sqrt",
          "old_text": null,
          "new_text": "sqrt(2*ss/LEN)",
          "old_line_content": "            sf= 2*sf/LEN;",
          "new_line_content": "            ss= sqrt(2*ss/LEN);",
          "content_same": false
        },
        {
          "line": 296,
          "old_api": null,
          "new_api": "rand",
          "old_text": null,
          "new_text": "rand()",
          "old_line_content": "    }",
          "new_line_content": "        av_resample_compensate(c, rand() % (8000*2) - 8000, 8000*2);",
          "content_same": false
        },
        {
          "line": 169,
          "old_api": null,
          "new_api": "FFMAX",
          "old_text": null,
          "new_text": "FFMAX(maxsf, sf)",
          "old_line_content": "            if(i%11==0){",
          "new_line_content": "            maxsf= FFMAX(maxsf, sf);",
          "content_same": false
        },
        {
          "line": 297,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(NULL, AV_LOG_DEBUG, \"%d %d %d\\n\", c->dst_incr, c->ideal_dst_incr, c->compensation_distance)",
          "old_line_content": "#endif",
          "new_line_content": "av_log(NULL, AV_LOG_DEBUG, \"%d %d %d\\n\", c->dst_incr, c->ideal_dst_incr, c->compensation_distance);",
          "content_same": false
        },
        {
          "line": 172,
          "old_api": null,
          "new_api": "av_log",
          "old_text": null,
          "new_text": "av_log(NULL, AV_LOG_ERROR, \"i:%4d ss:%f ff:%13.6e-%13.6e sf:%13.6e-%13.6e\\n\", i, ss, maxff, minff, maxsf, minsf)",
          "old_line_content": "                maxff=maxsf= -2;",
          "new_line_content": "                av_log(NULL, AV_LOG_ERROR, \"i:%4d ss:%f ff:%13.6e-%13.6e sf:%13.6e-%13.6e\\n\", i, ss, maxff, minff, maxsf, minsf);",
          "content_same": false
        },
        {
          "line": 182,
          "old_api": null,
          "new_api": "av_mallocz",
          "old_text": null,
          "new_text": "av_mallocz(sizeof(AVResampleContext))",
          "old_line_content": "    int phase_count= 1<<phase_shift;",
          "new_line_content": "    AVResampleContext *c= av_mallocz(sizeof(AVResampleContext));",
          "content_same": false
        },
        {
          "line": 183,
          "old_api": null,
          "new_api": "FFMIN",
          "old_text": null,
          "new_text": "FFMIN(out_rate * cutoff / in_rate, 1.0)",
          "old_line_content": "",
          "new_line_content": "    double factor= FFMIN(out_rate * cutoff / in_rate, 1.0);",
          "content_same": false
        },
        {
          "line": 192,
          "old_api": null,
          "new_api": "av_build_filter",
          "old_text": null,
          "new_text": "av_build_filter(c->filter_bank, factor, c->filter_length, phase_count, 1<<FILTER_SHIFT, WINDOW_TYPE)",
          "old_line_content": "    c->filter_bank[c->filter_length*phase_count]= c->filter_bank[c->filter_length - 1];",
          "new_line_content": "    av_build_filter(c->filter_bank, factor, c->filter_length, phase_count, 1<<FILTER_SHIFT, WINDOW_TYPE);",
          "content_same": false
        },
        {
          "line": 193,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy(&c->filter_bank[c->filter_length*phase_count+1], c->filter_bank, (c->filter_length-1)*sizeof(FELEM))",
          "old_line_content": "",
          "new_line_content": "    memcpy(&c->filter_bank[c->filter_length*phase_count+1], c->filter_bank, (c->filter_length-1)*sizeof(FELEM));",
          "content_same": false
        },
        {
          "line": 204,
          "old_api": null,
          "new_api": "av_freep",
          "old_text": null,
          "new_text": "av_freep(&c->filter_bank)",
          "old_line_content": "}",
          "new_line_content": "    av_freep(&c->filter_bank);",
          "content_same": false
        },
        {
          "line": 205,
          "old_api": null,
          "new_api": "av_freep",
          "old_text": null,
          "new_text": "av_freep(&c)",
          "old_line_content": "",
          "new_line_content": "    av_freep(&c);",
          "content_same": false
        },
        {
          "line": 225,
          "old_api": null,
          "new_api": "FFMIN",
          "old_text": null,
          "new_text": "FFMIN(dst_size, (src_size-1-index) * (int64_t)c->src_incr / c->dst_incr)",
          "old_line_content": "        for(dst_index=0; dst_index < dst_size; dst_index++){",
          "new_line_content": "        dst_size= FFMIN(dst_size, (src_size-1-index) * (int64_t)c->src_incr / c->dst_incr);",
          "content_same": false
        },
        {
          "line": 112,
          "old_api": null,
          "new_api": "sin",
          "old_text": null,
          "new_text": "sin(x)",
          "old_line_content": "            case 0:{",
          "new_line_content": "            else        y = sin(x) / x;",
          "content_same": false
        },
        {
          "line": 243,
          "old_api": null,
          "new_api": "FFABS",
          "old_text": null,
          "new_text": "FFABS(sample_index + i)",
          "old_line_content": "            break;",
          "new_line_content": "                val += src[FFABS(sample_index + i) % src_size] * filter[i];",
          "content_same": false
        },
        {
          "line": 116,
          "old_api": null,
          "new_api": "fabs",
          "old_text": null,
          "new_text": "fabs(((double)(i - center) - (double)ph / phase_count) * factor)",
          "old_line_content": "                else      y=                       d*(-4 + 8*x - 5*x*x + x*x*x);",
          "new_line_content": "                x = fabs(((double)(i - center) - (double)ph / phase_count) * factor);",
          "content_same": false
        },
        {
          "line": 122,
          "old_api": null,
          "new_api": "cos",
          "old_text": null,
          "new_text": "cos(3*w)",
          "old_line_content": "            default:",
          "new_line_content": "                y *= 0.3635819 - 0.4891775 * cos(w) + 0.1365995 * cos(2*w) - 0.0106411 * cos(3*w);",
          "content_same": false
        },
        {
          "line": 126,
          "old_api": null,
          "new_api": "FFMAX",
          "old_text": null,
          "new_text": "FFMAX(1-w*w, 0)",
          "old_line_content": "            }",
          "new_line_content": "                y *= bessel(type*sqrt(FFMAX(1-w*w, 0)));",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 258,
          "old_api": "lrintf",
          "new_api": null,
          "old_text": "lrintf(val)",
          "new_text": null,
          "old_line_content": "        dst[dst_index] = av_clip_int16(lrintf(val));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 137,
          "old_api": "lrintf",
          "new_api": null,
          "old_text": "lrintf(tab[i] * scale / norm)",
          "new_text": null,
          "old_line_content": "            filter[ph * tap_count + i] = av_clip(lrintf(tab[i] * scale / norm), FELEM_MIN, FELEM_MAX);",
          "new_line_content": "            filter[ph * tap_count + i] = tab[i] / norm;",
          "content_same": false
        },
        {
          "line": 278,
          "old_api": "FFMAX",
          "new_api": null,
          "old_text": "FFMAX(index, 0)",
          "new_text": null,
          "old_line_content": "    *consumed= FFMAX(index, 0) >> c->phase_shift;",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 151,
          "old_api": "cos",
          "new_api": null,
          "old_text": "cos(i*j*M_PI/LEN)",
          "new_text": null,
          "old_line_content": "                sine[j]= cos(i*j*M_PI/LEN);",
          "new_line_content": "            double ss=0, sf=0, ff=0;",
          "content_same": false
        },
        {
          "line": 283,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(compensation_distance > 0)",
          "new_text": null,
          "old_line_content": "        assert(compensation_distance > 0);",
          "new_line_content": "    if(compensation_distance){",
          "content_same": false
        },
        {
          "line": 162,
          "old_api": "sqrt",
          "new_api": null,
          "old_text": "sqrt(2*ss/LEN)",
          "new_text": null,
          "old_line_content": "            ss= sqrt(2*ss/LEN);",
          "new_line_content": "                sf+= sine[j + center] * filtered[j];",
          "content_same": false
        },
        {
          "line": 163,
          "old_api": "sqrt",
          "new_api": null,
          "old_text": "sqrt(2*ff/LEN)",
          "new_text": null,
          "old_line_content": "            ff= sqrt(2*ff/LEN);",
          "new_line_content": "            }",
          "content_same": false
        },
        {
          "line": 166,
          "old_api": "FFMIN",
          "new_api": null,
          "old_text": "FFMIN(minff, ff)",
          "new_text": null,
          "old_line_content": "            minff= FFMIN(minff, ff);",
          "new_line_content": "            sf= 2*sf/LEN;",
          "content_same": false
        },
        {
          "line": 294,
          "old_api": "rand",
          "new_api": null,
          "old_text": "rand()",
          "new_text": null,
          "old_line_content": "        av_resample_compensate(c, rand() % (8000*2) - 8000, 8000*2);",
          "new_line_content": "    if(update_ctx && !c->compensation_distance){",
          "content_same": false
        },
        {
          "line": 295,
          "old_api": "av_log",
          "new_api": null,
          "old_text": "av_log(NULL, AV_LOG_DEBUG, \"%d %d %d\\n\", c->dst_incr, c->ideal_dst_incr, c->compensation_distance)",
          "new_text": null,
          "old_line_content": "av_log(NULL, AV_LOG_DEBUG, \"%d %d %d\\n\", c->dst_incr, c->ideal_dst_incr, c->compensation_distance);",
          "new_line_content": "#undef rand",
          "content_same": false
        },
        {
          "line": 180,
          "old_api": "av_mallocz",
          "new_api": null,
          "old_text": "av_mallocz(sizeof(AVResampleContext))",
          "new_text": null,
          "old_line_content": "    AVResampleContext *c= av_mallocz(sizeof(AVResampleContext));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 181,
          "old_api": "FFMIN",
          "new_api": null,
          "old_text": "FFMIN(out_rate * cutoff / in_rate, 1.0)",
          "new_text": null,
          "old_line_content": "    double factor= FFMIN(out_rate * cutoff / in_rate, 1.0);",
          "new_line_content": "AVResampleContext *av_resample_init(int out_rate, int in_rate, int filter_size, int phase_shift, int linear, double cutoff){",
          "content_same": false
        },
        {
          "line": 188,
          "old_api": "ceil",
          "new_api": null,
          "old_text": "ceil(filter_size/factor)",
          "new_text": null,
          "old_line_content": "    c->filter_length= FFMAX((int)ceil(filter_size/factor), 1);",
          "new_line_content": "    c->linear= linear;",
          "content_same": false
        },
        {
          "line": 189,
          "old_api": "av_mallocz",
          "new_api": null,
          "old_text": "av_mallocz(c->filter_length*(phase_count+1)*sizeof(FELEM))",
          "new_text": null,
          "old_line_content": "    c->filter_bank= av_mallocz(c->filter_length*(phase_count+1)*sizeof(FELEM));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 202,
          "old_api": "av_freep",
          "new_api": null,
          "old_text": "av_freep(&c->filter_bank)",
          "new_text": null,
          "old_line_content": "    av_freep(&c->filter_bank);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 203,
          "old_api": "av_freep",
          "new_api": null,
          "old_text": "av_freep(&c)",
          "new_text": null,
          "old_line_content": "    av_freep(&c);",
          "new_line_content": "void av_resample_close(AVResampleContext *c){",
          "content_same": false
        },
        {
          "line": 223,
          "old_api": "FFMIN",
          "new_api": null,
          "old_text": "FFMIN(dst_size, (src_size-1-index) * (int64_t)c->src_incr / c->dst_incr)",
          "new_text": null,
          "old_line_content": "        dst_size= FFMIN(dst_size, (src_size-1-index) * (int64_t)c->src_incr / c->dst_incr);",
          "new_line_content": "        int64_t index2= ((int64_t)index)<<32;",
          "content_same": false
        },
        {
          "line": 110,
          "old_api": "sin",
          "new_api": null,
          "old_text": "sin(x)",
          "new_text": null,
          "old_line_content": "            else        y = sin(x) / x;",
          "new_line_content": "            x = M_PI * ((double)(i - center) - (double)ph / phase_count) * factor;",
          "content_same": false
        },
        {
          "line": 241,
          "old_api": "FFABS",
          "new_api": null,
          "old_text": "FFABS(sample_index + i)",
          "new_text": null,
          "old_line_content": "                val += src[FFABS(sample_index + i) % src_size] * filter[i];",
          "new_line_content": "        if(sample_index < 0){",
          "content_same": false
        },
        {
          "line": 114,
          "old_api": "fabs",
          "new_api": null,
          "old_text": "fabs(((double)(i - center) - (double)ph / phase_count) * factor)",
          "new_text": null,
          "old_line_content": "                x = fabs(((double)(i - center) - (double)ph / phase_count) * factor);",
          "new_line_content": "            case 0:{",
          "content_same": false
        },
        {
          "line": 120,
          "old_api": "cos",
          "new_api": null,
          "old_text": "cos(3*w)",
          "new_text": null,
          "old_line_content": "                y *= 0.3635819 - 0.4891775 * cos(w) + 0.1365995 * cos(2*w) - 0.0106411 * cos(3*w);",
          "new_line_content": "            case 1:",
          "content_same": false
        },
        {
          "line": 124,
          "old_api": "FFMAX",
          "new_api": null,
          "old_text": "FFMAX(1-w*w, 0)",
          "new_text": null,
          "old_line_content": "                y *= bessel(type*sqrt(FFMAX(1-w*w, 0)));",
          "new_line_content": "            default:",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 4,
      "total_additions": 22,
      "total_deletions": 22,
      "total_api_changes": 48
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 4,
        "api_related_lines": 48,
        "non_api_lines": 4,
        "non_api_line_numbers": [
          83,
          84,
          85,
          79
        ]
      }
    },
    "api_calls_before": 36,
    "api_calls_after": 36,
    "diff_info": {
      "added_lines": 3,
      "removed_lines": 1,
      "total_diff_lines": 20
    }
  }
}