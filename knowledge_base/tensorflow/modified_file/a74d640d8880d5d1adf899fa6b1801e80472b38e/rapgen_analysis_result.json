{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/a74d640d8880d5d1adf899fa6b1801e80472b38e",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/a74d640d8880d5d1adf899fa6b1801e80472b38e/before.cc",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/a74d640d8880d5d1adf899fa6b1801e80472b38e/after.cc",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/a74d640d8880d5d1adf899fa6b1801e80472b38e/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 334,
          "old_api": "GetInflightTaskCount",
          "new_api": "fetch_sub",
          "old_text": "GetInflightTaskCount(true)",
          "new_text": "counter->fetch_sub(1, std::memory_order_relaxed)",
          "old_line_content": "                           \", inter inflight = \", GetInflightTaskCount(true),",
          "new_line_content": "    counter->fetch_sub(1, std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 397,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": "ParamFromEnvBoolWithDefault",
          "old_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_SUB_THREAD_POOL_END_REQUEST_PERCENTAGE\",\n            std::vector<double>({0.4, 1}))",
          "new_text": "ParamFromEnvBoolWithDefault(\n            \"TF_RUN_HANDLER_USE_SUB_THREAD_POOL\", false)",
          "old_line_content": "        sub_thread_pool_end_request_percentage_(ParamFromEnvWithDefault(",
          "new_line_content": "        use_sub_thread_pool_(ParamFromEnvBoolWithDefault(",
          "content_same": false
        },
        {
          "line": 399,
          "old_api": "std::vector<double>({0.4, 1})",
          "new_api": "ParamFromEnvWithDefault",
          "old_text": "std::vector<double>({0.4, 1})",
          "new_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_NUM_THREADS_IN_SUB_THREAD_POOL\",\n            std::vector<int>(\n                {num_blocking_threads / 2,\n                 num_blocking_threads - num_blocking_threads / 2}))",
          "old_line_content": "            std::vector<double>({0.4, 1}))) {",
          "new_line_content": "        num_threads_in_sub_thread_pool_(ParamFromEnvWithDefault(",
          "content_same": false
        },
        {
          "line": 406,
          "old_api": "VLOG",
          "new_api": "std::vector<double>({0, 0.4})",
          "old_text": "VLOG(1)",
          "new_text": "std::vector<double>({0, 0.4})",
          "old_line_content": "    VLOG(1) << \"Exiting RunHandlerThreadPool \" << name_;",
          "new_line_content": "            std::vector<double>({0, 0.4}))),",
          "content_same": false
        },
        {
          "line": 409,
          "old_api": "size",
          "new_api": "std::vector<double>({0.4, 1})",
          "old_text": "thread_data_.size()",
          "new_text": "std::vector<double>({0.4, 1})",
          "old_line_content": "    for (size_t i = 0; i < thread_data_.size(); ++i) {",
          "new_line_content": "            std::vector<double>({0.4, 1}))) {",
          "content_same": false
        },
        {
          "line": 424,
          "old_api": "size",
          "new_api": "reset",
          "old_text": "num_threads_in_sub_thread_pool_.size()",
          "new_text": "thread_data_[i].thread.reset()",
          "old_line_content": "      for (int j = 0; j < num_threads_in_sub_thread_pool_.size(); ++j) {",
          "new_line_content": "      thread_data_[i].thread.reset();",
          "content_same": false
        },
        {
          "line": 433,
          "old_api": "WorkerLoop",
          "new_api": "size",
          "old_text": "WorkerLoop(i, i < num_blocking_threads)",
          "new_text": "num_threads_in_sub_thread_pool_.size()",
          "old_line_content": "            WorkerLoop(i, i < num_blocking_threads);",
          "new_line_content": "      int sub_thread_pool_id = num_threads_in_sub_thread_pool_.size() - 1;",
          "content_same": false
        },
        {
          "line": 441,
          "old_api": "std::move(t)",
          "new_api": "reset",
          "old_text": "std::move(t)",
          "new_text": "thread_data_[i].thread.reset(\n          env_.CreateThread([this, i, num_blocking_threads]() {\n            WorkerLoop(i, i < num_blocking_threads);\n          }))",
          "old_line_content": "    t = tws->EnqueueTask(std::move(t), is_blocking);",
          "new_line_content": "      thread_data_[i].thread.reset(",
          "content_same": false
        },
        {
          "line": 443,
          "old_api": "VLOG",
          "new_api": "WorkerLoop",
          "old_text": "VLOG(3)",
          "new_text": "WorkerLoop(i, i < num_blocking_threads)",
          "old_line_content": "      VLOG(3) << \"Running \" << (is_blocking ? \"inter\" : \"intra\") << \" work for \"",
          "new_line_content": "            WorkerLoop(i, i < num_blocking_threads);",
          "content_same": false
        },
        {
          "line": 688,
          "old_api": "PopNonBlockingTask",
          "new_api": "GetInflightTaskCount",
          "old_text": "tws->PopNonBlockingTask(thread_id, true)",
          "new_text": "tws->GetInflightTaskCount(true)",
          "old_line_content": "          t = tws->PopNonBlockingTask(thread_id, true);",
          "new_line_content": "            tws->GetInflightTaskCount(true) < kMaxBlockingInflight) {",
          "content_same": false
        },
        {
          "line": 724,
          "old_api": "VLOG_IS_ON",
          "new_api": "GetTracemeId",
          "old_text": "VLOG_IS_ON(4)",
          "new_text": "tws->GetTracemeId()",
          "old_line_content": "      if (VLOG_IS_ON(4)) {",
          "new_line_content": "              << \" work from \" << tws->GetTracemeId();",
          "content_same": false
        },
        {
          "line": 726,
          "old_api": "size",
          "new_api": "ExecuteTask",
          "old_text": "thread_work_sources->size()",
          "new_text": "env_.ExecuteTask(t)",
          "old_line_content": "        for (int i = 0; i < thread_work_sources->size(); ++i) {",
          "new_line_content": "      env_.ExecuteTask(t);",
          "content_same": false
        },
        {
          "line": 727,
          "old_api": "VLOG",
          "new_api": "DecrementInflightTaskCount",
          "old_text": "VLOG(4)",
          "new_text": "tws->DecrementInflightTaskCount(task_from_blocking_queue)",
          "old_line_content": "          VLOG(4) << \"source id \" << i << \" \"",
          "new_line_content": "      tws->DecrementInflightTaskCount(task_from_blocking_queue);",
          "content_same": false
        },
        {
          "line": 734,
          "old_api": "WaitForWork",
          "new_api": "VLOG_IS_ON",
          "old_text": "WaitForWork(may_steal_blocking_work, thread_id, kMaxBlockingInflight)",
          "new_text": "VLOG_IS_ON(4)",
          "old_line_content": "        WaitForWork(may_steal_blocking_work, thread_id, kMaxBlockingInflight);",
          "new_line_content": "      if (VLOG_IS_ON(4)) {",
          "content_same": false
        },
        {
          "line": 761,
          "old_api": "SleepForMicroseconds",
          "new_api": "WaitOnWaiter",
          "old_text": "Env::Default()->SleepForMicroseconds(kMaxSleepMicros)",
          "new_text": "WaitOnWaiter(&waiter, &(*queue_waiters_)[sub_thread_pool_id],\n               &(*waiters_mu_)[sub_thread_pool_id], kMaxSleepMicros)",
          "old_line_content": "    Env::Default()->SleepForMicroseconds(kMaxSleepMicros);",
          "new_line_content": "  WaitOnWaiter(&waiter, &(*queue_waiters_)[sub_thread_pool_id],",
          "content_same": false
        },
        {
          "line": 780,
          "old_api": "GetInflightTaskCount",
          "new_api": "empty",
          "old_text": "tws->GetInflightTaskCount(true)",
          "new_text": "thread_work_sources->empty()",
          "old_line_content": "  if (tws->GetInflightTaskCount(true) >= max_blocking_inflight) {",
          "new_line_content": "    while (!cancelled_ && thread_work_sources->empty()) {",
          "content_same": false
        },
        {
          "line": 782,
          "old_api": "SleepForMicroseconds",
          "new_api": "wait",
          "old_text": "Env::Default()->SleepForMicroseconds(kMaxSleepMicros)",
          "new_text": "thread_data_[thread_id].sources_not_empty.wait(l)",
          "old_line_content": "    Env::Default()->SleepForMicroseconds(kMaxSleepMicros);",
          "new_line_content": "      thread_data_[thread_id].sources_not_empty.wait(l);",
          "content_same": false
        },
        {
          "line": 856,
          "old_api": "VLOG",
          "new_api": "ParamFromEnvWithDefault",
          "old_text": "VLOG(1)",
          "new_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)",
          "old_line_content": "    VLOG(1) << \"Creating a RunHandlerPool with max handlers: \" << max_handlers_;",
          "new_line_content": "            ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)),",
          "content_same": false
        },
        {
          "line": 858,
          "old_api": "emplace_back",
          "new_api": "Env::Default()",
          "old_text": "handlers_.emplace_back(new RunHandler::Impl(this))",
          "new_text": "Env::Default()",
          "old_line_content": "      handlers_.emplace_back(new RunHandler::Impl(this));",
          "new_line_content": "            num_inter_op_threads, num_intra_op_threads, Env::Default(),",
          "content_same": false
        },
        {
          "line": 859,
          "old_api": "back",
          "new_api": "ThreadOptions",
          "old_text": "handlers_.back().get()",
          "new_text": "ThreadOptions()",
          "old_line_content": "      free_handlers_.push_back(handlers_.back().get());",
          "new_line_content": "            ThreadOptions(), \"tf_run_handler_pool\", &waiters_mu_,",
          "content_same": false
        },
        {
          "line": 863,
          "old_api": "resize",
          "new_api": "ParamFromEnvWithDefault",
          "old_text": "waiters_mu_.resize(\n        ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2))",
          "new_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_SUB_THREAD_POOL_END_REQUEST_PERCENTAGE\",\n            std::vector<double>({1}))",
          "old_line_content": "    waiters_mu_.resize(",
          "new_line_content": "        sub_thread_pool_end_request_percentage_(ParamFromEnvWithDefault(",
          "content_same": false
        },
        {
          "line": 869,
          "old_api": "Start",
          "new_api": "back",
          "old_text": "run_handler_thread_pool_->Start()",
          "new_text": "handlers_.back().get()",
          "old_line_content": "    run_handler_thread_pool_->Start();",
          "new_line_content": "      free_handlers_.push_back(handlers_.back().get());",
          "content_same": false
        },
        {
          "line": 885,
          "old_api": "get",
          "new_api": "size",
          "old_text": "run_handler_thread_pool_.get()",
          "new_text": "handlers_.size()",
          "old_line_content": "    return run_handler_thread_pool_.get();",
          "new_line_content": "    DCHECK_EQ(handlers_.size(), max_handlers_);",
          "content_same": false
        },
        {
          "line": 920,
          "old_api": "push_back",
          "new_api": "EnvTime::NowNanos()",
          "old_text": "sorted_active_handlers_.push_back(handler_impl)",
          "new_text": "EnvTime::NowNanos()",
          "old_line_content": "      sorted_active_handlers_.push_back(handler_impl);",
          "new_line_content": "                EnvTime::NowNanos() + timeout_in_ms * 1000 * 1000)) {",
          "content_same": false
        },
        {
          "line": 926,
          "old_api": "std::unique_ptr<Eigen::MaxSizeVector<ThreadWorkSource*>>(\n              new Eigen::MaxSizeVector<ThreadWorkSource*>(num_active_requests))",
          "new_api": "back",
          "old_text": "std::unique_ptr<Eigen::MaxSizeVector<ThreadWorkSource*>>(\n              new Eigen::MaxSizeVector<ThreadWorkSource*>(num_active_requests))",
          "new_text": "free_handlers_.back()",
          "old_line_content": "          std::unique_ptr<Eigen::MaxSizeVector<ThreadWorkSource*>>(",
          "new_line_content": "      handler_impl = free_handlers_.back();",
          "content_same": false
        },
        {
          "line": 930,
          "old_api": "tws",
          "new_api": "push_back",
          "old_text": "sorted_active_handlers_[i]->tws()",
          "new_text": "sorted_active_handlers_.push_back(handler_impl)",
          "old_line_content": "        (*thread_work_sources)[i] = sorted_active_handlers_[i]->tws();",
          "new_line_content": "      sorted_active_handlers_.push_back(handler_impl);",
          "content_same": false
        },
        {
          "line": 931,
          "old_api": "SetRank",
          "new_api": "size",
          "old_text": "*thread_work_sources)[i]->SetRank(i)",
          "new_text": "sorted_active_handlers_.size()",
          "old_line_content": "        (*thread_work_sources)[i]->SetRank(i);",
          "new_line_content": "      DCHECK_LE(sorted_active_handlers_.size(), max_handlers_);",
          "content_same": false
        },
        {
          "line": 936,
          "old_api": "WrapUnique<RunHandler>(new RunHandler(handler_impl))",
          "new_api": "std::unique_ptr<Eigen::MaxSizeVector<ThreadWorkSource*>>(\n              new Eigen::MaxSizeVector<ThreadWorkSource*>(num_active_requests))",
          "old_text": "WrapUnique<RunHandler>(new RunHandler(handler_impl))",
          "new_text": "std::unique_ptr<Eigen::MaxSizeVector<ThreadWorkSource*>>(\n              new Eigen::MaxSizeVector<ThreadWorkSource*>(num_active_requests))",
          "old_line_content": "    return WrapUnique<RunHandler>(new RunHandler(handler_impl));",
          "new_line_content": "          std::unique_ptr<Eigen::MaxSizeVector<ThreadWorkSource*>>(",
          "content_same": false
        },
        {
          "line": 941,
          "old_api": "size",
          "new_api": "SetRank",
          "old_text": "sorted_active_handlers_.size()",
          "new_text": "*thread_work_sources)[i]->SetRank(i)",
          "old_line_content": "    DCHECK_GT(sorted_active_handlers_.size(), 0);",
          "new_line_content": "        (*thread_work_sources)[i]->SetRank(i);",
          "content_same": false
        },
        {
          "line": 946,
          "old_api": "tensorflow::EnvTime::NowMicros()",
          "new_api": "WrapUnique<RunHandler>(new RunHandler(handler_impl))",
          "old_text": "tensorflow::EnvTime::NowMicros()",
          "new_text": "WrapUnique<RunHandler>(new RunHandler(handler_impl))",
          "old_line_content": "    uint64 now = tensorflow::EnvTime::NowMicros();",
          "new_line_content": "    return WrapUnique<RunHandler>(new RunHandler(handler_impl));",
          "content_same": false
        },
        {
          "line": 953,
          "old_api": "end",
          "new_api": "tws",
          "old_text": "sorted_active_handlers_.end()",
          "new_text": "handler->tws()->TaskQueueSize(true)",
          "old_line_content": "                          sorted_active_handlers_.end(), handler);",
          "new_line_content": "    CHECK_EQ(handler->tws()->TaskQueueSize(true), 0);   // Crash OK.",
          "content_same": false
        },
        {
          "line": 954,
          "old_api": "end",
          "new_api": "tws",
          "old_text": "sorted_active_handlers_.end()",
          "new_text": "handler->tws()->TaskQueueSize(false)",
          "old_line_content": "    DCHECK(iter != sorted_active_handlers_.end())",
          "new_line_content": "    CHECK_EQ(handler->tws()->TaskQueueSize(false), 0);  // Crash OK.",
          "content_same": false
        },
        {
          "line": 962,
          "old_api": "size",
          "new_api": "begin",
          "old_text": "free_handlers_.size()",
          "new_text": "sorted_active_handlers_.begin()",
          "old_line_content": "    DCHECK_LE(free_handlers_.size(), max_handlers_);",
          "new_line_content": "    auto iter = std::find(sorted_active_handlers_.begin(),",
          "content_same": false
        },
        {
          "line": 963,
          "old_api": "LogInfo",
          "new_api": "end",
          "old_text": "LogInfo()",
          "new_text": "sorted_active_handlers_.end()",
          "old_line_content": "    LogInfo();",
          "new_line_content": "                          sorted_active_handlers_.end(), handler);",
          "content_same": false
        },
        {
          "line": 1021,
          "old_api": "NumThreads",
          "new_api": "size",
          "old_text": "run_handler_thread_pool()->NumThreads()",
          "new_text": "sub_thread_pool_end_request_percentage_.size()",
          "old_line_content": "  int num_threads = run_handler_thread_pool()->NumThreads();",
          "new_line_content": "            sub_thread_pool_end_request_percentage_.size() - 1 &&",
          "content_same": false
        },
        {
          "line": 1047,
          "old_api": "size",
          "new_api": "VLOG",
          "old_text": "sorted_active_handlers_.size()",
          "new_text": "VLOG(2)",
          "old_line_content": "    int num_active_requests = sorted_active_handlers_.size();",
          "new_line_content": "    VLOG(2) << \"Set work for tid=\" << (i + num_blocking_threads)",
          "content_same": false
        },
        {
          "line": 1049,
          "old_api": "VLOG",
          "new_api": "SetThreadWorkSources",
          "old_text": "VLOG(1)",
          "new_text": "run_handler_thread_pool()->SetThreadWorkSources(\n        i + num_blocking_threads, request_idx_list[i], version,\n        thread_work_sources)",
          "old_line_content": "    VLOG(1) << \"Active session runs: \" << num_active_requests;",
          "new_line_content": "    run_handler_thread_pool()->SetThreadWorkSources(",
          "content_same": false
        },
        {
          "line": 1059,
          "old_api": "start_time_us",
          "new_api": "VLOG",
          "old_text": "strings::StrCat(\n          (now - sorted_active_handlers_[i]->start_time_us()) / 1000.0, \" ms.\")",
          "new_text": "VLOG(1)",
          "old_line_content": "      times_str += strings::StrCat(",
          "new_line_content": "    VLOG(1) << \"Active session runs: \" << num_active_requests;",
          "content_same": false
        },
        {
          "line": 1060,
          "old_api": "start_time_us",
          "new_api": "NowMicros",
          "old_text": "sorted_active_handlers_[i]->start_time_us()",
          "new_text": "tensorflow::Env::Default()->NowMicros()",
          "old_line_content": "          (now - sorted_active_handlers_[i]->start_time_us()) / 1000.0, \" ms.\");",
          "new_line_content": "    uint64 now = tensorflow::Env::Default()->NowMicros();",
          "content_same": false
        },
        {
          "line": 1072,
          "old_api": "run_handler_thread_pool",
          "new_api": "tws",
          "old_text": "run_handler_impl_->pool_impl_->run_handler_thread_pool()->NumThreads()",
          "new_text": "sorted_active_handlers_[i]->tws()->GetTracemeId()",
          "old_line_content": "  return run_handler_impl_->pool_impl_->run_handler_thread_pool()->NumThreads();",
          "new_line_content": "          strings::StrCat(sorted_active_handlers_[i]->tws()->GetTracemeId());",
          "content_same": false
        },
        {
          "line": 1082,
          "old_api": "std::move(fn)",
          "new_api": "run_handler_thread_pool",
          "old_text": "std::move(fn)",
          "new_text": "run_handler_impl_->pool_impl_->run_handler_thread_pool()->NumThreads()",
          "old_line_content": "  return run_handler_impl_->ScheduleIntraOpClosure(std::move(fn));",
          "new_line_content": "  return run_handler_impl_->pool_impl_->run_handler_thread_pool()->NumThreads();",
          "content_same": false
        },
        {
          "line": 1092,
          "old_api": "GetTracemeId",
          "new_api": "std::move(fn)",
          "old_text": "tws()->GetTracemeId()",
          "new_text": "std::move(fn)",
          "old_line_content": "  VLOG(3) << \"Scheduling inter work for  \" << tws()->GetTracemeId();",
          "new_line_content": "  return run_handler_impl_->ScheduleIntraOpClosure(std::move(fn));",
          "content_same": false
        },
        {
          "line": 1098,
          "old_api": "GetTracemeId",
          "new_api": "Reset",
          "old_text": "tws()->GetTracemeId()",
          "new_text": "Reset(0)",
          "old_line_content": "  VLOG(3) << \"Scheduling intra work for \" << tws()->GetTracemeId();",
          "new_line_content": "  Reset(0);",
          "content_same": false
        },
        {
          "line": 1104,
          "old_api": "NowMicros",
          "new_api": "std::move(fn)",
          "old_text": "tensorflow::Env::Default()->NowMicros()",
          "new_text": "std::move(fn)",
          "old_line_content": "  start_time_us_ = tensorflow::Env::Default()->NowMicros();",
          "new_line_content": "                                                        std::move(fn));",
          "content_same": false
        },
        {
          "line": 1130,
          "old_api": "thread_pool_interface",
          "new_api": "Get",
          "old_text": "impl_->thread_pool_interface()",
          "new_text": "impl_->Get(step_id, timeout_in_ms)",
          "old_line_content": "  return impl_->thread_pool_interface();",
          "new_line_content": "  return impl_->Get(step_id, timeout_in_ms);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 513,
          "old_api": null,
          "new_api": "thread_local",
          "old_text": null,
          "new_text": "thread_local",
          "old_line_content": "    } else {",
          "new_line_content": "    thread_local PerThread per_thread_;",
          "content_same": false
        },
        {
          "line": 1026,
          "old_api": null,
          "new_api": "SetWaiter",
          "old_text": null,
          "new_text": "thread_work_sources[i]->SetWaiter(version,\n                                      &queue_waiters_[sub_thread_pool_id],\n                                      &waiters_mu_[sub_thread_pool_id])",
          "old_line_content": "      num_active_requests, num_blocking_threads);",
          "new_line_content": "    thread_work_sources[i]->SetWaiter(version,",
          "content_same": false
        },
        {
          "line": 1031,
          "old_api": null,
          "new_api": "NumThreads",
          "old_text": null,
          "new_text": "run_handler_thread_pool()->NumThreads()",
          "old_line_content": "        i, request_idx_list[i], version, thread_work_sources);",
          "new_line_content": "  int num_threads = run_handler_thread_pool()->NumThreads();",
          "content_same": false
        },
        {
          "line": 520,
          "old_api": null,
          "new_api": "GetPerThread",
          "old_text": null,
          "new_text": "const_cast<RunHandlerThreadPool*>(this)->GetPerThread()",
          "old_line_content": "  int NumBlockingThreads() const { return num_blocking_threads_; }",
          "new_line_content": "        const_cast<RunHandlerThreadPool*>(this)->GetPerThread();",
          "content_same": false
        },
        {
          "line": 1032,
          "old_api": null,
          "new_api": "NumBlockingThreads",
          "old_text": null,
          "new_text": "run_handler_thread_pool()->NumBlockingThreads()",
          "old_line_content": "  }",
          "new_line_content": "  int num_blocking_threads = run_handler_thread_pool()->NumBlockingThreads();",
          "content_same": false
        },
        {
          "line": 1035,
          "old_api": null,
          "new_api": "ChooseRequestsWithExponentialDistribution",
          "old_text": null,
          "new_text": "ChooseRequestsWithExponentialDistribution(\n      num_active_requests, num_blocking_threads)",
          "old_line_content": "      num_active_requests, num_non_blocking_threads);",
          "new_line_content": "  std::vector<int> request_idx_list = ChooseRequestsWithExponentialDistribution(",
          "content_same": false
        },
        {
          "line": 1038,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(2)",
          "old_line_content": "            << \" with start_request_idx=\" << request_idx_list[i];",
          "new_line_content": "    VLOG(2) << \"Set work for tid=\" << i",
          "content_same": false
        },
        {
          "line": 1040,
          "old_api": null,
          "new_api": "SetThreadWorkSources",
          "old_text": null,
          "new_text": "run_handler_thread_pool()->SetThreadWorkSources(\n        i, request_idx_list[i], version, thread_work_sources)",
          "old_line_content": "        i + num_blocking_threads, request_idx_list[i], version,",
          "new_line_content": "    run_handler_thread_pool()->SetThreadWorkSources(",
          "content_same": false
        },
        {
          "line": 1044,
          "old_api": null,
          "new_api": "ChooseRequestsWithExponentialDistribution",
          "old_text": null,
          "new_text": "ChooseRequestsWithExponentialDistribution(\n      num_active_requests, num_non_blocking_threads)",
          "old_line_content": "",
          "new_line_content": "  request_idx_list = ChooseRequestsWithExponentialDistribution(",
          "content_same": false
        },
        {
          "line": 1056,
          "old_api": null,
          "new_api": "VLOG_IS_ON",
          "old_text": null,
          "new_text": "VLOG_IS_ON(1)",
          "old_line_content": "        ids_str += \" \";",
          "new_line_content": "  if (iterations_++ % 50000 == 10 && VLOG_IS_ON(1)) {",
          "content_same": false
        },
        {
          "line": 1057,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "sorted_active_handlers_.size()",
          "old_line_content": "      }",
          "new_line_content": "    int num_active_requests = sorted_active_handlers_.size();",
          "content_same": false
        },
        {
          "line": 1058,
          "old_api": null,
          "new_api": "ToString",
          "old_text": null,
          "new_text": "time_hist_.ToString()",
          "old_line_content": "",
          "new_line_content": "    VLOG(1) << \"Printing time histogram: \" << time_hist_.ToString();",
          "content_same": false
        },
        {
          "line": 1069,
          "old_api": null,
          "new_api": "start_time_us",
          "old_text": null,
          "new_text": "strings::StrCat(\n          (now - sorted_active_handlers_[i]->start_time_us()) / 1000.0, \" ms.\")",
          "old_line_content": "// It is important to return a value such as:",
          "new_line_content": "      times_str += strings::StrCat(",
          "content_same": false
        },
        {
          "line": 1070,
          "old_api": null,
          "new_api": "start_time_us",
          "old_text": null,
          "new_text": "sorted_active_handlers_[i]->start_time_us()",
          "old_line_content": "// CurrentThreadId() in [0, NumThreads)",
          "new_line_content": "          (now - sorted_active_handlers_[i]->start_time_us()) / 1000.0, \" ms.\");",
          "content_same": false
        },
        {
          "line": 1074,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(1)",
          "old_line_content": "",
          "new_line_content": "    VLOG(1) << \"Elapsed times are: \" << times_str;",
          "content_same": false
        },
        {
          "line": 1075,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(1)",
          "old_line_content": "int RunHandler::Impl::ThreadPoolInterfaceWrapper::CurrentThreadId() const {",
          "new_line_content": "    VLOG(1) << \"Step ids are: \" << ids_str;",
          "content_same": false
        },
        {
          "line": 1086,
          "old_api": null,
          "new_api": "run_handler_thread_pool",
          "old_text": null,
          "new_text": "run_handler_impl_->pool_impl_->run_handler_thread_pool()\n      ->CurrentThreadId()",
          "old_line_content": "    : pool_impl_(pool_impl) {",
          "new_line_content": "  return run_handler_impl_->pool_impl_->run_handler_thread_pool()",
          "content_same": false
        },
        {
          "line": 1097,
          "old_api": null,
          "new_api": "reset",
          "old_text": null,
          "new_text": "thread_pool_interface_.reset(new ThreadPoolInterfaceWrapper(this))",
          "old_line_content": "void RunHandler::Impl::ScheduleIntraOpClosure(std::function<void()> fn) {",
          "new_line_content": "  thread_pool_interface_.reset(new ThreadPoolInterfaceWrapper(this));",
          "content_same": false
        },
        {
          "line": 1102,
          "old_api": null,
          "new_api": "GetTracemeId",
          "old_text": null,
          "new_text": "tws()->GetTracemeId()",
          "old_line_content": "",
          "new_line_content": "  VLOG(3) << \"Scheduling inter work for  \" << tws()->GetTracemeId();",
          "content_same": false
        },
        {
          "line": 1103,
          "old_api": null,
          "new_api": "tws",
          "old_text": null,
          "new_text": "tws()",
          "old_line_content": "void RunHandler::Impl::Reset(int64 step_id) {",
          "new_line_content": "  pool_impl_->run_handler_thread_pool()->AddWorkToQueue(tws(), true,",
          "content_same": false
        },
        {
          "line": 1108,
          "old_api": null,
          "new_api": "GetTracemeId",
          "old_text": null,
          "new_text": "tws()->GetTracemeId()",
          "old_line_content": "",
          "new_line_content": "  VLOG(3) << \"Scheduling intra work for \" << tws()->GetTracemeId();",
          "content_same": false
        },
        {
          "line": 1109,
          "old_api": null,
          "new_api": "tws",
          "old_text": null,
          "new_text": "tws()",
          "old_line_content": "RunHandlerPool::RunHandlerPool(int num_inter_op_threads)",
          "new_line_content": "  pool_impl_->run_handler_thread_pool()->AddWorkToQueue(tws(), false,",
          "content_same": false
        },
        {
          "line": 1110,
          "old_api": null,
          "new_api": "std::move(fn)",
          "old_text": null,
          "new_text": "std::move(fn)",
          "old_line_content": "    : impl_(new Impl(num_inter_op_threads, 0)) {}",
          "new_line_content": "                                                        std::move(fn));",
          "content_same": false
        },
        {
          "line": 1114,
          "old_api": null,
          "new_api": "NowMicros",
          "old_text": null,
          "new_text": "tensorflow::Env::Default()->NowMicros()",
          "old_line_content": "    : impl_(new Impl(num_inter_op_threads, num_intra_op_threads)) {}",
          "new_line_content": "  start_time_us_ = tensorflow::Env::Default()->NowMicros();",
          "content_same": false
        },
        {
          "line": 1116,
          "old_api": null,
          "new_api": "SetTracemeId",
          "old_text": null,
          "new_text": "tws_.SetTracemeId(step_id)",
          "old_line_content": "RunHandlerPool::~RunHandlerPool() {}",
          "new_line_content": "  tws_.SetTracemeId(step_id);",
          "content_same": false
        },
        {
          "line": 609,
          "old_api": null,
          "new_api": "GetInflightTaskCount",
          "old_text": null,
          "new_text": "*tws)->GetInflightTaskCount(true)",
          "old_line_content": "    if (t.f) {",
          "new_line_content": "        (*tws)->GetInflightTaskCount(true) < max_blocking_inflight) {",
          "content_same": false
        },
        {
          "line": 610,
          "old_api": null,
          "new_api": "PopBlockingTask",
          "old_text": null,
          "new_text": "*tws)->PopBlockingTask()",
          "old_line_content": "      break;",
          "new_line_content": "      t = (*tws)->PopBlockingTask();",
          "content_same": false
        },
        {
          "line": 618,
          "old_api": null,
          "new_api": "PopNonBlockingTask",
          "old_text": null,
          "new_text": "*tws)->PopNonBlockingTask(thread_id, true)",
          "old_line_content": "void RunHandlerThreadPool::WorkerLoop(int thread_id,",
          "new_line_content": "    t = (*tws)->PopNonBlockingTask(thread_id, true);",
          "content_same": false
        },
        {
          "line": 1136,
          "old_api": null,
          "new_api": "std::move(fn)",
          "old_text": null,
          "new_text": "std::move(fn)",
          "old_line_content": "",
          "new_line_content": "  impl_->ScheduleInterOpClosure(std::move(fn));",
          "content_same": false
        },
        {
          "line": 1140,
          "old_api": null,
          "new_api": "thread_pool_interface",
          "old_text": null,
          "new_text": "impl_->thread_pool_interface()",
          "old_line_content": "",
          "new_line_content": "  return impl_->thread_pool_interface();",
          "content_same": false
        },
        {
          "line": 630,
          "old_api": null,
          "new_api": "GetPerThread",
          "old_text": null,
          "new_text": "GetPerThread()",
          "old_line_content": "        &thread_data_[thread_id].thread_work_sources;",
          "new_line_content": "  PerThread* pt = GetPerThread();",
          "content_same": false
        },
        {
          "line": 1143,
          "old_api": null,
          "new_api": "pool_impl",
          "old_text": null,
          "new_text": "impl_->pool_impl()->ReleaseHandler(impl_)",
          "old_line_content": "",
          "new_line_content": "RunHandler::~RunHandler() { impl_->pool_impl()->ReleaseHandler(impl_); }",
          "content_same": false
        },
        {
          "line": 633,
          "old_api": null,
          "new_api": "constexpr",
          "old_text": null,
          "new_text": "constexpr",
          "old_line_content": "      // The mutex is not hot since its per thread and can only be held",
          "new_line_content": "  static constexpr int32 kMaxBlockingInflight = 10;",
          "content_same": false
        },
        {
          "line": 647,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "thread_work_sources->size()",
          "old_line_content": "            /*may_steal_blocking_work=*/true, *thread_work_sources,",
          "new_line_content": "      int active_requests = thread_work_sources->size();",
          "content_same": false
        },
        {
          "line": 651,
          "old_api": null,
          "new_api": "FindTask",
          "old_text": null,
          "new_text": "FindTask(\n            active_requests *\n                sub_thread_pool_start_request_percentage_[sub_thread_pool_id],\n            active_requests *\n                sub_thread_pool_end_request_percentage_[sub_thread_pool_id],\n            thread_id, sub_thread_pool_id, kMaxBlockingInflight,\n            /*may_steal_blocking_work=*/true, *thread_work_sources,\n            &task_from_blocking_queue, &tws)",
          "old_line_content": "          // requests that belong to its own sub thread pool.",
          "new_line_content": "        t = FindTask(",
          "content_same": false
        },
        {
          "line": 662,
          "old_api": null,
          "new_api": "FindTask",
          "old_text": null,
          "new_text": "FindTask(0, active_requests, thread_id, sub_thread_pool_id,\n                       kMaxBlockingInflight,\n                       /*may_steal_blocking_work=*/true, *thread_work_sources,\n                       &task_from_blocking_queue, &tws)",
          "old_line_content": "                     /*may_steal_blocking_work=*/false, *thread_work_sources,",
          "new_line_content": "          t = FindTask(0, active_requests, thread_id, sub_thread_pool_id,",
          "content_same": false
        },
        {
          "line": 670,
          "old_api": null,
          "new_api": "FindTask",
          "old_text": null,
          "new_text": "FindTask(0, active_requests, thread_id, sub_thread_pool_id,\n                     kMaxBlockingInflight,\n                     /*may_steal_blocking_work=*/false, *thread_work_sources,\n                     &task_from_blocking_queue, &tws)",
          "old_line_content": "      // TODO(chaox): Refactor the following code to share the logic with",
          "new_line_content": "        t = FindTask(0, active_requests, thread_id, sub_thread_pool_id,",
          "content_same": false
        },
        {
          "line": 682,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "thread_work_sources->size()",
          "old_line_content": "          }",
          "new_line_content": "      for (int i = 0; i < thread_work_sources->size(); ++i) {",
          "content_same": false
        },
        {
          "line": 689,
          "old_api": null,
          "new_api": "PopBlockingTask",
          "old_text": null,
          "new_text": "tws->PopBlockingTask()",
          "old_line_content": "          if (t.f) {",
          "new_line_content": "          t = tws->PopBlockingTask();",
          "content_same": false
        },
        {
          "line": 698,
          "old_api": null,
          "new_api": "PopNonBlockingTask",
          "old_text": null,
          "new_text": "tws->PopNonBlockingTask(thread_id, true)",
          "old_line_content": "          if (t.f) {",
          "new_line_content": "          t = tws->PopNonBlockingTask(thread_id, true);",
          "content_same": false
        },
        {
          "line": 707,
          "old_api": null,
          "new_api": "PopNonBlockingTask",
          "old_text": null,
          "new_text": "tws->PopNonBlockingTask(thread_id, false)",
          "old_line_content": "          [=] {",
          "new_line_content": "          t = tws->PopNonBlockingTask(thread_id, false);",
          "content_same": false
        },
        {
          "line": 718,
          "old_api": null,
          "new_api": "GetTracemeId",
          "old_text": null,
          "new_text": "strings::StrCat(task_from_blocking_queue ? \"inter\" : \"intra\",\n                                   \" #id = \", tws->GetTracemeId(), \" \",\n                                   thread_id, \"#\")",
          "old_line_content": "    } else {",
          "new_line_content": "            return strings::StrCat(task_from_blocking_queue ? \"inter\" : \"intra\",",
          "content_same": false
        },
        {
          "line": 719,
          "old_api": null,
          "new_api": "GetTracemeId",
          "old_text": null,
          "new_text": "tws->GetTracemeId()",
          "old_line_content": "      profiler::TraceMe activity(",
          "new_line_content": "                                   \" #id = \", tws->GetTracemeId(), \" \",",
          "content_same": false
        },
        {
          "line": 723,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(2)",
          "old_line_content": "          profiler::TraceMeLevel::kInfo);",
          "new_line_content": "      VLOG(2) << \"Running \" << (task_from_blocking_queue ? \"inter\" : \"intra\")",
          "content_same": false
        },
        {
          "line": 725,
          "old_api": null,
          "new_api": "IncrementInflightTaskCount",
          "old_text": null,
          "new_text": "tws->IncrementInflightTaskCount(task_from_blocking_queue)",
          "old_line_content": "        mutex_lock l(thread_data_[thread_id].mu);",
          "new_line_content": "      tws->IncrementInflightTaskCount(task_from_blocking_queue);",
          "content_same": false
        },
        {
          "line": 731,
          "old_api": null,
          "new_api": "strings::StrCat(\"Sleeping#thread_id=\", thread_id, \"#\")",
          "old_text": null,
          "new_text": "strings::StrCat(\"Sleeping#thread_id=\", thread_id, \"#\")",
          "old_line_content": "      if (use_sub_thread_pool_) {",
          "new_line_content": "            return strings::StrCat(\"Sleeping#thread_id=\", thread_id, \"#\");",
          "content_same": false
        },
        {
          "line": 736,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "thread_work_sources->size()",
          "old_line_content": "    }",
          "new_line_content": "        for (int i = 0; i < thread_work_sources->size(); ++i) {",
          "content_same": false
        },
        {
          "line": 737,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(4)",
          "old_line_content": "  }",
          "new_line_content": "          VLOG(4) << \"source id \" << i << \" \"",
          "content_same": false
        },
        {
          "line": 738,
          "old_api": null,
          "new_api": "ToString",
          "old_text": null,
          "new_text": "*thread_work_sources)[i]->ToString()",
          "old_line_content": "}",
          "new_line_content": "                  << (*thread_work_sources)[i]->ToString();",
          "content_same": false
        },
        {
          "line": 742,
          "old_api": null,
          "new_api": "WaitForWorkInSubThreadPool",
          "old_text": null,
          "new_text": "WaitForWorkInSubThreadPool(may_steal_blocking_work, sub_thread_pool_id)",
          "old_line_content": "  const int kMaxSleepMicros = 250;",
          "new_line_content": "        WaitForWorkInSubThreadPool(may_steal_blocking_work, sub_thread_pool_id);",
          "content_same": false
        },
        {
          "line": 744,
          "old_api": null,
          "new_api": "WaitForWork",
          "old_text": null,
          "new_text": "WaitForWork(may_steal_blocking_work, thread_id, kMaxBlockingInflight)",
          "old_line_content": "  // The non-blocking thread will just sleep.",
          "new_line_content": "        WaitForWork(may_steal_blocking_work, thread_id, kMaxBlockingInflight);",
          "content_same": false
        },
        {
          "line": 756,
          "old_api": null,
          "new_api": "SleepForMicroseconds",
          "old_text": null,
          "new_text": "Env::Default()->SleepForMicroseconds(kMaxSleepMicros)",
          "old_line_content": "                                       int32 max_blocking_inflight) {",
          "new_line_content": "    Env::Default()->SleepForMicroseconds(kMaxSleepMicros);",
          "content_same": false
        },
        {
          "line": 760,
          "old_api": null,
          "new_api": "thread_local",
          "old_text": null,
          "new_text": "thread_local",
          "old_line_content": "  if (!is_blocking) {",
          "new_line_content": "  thread_local Waiter waiter;",
          "content_same": false
        },
        {
          "line": 771,
          "old_api": null,
          "new_api": "SleepForMicroseconds",
          "old_text": null,
          "new_text": "Env::Default()->SleepForMicroseconds(kMaxSleepMicros)",
          "old_line_content": "      // Wait until there is new request",
          "new_line_content": "    Env::Default()->SleepForMicroseconds(kMaxSleepMicros);",
          "content_same": false
        },
        {
          "line": 790,
          "old_api": null,
          "new_api": "GetInflightTaskCount",
          "old_text": null,
          "new_text": "tws->GetInflightTaskCount(true)",
          "old_line_content": "// Externally visible RunHandler class simply forwards the work to this one.",
          "new_line_content": "  if (tws->GetInflightTaskCount(true) >= max_blocking_inflight) {",
          "content_same": false
        },
        {
          "line": 792,
          "old_api": null,
          "new_api": "SleepForMicroseconds",
          "old_text": null,
          "new_text": "Env::Default()->SleepForMicroseconds(kMaxSleepMicros)",
          "old_line_content": " public:",
          "new_line_content": "    Env::Default()->SleepForMicroseconds(kMaxSleepMicros);",
          "content_same": false
        },
        {
          "line": 794,
          "old_api": null,
          "new_api": "WaitForWork",
          "old_text": null,
          "new_text": "tws->WaitForWork(kMaxSleepMicros)",
          "old_line_content": "",
          "new_line_content": "  tws->WaitForWork(kMaxSleepMicros);",
          "content_same": false
        },
        {
          "line": 803,
          "old_api": null,
          "new_api": "explicit",
          "old_text": null,
          "new_text": "explicit",
          "old_line_content": "  uint64 start_time_us() const { return start_time_us_; }",
          "new_line_content": "  explicit Impl(RunHandlerPool::Impl* pool_impl);",
          "content_same": false
        },
        {
          "line": 808,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "thread_pool_interface_.get()",
          "old_line_content": "  void Reset(int64 step_id);",
          "new_line_content": "    return thread_pool_interface_.get();",
          "content_same": false
        },
        {
          "line": 322,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "counter->load(std::memory_order_relaxed)",
          "old_line_content": "    std::atomic<int64>* counter =",
          "new_line_content": "    return counter->load(std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 328,
          "old_api": null,
          "new_api": "fetch_add",
          "old_text": null,
          "new_text": "counter->fetch_add(1, std::memory_order_relaxed)",
          "old_line_content": "    return non_blocking_work_sharding_factor_;",
          "new_line_content": "    counter->fetch_add(1, std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 850,
          "old_api": null,
          "new_api": "explicit",
          "old_text": null,
          "new_text": "explicit",
          "old_line_content": "            &queue_waiters_)),",
          "new_line_content": "  explicit Impl(int num_inter_op_threads, int num_intra_op_threads)",
          "content_same": false
        },
        {
          "line": 851,
          "old_api": null,
          "new_api": "ParamFromEnvWithDefault",
          "old_text": null,
          "new_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_MAX_CONCURRENT_HANDLERS\", kMaxConcurrentHandlers)",
          "old_line_content": "        iterations_(0),",
          "new_line_content": "      : max_handlers_(static_cast<int32>(ParamFromEnvWithDefault(",
          "content_same": false
        },
        {
          "line": 854,
          "old_api": null,
          "new_api": "ParamFromEnvWithDefault",
          "old_text": null,
          "new_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)",
          "old_line_content": "            \"TF_RUN_HANDLER_SUB_THREAD_POOL_END_REQUEST_PERCENTAGE\",",
          "new_line_content": "            ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)),",
          "content_same": false
        },
        {
          "line": 342,
          "old_api": null,
          "new_api": "GetTracemeId",
          "old_text": null,
          "new_text": "GetTracemeId()",
          "old_line_content": "    char pad[128];",
          "new_line_content": "    return strings::StrCat(\"traceme_id = \", GetTracemeId(),",
          "content_same": false
        },
        {
          "line": 343,
          "old_api": null,
          "new_api": "TaskQueueSize",
          "old_text": null,
          "new_text": "TaskQueueSize(true)",
          "old_line_content": "    Queue queue;",
          "new_line_content": "                           \", inter queue size = \", TaskQueueSize(true),",
          "content_same": false
        },
        {
          "line": 344,
          "old_api": null,
          "new_api": "GetInflightTaskCount",
          "old_text": null,
          "new_text": "GetInflightTaskCount(true)",
          "old_line_content": "  };",
          "new_line_content": "                           \", inter inflight = \", GetInflightTaskCount(true),",
          "content_same": false
        },
        {
          "line": 346,
          "old_api": null,
          "new_api": "GetInflightTaskCount",
          "old_text": null,
          "new_text": "GetInflightTaskCount(false)",
          "old_line_content": "  int32 non_blocking_work_sharding_factor_;",
          "new_line_content": "                           \", intra inflight = \", GetInflightTaskCount(false));",
          "content_same": false
        },
        {
          "line": 345,
          "old_api": null,
          "new_api": "TaskQueueSize",
          "old_text": null,
          "new_text": "TaskQueueSize(false)",
          "old_line_content": "",
          "new_line_content": "                           \", intra queue size = \", TaskQueueSize(false),",
          "content_same": false
        },
        {
          "line": 865,
          "old_api": null,
          "new_api": "std::vector<double>({1})",
          "old_text": null,
          "new_text": "std::vector<double>({1})",
          "old_line_content": "    for (auto& queue_waiter : queue_waiters_) {",
          "new_line_content": "            std::vector<double>({1}))) {",
          "content_same": false
        },
        {
          "line": 866,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(1)",
          "old_line_content": "      queue_waiter.next = &queue_waiter;",
          "new_line_content": "    VLOG(1) << \"Creating a RunHandlerPool with max handlers: \" << max_handlers_;",
          "content_same": false
        },
        {
          "line": 868,
          "old_api": null,
          "new_api": "emplace_back",
          "old_text": null,
          "new_text": "handlers_.emplace_back(new RunHandler::Impl(this))",
          "old_line_content": "    }",
          "new_line_content": "      handlers_.emplace_back(new RunHandler::Impl(this));",
          "content_same": false
        },
        {
          "line": 871,
          "old_api": null,
          "new_api": "resize",
          "old_text": null,
          "new_text": "queue_waiters_.resize(\n        ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2))",
          "old_line_content": "",
          "new_line_content": "    queue_waiters_.resize(",
          "content_same": false
        },
        {
          "line": 872,
          "old_api": null,
          "new_api": "ParamFromEnvWithDefault",
          "old_text": null,
          "new_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)",
          "old_line_content": "  ~Impl() {",
          "new_line_content": "        ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2));",
          "content_same": false
        },
        {
          "line": 873,
          "old_api": null,
          "new_api": "resize",
          "old_text": null,
          "new_text": "waiters_mu_.resize(\n        ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2))",
          "old_line_content": "    // Sanity check that all handlers have been returned back to the pool before",
          "new_line_content": "    waiters_mu_.resize(",
          "content_same": false
        },
        {
          "line": 874,
          "old_api": null,
          "new_api": "ParamFromEnvWithDefault",
          "old_text": null,
          "new_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)",
          "old_line_content": "    // destruction.",
          "new_line_content": "        ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2));",
          "content_same": false
        },
        {
          "line": 879,
          "old_api": null,
          "new_api": "Start",
          "old_text": null,
          "new_text": "run_handler_thread_pool_->Start()",
          "old_line_content": "    // pointers. Otherwise a thread may try to access a pointer after the",
          "new_line_content": "    run_handler_thread_pool_->Start();",
          "content_same": false
        },
        {
          "line": 886,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "handlers_.size()",
          "old_line_content": "  }",
          "new_line_content": "    DCHECK_EQ(free_handlers_.size(), handlers_.size());",
          "content_same": false
        },
        {
          "line": 887,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "sorted_active_handlers_.size()",
          "old_line_content": "",
          "new_line_content": "    DCHECK_EQ(sorted_active_handlers_.size(), 0);",
          "content_same": false
        },
        {
          "line": 891,
          "old_api": null,
          "new_api": "reset",
          "old_text": null,
          "new_text": "run_handler_thread_pool_.reset()",
          "old_line_content": "",
          "new_line_content": "    run_handler_thread_pool_.reset();",
          "content_same": false
        },
        {
          "line": 895,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "run_handler_thread_pool_.get()",
          "old_line_content": "        thread_work_sources;",
          "new_line_content": "    return run_handler_thread_pool_.get();",
          "content_same": false
        },
        {
          "line": 899,
          "old_api": null,
          "new_api": "empty",
          "old_text": null,
          "new_text": "free_handlers_.empty()",
          "old_line_content": "    {",
          "new_line_content": "    return !free_handlers_.empty();",
          "content_same": false
        },
        {
          "line": 911,
          "old_api": null,
          "new_api": "empty",
          "old_text": null,
          "new_text": "free_handlers_.empty()",
          "old_line_content": "          return nullptr;",
          "new_line_content": "      if (free_handlers_.empty()) {",
          "content_same": false
        },
        {
          "line": 401,
          "old_api": null,
          "new_api": "std::vector<int>(\n                {num_blocking_threads / 2,\n                 num_blocking_threads - num_blocking_threads / 2})",
          "old_text": null,
          "new_text": "std::vector<int>(\n                {num_blocking_threads / 2,\n                 num_blocking_threads - num_blocking_threads / 2})",
          "old_line_content": "            << num_blocking_threads_ << \" blocking threads and \"",
          "new_line_content": "            std::vector<int>(",
          "content_same": false
        },
        {
          "line": 914,
          "old_api": null,
          "new_api": "strings::StrCat(\"WaitingForHandler#step_id=\", step_id,\n                                     \"#\")",
          "old_text": null,
          "new_text": "strings::StrCat(\"WaitingForHandler#step_id=\", step_id,\n                                     \"#\")",
          "old_line_content": "      // Remove the last entry from free_handlers_ and add to the end of",
          "new_line_content": "              return strings::StrCat(\"WaitingForHandler#step_id=\", step_id,",
          "content_same": false
        },
        {
          "line": 404,
          "old_api": null,
          "new_api": "ParamFromEnvWithDefault",
          "old_text": null,
          "new_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_SUB_THREAD_POOL_START_REQUEST_PERCENTAGE\",\n            std::vector<double>({0, 0.4}))",
          "old_line_content": "",
          "new_line_content": "        sub_thread_pool_start_request_percentage_(ParamFromEnvWithDefault(",
          "content_same": false
        },
        {
          "line": 918,
          "old_api": null,
          "new_api": "AwaitWithDeadline",
          "old_text": null,
          "new_text": "mu_.AwaitWithDeadline(\n                Condition(this, &Impl::has_free_handler),\n                EnvTime::NowNanos() + timeout_in_ms * 1000 * 1000)",
          "old_line_content": "      // Sortedness isn't violated if we simply add at the end of the list,",
          "new_line_content": "        if (!mu_.AwaitWithDeadline(",
          "content_same": false
        },
        {
          "line": 407,
          "old_api": null,
          "new_api": "ParamFromEnvWithDefault",
          "old_text": null,
          "new_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_SUB_THREAD_POOL_END_REQUEST_PERCENTAGE\",\n            std::vector<double>({0.4, 1}))",
          "old_line_content": "",
          "new_line_content": "        sub_thread_pool_end_request_percentage_(ParamFromEnvWithDefault(",
          "content_same": false
        },
        {
          "line": 919,
          "old_api": null,
          "new_api": "Condition",
          "old_text": null,
          "new_text": "Condition(this, &Impl::has_free_handler)",
          "old_line_content": "      // since handlers are expected to be obtained in increasing order of time.",
          "new_line_content": "                Condition(this, &Impl::has_free_handler),",
          "content_same": false
        },
        {
          "line": 410,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(1)",
          "old_line_content": "      {",
          "new_line_content": "    VLOG(1) << \"Creating RunHandlerThreadPool \" << name << \" with  \"",
          "content_same": false
        },
        {
          "line": 927,
          "old_api": null,
          "new_api": "Reset",
          "old_text": null,
          "new_text": "handler_impl->Reset(step_id)",
          "old_line_content": "              new Eigen::MaxSizeVector<ThreadWorkSource*>(num_active_requests));",
          "new_line_content": "      handler_impl->Reset(step_id);",
          "content_same": false
        },
        {
          "line": 416,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(1)",
          "old_line_content": "  }",
          "new_line_content": "    VLOG(1) << \"Exiting RunHandlerThreadPool \" << name_;",
          "content_same": false
        },
        {
          "line": 419,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "thread_data_.size()",
          "old_line_content": "    cancelled_ = false;",
          "new_line_content": "    for (size_t i = 0; i < thread_data_.size(); ++i) {",
          "content_same": false
        },
        {
          "line": 932,
          "old_api": null,
          "new_api": "pop_back",
          "old_text": null,
          "new_text": "free_handlers_.pop_back()",
          "old_line_content": "      }",
          "new_line_content": "      free_handlers_.pop_back();",
          "content_same": false
        },
        {
          "line": 422,
          "old_api": null,
          "new_api": "notify_all",
          "old_text": null,
          "new_text": "thread_data_[i].sources_not_empty.notify_all()",
          "old_line_content": "    for (int i = 0; i < num_threads_; i++) {",
          "new_line_content": "        thread_data_[i].sources_not_empty.notify_all();",
          "content_same": false
        },
        {
          "line": 934,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "sorted_active_handlers_.size()",
          "old_line_content": "    }",
          "new_line_content": "      num_active_requests = sorted_active_handlers_.size();",
          "content_same": false
        },
        {
          "line": 938,
          "old_api": null,
          "new_api": "resize",
          "old_text": null,
          "new_text": "thread_work_sources->resize(num_active_requests)",
          "old_line_content": "",
          "new_line_content": "      thread_work_sources->resize(num_active_requests);",
          "content_same": false
        },
        {
          "line": 940,
          "old_api": null,
          "new_api": "tws",
          "old_text": null,
          "new_text": "sorted_active_handlers_[i]->tws()",
          "old_line_content": "    mutex_lock l(mu_);",
          "new_line_content": "        (*thread_work_sources)[i] = sorted_active_handlers_[i]->tws();",
          "content_same": false
        },
        {
          "line": 430,
          "old_api": null,
          "new_api": "resize",
          "old_text": null,
          "new_text": "thread_data_.resize(num_threads_)",
          "old_line_content": "      thread_data_[i].sub_thread_pool_id = sub_thread_pool_id;",
          "new_line_content": "    thread_data_.resize(num_threads_);",
          "content_same": false
        },
        {
          "line": 945,
          "old_api": null,
          "new_api": "RecomputePoolStats",
          "old_text": null,
          "new_text": "RecomputePoolStats(num_active_requests, version, *thread_work_sources)",
          "old_line_content": "",
          "new_line_content": "    RecomputePoolStats(num_active_requests, version, *thread_work_sources);",
          "content_same": false
        },
        {
          "line": 434,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "num_threads_in_sub_thread_pool_.size()",
          "old_line_content": "          }));",
          "new_line_content": "      for (int j = 0; j < num_threads_in_sub_thread_pool_.size(); ++j) {",
          "content_same": false
        },
        {
          "line": 951,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "sorted_active_handlers_.size()",
          "old_line_content": "    // free_handlers_.",
          "new_line_content": "    DCHECK_GT(sorted_active_handlers_.size(), 0);",
          "content_same": false
        },
        {
          "line": 442,
          "old_api": null,
          "new_api": "CreateThread",
          "old_text": null,
          "new_text": "env_.CreateThread([this, i, num_blocking_threads]() {\n            WorkerLoop(i, i < num_blocking_threads);\n          })",
          "old_line_content": "    if (t.f) {",
          "new_line_content": "          env_.CreateThread([this, i, num_blocking_threads]() {",
          "content_same": false
        },
        {
          "line": 956,
          "old_api": null,
          "new_api": "tensorflow::EnvTime::NowMicros()",
          "old_text": null,
          "new_text": "tensorflow::EnvTime::NowMicros()",
          "old_line_content": "        << \" is being requested for release\";",
          "new_line_content": "    uint64 now = tensorflow::EnvTime::NowMicros();",
          "content_same": false
        },
        {
          "line": 957,
          "old_api": null,
          "new_api": "start_time_us",
          "old_text": null,
          "new_text": "handler->start_time_us()",
          "old_line_content": "",
          "new_line_content": "    double elapsed = (now - handler->start_time_us()) / 1000.0;",
          "content_same": false
        },
        {
          "line": 958,
          "old_api": null,
          "new_api": "Add",
          "old_text": null,
          "new_text": "time_hist_.Add(elapsed)",
          "old_line_content": "    // Remove this handler from this list and add it to the list of free",
          "new_line_content": "    time_hist_.Add(elapsed);",
          "content_same": false
        },
        {
          "line": 450,
          "old_api": null,
          "new_api": "std::move(fn)",
          "old_text": null,
          "new_text": "std::move(fn)",
          "old_line_content": "  // The request with start_request_idx will be attempted first. Other requests",
          "new_line_content": "    Task t = env_.CreateTask(std::move(fn));",
          "content_same": false
        },
        {
          "line": 451,
          "old_api": null,
          "new_api": "std::move(t)",
          "old_text": null,
          "new_text": "std::move(t)",
          "old_line_content": "  // will be attempted in FIFO order based on their arrival time.",
          "new_line_content": "    t = tws->EnqueueTask(std::move(t), is_blocking);",
          "content_same": false
        },
        {
          "line": 964,
          "old_api": null,
          "new_api": "end",
          "old_text": null,
          "new_text": "sorted_active_handlers_.end()",
          "old_line_content": "",
          "new_line_content": "    DCHECK(iter != sorted_active_handlers_.end())",
          "content_same": false
        },
        {
          "line": 453,
          "old_api": null,
          "new_api": "VLOG",
          "old_text": null,
          "new_text": "VLOG(3)",
          "old_line_content": "  // TODO(donglin) Change the task steal order to be round-robin such that if",
          "new_line_content": "      VLOG(3) << \"Running \" << (is_blocking ? \"inter\" : \"intra\") << \" work for \"",
          "content_same": false
        },
        {
          "line": 454,
          "old_api": null,
          "new_api": "GetTracemeId",
          "old_text": null,
          "new_text": "tws->GetTracemeId()",
          "old_line_content": "  // an attempt to steal task from request i failed, then attempt to steal task",
          "new_line_content": "              << tws->GetTracemeId();",
          "content_same": false
        },
        {
          "line": 455,
          "old_api": null,
          "new_api": "ExecuteTask",
          "old_text": null,
          "new_text": "env_.ExecuteTask(t)",
          "old_line_content": "  // from the next request in terms of the arrival time. This approach may",
          "new_line_content": "      env_.ExecuteTask(t);",
          "content_same": false
        },
        {
          "line": 970,
          "old_api": null,
          "new_api": "erase",
          "old_text": null,
          "new_text": "sorted_active_handlers_.erase(iter)",
          "old_line_content": " private:",
          "new_line_content": "    sorted_active_handlers_.erase(iter);",
          "content_same": false
        },
        {
          "line": 971,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "free_handlers_.push_back(handler)",
          "old_line_content": "  void RecomputePoolStats(",
          "new_line_content": "    free_handlers_.push_back(handler);",
          "content_same": false
        },
        {
          "line": 972,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "free_handlers_.size()",
          "old_line_content": "      int num_active_requests, uint64 version,",
          "new_line_content": "    DCHECK_LE(free_handlers_.size(), max_handlers_);",
          "content_same": false
        },
        {
          "line": 973,
          "old_api": null,
          "new_api": "LogInfo",
          "old_text": null,
          "new_text": "LogInfo()",
          "old_line_content": "      const Eigen::MaxSizeVector<ThreadWorkSource*>& thread_work_sources);",
          "new_line_content": "    LogInfo();",
          "content_same": false
        },
        {
          "line": 478,
          "old_api": null,
          "new_api": "resize",
          "old_text": null,
          "new_text": "thread_data_[tid].thread_work_sources.resize(0)",
          "old_line_content": "      // The number of shards for the queue. Threads in each shard will",
          "new_line_content": "    thread_data_[tid].thread_work_sources.resize(0);",
          "content_same": false
        },
        {
          "line": 481,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "thread_work_sources.size()",
          "old_line_content": "      // num_shards == 1: thread_work_sources are ordered as start_request_idx,",
          "new_line_content": "      for (int i = 0; i < thread_work_sources.size(); ++i) {",
          "content_same": false
        },
        {
          "line": 482,
          "old_api": null,
          "new_api": "emplace_back",
          "old_text": null,
          "new_text": "thread_data_[tid].thread_work_sources.emplace_back(\n            thread_work_sources[i])",
          "old_line_content": "      // 0, 1, 2, 3, 4 ... for all threads. When num_shards == 2:",
          "new_line_content": "        thread_data_[tid].thread_work_sources.emplace_back(",
          "content_same": false
        },
        {
          "line": 486,
          "old_api": null,
          "new_api": "emplace_back",
          "old_text": null,
          "new_text": "thread_data_[tid].thread_work_sources.emplace_back(\n          thread_work_sources[start_request_idx])",
          "old_line_content": "      int num_shards =",
          "new_line_content": "      thread_data_[tid].thread_work_sources.emplace_back(",
          "content_same": false
        },
        {
          "line": 497,
          "old_api": null,
          "new_api": "ParamFromEnvWithDefault",
          "old_text": null,
          "new_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_QUEUE_SHARDS\", 1)",
          "old_line_content": "      }",
          "new_line_content": "          ParamFromEnvWithDefault(\"TF_RUN_HANDLER_QUEUE_SHARDS\", 1);",
          "content_same": false
        },
        {
          "line": 500,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "thread_work_sources.size()",
          "old_line_content": "  }",
          "new_line_content": "        for (int j = token; j < thread_work_sources.size(); j += num_shards) {",
          "content_same": false
        },
        {
          "line": 502,
          "old_api": null,
          "new_api": "emplace_back",
          "old_text": null,
          "new_text": "thread_data_[tid].thread_work_sources.emplace_back(\n                thread_work_sources[j])",
          "old_line_content": "  PerThread* GetPerThread() {",
          "new_line_content": "            thread_data_[tid].thread_work_sources.emplace_back(",
          "content_same": false
        },
        {
          "line": 508,
          "old_api": null,
          "new_api": "notify_all",
          "old_text": null,
          "new_text": "thread_data_[tid].sources_not_empty.notify_all()",
          "old_line_content": "  int CurrentThreadId() const {",
          "new_line_content": "      thread_data_[tid].sources_not_empty.notify_all();",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 1025,
          "old_api": "ChooseRequestsWithExponentialDistribution",
          "new_api": null,
          "old_text": "ChooseRequestsWithExponentialDistribution(\n      num_active_requests, num_blocking_threads)",
          "new_text": null,
          "old_line_content": "  std::vector<int> request_idx_list = ChooseRequestsWithExponentialDistribution(",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 1028,
          "old_api": "VLOG",
          "new_api": null,
          "old_text": "VLOG(2)",
          "new_text": null,
          "old_line_content": "    VLOG(2) << \"Set work for tid=\" << i",
          "new_line_content": "                                      &waiters_mu_[sub_thread_pool_id]);",
          "content_same": false
        },
        {
          "line": 1030,
          "old_api": "SetThreadWorkSources",
          "new_api": null,
          "old_text": "run_handler_thread_pool()->SetThreadWorkSources(\n        i, request_idx_list[i], version, thread_work_sources)",
          "new_text": null,
          "old_line_content": "    run_handler_thread_pool()->SetThreadWorkSources(",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 510,
          "old_api": "GetPerThread",
          "new_api": null,
          "old_text": "const_cast<RunHandlerThreadPool*>(this)->GetPerThread()",
          "new_text": null,
          "old_line_content": "        const_cast<RunHandlerThreadPool*>(this)->GetPerThread();",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 1034,
          "old_api": "ChooseRequestsWithExponentialDistribution",
          "new_api": null,
          "old_text": "ChooseRequestsWithExponentialDistribution(\n      num_active_requests, num_non_blocking_threads)",
          "new_text": null,
          "old_line_content": "  request_idx_list = ChooseRequestsWithExponentialDistribution(",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1037,
          "old_api": "VLOG",
          "new_api": null,
          "old_text": "VLOG(2)",
          "new_text": null,
          "old_line_content": "    VLOG(2) << \"Set work for tid=\" << (i + num_blocking_threads)",
          "new_line_content": "  for (int i = 0; i < num_blocking_threads; ++i) {",
          "content_same": false
        },
        {
          "line": 1039,
          "old_api": "SetThreadWorkSources",
          "new_api": null,
          "old_text": "run_handler_thread_pool()->SetThreadWorkSources(\n        i + num_blocking_threads, request_idx_list[i], version,\n        thread_work_sources)",
          "new_text": null,
          "old_line_content": "    run_handler_thread_pool()->SetThreadWorkSources(",
          "new_line_content": "            << \" with start_request_idx=\" << request_idx_list[i];",
          "content_same": false
        },
        {
          "line": 1046,
          "old_api": "VLOG_IS_ON",
          "new_api": null,
          "old_text": "VLOG_IS_ON(1)",
          "new_text": null,
          "old_line_content": "  if (iterations_++ % 50000 == 10 && VLOG_IS_ON(1)) {",
          "new_line_content": "  for (int i = 0; i < num_non_blocking_threads; ++i) {",
          "content_same": false
        },
        {
          "line": 1048,
          "old_api": "ToString",
          "new_api": null,
          "old_text": "time_hist_.ToString()",
          "new_text": null,
          "old_line_content": "    VLOG(1) << \"Printing time histogram: \" << time_hist_.ToString();",
          "new_line_content": "            << \" with start_request_idx=\" << request_idx_list[i];",
          "content_same": false
        },
        {
          "line": 1050,
          "old_api": "NowMicros",
          "new_api": null,
          "old_text": "tensorflow::Env::Default()->NowMicros()",
          "new_text": null,
          "old_line_content": "    uint64 now = tensorflow::Env::Default()->NowMicros();",
          "new_line_content": "        i + num_blocking_threads, request_idx_list[i], version,",
          "content_same": false
        },
        {
          "line": 1062,
          "old_api": "tws",
          "new_api": null,
          "old_text": "sorted_active_handlers_[i]->tws()->GetTracemeId()",
          "new_text": null,
          "old_line_content": "          strings::StrCat(sorted_active_handlers_[i]->tws()->GetTracemeId());",
          "new_line_content": "    string ids_str = \"\";",
          "content_same": false
        },
        {
          "line": 1064,
          "old_api": "VLOG",
          "new_api": null,
          "old_text": "VLOG(1)",
          "new_text": null,
          "old_line_content": "    VLOG(1) << \"Elapsed times are: \" << times_str;",
          "new_line_content": "      if (i > 0) {",
          "content_same": false
        },
        {
          "line": 1065,
          "old_api": "VLOG",
          "new_api": null,
          "old_text": "VLOG(1)",
          "new_text": null,
          "old_line_content": "    VLOG(1) << \"Step ids are: \" << ids_str;",
          "new_line_content": "        times_str += \" \";",
          "content_same": false
        },
        {
          "line": 1076,
          "old_api": "run_handler_thread_pool",
          "new_api": null,
          "old_text": "run_handler_impl_->pool_impl_->run_handler_thread_pool()\n      ->CurrentThreadId()",
          "new_text": null,
          "old_line_content": "  return run_handler_impl_->pool_impl_->run_handler_thread_pool()",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 1087,
          "old_api": "reset",
          "new_api": null,
          "old_text": "thread_pool_interface_.reset(new ThreadPoolInterfaceWrapper(this))",
          "new_text": null,
          "old_line_content": "  thread_pool_interface_.reset(new ThreadPoolInterfaceWrapper(this));",
          "new_line_content": "      ->CurrentThreadId();",
          "content_same": false
        },
        {
          "line": 1088,
          "old_api": "Reset",
          "new_api": null,
          "old_text": "Reset(0)",
          "new_text": null,
          "old_line_content": "  Reset(0);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 1093,
          "old_api": "tws",
          "new_api": null,
          "old_text": "tws()",
          "new_text": null,
          "old_line_content": "  pool_impl_->run_handler_thread_pool()->AddWorkToQueue(tws(), true,",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 1094,
          "old_api": "std::move(fn)",
          "new_api": null,
          "old_text": "std::move(fn)",
          "new_text": null,
          "old_line_content": "                                                        std::move(fn));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1099,
          "old_api": "tws",
          "new_api": null,
          "old_text": "tws()",
          "new_text": null,
          "old_line_content": "  pool_impl_->run_handler_thread_pool()->AddWorkToQueue(tws(), false,",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 1100,
          "old_api": "std::move(fn)",
          "new_api": null,
          "old_text": "std::move(fn)",
          "new_text": null,
          "old_line_content": "                                                        std::move(fn));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1106,
          "old_api": "SetTracemeId",
          "new_api": null,
          "old_text": "tws_.SetTracemeId(step_id)",
          "new_text": null,
          "old_line_content": "  tws_.SetTracemeId(step_id);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 599,
          "old_api": "GetInflightTaskCount",
          "new_api": null,
          "old_text": "*tws)->GetInflightTaskCount(true)",
          "new_text": null,
          "old_line_content": "        (*tws)->GetInflightTaskCount(true) < max_blocking_inflight) {",
          "new_line_content": "  // walk.",
          "content_same": false
        },
        {
          "line": 600,
          "old_api": "PopBlockingTask",
          "new_api": null,
          "old_text": "*tws)->PopBlockingTask()",
          "new_text": null,
          "old_line_content": "      t = (*tws)->PopBlockingTask();",
          "new_line_content": "  for (int i = 0; i < searching_range_end - searching_range_start; ++i) {",
          "content_same": false
        },
        {
          "line": 608,
          "old_api": "PopNonBlockingTask",
          "new_api": null,
          "old_text": "*tws)->PopNonBlockingTask(thread_id, true)",
          "new_text": null,
          "old_line_content": "    t = (*tws)->PopNonBlockingTask(thread_id, true);",
          "new_line_content": "    if (may_steal_blocking_work &&",
          "content_same": false
        },
        {
          "line": 1120,
          "old_api": "Get",
          "new_api": null,
          "old_text": "impl_->Get(step_id, timeout_in_ms)",
          "new_text": null,
          "old_line_content": "  return impl_->Get(step_id, timeout_in_ms);",
          "new_line_content": "    : impl_(new Impl(num_inter_op_threads, 0)) {}",
          "content_same": false
        },
        {
          "line": 1126,
          "old_api": "std::move(fn)",
          "new_api": null,
          "old_text": "std::move(fn)",
          "new_text": null,
          "old_line_content": "  impl_->ScheduleInterOpClosure(std::move(fn));",
          "new_line_content": "RunHandlerPool::~RunHandlerPool() {}",
          "content_same": false
        },
        {
          "line": 620,
          "old_api": "GetPerThread",
          "new_api": null,
          "old_text": "GetPerThread()",
          "new_text": null,
          "old_line_content": "  PerThread* pt = GetPerThread();",
          "new_line_content": "      break;",
          "content_same": false
        },
        {
          "line": 1133,
          "old_api": "pool_impl",
          "new_api": null,
          "old_text": "impl_->pool_impl()->ReleaseHandler(impl_)",
          "new_text": null,
          "old_line_content": "RunHandler::~RunHandler() { impl_->pool_impl()->ReleaseHandler(impl_); }",
          "new_line_content": "RunHandler::RunHandler(Impl* impl) : impl_(impl) {}",
          "content_same": false
        },
        {
          "line": 623,
          "old_api": "constexpr",
          "new_api": null,
          "old_text": "constexpr",
          "new_text": null,
          "old_line_content": "  static constexpr int32 kMaxBlockingInflight = 10;",
          "new_line_content": "  thread_data_[thread_id].current_index = current_index;",
          "content_same": false
        },
        {
          "line": 637,
          "old_api": "size",
          "new_api": null,
          "old_text": "thread_work_sources->size()",
          "new_text": null,
          "old_line_content": "      int active_requests = thread_work_sources->size();",
          "new_line_content": "    ThreadWorkSource* tws = nullptr;",
          "content_same": false
        },
        {
          "line": 641,
          "old_api": "FindTask",
          "new_api": null,
          "old_text": "FindTask(\n            active_requests *\n                sub_thread_pool_start_request_percentage_[sub_thread_pool_id],\n            active_requests *\n                sub_thread_pool_end_request_percentage_[sub_thread_pool_id],\n            thread_id, sub_thread_pool_id, kMaxBlockingInflight,\n            /*may_steal_blocking_work=*/true, *thread_work_sources,\n            &task_from_blocking_queue, &tws)",
          "new_text": null,
          "old_line_content": "        t = FindTask(",
          "new_line_content": "    int sub_thread_pool_id;",
          "content_same": false
        },
        {
          "line": 652,
          "old_api": "FindTask",
          "new_api": null,
          "old_text": "FindTask(0, active_requests, thread_id, sub_thread_pool_id,\n                       kMaxBlockingInflight,\n                       /*may_steal_blocking_work=*/true, *thread_work_sources,\n                       &task_from_blocking_queue, &tws)",
          "new_text": null,
          "old_line_content": "          t = FindTask(0, active_requests, thread_id, sub_thread_pool_id,",
          "new_line_content": "            active_requests *",
          "content_same": false
        },
        {
          "line": 660,
          "old_api": "FindTask",
          "new_api": null,
          "old_text": "FindTask(0, active_requests, thread_id, sub_thread_pool_id,\n                     kMaxBlockingInflight,\n                     /*may_steal_blocking_work=*/false, *thread_work_sources,\n                     &task_from_blocking_queue, &tws)",
          "new_text": null,
          "old_line_content": "        t = FindTask(0, active_requests, thread_id, sub_thread_pool_id,",
          "new_line_content": "          // Search from all requests if the thread cannot find tasks from",
          "content_same": false
        },
        {
          "line": 672,
          "old_api": "size",
          "new_api": null,
          "old_text": "thread_work_sources->size()",
          "new_text": null,
          "old_line_content": "      for (int i = 0; i < thread_work_sources->size(); ++i) {",
          "new_line_content": "                     /*may_steal_blocking_work=*/false, *thread_work_sources,",
          "content_same": false
        },
        {
          "line": 678,
          "old_api": "GetInflightTaskCount",
          "new_api": null,
          "old_text": "tws->GetInflightTaskCount(true)",
          "new_text": null,
          "old_line_content": "            tws->GetInflightTaskCount(true) < kMaxBlockingInflight) {",
          "new_line_content": "      mutex_lock l(thread_data_[thread_id].mu);",
          "content_same": false
        },
        {
          "line": 679,
          "old_api": "PopBlockingTask",
          "new_api": null,
          "old_text": "tws->PopBlockingTask()",
          "new_text": null,
          "old_line_content": "          t = tws->PopBlockingTask();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 697,
          "old_api": "PopNonBlockingTask",
          "new_api": null,
          "old_text": "tws->PopNonBlockingTask(thread_id, false)",
          "new_text": null,
          "old_line_content": "          t = tws->PopNonBlockingTask(thread_id, false);",
          "new_line_content": "          // guaranteed it can be worked on.",
          "content_same": false
        },
        {
          "line": 708,
          "old_api": "GetTracemeId",
          "new_api": null,
          "old_text": "strings::StrCat(task_from_blocking_queue ? \"inter\" : \"intra\",\n                                   \" #id = \", tws->GetTracemeId(), \" \",\n                                   thread_id, \"#\")",
          "new_text": null,
          "old_line_content": "            return strings::StrCat(task_from_blocking_queue ? \"inter\" : \"intra\",",
          "new_line_content": "          if (t.f) {",
          "content_same": false
        },
        {
          "line": 709,
          "old_api": "GetTracemeId",
          "new_api": null,
          "old_text": "tws->GetTracemeId()",
          "new_text": null,
          "old_line_content": "                                   \" #id = \", tws->GetTracemeId(), \" \",",
          "new_line_content": "            task_from_blocking_queue = false;",
          "content_same": false
        },
        {
          "line": 713,
          "old_api": "VLOG",
          "new_api": null,
          "old_text": "VLOG(2)",
          "new_text": null,
          "old_line_content": "      VLOG(2) << \"Running \" << (task_from_blocking_queue ? \"inter\" : \"intra\")",
          "new_line_content": "      }",
          "content_same": false
        },
        {
          "line": 714,
          "old_api": "GetTracemeId",
          "new_api": null,
          "old_text": "tws->GetTracemeId()",
          "new_text": null,
          "old_line_content": "              << \" work from \" << tws->GetTracemeId();",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 715,
          "old_api": "IncrementInflightTaskCount",
          "new_api": null,
          "old_text": "tws->IncrementInflightTaskCount(task_from_blocking_queue)",
          "new_text": null,
          "old_line_content": "      tws->IncrementInflightTaskCount(task_from_blocking_queue);",
          "new_line_content": "    if (t.f) {",
          "content_same": false
        },
        {
          "line": 716,
          "old_api": "ExecuteTask",
          "new_api": null,
          "old_text": "env_.ExecuteTask(t)",
          "new_text": null,
          "old_line_content": "      env_.ExecuteTask(t);",
          "new_line_content": "      profiler::TraceMe activity(",
          "content_same": false
        },
        {
          "line": 717,
          "old_api": "DecrementInflightTaskCount",
          "new_api": null,
          "old_text": "tws->DecrementInflightTaskCount(task_from_blocking_queue)",
          "new_text": null,
          "old_line_content": "      tws->DecrementInflightTaskCount(task_from_blocking_queue);",
          "new_line_content": "          [=] {",
          "content_same": false
        },
        {
          "line": 721,
          "old_api": "strings::StrCat(\"Sleeping#thread_id=\", thread_id, \"#\")",
          "new_api": null,
          "old_text": "strings::StrCat(\"Sleeping#thread_id=\", thread_id, \"#\")",
          "new_text": null,
          "old_line_content": "            return strings::StrCat(\"Sleeping#thread_id=\", thread_id, \"#\");",
          "new_line_content": "          },",
          "content_same": false
        },
        {
          "line": 728,
          "old_api": "ToString",
          "new_api": null,
          "old_text": "*thread_work_sources)[i]->ToString()",
          "new_text": null,
          "old_line_content": "                  << (*thread_work_sources)[i]->ToString();",
          "new_line_content": "    } else {",
          "content_same": false
        },
        {
          "line": 732,
          "old_api": "WaitForWorkInSubThreadPool",
          "new_api": null,
          "old_text": "WaitForWorkInSubThreadPool(may_steal_blocking_work, sub_thread_pool_id)",
          "new_text": null,
          "old_line_content": "        WaitForWorkInSubThreadPool(may_steal_blocking_work, sub_thread_pool_id);",
          "new_line_content": "          },",
          "content_same": false
        },
        {
          "line": 746,
          "old_api": "SleepForMicroseconds",
          "new_api": null,
          "old_text": "Env::Default()->SleepForMicroseconds(kMaxSleepMicros)",
          "new_text": null,
          "old_line_content": "    Env::Default()->SleepForMicroseconds(kMaxSleepMicros);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 750,
          "old_api": "thread_local",
          "new_api": null,
          "old_text": "thread_local",
          "new_text": null,
          "old_line_content": "  thread_local Waiter waiter;",
          "new_line_content": "void RunHandlerThreadPool::WaitForWorkInSubThreadPool(bool is_blocking,",
          "content_same": false
        },
        {
          "line": 751,
          "old_api": "WaitOnWaiter",
          "new_api": null,
          "old_text": "WaitOnWaiter(&waiter, &(*queue_waiters_)[sub_thread_pool_id],\n               &(*waiters_mu_)[sub_thread_pool_id], kMaxSleepMicros)",
          "new_text": null,
          "old_line_content": "  WaitOnWaiter(&waiter, &(*queue_waiters_)[sub_thread_pool_id],",
          "new_line_content": "                                                      int sub_thread_pool_id) {",
          "content_same": false
        },
        {
          "line": 770,
          "old_api": "empty",
          "new_api": null,
          "old_text": "thread_work_sources->empty()",
          "new_text": null,
          "old_line_content": "    while (!cancelled_ && thread_work_sources->empty()) {",
          "new_line_content": "  if (!is_blocking) {",
          "content_same": false
        },
        {
          "line": 772,
          "old_api": "wait",
          "new_api": null,
          "old_text": "thread_data_[thread_id].sources_not_empty.wait(l)",
          "new_text": null,
          "old_line_content": "      thread_data_[thread_id].sources_not_empty.wait(l);",
          "new_line_content": "    return;",
          "content_same": false
        },
        {
          "line": 784,
          "old_api": "WaitForWork",
          "new_api": null,
          "old_text": "tws->WaitForWork(kMaxSleepMicros)",
          "new_text": null,
          "old_line_content": "  tws->WaitForWork(kMaxSleepMicros);",
          "new_line_content": "    if (cancelled_) {",
          "content_same": false
        },
        {
          "line": 793,
          "old_api": "explicit",
          "new_api": null,
          "old_text": "explicit",
          "new_text": null,
          "old_line_content": "  explicit Impl(RunHandlerPool::Impl* pool_impl);",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 798,
          "old_api": "get",
          "new_api": null,
          "old_text": "thread_pool_interface_.get()",
          "new_text": null,
          "old_line_content": "    return thread_pool_interface_.get();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 312,
          "old_api": "load",
          "new_api": null,
          "old_text": "counter->load(std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "    return counter->load(std::memory_order_relaxed);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 318,
          "old_api": "fetch_add",
          "new_api": null,
          "old_text": "counter->fetch_add(1, std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "    counter->fetch_add(1, std::memory_order_relaxed);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 324,
          "old_api": "fetch_sub",
          "new_api": null,
          "old_text": "counter->fetch_sub(1, std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "    counter->fetch_sub(1, std::memory_order_relaxed);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 840,
          "old_api": "explicit",
          "new_api": null,
          "old_text": "explicit",
          "new_text": null,
          "old_line_content": "  explicit Impl(int num_inter_op_threads, int num_intra_op_threads)",
          "new_line_content": "  int64 step_id_;",
          "content_same": false
        },
        {
          "line": 841,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_MAX_CONCURRENT_HANDLERS\", kMaxConcurrentHandlers)",
          "new_text": null,
          "old_line_content": "      : max_handlers_(static_cast<int32>(ParamFromEnvWithDefault(",
          "new_line_content": "  std::unique_ptr<thread::ThreadPoolInterface> thread_pool_interface_;",
          "content_same": false
        },
        {
          "line": 844,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)",
          "new_text": null,
          "old_line_content": "            ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)),",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 332,
          "old_api": "GetTracemeId",
          "new_api": null,
          "old_text": "GetTracemeId()",
          "new_text": null,
          "old_line_content": "    return strings::StrCat(\"traceme_id = \", GetTracemeId(),",
          "new_line_content": "    std::atomic<int64>* counter =",
          "content_same": false
        },
        {
          "line": 846,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)",
          "new_text": null,
          "old_line_content": "            ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)),",
          "new_line_content": "// responsible for pool management decisions.",
          "content_same": false
        },
        {
          "line": 333,
          "old_api": "TaskQueueSize",
          "new_api": null,
          "old_text": "TaskQueueSize(true)",
          "new_text": null,
          "old_line_content": "                           \", inter queue size = \", TaskQueueSize(true),",
          "new_line_content": "        is_blocking ? &blocking_inflight_ : &non_blocking_inflight_;",
          "content_same": false
        },
        {
          "line": 848,
          "old_api": "Env::Default()",
          "new_api": null,
          "old_text": "Env::Default()",
          "new_text": null,
          "old_line_content": "            num_inter_op_threads, num_intra_op_threads, Env::Default(),",
          "new_line_content": "class RunHandlerPool::Impl {",
          "content_same": false
        },
        {
          "line": 335,
          "old_api": "TaskQueueSize",
          "new_api": null,
          "old_text": "TaskQueueSize(false)",
          "new_text": null,
          "old_line_content": "                           \", intra queue size = \", TaskQueueSize(false),",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 336,
          "old_api": "GetInflightTaskCount",
          "new_api": null,
          "old_text": "GetInflightTaskCount(false)",
          "new_text": null,
          "old_line_content": "                           \", intra inflight = \", GetInflightTaskCount(false));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 849,
          "old_api": "ThreadOptions",
          "new_api": null,
          "old_text": "ThreadOptions()",
          "new_text": null,
          "old_line_content": "            ThreadOptions(), \"tf_run_handler_pool\", &waiters_mu_,",
          "new_line_content": " public:",
          "content_same": false
        },
        {
          "line": 853,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_SUB_THREAD_POOL_END_REQUEST_PERCENTAGE\",\n            std::vector<double>({1}))",
          "new_text": null,
          "old_line_content": "        sub_thread_pool_end_request_percentage_(ParamFromEnvWithDefault(",
          "new_line_content": "        waiters_mu_(",
          "content_same": false
        },
        {
          "line": 855,
          "old_api": "std::vector<double>({1})",
          "new_api": null,
          "old_text": "std::vector<double>({1})",
          "new_text": null,
          "old_line_content": "            std::vector<double>({1}))) {",
          "new_line_content": "        queue_waiters_(",
          "content_same": false
        },
        {
          "line": 861,
          "old_api": "resize",
          "new_api": null,
          "old_text": "queue_waiters_.resize(\n        ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2))",
          "new_text": null,
          "old_line_content": "    queue_waiters_.resize(",
          "new_line_content": "        iterations_(0),",
          "content_same": false
        },
        {
          "line": 862,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)",
          "new_text": null,
          "old_line_content": "        ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2));",
          "new_line_content": "        version_(0),",
          "content_same": false
        },
        {
          "line": 864,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2)",
          "new_text": null,
          "old_line_content": "        ParamFromEnvWithDefault(\"TF_RUN_HANDLER_NUM_SUB_THREAD_POOL\", 2));",
          "new_line_content": "            \"TF_RUN_HANDLER_SUB_THREAD_POOL_END_REQUEST_PERCENTAGE\",",
          "content_same": false
        },
        {
          "line": 875,
          "old_api": "size",
          "new_api": null,
          "old_text": "handlers_.size()",
          "new_text": null,
          "old_line_content": "    DCHECK_EQ(handlers_.size(), max_handlers_);",
          "new_line_content": "    for (auto& queue_waiter : queue_waiters_) {",
          "content_same": false
        },
        {
          "line": 876,
          "old_api": "size",
          "new_api": null,
          "old_text": "handlers_.size()",
          "new_text": null,
          "old_line_content": "    DCHECK_EQ(free_handlers_.size(), handlers_.size());",
          "new_line_content": "      queue_waiter.next = &queue_waiter;",
          "content_same": false
        },
        {
          "line": 877,
          "old_api": "size",
          "new_api": null,
          "old_text": "sorted_active_handlers_.size()",
          "new_text": null,
          "old_line_content": "    DCHECK_EQ(sorted_active_handlers_.size(), 0);",
          "new_line_content": "      queue_waiter.prev = &queue_waiter;",
          "content_same": false
        },
        {
          "line": 881,
          "old_api": "reset",
          "new_api": null,
          "old_text": "run_handler_thread_pool_.reset()",
          "new_text": null,
          "old_line_content": "    run_handler_thread_pool_.reset();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 889,
          "old_api": "empty",
          "new_api": null,
          "old_text": "free_handlers_.empty()",
          "new_text": null,
          "old_line_content": "    return !free_handlers_.empty();",
          "new_line_content": "    // pointers. Otherwise a thread may try to access a pointer after the",
          "content_same": false
        },
        {
          "line": 387,
          "old_api": "ParamFromEnvBoolWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvBoolWithDefault(\n            \"TF_RUN_HANDLER_USE_SUB_THREAD_POOL\", false)",
          "new_text": null,
          "old_line_content": "        use_sub_thread_pool_(ParamFromEnvBoolWithDefault(",
          "new_line_content": "                       Eigen::MaxSizeVector<mutex>* waiters_mu,",
          "content_same": false
        },
        {
          "line": 389,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_NUM_THREADS_IN_SUB_THREAD_POOL\",\n            std::vector<int>(\n                {num_blocking_threads / 2,\n                 num_blocking_threads - num_blocking_threads / 2}))",
          "new_text": null,
          "old_line_content": "        num_threads_in_sub_thread_pool_(ParamFromEnvWithDefault(",
          "new_line_content": "      : num_threads_(num_blocking_threads + num_non_blocking_threads),",
          "content_same": false
        },
        {
          "line": 901,
          "old_api": "empty",
          "new_api": null,
          "old_text": "free_handlers_.empty()",
          "new_text": null,
          "old_line_content": "      if (free_handlers_.empty()) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 391,
          "old_api": "std::vector<int>(\n                {num_blocking_threads / 2,\n                 num_blocking_threads - num_blocking_threads / 2})",
          "new_api": null,
          "old_text": "std::vector<int>(\n                {num_blocking_threads / 2,\n                 num_blocking_threads - num_blocking_threads / 2})",
          "new_text": null,
          "old_line_content": "            std::vector<int>(",
          "new_line_content": "        num_non_blocking_threads_(num_non_blocking_threads),",
          "content_same": false
        },
        {
          "line": 904,
          "old_api": "strings::StrCat(\"WaitingForHandler#step_id=\", step_id,\n                                     \"#\")",
          "new_api": null,
          "old_text": "strings::StrCat(\"WaitingForHandler#step_id=\", step_id,\n                                     \"#\")",
          "new_text": null,
          "old_line_content": "              return strings::StrCat(\"WaitingForHandler#step_id=\", step_id,",
          "new_line_content": "    std::unique_ptr<Eigen::MaxSizeVector<ThreadWorkSource*>>",
          "content_same": false
        },
        {
          "line": 394,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\n            \"TF_RUN_HANDLER_SUB_THREAD_POOL_START_REQUEST_PERCENTAGE\",\n            std::vector<double>({0, 0.4}))",
          "new_text": null,
          "old_line_content": "        sub_thread_pool_start_request_percentage_(ParamFromEnvWithDefault(",
          "new_line_content": "        name_(name),",
          "content_same": false
        },
        {
          "line": 396,
          "old_api": "std::vector<double>({0, 0.4})",
          "new_api": null,
          "old_text": "std::vector<double>({0, 0.4})",
          "new_text": null,
          "old_line_content": "            std::vector<double>({0, 0.4}))),",
          "new_line_content": "        queue_waiters_(queue_waiters),",
          "content_same": false
        },
        {
          "line": 908,
          "old_api": "AwaitWithDeadline",
          "new_api": null,
          "old_text": "mu_.AwaitWithDeadline(\n                Condition(this, &Impl::has_free_handler),\n                EnvTime::NowNanos() + timeout_in_ms * 1000 * 1000)",
          "new_text": null,
          "old_line_content": "        if (!mu_.AwaitWithDeadline(",
          "new_line_content": "    RunHandler::Impl* handler_impl;",
          "content_same": false
        },
        {
          "line": 909,
          "old_api": "Condition",
          "new_api": null,
          "old_text": "Condition(this, &Impl::has_free_handler)",
          "new_text": null,
          "old_line_content": "                Condition(this, &Impl::has_free_handler),",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 910,
          "old_api": "EnvTime::NowNanos()",
          "new_api": null,
          "old_text": "EnvTime::NowNanos()",
          "new_text": null,
          "old_line_content": "                EnvTime::NowNanos() + timeout_in_ms * 1000 * 1000)) {",
          "new_line_content": "      mutex_lock l(mu_);",
          "content_same": false
        },
        {
          "line": 400,
          "old_api": "VLOG",
          "new_api": null,
          "old_text": "VLOG(1)",
          "new_text": null,
          "old_line_content": "    VLOG(1) << \"Creating RunHandlerThreadPool \" << name << \" with  \"",
          "new_line_content": "            \"TF_RUN_HANDLER_NUM_THREADS_IN_SUB_THREAD_POOL\",",
          "content_same": false
        },
        {
          "line": 916,
          "old_api": "back",
          "new_api": null,
          "old_text": "free_handlers_.back()",
          "new_text": null,
          "old_line_content": "      handler_impl = free_handlers_.back();",
          "new_line_content": "            },",
          "content_same": false
        },
        {
          "line": 917,
          "old_api": "Reset",
          "new_api": null,
          "old_text": "handler_impl->Reset(step_id)",
          "new_text": null,
          "old_line_content": "      handler_impl->Reset(step_id);",
          "new_line_content": "            profiler::TraceMeLevel::kInfo);",
          "content_same": false
        },
        {
          "line": 921,
          "old_api": "size",
          "new_api": null,
          "old_text": "sorted_active_handlers_.size()",
          "new_text": null,
          "old_line_content": "      DCHECK_LE(sorted_active_handlers_.size(), max_handlers_);",
          "new_line_content": "          return nullptr;",
          "content_same": false
        },
        {
          "line": 922,
          "old_api": "pop_back",
          "new_api": null,
          "old_text": "free_handlers_.pop_back()",
          "new_text": null,
          "old_line_content": "      free_handlers_.pop_back();",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 412,
          "old_api": "notify_all",
          "new_api": null,
          "old_text": "thread_data_[i].sources_not_empty.notify_all()",
          "new_text": null,
          "old_line_content": "        thread_data_[i].sources_not_empty.notify_all();",
          "new_line_content": "            << num_non_blocking_threads_ << \" non-blocking threads.\";",
          "content_same": false
        },
        {
          "line": 924,
          "old_api": "size",
          "new_api": null,
          "old_text": "sorted_active_handlers_.size()",
          "new_text": null,
          "old_line_content": "      num_active_requests = sorted_active_handlers_.size();",
          "new_line_content": "      // Remove the last entry from free_handlers_ and add to the end of",
          "content_same": false
        },
        {
          "line": 414,
          "old_api": "reset",
          "new_api": null,
          "old_text": "thread_data_[i].thread.reset()",
          "new_text": null,
          "old_line_content": "      thread_data_[i].thread.reset();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 928,
          "old_api": "resize",
          "new_api": null,
          "old_text": "thread_work_sources->resize(num_active_requests)",
          "new_text": null,
          "old_line_content": "      thread_work_sources->resize(num_active_requests);",
          "new_line_content": "      // Sortedness isn't violated if we simply add at the end of the list,",
          "content_same": false
        },
        {
          "line": 420,
          "old_api": "resize",
          "new_api": null,
          "old_text": "thread_data_.resize(num_threads_)",
          "new_text": null,
          "old_line_content": "    thread_data_.resize(num_threads_);",
          "new_line_content": "      {",
          "content_same": false
        },
        {
          "line": 423,
          "old_api": "size",
          "new_api": null,
          "old_text": "num_threads_in_sub_thread_pool_.size()",
          "new_text": null,
          "old_line_content": "      int sub_thread_pool_id = num_threads_in_sub_thread_pool_.size() - 1;",
          "new_line_content": "      }",
          "content_same": false
        },
        {
          "line": 935,
          "old_api": "RecomputePoolStats",
          "new_api": null,
          "old_text": "RecomputePoolStats(num_active_requests, version, *thread_work_sources)",
          "new_text": null,
          "old_line_content": "    RecomputePoolStats(num_active_requests, version, *thread_work_sources);",
          "new_line_content": "      thread_work_sources =",
          "content_same": false
        },
        {
          "line": 431,
          "old_api": "reset",
          "new_api": null,
          "old_text": "thread_data_[i].thread.reset(\n          env_.CreateThread([this, i, num_blocking_threads]() {\n            WorkerLoop(i, i < num_blocking_threads);\n          }))",
          "new_text": null,
          "old_line_content": "      thread_data_[i].thread.reset(",
          "new_line_content": "    int num_blocking_threads = num_blocking_threads_;",
          "content_same": false
        },
        {
          "line": 432,
          "old_api": "CreateThread",
          "new_api": null,
          "old_text": "env_.CreateThread([this, i, num_blocking_threads]() {\n            WorkerLoop(i, i < num_blocking_threads);\n          })",
          "new_text": null,
          "old_line_content": "          env_.CreateThread([this, i, num_blocking_threads]() {",
          "new_line_content": "    for (int i = 0; i < num_threads_; i++) {",
          "content_same": false
        },
        {
          "line": 943,
          "old_api": "tws",
          "new_api": null,
          "old_text": "handler->tws()->TaskQueueSize(true)",
          "new_text": null,
          "old_line_content": "    CHECK_EQ(handler->tws()->TaskQueueSize(true), 0);   // Crash OK.",
          "new_line_content": "      version = ++version_;",
          "content_same": false
        },
        {
          "line": 944,
          "old_api": "tws",
          "new_api": null,
          "old_text": "handler->tws()->TaskQueueSize(false)",
          "new_text": null,
          "old_line_content": "    CHECK_EQ(handler->tws()->TaskQueueSize(false), 0);  // Crash OK.",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 947,
          "old_api": "start_time_us",
          "new_api": null,
          "old_text": "handler->start_time_us()",
          "new_text": null,
          "old_line_content": "    double elapsed = (now - handler->start_time_us()) / 1000.0;",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 948,
          "old_api": "Add",
          "new_api": null,
          "old_text": "time_hist_.Add(elapsed)",
          "new_text": null,
          "old_line_content": "    time_hist_.Add(elapsed);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 440,
          "old_api": "std::move(fn)",
          "new_api": null,
          "old_text": "std::move(fn)",
          "new_text": null,
          "old_line_content": "    Task t = env_.CreateTask(std::move(fn));",
          "new_line_content": "      thread_data_[i].sub_thread_pool_id = sub_thread_pool_id;",
          "content_same": false
        },
        {
          "line": 952,
          "old_api": "begin",
          "new_api": null,
          "old_text": "sorted_active_handlers_.begin()",
          "new_text": null,
          "old_line_content": "    auto iter = std::find(sorted_active_handlers_.begin(),",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 444,
          "old_api": "GetTracemeId",
          "new_api": null,
          "old_text": "tws->GetTracemeId()",
          "new_text": null,
          "old_line_content": "              << tws->GetTracemeId();",
          "new_line_content": "          }));",
          "content_same": false
        },
        {
          "line": 445,
          "old_api": "ExecuteTask",
          "new_api": null,
          "old_text": "env_.ExecuteTask(t)",
          "new_text": null,
          "old_line_content": "      env_.ExecuteTask(t);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 960,
          "old_api": "erase",
          "new_api": null,
          "old_text": "sorted_active_handlers_.erase(iter)",
          "new_text": null,
          "old_line_content": "    sorted_active_handlers_.erase(iter);",
          "new_line_content": "    // Erase from and update sorted_active_handlers_. Add it to the end of",
          "content_same": false
        },
        {
          "line": 961,
          "old_api": "push_back",
          "new_api": null,
          "old_text": "free_handlers_.push_back(handler)",
          "new_text": null,
          "old_line_content": "    free_handlers_.push_back(handler);",
          "new_line_content": "    // free_handlers_.",
          "content_same": false
        },
        {
          "line": 468,
          "old_api": "resize",
          "new_api": null,
          "old_text": "thread_data_[tid].thread_work_sources.resize(0)",
          "new_text": null,
          "old_line_content": "    thread_data_[tid].thread_work_sources.resize(0);",
          "new_line_content": "  void SetThreadWorkSources(",
          "content_same": false
        },
        {
          "line": 471,
          "old_api": "size",
          "new_api": null,
          "old_text": "thread_work_sources.size()",
          "new_text": null,
          "old_line_content": "      for (int i = 0; i < thread_work_sources.size(); ++i) {",
          "new_line_content": "    mutex_lock l(thread_data_[tid].mu);",
          "content_same": false
        },
        {
          "line": 472,
          "old_api": "emplace_back",
          "new_api": null,
          "old_text": "thread_data_[tid].thread_work_sources.emplace_back(\n            thread_work_sources[i])",
          "new_text": null,
          "old_line_content": "        thread_data_[tid].thread_work_sources.emplace_back(",
          "new_line_content": "    if (version > thread_data_[tid].version) {",
          "content_same": false
        },
        {
          "line": 476,
          "old_api": "emplace_back",
          "new_api": null,
          "old_text": "thread_data_[tid].thread_work_sources.emplace_back(\n          thread_work_sources[start_request_idx])",
          "new_text": null,
          "old_line_content": "      thread_data_[tid].thread_work_sources.emplace_back(",
          "new_line_content": "      return;",
          "content_same": false
        },
        {
          "line": 487,
          "old_api": "ParamFromEnvWithDefault",
          "new_api": null,
          "old_text": "ParamFromEnvWithDefault(\"TF_RUN_HANDLER_QUEUE_SHARDS\", 1)",
          "new_text": null,
          "old_line_content": "          ParamFromEnvWithDefault(\"TF_RUN_HANDLER_QUEUE_SHARDS\", 1);",
          "new_line_content": "          thread_work_sources[start_request_idx]);",
          "content_same": false
        },
        {
          "line": 490,
          "old_api": "size",
          "new_api": null,
          "old_text": "thread_work_sources.size()",
          "new_text": null,
          "old_line_content": "        for (int j = token; j < thread_work_sources.size(); j += num_shards) {",
          "new_line_content": "      // could decrease the contention in the queue. For example, when",
          "content_same": false
        },
        {
          "line": 492,
          "old_api": "emplace_back",
          "new_api": null,
          "old_text": "thread_data_[tid].thread_work_sources.emplace_back(\n                thread_work_sources[j])",
          "new_text": null,
          "old_line_content": "            thread_data_[tid].thread_work_sources.emplace_back(",
          "new_line_content": "      // 0, 1, 2, 3, 4 ... for all threads. When num_shards == 2:",
          "content_same": false
        },
        {
          "line": 498,
          "old_api": "notify_all",
          "new_api": null,
          "old_text": "thread_data_[tid].sources_not_empty.notify_all()",
          "new_text": null,
          "old_line_content": "      thread_data_[tid].sources_not_empty.notify_all();",
          "new_line_content": "      int token = tid % num_shards;",
          "content_same": false
        },
        {
          "line": 1011,
          "old_api": "size",
          "new_api": null,
          "old_text": "sub_thread_pool_end_request_percentage_.size()",
          "new_text": null,
          "old_line_content": "            sub_thread_pool_end_request_percentage_.size() - 1 &&",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 503,
          "old_api": "thread_local",
          "new_api": null,
          "old_text": "thread_local",
          "new_text": null,
          "old_line_content": "    thread_local PerThread per_thread_;",
          "new_line_content": "                thread_work_sources[j]);",
          "content_same": false
        },
        {
          "line": 1016,
          "old_api": "SetWaiter",
          "new_api": null,
          "old_text": "thread_work_sources[i]->SetWaiter(version,\n                                      &queue_waiters_[sub_thread_pool_id],\n                                      &waiters_mu_[sub_thread_pool_id])",
          "new_text": null,
          "old_line_content": "    thread_work_sources[i]->SetWaiter(version,",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1022,
          "old_api": "NumBlockingThreads",
          "new_api": null,
          "old_text": "run_handler_thread_pool()->NumBlockingThreads()",
          "new_text": null,
          "old_line_content": "  int num_blocking_threads = run_handler_thread_pool()->NumBlockingThreads();",
          "new_line_content": "        i >= num_active_requests *",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 45,
      "total_additions": 124,
      "total_deletions": 124,
      "total_api_changes": 293
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 13,
        "api_related_lines": 293,
        "non_api_lines": 12,
        "non_api_line_numbers": [
          300,
          301,
          302,
          303,
          304,
          305,
          306,
          307,
          308,
          309,
          310,
          313
        ]
      }
    },
    "api_calls_before": 258,
    "api_calls_after": 258,
    "diff_info": {
      "added_lines": 13,
      "removed_lines": 3,
      "total_diff_lines": 29
    }
  }
}