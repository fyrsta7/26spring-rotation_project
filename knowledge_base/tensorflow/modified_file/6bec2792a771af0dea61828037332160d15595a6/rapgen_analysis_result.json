{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/6bec2792a771af0dea61828037332160d15595a6",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/6bec2792a771af0dea61828037332160d15595a6/before.h",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/6bec2792a771af0dea61828037332160d15595a6/after.h",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/6bec2792a771af0dea61828037332160d15595a6/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 50,
          "old_api": "static_cast<double>(input_data[i * depth + c] - max)",
          "new_api": "static_cast<float>(params.beta)",
          "old_text": "static_cast<double>(input_data[i * depth + c] - max)",
          "new_text": "static_cast<float>(params.beta)",
          "old_line_content": "      sum += std::exp(static_cast<double>(input_data[i * depth + c] - max) *",
          "new_line_content": "                      static_cast<float>(params.beta));",
          "content_same": false
        },
        {
          "line": 82,
          "old_api": "DimensionsCount",
          "new_api": "MatchingFlatSizeSkipDim",
          "old_text": "input_shape.DimensionsCount()",
          "new_text": "MatchingFlatSizeSkipDim(input_shape, trailing_dim, output_shape)",
          "old_line_content": "  const int trailing_dim = input_shape.DimensionsCount() - 1;",
          "new_line_content": "      MatchingFlatSizeSkipDim(input_shape, trailing_dim, output_shape);",
          "content_same": false
        },
        {
          "line": 84,
          "old_api": "MatchingFlatSizeSkipDim",
          "new_api": "MatchingDim",
          "old_text": "MatchingFlatSizeSkipDim(input_shape, trailing_dim, output_shape)",
          "new_text": "MatchingDim(input_shape, trailing_dim, output_shape, trailing_dim)",
          "old_line_content": "      MatchingFlatSizeSkipDim(input_shape, trailing_dim, output_shape);",
          "new_line_content": "      MatchingDim(input_shape, trailing_dim, output_shape, trailing_dim);",
          "content_same": false
        },
        {
          "line": 103,
          "old_api": "FixedPointScaledDiff::FromRaw(input_diff_rescaled)",
          "new_api": "exp_on_negative_values",
          "old_text": "FixedPointScaledDiff::FromRaw(input_diff_rescaled)",
          "new_text": "exp_on_negative_values(scaled_diff_f8)",
          "old_line_content": "            FixedPointScaledDiff::FromRaw(input_diff_rescaled);",
          "new_line_content": "                                        exp_on_negative_values(scaled_diff_f8));",
          "content_same": false
        },
        {
          "line": 121,
          "old_api": "FixedPointScaledDiff::FromRaw(input_diff_rescaled)",
          "new_api": "exp_on_negative_values",
          "old_text": "FixedPointScaledDiff::FromRaw(input_diff_rescaled)",
          "new_text": "exp_on_negative_values(scaled_diff_f8)",
          "old_line_content": "            FixedPointScaledDiff::FromRaw(input_diff_rescaled);",
          "new_line_content": "        FixedPoint0 exp_in_0 = exp_on_negative_values(scaled_diff_f8);",
          "content_same": false
        },
        {
          "line": 123,
          "old_api": "exp_on_negative_values",
          "new_api": "raw",
          "old_text": "exp_on_negative_values(scaled_diff_f8)",
          "new_text": "shifted_scale * exp_in_0).raw()",
          "old_line_content": "        FixedPoint0 exp_in_0 = exp_on_negative_values(scaled_diff_f8);",
          "new_line_content": "            (shifted_scale * exp_in_0).raw(), num_bits_over_unit + 31 - 8);",
          "content_same": false
        },
        {
          "line": 125,
          "old_api": "raw",
          "new_api": "static_cast<uint8>(\n            std::max(std::min(unsat_output, static_cast<int32>(255)),\n                     static_cast<int32>(0)))",
          "old_text": "shifted_scale * exp_in_0).raw()",
          "new_text": "static_cast<uint8>(\n            std::max(std::min(unsat_output, static_cast<int32>(255)),\n                     static_cast<int32>(0)))",
          "old_line_content": "            (shifted_scale * exp_in_0).raw(), num_bits_over_unit + 31 - 8);",
          "new_line_content": "        output_data[i * depth + c] = static_cast<uint8>(",
          "content_same": false
        },
        {
          "line": 127,
          "old_api": "static_cast<uint8>(\n            std::max(std::min(unsat_output, static_cast<int32>(255)),\n                     static_cast<int32>(0)))",
          "new_api": "static_cast<int32>(0)",
          "old_text": "static_cast<uint8>(\n            std::max(std::min(unsat_output, static_cast<int32>(255)),\n                     static_cast<int32>(0)))",
          "new_text": "static_cast<int32>(0)",
          "old_line_content": "        output_data[i * depth + c] = static_cast<uint8>(",
          "new_line_content": "                     static_cast<int32>(0)));",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 98,
          "old_api": null,
          "new_api": "MultiplyByQuantizedMultiplierGreaterThanOne",
          "old_text": null,
          "new_text": "MultiplyByQuantizedMultiplierGreaterThanOne(\n                input_diff, input_beta_multiplier, input_beta_left_shift)",
          "old_line_content": "      if (input_diff >= diff_min) {",
          "new_line_content": "            MultiplyByQuantizedMultiplierGreaterThanOne(",
          "content_same": false
        },
        {
          "line": 101,
          "old_api": null,
          "new_api": "FixedPointScaledDiff::FromRaw(input_diff_rescaled)",
          "old_text": null,
          "new_text": "FixedPointScaledDiff::FromRaw(input_diff_rescaled)",
          "old_line_content": "                input_diff, input_beta_multiplier, input_beta_left_shift);",
          "new_line_content": "            FixedPointScaledDiff::FromRaw(input_diff_rescaled);",
          "content_same": false
        },
        {
          "line": 102,
          "old_api": null,
          "new_api": "gemmlowp::Rescale<kAccumulationIntegerBits>(\n                                        exp_on_negative_values(scaled_diff_f8))",
          "old_text": null,
          "new_text": "gemmlowp::Rescale<kAccumulationIntegerBits>(\n                                        exp_on_negative_values(scaled_diff_f8))",
          "old_line_content": "        const FixedPointScaledDiff scaled_diff_f8 =",
          "new_line_content": "        sum_of_exps = sum_of_exps + gemmlowp::Rescale<kAccumulationIntegerBits>(",
          "content_same": false
        },
        {
          "line": 122,
          "old_api": null,
          "new_api": "raw",
          "old_text": null,
          "new_text": "gemmlowp::RoundingDivideByPOT(\n            (shifted_scale * exp_in_0).raw(), num_bits_over_unit + 31 - 8)",
          "old_line_content": "",
          "new_line_content": "        int32 unsat_output = gemmlowp::RoundingDivideByPOT(",
          "content_same": false
        },
        {
          "line": 108,
          "old_api": null,
          "new_api": "raw",
          "old_text": null,
          "new_text": "GetReciprocal(\n        sum_of_exps.raw(), kAccumulationIntegerBits, &num_bits_over_unit)",
          "old_line_content": "",
          "new_line_content": "    FixedPoint0 shifted_scale = FixedPoint0::FromRaw(GetReciprocal(",
          "content_same": false
        },
        {
          "line": 109,
          "old_api": null,
          "new_api": "raw",
          "old_text": null,
          "new_text": "sum_of_exps.raw()",
          "old_line_content": "    int num_bits_over_unit;",
          "new_line_content": "        sum_of_exps.raw(), kAccumulationIntegerBits, &num_bits_over_unit));",
          "content_same": false
        },
        {
          "line": 80,
          "old_api": null,
          "new_api": "DimensionsCount",
          "old_text": null,
          "new_text": "input_shape.DimensionsCount()",
          "old_line_content": "  using FixedPoint0 = gemmlowp::FixedPoint<int32, 0>;",
          "new_line_content": "  const int trailing_dim = input_shape.DimensionsCount() - 1;",
          "content_same": false
        },
        {
          "line": 49,
          "old_api": null,
          "new_api": "std::exp((input_data[i * depth + c] - max) *\n                      static_cast<float>(params.beta))",
          "old_text": null,
          "new_text": "std::exp((input_data[i * depth + c] - max) *\n                      static_cast<float>(params.beta))",
          "old_line_content": "    for (int c = 0; c < depth; ++c) {",
          "new_line_content": "      sum += std::exp((input_data[i * depth + c] - max) *",
          "content_same": false
        },
        {
          "line": 113,
          "old_api": null,
          "new_api": "static_cast<int32>(input_data[i * depth + c])",
          "old_text": null,
          "new_text": "static_cast<int32>(input_data[i * depth + c])",
          "old_line_content": "    for (int c = 0; c < depth; ++c) {",
          "new_line_content": "          static_cast<int32>(input_data[i * depth + c]) - max_in_row;",
          "content_same": false
        },
        {
          "line": 116,
          "old_api": null,
          "new_api": "MultiplyByQuantizedMultiplierGreaterThanOne",
          "old_text": null,
          "new_text": "MultiplyByQuantizedMultiplierGreaterThanOne(\n                input_diff, input_beta_multiplier, input_beta_left_shift)",
          "old_line_content": "      if (input_diff >= diff_min) {",
          "new_line_content": "            MultiplyByQuantizedMultiplierGreaterThanOne(",
          "content_same": false
        },
        {
          "line": 119,
          "old_api": null,
          "new_api": "FixedPointScaledDiff::FromRaw(input_diff_rescaled)",
          "old_text": null,
          "new_text": "FixedPointScaledDiff::FromRaw(input_diff_rescaled)",
          "old_line_content": "                input_diff, input_beta_multiplier, input_beta_left_shift);",
          "new_line_content": "            FixedPointScaledDiff::FromRaw(input_diff_rescaled);",
          "content_same": false
        },
        {
          "line": 55,
          "old_api": null,
          "new_api": "std::exp((input_data[i * depth + c] - max) *\n                                            static_cast<float>(params.beta))",
          "old_text": null,
          "new_text": "std::exp((input_data[i * depth + c] - max) *\n                                            static_cast<float>(params.beta))",
          "old_line_content": "    for (int c = 0; c < depth; ++c) {",
          "new_line_content": "      output_data[i * depth + c] = std::exp((input_data[i * depth + c] - max) *",
          "content_same": false
        },
        {
          "line": 152,
          "old_api": null,
          "new_api": "std::exp((in[i] - max_coeff) * beta)",
          "old_text": null,
          "new_text": "std::exp((in[i] - max_coeff) * beta)",
          "old_line_content": "    float exp_sum = 0.0;",
          "new_line_content": "      out[i] = std::exp((in[i] - max_coeff) * beta);",
          "content_same": false
        },
        {
          "line": 89,
          "old_api": null,
          "new_api": "std::max(max_in_row, input_data[i * depth + c])",
          "old_text": null,
          "new_text": "std::max(max_in_row, input_data[i * depth + c])",
          "old_line_content": "    uint8 max_in_row = 0;",
          "new_line_content": "      max_in_row = std::max(max_in_row, input_data[i * depth + c]);",
          "content_same": false
        },
        {
          "line": 56,
          "old_api": null,
          "new_api": "static_cast<float>(params.beta)",
          "old_text": null,
          "new_text": "static_cast<float>(params.beta)",
          "old_line_content": "      output_data[i * depth + c] =",
          "new_line_content": "                                            static_cast<float>(params.beta)) /",
          "content_same": false
        },
        {
          "line": 92,
          "old_api": null,
          "new_api": "FixedPointAccum::Zero()",
          "old_text": null,
          "new_text": "FixedPointAccum::Zero()",
          "old_line_content": "    }",
          "new_line_content": "    FixedPointAccum sum_of_exps = FixedPointAccum::Zero();",
          "content_same": false
        },
        {
          "line": 126,
          "old_api": null,
          "new_api": "static_cast<int32>(255)",
          "old_text": null,
          "new_text": "static_cast<int32>(255)",
          "old_line_content": "",
          "new_line_content": "            std::max(std::min(unsat_output, static_cast<int32>(255)),",
          "content_same": false
        },
        {
          "line": 95,
          "old_api": null,
          "new_api": "static_cast<int32>(input_data[i * depth + c])",
          "old_text": null,
          "new_text": "static_cast<int32>(input_data[i * depth + c])",
          "old_line_content": "    for (int c = 0; c < depth; ++c) {",
          "new_line_content": "          static_cast<int32>(input_data[i * depth + c]) - max_in_row;",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 128,
          "old_api": "static_cast<int32>(255)",
          "new_api": null,
          "old_text": "static_cast<int32>(255)",
          "new_text": null,
          "old_line_content": "            std::max(std::min(unsat_output, static_cast<int32>(255)),",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 129,
          "old_api": "static_cast<int32>(0)",
          "new_api": null,
          "old_text": "static_cast<int32>(0)",
          "new_text": null,
          "old_line_content": "                     static_cast<int32>(0)));",
          "new_line_content": "      } else {",
          "content_same": false
        },
        {
          "line": 97,
          "old_api": "static_cast<int32>(input_data[i * depth + c])",
          "new_api": null,
          "old_text": "static_cast<int32>(input_data[i * depth + c])",
          "new_text": null,
          "old_line_content": "          static_cast<int32>(input_data[i * depth + c]) - max_in_row;",
          "new_line_content": "        const int32 input_diff_rescaled =",
          "content_same": false
        },
        {
          "line": 100,
          "old_api": "MultiplyByQuantizedMultiplierGreaterThanOne",
          "new_api": null,
          "old_text": "MultiplyByQuantizedMultiplierGreaterThanOne(\n                input_diff, input_beta_multiplier, input_beta_left_shift)",
          "new_text": null,
          "old_line_content": "            MultiplyByQuantizedMultiplierGreaterThanOne(",
          "new_line_content": "        const FixedPointScaledDiff scaled_diff_f8 =",
          "content_same": false
        },
        {
          "line": 104,
          "old_api": "gemmlowp::Rescale<kAccumulationIntegerBits>(\n                                        exp_on_negative_values(scaled_diff_f8))",
          "new_api": null,
          "old_text": "gemmlowp::Rescale<kAccumulationIntegerBits>(\n                                        exp_on_negative_values(scaled_diff_f8))",
          "new_text": null,
          "old_line_content": "        sum_of_exps = sum_of_exps + gemmlowp::Rescale<kAccumulationIntegerBits>(",
          "new_line_content": "      }",
          "content_same": false
        },
        {
          "line": 105,
          "old_api": "exp_on_negative_values",
          "new_api": null,
          "old_text": "exp_on_negative_values(scaled_diff_f8)",
          "new_text": null,
          "old_line_content": "                                        exp_on_negative_values(scaled_diff_f8));",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 91,
          "old_api": "std::max(max_in_row, input_data[i * depth + c])",
          "new_api": null,
          "old_text": "std::max(max_in_row, input_data[i * depth + c])",
          "new_text": null,
          "old_line_content": "      max_in_row = std::max(max_in_row, input_data[i * depth + c]);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 110,
          "old_api": "raw",
          "new_api": null,
          "old_text": "GetReciprocal(\n        sum_of_exps.raw(), kAccumulationIntegerBits, &num_bits_over_unit)",
          "new_text": null,
          "old_line_content": "    FixedPoint0 shifted_scale = FixedPoint0::FromRaw(GetReciprocal(",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 111,
          "old_api": "raw",
          "new_api": null,
          "old_text": "sum_of_exps.raw()",
          "new_text": null,
          "old_line_content": "        sum_of_exps.raw(), kAccumulationIntegerBits, &num_bits_over_unit));",
          "new_line_content": "    for (int c = 0; c < depth; ++c) {",
          "content_same": false
        },
        {
          "line": 115,
          "old_api": "static_cast<int32>(input_data[i * depth + c])",
          "new_api": null,
          "old_text": "static_cast<int32>(input_data[i * depth + c])",
          "new_text": null,
          "old_line_content": "          static_cast<int32>(input_data[i * depth + c]) - max_in_row;",
          "new_line_content": "        const int32 input_diff_rescaled =",
          "content_same": false
        },
        {
          "line": 86,
          "old_api": "MatchingDim",
          "new_api": null,
          "old_text": "MatchingDim(input_shape, trailing_dim, output_shape, trailing_dim)",
          "new_text": null,
          "old_line_content": "      MatchingDim(input_shape, trailing_dim, output_shape, trailing_dim);",
          "new_line_content": "  for (int i = 0; i < outer_size; ++i) {",
          "content_same": false
        },
        {
          "line": 118,
          "old_api": "MultiplyByQuantizedMultiplierGreaterThanOne",
          "new_api": null,
          "old_text": "MultiplyByQuantizedMultiplierGreaterThanOne(\n                input_diff, input_beta_multiplier, input_beta_left_shift)",
          "new_text": null,
          "old_line_content": "            MultiplyByQuantizedMultiplierGreaterThanOne(",
          "new_line_content": "        const FixedPointScaledDiff scaled_diff_f8 =",
          "content_same": false
        },
        {
          "line": 57,
          "old_api": "static_cast<double>(input_data[i * depth + c] - max)",
          "new_api": null,
          "old_text": "static_cast<double>(input_data[i * depth + c] - max)",
          "new_text": null,
          "old_line_content": "          std::exp(static_cast<double>(input_data[i * depth + c] - max) *",
          "new_line_content": "                                   sum;",
          "content_same": false
        },
        {
          "line": 154,
          "old_api": "std::exp((in[i] - max_coeff) * beta)",
          "new_api": null,
          "old_text": "std::exp((in[i] - max_coeff) * beta)",
          "new_text": null,
          "old_line_content": "      out[i] = std::exp((in[i] - max_coeff) * beta);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 59,
          "old_api": "static_cast<double>(sum)",
          "new_api": null,
          "old_text": "static_cast<double>(sum)",
          "new_text": null,
          "old_line_content": "          static_cast<double>(sum);",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 124,
          "old_api": "raw",
          "new_api": null,
          "old_text": "gemmlowp::RoundingDivideByPOT(\n            (shifted_scale * exp_in_0).raw(), num_bits_over_unit + 31 - 8)",
          "new_text": null,
          "old_line_content": "        int32 unsat_output = gemmlowp::RoundingDivideByPOT(",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 94,
          "old_api": "FixedPointAccum::Zero()",
          "new_api": null,
          "old_text": "FixedPointAccum::Zero()",
          "new_text": null,
          "old_line_content": "    FixedPointAccum sum_of_exps = FixedPointAccum::Zero();",
          "new_line_content": "      int32 input_diff =",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 8,
      "total_additions": 18,
      "total_deletions": 17,
      "total_api_changes": 43
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 9,
        "api_related_lines": 43,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          58,
          51,
          46
        ]
      }
    },
    "api_calls_before": 35,
    "api_calls_after": 34,
    "diff_info": {
      "added_lines": 5,
      "removed_lines": 7,
      "total_diff_lines": 31
    }
  }
}