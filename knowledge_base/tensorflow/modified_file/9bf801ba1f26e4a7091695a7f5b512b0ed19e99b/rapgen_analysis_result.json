{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/9bf801ba1f26e4a7091695a7f5b512b0ed19e99b",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/9bf801ba1f26e4a7091695a7f5b512b0ed19e99b/before.cc",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/9bf801ba1f26e4a7091695a7f5b512b0ed19e99b/after.cc",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/tensorflow/modified_file/9bf801ba1f26e4a7091695a7f5b512b0ed19e99b/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 115,
          "old_api": "gmentReductionF",
          "new_api": "dex",
          "old_text": "gmentReductionF()(output + output_index, reduce_res);\n",
          "new_text": "dex(OuterDimTileSize);\n",
          "old_line_content": "      SegmentReductionF()(output + output_index, reduce_res);",
          "new_line_content": "        stripe_index / inner_dim_size * Index(OuterDimTileSize);",
          "content_same": false
        },
        {
          "line": 196,
          "old_api": "cur_segment_num));",
          "new_api": "restrict__ o",
          "old_text": "cur_segment_num));",
          "new_text": "restrict__ o",
          "old_line_content": "      CudaAtomicAdd(output + output_index, sum / T(cur_segment_num));",
          "new_line_content": "    const T* __restrict__ input, T* __restrict__ output) {",
          "content_same": false
        },
        {
          "line": 198,
          "old_api": "cur_segment_num);",
          "new_api": "uGridRangeX",
          "old_text": "cur_segment_num);\n",
          "new_text": "uGridRangeX(input_total_size)) ",
          "old_line_content": "      *(output + output_index) = sum / T(cur_segment_num);",
          "new_line_content": "  for (int64 input_index : GpuGridRangeX(input_total_size)) {",
          "content_same": false
        },
        {
          "line": 238,
          "old_api": "size",
          "new_api": "dimension",
          "old_text": "tput.size(), ",
          "new_text": "gment_ids.dimension(0);\n",
          "old_line_content": "  GpuLaunchConfig config = GetGpuLaunchConfig(output.size(), d);",
          "new_line_content": "  const Index input_outer_dim_size = segment_ids.dimension(0);",
          "content_same": false
        },
        {
          "line": 252,
          "old_api": "dimension",
          "new_api": "stream",
          "old_text": "gment_ids.dimension(0);\n",
          "new_text": "stream(),\n",
          "old_line_content": "  const Index input_outer_dim_size = segment_ids.dimension(0);",
          "new_line_content": "      config.block_count, config.thread_per_block, 0, d.stream(),",
          "content_same": false
        },
        {
          "line": 284,
          "old_api": "itialValueF",
          "new_api": "dimension",
          "old_text": "itialValueF()();\n",
          "new_text": "gment_ids.dimension(0);\n",
          "old_line_content": "  const T InitialValue = InitialValueF()();",
          "new_line_content": "  const Index input_outer_dim_size = segment_ids.dimension(0);",
          "content_same": false
        },
        {
          "line": 331,
          "old_api": "x->template eigen_device<GPUDevice>();",
          "new_api": "dimension",
          "old_text": "x->template eigen_device<GPUDevice>();\n",
          "new_text": "gment_ids.dimension(0);\n",
          "old_line_content": "    GPUDevice d = ctx->template eigen_device<GPUDevice>();",
          "new_line_content": "    const int64 input_outer_dim_size = segment_ids.dimension(0);",
          "content_same": false
        },
        {
          "line": 332,
          "old_api": "size",
          "new_api": "dimension",
          "old_text": "tput.size(), ",
          "new_text": "ta.dimension(1);\n",
          "old_line_content": "    GpuLaunchConfig config = GetGpuLaunchConfig(output.size(), d);",
          "new_line_content": "    const int64 input_inner_dim_size = data.dimension(1);",
          "content_same": false
        },
        {
          "line": 333,
          "old_api": "stream",
          "new_api": "dimension",
          "old_text": "uLaunchKernel(\n        SetToValue<T>, config.block_count, config.thread_per_block, 0,\n        d.stream(), output.size(), output.data(), InitialValueF()()));",
          "new_text": "tput.dimension(0);\n",
          "old_line_content": "    TF_CHECK_OK(GpuLaunchKernel(",
          "new_line_content": "    const int64 output_outer_dim_size = output.dimension(0);",
          "content_same": false
        },
        {
          "line": 336,
          "old_api": "size",
          "new_api": "stream",
          "old_text": "ta.size();\n",
          "new_text": "uLaunchKernel(\n        UnsortedSegmentCustomKernel<T, Index, ReductionF>, config.block_count,\n        config.thread_per_block, 0, d.stream(), input_outer_dim_size,\n        input_inner_dim_size, output_outer_dim_size, segment_ids.data(),\n        data.data(), output.data()));",
          "old_line_content": "    const int64 data_size = data.size();",
          "new_line_content": "    TF_CHECK_OK(GpuLaunchKernel(",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 384,
          "old_api": null,
          "new_api": "_CALL_GPU_NUMBER_TYPES",
          "old_text": null,
          "new_text": "_CALL_GPU_NUMBER_TYPES(DEFINE_SUM_GPU_SPECS);\n",
          "old_line_content": "#define DEFINE_SUM_UNSORTED_GPU_SPECS_INDEX(T, Index) \\",
          "new_line_content": "TF_CALL_GPU_NUMBER_TYPES(DEFINE_SUM_GPU_SPECS);",
          "content_same": false
        },
        {
          "line": 385,
          "old_api": null,
          "new_api": "_CALL_int32",
          "old_text": null,
          "new_text": "_CALL_int32(DEFINE_SUM_GPU_SPECS);\n",
          "old_line_content": "  template struct UnsortedSegmentFunctor<             \\",
          "new_line_content": "TF_CALL_int32(DEFINE_SUM_GPU_SPECS);",
          "content_same": false
        },
        {
          "line": 389,
          "old_api": null,
          "new_api": "_CALL_COMPLEX_TYPES",
          "old_text": null,
          "new_text": "_CALL_COMPLEX_TYPES(DEFINE_SUM_GPU_SPECS);\n",
          "old_line_content": "  DEFINE_REAL_UNSORTED_GPU_SPECS_INDEX(T, int32); \\",
          "new_line_content": "TF_CALL_COMPLEX_TYPES(DEFINE_SUM_GPU_SPECS);",
          "content_same": false
        },
        {
          "line": 265,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "tput.size() =",
          "old_line_content": "      SortedSegmentMeanCustomKernel<T, Index, OuterDimTileSize>,",
          "new_line_content": "  if (output.size() == 0) {",
          "content_same": false
        },
        {
          "line": 269,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "tput.size(), ",
          "old_line_content": "}",
          "new_line_content": "  GpuLaunchConfig config = GetGpuLaunchConfig(output.size(), d);",
          "content_same": false
        },
        {
          "line": 270,
          "old_api": null,
          "new_api": "itialValueF",
          "old_text": null,
          "new_text": "itialValueF()();\n",
          "old_line_content": "",
          "new_line_content": "  const T InitialValue = InitialValueF()();",
          "content_same": false
        },
        {
          "line": 271,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "uLaunchKernel(SetToValue<T>, config.block_count,\n                              config.thread_per_block, 0, d.stream(),\n                              output.size(), output.data(), InitialValue));",
          "old_line_content": "template <typename T, typename Index, typename InitialValueF,",
          "new_line_content": "  TF_CHECK_OK(GpuLaunchKernel(SetToValue<T>, config.block_count,",
          "content_same": false
        },
        {
          "line": 272,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "stream(),\n",
          "old_line_content": "          typename SegmentReductionF, typename SegmentAtomicReductionF>",
          "new_line_content": "                              config.thread_per_block, 0, d.stream(),",
          "content_same": false
        },
        {
          "line": 273,
          "old_api": null,
          "new_api": "data",
          "old_text": null,
          "new_text": "tput.data(), ",
          "old_line_content": "void SegmentReductionFunctor<T, Index, InitialValueF, SegmentReductionF,",
          "new_line_content": "                              output.size(), output.data(), InitialValue));",
          "content_same": false
        },
        {
          "line": 274,
          "old_api": null,
          "new_api": "num_elements",
          "old_text": null,
          "new_text": "gment_ids_shape.num_elements() =",
          "old_line_content": "                             SegmentAtomicReductionF>::operator()(",
          "new_line_content": "  if (data_size == 0 || segment_ids_shape.num_elements() == 0) {",
          "content_same": false
        },
        {
          "line": 149,
          "old_api": null,
          "new_api": "cur_segment_num));",
          "old_text": null,
          "new_text": "cur_segment_num));",
          "old_line_content": "      if (current_output_segment_id > last_output_segment_id) {",
          "new_line_content": "          GpuAtomicAdd(output + output_index, sum / T(cur_segment_num));",
          "content_same": false
        },
        {
          "line": 151,
          "old_api": null,
          "new_api": "cur_segment_num);",
          "old_text": null,
          "new_text": "cur_segment_num);\n",
          "old_line_content": "            last_output_segment_id * inner_dim_size + segment_offset;",
          "new_line_content": "          *(output + output_index) = sum / T(cur_segment_num);",
          "content_same": false
        },
        {
          "line": 153,
          "old_api": null,
          "new_api": "0);",
          "old_text": null,
          "new_text": "0);\n",
          "old_line_content": "        // operations",
          "new_line_content": "        sum = T(0);",
          "content_same": false
        },
        {
          "line": 156,
          "old_api": null,
          "new_api": "g",
          "old_text": null,
          "new_text": "g(input + (input_outer_dim_index_base + j) * inner_dim_size +\n                 segment_offset);\n",
          "old_line_content": "          for (Index k = 1; input_outer_dim_index_base - k >= 0; k++) {",
          "new_line_content": "      sum += ldg(input + (input_outer_dim_index_base + j) * inner_dim_size +",
          "content_same": false
        },
        {
          "line": 290,
          "old_api": null,
          "new_api": "dex",
          "old_text": null,
          "new_text": "dex(OuterDimTileSize));",
          "old_line_content": "  }",
          "new_line_content": "      Eigen::divup(input_outer_dim_size, Index(OuterDimTileSize));",
          "content_same": false
        },
        {
          "line": 295,
          "old_api": null,
          "new_api": "tGpuLaunchConfig",
          "old_text": null,
          "new_text": "tGpuLaunchConfig(total_stripe_count, d);\n",
          "old_line_content": "  // *) 'segment_ids.shape' is a prefix of data's shape.",
          "new_line_content": "  config = GetGpuLaunchConfig(total_stripe_count, d);",
          "content_same": false
        },
        {
          "line": 296,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "uLaunchKernel(\n      SortedSegmentReductionCustomKernel<T, Index, OuterDimTileSize,\n                                         SegmentReductionF,\n                                         SegmentAtomicReductionF>,\n      config.block_count, config.thread_per_block, 0, d.stream(),\n      input_outer_dim_size, input_inner_dim_size, output_rows,\n      segment_ids.data(), data, output.data(), total_stripe_count,\n      InitialValue));",
          "old_line_content": "  // *) 'input_outer_dim_size' is the total number of segments to process.",
          "new_line_content": "  TF_CHECK_OK(GpuLaunchKernel(",
          "content_same": false
        },
        {
          "line": 300,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "stream(),\n",
          "old_line_content": "",
          "new_line_content": "      config.block_count, config.thread_per_block, 0, d.stream(),",
          "content_same": false
        },
        {
          "line": 302,
          "old_api": null,
          "new_api": "data",
          "old_text": null,
          "new_text": "tput.data(), ",
          "old_line_content": "",
          "new_line_content": "      segment_ids.data(), data, output.data(), total_stripe_count,",
          "content_same": false
        },
        {
          "line": 182,
          "old_api": null,
          "new_api": "cur_segment_num));",
          "old_text": null,
          "new_text": "cur_segment_num));",
          "old_line_content": "          ? true : false;",
          "new_line_content": "      CudaAtomicAdd(output + output_index, sum / T(cur_segment_num));",
          "content_same": false
        },
        {
          "line": 184,
          "old_api": null,
          "new_api": "cur_segment_num);",
          "old_text": null,
          "new_text": "cur_segment_num);\n",
          "old_line_content": "        last_output_segment_id * inner_dim_size + segment_offset;",
          "new_line_content": "      *(output + output_index) = sum / T(cur_segment_num);",
          "content_same": false
        },
        {
          "line": 313,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "tput.size() =",
          "old_line_content": "                                         SegmentAtomicReductionF>,",
          "new_line_content": "    if (output.size() == 0) {",
          "content_same": false
        },
        {
          "line": 317,
          "old_api": null,
          "new_api": "x->template eigen_device<GPUDevice>();",
          "old_text": null,
          "new_text": "x->template eigen_device<GPUDevice>();\n",
          "old_line_content": "      InitialValue));",
          "new_line_content": "    GPUDevice d = ctx->template eigen_device<GPUDevice>();",
          "content_same": false
        },
        {
          "line": 318,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "tput.size(), ",
          "old_line_content": "}",
          "new_line_content": "    GpuLaunchConfig config = GetGpuLaunchConfig(output.size(), d);",
          "content_same": false
        },
        {
          "line": 319,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "uLaunchKernel(\n        SetToValue<T>, config.block_count, config.thread_per_block, 0,\n        d.stream(), output.size(), output.data(), InitialValueF()()));",
          "old_line_content": "",
          "new_line_content": "    TF_CHECK_OK(GpuLaunchKernel(",
          "content_same": false
        },
        {
          "line": 321,
          "old_api": null,
          "new_api": "itialValueF",
          "old_text": null,
          "new_text": "itialValueF()()))",
          "old_line_content": "          typename ReductionF>",
          "new_line_content": "        d.stream(), output.size(), output.data(), InitialValueF()()));",
          "content_same": false
        },
        {
          "line": 322,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "ta.size();\n",
          "old_line_content": "struct UnsortedSegmentFunctor<GPUDevice, T, Index, InitialValueF, ReductionF> {",
          "new_line_content": "    const int64 data_size = data.size();",
          "content_same": false
        },
        {
          "line": 195,
          "old_api": null,
          "new_api": "restrict__ s",
          "old_text": null,
          "new_text": "restrict__ s",
          "old_line_content": "      cur_segment_num += after_segment_num;",
          "new_line_content": "    const int64 output_outer_dim_size, const Index* __restrict__ segment_ids,",
          "content_same": false
        },
        {
          "line": 323,
          "old_api": null,
          "new_api": "num_elements",
          "old_text": null,
          "new_text": "gment_ids_shape.num_elements() =",
          "old_line_content": "  void operator()(OpKernelContext* ctx, const TensorShape& segment_ids_shape,",
          "new_line_content": "    if (data_size == 0 || segment_ids_shape.num_elements() == 0) {",
          "content_same": false
        },
        {
          "line": 71,
          "old_api": null,
          "new_api": "dex",
          "old_text": null,
          "new_text": "dex(OuterDimTileSize),\n",
          "old_line_content": "        ? true : false;",
          "new_line_content": "        min(Index(OuterDimTileSize),",
          "content_same": false
        },
        {
          "line": 334,
          "old_api": null,
          "new_api": "tGpuLaunchConfig",
          "old_text": null,
          "new_text": "tGpuLaunchConfig(data_size, d);\n",
          "old_line_content": "        SetToValue<T>, config.block_count, config.thread_per_block, 0,",
          "new_line_content": "    config = GetGpuLaunchConfig(data_size, d);",
          "content_same": false
        },
        {
          "line": 208,
          "old_api": null,
          "new_api": "g",
          "old_text": null,
          "new_text": "g(input + input_index));",
          "old_line_content": "    const int64 input_outer_dim_size, const int64 inner_dim_size,",
          "new_line_content": "    KernelReductionFunctor()(output + output_index, ldg(input + input_index));",
          "content_same": false
        },
        {
          "line": 338,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "stream(), ",
          "old_line_content": "      return;",
          "new_line_content": "        config.thread_per_block, 0, d.stream(), input_outer_dim_size,",
          "content_same": false
        },
        {
          "line": 339,
          "old_api": null,
          "new_api": "data",
          "old_text": null,
          "new_text": "gment_ids.data(),\n",
          "old_line_content": "    }",
          "new_line_content": "        input_inner_dim_size, output_outer_dim_size, segment_ids.data(),",
          "content_same": false
        },
        {
          "line": 340,
          "old_api": null,
          "new_api": "data",
          "old_text": null,
          "new_text": "tput.data()))",
          "old_line_content": "    // Launch kernel to compute unsorted segment reduction.",
          "new_line_content": "        data.data(), output.data()));",
          "content_same": false
        },
        {
          "line": 86,
          "old_api": null,
          "new_api": "gmentAtomicReductionF",
          "old_text": null,
          "new_text": "gmentAtomicReductionF()(output + output_index, reduce_res);\n",
          "old_line_content": "        // decide whether to write result to global memory using atomic",
          "new_line_content": "          SegmentAtomicReductionF()(output + output_index, reduce_res);",
          "content_same": false
        },
        {
          "line": 88,
          "old_api": null,
          "new_api": "gmentReductionF",
          "old_text": null,
          "new_text": "gmentReductionF()(output + output_index, reduce_res);\n",
          "old_line_content": "        if (last_output_segment_id == first_segment_id && is_first_has_race) {",
          "new_line_content": "          SegmentReductionF()(output + output_index, reduce_res);",
          "content_same": false
        },
        {
          "line": 92,
          "old_api": null,
          "new_api": "gmentReductionF",
          "old_text": null,
          "new_text": "gmentReductionF()(&reduce_res,\n                          ldg(input + (input_outer_dim_index_base + j) \\\n                              * inner_dim_size + segment_offset));\n",
          "old_line_content": "        }",
          "new_line_content": "      SegmentReductionF()(&reduce_res,",
          "content_same": false
        },
        {
          "line": 93,
          "old_api": null,
          "new_api": "g",
          "old_text": null,
          "new_text": "g(input + (input_outer_dim_index_base + j) \\\n                              * inner_dim_size + segment_offset));",
          "old_line_content": "        reduce_res = initial_value;",
          "new_line_content": "                          ldg(input + (input_outer_dim_index_base + j) \\",
          "content_same": false
        },
        {
          "line": 220,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "tput.size() =",
          "old_line_content": "    const int64 output_index =",
          "new_line_content": "  if (output.size() == 0) {",
          "content_same": false
        },
        {
          "line": 224,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "tput.size(), ",
          "old_line_content": "}",
          "new_line_content": "  GpuLaunchConfig config = GetGpuLaunchConfig(output.size(), d);",
          "content_same": false
        },
        {
          "line": 225,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "uLaunchKernel(SetZero<T>, config.block_count,\n                              config.thread_per_block, 0, d.stream(),\n                              output.size(), output.data()));",
          "old_line_content": "",
          "new_line_content": "  TF_CHECK_OK(GpuLaunchKernel(SetZero<T>, config.block_count,",
          "content_same": false
        },
        {
          "line": 226,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "stream(),\n",
          "old_line_content": "namespace functor {",
          "new_line_content": "                              config.thread_per_block, 0, d.stream(),",
          "content_same": false
        },
        {
          "line": 227,
          "old_api": null,
          "new_api": "data",
          "old_text": null,
          "new_text": "tput.data()))",
          "old_line_content": "",
          "new_line_content": "                              output.size(), output.data()));",
          "content_same": false
        },
        {
          "line": 228,
          "old_api": null,
          "new_api": "num_elements",
          "old_text": null,
          "new_text": "gment_ids_shape.num_elements() =",
          "old_line_content": "template <typename T, typename Index>",
          "new_line_content": "  if (data_size == 0 || segment_ids_shape.num_elements() == 0) {",
          "content_same": false
        },
        {
          "line": 102,
          "old_api": null,
          "new_api": "gmentAtomicReductionF",
          "old_text": null,
          "new_text": "gmentAtomicReductionF()(output + output_index, reduce_res);\n",
          "old_line_content": "    // the following strip.",
          "new_line_content": "    SegmentAtomicReductionF()(output + output_index, reduce_res);",
          "content_same": false
        },
        {
          "line": 359,
          "old_api": null,
          "new_api": "_CALL_GPU_NUMBER_TYPES",
          "old_text": null,
          "new_text": "_CALL_GPU_NUMBER_TYPES(DEFINE_SORTED_GPU_SPECS);\n",
          "old_line_content": "  template struct SegmentMeanFunctor<T, Index>;                                \\",
          "new_line_content": "TF_CALL_GPU_NUMBER_TYPES(DEFINE_SORTED_GPU_SPECS);",
          "content_same": false
        },
        {
          "line": 109,
          "old_api": null,
          "new_api": "restrict__ s",
          "old_text": null,
          "new_text": "restrict__ s",
          "old_line_content": "          ? true : false;",
          "new_line_content": "    const Index output_outer_dim_size, const Index* __restrict__ segment_ids,",
          "content_same": false
        },
        {
          "line": 110,
          "old_api": null,
          "new_api": "restrict__ o",
          "old_text": null,
          "new_text": "restrict__ o",
          "old_line_content": "    const Index output_index =",
          "new_line_content": "    const T* __restrict__ input, T* __restrict__ output,",
          "content_same": false
        },
        {
          "line": 112,
          "old_api": null,
          "new_api": "uGridRangeX",
          "old_text": null,
          "new_text": "uGridRangeX(total_stripe_count)) ",
          "old_line_content": "    if (is_last_has_race) {",
          "new_line_content": "  for (int stripe_index : GpuGridRangeX(total_stripe_count)) {",
          "content_same": false
        },
        {
          "line": 244,
          "old_api": null,
          "new_api": "dex",
          "old_text": null,
          "new_text": "dex(OuterDimTileSize));",
          "old_line_content": "  }",
          "new_line_content": "      Eigen::divup(input_outer_dim_size, Index(OuterDimTileSize));",
          "content_same": false
        },
        {
          "line": 117,
          "old_api": null,
          "new_api": "0);",
          "old_text": null,
          "new_text": "0);\n",
          "old_line_content": "  }",
          "new_line_content": "    T sum = T(0);",
          "content_same": false
        },
        {
          "line": 254,
          "old_api": null,
          "new_api": "data",
          "old_text": null,
          "new_text": "tput.data(), ",
          "old_line_content": "",
          "new_line_content": "      segment_ids.data(), data, output.data(), total_stripe_count));",
          "content_same": false
        },
        {
          "line": 249,
          "old_api": null,
          "new_api": "tGpuLaunchConfig",
          "old_text": null,
          "new_text": "tGpuLaunchConfig(total_stripe_count, d);\n",
          "old_line_content": "  // *) 'segment_ids.shape' is a prefix of data's shape.",
          "new_line_content": "  config = GetGpuLaunchConfig(total_stripe_count, d);",
          "content_same": false
        },
        {
          "line": 250,
          "old_api": null,
          "new_api": "stream",
          "old_text": null,
          "new_text": "uLaunchKernel(\n      SortedSegmentMeanCustomKernel<T, Index, OuterDimTileSize>,\n      config.block_count, config.thread_per_block, 0, d.stream(),\n      input_outer_dim_size, input_inner_dim_size, output_rows,\n      segment_ids.data(), data, output.data(), total_stripe_count));",
          "old_line_content": "  // *) 'input_outer_dim_size' is the total number of segments to process.",
          "new_line_content": "  TF_CHECK_OK(GpuLaunchKernel(",
          "content_same": false
        },
        {
          "line": 125,
          "old_api": null,
          "new_api": "dex",
          "old_text": null,
          "new_text": "dex(OuterDimTileSize),\n",
          "old_line_content": "    const Index total_stripe_count) {",
          "new_line_content": "        min(Index(OuterDimTileSize),",
          "content_same": false
        },
        {
          "line": 382,
          "old_api": null,
          "new_api": "_CALL_GPU_NUMBER_TYPES",
          "old_text": null,
          "new_text": "_CALL_GPU_NUMBER_TYPES(DEFINE_REAL_GPU_SPECS);\n",
          "old_line_content": "",
          "new_line_content": "TF_CALL_GPU_NUMBER_TYPES(DEFINE_REAL_GPU_SPECS);",
          "content_same": false
        },
        {
          "line": 383,
          "old_api": null,
          "new_api": "_CALL_int32",
          "old_text": null,
          "new_text": "_CALL_int32(DEFINE_REAL_GPU_SPECS);\n",
          "old_line_content": "// sum is the only op that supports all input types currently",
          "new_line_content": "TF_CALL_int32(DEFINE_REAL_GPU_SPECS);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 129,
          "old_api": "dex",
          "new_api": null,
          "old_text": "dex(OuterDimTileSize);\n",
          "new_text": null,
          "old_line_content": "        stripe_index / inner_dim_size * Index(OuterDimTileSize);",
          "new_line_content": "      Index current_output_segment_id =",
          "content_same": false
        },
        {
          "line": 258,
          "old_api": "dex",
          "new_api": null,
          "old_text": "dex(OuterDimTileSize));",
          "new_text": null,
          "old_line_content": "      Eigen::divup(input_outer_dim_size, Index(OuterDimTileSize));",
          "new_line_content": "          typename SegmentReductionF, typename SegmentAtomicReductionF>",
          "content_same": false
        },
        {
          "line": 131,
          "old_api": "0);",
          "new_api": null,
          "old_text": "0);\n",
          "new_text": null,
          "old_line_content": "    T sum = T(0);",
          "new_line_content": "      // Decide whether to write result to global memory.",
          "content_same": false
        },
        {
          "line": 263,
          "old_api": "tGpuLaunchConfig",
          "new_api": null,
          "old_text": "tGpuLaunchConfig(total_stripe_count, d);\n",
          "new_text": null,
          "old_line_content": "  config = GetGpuLaunchConfig(total_stripe_count, d);",
          "new_line_content": "    typename TTypes<Index>::ConstFlat segment_ids, const Index data_size,",
          "content_same": false
        },
        {
          "line": 264,
          "old_api": "stream",
          "new_api": null,
          "old_text": "uLaunchKernel(\n      SortedSegmentMeanCustomKernel<T, Index, OuterDimTileSize>,\n      config.block_count, config.thread_per_block, 0, d.stream(),\n      input_outer_dim_size, input_inner_dim_size, output_rows,\n      segment_ids.data(), data, output.data(), total_stripe_count));",
          "new_text": null,
          "old_line_content": "  TF_CHECK_OK(GpuLaunchKernel(",
          "new_line_content": "    const T* data, typename TTypes<T, 2>::Tensor output) {",
          "content_same": false
        },
        {
          "line": 266,
          "old_api": "stream",
          "new_api": null,
          "old_text": "stream(),\n",
          "new_text": null,
          "old_line_content": "      config.block_count, config.thread_per_block, 0, d.stream(),",
          "new_line_content": "    return;",
          "content_same": false
        },
        {
          "line": 139,
          "old_api": "dex",
          "new_api": null,
          "old_text": "dex(OuterDimTileSize),\n",
          "new_text": null,
          "old_line_content": "        min(Index(OuterDimTileSize),",
          "new_line_content": "        // operations",
          "content_same": false
        },
        {
          "line": 268,
          "old_api": "data",
          "new_api": null,
          "old_text": "tput.data(), ",
          "new_text": null,
          "old_line_content": "      segment_ids.data(), data, output.data(), total_stripe_count));",
          "new_line_content": "  // Set 'output' to initial value.",
          "content_same": false
        },
        {
          "line": 396,
          "old_api": "_CALL_GPU_NUMBER_TYPES",
          "new_api": null,
          "old_text": "_CALL_GPU_NUMBER_TYPES(DEFINE_REAL_GPU_SPECS);\n",
          "new_text": null,
          "old_line_content": "TF_CALL_GPU_NUMBER_TYPES(DEFINE_REAL_GPU_SPECS);",
          "new_line_content": "#undef DEFINE_REAL_GPU_SPECS",
          "content_same": false
        },
        {
          "line": 397,
          "old_api": "_CALL_int32",
          "new_api": null,
          "old_text": "_CALL_int32(DEFINE_REAL_GPU_SPECS);\n",
          "new_text": null,
          "old_line_content": "TF_CALL_int32(DEFINE_REAL_GPU_SPECS);",
          "new_line_content": "#undef DEFINE_SUM_GPU_SPECS",
          "content_same": false
        },
        {
          "line": 398,
          "old_api": "_CALL_GPU_NUMBER_TYPES",
          "new_api": null,
          "old_text": "_CALL_GPU_NUMBER_TYPES(DEFINE_SUM_GPU_SPECS);\n",
          "new_text": null,
          "old_line_content": "TF_CALL_GPU_NUMBER_TYPES(DEFINE_SUM_GPU_SPECS);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 399,
          "old_api": "_CALL_int32",
          "new_api": null,
          "old_text": "_CALL_int32(DEFINE_SUM_GPU_SPECS);\n",
          "new_text": null,
          "old_line_content": "TF_CALL_int32(DEFINE_SUM_GPU_SPECS);",
          "new_line_content": "}  // namespace functor",
          "content_same": false
        },
        {
          "line": 403,
          "old_api": "_CALL_COMPLEX_TYPES",
          "new_api": null,
          "old_text": "_CALL_COMPLEX_TYPES(DEFINE_SUM_GPU_SPECS);\n",
          "new_text": null,
          "old_line_content": "TF_CALL_COMPLEX_TYPES(DEFINE_SUM_GPU_SPECS);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 279,
          "old_api": "size",
          "new_api": null,
          "old_text": "tput.size() =",
          "new_text": null,
          "old_line_content": "  if (output.size() == 0) {",
          "new_line_content": "  // Notes:",
          "content_same": false
        },
        {
          "line": 283,
          "old_api": "size",
          "new_api": null,
          "old_text": "tput.size(), ",
          "new_text": null,
          "old_line_content": "  GpuLaunchConfig config = GetGpuLaunchConfig(output.size(), d);",
          "new_line_content": "  const Index input_total_size = data_size;",
          "content_same": false
        },
        {
          "line": 285,
          "old_api": "stream",
          "new_api": null,
          "old_text": "uLaunchKernel(SetToValue<T>, config.block_count,\n                              config.thread_per_block, 0, d.stream(),\n                              output.size(), output.data(), InitialValue));",
          "new_text": null,
          "old_line_content": "  TF_CHECK_OK(GpuLaunchKernel(SetToValue<T>, config.block_count,",
          "new_line_content": "  const Index input_inner_dim_size = input_total_size / input_outer_dim_size;",
          "content_same": false
        },
        {
          "line": 286,
          "old_api": "stream",
          "new_api": null,
          "old_text": "stream(),\n",
          "new_text": null,
          "old_line_content": "                              config.thread_per_block, 0, d.stream(),",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 287,
          "old_api": "data",
          "new_api": null,
          "old_text": "tput.data(), ",
          "new_text": null,
          "old_line_content": "                              output.size(), output.data(), InitialValue));",
          "new_line_content": "  const int OuterDimTileSize = 8;",
          "content_same": false
        },
        {
          "line": 288,
          "old_api": "num_elements",
          "new_api": null,
          "old_text": "gment_ids_shape.num_elements() =",
          "new_text": null,
          "old_line_content": "  if (data_size == 0 || segment_ids_shape.num_elements() == 0) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 163,
          "old_api": "cur_segment_num));",
          "new_api": null,
          "old_text": "cur_segment_num));",
          "new_text": null,
          "old_line_content": "          GpuAtomicAdd(output + output_index, sum / T(cur_segment_num));",
          "new_line_content": "        input_outer_dim_index_base + actual_stripe_height - 1;",
          "content_same": false
        },
        {
          "line": 165,
          "old_api": "cur_segment_num);",
          "new_api": null,
          "old_text": "cur_segment_num);\n",
          "new_text": null,
          "old_line_content": "          *(output + output_index) = sum / T(cur_segment_num);",
          "new_line_content": "        last_input_outer_dim_index < input_outer_dim_size - 1 \\",
          "content_same": false
        },
        {
          "line": 167,
          "old_api": "0);",
          "new_api": null,
          "old_text": "0);\n",
          "new_text": null,
          "old_line_content": "        sum = T(0);",
          "new_line_content": "             segment_ids[last_input_outer_dim_index + 1] \\",
          "content_same": false
        },
        {
          "line": 170,
          "old_api": "g",
          "new_api": null,
          "old_text": "g(input + (input_outer_dim_index_base + j) * inner_dim_size +\n                 segment_offset);\n",
          "new_text": null,
          "old_line_content": "      sum += ldg(input + (input_outer_dim_index_base + j) * inner_dim_size +",
          "new_line_content": "        last_output_segment_id * inner_dim_size + segment_offset;",
          "content_same": false
        },
        {
          "line": 298,
          "old_api": "dimension",
          "new_api": null,
          "old_text": "gment_ids.dimension(0);\n",
          "new_text": null,
          "old_line_content": "  const Index input_outer_dim_size = segment_ids.dimension(0);",
          "new_line_content": "                                         SegmentReductionF,",
          "content_same": false
        },
        {
          "line": 304,
          "old_api": "dex",
          "new_api": null,
          "old_text": "dex(OuterDimTileSize));",
          "new_text": null,
          "old_line_content": "      Eigen::divup(input_outer_dim_size, Index(OuterDimTileSize));",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 309,
          "old_api": "tGpuLaunchConfig",
          "new_api": null,
          "old_text": "tGpuLaunchConfig(total_stripe_count, d);\n",
          "new_text": null,
          "old_line_content": "  config = GetGpuLaunchConfig(total_stripe_count, d);",
          "new_line_content": "  void operator()(OpKernelContext* ctx, const TensorShape& segment_ids_shape,",
          "content_same": false
        },
        {
          "line": 310,
          "old_api": "stream",
          "new_api": null,
          "old_text": "uLaunchKernel(\n      SortedSegmentReductionCustomKernel<T, Index, OuterDimTileSize,\n                                         SegmentReductionF,\n                                         SegmentAtomicReductionF>,\n      config.block_count, config.thread_per_block, 0, d.stream(),\n      input_outer_dim_size, input_inner_dim_size, output_rows,\n      segment_ids.data(), data, output.data(), total_stripe_count,\n      InitialValue));",
          "new_text": null,
          "old_line_content": "  TF_CHECK_OK(GpuLaunchKernel(",
          "new_line_content": "                  typename TTypes<Index>::ConstFlat segment_ids,",
          "content_same": false
        },
        {
          "line": 314,
          "old_api": "stream",
          "new_api": null,
          "old_text": "stream(),\n",
          "new_text": null,
          "old_line_content": "      config.block_count, config.thread_per_block, 0, d.stream(),",
          "new_line_content": "      return;",
          "content_same": false
        },
        {
          "line": 316,
          "old_api": "data",
          "new_api": null,
          "old_text": "tput.data(), ",
          "new_text": null,
          "old_line_content": "      segment_ids.data(), data, output.data(), total_stripe_count,",
          "new_line_content": "    // Set 'output' to initial value.",
          "content_same": false
        },
        {
          "line": 327,
          "old_api": "size",
          "new_api": null,
          "old_text": "tput.size() =",
          "new_text": null,
          "old_line_content": "    if (output.size() == 0) {",
          "new_line_content": "    // Notes:",
          "content_same": false
        },
        {
          "line": 74,
          "old_api": "dex",
          "new_api": null,
          "old_text": "dex(OuterDimTileSize),\n",
          "new_text": null,
          "old_line_content": "        min(Index(OuterDimTileSize),",
          "new_line_content": "      Index current_output_segment_id =",
          "content_same": false
        },
        {
          "line": 335,
          "old_api": "itialValueF",
          "new_api": null,
          "old_text": "itialValueF()()))",
          "new_text": null,
          "old_line_content": "        d.stream(), output.size(), output.data(), InitialValueF()()));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 209,
          "old_api": "restrict__ s",
          "new_api": null,
          "old_text": "restrict__ s",
          "new_text": null,
          "old_line_content": "    const int64 output_outer_dim_size, const Index* __restrict__ segment_ids,",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 210,
          "old_api": "restrict__ o",
          "new_api": null,
          "old_text": "restrict__ o",
          "new_text": null,
          "old_line_content": "    const T* __restrict__ input, T* __restrict__ output) {",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 337,
          "old_api": "num_elements",
          "new_api": null,
          "old_text": "gment_ids_shape.num_elements() =",
          "new_text": null,
          "old_line_content": "    if (data_size == 0 || segment_ids_shape.num_elements() == 0) {",
          "new_line_content": "        UnsortedSegmentCustomKernel<T, Index, ReductionF>, config.block_count,",
          "content_same": false
        },
        {
          "line": 212,
          "old_api": "uGridRangeX",
          "new_api": null,
          "old_text": "uGridRangeX(input_total_size)) ",
          "new_text": null,
          "old_line_content": "  for (int64 input_index : GpuGridRangeX(input_total_size)) {",
          "new_line_content": "namespace functor {",
          "content_same": false
        },
        {
          "line": 89,
          "old_api": "gmentAtomicReductionF",
          "new_api": null,
          "old_text": "gmentAtomicReductionF()(output + output_index, reduce_res);\n",
          "new_text": null,
          "old_line_content": "          SegmentAtomicReductionF()(output + output_index, reduce_res);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 345,
          "old_api": "dimension",
          "new_api": null,
          "old_text": "gment_ids.dimension(0);\n",
          "new_text": null,
          "old_line_content": "    const int64 input_outer_dim_size = segment_ids.dimension(0);",
          "new_line_content": "  template struct SegmentMeanFunctor<T, Index>;                                \\",
          "content_same": false
        },
        {
          "line": 91,
          "old_api": "gmentReductionF",
          "new_api": null,
          "old_text": "gmentReductionF()(output + output_index, reduce_res);\n",
          "new_text": null,
          "old_line_content": "          SegmentReductionF()(output + output_index, reduce_res);",
          "new_line_content": "      }",
          "content_same": false
        },
        {
          "line": 346,
          "old_api": "dimension",
          "new_api": null,
          "old_text": "ta.dimension(1);\n",
          "new_text": null,
          "old_line_content": "    const int64 input_inner_dim_size = data.dimension(1);",
          "new_line_content": "  template struct SegmentReductionFunctor<T, Index, functor::Zero<T>,          \\",
          "content_same": false
        },
        {
          "line": 347,
          "old_api": "dimension",
          "new_api": null,
          "old_text": "tput.dimension(0);\n",
          "new_text": null,
          "old_line_content": "    const int64 output_outer_dim_size = output.dimension(0);",
          "new_line_content": "      functor::SumOpGpu<T>, functor::SumAtomicOpGpu<T>>;                       \\",
          "content_same": false
        },
        {
          "line": 222,
          "old_api": "g",
          "new_api": null,
          "old_text": "g(input + input_index));",
          "new_text": null,
          "old_line_content": "    KernelReductionFunctor()(output + output_index, ldg(input + input_index));",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 95,
          "old_api": "gmentReductionF",
          "new_api": null,
          "old_text": "gmentReductionF()(&reduce_res,\n                          ldg(input + (input_outer_dim_index_base + j) \\\n                              * inner_dim_size + segment_offset));\n",
          "new_text": null,
          "old_line_content": "      SegmentReductionF()(&reduce_res,",
          "new_line_content": "      last_output_segment_id = current_output_segment_id;",
          "content_same": false
        },
        {
          "line": 96,
          "old_api": "g",
          "new_api": null,
          "old_text": "g(input + (input_outer_dim_index_base + j) \\\n                              * inner_dim_size + segment_offset));",
          "new_text": null,
          "old_line_content": "                          ldg(input + (input_outer_dim_index_base + j) \\",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 348,
          "old_api": "tGpuLaunchConfig",
          "new_api": null,
          "old_text": "tGpuLaunchConfig(data_size, d);\n",
          "new_text": null,
          "old_line_content": "    config = GetGpuLaunchConfig(data_size, d);",
          "new_line_content": "  template struct SegmentReductionFunctor<T, Index, functor::One<T>,           \\",
          "content_same": false
        },
        {
          "line": 350,
          "old_api": "stream",
          "new_api": null,
          "old_text": "uLaunchKernel(\n        UnsortedSegmentCustomKernel<T, Index, ReductionF>, config.block_count,\n        config.thread_per_block, 0, d.stream(), input_outer_dim_size,\n        input_inner_dim_size, output_outer_dim_size, segment_ids.data(),\n        data.data(), output.data()));",
          "new_text": null,
          "old_line_content": "    TF_CHECK_OK(GpuLaunchKernel(",
          "new_line_content": "  template struct SegmentReductionFunctor<T, Index, functor::Highest<T>,       \\",
          "content_same": false
        },
        {
          "line": 352,
          "old_api": "stream",
          "new_api": null,
          "old_text": "stream(), ",
          "new_text": null,
          "old_line_content": "        config.thread_per_block, 0, d.stream(), input_outer_dim_size,",
          "new_line_content": "  template struct SegmentReductionFunctor<T, Index, functor::Lowest<T>,        \\",
          "content_same": false
        },
        {
          "line": 353,
          "old_api": "data",
          "new_api": null,
          "old_text": "gment_ids.data(),\n",
          "new_text": null,
          "old_line_content": "        input_inner_dim_size, output_outer_dim_size, segment_ids.data(),",
          "new_line_content": "      functor::MaxOpGpu<T>, functor::MaxAtomicOpGpu<T>>;",
          "content_same": false
        },
        {
          "line": 354,
          "old_api": "data",
          "new_api": null,
          "old_text": "tput.data()))",
          "new_text": null,
          "old_line_content": "        data.data(), output.data()));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 234,
          "old_api": "size",
          "new_api": null,
          "old_text": "tput.size() =",
          "new_text": null,
          "old_line_content": "  if (output.size() == 0) {",
          "new_line_content": "  // *) 'input_total_size' is the total number of elements to process.",
          "content_same": false
        },
        {
          "line": 239,
          "old_api": "stream",
          "new_api": null,
          "old_text": "uLaunchKernel(SetZero<T>, config.block_count,\n                              config.thread_per_block, 0, d.stream(),\n                              output.size(), output.data()));",
          "new_text": null,
          "old_line_content": "  TF_CHECK_OK(GpuLaunchKernel(SetZero<T>, config.block_count,",
          "new_line_content": "  const Index input_inner_dim_size = input_total_size / input_outer_dim_size;",
          "content_same": false
        },
        {
          "line": 240,
          "old_api": "stream",
          "new_api": null,
          "old_text": "stream(),\n",
          "new_text": null,
          "old_line_content": "                              config.thread_per_block, 0, d.stream(),",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 113,
          "old_api": "gmentAtomicReductionF",
          "new_api": null,
          "old_text": "gmentAtomicReductionF()(output + output_index, reduce_res);\n",
          "new_text": null,
          "old_line_content": "      SegmentAtomicReductionF()(output + output_index, reduce_res);",
          "new_line_content": "    const Index segment_offset = stripe_index % inner_dim_size;",
          "content_same": false
        },
        {
          "line": 241,
          "old_api": "data",
          "new_api": null,
          "old_text": "tput.data()))",
          "new_text": null,
          "old_line_content": "                              output.size(), output.data()));",
          "new_line_content": "  const int OuterDimTileSize = 8;",
          "content_same": false
        },
        {
          "line": 242,
          "old_api": "num_elements",
          "new_api": null,
          "old_text": "gment_ids_shape.num_elements() =",
          "new_text": null,
          "old_line_content": "  if (data_size == 0 || segment_ids_shape.num_elements() == 0) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 373,
          "old_api": "_CALL_GPU_NUMBER_TYPES",
          "new_api": null,
          "old_text": "_CALL_GPU_NUMBER_TYPES(DEFINE_SORTED_GPU_SPECS);\n",
          "new_text": null,
          "old_line_content": "TF_CALL_GPU_NUMBER_TYPES(DEFINE_SORTED_GPU_SPECS);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 123,
          "old_api": "restrict__ s",
          "new_api": null,
          "old_text": "restrict__ s",
          "new_text": null,
          "old_line_content": "    const Index output_outer_dim_size, const Index* __restrict__ segment_ids,",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 124,
          "old_api": "restrict__ o",
          "new_api": null,
          "old_text": "restrict__ o",
          "new_text": null,
          "old_line_content": "    const T* __restrict__ input, T* __restrict__ output,",
          "new_line_content": "    const Index actual_stripe_height =",
          "content_same": false
        },
        {
          "line": 126,
          "old_api": "uGridRangeX",
          "new_api": null,
          "old_text": "uGridRangeX(total_stripe_count)) ",
          "new_text": null,
          "old_line_content": "  for (int stripe_index : GpuGridRangeX(total_stripe_count)) {",
          "new_line_content": "            input_outer_dim_size - input_outer_dim_index_base);",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 10,
      "total_additions": 58,
      "total_deletions": 59,
      "total_api_changes": 127
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 18,
        "api_related_lines": 127,
        "non_api_lines": 11,
        "non_api_line_numbers": [
          69,
          70,
          103,
          104,
          105,
          106,
          107,
          108,
          114,
          116,
          85
        ]
      }
    },
    "api_calls_before": 108,
    "api_calls_after": 106,
    "diff_info": {
      "added_lines": 2,
      "removed_lines": 16,
      "total_diff_lines": 46
    }
  }
}