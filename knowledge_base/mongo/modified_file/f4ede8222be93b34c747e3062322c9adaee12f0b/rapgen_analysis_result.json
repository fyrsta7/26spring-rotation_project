{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/f4ede8222be93b34c747e3062322c9adaee12f0b",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/f4ede8222be93b34c747e3062322c9adaee12f0b/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/f4ede8222be93b34c747e3062322c9adaee12f0b/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/f4ede8222be93b34c747e3062322c9adaee12f0b/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 403,
          "old_api": "insert",
          "new_api": "type",
          "old_text": "arrIdxs.insert(i)",
          "new_text": "e.type()",
          "old_line_content": "            arrIdxs.insert(i);",
          "new_line_content": "        } else if (e.type() == Array) {",
          "content_same": false
        },
        {
          "line": 404,
          "old_api": "eoo",
          "new_api": "insert",
          "old_text": "arrElt.eoo()",
          "new_text": "arrIdxs.insert(i)",
          "old_line_content": "            if (arrElt.eoo()) {",
          "new_line_content": "            arrIdxs.insert(i);",
          "content_same": false
        },
        {
          "line": 427,
          "old_api": "CollationIndexKey::collationAwareIndexKeyAppend(*i, _collator, &b)",
          "new_api": "end",
          "old_text": "CollationIndexKey::collationAwareIndexKeyAppend(*i, _collator, &b)",
          "new_text": "fixed.end()",
          "old_line_content": "            CollationIndexKey::collationAwareIndexKeyAppend(*i, _collator, &b);",
          "new_line_content": "        for (std::vector<BSONElement>::iterator i = fixed.begin(); i != fixed.end(); ++i) {",
          "content_same": false
        },
        {
          "line": 430,
          "old_api": "embeddedObject",
          "new_api": "obj",
          "old_text": "arrElt.embeddedObject().firstElement().eoo()",
          "new_text": "b.obj()",
          "old_line_content": "    } else if (arrElt.embeddedObject().firstElement().eoo()) {",
          "new_line_content": "        keys->insert(b.obj());",
          "content_same": false
        },
        {
          "line": 442,
          "old_api": "invariant",
          "new_api": "numParts",
          "old_text": "invariant(suffixPathLength < fullPathLength)",
          "new_text": "FieldRef{fieldNames[i]}.numParts()",
          "old_line_content": "                invariant(suffixPathLength < fullPathLength);",
          "new_line_content": "                size_t suffixPathLength = FieldRef{fieldNames[i]}.numParts();",
          "content_same": false
        },
        {
          "line": 467,
          "old_api": "end",
          "new_api": "size",
          "old_text": "arrIdxs.end()",
          "new_text": "fieldNames.size()",
          "old_line_content": "            const bool fieldIsArray = arrIdxs.find(i) != arrIdxs.end();",
          "new_line_content": "        for (size_t i = 0; i < fieldNames.size(); ++i) {",
          "content_same": false
        },
        {
          "line": 510,
          "old_api": "invariant",
          "new_api": "numParts",
          "old_text": "invariant(suffixPathLength < fullPathLength)",
          "new_text": "FieldRef{fieldNames[i]}.numParts()",
          "old_line_content": "                    invariant(suffixPathLength < fullPathLength);",
          "new_line_content": "                    size_t suffixPathLength = FieldRef{fieldNames[i]}.numParts();",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 384,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "fieldNames.size()",
          "old_line_content": "",
          "new_line_content": "    std::vector<boost::optional<size_t>> arrComponents(fieldNames.size());",
          "content_same": false
        },
        {
          "line": 387,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "fieldNames.size()",
          "old_line_content": "        if (*fieldNames[i] == '\\0') {",
          "new_line_content": "    for (size_t i = 0; i < fieldNames.size(); ++i) {",
          "content_same": false
        },
        {
          "line": 395,
          "old_api": null,
          "new_api": "extractNextElement",
          "old_text": null,
          "new_text": "extractNextElement(obj, positionalInfo[i], &fieldNames[i], &arrayNestedArray)",
          "old_line_content": "",
          "new_line_content": "            extractNextElement(obj, positionalInfo[i], &fieldNames[i], &arrayNestedArray);",
          "content_same": false
        },
        {
          "line": 525,
          "old_api": null,
          "new_api": "dps::extractElementAtPathOrArrayAlongPath(\n                arrObj, subPositionalInfo[i].remainingPath)",
          "old_text": null,
          "new_text": "dps::extractElementAtPathOrArrayAlongPath(\n                arrObj, subPositionalInfo[i].remainingPath)",
          "old_line_content": "                arrObj, subPositionalInfo[i].remainingPath);",
          "new_line_content": "            subPositionalInfo[i].dottedElt = dps::extractElementAtPathOrArrayAlongPath(",
          "content_same": false
        },
        {
          "line": 397,
          "old_api": null,
          "new_api": "eoo",
          "old_text": null,
          "new_text": "e.eoo()",
          "old_line_content": "            // if field not present, set to null",
          "new_line_content": "        if (e.eoo()) {",
          "content_same": false
        },
        {
          "line": 531,
          "old_api": null,
          "new_api": "_getKeysArrEltFixed",
          "old_text": null,
          "new_text": "_getKeysArrEltFixed(&fieldNames,\n                                &fixed,\n                                arrObjElem,\n                                keys,\n                                numNotFound,\n                                arrElt,\n                                arrIdxs,\n                                mayExpandArrayUnembedded,\n                                subPositionalInfo,\n                                multikeyPaths)",
          "old_line_content": "                                &fixed,",
          "new_line_content": "            _getKeysArrEltFixed(&fieldNames,",
          "content_same": false
        },
        {
          "line": 405,
          "old_api": null,
          "new_api": "eoo",
          "old_text": null,
          "new_text": "arrElt.eoo()",
          "old_line_content": "                // we only expand arrays on a single path -- track the path here",
          "new_line_content": "            if (arrElt.eoo()) {",
          "content_same": false
        },
        {
          "line": 408,
          "old_api": null,
          "new_api": "rawdata",
          "old_text": null,
          "new_text": "arrElt.rawdata()",
          "old_line_content": "                // enforce single array path here",
          "new_line_content": "            } else if (e.rawdata() != arrElt.rawdata()) {",
          "content_same": false
        },
        {
          "line": 410,
          "old_api": null,
          "new_api": "fieldName",
          "old_text": null,
          "new_text": "arrElt.fieldName()",
          "old_line_content": "            }",
          "new_line_content": "                assertParallelArrays(e.fieldName(), arrElt.fieldName());",
          "content_same": false
        },
        {
          "line": 546,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "arrComponents.size()",
          "old_line_content": "            if (auto arrComponent = arrComponents[i]) {",
          "new_line_content": "        for (size_t i = 0; i < arrComponents.size(); ++i) {",
          "content_same": false
        },
        {
          "line": 548,
          "old_api": null,
          "new_api": "insert",
          "old_text": null,
          "new_text": "*multikeyPaths)[i].insert(*arrComponent)",
          "old_line_content": "            }",
          "new_line_content": "                (*multikeyPaths)[i].insert(*arrComponent);",
          "content_same": false
        },
        {
          "line": 421,
          "old_api": null,
          "new_api": "eoo",
          "old_text": null,
          "new_text": "arrElt.eoo()",
          "old_line_content": "        // No array, so generate a single key.",
          "new_line_content": "    if (arrElt.eoo()) {",
          "content_same": false
        },
        {
          "line": 423,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "fieldNames.size()",
          "old_line_content": "            return;",
          "new_line_content": "        if (_isSparse && numNotFound == fieldNames.size()) {",
          "content_same": false
        },
        {
          "line": 428,
          "old_api": null,
          "new_api": "CollationIndexKey::collationAwareIndexKeyAppend(*i, _collator, &b)",
          "old_text": null,
          "new_text": "CollationIndexKey::collationAwareIndexKeyAppend(*i, _collator, &b)",
          "old_line_content": "        }",
          "new_line_content": "            CollationIndexKey::collationAwareIndexKeyAppend(*i, _collator, &b);",
          "content_same": false
        },
        {
          "line": 431,
          "old_api": null,
          "new_api": "embeddedObject",
          "old_text": null,
          "new_text": "arrElt.embeddedObject().firstElement().eoo()",
          "old_line_content": "        // We've encountered an empty array.",
          "new_line_content": "    } else if (arrElt.embeddedObject().firstElement().eoo()) {",
          "content_same": false
        },
        {
          "line": 443,
          "old_api": null,
          "new_api": "invariant",
          "old_text": null,
          "new_text": "invariant(suffixPathLength < fullPathLength)",
          "old_line_content": "                arrComponents[i] = fullPathLength - suffixPathLength - 1;",
          "new_line_content": "                invariant(suffixPathLength < fullPathLength);",
          "content_same": false
        },
        {
          "line": 449,
          "old_api": null,
          "new_api": "_getKeysArrEltFixed",
          "old_text": null,
          "new_text": "_getKeysArrEltFixed(&fieldNames,\n                            &fixed,\n                            undefinedElt,\n                            keys,\n                            numNotFound,\n                            arrElt,\n                            arrIdxs,\n                            true,\n                            _emptyPositionalInfo,\n                            multikeyPaths)",
          "old_line_content": "                            &fixed,",
          "new_line_content": "        _getKeysArrEltFixed(&fieldNames,",
          "content_same": false
        },
        {
          "line": 460,
          "old_api": null,
          "new_api": "embeddedObject",
          "old_text": null,
          "new_text": "arrElt.embeddedObject()",
          "old_line_content": "",
          "new_line_content": "        BSONObj arrObj = arrElt.embeddedObject();",
          "content_same": false
        },
        {
          "line": 468,
          "old_api": null,
          "new_api": "end",
          "old_text": null,
          "new_text": "arrIdxs.end()",
          "old_line_content": "",
          "new_line_content": "            const bool fieldIsArray = arrIdxs.find(i) != arrIdxs.end();",
          "content_same": false
        },
        {
          "line": 347,
          "old_api": null,
          "new_api": "std::move(fixed)",
          "old_text": null,
          "new_text": "std::move(fixed)",
          "old_line_content": "}",
          "new_line_content": "        std::move(fieldNames), std::move(fixed), obj, keys, 0, _emptyPositionalInfo, multikeyPaths);",
          "content_same": false
        },
        {
          "line": 486,
          "old_api": null,
          "new_api": "invariant",
          "old_text": null,
          "new_text": "invariant(fieldIsArray)",
          "old_line_content": "",
          "new_line_content": "            invariant(fieldIsArray);",
          "content_same": false
        },
        {
          "line": 489,
          "old_api": null,
          "new_api": "find",
          "old_text": null,
          "new_text": "part.find('.')",
          "old_line_content": "            subPositionalInfo[i].positionallyIndexedElt = arrObj[part];",
          "new_line_content": "            part = part.substr(0, part.find('.'));",
          "content_same": false
        },
        {
          "line": 491,
          "old_api": null,
          "new_api": "eoo",
          "old_text": null,
          "new_text": "subPositionalInfo[i].positionallyIndexedElt.eoo()",
          "old_line_content": "                // We aren't indexing a particular element of the 'arrElt' array value, so it may be",
          "new_line_content": "            if (subPositionalInfo[i].positionallyIndexedElt.eoo()) {",
          "content_same": false
        },
        {
          "line": 511,
          "old_api": null,
          "new_api": "invariant",
          "old_text": null,
          "new_text": "invariant(suffixPathLength < fullPathLength)",
          "old_line_content": "                    arrComponents[i] = fullPathLength - suffixPathLength - 1;",
          "new_line_content": "                    invariant(suffixPathLength < fullPathLength);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 386,
          "old_api": "size",
          "new_api": null,
          "old_text": "fieldNames.size()",
          "new_text": null,
          "old_line_content": "    for (size_t i = 0; i < fieldNames.size(); ++i) {",
          "new_line_content": "    bool mayExpandArrayUnembedded = true;",
          "content_same": false
        },
        {
          "line": 394,
          "old_api": "extractNextElement",
          "new_api": null,
          "old_text": "extractNextElement(obj, positionalInfo[i], &fieldNames[i], &arrayNestedArray)",
          "new_text": null,
          "old_line_content": "            extractNextElement(obj, positionalInfo[i], &fieldNames[i], &arrayNestedArray);",
          "new_line_content": "        BSONElement e =",
          "content_same": false
        },
        {
          "line": 524,
          "old_api": "dps::extractElementAtPathOrArrayAlongPath(\n                arrObj, subPositionalInfo[i].remainingPath)",
          "new_api": null,
          "old_text": "dps::extractElementAtPathOrArrayAlongPath(\n                arrObj, subPositionalInfo[i].remainingPath)",
          "new_text": null,
          "old_line_content": "            subPositionalInfo[i].dottedElt = dps::extractElementAtPathOrArrayAlongPath(",
          "new_line_content": "            subPositionalInfo[i].remainingPath = fieldNames[i];",
          "content_same": false
        },
        {
          "line": 396,
          "old_api": "eoo",
          "new_api": null,
          "old_text": "e.eoo()",
          "new_text": null,
          "old_line_content": "        if (e.eoo()) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 530,
          "old_api": "_getKeysArrEltFixed",
          "new_api": null,
          "old_text": "_getKeysArrEltFixed(&fieldNames,\n                                &fixed,\n                                arrObjElem,\n                                keys,\n                                numNotFound,\n                                arrElt,\n                                arrIdxs,\n                                mayExpandArrayUnembedded,\n                                subPositionalInfo,\n                                multikeyPaths)",
          "new_text": null,
          "old_line_content": "            _getKeysArrEltFixed(&fieldNames,",
          "new_line_content": "        for (const auto arrObjElem : arrObj) {",
          "content_same": false
        },
        {
          "line": 402,
          "old_api": "type",
          "new_api": null,
          "old_text": "e.type()",
          "new_text": null,
          "old_line_content": "        } else if (e.type() == Array) {",
          "new_line_content": "            numNotFound++;",
          "content_same": false
        },
        {
          "line": 407,
          "old_api": "rawdata",
          "new_api": null,
          "old_text": "arrElt.rawdata()",
          "new_text": null,
          "old_line_content": "            } else if (e.rawdata() != arrElt.rawdata()) {",
          "new_line_content": "                arrElt = e;",
          "content_same": false
        },
        {
          "line": 409,
          "old_api": "fieldName",
          "new_api": null,
          "old_text": "arrElt.fieldName()",
          "new_text": null,
          "old_line_content": "                assertParallelArrays(e.fieldName(), arrElt.fieldName());",
          "new_line_content": "                // enforce single array path here",
          "content_same": false
        },
        {
          "line": 545,
          "old_api": "size",
          "new_api": null,
          "old_text": "arrComponents.size()",
          "new_text": null,
          "old_line_content": "        for (size_t i = 0; i < arrComponents.size(); ++i) {",
          "new_line_content": "    if (multikeyPaths) {",
          "content_same": false
        },
        {
          "line": 547,
          "old_api": "insert",
          "new_api": null,
          "old_text": "*multikeyPaths)[i].insert(*arrComponent)",
          "new_text": null,
          "old_line_content": "                (*multikeyPaths)[i].insert(*arrComponent);",
          "new_line_content": "            if (auto arrComponent = arrComponents[i]) {",
          "content_same": false
        },
        {
          "line": 420,
          "old_api": "eoo",
          "new_api": null,
          "old_text": "arrElt.eoo()",
          "new_text": null,
          "old_line_content": "    if (arrElt.eoo()) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 422,
          "old_api": "size",
          "new_api": null,
          "old_text": "fieldNames.size()",
          "new_text": null,
          "old_line_content": "        if (_isSparse && numNotFound == fieldNames.size()) {",
          "new_line_content": "        // No array, so generate a single key.",
          "content_same": false
        },
        {
          "line": 426,
          "old_api": "end",
          "new_api": null,
          "old_text": "fixed.end()",
          "new_text": null,
          "old_line_content": "        for (std::vector<BSONElement>::iterator i = fixed.begin(); i != fixed.end(); ++i) {",
          "new_line_content": "        BSONObjBuilder b(_sizeTracker);",
          "content_same": false
        },
        {
          "line": 429,
          "old_api": "obj",
          "new_api": null,
          "old_text": "b.obj()",
          "new_text": null,
          "old_line_content": "        keys->insert(b.obj());",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 441,
          "old_api": "numParts",
          "new_api": null,
          "old_text": "FieldRef{fieldNames[i]}.numParts()",
          "new_text": null,
          "old_line_content": "                size_t suffixPathLength = FieldRef{fieldNames[i]}.numParts();",
          "new_line_content": "                size_t fullPathLength = _pathLengths[i];",
          "content_same": false
        },
        {
          "line": 448,
          "old_api": "_getKeysArrEltFixed",
          "new_api": null,
          "old_text": "_getKeysArrEltFixed(&fieldNames,\n                            &fixed,\n                            undefinedElt,\n                            keys,\n                            numNotFound,\n                            arrElt,\n                            arrIdxs,\n                            true,\n                            _emptyPositionalInfo,\n                            multikeyPaths)",
          "new_text": null,
          "old_line_content": "        _getKeysArrEltFixed(&fieldNames,",
          "new_line_content": "        // For an empty array, set matching fields to undefined.",
          "content_same": false
        },
        {
          "line": 459,
          "old_api": "embeddedObject",
          "new_api": null,
          "old_text": "arrElt.embeddedObject()",
          "new_text": null,
          "old_line_content": "        BSONObj arrObj = arrElt.embeddedObject();",
          "new_line_content": "    } else {",
          "content_same": false
        },
        {
          "line": 465,
          "old_api": "size",
          "new_api": null,
          "old_text": "fixed.size()",
          "new_text": null,
          "old_line_content": "        std::vector<PositionalPathInfo> subPositionalInfo(fixed.size());",
          "new_line_content": "        // array element).",
          "content_same": false
        },
        {
          "line": 485,
          "old_api": "invariant",
          "new_api": null,
          "old_text": "invariant(fieldIsArray)",
          "new_text": null,
          "old_line_content": "            invariant(fieldIsArray);",
          "new_line_content": "            // we must have traversed through 'arrElt'.",
          "content_same": false
        },
        {
          "line": 488,
          "old_api": "find",
          "new_api": null,
          "old_text": "part.find('.')",
          "new_text": null,
          "old_line_content": "            part = part.substr(0, part.find('.'));",
          "new_line_content": "            StringData part = fieldNames[i];",
          "content_same": false
        },
        {
          "line": 490,
          "old_api": "eoo",
          "new_api": null,
          "old_text": "subPositionalInfo[i].positionallyIndexedElt.eoo()",
          "new_text": null,
          "old_line_content": "            if (subPositionalInfo[i].positionallyIndexedElt.eoo()) {",
          "new_line_content": "            subPositionalInfo[i].positionallyIndexedElt = arrObj[part];",
          "content_same": false
        },
        {
          "line": 509,
          "old_api": "numParts",
          "new_api": null,
          "old_text": "FieldRef{fieldNames[i]}.numParts()",
          "new_text": null,
          "old_line_content": "                    size_t suffixPathLength = FieldRef{fieldNames[i]}.numParts();",
          "new_line_content": "                    size_t fullPathLength = _pathLengths[i];",
          "content_same": false
        },
        {
          "line": 383,
          "old_api": "size",
          "new_api": null,
          "old_text": "fieldNames.size()",
          "new_text": null,
          "old_line_content": "    std::vector<boost::optional<size_t>> arrComponents(fieldNames.size());",
          "new_line_content": "    // std::vector<boost::optional<size_t>>{{1U}, boost::none}.",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 7,
      "total_additions": 24,
      "total_deletions": 23,
      "total_api_changes": 54
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 2,
        "api_related_lines": 54,
        "non_api_lines": 1,
        "non_api_line_numbers": [
          346
        ]
      }
    },
    "api_calls_before": 150,
    "api_calls_after": 152,
    "diff_info": {
      "added_lines": 2,
      "removed_lines": 1,
      "total_diff_lines": 15
    }
  }
}