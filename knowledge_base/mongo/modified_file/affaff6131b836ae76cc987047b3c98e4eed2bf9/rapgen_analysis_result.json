{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/affaff6131b836ae76cc987047b3c98e4eed2bf9",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/affaff6131b836ae76cc987047b3c98e4eed2bf9/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/affaff6131b836ae76cc987047b3c98e4eed2bf9/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/affaff6131b836ae76cc987047b3c98e4eed2bf9/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 351,
          "old_api": "isOK",
          "new_api": "validateBSON",
          "old_text": "uassert(ErrorCodes::InvalidBSON,\n            str::stream() << \"Got invalid BSON from external server while reading from cursor\"\n                          << causedBy(status),\n            status.isOK())",
          "new_text": "validateBSON(batch.data, batch.remainingBytes, _enabledBSONVersion)",
          "old_line_content": "    uassert(ErrorCodes::InvalidBSON,",
          "new_line_content": "        auto status = validateBSON(batch.data, batch.remainingBytes, _enabledBSONVersion);",
          "content_same": false
        },
        {
          "line": 352,
          "old_api": "str::stream()",
          "new_api": "isOK",
          "old_text": "str::stream()",
          "new_text": "uassert(ErrorCodes::InvalidBSON,\n                str::stream() << \"Got invalid BSON from external server while reading from cursor\"\n                              << causedBy(status),\n                status.isOK())",
          "old_line_content": "            str::stream() << \"Got invalid BSON from external server while reading from cursor\"",
          "new_line_content": "        uassert(ErrorCodes::InvalidBSON,",
          "content_same": false
        },
        {
          "line": 353,
          "old_api": "causedBy",
          "new_api": "str::stream()",
          "old_text": "causedBy(status)",
          "new_text": "str::stream()",
          "old_line_content": "                          << causedBy(status),",
          "new_line_content": "                str::stream() << \"Got invalid BSON from external server while reading from cursor\"",
          "content_same": false
        },
        {
          "line": 354,
          "old_api": "isOK",
          "new_api": "causedBy",
          "old_text": "status.isOK()",
          "new_text": "causedBy(status)",
          "old_line_content": "            status.isOK());",
          "new_line_content": "                              << causedBy(status),",
          "content_same": false
        },
        {
          "line": 410,
          "old_api": "size",
          "new_api": "peek",
          "old_text": "v.size()",
          "new_text": "peek(v, 1)",
          "old_line_content": "    if (v.size() > 0)",
          "new_line_content": "    peek(v, 1);",
          "content_same": false
        },
        {
          "line": 423,
          "old_api": "size",
          "new_api": "peek",
          "old_text": "v.size()",
          "new_text": "peek(v, 1)",
          "old_line_content": "    verify(v.size() == 1);",
          "new_line_content": "    peek(v, 1);",
          "content_same": false
        },
        {
          "line": 437,
          "old_api": "get",
          "new_api": "size",
          "old_text": "conn->get()",
          "new_text": "_scopedHost.size()",
          "old_line_content": "    verify(conn->get());",
          "new_line_content": "    verify(_scopedHost.size() == 0);",
          "content_same": false
        },
        {
          "line": 445,
          "old_api": "massert",
          "new_api": "getServerAddress",
          "old_text": "massert(14821,\n                    \"No client or lazy client specified, cannot store multi-host connection.\",\n                    false)",
          "new_text": "_client->getServerAddress()",
          "old_line_content": "            massert(14821,",
          "new_line_content": "            _scopedHost = _client->getServerAddress();",
          "content_same": false
        },
        {
          "line": 502,
          "old_api": "nsToCollectionSubstring",
          "new_api": "getServerAddress",
          "old_text": "nsToCollectionSubstring(ns)",
          "new_text": "_client->getServerAddress()",
          "old_line_content": "      _isCommand(nsIsFull(ns) ? nsToCollectionSubstring(ns) == \"$cmd\" : false),",
          "new_line_content": "      _originalHost(_client->getServerAddress()),",
          "content_same": false
        },
        {
          "line": 527,
          "old_api": "size",
          "new_api": "killCursor",
          "old_text": "_scopedHost.size()",
          "new_text": "_client->killCursor(cursorId)",
          "old_line_content": "                verify(_scopedHost.size());",
          "new_line_content": "                _client->killCursor(cursorId);",
          "content_same": false
        },
        {
          "line": 529,
          "old_api": "killCursor",
          "new_api": "size",
          "old_text": "conn->killCursor(cursorId)",
          "new_text": "_scopedHost.size()",
          "old_line_content": "                conn->killCursor(cursorId);",
          "new_line_content": "                verify(_scopedHost.size());",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 516,
          "old_api": null,
          "new_api": "Validator<BSONObj>::enabledBSONVersion()",
          "old_text": null,
          "new_text": "Validator<BSONObj>::enabledBSONVersion()",
          "old_line_content": "DBClientCursor::~DBClientCursor() {",
          "new_line_content": "      _enabledBSONVersion(Validator<BSONObj>::enabledBSONVersion()) {}",
          "content_same": false
        },
        {
          "line": 519,
          "old_api": null,
          "new_api": "kill",
          "old_text": null,
          "new_text": "kill()",
          "old_line_content": "",
          "new_line_content": "    kill();",
          "content_same": false
        },
        {
          "line": 523,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "DESTRUCTOR_GUARD(\n\n        if (cursorId && _ownCursor && !inShutdown()) {\n            if (_client) {\n                _client->killCursor(cursorId);\n            } else {\n                verify(_scopedHost.size());\n                ScopedDbConnection conn(_scopedHost);\n                conn->killCursor(cursorId);\n                conn.done();\n            }\n        }\n\n        )",
          "old_line_content": "        if (cursorId && _ownCursor && !inShutdown()) {",
          "new_line_content": "    DESTRUCTOR_GUARD(",
          "content_same": false
        },
        {
          "line": 401,
          "old_api": null,
          "new_api": "objsize",
          "old_text": null,
          "new_text": "o.objsize()",
          "old_line_content": "        m--;",
          "new_line_content": "        d += o.objsize();",
          "content_same": false
        },
        {
          "line": 531,
          "old_api": null,
          "new_api": "killCursor",
          "old_text": null,
          "new_text": "conn->killCursor(cursorId)",
          "old_line_content": "            }",
          "new_line_content": "                conn->killCursor(cursorId);",
          "content_same": false
        },
        {
          "line": 532,
          "old_api": null,
          "new_api": "done",
          "old_text": null,
          "new_text": "conn.done()",
          "old_line_content": "        }",
          "new_line_content": "                conn.done();",
          "content_same": false
        },
        {
          "line": 404,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "v.push_back(o)",
          "old_line_content": "}",
          "new_line_content": "        v.push_back(o);",
          "content_same": false
        },
        {
          "line": 412,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "v.size()",
          "old_line_content": "    else",
          "new_line_content": "    if (v.size() > 0)",
          "content_same": false
        },
        {
          "line": 415,
          "old_api": null,
          "new_api": "BSONObj",
          "old_text": null,
          "new_text": "BSONObj()",
          "old_line_content": "",
          "new_line_content": "        return BSONObj();",
          "content_same": false
        },
        {
          "line": 425,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "v.size()",
          "old_line_content": "    // $err, and getStatusFromCommandResult checks for modern errors of the form '{ok: 0.0, code:",
          "new_line_content": "    verify(v.size() == 1);",
          "content_same": false
        },
        {
          "line": 429,
          "old_api": null,
          "new_api": "isOK",
          "old_text": null,
          "new_text": "getStatusFromCommandResult(v[0]).isOK()",
          "old_line_content": "    if (error)",
          "new_line_content": "    verify(hasErrField(v[0]) || !getStatusFromCommandResult(v[0]).isOK());",
          "content_same": false
        },
        {
          "line": 432,
          "old_api": null,
          "new_api": "getOwned",
          "old_text": null,
          "new_text": "v[0].getOwned()",
          "old_line_content": "}",
          "new_line_content": "        *error = v[0].getOwned();",
          "content_same": false
        },
        {
          "line": 438,
          "old_api": null,
          "new_api": "verify",
          "old_text": null,
          "new_text": "verify(conn)",
          "old_line_content": "",
          "new_line_content": "    verify(conn);",
          "content_same": false
        },
        {
          "line": 441,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "conn->get()->type()",
          "old_line_content": "            _scopedHost = _lazyHost;",
          "new_line_content": "    if (conn->get()->type() == ConnectionString::SET) {",
          "content_same": false
        },
        {
          "line": 442,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "_lazyHost.size()",
          "old_line_content": "        else if (_client)",
          "new_line_content": "        if (_lazyHost.size() > 0)",
          "content_same": false
        },
        {
          "line": 447,
          "old_api": null,
          "new_api": "massert",
          "old_text": null,
          "new_text": "massert(14821,\n                    \"No client or lazy client specified, cannot store multi-host connection.\",\n                    false)",
          "old_line_content": "                    false);",
          "new_line_content": "            massert(14821,",
          "content_same": false
        },
        {
          "line": 451,
          "old_api": null,
          "new_api": "getHost",
          "old_text": null,
          "new_text": "conn->getHost()",
          "old_line_content": "",
          "new_line_content": "        _scopedHost = conn->getHost();",
          "content_same": false
        },
        {
          "line": 454,
          "old_api": null,
          "new_api": "done",
          "old_text": null,
          "new_text": "conn->done()",
          "old_line_content": "    _lazyHost = \"\";",
          "new_line_content": "    conn->done();",
          "content_same": false
        },
        {
          "line": 355,
          "old_api": null,
          "new_api": "isOK",
          "old_text": null,
          "new_text": "status.isOK()",
          "old_line_content": "",
          "new_line_content": "                status.isOK());",
          "content_same": false
        },
        {
          "line": 484,
          "old_api": null,
          "new_api": "BSONObj",
          "old_text": null,
          "new_text": "BSONObj()",
          "old_line_content": "                     nToReturn,",
          "new_line_content": "                     BSONObj(),  // query",
          "content_same": false
        },
        {
          "line": 361,
          "old_api": null,
          "new_api": "objsize",
          "old_text": null,
          "new_text": "o.objsize()",
          "old_line_content": "",
          "new_line_content": "    batch.data += o.objsize();",
          "content_same": false
        },
        {
          "line": 362,
          "old_api": null,
          "new_api": "objsize",
          "old_text": null,
          "new_text": "o.objsize()",
          "old_line_content": "    /* todo would be good to make data null at end of batch for safety */",
          "new_line_content": "    batch.remainingBytes -= o.objsize();",
          "content_same": false
        },
        {
          "line": 369,
          "old_api": null,
          "new_api": "next",
          "old_text": null,
          "new_text": "next()",
          "old_line_content": "    // Only convert legacy errors ($err) to exceptions. Otherwise, just return the response and the",
          "new_line_content": "    BSONObj o = next();",
          "content_same": false
        },
        {
          "line": 373,
          "old_api": null,
          "new_api": "firstElementFieldName",
          "old_text": null,
          "new_text": "o.firstElementFieldName()",
          "old_line_content": "        if (!code) {",
          "new_line_content": "    if (wasError && strcmp(o.firstElementFieldName(), \"$err\") == 0) {",
          "content_same": false
        },
        {
          "line": 374,
          "old_api": null,
          "new_api": "numberInt",
          "old_text": null,
          "new_text": "o[\"code\"].numberInt()",
          "old_line_content": "            code = ErrorCodes::UnknownError;",
          "new_line_content": "        auto code = o[\"code\"].numberInt();",
          "content_same": false
        },
        {
          "line": 504,
          "old_api": null,
          "new_api": "nsToCollectionSubstring",
          "old_text": null,
          "new_text": "nsToCollectionSubstring(ns)",
          "old_line_content": "      nToReturn(nToReturn),",
          "new_line_content": "      _isCommand(nsIsFull(ns) ? nsToCollectionSubstring(ns) == \"$cmd\" : false),",
          "content_same": false
        },
        {
          "line": 378,
          "old_api": null,
          "new_api": "firstElement",
          "old_text": null,
          "new_text": "o.firstElement().str()",
          "old_line_content": "",
          "new_line_content": "        uasserted(code, o.firstElement().str());",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 514,
          "old_api": "Validator<BSONObj>::enabledBSONVersion()",
          "new_api": null,
          "old_text": "Validator<BSONObj>::enabledBSONVersion()",
          "new_text": null,
          "old_line_content": "      _enabledBSONVersion(Validator<BSONObj>::enabledBSONVersion()) {}",
          "new_line_content": "      _ownCursor(true),",
          "content_same": false
        },
        {
          "line": 517,
          "old_api": "kill",
          "new_api": null,
          "old_text": "kill()",
          "new_text": null,
          "old_line_content": "    kill();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 521,
          "old_api": "size",
          "new_api": null,
          "old_text": "DESTRUCTOR_GUARD(\n\n        if (cursorId && _ownCursor && !inShutdown()) {\n            if (_client) {\n                _client->killCursor(cursorId);\n            } else {\n                verify(_scopedHost.size());\n                ScopedDbConnection conn(_scopedHost);\n                conn->killCursor(cursorId);\n                conn.done();\n            }\n        }\n\n        )",
          "new_text": null,
          "old_line_content": "    DESTRUCTOR_GUARD(",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 525,
          "old_api": "killCursor",
          "new_api": null,
          "old_text": "_client->killCursor(cursorId)",
          "new_text": null,
          "old_line_content": "                _client->killCursor(cursorId);",
          "new_line_content": "        if (cursorId && _ownCursor && !inShutdown()) {",
          "content_same": false
        },
        {
          "line": 399,
          "old_api": "objsize",
          "new_api": null,
          "old_text": "o.objsize()",
          "new_text": null,
          "old_line_content": "        d += o.objsize();",
          "new_line_content": "    while (m && p < batch.nReturned) {",
          "content_same": false
        },
        {
          "line": 530,
          "old_api": "done",
          "new_api": null,
          "old_text": "conn.done()",
          "new_text": null,
          "old_line_content": "                conn.done();",
          "new_line_content": "                ScopedDbConnection conn(_scopedHost);",
          "content_same": false
        },
        {
          "line": 402,
          "old_api": "push_back",
          "new_api": null,
          "old_text": "v.push_back(o)",
          "new_text": null,
          "old_line_content": "        v.push_back(o);",
          "new_line_content": "        p++;",
          "content_same": false
        },
        {
          "line": 408,
          "old_api": "peek",
          "new_api": null,
          "old_text": "peek(v, 1)",
          "new_text": null,
          "old_line_content": "    peek(v, 1);",
          "new_line_content": "BSONObj DBClientCursor::peekFirst() {",
          "content_same": false
        },
        {
          "line": 413,
          "old_api": "BSONObj",
          "new_api": null,
          "old_text": "BSONObj()",
          "new_text": null,
          "old_line_content": "        return BSONObj();",
          "new_line_content": "        return v[0];",
          "content_same": false
        },
        {
          "line": 421,
          "old_api": "peek",
          "new_api": null,
          "old_text": "peek(v, 1)",
          "new_text": null,
          "old_line_content": "    peek(v, 1);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 427,
          "old_api": "isOK",
          "new_api": null,
          "old_text": "getStatusFromCommandResult(v[0]).isOK()",
          "new_text": null,
          "old_line_content": "    verify(hasErrField(v[0]) || !getStatusFromCommandResult(v[0]).isOK());",
          "new_line_content": "    // $err, and getStatusFromCommandResult checks for modern errors of the form '{ok: 0.0, code:",
          "content_same": false
        },
        {
          "line": 430,
          "old_api": "getOwned",
          "new_api": null,
          "old_text": "v[0].getOwned()",
          "new_text": null,
          "old_line_content": "        *error = v[0].getOwned();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 435,
          "old_api": "size",
          "new_api": null,
          "old_text": "_scopedHost.size()",
          "new_text": null,
          "old_line_content": "    verify(_scopedHost.size() == 0);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 436,
          "old_api": "verify",
          "new_api": null,
          "old_text": "verify(conn)",
          "new_text": null,
          "old_line_content": "    verify(conn);",
          "new_line_content": "void DBClientCursor::attach(AScopedConnection* conn) {",
          "content_same": false
        },
        {
          "line": 440,
          "old_api": "size",
          "new_api": null,
          "old_text": "_lazyHost.size()",
          "new_text": null,
          "old_line_content": "        if (_lazyHost.size() > 0)",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 443,
          "old_api": "getServerAddress",
          "new_api": null,
          "old_text": "_client->getServerAddress()",
          "new_text": null,
          "old_line_content": "            _scopedHost = _client->getServerAddress();",
          "new_line_content": "            _scopedHost = _lazyHost;",
          "content_same": false
        },
        {
          "line": 449,
          "old_api": "getHost",
          "new_api": null,
          "old_text": "conn->getHost()",
          "new_text": null,
          "old_line_content": "        _scopedHost = conn->getHost();",
          "new_line_content": "                    false);",
          "content_same": false
        },
        {
          "line": 452,
          "old_api": "done",
          "new_api": null,
          "old_text": "conn->done()",
          "new_text": null,
          "old_line_content": "    conn->done();",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 350,
          "old_api": "validateBSON",
          "new_api": null,
          "old_text": "validateBSON(batch.data, batch.remainingBytes, _enabledBSONVersion)",
          "new_text": null,
          "old_line_content": "    auto status = validateBSON(batch.data, batch.remainingBytes, _enabledBSONVersion);",
          "new_line_content": "    if (serverGlobalParams.objcheck) {",
          "content_same": false
        },
        {
          "line": 482,
          "old_api": "BSONObj",
          "new_api": null,
          "old_text": "BSONObj()",
          "new_text": null,
          "old_line_content": "                     BSONObj(),  // query",
          "new_line_content": "    : DBClientCursor(client,",
          "content_same": false
        },
        {
          "line": 359,
          "old_api": "objsize",
          "new_api": null,
          "old_text": "o.objsize()",
          "new_text": null,
          "old_line_content": "    batch.data += o.objsize();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 360,
          "old_api": "objsize",
          "new_api": null,
          "old_text": "o.objsize()",
          "new_text": null,
          "old_line_content": "    batch.remainingBytes -= o.objsize();",
          "new_line_content": "    batch.pos++;",
          "content_same": false
        },
        {
          "line": 367,
          "old_api": "next",
          "new_api": null,
          "old_text": "next()",
          "new_text": null,
          "old_line_content": "    BSONObj o = next();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 371,
          "old_api": "firstElementFieldName",
          "new_api": null,
          "old_text": "o.firstElementFieldName()",
          "new_text": null,
          "old_line_content": "    if (wasError && strcmp(o.firstElementFieldName(), \"$err\") == 0) {",
          "new_line_content": "    // Only convert legacy errors ($err) to exceptions. Otherwise, just return the response and the",
          "content_same": false
        },
        {
          "line": 372,
          "old_api": "numberInt",
          "new_api": null,
          "old_text": "o[\"code\"].numberInt()",
          "new_text": null,
          "old_line_content": "        auto code = o[\"code\"].numberInt();",
          "new_line_content": "    // caller will interpret it as a command error.",
          "content_same": false
        },
        {
          "line": 500,
          "old_api": "getServerAddress",
          "new_api": null,
          "old_text": "_client->getServerAddress()",
          "new_text": null,
          "old_line_content": "      _originalHost(_client->getServerAddress()),",
          "new_line_content": "                               int batchSize)",
          "content_same": false
        },
        {
          "line": 376,
          "old_api": "firstElement",
          "new_api": null,
          "old_text": "o.firstElement().str()",
          "new_text": null,
          "old_line_content": "        uasserted(code, o.firstElement().str());",
          "new_line_content": "            code = ErrorCodes::UnknownError;",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 11,
      "total_additions": 27,
      "total_deletions": 27,
      "total_api_changes": 65
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 7,
        "api_related_lines": 65,
        "non_api_lines": 1,
        "non_api_line_numbers": [
          356
        ]
      }
    },
    "api_calls_before": 181,
    "api_calls_after": 181,
    "diff_info": {
      "added_lines": 7,
      "removed_lines": 5,
      "total_diff_lines": 24
    }
  }
}