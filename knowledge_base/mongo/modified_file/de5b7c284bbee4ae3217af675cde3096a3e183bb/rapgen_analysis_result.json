{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/de5b7c284bbee4ae3217af675cde3096a3e183bb",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/de5b7c284bbee4ae3217af675cde3096a3e183bb/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/de5b7c284bbee4ae3217af675cde3096a3e183bb/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/de5b7c284bbee4ae3217af675cde3096a3e183bb/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 89,
          "old_api": "BSONObj",
          "new_api": "c_str",
          "old_text": "BSONObj()",
          "new_text": "ns.c_str()",
          "old_line_content": "            shared_ptr<Cursor> cursor = bestGuessCursor(ns.c_str() , query , BSONObj() );",
          "new_line_content": "            shared_ptr<Cursor> cursor = newQueryOptimizerCursor(ns.c_str() , query);",
          "content_same": false
        },
        {
          "line": 93,
          "old_api": "advance",
          "new_api": "currLoc",
          "old_text": "cursor->advance()",
          "new_text": "cursor->currLoc()",
          "old_line_content": "                    cursor->advance();",
          "new_line_content": "                    cursor->getsetdup( cursor->currLoc() ) ) {",
          "content_same": false
        },
        {
          "line": 98,
          "old_api": "advance",
          "new_api": "current",
          "old_text": "cursor->advance()",
          "new_text": "cursor->current()",
          "old_line_content": "                cursor->advance();",
          "new_line_content": "                BSONObj obj = cursor->current();",
          "content_same": false
        },
        {
          "line": 101,
          "old_api": "objsize",
          "new_api": "get",
          "old_text": "key.objsize()",
          "new_text": "s.get()",
          "old_line_content": "                keysize += key.objsize();",
          "new_line_content": "                BSONObj key = getKey( obj , keyPattern , keyFunction , keysize / keynum , s.get() );",
          "content_same": false
        },
        {
          "line": 107,
          "old_api": "setObject",
          "new_api": "size",
          "old_text": "s->setObject( \"$key\" , key , true )",
          "new_text": "map.size()",
          "old_line_content": "                    s->setObject( \"$key\" , key , true );",
          "new_line_content": "                    n = map.size();",
          "content_same": false
        },
        {
          "line": 113,
          "old_api": "setNumber",
          "new_api": "setObject",
          "old_text": "s->setNumber( \"n\" , n - 1 )",
          "new_text": "s->setObject( \"obj\" , obj , true )",
          "old_line_content": "                s->setNumber( \"n\" , n - 1 );",
          "new_line_content": "                s->setObject( \"obj\" , obj , true );",
          "content_same": false
        },
        {
          "line": 114,
          "old_api": "invoke",
          "new_api": "setNumber",
          "old_text": "s->invoke( f , 0, 0 , 0 , true )",
          "new_text": "s->setNumber( \"n\" , n - 1 )",
          "old_line_content": "                if ( s->invoke( f , 0, 0 , 0 , true ) ) {",
          "new_line_content": "                s->setNumber( \"n\" , n - 1 );",
          "content_same": false
        },
        {
          "line": 115,
          "old_api": "getError",
          "new_api": "invoke",
          "old_text": "s->getError()",
          "new_text": "s->invoke( f , 0, 0 , 0 , true )",
          "old_line_content": "                    throw UserException( 9010 , (string)\"reduce invoke failed: \" + s->getError() );",
          "new_line_content": "                if ( s->invoke( f , 0, 0 , 0 , true ) ) {",
          "content_same": false
        },
        {
          "line": 120,
          "old_api": "exec",
          "new_api": "empty",
          "old_text": "s->exec( \"$finalize = \" + finalize , \"finalize define\" , false , true , true , 100 )",
          "new_text": "finalize.empty()",
          "old_line_content": "                s->exec( \"$finalize = \" + finalize , \"finalize define\" , false , true , true , 100 );",
          "new_line_content": "            if (!finalize.empty()) {",
          "content_same": false
        },
        {
          "line": 121,
          "old_api": "createFunction",
          "new_api": "exec",
          "old_text": "s->createFunction(\n                                          \"function(){ \"\n                                          \"  for(var i=0; i < $arr.length; i++){ \"\n                                          \"  var ret = $finalize($arr[i]); \"\n                                          \"  if (ret !== undefined) \"\n                                          \"    $arr[i] = ret; \"\n                                          \"  } \"\n                                          \"}\" )",
          "new_text": "s->exec( \"$finalize = \" + finalize , \"finalize define\" , false , true , true , 100 )",
          "old_line_content": "                ScriptingFunction g = s->createFunction(",
          "new_line_content": "                s->exec( \"$finalize = \" + finalize , \"finalize define\" , false , true , true , 100 );",
          "content_same": false
        },
        {
          "line": 133,
          "old_api": "append",
          "new_api": "getObject",
          "old_text": "result.append( \"count\" , keynum - 1 )",
          "new_text": "s->getObject( \"$arr\" )",
          "old_line_content": "            result.append( \"count\" , keynum - 1 );",
          "new_line_content": "            result.appendArray( \"retval\" , s->getObject( \"$arr\" ) );",
          "content_same": false
        },
        {
          "line": 134,
          "old_api": "size",
          "new_api": "append",
          "old_text": "map.size()",
          "new_text": "result.append( \"count\" , keynum - 1 )",
          "old_line_content": "            result.append( \"keys\" , (int)(map.size()) );",
          "new_line_content": "            result.append( \"count\" , keynum - 1 );",
          "content_same": false
        },
        {
          "line": 135,
          "old_api": "exec",
          "new_api": "size",
          "old_text": "s->exec( \"$arr = [];\" , \"reduce setup 2\" , false , true , true , 100 )",
          "new_text": "map.size()",
          "old_line_content": "            s->exec( \"$arr = [];\" , \"reduce setup 2\" , false , true , true , 100 );",
          "new_line_content": "            result.append( \"keys\" , (int)(map.size()) );",
          "content_same": false
        },
        {
          "line": 136,
          "old_api": "gc",
          "new_api": "exec",
          "old_text": "s->gc()",
          "new_text": "s->exec( \"$arr = [];\" , \"reduce setup 2\" , false , true , true , 100 )",
          "old_line_content": "            s->gc();",
          "new_line_content": "            s->exec( \"$arr = [];\" , \"reduce setup 2\" , false , true , true , 100 );",
          "content_same": false
        },
        {
          "line": 153,
          "old_api": "embeddedObject",
          "new_api": "type",
          "old_text": "p[\"cond\"].embeddedObject()",
          "new_text": "p[\"cond\"].type()",
          "old_line_content": "                q = p[\"cond\"].embeddedObject();",
          "new_line_content": "            if ( p[\"cond\"].type() == Object )",
          "content_same": false
        },
        {
          "line": 154,
          "old_api": "type",
          "new_api": "embeddedObject",
          "old_text": "p[\"condition\"].type()",
          "new_text": "p[\"cond\"].embeddedObject()",
          "old_line_content": "            else if ( p[\"condition\"].type() == Object )",
          "new_line_content": "                q = p[\"cond\"].embeddedObject();",
          "content_same": false
        },
        {
          "line": 155,
          "old_api": "embeddedObject",
          "new_api": "type",
          "old_text": "p[\"condition\"].embeddedObject()",
          "new_text": "p[\"condition\"].type()",
          "old_line_content": "                q = p[\"condition\"].embeddedObject();",
          "new_line_content": "            else if ( p[\"condition\"].type() == Object )",
          "content_same": false
        },
        {
          "line": 169,
          "old_api": "embeddedObjectUserCheck",
          "new_api": "type",
          "old_text": "p[\"key\"].embeddedObjectUserCheck()",
          "new_text": "p[\"key\"].type()",
          "old_line_content": "                key = p[\"key\"].embeddedObjectUserCheck();",
          "new_line_content": "            if ( p[\"key\"].type() == Object ) {",
          "content_same": false
        },
        {
          "line": 170,
          "old_api": "eoo",
          "new_api": "embeddedObjectUserCheck",
          "old_text": "p[\"$keyf\"].eoo()",
          "new_text": "p[\"key\"].embeddedObjectUserCheck()",
          "old_line_content": "                if ( ! p[\"$keyf\"].eoo() ) {",
          "new_line_content": "                key = p[\"key\"].embeddedObjectUserCheck();",
          "content_same": false
        },
        {
          "line": 176,
          "old_api": "_asCode",
          "new_api": "type",
          "old_text": "p[\"$keyf\"]._asCode()",
          "new_text": "p[\"$keyf\"].type()",
          "old_line_content": "                keyf = p[\"$keyf\"]._asCode();",
          "new_line_content": "            else if ( p[\"$keyf\"].type() ) {",
          "content_same": false
        },
        {
          "line": 197,
          "old_api": "_asCode",
          "new_api": "type",
          "old_text": "p[\"finalize\"]._asCode()",
          "new_text": "p[\"finalize\"].type()",
          "old_line_content": "                finalize = p[\"finalize\"]._asCode();",
          "new_line_content": "            if (p[\"finalize\"].type())",
          "content_same": false
        },
        {
          "line": 200,
          "old_api": "codeWScopeScopeData",
          "new_api": "_asCode",
          "old_text": "reduce.codeWScopeScopeData()",
          "new_text": "group( dbname , ns , q ,\n                          key , keyf , reduce._asCode() , reduce.type() != CodeWScope ? 0 : reduce.codeWScopeScopeData() ,\n                          initial.embeddedObject() , finalize ,\n                          errmsg , result )",
          "old_line_content": "                          key , keyf , reduce._asCode() , reduce.type() != CodeWScope ? 0 : reduce.codeWScopeScopeData() ,",
          "new_line_content": "            return group( dbname , ns , q ,",
          "content_same": false
        },
        {
          "line": 201,
          "old_api": "embeddedObject",
          "new_api": "codeWScopeScopeData",
          "old_text": "initial.embeddedObject()",
          "new_text": "reduce.codeWScopeScopeData()",
          "old_line_content": "                          initial.embeddedObject() , finalize ,",
          "new_line_content": "                          key , keyf , reduce._asCode() , reduce.type() != CodeWScope ? 0 : reduce.codeWScopeScopeData() ,",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 130,
          "old_api": null,
          "new_api": "invoke",
          "old_text": null,
          "new_text": "s->invoke( g , 0, 0 , 0 , true )",
          "old_line_content": "            }",
          "new_line_content": "                s->invoke( g , 0, 0 , 0 , true );",
          "content_same": false
        },
        {
          "line": 137,
          "old_api": null,
          "new_api": "gc",
          "old_text": null,
          "new_text": "s->gc()",
          "old_line_content": "",
          "new_line_content": "            s->gc();",
          "content_same": false
        },
        {
          "line": 150,
          "old_api": null,
          "new_api": "firstElement",
          "old_text": null,
          "new_text": "jsobj.firstElement().embeddedObjectUserCheck()",
          "old_line_content": "",
          "new_line_content": "            const BSONObj& p = jsobj.firstElement().embeddedObjectUserCheck();",
          "content_same": false
        },
        {
          "line": 156,
          "old_api": null,
          "new_api": "embeddedObject",
          "old_text": null,
          "new_text": "p[\"condition\"].embeddedObject()",
          "old_line_content": "            else",
          "new_line_content": "                q = p[\"condition\"].embeddedObject();",
          "content_same": false
        },
        {
          "line": 158,
          "old_api": null,
          "new_api": "getQuery",
          "old_text": null,
          "new_text": "getQuery( p )",
          "old_line_content": "",
          "new_line_content": "                q = getQuery( p );",
          "content_same": false
        },
        {
          "line": 160,
          "old_api": null,
          "new_api": "type",
          "old_text": null,
          "new_text": "p[\"ns\"].type()",
          "old_line_content": "                errmsg = \"ns has to be set\";",
          "new_line_content": "            if ( p[\"ns\"].type() != String ) {",
          "content_same": false
        },
        {
          "line": 165,
          "old_api": null,
          "new_api": "String",
          "old_text": null,
          "new_text": "p[\"ns\"].String()",
          "old_line_content": "",
          "new_line_content": "            string ns = dbname + \".\" + p[\"ns\"].String();",
          "content_same": false
        },
        {
          "line": 171,
          "old_api": null,
          "new_api": "eoo",
          "old_text": null,
          "new_text": "p[\"$keyf\"].eoo()",
          "old_line_content": "                    errmsg = \"can't have key and $keyf\";",
          "new_line_content": "                if ( ! p[\"$keyf\"].eoo() ) {",
          "content_same": false
        },
        {
          "line": 177,
          "old_api": null,
          "new_api": "_asCode",
          "old_text": null,
          "new_text": "p[\"$keyf\"]._asCode()",
          "old_line_content": "            }",
          "new_line_content": "                keyf = p[\"$keyf\"]._asCode();",
          "content_same": false
        },
        {
          "line": 184,
          "old_api": null,
          "new_api": "eoo",
          "old_text": null,
          "new_text": "reduce.eoo()",
          "old_line_content": "                errmsg = \"$reduce has to be set\";",
          "new_line_content": "            if ( reduce.eoo() ) {",
          "content_same": false
        },
        {
          "line": 190,
          "old_api": null,
          "new_api": "type",
          "old_text": null,
          "new_text": "initial.type()",
          "old_line_content": "                errmsg = \"initial has to be an object\";",
          "new_line_content": "            if ( initial.type() != Object ) {",
          "content_same": false
        },
        {
          "line": 198,
          "old_api": null,
          "new_api": "_asCode",
          "old_text": null,
          "new_text": "p[\"finalize\"]._asCode()",
          "old_line_content": "",
          "new_line_content": "                finalize = p[\"finalize\"]._asCode();",
          "content_same": false
        },
        {
          "line": 202,
          "old_api": null,
          "new_api": "embeddedObject",
          "old_text": null,
          "new_text": "initial.embeddedObject()",
          "old_line_content": "                          errmsg , result );",
          "new_line_content": "                          initial.embeddedObject() , finalize ,",
          "content_same": false
        },
        {
          "line": 94,
          "old_api": null,
          "new_api": "advance",
          "old_text": null,
          "new_text": "cursor->advance()",
          "old_line_content": "                    continue;",
          "new_line_content": "                    cursor->advance();",
          "content_same": false
        },
        {
          "line": 99,
          "old_api": null,
          "new_api": "advance",
          "old_text": null,
          "new_text": "cursor->advance()",
          "old_line_content": "",
          "new_line_content": "                cursor->advance();",
          "content_same": false
        },
        {
          "line": 102,
          "old_api": null,
          "new_api": "objsize",
          "old_text": null,
          "new_text": "key.objsize()",
          "old_line_content": "                keynum++;",
          "new_line_content": "                keysize += key.objsize();",
          "content_same": false
        },
        {
          "line": 108,
          "old_api": null,
          "new_api": "setObject",
          "old_text": null,
          "new_text": "s->setObject( \"$key\" , key , true )",
          "old_line_content": "",
          "new_line_content": "                    s->setObject( \"$key\" , key , true );",
          "content_same": false
        },
        {
          "line": 110,
          "old_api": null,
          "new_api": "uassert",
          "old_text": null,
          "new_text": "uassert( 10043 ,  \"group() can't handle more than 20000 unique keys\" , n <= 20000 )",
          "old_line_content": "                }",
          "new_line_content": "                    uassert( 10043 ,  \"group() can't handle more than 20000 unique keys\" , n <= 20000 );",
          "content_same": false
        },
        {
          "line": 116,
          "old_api": null,
          "new_api": "getError",
          "old_text": null,
          "new_text": "s->getError()",
          "old_line_content": "                }",
          "new_line_content": "                    throw UserException( 9010 , (string)\"reduce invoke failed: \" + s->getError() );",
          "content_same": false
        },
        {
          "line": 122,
          "old_api": null,
          "new_api": "createFunction",
          "old_text": null,
          "new_text": "s->createFunction(\n                                          \"function(){ \"\n                                          \"  for(var i=0; i < $arr.length; i++){ \"\n                                          \"  var ret = $finalize($arr[i]); \"\n                                          \"  if (ret !== undefined) \"\n                                          \"    $arr[i] = ret; \"\n                                          \"  } \"\n                                          \"}\" )",
          "old_line_content": "                                          \"function(){ \"",
          "new_line_content": "                ScriptingFunction g = s->createFunction(",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 129,
          "old_api": "invoke",
          "new_api": null,
          "old_text": "s->invoke( g , 0, 0 , 0 , true )",
          "new_text": null,
          "old_line_content": "                s->invoke( g , 0, 0 , 0 , true );",
          "new_line_content": "                                          \"}\" );",
          "content_same": false
        },
        {
          "line": 132,
          "old_api": "getObject",
          "new_api": null,
          "old_text": "s->getObject( \"$arr\" )",
          "new_text": null,
          "old_line_content": "            result.appendArray( \"retval\" , s->getObject( \"$arr\" ) );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 149,
          "old_api": "firstElement",
          "new_api": null,
          "old_text": "jsobj.firstElement().embeddedObjectUserCheck()",
          "new_text": null,
          "old_line_content": "            const BSONObj& p = jsobj.firstElement().embeddedObjectUserCheck();",
          "new_line_content": "            /* db.$cmd.findOne( { group : <p> } ) */",
          "content_same": false
        },
        {
          "line": 152,
          "old_api": "type",
          "new_api": null,
          "old_text": "p[\"cond\"].type()",
          "new_text": null,
          "old_line_content": "            if ( p[\"cond\"].type() == Object )",
          "new_line_content": "            BSONObj q;",
          "content_same": false
        },
        {
          "line": 157,
          "old_api": "getQuery",
          "new_api": null,
          "old_text": "getQuery( p )",
          "new_text": null,
          "old_line_content": "                q = getQuery( p );",
          "new_line_content": "            else",
          "content_same": false
        },
        {
          "line": 159,
          "old_api": "type",
          "new_api": null,
          "old_text": "p[\"ns\"].type()",
          "new_text": null,
          "old_line_content": "            if ( p[\"ns\"].type() != String ) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 164,
          "old_api": "String",
          "new_api": null,
          "old_text": "p[\"ns\"].String()",
          "new_text": null,
          "old_line_content": "            string ns = dbname + \".\" + p[\"ns\"].String();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 168,
          "old_api": "type",
          "new_api": null,
          "old_text": "p[\"key\"].type()",
          "new_text": null,
          "old_line_content": "            if ( p[\"key\"].type() == Object ) {",
          "new_line_content": "            string keyf;",
          "content_same": false
        },
        {
          "line": 175,
          "old_api": "type",
          "new_api": null,
          "old_text": "p[\"$keyf\"].type()",
          "new_text": null,
          "old_line_content": "            else if ( p[\"$keyf\"].type() ) {",
          "new_line_content": "            }",
          "content_same": false
        },
        {
          "line": 183,
          "old_api": "eoo",
          "new_api": null,
          "old_text": "reduce.eoo()",
          "new_text": null,
          "old_line_content": "            if ( reduce.eoo() ) {",
          "new_line_content": "            BSONElement reduce = p[\"$reduce\"];",
          "content_same": false
        },
        {
          "line": 189,
          "old_api": "type",
          "new_api": null,
          "old_text": "initial.type()",
          "new_text": null,
          "old_line_content": "            if ( initial.type() != Object ) {",
          "new_line_content": "            BSONElement initial = p[\"initial\"];",
          "content_same": false
        },
        {
          "line": 196,
          "old_api": "type",
          "new_api": null,
          "old_text": "p[\"finalize\"].type()",
          "new_text": null,
          "old_line_content": "            if (p[\"finalize\"].type())",
          "new_line_content": "            string finalize;",
          "content_same": false
        },
        {
          "line": 199,
          "old_api": "_asCode",
          "new_api": null,
          "old_text": "group( dbname , ns , q ,\n                          key , keyf , reduce._asCode() , reduce.type() != CodeWScope ? 0 : reduce.codeWScopeScopeData() ,\n                          initial.embeddedObject() , finalize ,\n                          errmsg , result )",
          "new_text": null,
          "old_line_content": "            return group( dbname , ns , q ,",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 97,
          "old_api": "current",
          "new_api": null,
          "old_text": "cursor->current()",
          "new_text": null,
          "old_line_content": "                BSONObj obj = cursor->current();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 100,
          "old_api": "get",
          "new_api": null,
          "old_text": "s.get()",
          "new_text": null,
          "old_line_content": "                BSONObj key = getKey( obj , keyPattern , keyFunction , keysize / keynum , s.get() );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 106,
          "old_api": "size",
          "new_api": null,
          "old_text": "map.size()",
          "new_text": null,
          "old_line_content": "                    n = map.size();",
          "new_line_content": "                if ( n == 0 ) {",
          "content_same": false
        },
        {
          "line": 109,
          "old_api": "uassert",
          "new_api": null,
          "old_text": "uassert( 10043 ,  \"group() can't handle more than 20000 unique keys\" , n <= 20000 )",
          "new_text": null,
          "old_line_content": "                    uassert( 10043 ,  \"group() can't handle more than 20000 unique keys\" , n <= 20000 );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 112,
          "old_api": "setObject",
          "new_api": null,
          "old_text": "s->setObject( \"obj\" , obj , true )",
          "new_text": null,
          "old_line_content": "                s->setObject( \"obj\" , obj , true );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 119,
          "old_api": "empty",
          "new_api": null,
          "old_text": "finalize.empty()",
          "new_text": null,
          "old_line_content": "            if (!finalize.empty()) {",
          "new_line_content": "",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 23,
      "total_additions": 20,
      "total_deletions": 19,
      "total_api_changes": 62
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 3,
        "api_related_lines": 62,
        "non_api_lines": 1,
        "non_api_line_numbers": [
          92
        ]
      }
    },
    "api_calls_before": 78,
    "api_calls_after": 79,
    "diff_info": {
      "added_lines": 3,
      "removed_lines": 2,
      "total_diff_lines": 19
    }
  }
}