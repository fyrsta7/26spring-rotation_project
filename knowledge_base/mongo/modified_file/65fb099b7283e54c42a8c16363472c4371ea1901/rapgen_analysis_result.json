{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/65fb099b7283e54c42a8c16363472c4371ea1901",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/65fb099b7283e54c42a8c16363472c4371ea1901/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/65fb099b7283e54c42a8c16363472c4371ea1901/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mongo/modified_file/65fb099b7283e54c42a8c16363472c4371ea1901/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 126,
          "old_api": "load",
          "new_api": "numChildren",
          "old_text": "internalQueryEnableBooleanExpressionsSimplifier.load()",
          "new_text": "optimizedExpr->numChildren()",
          "old_line_content": "        if (enableSimplification && internalQueryEnableBooleanExpressionsSimplifier.load()) {",
          "new_line_content": "        const bool isTriviallySimple = optimizedExpr->numChildren() == 0 ||",
          "content_same": false
        },
        {
          "line": 133,
          "old_api": "get",
          "new_api": "load",
          "old_text": "optimizedExpr.get()",
          "new_text": "internalQueryMaxSizeFactorToSimplify.load()",
          "old_line_content": "            auto simplifiedExpr = simplifyMatchExpression(optimizedExpr.get(), settings);",
          "new_line_content": "                internalQueryMaxSizeFactorToSimplify.load(),",
          "content_same": false
        },
        {
          "line": 150,
          "old_api": "getChildVector",
          "new_api": "numChildren",
          "old_text": "tree->getChildVector()",
          "new_text": "tree->numChildren()",
          "old_line_content": "    if (auto&& children = tree->getChildVector()) {",
          "new_line_content": "    for (size_t i = 0; i < tree->numChildren(); ++i) {",
          "content_same": false
        },
        {
          "line": 151,
          "old_api": "end",
          "new_api": "getChild",
          "old_text": "children->end()",
          "new_text": "tree->getChild(i)",
          "old_line_content": "        std::stable_sort(children->begin(), children->end(), [](auto&& lhs, auto&& rhs) {",
          "new_line_content": "        sortTree(tree->getChild(i));",
          "content_same": false
        },
        {
          "line": 219,
          "old_api": "_doSetCollator",
          "new_api": "setCollator",
          "old_text": "_doSetCollator(collator)",
          "new_text": "getChild(i)->setCollator(collator)",
          "old_line_content": "    _doSetCollator(collator);",
          "new_line_content": "        getChild(i)->setCollator(collator);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 132,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "internalQueryMaximumNumberOfMintermsInSimplifier.load()",
          "old_line_content": "                /*applyQuineMcCluskey*/ true};",
          "new_line_content": "                static_cast<size_t>(internalQueryMaximumNumberOfMintermsInSimplifier.load()),",
          "content_same": false
        },
        {
          "line": 134,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "internalQueryDoNotOpenContainedOrsInSimplifier.load()",
          "old_line_content": "            if (simplifiedExpr) {",
          "new_line_content": "                internalQueryDoNotOpenContainedOrsInSimplifier.load(),",
          "content_same": false
        },
        {
          "line": 136,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "optimizedExpr.get()",
          "old_line_content": "            }",
          "new_line_content": "            auto simplifiedExpr = simplifyMatchExpression(optimizedExpr.get(), settings);",
          "content_same": false
        },
        {
          "line": 138,
          "old_api": null,
          "new_api": "std::move(*simplifiedExpr)",
          "old_text": null,
          "new_text": "std::move(*simplifiedExpr)",
          "old_line_content": "        return optimizedExpr;",
          "new_line_content": "                return std::move(*simplifiedExpr);",
          "content_same": false
        },
        {
          "line": 143,
          "old_api": null,
          "new_api": "addContext",
          "old_text": null,
          "new_text": "ex.addContext(\"Failed to optimize expression\")",
          "old_line_content": "}",
          "new_line_content": "        ex.addContext(\"Failed to optimize expression\");",
          "content_same": false
        },
        {
          "line": 153,
          "old_api": null,
          "new_api": "getChildVector",
          "old_text": null,
          "new_text": "tree->getChildVector()",
          "old_line_content": "        });",
          "new_line_content": "    if (auto&& children = tree->getChildVector()) {",
          "content_same": false
        },
        {
          "line": 154,
          "old_api": null,
          "new_api": "end",
          "old_text": null,
          "new_text": "children->end()",
          "old_line_content": "    }",
          "new_line_content": "        std::stable_sort(children->begin(), children->end(), [](auto&& lhs, auto&& rhs) {",
          "content_same": false
        },
        {
          "line": 155,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "rhs.get()",
          "old_line_content": "}",
          "new_line_content": "            return matchExpressionLessThan(lhs.get(), rhs.get());",
          "content_same": false
        },
        {
          "line": 163,
          "old_api": null,
          "new_api": "std::move(tree)",
          "old_text": null,
          "new_text": "std::move(tree)",
          "old_line_content": "}",
          "new_line_content": "    tree = optimize(std::move(tree), enableSimplification);",
          "content_same": false
        },
        {
          "line": 164,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "tree.get()",
          "old_line_content": "",
          "new_line_content": "    sortTree(tree.get());",
          "content_same": false
        },
        {
          "line": 177,
          "old_api": null,
          "new_api": "tree_walker::walk<false, MatchExpression>(tree, &walker)",
          "old_text": null,
          "new_text": "tree_walker::walk<false, MatchExpression>(tree, &walker)",
          "old_line_content": "    if (parameterized != nullptr) {",
          "new_line_content": "    tree_walker::walk<false, MatchExpression>(tree, &walker);",
          "content_same": false
        },
        {
          "line": 184,
          "old_api": null,
          "new_api": "std::move(context.inputParamIdToExpressionMap)",
          "old_text": null,
          "new_text": "std::move(context.inputParamIdToExpressionMap)",
          "old_line_content": "// static",
          "new_line_content": "    return std::move(context.inputParamIdToExpressionMap);",
          "content_same": false
        },
        {
          "line": 189,
          "old_api": null,
          "new_api": "MatchExpression::parameterize(tree, 0)",
          "old_text": null,
          "new_text": "MatchExpression::parameterize(tree, 0)",
          "old_line_content": "std::string MatchExpression::toString() const {",
          "new_line_content": "    return MatchExpression::parameterize(tree, 0);",
          "content_same": false
        },
        {
          "line": 193,
          "old_api": null,
          "new_api": "toString",
          "old_text": null,
          "new_text": "serialize().toString()",
          "old_line_content": "std::string MatchExpression::debugString() const {",
          "new_line_content": "    return serialize().toString();",
          "content_same": false
        },
        {
          "line": 198,
          "old_api": null,
          "new_api": "debugString",
          "old_text": null,
          "new_text": "debugString(builder, 0)",
          "old_line_content": "",
          "new_line_content": "    debugString(builder, 0);",
          "content_same": false
        },
        {
          "line": 199,
          "old_api": null,
          "new_api": "str",
          "old_text": null,
          "new_text": "builder.str()",
          "old_line_content": "void MatchExpression::_debugAddSpace(StringBuilder& debug, int indentationLevel) const {",
          "new_line_content": "    return builder.str();",
          "content_same": false
        },
        {
          "line": 209,
          "old_api": null,
          "new_api": "matches",
          "old_text": null,
          "new_text": "matches(&mydoc, details)",
          "old_line_content": "bool MatchExpression::matchesBSONElement(BSONElement elem, MatchDetails* details) const {",
          "new_line_content": "    return matches(&mydoc, details);",
          "content_same": false
        },
        {
          "line": 214,
          "old_api": null,
          "new_api": "matches",
          "old_text": null,
          "new_text": "matches(&matchableDoc, details)",
          "old_line_content": "void MatchExpression::setCollator(const CollatorInterface* collator) {",
          "new_line_content": "    return matches(&matchableDoc, details);",
          "content_same": false
        },
        {
          "line": 218,
          "old_api": null,
          "new_api": "numChildren",
          "old_text": null,
          "new_text": "numChildren()",
          "old_line_content": "",
          "new_line_content": "    for (size_t i = 0; i < numChildren(); ++i) {",
          "content_same": false
        },
        {
          "line": 222,
          "old_api": null,
          "new_api": "_doSetCollator",
          "old_text": null,
          "new_text": "_doSetCollator(collator)",
          "old_line_content": "MatchExpression::ErrorAnnotation::SchemaAnnotations::SchemaAnnotations(",
          "new_line_content": "    _doSetCollator(collator);",
          "content_same": false
        },
        {
          "line": 228,
          "old_api": null,
          "new_api": "type",
          "old_text": null,
          "new_text": "title.type()",
          "old_line_content": "",
          "new_line_content": "    if (title.type() == BSONType::String) {",
          "content_same": false
        },
        {
          "line": 229,
          "old_api": null,
          "new_api": "String",
          "old_text": null,
          "new_text": "title.String()",
          "old_line_content": "    auto description = jsonSchemaElement[JSONSchemaParser::kSchemaDescriptionKeyword];",
          "new_line_content": "        this->title = {title.String()};",
          "content_same": false
        },
        {
          "line": 233,
          "old_api": null,
          "new_api": "type",
          "old_text": null,
          "new_text": "description.type()",
          "old_line_content": "}",
          "new_line_content": "    if (description.type() == BSONType::String) {",
          "content_same": false
        },
        {
          "line": 234,
          "old_api": null,
          "new_api": "String",
          "old_text": null,
          "new_text": "description.String()",
          "old_line_content": "",
          "new_line_content": "        this->description = {description.String()};",
          "content_same": false
        },
        {
          "line": 241,
          "old_api": null,
          "new_api": "value",
          "old_text": null,
          "new_text": "title.value()",
          "old_line_content": "    if (description) {",
          "new_line_content": "        builder << JSONSchemaParser::kSchemaTitleKeyword << title.value();",
          "content_same": false
        },
        {
          "line": 245,
          "old_api": null,
          "new_api": "value",
          "old_text": null,
          "new_text": "description.value()",
          "old_line_content": "}  // namespace mongo",
          "new_line_content": "        builder << JSONSchemaParser::kSchemaDescriptionKeyword << description.value();",
          "content_same": false
        },
        {
          "line": 127,
          "old_api": null,
          "new_api": "getChild",
          "old_text": null,
          "new_text": "optimizedExpr->getChild(0)->numChildren()",
          "old_line_content": "            ExpressionSimlifierSettings settings{",
          "new_line_content": "            (optimizedExpr->numChildren() == 1 && optimizedExpr->getChild(0)->numChildren() == 0);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 128,
          "old_api": "load",
          "new_api": null,
          "old_text": "internalQueryMaximumNumberOfUniquePredicatesToSimplify.load()",
          "new_text": null,
          "old_line_content": "                static_cast<size_t>(internalQueryMaximumNumberOfUniquePredicatesToSimplify.load()),",
          "new_line_content": "        if (enableSimplification && !isTriviallySimple &&",
          "content_same": false
        },
        {
          "line": 130,
          "old_api": "load",
          "new_api": null,
          "old_text": "internalQueryMaxSizeFactorToSimplify.load()",
          "new_text": null,
          "old_line_content": "                internalQueryMaxSizeFactorToSimplify.load(),",
          "new_line_content": "            ExpressionSimlifierSettings settings{",
          "content_same": false
        },
        {
          "line": 135,
          "old_api": "std::move(*simplifiedExpr)",
          "new_api": null,
          "old_text": "std::move(*simplifiedExpr)",
          "new_text": null,
          "old_line_content": "                return std::move(*simplifiedExpr);",
          "new_line_content": "                /*applyQuineMcCluskey*/ true};",
          "content_same": false
        },
        {
          "line": 140,
          "old_api": "addContext",
          "new_api": null,
          "old_text": "ex.addContext(\"Failed to optimize expression\")",
          "new_text": null,
          "old_line_content": "        ex.addContext(\"Failed to optimize expression\");",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 147,
          "old_api": "numChildren",
          "new_api": null,
          "old_text": "tree->numChildren()",
          "new_text": null,
          "old_line_content": "    for (size_t i = 0; i < tree->numChildren(); ++i) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 148,
          "old_api": "getChild",
          "new_api": null,
          "old_text": "tree->getChild(i)",
          "new_text": null,
          "old_line_content": "        sortTree(tree->getChild(i));",
          "new_line_content": "// static",
          "content_same": false
        },
        {
          "line": 152,
          "old_api": "get",
          "new_api": null,
          "old_text": "rhs.get()",
          "new_text": null,
          "old_line_content": "            return matchExpressionLessThan(lhs.get(), rhs.get());",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 160,
          "old_api": "std::move(tree)",
          "new_api": null,
          "old_text": "std::move(tree)",
          "new_text": null,
          "old_line_content": "    tree = optimize(std::move(tree), enableSimplification);",
          "new_line_content": "// static",
          "content_same": false
        },
        {
          "line": 161,
          "old_api": "get",
          "new_api": null,
          "old_text": "tree.get()",
          "new_text": null,
          "old_line_content": "    sortTree(tree.get());",
          "new_line_content": "std::unique_ptr<MatchExpression> MatchExpression::normalize(std::unique_ptr<MatchExpression> tree,",
          "content_same": false
        },
        {
          "line": 174,
          "old_api": "tree_walker::walk<false, MatchExpression>(tree, &walker)",
          "new_api": null,
          "old_text": "tree_walker::walk<false, MatchExpression>(tree, &walker)",
          "new_text": null,
          "old_line_content": "    tree_walker::walk<false, MatchExpression>(tree, &walker);",
          "new_line_content": "    MatchExpressionParameterizationVisitorContext context{maxParamCount, startingParamId};",
          "content_same": false
        },
        {
          "line": 181,
          "old_api": "std::move(context.inputParamIdToExpressionMap)",
          "new_api": null,
          "old_text": "std::move(context.inputParamIdToExpressionMap)",
          "new_text": null,
          "old_line_content": "    return std::move(context.inputParamIdToExpressionMap);",
          "new_line_content": "        *parameterized = context.parameterized;",
          "content_same": false
        },
        {
          "line": 186,
          "old_api": "MatchExpression::parameterize(tree, 0)",
          "new_api": null,
          "old_text": "MatchExpression::parameterize(tree, 0)",
          "new_text": null,
          "old_line_content": "    return MatchExpression::parameterize(tree, 0);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 190,
          "old_api": "toString",
          "new_api": null,
          "old_text": "serialize().toString()",
          "new_text": null,
          "old_line_content": "    return serialize().toString();",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 195,
          "old_api": "debugString",
          "new_api": null,
          "old_text": "debugString(builder, 0)",
          "new_text": null,
          "old_line_content": "    debugString(builder, 0);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 196,
          "old_api": "str",
          "new_api": null,
          "old_text": "builder.str()",
          "new_text": null,
          "old_line_content": "    return builder.str();",
          "new_line_content": "std::string MatchExpression::debugString() const {",
          "content_same": false
        },
        {
          "line": 206,
          "old_api": "matches",
          "new_api": null,
          "old_text": "matches(&mydoc, details)",
          "new_text": null,
          "old_line_content": "    return matches(&mydoc, details);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 211,
          "old_api": "matches",
          "new_api": null,
          "old_text": "matches(&matchableDoc, details)",
          "new_text": null,
          "old_line_content": "    return matches(&matchableDoc, details);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 215,
          "old_api": "numChildren",
          "new_api": null,
          "old_text": "numChildren()",
          "new_text": null,
          "old_line_content": "    for (size_t i = 0; i < numChildren(); ++i) {",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 216,
          "old_api": "setCollator",
          "new_api": null,
          "old_text": "getChild(i)->setCollator(collator)",
          "new_text": null,
          "old_line_content": "        getChild(i)->setCollator(collator);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 225,
          "old_api": "type",
          "new_api": null,
          "old_text": "title.type()",
          "new_text": null,
          "old_line_content": "    if (title.type() == BSONType::String) {",
          "new_line_content": "MatchExpression::ErrorAnnotation::SchemaAnnotations::SchemaAnnotations(",
          "content_same": false
        },
        {
          "line": 226,
          "old_api": "String",
          "new_api": null,
          "old_text": "title.String()",
          "new_text": null,
          "old_line_content": "        this->title = {title.String()};",
          "new_line_content": "    const BSONObj& jsonSchemaElement) {",
          "content_same": false
        },
        {
          "line": 230,
          "old_api": "type",
          "new_api": null,
          "old_text": "description.type()",
          "new_text": null,
          "old_line_content": "    if (description.type() == BSONType::String) {",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 231,
          "old_api": "String",
          "new_api": null,
          "old_text": "description.String()",
          "new_text": null,
          "old_line_content": "        this->description = {description.String()};",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 238,
          "old_api": "value",
          "new_api": null,
          "old_text": "title.value()",
          "new_text": null,
          "old_line_content": "        builder << JSONSchemaParser::kSchemaTitleKeyword << title.value();",
          "new_line_content": "void MatchExpression::ErrorAnnotation::SchemaAnnotations::appendElements(",
          "content_same": false
        },
        {
          "line": 242,
          "old_api": "value",
          "new_api": null,
          "old_text": "description.value()",
          "new_text": null,
          "old_line_content": "        builder << JSONSchemaParser::kSchemaDescriptionKeyword << description.value();",
          "new_line_content": "    }",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 5,
      "total_additions": 27,
      "total_deletions": 25,
      "total_api_changes": 57
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 4,
        "api_related_lines": 57,
        "non_api_lines": 1,
        "non_api_line_numbers": [
          129
        ]
      }
    },
    "api_calls_before": 67,
    "api_calls_after": 71,
    "diff_info": {
      "added_lines": 4,
      "removed_lines": 1,
      "total_diff_lines": 17
    }
  }
}