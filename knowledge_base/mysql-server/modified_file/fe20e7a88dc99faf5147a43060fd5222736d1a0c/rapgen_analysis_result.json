{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mysql-server/modified_file/fe20e7a88dc99faf5147a43060fd5222736d1a0c",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mysql-server/modified_file/fe20e7a88dc99faf5147a43060fd5222736d1a0c/before.cc",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mysql-server/modified_file/fe20e7a88dc99faf5147a43060fd5222736d1a0c/after.cc",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/mysql-server/modified_file/fe20e7a88dc99faf5147a43060fd5222736d1a0c/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 2107,
          "old_api": "os_thread_yield",
          "new_api": "srv_get_task_queue_length",
          "old_text": "os_thread_yield()",
          "new_text": "srv_get_task_queue_length()",
          "old_line_content": "      os_thread_yield();",
          "new_line_content": "      if (srv_get_task_queue_length() > 0) {",
          "content_same": false
        },
        {
          "line": 2148,
          "old_api": "ut_a",
          "new_api": "trx_purge_dml_delay",
          "old_text": "ut_a(n_purge_threads > 0)",
          "new_text": "trx_purge_dml_delay()",
          "old_line_content": "  ut_a(n_purge_threads > 0);",
          "new_line_content": "  srv_dml_needed_delay = trx_purge_dml_delay();",
          "content_same": false
        },
        {
          "line": 2153,
          "old_api": "ut_a",
          "new_api": "rw_lock_x_lock",
          "old_text": "ut_a(purge_sys->n_submitted == purge_sys->n_completed)",
          "new_text": "rw_lock_x_lock(&purge_sys->latch)",
          "old_line_content": "  ut_a(purge_sys->n_submitted == purge_sys->n_completed);",
          "new_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2178,
          "old_api": "que_fork_scheduler_round_robin",
          "new_api": "ut_a",
          "old_text": "que_fork_scheduler_round_robin(purge_sys->query, thr)",
          "new_text": "ut_a(thr != NULL)",
          "old_line_content": "      thr = que_fork_scheduler_round_robin(purge_sys->query, thr);",
          "new_line_content": "      ut_a(thr != NULL);",
          "content_same": false
        },
        {
          "line": 2180,
          "old_api": "ut_a",
          "new_api": "srv_que_task_enqueue_low",
          "old_text": "ut_a(thr != NULL)",
          "new_text": "srv_que_task_enqueue_low(thr)",
          "old_line_content": "      ut_a(thr != NULL);",
          "new_line_content": "      srv_que_task_enqueue_low(thr);",
          "content_same": false
        },
        {
          "line": 2200,
          "old_api": "que_run_threads",
          "new_api": "os_atomic_inc_ulint",
          "old_text": "que_run_threads(thr)",
          "new_text": "os_atomic_inc_ulint(&purge_sys->pq_mutex, &purge_sys->n_completed, 1)",
          "old_line_content": "    que_run_threads(thr);",
          "new_line_content": "    os_atomic_inc_ulint(&purge_sys->pq_mutex, &purge_sys->n_completed, 1);",
          "content_same": false
        },
        {
          "line": 2252,
          "old_api": "os_event_reset",
          "new_api": "ut_a",
          "old_text": "os_event_reset(purge_sys->event)",
          "new_text": "ut_a(srv_n_purge_threads > 0)",
          "old_line_content": "  int64_t sig_count = os_event_reset(purge_sys->event);",
          "new_line_content": "  ut_a(srv_n_purge_threads > 0);",
          "content_same": false
        },
        {
          "line": 2254,
          "old_api": "ut_a",
          "new_api": "rw_lock_x_lock",
          "old_text": "ut_a(srv_n_purge_threads > 0)",
          "new_text": "rw_lock_x_lock(&purge_sys->latch)",
          "old_line_content": "  ut_a(srv_n_purge_threads > 0);",
          "new_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2256,
          "old_api": "rw_lock_x_lock",
          "new_api": "ut_a",
          "old_text": "rw_lock_x_lock(&purge_sys->latch)",
          "new_text": "ut_a(purge_sys->state != PURGE_STATE_INIT)",
          "old_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "new_line_content": "  ut_a(purge_sys->state != PURGE_STATE_INIT);",
          "content_same": false
        },
        {
          "line": 2295,
          "old_api": "rw_lock_x_unlock",
          "new_api": "os_thread_sleep",
          "old_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "new_text": "os_thread_sleep(10000)",
          "old_line_content": "      rw_lock_x_unlock(&purge_sys->latch);",
          "new_line_content": "      os_thread_sleep(10000);",
          "content_same": false
        },
        {
          "line": 2297,
          "old_api": "os_thread_sleep",
          "new_api": "rw_lock_x_lock",
          "old_text": "os_thread_sleep(10000)",
          "new_text": "rw_lock_x_lock(&purge_sys->latch)",
          "old_line_content": "      os_thread_sleep(10000);",
          "new_line_content": "      rw_lock_x_lock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2334,
          "old_api": "MONITOR_INC_VALUE",
          "new_api": "ut_a",
          "old_text": "MONITOR_INC_VALUE(MONITOR_PURGE_RESUME_COUNT, 1)",
          "new_text": "ut_a(purge_sys->state == PURGE_STATE_RUN)",
          "old_line_content": "    MONITOR_INC_VALUE(MONITOR_PURGE_RESUME_COUNT, 1);",
          "new_line_content": "    ut_a(purge_sys->state == PURGE_STATE_RUN);",
          "content_same": false
        },
        {
          "line": 2339,
          "old_api": "rw_lock_x_unlock",
          "new_api": "srv_purge_wakeup",
          "old_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "new_text": "srv_purge_wakeup()",
          "old_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "new_line_content": "  srv_purge_wakeup();",
          "content_same": false
        },
        {
          "line": 2349,
          "old_api": "reserve",
          "new_api": "ut_zalloc_nokey",
          "old_text": "m_spaces.reserve(FSP_MAX_UNDO_TABLESPACES)",
          "new_text": "ut_zalloc_nokey(sizeof(*m_latch))",
          "old_line_content": "  m_spaces.reserve(FSP_MAX_UNDO_TABLESPACES);",
          "new_line_content": "  m_latch = static_cast<rw_lock_t *>(ut_zalloc_nokey(sizeof(*m_latch)));",
          "content_same": false
        },
        {
          "line": 2351,
          "old_api": "ut_zalloc_nokey",
          "new_api": "rw_lock_create",
          "old_text": "ut_zalloc_nokey(sizeof(*m_latch))",
          "new_text": "rw_lock_create(undo_spaces_lock_key, m_latch, SYNC_UNDO_SPACES)",
          "old_line_content": "  m_latch = static_cast<rw_lock_t *>(ut_zalloc_nokey(sizeof(*m_latch)));",
          "new_line_content": "  rw_lock_create(undo_spaces_lock_key, m_latch, SYNC_UNDO_SPACES);",
          "content_same": false
        },
        {
          "line": 2353,
          "old_api": "rw_lock_create",
          "new_api": "mutex_create",
          "old_text": "rw_lock_create(undo_spaces_lock_key, m_latch, SYNC_UNDO_SPACES)",
          "new_text": "mutex_create(LATCH_ID_UNDO_DDL, &ddl_mutex)",
          "old_line_content": "  rw_lock_create(undo_spaces_lock_key, m_latch, SYNC_UNDO_SPACES);",
          "new_line_content": "  mutex_create(LATCH_ID_UNDO_DDL, &ddl_mutex);",
          "content_same": false
        },
        {
          "line": 2360,
          "old_api": "clear",
          "new_api": "rw_lock_free",
          "old_text": "clear()",
          "new_text": "rw_lock_free(m_latch)",
          "old_line_content": "  clear();",
          "new_line_content": "  rw_lock_free(m_latch);",
          "content_same": false
        },
        {
          "line": 2363,
          "old_api": "ut_free",
          "new_api": "mutex_free",
          "old_text": "ut_free(m_latch)",
          "new_text": "mutex_free(&ddl_mutex)",
          "old_line_content": "  ut_free(m_latch);",
          "new_line_content": "  mutex_free(&ddl_mutex);",
          "content_same": false
        },
        {
          "line": 2374,
          "old_api": "id",
          "new_api": "num",
          "old_text": "ref_undo_space.id()",
          "new_text": "ref_undo_space.num()",
          "old_line_content": "  ut_ad(is_reserved(ref_undo_space.id()));",
          "new_line_content": "  if (contains(ref_undo_space.num())) {",
          "content_same": false
        },
        {
          "line": 2380,
          "old_api": "Tablespace",
          "new_api": "push_back",
          "old_text": "Tablespace(ref_undo_space)",
          "new_text": "m_spaces.push_back(undo_space)",
          "old_line_content": "  auto undo_space = UT_NEW_NOKEY(Tablespace(ref_undo_space));",
          "new_line_content": "  m_spaces.push_back(undo_space);",
          "content_same": false
        },
        {
          "line": 2389,
          "old_api": "num",
          "new_api": "end",
          "old_text": "undo_space->num()",
          "new_text": "m_spaces.end()",
          "old_line_content": "  ut_ad(contains(undo_space->num()));",
          "new_line_content": "  for (auto it = m_spaces.begin(); it != m_spaces.end(); it++) {",
          "content_same": false
        },
        {
          "line": 2391,
          "old_api": "end",
          "new_api": "UT_DELETE",
          "old_text": "m_spaces.end()",
          "new_text": "UT_DELETE(undo_space)",
          "old_line_content": "  for (auto it = m_spaces.begin(); it != m_spaces.end(); it++) {",
          "new_line_content": "      UT_DELETE(undo_space);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 2176,
          "old_api": null,
          "new_api": "que_fork_scheduler_round_robin",
          "old_text": null,
          "new_text": "que_fork_scheduler_round_robin(purge_sys->query, thr)",
          "old_line_content": "    /* Submit the tasks to the work queue. */",
          "new_line_content": "      thr = que_fork_scheduler_round_robin(purge_sys->query, thr);",
          "content_same": false
        },
        {
          "line": 2308,
          "old_api": null,
          "new_api": "rw_lock_x_lock",
          "old_text": null,
          "new_text": "rw_lock_x_lock(&purge_sys->latch)",
          "old_line_content": "/** Resume purge, move to PURGE_STATE_RUN. */",
          "new_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2183,
          "old_api": null,
          "new_api": "que_fork_scheduler_round_robin",
          "old_text": null,
          "new_text": "que_fork_scheduler_round_robin(purge_sys->query, thr)",
          "old_line_content": "    }",
          "new_line_content": "    thr = que_fork_scheduler_round_robin(purge_sys->query, thr);",
          "content_same": false
        },
        {
          "line": 2184,
          "old_api": null,
          "new_api": "ut_a",
          "old_text": null,
          "new_text": "ut_a(thr != NULL)",
          "old_line_content": "",
          "new_line_content": "    ut_a(thr != NULL);",
          "content_same": false
        },
        {
          "line": 2192,
          "old_api": null,
          "new_api": "que_fork_scheduler_round_robin",
          "old_text": null,
          "new_text": "que_fork_scheduler_round_robin(purge_sys->query, NULL)",
          "old_line_content": "    /* Do it synchronously. */",
          "new_line_content": "    thr = que_fork_scheduler_round_robin(purge_sys->query, NULL);",
          "content_same": false
        },
        {
          "line": 2193,
          "old_api": null,
          "new_api": "ut_ad",
          "old_text": null,
          "new_text": "ut_ad(thr)",
          "old_line_content": "  } else {",
          "new_line_content": "    ut_ad(thr);",
          "content_same": false
        },
        {
          "line": 2322,
          "old_api": null,
          "new_api": "ut_a",
          "old_text": null,
          "new_text": "ut_a(purge_sys->state == PURGE_STATE_STOP)",
          "old_line_content": "",
          "new_line_content": "    ut_a(purge_sys->state == PURGE_STATE_STOP);",
          "content_same": false
        },
        {
          "line": 2198,
          "old_api": null,
          "new_api": "que_run_threads",
          "old_text": null,
          "new_text": "que_run_threads(thr)",
          "old_line_content": "    ++purge_sys->n_submitted;",
          "new_line_content": "    que_run_threads(thr);",
          "content_same": false
        },
        {
          "line": 2327,
          "old_api": null,
          "new_api": "ib::info(ER_IB_MSG_1183)",
          "old_text": null,
          "new_text": "ib::info(ER_IB_MSG_1183)",
          "old_line_content": "",
          "new_line_content": "      ib::info(ER_IB_MSG_1183) << \"Resuming purge\";",
          "content_same": false
        },
        {
          "line": 2203,
          "old_api": null,
          "new_api": "trx_purge_wait_for_workers_to_complete",
          "old_text": null,
          "new_text": "trx_purge_wait_for_workers_to_complete()",
          "old_line_content": "",
          "new_line_content": "      trx_purge_wait_for_workers_to_complete();",
          "content_same": false
        },
        {
          "line": 2332,
          "old_api": null,
          "new_api": "MONITOR_INC_VALUE",
          "old_text": null,
          "new_text": "MONITOR_INC_VALUE(MONITOR_PURGE_RESUME_COUNT, 1)",
          "old_line_content": "    }",
          "new_line_content": "    MONITOR_INC_VALUE(MONITOR_PURGE_RESUME_COUNT, 1);",
          "content_same": false
        },
        {
          "line": 2207,
          "old_api": null,
          "new_api": "ut_a",
          "old_text": null,
          "new_text": "ut_a(purge_sys->n_submitted == purge_sys->n_completed)",
          "old_line_content": "  }",
          "new_line_content": "  ut_a(purge_sys->n_submitted == purge_sys->n_completed);",
          "content_same": false
        },
        {
          "line": 2337,
          "old_api": null,
          "new_api": "rw_lock_x_unlock",
          "old_text": null,
          "new_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "old_line_content": "  }",
          "new_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2210,
          "old_api": null,
          "new_api": "rw_lock_x_lock",
          "old_text": null,
          "new_text": "rw_lock_x_lock(&purge_sys->latch)",
          "old_line_content": "",
          "new_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2083,
          "old_api": null,
          "new_api": "ulint)((ratio - .995) * 10000)",
          "old_text": null,
          "new_text": "ulint)((ratio - .995) * 10000)",
          "old_line_content": "      statements are delayed by at least 5000",
          "new_line_content": "      delay = (ulint)((ratio - .995) * 10000);",
          "content_same": false
        },
        {
          "line": 2216,
          "old_api": null,
          "new_api": "rw_lock_x_unlock",
          "old_text": null,
          "new_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "old_line_content": "    purge_sys->done = purge_sys->limit;",
          "new_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2090,
          "old_api": null,
          "new_api": "MONITOR_SET",
          "old_text": null,
          "new_text": "MONITOR_SET(MONITOR_DML_PURGE_DELAY, delay)",
          "old_line_content": "    }",
          "new_line_content": "    MONITOR_SET(MONITOR_DML_PURGE_DELAY, delay);",
          "content_same": false
        },
        {
          "line": 2347,
          "old_api": null,
          "new_api": "reserve",
          "old_text": null,
          "new_text": "m_spaces.reserve(FSP_MAX_UNDO_TABLESPACES)",
          "old_line_content": "  allocations for inserts. This way the contents can be",
          "new_line_content": "  m_spaces.reserve(FSP_MAX_UNDO_TABLESPACES);",
          "content_same": false
        },
        {
          "line": 2224,
          "old_api": null,
          "new_api": "trx_purge_truncate",
          "old_text": null,
          "new_text": "trx_purge_truncate()",
          "old_line_content": "  length. */",
          "new_line_content": "    trx_purge_truncate();",
          "content_same": false
        },
        {
          "line": 2227,
          "old_api": null,
          "new_api": "MONITOR_INC_VALUE",
          "old_text": null,
          "new_text": "MONITOR_INC_VALUE(MONITOR_PURGE_INVOKED, 1)",
          "old_line_content": "  }",
          "new_line_content": "  MONITOR_INC_VALUE(MONITOR_PURGE_INVOKED, 1);",
          "content_same": false
        },
        {
          "line": 2228,
          "old_api": null,
          "new_api": "MONITOR_INC_VALUE",
          "old_text": null,
          "new_text": "MONITOR_INC_VALUE(MONITOR_PURGE_N_PAGE_HANDLED, n_pages_handled)",
          "old_line_content": "",
          "new_line_content": "  MONITOR_INC_VALUE(MONITOR_PURGE_N_PAGE_HANDLED, n_pages_handled);",
          "content_same": false
        },
        {
          "line": 2102,
          "old_api": null,
          "new_api": "os_compare_and_swap_ulint",
          "old_text": null,
          "new_text": "os_compare_and_swap_ulint(&purge_sys->n_completed, n_submitted,\n                                    n_submitted)",
          "old_line_content": "",
          "new_line_content": "  while (!os_compare_and_swap_ulint(&purge_sys->n_completed, n_submitted,",
          "content_same": false
        },
        {
          "line": 2358,
          "old_api": null,
          "new_api": "clear",
          "old_text": null,
          "new_text": "clear()",
          "old_line_content": "/** De-initialize the undo::Tablespaces object. */",
          "new_line_content": "  clear();",
          "content_same": false
        },
        {
          "line": 2105,
          "old_api": null,
          "new_api": "os_thread_yield",
          "old_text": null,
          "new_text": "os_thread_yield()",
          "old_line_content": "                                    n_submitted)) {",
          "new_line_content": "      os_thread_yield();",
          "content_same": false
        },
        {
          "line": 2361,
          "old_api": null,
          "new_api": "ut_free",
          "old_text": null,
          "new_text": "ut_free(m_latch)",
          "old_line_content": "",
          "new_line_content": "  ut_free(m_latch);",
          "content_same": false
        },
        {
          "line": 2108,
          "old_api": null,
          "new_api": "srv_release_threads",
          "old_text": null,
          "new_text": "srv_release_threads(SRV_WORKER, 1)",
          "old_line_content": "    } else {",
          "new_line_content": "        srv_release_threads(SRV_WORKER, 1);",
          "content_same": false
        },
        {
          "line": 2238,
          "old_api": null,
          "new_api": "rw_lock_x_lock",
          "old_text": null,
          "new_text": "rw_lock_x_lock(&purge_sys->latch)",
          "old_line_content": "  purge_state_t state;",
          "new_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2111,
          "old_api": null,
          "new_api": "os_thread_sleep",
          "old_text": null,
          "new_text": "os_thread_sleep(20)",
          "old_line_content": "      }",
          "new_line_content": "      os_thread_sleep(20);",
          "content_same": false
        },
        {
          "line": 2242,
          "old_api": null,
          "new_api": "rw_lock_x_unlock",
          "old_text": null,
          "new_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "old_line_content": "  state = purge_sys->state;",
          "new_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2372,
          "old_api": null,
          "new_api": "id",
          "old_text": null,
          "new_text": "ref_undo_space.id()",
          "old_line_content": "@param[in]\tref_undo_space\tundo tablespace */",
          "new_line_content": "  ut_ad(is_reserved(ref_undo_space.id()));",
          "content_same": false
        },
        {
          "line": 2117,
          "old_api": null,
          "new_api": "ut_a",
          "old_text": null,
          "new_text": "ut_a(purge_sys->n_submitted == purge_sys->n_completed)",
          "old_line_content": "",
          "new_line_content": "  ut_a(purge_sys->n_submitted == purge_sys->n_completed);",
          "content_same": false
        },
        {
          "line": 2121,
          "old_api": null,
          "new_api": "srv_get_task_queue_length",
          "old_text": null,
          "new_text": "srv_get_task_queue_length()",
          "old_line_content": "  /* There should be no outstanding tasks as long",
          "new_line_content": "  ut_a(srv_get_task_queue_length() == 0);",
          "content_same": false
        },
        {
          "line": 2250,
          "old_api": null,
          "new_api": "os_event_reset",
          "old_text": null,
          "new_text": "os_event_reset(purge_sys->event)",
          "old_line_content": "void trx_purge_stop(void) {",
          "new_line_content": "  int64_t sig_count = os_event_reset(purge_sys->event);",
          "content_same": false
        },
        {
          "line": 2378,
          "old_api": null,
          "new_api": "Tablespace",
          "old_text": null,
          "new_text": "Tablespace(ref_undo_space)",
          "old_line_content": "  }",
          "new_line_content": "  auto undo_space = UT_NEW_NOKEY(Tablespace(ref_undo_space));",
          "content_same": false
        },
        {
          "line": 2126,
          "old_api": null,
          "new_api": "trx_purge_check_limit",
          "old_text": null,
          "new_text": "trx_purge_check_limit()",
          "old_line_content": "/** Remove old historical changes from the rollback segments. */",
          "new_line_content": "  ut_ad(trx_purge_check_limit());",
          "content_same": false
        },
        {
          "line": 2129,
          "old_api": null,
          "new_api": "trx_purge_truncate_history",
          "old_text": null,
          "new_text": "trx_purge_truncate_history(&purge_sys->iter, &purge_sys->view)",
          "old_line_content": "",
          "new_line_content": "    trx_purge_truncate_history(&purge_sys->iter, &purge_sys->view);",
          "content_same": false
        },
        {
          "line": 2257,
          "old_api": null,
          "new_api": "ut_a",
          "old_text": null,
          "new_text": "ut_a(purge_sys->state != PURGE_STATE_EXIT)",
          "old_line_content": "",
          "new_line_content": "  ut_a(purge_sys->state != PURGE_STATE_EXIT);",
          "content_same": false
        },
        {
          "line": 2386,
          "old_api": null,
          "new_api": "id",
          "old_text": null,
          "new_text": "undo_space->id()",
          "old_line_content": "@param[in]\tundo_space\tpointer to undo space */",
          "new_line_content": "  ut_ad(is_reserved(undo_space->id()));",
          "content_same": false
        },
        {
          "line": 2387,
          "old_api": null,
          "new_api": "num",
          "old_text": null,
          "new_text": "undo_space->num()",
          "old_line_content": "void undo::Tablespaces::drop(Tablespace *undo_space) {",
          "new_line_content": "  ut_ad(contains(undo_space->num()));",
          "content_same": false
        },
        {
          "line": 2392,
          "old_api": null,
          "new_api": "erase",
          "old_text": null,
          "new_text": "m_spaces.erase(it)",
          "old_line_content": "    if (*it == undo_space) {",
          "new_line_content": "      m_spaces.erase(it);",
          "content_same": false
        },
        {
          "line": 2265,
          "old_api": null,
          "new_api": "ib::info(ER_IB_MSG_1181)",
          "old_text": null,
          "new_text": "ib::info(ER_IB_MSG_1181)",
          "old_line_content": "",
          "new_line_content": "    ib::info(ER_IB_MSG_1181) << \"Stopping purge\";",
          "content_same": false
        },
        {
          "line": 2270,
          "old_api": null,
          "new_api": "srv_purge_wakeup",
          "old_text": null,
          "new_text": "srv_purge_wakeup()",
          "old_line_content": "    so that it can acknowledge the state change. */",
          "new_line_content": "    srv_purge_wakeup();",
          "content_same": false
        },
        {
          "line": 2146,
          "old_api": null,
          "new_api": "ut_a",
          "old_text": null,
          "new_text": "ut_a(n_purge_threads > 0)",
          "old_line_content": "  ulint n_pages_handled;",
          "new_line_content": "  ut_a(n_purge_threads > 0);",
          "content_same": false
        },
        {
          "line": 2275,
          "old_api": null,
          "new_api": "rw_lock_x_unlock",
          "old_text": null,
          "new_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "old_line_content": "  purge_sys->state = PURGE_STATE_STOP;",
          "new_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2151,
          "old_api": null,
          "new_api": "ut_a",
          "old_text": null,
          "new_text": "ut_a(purge_sys->n_submitted == purge_sys->n_completed)",
          "old_line_content": "",
          "new_line_content": "  ut_a(purge_sys->n_submitted == purge_sys->n_completed);",
          "content_same": false
        },
        {
          "line": 2280,
          "old_api": null,
          "new_api": "os_event_wait_low",
          "old_text": null,
          "new_text": "os_event_wait_low(purge_sys->event, sig_count)",
          "old_line_content": "    /* Wait for purge coordinator to signal that it",
          "new_line_content": "    os_event_wait_low(purge_sys->event, sig_count);",
          "content_same": false
        },
        {
          "line": 2284,
          "old_api": null,
          "new_api": "rw_lock_x_lock",
          "old_text": null,
          "new_text": "rw_lock_x_lock(&purge_sys->latch)",
          "old_line_content": "    bool once = true;",
          "new_line_content": "    rw_lock_x_lock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2157,
          "old_api": null,
          "new_api": "clone_oldest_view",
          "old_text": null,
          "new_text": "trx_sys->mvcc->clone_oldest_view(&purge_sys->view)",
          "old_line_content": "  purge_sys->view_active = false;",
          "new_line_content": "  trx_sys->mvcc->clone_oldest_view(&purge_sys->view);",
          "content_same": false
        },
        {
          "line": 2161,
          "old_api": null,
          "new_api": "rw_lock_x_unlock",
          "old_text": null,
          "new_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "old_line_content": "  purge_sys->view_active = true;",
          "new_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2289,
          "old_api": null,
          "new_api": "ib::info(ER_IB_MSG_1182)",
          "old_text": null,
          "new_text": "ib::info(ER_IB_MSG_1182)",
          "old_line_content": "    while (purge_sys->running) {",
          "new_line_content": "        ib::info(ER_IB_MSG_1182) << \"Waiting for purge to stop\";",
          "content_same": false
        },
        {
          "line": 2293,
          "old_api": null,
          "new_api": "rw_lock_x_unlock",
          "old_text": null,
          "new_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "old_line_content": "      }",
          "new_line_content": "      rw_lock_x_unlock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2170,
          "old_api": null,
          "new_api": "trx_purge_attach_undo_recs",
          "old_text": null,
          "new_text": "trx_purge_attach_undo_recs(n_purge_threads, batch_size)",
          "old_line_content": "",
          "new_line_content": "  n_pages_handled = trx_purge_attach_undo_recs(n_purge_threads, batch_size);",
          "content_same": false
        },
        {
          "line": 2300,
          "old_api": null,
          "new_api": "rw_lock_x_unlock",
          "old_text": null,
          "new_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "old_line_content": "    }",
          "new_line_content": "    rw_lock_x_unlock(&purge_sys->latch);",
          "content_same": false
        },
        {
          "line": 2303,
          "old_api": null,
          "new_api": "MONITOR_INC_VALUE",
          "old_text": null,
          "new_text": "MONITOR_INC_VALUE(MONITOR_PURGE_STOP_COUNT, 1)",
          "old_line_content": "  }",
          "new_line_content": "  MONITOR_INC_VALUE(MONITOR_PURGE_STOP_COUNT, 1);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 2305,
          "old_api": "MONITOR_INC_VALUE",
          "new_api": null,
          "old_text": "MONITOR_INC_VALUE(MONITOR_PURGE_STOP_COUNT, 1)",
          "new_text": null,
          "old_line_content": "  MONITOR_INC_VALUE(MONITOR_PURGE_STOP_COUNT, 1);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2182,
          "old_api": "srv_que_task_enqueue_low",
          "new_api": null,
          "old_text": "srv_que_task_enqueue_low(thr)",
          "new_text": null,
          "old_line_content": "      srv_que_task_enqueue_low(thr);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2310,
          "old_api": "rw_lock_x_lock",
          "new_api": null,
          "old_text": "rw_lock_x_lock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "new_line_content": "  switch (purge_sys->state) {",
          "content_same": false
        },
        {
          "line": 2185,
          "old_api": "que_fork_scheduler_round_robin",
          "new_api": null,
          "old_text": "que_fork_scheduler_round_robin(purge_sys->query, thr)",
          "new_text": null,
          "old_line_content": "    thr = que_fork_scheduler_round_robin(purge_sys->query, thr);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2186,
          "old_api": "ut_a",
          "new_api": null,
          "old_text": "ut_a(thr != NULL)",
          "new_text": null,
          "old_line_content": "    ut_a(thr != NULL);",
          "new_line_content": "    purge_sys->n_submitted += n_purge_threads - 1;",
          "content_same": false
        },
        {
          "line": 2194,
          "old_api": "que_fork_scheduler_round_robin",
          "new_api": null,
          "old_text": "que_fork_scheduler_round_robin(purge_sys->query, NULL)",
          "new_text": null,
          "old_line_content": "    thr = que_fork_scheduler_round_robin(purge_sys->query, NULL);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2195,
          "old_api": "ut_ad",
          "new_api": null,
          "old_text": "ut_ad(thr)",
          "new_text": null,
          "old_line_content": "    ut_ad(thr);",
          "new_line_content": "  run_synchronously:",
          "content_same": false
        },
        {
          "line": 2324,
          "old_api": "ut_a",
          "new_api": null,
          "old_text": "ut_a(purge_sys->state == PURGE_STATE_STOP)",
          "new_text": null,
          "old_line_content": "    ut_a(purge_sys->state == PURGE_STATE_STOP);",
          "new_line_content": "    --purge_sys->n_stop;",
          "content_same": false
        },
        {
          "line": 2329,
          "old_api": "ib::info(ER_IB_MSG_1183)",
          "new_api": null,
          "old_text": "ib::info(ER_IB_MSG_1183)",
          "new_text": null,
          "old_line_content": "      ib::info(ER_IB_MSG_1183) << \"Resuming purge\";",
          "new_line_content": "      purge_sys->state = PURGE_STATE_RUN;",
          "content_same": false
        },
        {
          "line": 2202,
          "old_api": "os_atomic_inc_ulint",
          "new_api": null,
          "old_text": "os_atomic_inc_ulint(&purge_sys->pq_mutex, &purge_sys->n_completed, 1)",
          "new_text": null,
          "old_line_content": "    os_atomic_inc_ulint(&purge_sys->pq_mutex, &purge_sys->n_completed, 1);",
          "new_line_content": "    if (n_purge_threads > 1) {",
          "content_same": false
        },
        {
          "line": 2205,
          "old_api": "trx_purge_wait_for_workers_to_complete",
          "new_api": null,
          "old_text": "trx_purge_wait_for_workers_to_complete()",
          "new_text": null,
          "old_line_content": "      trx_purge_wait_for_workers_to_complete();",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 2336,
          "old_api": "ut_a",
          "new_api": null,
          "old_text": "ut_a(purge_sys->state == PURGE_STATE_RUN)",
          "new_text": null,
          "old_line_content": "    ut_a(purge_sys->state == PURGE_STATE_RUN);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2209,
          "old_api": "ut_a",
          "new_api": null,
          "old_text": "ut_a(purge_sys->n_submitted == purge_sys->n_completed)",
          "new_text": null,
          "old_line_content": "  ut_a(purge_sys->n_submitted == purge_sys->n_completed);",
          "new_line_content": "#ifdef UNIV_DEBUG",
          "content_same": false
        },
        {
          "line": 2212,
          "old_api": "rw_lock_x_lock",
          "new_api": null,
          "old_text": "rw_lock_x_lock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "new_line_content": "    purge_sys->done = purge_sys->iter;",
          "content_same": false
        },
        {
          "line": 2085,
          "old_api": "ulint)((ratio - .5) * 10000)",
          "new_api": null,
          "old_text": "ulint)((ratio - .5) * 10000)",
          "new_text": null,
          "old_line_content": "      delay = (ulint)((ratio - .5) * 10000);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2341,
          "old_api": "srv_purge_wakeup",
          "new_api": null,
          "old_text": "srv_purge_wakeup()",
          "new_text": null,
          "old_line_content": "  srv_purge_wakeup();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2218,
          "old_api": "rw_lock_x_unlock",
          "new_api": null,
          "old_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2092,
          "old_api": "MONITOR_SET",
          "new_api": null,
          "old_text": "MONITOR_SET(MONITOR_DML_PURGE_DELAY, delay)",
          "new_text": null,
          "old_line_content": "    MONITOR_SET(MONITOR_DML_PURGE_DELAY, delay);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2226,
          "old_api": "trx_purge_truncate",
          "new_api": null,
          "old_text": "trx_purge_truncate()",
          "new_text": null,
          "old_line_content": "    trx_purge_truncate();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2355,
          "old_api": "mutex_create",
          "new_api": null,
          "old_text": "mutex_create(LATCH_ID_UNDO_DDL, &ddl_mutex)",
          "new_text": null,
          "old_line_content": "  mutex_create(LATCH_ID_UNDO_DDL, &ddl_mutex);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2229,
          "old_api": "MONITOR_INC_VALUE",
          "new_api": null,
          "old_text": "MONITOR_INC_VALUE(MONITOR_PURGE_INVOKED, 1)",
          "new_text": null,
          "old_line_content": "  MONITOR_INC_VALUE(MONITOR_PURGE_INVOKED, 1);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2230,
          "old_api": "MONITOR_INC_VALUE",
          "new_api": null,
          "old_text": "MONITOR_INC_VALUE(MONITOR_PURGE_N_PAGE_HANDLED, n_pages_handled)",
          "new_text": null,
          "old_line_content": "  MONITOR_INC_VALUE(MONITOR_PURGE_N_PAGE_HANDLED, n_pages_handled);",
          "new_line_content": "  return (n_pages_handled);",
          "content_same": false
        },
        {
          "line": 2104,
          "old_api": "os_compare_and_swap_ulint",
          "new_api": null,
          "old_text": "os_compare_and_swap_ulint(&purge_sys->n_completed, n_submitted,\n                                    n_submitted)",
          "new_text": null,
          "old_line_content": "  while (!os_compare_and_swap_ulint(&purge_sys->n_completed, n_submitted,",
          "new_line_content": "    if (++i < 10) {",
          "content_same": false
        },
        {
          "line": 2362,
          "old_api": "rw_lock_free",
          "new_api": null,
          "old_text": "rw_lock_free(m_latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_free(m_latch);",
          "new_line_content": "  m_latch = nullptr;",
          "content_same": false
        },
        {
          "line": 2109,
          "old_api": "srv_get_task_queue_length",
          "new_api": null,
          "old_text": "srv_get_task_queue_length()",
          "new_text": null,
          "old_line_content": "      if (srv_get_task_queue_length() > 0) {",
          "new_line_content": "      }",
          "content_same": false
        },
        {
          "line": 2110,
          "old_api": "srv_release_threads",
          "new_api": null,
          "old_text": "srv_release_threads(SRV_WORKER, 1)",
          "new_text": null,
          "old_line_content": "        srv_release_threads(SRV_WORKER, 1);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2365,
          "old_api": "mutex_free",
          "new_api": null,
          "old_text": "mutex_free(&ddl_mutex)",
          "new_text": null,
          "old_line_content": "  mutex_free(&ddl_mutex);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2240,
          "old_api": "rw_lock_x_lock",
          "new_api": null,
          "old_text": "rw_lock_x_lock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "new_line_content": "  state = purge_sys->state;",
          "content_same": false
        },
        {
          "line": 2113,
          "old_api": "os_thread_sleep",
          "new_api": null,
          "old_text": "os_thread_sleep(20)",
          "new_text": null,
          "old_line_content": "      os_thread_sleep(20);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 2244,
          "old_api": "rw_lock_x_unlock",
          "new_api": null,
          "old_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "new_line_content": "  return (state);",
          "content_same": false
        },
        {
          "line": 2119,
          "old_api": "ut_a",
          "new_api": null,
          "old_text": "ut_a(purge_sys->n_submitted == purge_sys->n_completed)",
          "new_text": null,
          "old_line_content": "  ut_a(purge_sys->n_submitted == purge_sys->n_completed);",
          "new_line_content": "  /* There should be no outstanding tasks as long",
          "content_same": false
        },
        {
          "line": 2376,
          "old_api": "num",
          "new_api": null,
          "old_text": "ref_undo_space.num()",
          "new_text": null,
          "old_line_content": "  if (contains(ref_undo_space.num())) {",
          "new_line_content": "  }",
          "content_same": false
        },
        {
          "line": 2123,
          "old_api": "srv_get_task_queue_length",
          "new_api": null,
          "old_text": "srv_get_task_queue_length()",
          "new_text": null,
          "old_line_content": "  ut_a(srv_get_task_queue_length() == 0);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2382,
          "old_api": "push_back",
          "new_api": null,
          "old_text": "m_spaces.push_back(undo_space)",
          "new_text": null,
          "old_line_content": "  m_spaces.push_back(undo_space);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2128,
          "old_api": "trx_purge_check_limit",
          "new_api": null,
          "old_text": "trx_purge_check_limit()",
          "new_text": null,
          "old_line_content": "  ut_ad(trx_purge_check_limit());",
          "new_line_content": "  if (purge_sys->limit.trx_no == 0) {",
          "content_same": false
        },
        {
          "line": 2259,
          "old_api": "ut_a",
          "new_api": null,
          "old_text": "ut_a(purge_sys->state != PURGE_STATE_EXIT)",
          "new_text": null,
          "old_line_content": "  ut_a(purge_sys->state != PURGE_STATE_EXIT);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2260,
          "old_api": "ut_a",
          "new_api": null,
          "old_text": "ut_a(purge_sys->state != PURGE_STATE_DISABLED)",
          "new_text": null,
          "old_line_content": "  ut_a(purge_sys->state != PURGE_STATE_DISABLED);",
          "new_line_content": "  ++purge_sys->n_stop;",
          "content_same": false
        },
        {
          "line": 2133,
          "old_api": "trx_purge_truncate_history",
          "new_api": null,
          "old_text": "trx_purge_truncate_history(&purge_sys->limit, &purge_sys->view)",
          "new_text": null,
          "old_line_content": "    trx_purge_truncate_history(&purge_sys->limit, &purge_sys->view);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 2388,
          "old_api": "id",
          "new_api": null,
          "old_text": "undo_space->id()",
          "new_text": null,
          "old_line_content": "  ut_ad(is_reserved(undo_space->id()));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2393,
          "old_api": "UT_DELETE",
          "new_api": null,
          "old_text": "UT_DELETE(undo_space)",
          "new_text": null,
          "old_line_content": "      UT_DELETE(undo_space);",
          "new_line_content": "      break;",
          "content_same": false
        },
        {
          "line": 2394,
          "old_api": "erase",
          "new_api": null,
          "old_text": "m_spaces.erase(it)",
          "new_text": null,
          "old_line_content": "      m_spaces.erase(it);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 2267,
          "old_api": "ib::info(ER_IB_MSG_1181)",
          "new_api": null,
          "old_text": "ib::info(ER_IB_MSG_1181)",
          "new_text": null,
          "old_line_content": "    ib::info(ER_IB_MSG_1181) << \"Stopping purge\";",
          "new_line_content": "    /* We need to wakeup the purge thread in case it is suspended,",
          "content_same": false
        },
        {
          "line": 2272,
          "old_api": "srv_purge_wakeup",
          "new_api": null,
          "old_text": "srv_purge_wakeup()",
          "new_text": null,
          "old_line_content": "    srv_purge_wakeup();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2277,
          "old_api": "rw_lock_x_unlock",
          "new_api": null,
          "old_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "new_line_content": "  if (state != PURGE_STATE_STOP) {",
          "content_same": false
        },
        {
          "line": 2150,
          "old_api": "trx_purge_dml_delay",
          "new_api": null,
          "old_text": "trx_purge_dml_delay()",
          "new_text": null,
          "old_line_content": "  srv_dml_needed_delay = trx_purge_dml_delay();",
          "new_line_content": "  /* The number of tasks submitted should be completed. */",
          "content_same": false
        },
        {
          "line": 2282,
          "old_api": "os_event_wait_low",
          "new_api": null,
          "old_text": "os_event_wait_low(purge_sys->event, sig_count)",
          "new_text": null,
          "old_line_content": "    os_event_wait_low(purge_sys->event, sig_count);",
          "new_line_content": "    bool once = true;",
          "content_same": false
        },
        {
          "line": 2155,
          "old_api": "rw_lock_x_lock",
          "new_api": null,
          "old_text": "rw_lock_x_lock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_x_lock(&purge_sys->latch);",
          "new_line_content": "  purge_sys->view_active = false;",
          "content_same": false
        },
        {
          "line": 2286,
          "old_api": "rw_lock_x_lock",
          "new_api": null,
          "old_text": "rw_lock_x_lock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "    rw_lock_x_lock(&purge_sys->latch);",
          "new_line_content": "    /* Wait for purge to signal that it has actually stopped. */",
          "content_same": false
        },
        {
          "line": 2159,
          "old_api": "clone_oldest_view",
          "new_api": null,
          "old_text": "trx_sys->mvcc->clone_oldest_view(&purge_sys->view)",
          "new_text": null,
          "old_line_content": "  trx_sys->mvcc->clone_oldest_view(&purge_sys->view);",
          "new_line_content": "  purge_sys->view_active = true;",
          "content_same": false
        },
        {
          "line": 2163,
          "old_api": "rw_lock_x_unlock",
          "new_api": null,
          "old_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "  rw_lock_x_unlock(&purge_sys->latch);",
          "new_line_content": "#ifdef UNIV_DEBUG",
          "content_same": false
        },
        {
          "line": 2291,
          "old_api": "ib::info(ER_IB_MSG_1182)",
          "new_api": null,
          "old_text": "ib::info(ER_IB_MSG_1182)",
          "new_text": null,
          "old_line_content": "        ib::info(ER_IB_MSG_1182) << \"Waiting for purge to stop\";",
          "new_line_content": "      }",
          "content_same": false
        },
        {
          "line": 2299,
          "old_api": "rw_lock_x_lock",
          "new_api": null,
          "old_text": "rw_lock_x_lock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "      rw_lock_x_lock(&purge_sys->latch);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 2172,
          "old_api": "trx_purge_attach_undo_recs",
          "new_api": null,
          "old_text": "trx_purge_attach_undo_recs(n_purge_threads, batch_size)",
          "new_text": null,
          "old_line_content": "  n_pages_handled = trx_purge_attach_undo_recs(n_purge_threads, batch_size);",
          "new_line_content": "  /* Do we do an asynchronous purge or not ? */",
          "content_same": false
        },
        {
          "line": 2302,
          "old_api": "rw_lock_x_unlock",
          "new_api": null,
          "old_text": "rw_lock_x_unlock(&purge_sys->latch)",
          "new_text": null,
          "old_line_content": "    rw_lock_x_unlock(&purge_sys->latch);",
          "new_line_content": "",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 22,
      "total_additions": 54,
      "total_deletions": 54,
      "total_api_changes": 130
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 5,
        "api_related_lines": 130,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          2081,
          2082,
          2084
        ]
      }
    },
    "api_calls_before": 620,
    "api_calls_after": 620,
    "diff_info": {
      "added_lines": 3,
      "removed_lines": 5,
      "total_diff_lines": 20
    }
  }
}