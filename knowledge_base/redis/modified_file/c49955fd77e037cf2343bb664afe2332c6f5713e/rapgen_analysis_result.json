{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/c49955fd77e037cf2343bb664afe2332c6f5713e",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/c49955fd77e037cf2343bb664afe2332c6f5713e/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/c49955fd77e037cf2343bb664afe2332c6f5713e/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/c49955fd77e037cf2343bb664afe2332c6f5713e/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 873,
          "old_api": "lua_isnil",
          "new_api": "lua_getglobal",
          "old_text": "lua_isnil(lua,-1)",
          "new_text": "lua_getglobal(lua, \"__redis__err__handler\")",
          "old_line_content": "    if (lua_isnil(lua,-1)) {",
          "new_line_content": "    lua_getglobal(lua, \"__redis__err__handler\");",
          "content_same": false
        },
        {
          "line": 883,
          "old_api": "luaCreateFunction",
          "new_api": "lua_pop",
          "old_text": "luaCreateFunction(c,lua,funcname,c->argv[1])",
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "        if (luaCreateFunction(c,lua,funcname,c->argv[1]) == REDIS_ERR) {",
          "new_line_content": "            lua_pop(lua,1); /* remove the error handler from the stack. */",
          "content_same": false
        },
        {
          "line": 884,
          "old_api": "lua_pop",
          "new_api": "addReply",
          "old_text": "lua_pop(lua,1)",
          "new_text": "addReply(c, shared.noscripterr)",
          "old_line_content": "            lua_pop(lua,1); /* remove the error handler from the stack. */",
          "new_line_content": "            addReply(c, shared.noscripterr);",
          "content_same": false
        },
        {
          "line": 900,
          "old_api": "selectDb",
          "new_api": "luaSetGlobalArray",
          "old_text": "selectDb(server.lua_client,c->db->id)",
          "new_text": "luaSetGlobalArray(lua,\"KEYS\",c->argv+3,numkeys)",
          "old_line_content": "    selectDb(server.lua_client,c->db->id);",
          "new_line_content": "    luaSetGlobalArray(lua,\"KEYS\",c->argv+3,numkeys);",
          "content_same": false
        },
        {
          "line": 929,
          "old_api": "selectDb",
          "new_api": "aeCreateFileEvent",
          "old_text": "selectDb(c,server.lua_client->db->id)",
          "new_text": "aeCreateFileEvent(server.el,c->fd,AE_READABLE,\n                          readQueryFromClient,c)",
          "old_line_content": "    selectDb(c,server.lua_client->db->id); /* set DB ID from Lua client */",
          "new_line_content": "        aeCreateFileEvent(server.el,c->fd,AE_READABLE,",
          "content_same": false
        },
        {
          "line": 933,
          "old_api": "addReplyErrorFormat",
          "new_api": "selectDb",
          "old_text": "addReplyErrorFormat(c,\"Error running script (call to %s): %s\\n\",\n            funcname, lua_tostring(lua,-1))",
          "new_text": "selectDb(c,server.lua_client->db->id)",
          "old_line_content": "        addReplyErrorFormat(c,\"Error running script (call to %s): %s\\n\",",
          "new_line_content": "    selectDb(c,server.lua_client->db->id); /* set DB ID from Lua client */",
          "content_same": false
        },
        {
          "line": 934,
          "old_api": "lua_tostring",
          "new_api": "lua_gc",
          "old_text": "lua_tostring(lua,-1)",
          "new_text": "lua_gc(lua,LUA_GCSTEP,1)",
          "old_line_content": "            funcname, lua_tostring(lua,-1));",
          "new_line_content": "    lua_gc(lua,LUA_GCSTEP,1);",
          "content_same": false
        },
        {
          "line": 939,
          "old_api": "luaReplyToRedisReply",
          "new_api": "lua_pop",
          "old_text": "luaReplyToRedisReply(c,lua)",
          "new_text": "lua_pop(lua,2)",
          "old_line_content": "        luaReplyToRedisReply(c,lua); /* Convert and consume the reply. */",
          "new_line_content": "        lua_pop(lua,2); /* Consume the Lua reply and remove error handler. */",
          "content_same": false
        },
        {
          "line": 958,
          "old_api": "dictFetchValue",
          "new_api": "replicationScriptCacheExists",
          "old_text": "dictFetchValue(server.lua_scripts,c->argv[1]->ptr)",
          "new_text": "replicationScriptCacheExists(c->argv[1]->ptr)",
          "old_line_content": "            robj *script = dictFetchValue(server.lua_scripts,c->argv[1]->ptr);",
          "new_line_content": "        if (!replicationScriptCacheExists(c->argv[1]->ptr)) {",
          "content_same": false
        },
        {
          "line": 962,
          "old_api": "rewriteClientCommandArgument",
          "new_api": "dictFetchValue",
          "old_text": "rewriteClientCommandArgument(c,0,\n                resetRefCount(createStringObject(\"EVAL\",4)))",
          "new_text": "dictFetchValue(server.lua_scripts,c->argv[1]->ptr)",
          "old_line_content": "            rewriteClientCommandArgument(c,0,",
          "new_line_content": "            robj *script = dictFetchValue(server.lua_scripts,c->argv[1]->ptr);",
          "content_same": false
        },
        {
          "line": 964,
          "old_api": "rewriteClientCommandArgument",
          "new_api": "replicationScriptCacheAdd",
          "old_text": "rewriteClientCommandArgument(c,1,script)",
          "new_text": "replicationScriptCacheAdd(c->argv[1]->ptr)",
          "old_line_content": "            rewriteClientCommandArgument(c,1,script);",
          "new_line_content": "            replicationScriptCacheAdd(c->argv[1]->ptr);",
          "content_same": false
        },
        {
          "line": 965,
          "old_api": "forceCommandPropagation",
          "new_api": "redisAssertWithInfo",
          "old_text": "forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF)",
          "new_text": "redisAssertWithInfo(c,NULL,script != NULL)",
          "old_line_content": "            forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF);",
          "new_line_content": "            redisAssertWithInfo(c,NULL,script != NULL);",
          "content_same": false
        },
        {
          "line": 975,
          "old_api": "sdslen",
          "new_api": "evalGenericCommand",
          "old_text": "sdslen(c->argv[1]->ptr)",
          "new_text": "evalGenericCommand(c,0)",
          "old_line_content": "    if (sdslen(c->argv[1]->ptr) != 40) {",
          "new_line_content": "    evalGenericCommand(c,0);",
          "content_same": false
        },
        {
          "line": 999,
          "old_api": "lua_pushnumber",
          "new_api": "redisLrand48",
          "old_text": "lua_pushnumber(L, r)",
          "new_text": "redisLrand48()",
          "old_line_content": "      lua_pushnumber(L, r);  /* Number between 0 and 1 */",
          "new_line_content": "  lua_Number r = (lua_Number)(redisLrand48()%REDIS_LRAND48_MAX) /",
          "content_same": false
        },
        {
          "line": 1003,
          "old_api": "luaL_checkint",
          "new_api": "lua_pushnumber",
          "old_text": "luaL_checkint(L, 1)",
          "new_text": "lua_pushnumber(L, r)",
          "old_line_content": "      int u = luaL_checkint(L, 1);",
          "new_line_content": "      lua_pushnumber(L, r);  /* Number between 0 and 1 */",
          "content_same": false
        },
        {
          "line": 1009,
          "old_api": "luaL_checkint",
          "new_api": "floor",
          "old_text": "luaL_checkint(L, 1)",
          "new_text": "floor(r*u)",
          "old_line_content": "      int l = luaL_checkint(L, 1);",
          "new_line_content": "      lua_pushnumber(L, floor(r*u)+1);  /* int between 1 and `u' */",
          "content_same": false
        },
        {
          "line": 1015,
          "old_api": "luaL_error",
          "new_api": "luaL_argcheck",
          "old_text": "luaL_error(L, \"wrong number of arguments\")",
          "new_text": "luaL_argcheck(L, l<=u, 2, \"interval is empty\")",
          "old_line_content": "    default: return luaL_error(L, \"wrong number of arguments\");",
          "new_line_content": "      luaL_argcheck(L, l<=u, 2, \"interval is empty\");",
          "content_same": false
        },
        {
          "line": 1035,
          "old_api": "strcasecmp",
          "new_api": "scriptingReset",
          "old_text": "strcasecmp(c->argv[1]->ptr,\"exists\")",
          "new_text": "scriptingReset()",
          "old_line_content": "    } else if (c->argc >= 2 && !strcasecmp(c->argv[1]->ptr,\"exists\")) {",
          "new_line_content": "        scriptingReset();",
          "content_same": false
        },
        {
          "line": 1045,
          "old_api": "strcasecmp",
          "new_api": "addReply",
          "old_text": "strcasecmp(c->argv[1]->ptr,\"load\")",
          "new_text": "addReply(c,shared.cone)",
          "old_line_content": "    } else if (c->argc == 3 && !strcasecmp(c->argv[1]->ptr,\"load\")) {",
          "new_line_content": "                addReply(c,shared.cone);",
          "content_same": false
        },
        {
          "line": 1056,
          "old_api": "sdsfree",
          "new_api": "sdsnewlen",
          "old_text": "sdsfree(sha)",
          "new_text": "sdsnewlen(funcname+2,40)",
          "old_line_content": "                sdsfree(sha);",
          "new_line_content": "        sha = sdsnewlen(funcname+2,40);",
          "content_same": false
        },
        {
          "line": 1060,
          "old_api": "addReplyBulkCBuffer",
          "new_api": "sdsfree",
          "old_text": "addReplyBulkCBuffer(c,funcname+2,40)",
          "new_text": "sdsfree(sha)",
          "old_line_content": "        addReplyBulkCBuffer(c,funcname+2,40);",
          "new_line_content": "                sdsfree(sha);",
          "content_same": false
        },
        {
          "line": 1065,
          "old_api": "sdsnew",
          "new_api": "sdsfree",
          "old_text": "sdsnew(\"-NOTBUSY No scripts in execution right now.\\r\\n\")",
          "new_text": "sdsfree(sha)",
          "old_line_content": "            addReplySds(c,sdsnew(\"-NOTBUSY No scripts in execution right now.\\r\\n\"));",
          "new_line_content": "        sdsfree(sha);",
          "content_same": false
        },
        {
          "line": 1067,
          "old_api": "sdsnew",
          "new_api": "strcasecmp",
          "old_text": "sdsnew(\"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\\r\\n\")",
          "new_text": "strcasecmp(c->argv[1]->ptr,\"kill\")",
          "old_line_content": "            addReplySds(c,sdsnew(\"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\\r\\n\"));",
          "new_line_content": "    } else if (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\"kill\")) {",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 1025,
          "old_api": null,
          "new_api": "luaL_checkint",
          "old_text": null,
          "new_text": "luaL_checkint(L, 1)",
          "old_line_content": "/* ---------------------------------------------------------------------------",
          "new_line_content": "  redisSrand48(luaL_checkint(L, 1));",
          "content_same": false
        },
        {
          "line": 901,
          "old_api": null,
          "new_api": "luaSetGlobalArray",
          "old_text": null,
          "new_text": "luaSetGlobalArray(lua,\"ARGV\",c->argv+3+numkeys,c->argc-3-numkeys)",
          "old_line_content": "    ",
          "new_line_content": "    luaSetGlobalArray(lua,\"ARGV\",c->argv+3+numkeys,c->argc-3-numkeys);",
          "content_same": false
        },
        {
          "line": 904,
          "old_api": null,
          "new_api": "selectDb",
          "old_text": null,
          "new_text": "selectDb(server.lua_client,c->db->id)",
          "old_line_content": "     * We set the hook only if the time limit is enabled as the hook will",
          "new_line_content": "    selectDb(server.lua_client,c->db->id);",
          "content_same": false
        },
        {
          "line": 1034,
          "old_api": null,
          "new_api": "strcasecmp",
          "old_text": null,
          "new_text": "strcasecmp(c->argv[1]->ptr,\"flush\")",
          "old_line_content": "        server.dirty++; /* Propagating this command is a good idea. */",
          "new_line_content": "    if (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\"flush\")) {",
          "content_same": false
        },
        {
          "line": 1036,
          "old_api": null,
          "new_api": "addReply",
          "old_text": null,
          "new_text": "addReply(c,shared.ok)",
          "old_line_content": "        int j;",
          "new_line_content": "        addReply(c,shared.ok);",
          "content_same": false
        },
        {
          "line": 1037,
          "old_api": null,
          "new_api": "replicationScriptCacheFlush",
          "old_text": null,
          "new_text": "replicationScriptCacheFlush()",
          "old_line_content": "",
          "new_line_content": "        replicationScriptCacheFlush();",
          "content_same": false
        },
        {
          "line": 911,
          "old_api": null,
          "new_api": "mstime",
          "old_text": null,
          "new_text": "mstime()",
          "old_line_content": "        delhook = 1;",
          "new_line_content": "    server.lua_time_start = mstime();",
          "content_same": false
        },
        {
          "line": 1039,
          "old_api": null,
          "new_api": "strcasecmp",
          "old_text": null,
          "new_text": "strcasecmp(c->argv[1]->ptr,\"exists\")",
          "old_line_content": "        for (j = 2; j < c->argc; j++) {",
          "new_line_content": "    } else if (c->argc >= 2 && !strcasecmp(c->argv[1]->ptr,\"exists\")) {",
          "content_same": false
        },
        {
          "line": 914,
          "old_api": null,
          "new_api": "lua_sethook",
          "old_text": null,
          "new_text": "lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000)",
          "old_line_content": "    /* At this point whether this script was never seen before or if it was",
          "new_line_content": "        lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000);",
          "content_same": false
        },
        {
          "line": 1042,
          "old_api": null,
          "new_api": "addReplyMultiBulkLen",
          "old_text": null,
          "new_text": "addReplyMultiBulkLen(c, c->argc-2)",
          "old_line_content": "            else",
          "new_line_content": "        addReplyMultiBulkLen(c, c->argc-2);",
          "content_same": false
        },
        {
          "line": 1044,
          "old_api": null,
          "new_api": "dictFind",
          "old_text": null,
          "new_text": "dictFind(server.lua_scripts,c->argv[j]->ptr)",
          "old_line_content": "        }",
          "new_line_content": "            if (dictFind(server.lua_scripts,c->argv[j]->ptr))",
          "content_same": false
        },
        {
          "line": 1047,
          "old_api": null,
          "new_api": "addReply",
          "old_text": null,
          "new_text": "addReply(c,shared.czero)",
          "old_line_content": "        sds sha;",
          "new_line_content": "                addReply(c,shared.czero);",
          "content_same": false
        },
        {
          "line": 921,
          "old_api": null,
          "new_api": "lua_pcall",
          "old_text": null,
          "new_text": "lua_pcall(lua,0,1,-2)",
          "old_line_content": "    if (server.lua_timedout) {",
          "new_line_content": "    err = lua_pcall(lua,0,1,-2);",
          "content_same": false
        },
        {
          "line": 1049,
          "old_api": null,
          "new_api": "strcasecmp",
          "old_text": null,
          "new_text": "strcasecmp(c->argv[1]->ptr,\"load\")",
          "old_line_content": "        funcname[0] = 'f';",
          "new_line_content": "    } else if (c->argc == 3 && !strcasecmp(c->argv[1]->ptr,\"load\")) {",
          "content_same": false
        },
        {
          "line": 924,
          "old_api": null,
          "new_api": "lua_sethook",
          "old_text": null,
          "new_text": "lua_sethook(lua,luaMaskCountHook,0,0)",
          "old_line_content": "         * script timeout was detected. */",
          "new_line_content": "    if (delhook) lua_sethook(lua,luaMaskCountHook,0,0); /* Disable hook */",
          "content_same": false
        },
        {
          "line": 1055,
          "old_api": null,
          "new_api": "sdslen",
          "old_text": null,
          "new_text": "sdslen(c->argv[2]->ptr)",
          "old_line_content": "                    == REDIS_ERR) {",
          "new_line_content": "        sha1hex(funcname+2,c->argv[2]->ptr,sdslen(c->argv[2]->ptr));",
          "content_same": false
        },
        {
          "line": 1057,
          "old_api": null,
          "new_api": "dictFind",
          "old_text": null,
          "new_text": "dictFind(server.lua_scripts,sha)",
          "old_line_content": "                return;",
          "new_line_content": "        if (dictFind(server.lua_scripts,sha) == NULL) {",
          "content_same": false
        },
        {
          "line": 1058,
          "old_api": null,
          "new_api": "luaCreateFunction",
          "old_text": null,
          "new_text": "luaCreateFunction(c,server.lua,funcname,c->argv[2])",
          "old_line_content": "            }",
          "new_line_content": "            if (luaCreateFunction(c,server.lua,funcname,c->argv[2])",
          "content_same": false
        },
        {
          "line": 1064,
          "old_api": null,
          "new_api": "addReplyBulkCBuffer",
          "old_text": null,
          "new_text": "addReplyBulkCBuffer(c,funcname+2,40)",
          "old_line_content": "        if (server.lua_caller == NULL) {",
          "new_line_content": "        addReplyBulkCBuffer(c,funcname+2,40);",
          "content_same": false
        },
        {
          "line": 937,
          "old_api": null,
          "new_api": "addReplyErrorFormat",
          "old_text": null,
          "new_text": "addReplyErrorFormat(c,\"Error running script (call to %s): %s\\n\",\n            funcname, lua_tostring(lua,-1))",
          "old_line_content": "        /* On success convert the Lua return value into Redis protocol, and",
          "new_line_content": "        addReplyErrorFormat(c,\"Error running script (call to %s): %s\\n\",",
          "content_same": false
        },
        {
          "line": 938,
          "old_api": null,
          "new_api": "lua_tostring",
          "old_text": null,
          "new_text": "lua_tostring(lua,-1)",
          "old_line_content": "         * send it to * the client. */",
          "new_line_content": "            funcname, lua_tostring(lua,-1));",
          "content_same": false
        },
        {
          "line": 1066,
          "old_api": null,
          "new_api": "forceCommandPropagation",
          "old_text": null,
          "new_text": "forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF)",
          "old_line_content": "        } else if (server.lua_write_dirty) {",
          "new_line_content": "        forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF);",
          "content_same": false
        },
        {
          "line": 1069,
          "old_api": null,
          "new_api": "sdsnew",
          "old_text": null,
          "new_text": "sdsnew(\"-NOTBUSY No scripts in execution right now.\\r\\n\")",
          "old_line_content": "            server.lua_kill = 1;",
          "new_line_content": "            addReplySds(c,sdsnew(\"-NOTBUSY No scripts in execution right now.\\r\\n\"));",
          "content_same": false
        },
        {
          "line": 943,
          "old_api": null,
          "new_api": "luaReplyToRedisReply",
          "old_text": null,
          "new_text": "luaReplyToRedisReply(c,lua)",
          "old_line_content": "    /* EVALSHA should be propagated to Slave and AOF file as full EVAL, unless",
          "new_line_content": "        luaReplyToRedisReply(c,lua); /* Convert and consume the reply. */",
          "content_same": false
        },
        {
          "line": 944,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "     * we are sure that the script was already in the context of all the",
          "new_line_content": "        lua_pop(lua,1); /* Remove the error handler. */",
          "content_same": false
        },
        {
          "line": 1071,
          "old_api": null,
          "new_api": "sdsnew",
          "old_text": null,
          "new_text": "sdsnew(\"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\\r\\n\")",
          "old_line_content": "        }",
          "new_line_content": "            addReplySds(c,sdsnew(\"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\\r\\n\"));",
          "content_same": false
        },
        {
          "line": 1074,
          "old_api": null,
          "new_api": "addReply",
          "old_text": null,
          "new_text": "addReply(c,shared.ok)",
          "old_line_content": "    }",
          "new_line_content": "            addReply(c,shared.ok);",
          "content_same": false
        },
        {
          "line": 1077,
          "old_api": null,
          "new_api": "addReplyError",
          "old_text": null,
          "new_text": "addReplyError(c, \"Unknown SCRIPT subcommand or wrong # of args.\")",
          "old_line_content": "",
          "new_line_content": "        addReplyError(c, \"Unknown SCRIPT subcommand or wrong # of args.\");",
          "content_same": false
        },
        {
          "line": 966,
          "old_api": null,
          "new_api": "rewriteClientCommandArgument",
          "old_text": null,
          "new_text": "rewriteClientCommandArgument(c,0,\n                resetRefCount(createStringObject(\"EVAL\",4)))",
          "old_line_content": "        }",
          "new_line_content": "            rewriteClientCommandArgument(c,0,",
          "content_same": false
        },
        {
          "line": 967,
          "old_api": null,
          "new_api": "createStringObject",
          "old_text": null,
          "new_text": "createStringObject(\"EVAL\",4)",
          "old_line_content": "    }",
          "new_line_content": "                resetRefCount(createStringObject(\"EVAL\",4)));",
          "content_same": false
        },
        {
          "line": 968,
          "old_api": null,
          "new_api": "rewriteClientCommandArgument",
          "old_text": null,
          "new_text": "rewriteClientCommandArgument(c,1,script)",
          "old_line_content": "}",
          "new_line_content": "            rewriteClientCommandArgument(c,1,script);",
          "content_same": false
        },
        {
          "line": 969,
          "old_api": null,
          "new_api": "forceCommandPropagation",
          "old_text": null,
          "new_text": "forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF)",
          "old_line_content": "",
          "new_line_content": "            forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF);",
          "content_same": false
        },
        {
          "line": 979,
          "old_api": null,
          "new_api": "sdslen",
          "old_text": null,
          "new_text": "sdslen(c->argv[1]->ptr)",
          "old_line_content": "         * sanity check */",
          "new_line_content": "    if (sdslen(c->argv[1]->ptr) != 40) {",
          "content_same": false
        },
        {
          "line": 984,
          "old_api": null,
          "new_api": "addReply",
          "old_text": null,
          "new_text": "addReply(c, shared.noscripterr)",
          "old_line_content": "}",
          "new_line_content": "        addReply(c, shared.noscripterr);",
          "content_same": false
        },
        {
          "line": 1016,
          "old_api": null,
          "new_api": "floor",
          "old_text": null,
          "new_text": "floor(r*(u-l+1))",
          "old_line_content": "  }",
          "new_line_content": "      lua_pushnumber(L, floor(r*(u-l+1))+l);  /* int between `l' and `u' */",
          "content_same": false
        },
        {
          "line": 987,
          "old_api": null,
          "new_api": "evalGenericCommand",
          "old_text": null,
          "new_text": "evalGenericCommand(c,1)",
          "old_line_content": " * by specific libc random() implementations and will output the same sequence",
          "new_line_content": "    evalGenericCommand(c,1);",
          "content_same": false
        },
        {
          "line": 1001,
          "old_api": null,
          "new_api": "lua_gettop",
          "old_text": null,
          "new_text": "lua_gettop(L)",
          "old_line_content": "    }",
          "new_line_content": "  switch (lua_gettop(L)) {  /* check number of arguments */",
          "content_same": false
        },
        {
          "line": 876,
          "old_api": null,
          "new_api": "lua_getglobal",
          "old_text": null,
          "new_text": "lua_getglobal(lua, funcname)",
          "old_line_content": "         * body of the function. If this is an EVALSHA call we can just",
          "new_line_content": "    lua_getglobal(lua, funcname);",
          "content_same": false
        },
        {
          "line": 877,
          "old_api": null,
          "new_api": "lua_isnil",
          "old_text": null,
          "new_text": "lua_isnil(lua,-1)",
          "old_line_content": "         * return an error. */",
          "new_line_content": "    if (lua_isnil(lua,-1)) {",
          "content_same": false
        },
        {
          "line": 878,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "        if (evalsha) {",
          "new_line_content": "        lua_pop(lua,1); /* remove the nil from the stack */",
          "content_same": false
        },
        {
          "line": 1007,
          "old_api": null,
          "new_api": "luaL_checkint",
          "old_text": null,
          "new_text": "luaL_checkint(L, 1)",
          "old_line_content": "    }",
          "new_line_content": "      int u = luaL_checkint(L, 1);",
          "content_same": false
        },
        {
          "line": 1008,
          "old_api": null,
          "new_api": "luaL_argcheck",
          "old_text": null,
          "new_text": "luaL_argcheck(L, 1<=u, 1, \"interval is empty\")",
          "old_line_content": "    case 2: {  /* lower and upper limits */",
          "new_line_content": "      luaL_argcheck(L, 1<=u, 1, \"interval is empty\");",
          "content_same": false
        },
        {
          "line": 1013,
          "old_api": null,
          "new_api": "luaL_checkint",
          "old_text": null,
          "new_text": "luaL_checkint(L, 1)",
          "old_line_content": "      break;",
          "new_line_content": "      int l = luaL_checkint(L, 1);",
          "content_same": false
        },
        {
          "line": 1014,
          "old_api": null,
          "new_api": "luaL_checkint",
          "old_text": null,
          "new_text": "luaL_checkint(L, 2)",
          "old_line_content": "    }",
          "new_line_content": "      int u = luaL_checkint(L, 2);",
          "content_same": false
        },
        {
          "line": 887,
          "old_api": null,
          "new_api": "luaCreateFunction",
          "old_text": null,
          "new_text": "luaCreateFunction(c,lua,funcname,c->argv[1])",
          "old_line_content": "            return;",
          "new_line_content": "        if (luaCreateFunction(c,lua,funcname,c->argv[1]) == REDIS_ERR) {",
          "content_same": false
        },
        {
          "line": 888,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "        }",
          "new_line_content": "            lua_pop(lua,1); /* remove the error handler from the stack. */",
          "content_same": false
        },
        {
          "line": 1019,
          "old_api": null,
          "new_api": "luaL_error",
          "old_text": null,
          "new_text": "luaL_error(L, \"wrong number of arguments\")",
          "old_line_content": "",
          "new_line_content": "    default: return luaL_error(L, \"wrong number of arguments\");",
          "content_same": false
        },
        {
          "line": 894,
          "old_api": null,
          "new_api": "lua_getglobal",
          "old_text": null,
          "new_text": "lua_getglobal(lua, funcname)",
          "old_line_content": "    /* Populate the argv and keys table accordingly to the arguments that",
          "new_line_content": "        lua_getglobal(lua, funcname);",
          "content_same": false
        },
        {
          "line": 895,
          "old_api": null,
          "new_api": "lua_isnil",
          "old_text": null,
          "new_text": "lua_isnil(lua,-1)",
          "old_line_content": "     * EVAL received. */",
          "new_line_content": "        redisAssert(!lua_isnil(lua,-1));",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 896,
          "old_api": "luaSetGlobalArray",
          "new_api": null,
          "old_text": "luaSetGlobalArray(lua,\"KEYS\",c->argv+3,numkeys)",
          "new_text": null,
          "old_line_content": "    luaSetGlobalArray(lua,\"KEYS\",c->argv+3,numkeys);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 897,
          "old_api": "luaSetGlobalArray",
          "new_api": null,
          "old_text": "luaSetGlobalArray(lua,\"ARGV\",c->argv+3+numkeys,c->argc-3-numkeys)",
          "new_text": null,
          "old_line_content": "    luaSetGlobalArray(lua,\"ARGV\",c->argv+3+numkeys,c->argc-3-numkeys);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1030,
          "old_api": "strcasecmp",
          "new_api": null,
          "old_text": "strcasecmp(c->argv[1]->ptr,\"flush\")",
          "new_text": null,
          "old_line_content": "    if (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\"flush\")) {",
          "new_line_content": " * SCRIPT command for script environment introspection and control",
          "content_same": false
        },
        {
          "line": 1031,
          "old_api": "scriptingReset",
          "new_api": null,
          "old_text": "scriptingReset()",
          "new_text": null,
          "old_line_content": "        scriptingReset();",
          "new_line_content": " * ------------------------------------------------------------------------- */",
          "content_same": false
        },
        {
          "line": 1032,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c,shared.ok)",
          "new_text": null,
          "old_line_content": "        addReply(c,shared.ok);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1033,
          "old_api": "replicationScriptCacheFlush",
          "new_api": null,
          "old_text": "replicationScriptCacheFlush()",
          "new_text": null,
          "old_line_content": "        replicationScriptCacheFlush();",
          "new_line_content": "void scriptCommand(redisClient *c) {",
          "content_same": false
        },
        {
          "line": 907,
          "old_api": "mstime",
          "new_api": null,
          "old_text": "mstime()",
          "new_text": null,
          "old_line_content": "    server.lua_time_start = mstime();",
          "new_line_content": "     * is running for too much time.",
          "content_same": false
        },
        {
          "line": 910,
          "old_api": "lua_sethook",
          "new_api": null,
          "old_text": "lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000)",
          "new_text": null,
          "old_line_content": "        lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000);",
          "new_line_content": "    server.lua_caller = c;",
          "content_same": false
        },
        {
          "line": 1038,
          "old_api": "addReplyMultiBulkLen",
          "new_api": null,
          "old_text": "addReplyMultiBulkLen(c, c->argc-2)",
          "new_text": null,
          "old_line_content": "        addReplyMultiBulkLen(c, c->argc-2);",
          "new_line_content": "        server.dirty++; /* Propagating this command is a good idea. */",
          "content_same": false
        },
        {
          "line": 1040,
          "old_api": "dictFind",
          "new_api": null,
          "old_text": "dictFind(server.lua_scripts,c->argv[j]->ptr)",
          "new_text": null,
          "old_line_content": "            if (dictFind(server.lua_scripts,c->argv[j]->ptr))",
          "new_line_content": "        int j;",
          "content_same": false
        },
        {
          "line": 1041,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c,shared.cone)",
          "new_text": null,
          "old_line_content": "                addReply(c,shared.cone);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1043,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c,shared.czero)",
          "new_text": null,
          "old_line_content": "                addReply(c,shared.czero);",
          "new_line_content": "        for (j = 2; j < c->argc; j++) {",
          "content_same": false
        },
        {
          "line": 917,
          "old_api": "lua_pcall",
          "new_api": null,
          "old_text": "lua_pcall(lua,0,1,-2)",
          "new_text": null,
          "old_line_content": "    err = lua_pcall(lua,0,1,-2);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 920,
          "old_api": "lua_sethook",
          "new_api": null,
          "old_text": "lua_sethook(lua,luaMaskCountHook,0,0)",
          "new_text": null,
          "old_line_content": "    if (delhook) lua_sethook(lua,luaMaskCountHook,0,0); /* Disable hook */",
          "new_line_content": "     * a single return value. */",
          "content_same": false
        },
        {
          "line": 1051,
          "old_api": "sdslen",
          "new_api": null,
          "old_text": "sdslen(c->argv[2]->ptr)",
          "new_text": null,
          "old_line_content": "        sha1hex(funcname+2,c->argv[2]->ptr,sdslen(c->argv[2]->ptr));",
          "new_line_content": "        sds sha;",
          "content_same": false
        },
        {
          "line": 1052,
          "old_api": "sdsnewlen",
          "new_api": null,
          "old_text": "sdsnewlen(funcname+2,40)",
          "new_text": null,
          "old_line_content": "        sha = sdsnewlen(funcname+2,40);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 925,
          "old_api": "aeCreateFileEvent",
          "new_api": null,
          "old_text": "aeCreateFileEvent(server.el,c->fd,AE_READABLE,\n                          readQueryFromClient,c)",
          "new_text": null,
          "old_line_content": "        aeCreateFileEvent(server.el,c->fd,AE_READABLE,",
          "new_line_content": "    if (server.lua_timedout) {",
          "content_same": false
        },
        {
          "line": 1053,
          "old_api": "dictFind",
          "new_api": null,
          "old_text": "dictFind(server.lua_scripts,sha)",
          "new_text": null,
          "old_line_content": "        if (dictFind(server.lua_scripts,sha) == NULL) {",
          "new_line_content": "        funcname[0] = 'f';",
          "content_same": false
        },
        {
          "line": 1054,
          "old_api": "luaCreateFunction",
          "new_api": null,
          "old_text": "luaCreateFunction(c,server.lua,funcname,c->argv[2])",
          "new_text": null,
          "old_line_content": "            if (luaCreateFunction(c,server.lua,funcname,c->argv[2])",
          "new_line_content": "        funcname[1] = '_';",
          "content_same": false
        },
        {
          "line": 930,
          "old_api": "lua_gc",
          "new_api": null,
          "old_text": "lua_gc(lua,LUA_GCSTEP,1)",
          "new_text": null,
          "old_line_content": "    lua_gc(lua,LUA_GCSTEP,1);",
          "new_line_content": "                          readQueryFromClient,c);",
          "content_same": false
        },
        {
          "line": 1061,
          "old_api": "sdsfree",
          "new_api": null,
          "old_text": "sdsfree(sha)",
          "new_text": null,
          "old_line_content": "        sdsfree(sha);",
          "new_line_content": "                return;",
          "content_same": false
        },
        {
          "line": 1062,
          "old_api": "forceCommandPropagation",
          "new_api": null,
          "old_text": "forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF)",
          "new_text": null,
          "old_line_content": "        forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF);",
          "new_line_content": "            }",
          "content_same": false
        },
        {
          "line": 935,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,2)",
          "new_text": null,
          "old_line_content": "        lua_pop(lua,2); /* Consume the Lua reply and remove error handler. */",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1063,
          "old_api": "strcasecmp",
          "new_api": null,
          "old_text": "strcasecmp(c->argv[1]->ptr,\"kill\")",
          "new_text": null,
          "old_line_content": "    } else if (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\"kill\")) {",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 940,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "        lua_pop(lua,1); /* Remove the error handler. */",
          "new_line_content": "    } else {",
          "content_same": false
        },
        {
          "line": 1070,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c,shared.ok)",
          "new_text": null,
          "old_line_content": "            addReply(c,shared.ok);",
          "new_line_content": "        } else if (server.lua_write_dirty) {",
          "content_same": false
        },
        {
          "line": 1073,
          "old_api": "addReplyError",
          "new_api": null,
          "old_text": "addReplyError(c, \"Unknown SCRIPT subcommand or wrong # of args.\")",
          "new_text": null,
          "old_line_content": "        addReplyError(c, \"Unknown SCRIPT subcommand or wrong # of args.\");",
          "new_line_content": "            server.lua_kill = 1;",
          "content_same": false
        },
        {
          "line": 954,
          "old_api": "replicationScriptCacheExists",
          "new_api": null,
          "old_text": "replicationScriptCacheExists(c->argv[1]->ptr)",
          "new_text": null,
          "old_line_content": "        if (!replicationScriptCacheExists(c->argv[1]->ptr)) {",
          "new_line_content": "     * For repliation, everytime a new slave attaches to the master, we need to",
          "content_same": false
        },
        {
          "line": 960,
          "old_api": "replicationScriptCacheAdd",
          "new_api": null,
          "old_text": "replicationScriptCacheAdd(c->argv[1]->ptr)",
          "new_text": null,
          "old_line_content": "            replicationScriptCacheAdd(c->argv[1]->ptr);",
          "new_line_content": "             * EVAL, then add it into the script cache, as from now on",
          "content_same": false
        },
        {
          "line": 961,
          "old_api": "redisAssertWithInfo",
          "new_api": null,
          "old_text": "redisAssertWithInfo(c,NULL,script != NULL)",
          "new_text": null,
          "old_line_content": "            redisAssertWithInfo(c,NULL,script != NULL);",
          "new_line_content": "             * slaves and AOF know about it. */",
          "content_same": false
        },
        {
          "line": 963,
          "old_api": "createStringObject",
          "new_api": null,
          "old_text": "createStringObject(\"EVAL\",4)",
          "new_text": null,
          "old_line_content": "                resetRefCount(createStringObject(\"EVAL\",4)));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 971,
          "old_api": "evalGenericCommand",
          "new_api": null,
          "old_text": "evalGenericCommand(c,0)",
          "new_text": null,
          "old_line_content": "    evalGenericCommand(c,0);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 980,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c, shared.noscripterr)",
          "new_text": null,
          "old_line_content": "        addReply(c, shared.noscripterr);",
          "new_line_content": "        /* We know that a match is not possible if the provided SHA is",
          "content_same": false
        },
        {
          "line": 983,
          "old_api": "evalGenericCommand",
          "new_api": null,
          "old_text": "evalGenericCommand(c,1)",
          "new_text": null,
          "old_line_content": "    evalGenericCommand(c,1);",
          "new_line_content": "         * sanity check */",
          "content_same": false
        },
        {
          "line": 864,
          "old_api": "tolower",
          "new_api": null,
          "old_text": "tolower(sha[j])",
          "new_text": null,
          "old_line_content": "            funcname[j+2] = tolower(sha[j]);",
          "new_line_content": "         * managed to always show up in the profiler output consuming",
          "content_same": false
        },
        {
          "line": 995,
          "old_api": "redisLrand48",
          "new_api": null,
          "old_text": "redisLrand48()",
          "new_text": null,
          "old_line_content": "  lua_Number r = (lua_Number)(redisLrand48()%REDIS_LRAND48_MAX) /",
          "new_line_content": " * rand() replaced by redisLrand48(). */",
          "content_same": false
        },
        {
          "line": 869,
          "old_api": "lua_getglobal",
          "new_api": null,
          "old_text": "lua_getglobal(lua, \"__redis__err__handler\")",
          "new_text": null,
          "old_line_content": "    lua_getglobal(lua, \"__redis__err__handler\");",
          "new_line_content": "        funcname[42] = '\\0';",
          "content_same": false
        },
        {
          "line": 997,
          "old_api": "lua_gettop",
          "new_api": null,
          "old_text": "lua_gettop(L)",
          "new_text": null,
          "old_line_content": "  switch (lua_gettop(L)) {  /* check number of arguments */",
          "new_line_content": "  /* the `%' avoids the (rare) case of r==1, and is needed also because on",
          "content_same": false
        },
        {
          "line": 872,
          "old_api": "lua_getglobal",
          "new_api": null,
          "old_text": "lua_getglobal(lua, funcname)",
          "new_text": null,
          "old_line_content": "    lua_getglobal(lua, funcname);",
          "new_line_content": "    /* Push the pcall error handler function on the stack. */",
          "content_same": false
        },
        {
          "line": 874,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "        lua_pop(lua,1); /* remove the nil from the stack */",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1004,
          "old_api": "luaL_argcheck",
          "new_api": null,
          "old_text": "luaL_argcheck(L, 1<=u, 1, \"interval is empty\")",
          "new_text": null,
          "old_line_content": "      luaL_argcheck(L, 1<=u, 1, \"interval is empty\");",
          "new_line_content": "      break;",
          "content_same": false
        },
        {
          "line": 1005,
          "old_api": "floor",
          "new_api": null,
          "old_text": "floor(r*u)",
          "new_text": null,
          "old_line_content": "      lua_pushnumber(L, floor(r*u)+1);  /* int between 1 and `u' */",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 879,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "            lua_pop(lua,1); /* remove the error handler from the stack. */",
          "new_line_content": "        /* Function not defined... let's define it if we have the",
          "content_same": false
        },
        {
          "line": 880,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c, shared.noscripterr)",
          "new_text": null,
          "old_line_content": "            addReply(c, shared.noscripterr);",
          "new_line_content": "         * body of the function. If this is an EVALSHA call we can just",
          "content_same": false
        },
        {
          "line": 1010,
          "old_api": "luaL_checkint",
          "new_api": null,
          "old_text": "luaL_checkint(L, 2)",
          "new_text": null,
          "old_line_content": "      int u = luaL_checkint(L, 2);",
          "new_line_content": "      break;",
          "content_same": false
        },
        {
          "line": 1011,
          "old_api": "luaL_argcheck",
          "new_api": null,
          "old_text": "luaL_argcheck(L, l<=u, 2, \"interval is empty\")",
          "new_text": null,
          "old_line_content": "      luaL_argcheck(L, l<=u, 2, \"interval is empty\");",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 1012,
          "old_api": "floor",
          "new_api": null,
          "old_text": "floor(r*(u-l+1))",
          "new_text": null,
          "old_line_content": "      lua_pushnumber(L, floor(r*(u-l+1))+l);  /* int between `l' and `u' */",
          "new_line_content": "    case 2: {  /* lower and upper limits */",
          "content_same": false
        },
        {
          "line": 890,
          "old_api": "lua_getglobal",
          "new_api": null,
          "old_text": "lua_getglobal(lua, funcname)",
          "new_text": null,
          "old_line_content": "        lua_getglobal(lua, funcname);",
          "new_line_content": "             * itself when it returns REDIS_ERR. */",
          "content_same": false
        },
        {
          "line": 891,
          "old_api": "lua_isnil",
          "new_api": null,
          "old_text": "lua_isnil(lua,-1)",
          "new_text": null,
          "old_line_content": "        redisAssert(!lua_isnil(lua,-1));",
          "new_line_content": "            return;",
          "content_same": false
        },
        {
          "line": 1021,
          "old_api": "luaL_checkint",
          "new_api": null,
          "old_text": "luaL_checkint(L, 1)",
          "new_text": null,
          "old_line_content": "  redisSrand48(luaL_checkint(L, 1));",
          "new_line_content": "  return 1;",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 23,
      "total_additions": 49,
      "total_deletions": 50,
      "total_api_changes": 122
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 5,
        "api_related_lines": 122,
        "non_api_lines": 4,
        "non_api_line_numbers": [
          865,
          867,
          868,
          863
        ]
      }
    },
    "api_calls_before": 361,
    "api_calls_after": 360,
    "diff_info": {
      "added_lines": 5,
      "removed_lines": 1,
      "total_diff_lines": 19
    }
  }
}