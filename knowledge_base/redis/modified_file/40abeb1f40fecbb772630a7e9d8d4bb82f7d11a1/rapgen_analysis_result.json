{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/40abeb1f40fecbb772630a7e9d8d4bb82f7d11a1",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/40abeb1f40fecbb772630a7e9d8d4bb82f7d11a1/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/40abeb1f40fecbb772630a7e9d8d4bb82f7d11a1/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/40abeb1f40fecbb772630a7e9d8d4bb82f7d11a1/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 309,
          "old_api": "sdsempty",
          "new_api": "sdsnewlen",
          "old_text": "sdsempty()",
          "new_text": "sdsnewlen(c->buf,c->bufpos)",
          "old_line_content": "    reply = sdsempty();",
          "new_line_content": "    reply = sdsnewlen(c->buf,c->bufpos);",
          "content_same": false
        },
        {
          "line": 311,
          "old_api": "sdscatlen",
          "new_api": "listLength",
          "old_text": "sdscatlen(reply,c->buf,c->bufpos)",
          "new_text": "listLength(c->reply)",
          "old_line_content": "        reply = sdscatlen(reply,c->buf,c->bufpos);",
          "new_line_content": "    while(listLength(c->reply)) {",
          "content_same": false
        },
        {
          "line": 314,
          "old_api": "listLength",
          "new_api": "sdslen",
          "old_text": "listLength(c->reply)",
          "new_text": "sdslen(o->ptr)",
          "old_line_content": "    while(listLength(c->reply)) {",
          "new_line_content": "        reply = sdscatlen(reply,o->ptr,sdslen(o->ptr));",
          "content_same": false
        },
        {
          "line": 318,
          "old_api": "listFirst",
          "new_api": "redisProtocolToLuaType",
          "old_text": "listFirst(c->reply)",
          "new_text": "redisProtocolToLuaType(lua,reply)",
          "old_line_content": "        listDelNode(c->reply,listFirst(c->reply));",
          "new_line_content": "    redisProtocolToLuaType(lua,reply);",
          "content_same": false
        },
        {
          "line": 389,
          "old_api": "lua_newtable",
          "new_api": "lua_settable",
          "old_text": "lua_newtable(lua)",
          "new_text": "lua_settable(lua, -3)",
          "old_line_content": "    lua_newtable(lua);",
          "new_line_content": "    lua_settable(lua, -3);",
          "content_same": false
        },
        {
          "line": 410,
          "old_api": "log",
          "new_api": "luaPushError",
          "old_text": "luaPushError(lua, \"redis.log() requires two arguments or more.\")",
          "new_text": "luaPushError(lua, \"First argument must be a number (log level).\")",
          "old_line_content": "        luaPushError(lua, \"redis.log() requires two arguments or more.\");",
          "new_line_content": "        luaPushError(lua, \"First argument must be a number (log level).\");",
          "content_same": false
        },
        {
          "line": 413,
          "old_api": "luaPushError",
          "new_api": "lua_tonumber",
          "old_text": "luaPushError(lua, \"First argument must be a number (log level).\")",
          "new_text": "lua_tonumber(lua,-argc)",
          "old_line_content": "        luaPushError(lua, \"First argument must be a number (log level).\");",
          "new_line_content": "    level = lua_tonumber(lua,-argc);",
          "content_same": false
        },
        {
          "line": 428,
          "old_api": "lua_tolstring",
          "new_api": "sdscatlen",
          "old_text": "lua_tolstring(lua,(-argc)+j,&len)",
          "new_text": "sdscatlen(log,s,len)",
          "old_line_content": "        s = (char*)lua_tolstring(lua,(-argc)+j,&len);",
          "new_line_content": "            log = sdscatlen(log,s,len);",
          "content_same": false
        },
        {
          "line": 431,
          "old_api": "sdscatlen",
          "new_api": "redisLogRaw",
          "old_text": "sdscatlen(log,s,len)",
          "new_text": "redisLogRaw(level,log)",
          "old_line_content": "            log = sdscatlen(log,s,len);",
          "new_line_content": "    redisLogRaw(level,log);",
          "content_same": false
        },
        {
          "line": 441,
          "old_api": "REDIS_NOTUSED",
          "new_api": "mstime",
          "old_text": "REDIS_NOTUSED(ar)",
          "new_text": "mstime()",
          "old_line_content": "    REDIS_NOTUSED(ar);",
          "new_line_content": "    elapsed = mstime() - server.lua_time_start;",
          "content_same": false
        },
        {
          "line": 455,
          "old_api": "processEventsWhileBlocked",
          "new_api": "lua_pushstring",
          "old_text": "processEventsWhileBlocked()",
          "new_text": "lua_pushstring(lua,\"Script killed by user with SCRIPT KILL...\")",
          "old_line_content": "    if (server.lua_timedout) processEventsWhileBlocked();",
          "new_line_content": "        lua_pushstring(lua,\"Script killed by user with SCRIPT KILL...\");",
          "content_same": false
        },
        {
          "line": 527,
          "old_api": "strlen",
          "new_api": "sdsfree",
          "old_text": "strlen(s[j])",
          "new_text": "sdsfree(code)",
          "old_line_content": "    for (j = 0; s[j] != NULL; j++) code = sdscatlen(code,s[j],strlen(s[j]));",
          "new_line_content": "    sdsfree(code);",
          "content_same": false
        },
        {
          "line": 538,
          "old_api": "lua_open",
          "new_api": "luaRemoveUnsupportedFunctions",
          "old_text": "lua_open()",
          "new_text": "luaRemoveUnsupportedFunctions(lua)",
          "old_line_content": "    lua_State *lua = lua_open();",
          "new_line_content": "    luaRemoveUnsupportedFunctions(lua);",
          "content_same": false
        },
        {
          "line": 546,
          "old_api": "dictCreate",
          "new_api": "lua_newtable",
          "old_text": "dictCreate(&shaScriptObjectDictType,NULL)",
          "new_text": "lua_newtable(lua)",
          "old_line_content": "    server.lua_scripts = dictCreate(&shaScriptObjectDictType,NULL);",
          "new_line_content": "    lua_newtable(lua);",
          "content_same": false
        },
        {
          "line": 549,
          "old_api": "lua_newtable",
          "new_api": "lua_pushstring",
          "old_text": "lua_newtable(lua)",
          "new_text": "lua_pushstring(lua,\"call\")",
          "old_line_content": "    lua_newtable(lua);",
          "new_line_content": "    lua_pushstring(lua,\"call\");",
          "content_same": false
        },
        {
          "line": 554,
          "old_api": "lua_settable",
          "new_api": "lua_pushstring",
          "old_text": "lua_settable(lua,-3)",
          "new_text": "lua_pushstring(lua,\"pcall\")",
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "    lua_pushstring(lua,\"pcall\");",
          "content_same": false
        },
        {
          "line": 559,
          "old_api": "lua_settable",
          "new_api": "lua_pushstring",
          "old_text": "lua_settable(lua,-3)",
          "new_text": "lua_pushstring(lua,\"log\")",
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "    lua_pushstring(lua,\"log\");",
          "content_same": false
        },
        {
          "line": 563,
          "old_api": "lua_pushcfunction",
          "new_api": "lua_pushstring",
          "old_text": "lua_pushcfunction(lua,luaLogCommand)",
          "new_text": "lua_pushstring(lua,\"LOG_DEBUG\")",
          "old_line_content": "    lua_pushcfunction(lua,luaLogCommand);",
          "new_line_content": "    lua_pushstring(lua,\"LOG_DEBUG\");",
          "content_same": false
        },
        {
          "line": 564,
          "old_api": "lua_settable",
          "new_api": "lua_pushnumber",
          "old_text": "lua_settable(lua,-3)",
          "new_text": "lua_pushnumber(lua,REDIS_DEBUG)",
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "    lua_pushnumber(lua,REDIS_DEBUG);",
          "content_same": false
        },
        {
          "line": 567,
          "old_api": "lua_pushnumber",
          "new_api": "lua_pushstring",
          "old_text": "lua_pushnumber(lua,REDIS_DEBUG)",
          "new_text": "lua_pushstring(lua,\"LOG_VERBOSE\")",
          "old_line_content": "    lua_pushnumber(lua,REDIS_DEBUG);",
          "new_line_content": "    lua_pushstring(lua,\"LOG_VERBOSE\");",
          "content_same": false
        },
        {
          "line": 568,
          "old_api": "lua_settable",
          "new_api": "lua_pushnumber",
          "old_text": "lua_settable(lua,-3)",
          "new_text": "lua_pushnumber(lua,REDIS_VERBOSE)",
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "    lua_pushnumber(lua,REDIS_VERBOSE);",
          "content_same": false
        },
        {
          "line": 571,
          "old_api": "lua_pushnumber",
          "new_api": "lua_pushstring",
          "old_text": "lua_pushnumber(lua,REDIS_VERBOSE)",
          "new_text": "lua_pushstring(lua,\"LOG_NOTICE\")",
          "old_line_content": "    lua_pushnumber(lua,REDIS_VERBOSE);",
          "new_line_content": "    lua_pushstring(lua,\"LOG_NOTICE\");",
          "content_same": false
        },
        {
          "line": 572,
          "old_api": "lua_settable",
          "new_api": "lua_pushnumber",
          "old_text": "lua_settable(lua,-3)",
          "new_text": "lua_pushnumber(lua,REDIS_NOTICE)",
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "    lua_pushnumber(lua,REDIS_NOTICE);",
          "content_same": false
        },
        {
          "line": 575,
          "old_api": "lua_pushnumber",
          "new_api": "lua_pushstring",
          "old_text": "lua_pushnumber(lua,REDIS_NOTICE)",
          "new_text": "lua_pushstring(lua,\"LOG_WARNING\")",
          "old_line_content": "    lua_pushnumber(lua,REDIS_NOTICE);",
          "new_line_content": "    lua_pushstring(lua,\"LOG_WARNING\");",
          "content_same": false
        },
        {
          "line": 576,
          "old_api": "lua_settable",
          "new_api": "lua_pushnumber",
          "old_text": "lua_settable(lua,-3)",
          "new_text": "lua_pushnumber(lua,REDIS_WARNING)",
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "    lua_pushnumber(lua,REDIS_WARNING);",
          "content_same": false
        },
        {
          "line": 580,
          "old_api": "lua_settable",
          "new_api": "lua_pushstring",
          "old_text": "lua_settable(lua,-3)",
          "new_text": "lua_pushstring(lua, \"sha1hex\")",
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "    lua_pushstring(lua, \"sha1hex\");",
          "content_same": false
        },
        {
          "line": 585,
          "old_api": "lua_settable",
          "new_api": "lua_pushstring",
          "old_text": "lua_settable(lua, -3)",
          "new_text": "lua_pushstring(lua, \"error_reply\")",
          "old_line_content": "    lua_settable(lua, -3);",
          "new_line_content": "    lua_pushstring(lua, \"error_reply\");",
          "content_same": false
        },
        {
          "line": 593,
          "old_api": "lua_settable",
          "new_api": "lua_setglobal",
          "old_text": "lua_settable(lua, -3)",
          "new_text": "lua_setglobal(lua,\"redis\")",
          "old_line_content": "    lua_settable(lua, -3);",
          "new_line_content": "    lua_setglobal(lua,\"redis\");",
          "content_same": false
        },
        {
          "line": 596,
          "old_api": "lua_setglobal",
          "new_api": "lua_getglobal",
          "old_text": "lua_setglobal(lua,\"redis\")",
          "new_text": "lua_getglobal(lua,\"math\")",
          "old_line_content": "    lua_setglobal(lua,\"redis\");",
          "new_line_content": "    lua_getglobal(lua,\"math\");",
          "content_same": false
        },
        {
          "line": 599,
          "old_api": "lua_getglobal",
          "new_api": "lua_pushcfunction",
          "old_text": "lua_getglobal(lua,\"math\")",
          "new_text": "lua_pushcfunction(lua,redis_math_random)",
          "old_line_content": "    lua_getglobal(lua,\"math\");",
          "new_line_content": "    lua_pushcfunction(lua,redis_math_random);",
          "content_same": false
        },
        {
          "line": 602,
          "old_api": "lua_pushcfunction",
          "new_api": "lua_pushstring",
          "old_text": "lua_pushcfunction(lua,redis_math_random)",
          "new_text": "lua_pushstring(lua,\"randomseed\")",
          "old_line_content": "    lua_pushcfunction(lua,redis_math_random);",
          "new_line_content": "    lua_pushstring(lua,\"randomseed\");",
          "content_same": false
        },
        {
          "line": 603,
          "old_api": "lua_settable",
          "new_api": "lua_pushcfunction",
          "old_text": "lua_settable(lua,-3)",
          "new_text": "lua_pushcfunction(lua,redis_math_randomseed)",
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "    lua_pushcfunction(lua,redis_math_randomseed);",
          "content_same": false
        },
        {
          "line": 606,
          "old_api": "lua_pushcfunction",
          "new_api": "lua_setglobal",
          "old_text": "lua_pushcfunction(lua,redis_math_randomseed)",
          "new_text": "lua_setglobal(lua,\"math\")",
          "old_line_content": "    lua_pushcfunction(lua,redis_math_randomseed);",
          "new_line_content": "    lua_setglobal(lua,\"math\");",
          "content_same": false
        },
        {
          "line": 700,
          "old_api": "lua_strlen",
          "new_api": "lua_toboolean",
          "old_text": "lua_strlen(lua,-1)",
          "new_text": "lua_toboolean(lua,-1)",
          "old_line_content": "        addReplyBulkCBuffer(c,(char*)lua_tostring(lua,-1),lua_strlen(lua,-1));",
          "new_line_content": "        addReply(c,lua_toboolean(lua,-1) ? shared.cone : shared.nullbulk);",
          "content_same": false
        },
        {
          "line": 703,
          "old_api": "lua_toboolean",
          "new_api": "lua_tonumber",
          "old_text": "lua_toboolean(lua,-1)",
          "new_text": "lua_tonumber(lua,-1)",
          "old_line_content": "        addReply(c,lua_toboolean(lua,-1) ? shared.cone : shared.nullbulk);",
          "new_line_content": "        addReplyLongLong(c,(long long)lua_tonumber(lua,-1));",
          "content_same": false
        },
        {
          "line": 713,
          "old_api": "lua_gettable",
          "new_api": "lua_tostring",
          "old_text": "lua_gettable(lua,-2)",
          "new_text": "lua_tostring(lua,-1)",
          "old_line_content": "        lua_gettable(lua,-2);",
          "new_line_content": "            sds err = sdsnew(lua_tostring(lua,-1));",
          "content_same": false
        },
        {
          "line": 714,
          "old_api": "lua_type",
          "new_api": "sdsmapchars",
          "old_text": "lua_type(lua,-1)",
          "new_text": "sdsmapchars(err,\"\\r\\n\",\"  \",2)",
          "old_line_content": "        t = lua_type(lua,-1);",
          "new_line_content": "            sdsmapchars(err,\"\\r\\n\",\"  \",2);",
          "content_same": false
        },
        {
          "line": 716,
          "old_api": "lua_tostring",
          "new_api": "sdsfree",
          "old_text": "lua_tostring(lua,-1)",
          "new_text": "sdsfree(err)",
          "old_line_content": "            sds err = sdsnew(lua_tostring(lua,-1));",
          "new_line_content": "            sdsfree(err);",
          "content_same": false
        },
        {
          "line": 717,
          "old_api": "sdsmapchars",
          "new_api": "lua_pop",
          "old_text": "sdsmapchars(err,\"\\r\\n\",\"  \",2)",
          "new_text": "lua_pop(lua,2)",
          "old_line_content": "            sdsmapchars(err,\"\\r\\n\",\"  \",2);",
          "new_line_content": "            lua_pop(lua,2);",
          "content_same": false
        },
        {
          "line": 724,
          "old_api": "lua_pop",
          "new_api": "lua_type",
          "old_text": "lua_pop(lua,1)",
          "new_text": "lua_type(lua,-1)",
          "old_line_content": "        lua_pop(lua,1);",
          "new_line_content": "        t = lua_type(lua,-1);",
          "content_same": false
        },
        {
          "line": 726,
          "old_api": "lua_gettable",
          "new_api": "lua_tostring",
          "old_text": "lua_gettable(lua,-2)",
          "new_text": "lua_tostring(lua,-1)",
          "old_line_content": "        lua_gettable(lua,-2);",
          "new_line_content": "            sds ok = sdsnew(lua_tostring(lua,-1));",
          "content_same": false
        },
        {
          "line": 727,
          "old_api": "lua_type",
          "new_api": "sdsmapchars",
          "old_text": "lua_type(lua,-1)",
          "new_text": "sdsmapchars(ok,\"\\r\\n\",\"  \",2)",
          "old_line_content": "        t = lua_type(lua,-1);",
          "new_line_content": "            sdsmapchars(ok,\"\\r\\n\",\"  \",2);",
          "content_same": false
        },
        {
          "line": 729,
          "old_api": "lua_tostring",
          "new_api": "sdsfree",
          "old_text": "lua_tostring(lua,-1)",
          "new_text": "sdsfree(ok)",
          "old_line_content": "            sds ok = sdsnew(lua_tostring(lua,-1));",
          "new_line_content": "            sdsfree(ok);",
          "content_same": false
        },
        {
          "line": 730,
          "old_api": "sdsmapchars",
          "new_api": "lua_pop",
          "old_text": "sdsmapchars(ok,\"\\r\\n\",\"  \",2)",
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "            sdsmapchars(ok,\"\\r\\n\",\"  \",2);",
          "new_line_content": "            lua_pop(lua,1);",
          "content_same": false
        },
        {
          "line": 732,
          "old_api": "sdsfree",
          "new_api": "addDeferredMultiBulkLength",
          "old_text": "sdsfree(ok)",
          "new_text": "addDeferredMultiBulkLength(c)",
          "old_line_content": "            sdsfree(ok);",
          "new_line_content": "            void *replylen = addDeferredMultiBulkLength(c);",
          "content_same": false
        },
        {
          "line": 735,
          "old_api": "addDeferredMultiBulkLength",
          "new_api": "lua_pop",
          "old_text": "addDeferredMultiBulkLength(c)",
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "            void *replylen = addDeferredMultiBulkLength(c);",
          "new_line_content": "            lua_pop(lua,1); /* Discard the 'ok' field value we popped */",
          "content_same": false
        },
        {
          "line": 738,
          "old_api": "lua_pop",
          "new_api": "lua_gettable",
          "old_text": "lua_pop(lua,1)",
          "new_text": "lua_gettable(lua,-2)",
          "old_line_content": "            lua_pop(lua,1); /* Discard the 'ok' field value we popped */",
          "new_line_content": "                lua_gettable(lua,-2);",
          "content_same": false
        },
        {
          "line": 741,
          "old_api": "lua_gettable",
          "new_api": "lua_pop",
          "old_text": "lua_gettable(lua,-2)",
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "                lua_gettable(lua,-2);",
          "new_line_content": "                    lua_pop(lua,1);",
          "content_same": false
        },
        {
          "line": 744,
          "old_api": "lua_pop",
          "new_api": "luaReplyToRedisReply",
          "old_text": "lua_pop(lua,1)",
          "new_text": "luaReplyToRedisReply(c, lua)",
          "old_line_content": "                    lua_pop(lua,1);",
          "new_line_content": "                luaReplyToRedisReply(c, lua);",
          "content_same": false
        },
        {
          "line": 747,
          "old_api": "luaReplyToRedisReply",
          "new_api": "setDeferredMultiBulkLength",
          "old_text": "luaReplyToRedisReply(c, lua)",
          "new_text": "setDeferredMultiBulkLength(c,replylen,mbulklen)",
          "old_line_content": "                luaReplyToRedisReply(c, lua);",
          "new_line_content": "            setDeferredMultiBulkLength(c,replylen,mbulklen);",
          "content_same": false
        },
        {
          "line": 764,
          "old_api": "lua_newtable",
          "new_api": "lua_rawseti",
          "old_text": "lua_newtable(lua)",
          "new_text": "lua_rawseti(lua,-2,j+1)",
          "old_line_content": "    lua_newtable(lua);",
          "new_line_content": "        lua_rawseti(lua,-2,j+1);",
          "content_same": false
        },
        {
          "line": 766,
          "old_api": "sdslen",
          "new_api": "lua_setglobal",
          "old_text": "sdslen(elev[j]->ptr)",
          "new_text": "lua_setglobal(lua,var)",
          "old_line_content": "        lua_pushlstring(lua,(char*)elev[j]->ptr,sdslen(elev[j]->ptr));",
          "new_line_content": "    lua_setglobal(lua,var);",
          "content_same": false
        },
        {
          "line": 782,
          "old_api": "sdsempty",
          "new_api": "sdscatlen",
          "old_text": "sdsempty()",
          "new_text": "sdscatlen(funcdef,funcname,42)",
          "old_line_content": "    sds funcdef = sdsempty();",
          "new_line_content": "    funcdef = sdscatlen(funcdef,funcname,42);",
          "content_same": false
        },
        {
          "line": 784,
          "old_api": "sdscat",
          "new_api": "sdslen",
          "old_text": "sdscat(funcdef,\"function \")",
          "new_text": "sdslen(body->ptr)",
          "old_line_content": "    funcdef = sdscat(funcdef,\"function \");",
          "new_line_content": "    funcdef = sdscatlen(funcdef,body->ptr,sdslen(body->ptr));",
          "content_same": false
        },
        {
          "line": 788,
          "old_api": "sdscatlen",
          "new_api": "addReplyErrorFormat",
          "old_text": "sdscatlen(funcdef,\" end\",4)",
          "new_text": "addReplyErrorFormat(c,\"Error compiling script (new function): %s\\n\",\n            lua_tostring(lua,-1))",
          "old_line_content": "    funcdef = sdscatlen(funcdef,\" end\",4);",
          "new_line_content": "        addReplyErrorFormat(c,\"Error compiling script (new function): %s\\n\",",
          "content_same": false
        },
        {
          "line": 790,
          "old_api": "sdslen",
          "new_api": "lua_pop",
          "old_text": "sdslen(funcdef)",
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "    if (luaL_loadbuffer(lua,funcdef,sdslen(funcdef),\"@user_script\")) {",
          "new_line_content": "        lua_pop(lua,1);",
          "content_same": false
        },
        {
          "line": 791,
          "old_api": "addReplyErrorFormat",
          "new_api": "sdsfree",
          "old_text": "addReplyErrorFormat(c,\"Error compiling script (new function): %s\\n\",\n            lua_tostring(lua,-1))",
          "new_text": "sdsfree(funcdef)",
          "old_line_content": "        addReplyErrorFormat(c,\"Error compiling script (new function): %s\\n\",",
          "new_line_content": "        sdsfree(funcdef);",
          "content_same": false
        },
        {
          "line": 797,
          "old_api": "sdsfree",
          "new_api": "lua_tostring",
          "old_text": "sdsfree(funcdef)",
          "new_text": "lua_tostring(lua,-1)",
          "old_line_content": "    sdsfree(funcdef);",
          "new_line_content": "            lua_tostring(lua,-1));",
          "content_same": false
        },
        {
          "line": 798,
          "old_api": "lua_pcall",
          "new_api": "lua_pop",
          "old_text": "lua_pcall(lua,0,0,0)",
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "    if (lua_pcall(lua,0,0,0)) {",
          "new_line_content": "        lua_pop(lua,1);",
          "content_same": false
        },
        {
          "line": 809,
          "old_api": "dictAdd",
          "new_api": "incrRefCount",
          "old_text": "dictAdd(server.lua_scripts,\n                             sdsnewlen(funcname+2,40),body)",
          "new_text": "incrRefCount(body)",
          "old_line_content": "        int retval = dictAdd(server.lua_scripts,",
          "new_line_content": "        incrRefCount(body);",
          "content_same": false
        },
        {
          "line": 839,
          "old_api": "getLongLongFromObjectOrReply",
          "new_api": "addReplyError",
          "old_text": "getLongLongFromObjectOrReply(c,c->argv[2],&numkeys,NULL)",
          "new_text": "addReplyError(c,\"Number of keys can't be greater than number of args\")",
          "old_line_content": "    if (getLongLongFromObjectOrReply(c,c->argv[2],&numkeys,NULL) != REDIS_OK)",
          "new_line_content": "        addReplyError(c,\"Number of keys can't be greater than number of args\");",
          "content_same": false
        },
        {
          "line": 875,
          "old_api": "addReply",
          "new_api": "luaCreateFunction",
          "old_text": "addReply(c, shared.noscripterr)",
          "new_text": "luaCreateFunction(c,lua,funcname,c->argv[1])",
          "old_line_content": "            addReply(c, shared.noscripterr);",
          "new_line_content": "        if (luaCreateFunction(c,lua,funcname,c->argv[1]) == REDIS_ERR) {",
          "content_same": false
        },
        {
          "line": 892,
          "old_api": "luaSetGlobalArray",
          "new_api": "selectDb",
          "old_text": "luaSetGlobalArray(lua,\"ARGV\",c->argv+3+numkeys,c->argc-3-numkeys)",
          "new_text": "selectDb(server.lua_client,c->db->id)",
          "old_line_content": "    luaSetGlobalArray(lua,\"ARGV\",c->argv+3+numkeys,c->argc-3-numkeys);",
          "new_line_content": "    selectDb(server.lua_client,c->db->id);",
          "content_same": false
        },
        {
          "line": 902,
          "old_api": "mstime",
          "new_api": "lua_sethook",
          "old_text": "mstime()",
          "new_text": "lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000)",
          "old_line_content": "    server.lua_time_start = mstime();",
          "new_line_content": "        lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000);",
          "content_same": false
        },
        {
          "line": 912,
          "old_api": "lua_pcall",
          "new_api": "lua_sethook",
          "old_text": "lua_pcall(lua,0,1,-2)",
          "new_text": "lua_sethook(lua,luaMaskCountHook,0,0)",
          "old_line_content": "    err = lua_pcall(lua,0,1,-2);",
          "new_line_content": "    if (delhook) lua_sethook(lua,luaMaskCountHook,0,0); /* Disable hook */",
          "content_same": false
        },
        {
          "line": 925,
          "old_api": "lua_gc",
          "new_api": "addReplyErrorFormat",
          "old_text": "lua_gc(lua,LUA_GCSTEP,1)",
          "new_text": "addReplyErrorFormat(c,\"Error running script (call to %s): %s\\n\",\n            funcname, lua_tostring(lua,-1))",
          "old_line_content": "    lua_gc(lua,LUA_GCSTEP,1);",
          "new_line_content": "        addReplyErrorFormat(c,\"Error running script (call to %s): %s\\n\",",
          "content_same": false
        },
        {
          "line": 953,
          "old_api": "dictFetchValue",
          "new_api": "redisAssertWithInfo",
          "old_text": "dictFetchValue(server.lua_scripts,c->argv[1]->ptr)",
          "new_text": "redisAssertWithInfo(c,NULL,script != NULL)",
          "old_line_content": "            robj *script = dictFetchValue(server.lua_scripts,c->argv[1]->ptr);",
          "new_line_content": "            redisAssertWithInfo(c,NULL,script != NULL);",
          "content_same": false
        },
        {
          "line": 955,
          "old_api": "replicationScriptCacheAdd",
          "new_api": "createStringObject",
          "old_text": "replicationScriptCacheAdd(c->argv[1]->ptr)",
          "new_text": "createStringObject(\"EVAL\",4)",
          "old_line_content": "            replicationScriptCacheAdd(c->argv[1]->ptr);",
          "new_line_content": "                resetRefCount(createStringObject(\"EVAL\",4)));",
          "content_same": false
        },
        {
          "line": 956,
          "old_api": "redisAssertWithInfo",
          "new_api": "rewriteClientCommandArgument",
          "old_text": "redisAssertWithInfo(c,NULL,script != NULL)",
          "new_text": "rewriteClientCommandArgument(c,1,script)",
          "old_line_content": "            redisAssertWithInfo(c,NULL,script != NULL);",
          "new_line_content": "            rewriteClientCommandArgument(c,1,script);",
          "content_same": false
        },
        {
          "line": 957,
          "old_api": "rewriteClientCommandArgument",
          "new_api": "forceCommandPropagation",
          "old_text": "rewriteClientCommandArgument(c,0,\n                resetRefCount(createStringObject(\"EVAL\",4)))",
          "new_text": "forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF)",
          "old_line_content": "            rewriteClientCommandArgument(c,0,",
          "new_line_content": "            forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF);",
          "content_same": false
        },
        {
          "line": 975,
          "old_api": "addReply",
          "new_api": "evalGenericCommand",
          "old_text": "addReply(c, shared.noscripterr)",
          "new_text": "evalGenericCommand(c,1)",
          "old_line_content": "        addReply(c, shared.noscripterr);",
          "new_line_content": "    evalGenericCommand(c,1);",
          "content_same": false
        },
        {
          "line": 1004,
          "old_api": "luaL_checkint",
          "new_api": "floor",
          "old_text": "luaL_checkint(L, 1)",
          "new_text": "floor(r*(u-l+1))",
          "old_line_content": "      int l = luaL_checkint(L, 1);",
          "new_line_content": "      lua_pushnumber(L, floor(r*(u-l+1))+l);  /* int between `l' and `u' */",
          "content_same": false
        },
        {
          "line": 1007,
          "old_api": "floor",
          "new_api": "luaL_error",
          "old_text": "floor(r*(u-l+1))",
          "new_text": "luaL_error(L, \"wrong number of arguments\")",
          "old_line_content": "      lua_pushnumber(L, floor(r*(u-l+1))+l);  /* int between `l' and `u' */",
          "new_line_content": "    default: return luaL_error(L, \"wrong number of arguments\");",
          "content_same": false
        },
        {
          "line": 1025,
          "old_api": "strcasecmp",
          "new_api": "replicationScriptCacheFlush",
          "old_text": "strcasecmp(c->argv[1]->ptr,\"flush\")",
          "new_text": "replicationScriptCacheFlush()",
          "old_line_content": "    if (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\"flush\")) {",
          "new_line_content": "        replicationScriptCacheFlush();",
          "content_same": false
        },
        {
          "line": 1027,
          "old_api": "addReply",
          "new_api": "strcasecmp",
          "old_text": "addReply(c,shared.ok)",
          "new_text": "strcasecmp(c->argv[1]->ptr,\"exists\")",
          "old_line_content": "        addReply(c,shared.ok);",
          "new_line_content": "    } else if (c->argc >= 2 && !strcasecmp(c->argv[1]->ptr,\"exists\")) {",
          "content_same": false
        },
        {
          "line": 1030,
          "old_api": "strcasecmp",
          "new_api": "addReplyMultiBulkLen",
          "old_text": "strcasecmp(c->argv[1]->ptr,\"exists\")",
          "new_text": "addReplyMultiBulkLen(c, c->argc-2)",
          "old_line_content": "    } else if (c->argc >= 2 && !strcasecmp(c->argv[1]->ptr,\"exists\")) {",
          "new_line_content": "        addReplyMultiBulkLen(c, c->argc-2);",
          "content_same": false
        },
        {
          "line": 1033,
          "old_api": "addReplyMultiBulkLen",
          "new_api": "addReply",
          "old_text": "addReplyMultiBulkLen(c, c->argc-2)",
          "new_text": "addReply(c,shared.cone)",
          "old_line_content": "        addReplyMultiBulkLen(c, c->argc-2);",
          "new_line_content": "                addReply(c,shared.cone);",
          "content_same": false
        },
        {
          "line": 1035,
          "old_api": "dictFind",
          "new_api": "addReply",
          "old_text": "dictFind(server.lua_scripts,c->argv[j]->ptr)",
          "new_text": "addReply(c,shared.czero)",
          "old_line_content": "            if (dictFind(server.lua_scripts,c->argv[j]->ptr))",
          "new_line_content": "                addReply(c,shared.czero);",
          "content_same": false
        },
        {
          "line": 1046,
          "old_api": "sdslen",
          "new_api": "luaCreateFunction",
          "old_text": "sdslen(c->argv[2]->ptr)",
          "new_text": "luaCreateFunction(c,server.lua,funcname,c->argv[2])",
          "old_line_content": "        sha1hex(funcname+2,c->argv[2]->ptr,sdslen(c->argv[2]->ptr));",
          "new_line_content": "            if (luaCreateFunction(c,server.lua,funcname,c->argv[2])",
          "content_same": false
        },
        {
          "line": 1048,
          "old_api": "dictFind",
          "new_api": "sdsfree",
          "old_text": "dictFind(server.lua_scripts,sha)",
          "new_text": "sdsfree(sha)",
          "old_line_content": "        if (dictFind(server.lua_scripts,sha) == NULL) {",
          "new_line_content": "                sdsfree(sha);",
          "content_same": false
        },
        {
          "line": 1055,
          "old_api": "addReplyBulkCBuffer",
          "new_api": "strcasecmp",
          "old_text": "addReplyBulkCBuffer(c,funcname+2,40)",
          "new_text": "strcasecmp(c->argv[1]->ptr,\"kill\")",
          "old_line_content": "        addReplyBulkCBuffer(c,funcname+2,40);",
          "new_line_content": "    } else if (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\"kill\")) {",
          "content_same": false
        },
        {
          "line": 1057,
          "old_api": "forceCommandPropagation",
          "new_api": "sdsnew",
          "old_text": "forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF)",
          "new_text": "sdsnew(\"-NOTBUSY No scripts in execution right now.\\r\\n\")",
          "old_line_content": "        forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF);",
          "new_line_content": "            addReplySds(c,sdsnew(\"-NOTBUSY No scripts in execution right now.\\r\\n\"));",
          "content_same": false
        },
        {
          "line": 1062,
          "old_api": "sdsnew",
          "new_api": "addReply",
          "old_text": "sdsnew(\"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\\r\\n\")",
          "new_text": "addReply(c,shared.ok)",
          "old_line_content": "            addReplySds(c,sdsnew(\"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\\r\\n\"));",
          "new_line_content": "            addReply(c,shared.ok);",
          "content_same": false
        },
        {
          "line": 1065,
          "old_api": "addReply",
          "new_api": "addReplyError",
          "old_text": "addReply(c,shared.ok)",
          "new_text": "addReplyError(c, \"Unknown SCRIPT subcommand or wrong # of args.\")",
          "old_line_content": "            addReply(c,shared.ok);",
          "new_line_content": "        addReplyError(c, \"Unknown SCRIPT subcommand or wrong # of args.\");",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 1024,
          "old_api": null,
          "new_api": "addReply",
          "old_text": null,
          "new_text": "addReply(c,shared.ok)",
          "old_line_content": "void scriptCommand(redisClient *c) {",
          "new_line_content": "        addReply(c,shared.ok);",
          "content_same": false
        },
        {
          "line": 1032,
          "old_api": null,
          "new_api": "dictFind",
          "old_text": null,
          "new_text": "dictFind(server.lua_scripts,c->argv[j]->ptr)",
          "old_line_content": "",
          "new_line_content": "            if (dictFind(server.lua_scripts,c->argv[j]->ptr))",
          "content_same": false
        },
        {
          "line": 524,
          "old_api": null,
          "new_api": "strlen",
          "old_text": null,
          "new_text": "strlen(s[j])",
          "old_line_content": "    s[j++]=\"end\\n\";",
          "new_line_content": "    for (j = 0; s[j] != NULL; j++) code = sdscatlen(code,s[j],strlen(s[j]));",
          "content_same": false
        },
        {
          "line": 525,
          "old_api": null,
          "new_api": "sdslen",
          "old_text": null,
          "new_text": "sdslen(code)",
          "old_line_content": "    s[j++]=NULL;",
          "new_line_content": "    luaL_loadbuffer(lua,code,sdslen(code),\"@enable_strict_lua\");",
          "content_same": false
        },
        {
          "line": 526,
          "old_api": null,
          "new_api": "lua_pcall",
          "old_text": null,
          "new_text": "lua_pcall(lua,0,0,0)",
          "old_line_content": "",
          "new_line_content": "    lua_pcall(lua,0,0,0);",
          "content_same": false
        },
        {
          "line": 1037,
          "old_api": null,
          "new_api": "strcasecmp",
          "old_text": null,
          "new_text": "strcasecmp(c->argv[1]->ptr,\"load\")",
          "old_line_content": "            else",
          "new_line_content": "    } else if (c->argc == 3 && !strcasecmp(c->argv[1]->ptr,\"load\")) {",
          "content_same": false
        },
        {
          "line": 1043,
          "old_api": null,
          "new_api": "sdslen",
          "old_text": null,
          "new_text": "sdslen(c->argv[2]->ptr)",
          "old_line_content": "",
          "new_line_content": "        sha1hex(funcname+2,c->argv[2]->ptr,sdslen(c->argv[2]->ptr));",
          "content_same": false
        },
        {
          "line": 1044,
          "old_api": null,
          "new_api": "sdsnewlen",
          "old_text": null,
          "new_text": "sdsnewlen(funcname+2,40)",
          "old_line_content": "        funcname[0] = 'f';",
          "new_line_content": "        sha = sdsnewlen(funcname+2,40);",
          "content_same": false
        },
        {
          "line": 1045,
          "old_api": null,
          "new_api": "dictFind",
          "old_text": null,
          "new_text": "dictFind(server.lua_scripts,sha)",
          "old_line_content": "        funcname[1] = '_';",
          "new_line_content": "        if (dictFind(server.lua_scripts,sha) == NULL) {",
          "content_same": false
        },
        {
          "line": 535,
          "old_api": null,
          "new_api": "lua_open",
          "old_text": null,
          "new_text": "lua_open()",
          "old_line_content": " * assuming that we call scriptingRelease() before.",
          "new_line_content": "    lua_State *lua = lua_open();",
          "content_same": false
        },
        {
          "line": 537,
          "old_api": null,
          "new_api": "luaLoadLibraries",
          "old_text": null,
          "new_text": "luaLoadLibraries(lua)",
          "old_line_content": "void scriptingInit(void) {",
          "new_line_content": "    luaLoadLibraries(lua);",
          "content_same": false
        },
        {
          "line": 1052,
          "old_api": null,
          "new_api": "addReplyBulkCBuffer",
          "old_text": null,
          "new_text": "addReplyBulkCBuffer(c,funcname+2,40)",
          "old_line_content": "                return;",
          "new_line_content": "        addReplyBulkCBuffer(c,funcname+2,40);",
          "content_same": false
        },
        {
          "line": 1053,
          "old_api": null,
          "new_api": "sdsfree",
          "old_text": null,
          "new_text": "sdsfree(sha)",
          "old_line_content": "            }",
          "new_line_content": "        sdsfree(sha);",
          "content_same": false
        },
        {
          "line": 1054,
          "old_api": null,
          "new_api": "forceCommandPropagation",
          "old_text": null,
          "new_text": "forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF)",
          "old_line_content": "        }",
          "new_line_content": "        forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF);",
          "content_same": false
        },
        {
          "line": 543,
          "old_api": null,
          "new_api": "dictCreate",
          "old_text": null,
          "new_text": "dictCreate(&shaScriptObjectDictType,NULL)",
          "old_line_content": "    /* Initialize a dictionary we use to map SHAs to scripts.",
          "new_line_content": "    server.lua_scripts = dictCreate(&shaScriptObjectDictType,NULL);",
          "content_same": false
        },
        {
          "line": 1059,
          "old_api": null,
          "new_api": "sdsnew",
          "old_text": null,
          "new_text": "sdsnew(\"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\\r\\n\")",
          "old_line_content": "        if (server.lua_caller == NULL) {",
          "new_line_content": "            addReplySds(c,sdsnew(\"-UNKILLABLE Sorry the script already executed write commands against the dataset. You can either wait the script termination or kill the server in a hard way using the SHUTDOWN NOSAVE command.\\r\\n\"));",
          "content_same": false
        },
        {
          "line": 550,
          "old_api": null,
          "new_api": "lua_pushcfunction",
          "old_text": null,
          "new_text": "lua_pushcfunction(lua,luaRedisCallCommand)",
          "old_line_content": "",
          "new_line_content": "    lua_pushcfunction(lua,luaRedisCallCommand);",
          "content_same": false
        },
        {
          "line": 551,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "    /* redis.call */",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 555,
          "old_api": null,
          "new_api": "lua_pushcfunction",
          "old_text": null,
          "new_text": "lua_pushcfunction(lua,luaRedisPCallCommand)",
          "old_line_content": "",
          "new_line_content": "    lua_pushcfunction(lua,luaRedisPCallCommand);",
          "content_same": false
        },
        {
          "line": 556,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "    /* redis.pcall */",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 560,
          "old_api": null,
          "new_api": "lua_pushcfunction",
          "old_text": null,
          "new_text": "lua_pushcfunction(lua,luaLogCommand)",
          "old_line_content": "",
          "new_line_content": "    lua_pushcfunction(lua,luaLogCommand);",
          "content_same": false
        },
        {
          "line": 561,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "    /* redis.log and log levels. */",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 565,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 569,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 573,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 577,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 581,
          "old_api": null,
          "new_api": "lua_pushcfunction",
          "old_text": null,
          "new_text": "lua_pushcfunction(lua, luaRedisSha1hexCommand)",
          "old_line_content": "",
          "new_line_content": "    lua_pushcfunction(lua, luaRedisSha1hexCommand);",
          "content_same": false
        },
        {
          "line": 582,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua, -3)",
          "old_line_content": "    /* redis.sha1hex */",
          "new_line_content": "    lua_settable(lua, -3);",
          "content_same": false
        },
        {
          "line": 586,
          "old_api": null,
          "new_api": "lua_pushcfunction",
          "old_text": null,
          "new_text": "lua_pushcfunction(lua, luaRedisErrorReplyCommand)",
          "old_line_content": "",
          "new_line_content": "    lua_pushcfunction(lua, luaRedisErrorReplyCommand);",
          "content_same": false
        },
        {
          "line": 587,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua, -3)",
          "old_line_content": "    /* redis.error_reply and redis.status_reply */",
          "new_line_content": "    lua_settable(lua, -3);",
          "content_same": false
        },
        {
          "line": 598,
          "old_api": null,
          "new_api": "lua_pushstring",
          "old_text": null,
          "new_text": "lua_pushstring(lua,\"random\")",
          "old_line_content": "    /* Replace math.random and math.randomseed with our implementations. */",
          "new_line_content": "    lua_pushstring(lua,\"random\");",
          "content_same": false
        },
        {
          "line": 600,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 604,
          "old_api": null,
          "new_api": "lua_settable",
          "old_text": null,
          "new_text": "lua_settable(lua,-3)",
          "old_line_content": "",
          "new_line_content": "    lua_settable(lua,-3);",
          "content_same": false
        },
        {
          "line": 616,
          "old_api": null,
          "new_api": "strlen",
          "old_text": null,
          "new_text": "strlen(compare_func)",
          "old_line_content": "                                \"  if b == false then b = '' end\\n\"",
          "new_line_content": "        luaL_loadbuffer(lua,compare_func,strlen(compare_func),\"@cmp_func_def\");",
          "content_same": false
        },
        {
          "line": 617,
          "old_api": null,
          "new_api": "lua_pcall",
          "old_text": null,
          "new_text": "lua_pcall(lua,0,0,0)",
          "old_line_content": "                                \"  return a<b\\n\"",
          "new_line_content": "        lua_pcall(lua,0,0,0);",
          "content_same": false
        },
        {
          "line": 636,
          "old_api": null,
          "new_api": "strlen",
          "old_text": null,
          "new_text": "strlen(errh_func)",
          "old_line_content": "                                \"    return err\\n\"",
          "new_line_content": "        luaL_loadbuffer(lua,errh_func,strlen(errh_func),\"@err_handler_def\");",
          "content_same": false
        },
        {
          "line": 637,
          "old_api": null,
          "new_api": "lua_pcall",
          "old_text": null,
          "new_text": "lua_pcall(lua,0,0,0)",
          "old_line_content": "                                \"  end\\n\"",
          "new_line_content": "        lua_pcall(lua,0,0,0);",
          "content_same": false
        },
        {
          "line": 645,
          "old_api": null,
          "new_api": "createClient",
          "old_text": null,
          "new_text": "createClient(-1)",
          "old_line_content": "     * Note: there is no need to create it again when this function is called",
          "new_line_content": "        server.lua_client = createClient(-1);",
          "content_same": false
        },
        {
          "line": 652,
          "old_api": null,
          "new_api": "scriptingEnableGlobalsProtection",
          "old_text": null,
          "new_text": "scriptingEnableGlobalsProtection(lua)",
          "old_line_content": "    /* Lua beginners ofter don't use \"local\", this is likely to introduce",
          "new_line_content": "    scriptingEnableGlobalsProtection(lua);",
          "content_same": false
        },
        {
          "line": 660,
          "old_api": null,
          "new_api": "dictRelease",
          "old_text": null,
          "new_text": "dictRelease(server.lua_scripts)",
          "old_line_content": "/* Release resources related to Lua scripting.",
          "new_line_content": "    dictRelease(server.lua_scripts);",
          "content_same": false
        },
        {
          "line": 661,
          "old_api": null,
          "new_api": "lua_close",
          "old_text": null,
          "new_text": "lua_close(server.lua)",
          "old_line_content": " * This function is used in order to reset the scripting environment. */",
          "new_line_content": "    lua_close(server.lua);",
          "content_same": false
        },
        {
          "line": 665,
          "old_api": null,
          "new_api": "scriptingRelease",
          "old_text": null,
          "new_text": "scriptingRelease()",
          "old_line_content": "}",
          "new_line_content": "    scriptingRelease();",
          "content_same": false
        },
        {
          "line": 666,
          "old_api": null,
          "new_api": "scriptingInit",
          "old_text": null,
          "new_text": "scriptingInit()",
          "old_line_content": "",
          "new_line_content": "    scriptingInit();",
          "content_same": false
        },
        {
          "line": 681,
          "old_api": null,
          "new_api": "SHA1Init",
          "old_text": null,
          "new_text": "SHA1Init(&ctx)",
          "old_line_content": "    char *cset = \"0123456789abcdef\";",
          "new_line_content": "    SHA1Init(&ctx);",
          "content_same": false
        },
        {
          "line": 682,
          "old_api": null,
          "new_api": "SHA1Update",
          "old_text": null,
          "new_text": "SHA1Update(&ctx,(unsigned char*)script,len)",
          "old_line_content": "    int j;",
          "new_line_content": "    SHA1Update(&ctx,(unsigned char*)script,len);",
          "content_same": false
        },
        {
          "line": 683,
          "old_api": null,
          "new_api": "SHA1Final",
          "old_text": null,
          "new_text": "SHA1Final(hash,&ctx)",
          "old_line_content": "",
          "new_line_content": "    SHA1Final(hash,&ctx);",
          "content_same": false
        },
        {
          "line": 693,
          "old_api": null,
          "new_api": "lua_type",
          "old_text": null,
          "new_text": "lua_type(lua,-1)",
          "old_line_content": "}",
          "new_line_content": "    int t = lua_type(lua,-1);",
          "content_same": false
        },
        {
          "line": 697,
          "old_api": null,
          "new_api": "lua_strlen",
          "old_text": null,
          "new_text": "lua_strlen(lua,-1)",
          "old_line_content": "",
          "new_line_content": "        addReplyBulkCBuffer(c,(char*)lua_tostring(lua,-1),lua_strlen(lua,-1));",
          "content_same": false
        },
        {
          "line": 709,
          "old_api": null,
          "new_api": "lua_pushstring",
          "old_text": null,
          "new_text": "lua_pushstring(lua,\"err\")",
          "old_line_content": "        /* We need to check if it is an array, an error, or a status reply.",
          "new_line_content": "        lua_pushstring(lua,\"err\");",
          "content_same": false
        },
        {
          "line": 710,
          "old_api": null,
          "new_api": "lua_gettable",
          "old_text": null,
          "new_text": "lua_gettable(lua,-2)",
          "old_line_content": "         * Error are returned as a single element table with 'err' field.",
          "new_line_content": "        lua_gettable(lua,-2);",
          "content_same": false
        },
        {
          "line": 711,
          "old_api": null,
          "new_api": "lua_type",
          "old_text": null,
          "new_text": "lua_type(lua,-1)",
          "old_line_content": "         * Status replies are returned as single element table with 'ok' field */",
          "new_line_content": "        t = lua_type(lua,-1);",
          "content_same": false
        },
        {
          "line": 715,
          "old_api": null,
          "new_api": "sdsempty",
          "old_text": null,
          "new_text": "sdsempty()",
          "old_line_content": "        if (t == LUA_TSTRING) {",
          "new_line_content": "            addReplySds(c,sdscatprintf(sdsempty(),\"-%s\\r\\n\",err));",
          "content_same": false
        },
        {
          "line": 721,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "            return;",
          "new_line_content": "        lua_pop(lua,1);",
          "content_same": false
        },
        {
          "line": 722,
          "old_api": null,
          "new_api": "lua_pushstring",
          "old_text": null,
          "new_text": "lua_pushstring(lua,\"ok\")",
          "old_line_content": "        }",
          "new_line_content": "        lua_pushstring(lua,\"ok\");",
          "content_same": false
        },
        {
          "line": 723,
          "old_api": null,
          "new_api": "lua_gettable",
          "old_text": null,
          "new_text": "lua_gettable(lua,-2)",
          "old_line_content": "",
          "new_line_content": "        lua_gettable(lua,-2);",
          "content_same": false
        },
        {
          "line": 728,
          "old_api": null,
          "new_api": "sdsempty",
          "old_text": null,
          "new_text": "sdsempty()",
          "old_line_content": "        if (t == LUA_TSTRING) {",
          "new_line_content": "            addReplySds(c,sdscatprintf(sdsempty(),\"+%s\\r\\n\",ok));",
          "content_same": false
        },
        {
          "line": 737,
          "old_api": null,
          "new_api": "lua_pushnumber",
          "old_text": null,
          "new_text": "lua_pushnumber(lua,j++)",
          "old_line_content": "",
          "new_line_content": "                lua_pushnumber(lua,j++);",
          "content_same": false
        },
        {
          "line": 739,
          "old_api": null,
          "new_api": "lua_type",
          "old_text": null,
          "new_text": "lua_type(lua,-1)",
          "old_line_content": "            while(1) {",
          "new_line_content": "                t = lua_type(lua,-1);",
          "content_same": false
        },
        {
          "line": 751,
          "old_api": null,
          "new_api": "addReply",
          "old_text": null,
          "new_text": "addReply(c,shared.nullbulk)",
          "old_line_content": "        }",
          "new_line_content": "        addReply(c,shared.nullbulk);",
          "content_same": false
        },
        {
          "line": 753,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "    default:",
          "new_line_content": "    lua_pop(lua,1);",
          "content_same": false
        },
        {
          "line": 761,
          "old_api": null,
          "new_api": "lua_newtable",
          "old_text": null,
          "new_text": "lua_newtable(lua)",
          "old_line_content": "void luaSetGlobalArray(lua_State *lua, char *var, robj **elev, int elec) {",
          "new_line_content": "    lua_newtable(lua);",
          "content_same": false
        },
        {
          "line": 763,
          "old_api": null,
          "new_api": "sdslen",
          "old_text": null,
          "new_text": "sdslen(elev[j]->ptr)",
          "old_line_content": "",
          "new_line_content": "        lua_pushlstring(lua,(char*)elev[j]->ptr,sdslen(elev[j]->ptr));",
          "content_same": false
        },
        {
          "line": 779,
          "old_api": null,
          "new_api": "sdsempty",
          "old_text": null,
          "new_text": "sdsempty()",
          "old_line_content": " * On error REDIS_ERR is returned and an appropriate error is set in the",
          "new_line_content": "    sds funcdef = sdsempty();",
          "content_same": false
        },
        {
          "line": 781,
          "old_api": null,
          "new_api": "sdscat",
          "old_text": null,
          "new_text": "sdscat(funcdef,\"function \")",
          "old_line_content": "int luaCreateFunction(redisClient *c, lua_State *lua, char *funcname, robj *body) {",
          "new_line_content": "    funcdef = sdscat(funcdef,\"function \");",
          "content_same": false
        },
        {
          "line": 783,
          "old_api": null,
          "new_api": "sdscatlen",
          "old_text": null,
          "new_text": "sdscatlen(funcdef,\"() \",3)",
          "old_line_content": "",
          "new_line_content": "    funcdef = sdscatlen(funcdef,\"() \",3);",
          "content_same": false
        },
        {
          "line": 789,
          "old_api": null,
          "new_api": "lua_tostring",
          "old_text": null,
          "new_text": "lua_tostring(lua,-1)",
          "old_line_content": "",
          "new_line_content": "            lua_tostring(lua,-1));",
          "content_same": false
        },
        {
          "line": 795,
          "old_api": null,
          "new_api": "lua_pcall",
          "old_text": null,
          "new_text": "lua_pcall(lua,0,0,0)",
          "old_line_content": "        return REDIS_ERR;",
          "new_line_content": "    if (lua_pcall(lua,0,0,0)) {",
          "content_same": false
        },
        {
          "line": 796,
          "old_api": null,
          "new_api": "addReplyErrorFormat",
          "old_text": null,
          "new_text": "addReplyErrorFormat(c,\"Error running script (new function): %s\\n\",\n            lua_tostring(lua,-1))",
          "old_line_content": "    }",
          "new_line_content": "        addReplyErrorFormat(c,\"Error running script (new function): %s\\n\",",
          "content_same": false
        },
        {
          "line": 806,
          "old_api": null,
          "new_api": "dictAdd",
          "old_text": null,
          "new_text": "dictAdd(server.lua_scripts,\n                             sdsnewlen(funcname+2,40),body)",
          "old_line_content": "     * so that we can replicate / write in the AOF all the",
          "new_line_content": "        int retval = dictAdd(server.lua_scripts,",
          "content_same": false
        },
        {
          "line": 807,
          "old_api": null,
          "new_api": "sdsnewlen",
          "old_text": null,
          "new_text": "sdsnewlen(funcname+2,40)",
          "old_line_content": "     * EVALSHA commands as EVAL using the original script. */",
          "new_line_content": "                             sdsnewlen(funcname+2,40),body);",
          "content_same": false
        },
        {
          "line": 808,
          "old_api": null,
          "new_api": "redisAssertWithInfo",
          "old_text": null,
          "new_text": "redisAssertWithInfo(c,NULL,retval == DICT_OK)",
          "old_line_content": "    {",
          "new_line_content": "        redisAssertWithInfo(c,NULL,retval == DICT_OK);",
          "content_same": false
        },
        {
          "line": 822,
          "old_api": null,
          "new_api": "redisSrand48",
          "old_text": null,
          "new_text": "redisSrand48(0)",
          "old_line_content": "",
          "new_line_content": "    redisSrand48(0);",
          "content_same": false
        },
        {
          "line": 312,
          "old_api": null,
          "new_api": "listFirst",
          "old_text": null,
          "new_text": "listFirst(c->reply)",
          "old_line_content": "        c->bufpos = 0;",
          "new_line_content": "        robj *o = listNodeValue(listFirst(c->reply));",
          "content_same": false
        },
        {
          "line": 323,
          "old_api": null,
          "new_api": "luaSortArray",
          "old_text": null,
          "new_text": "luaSortArray(lua)",
          "old_line_content": "     * reply as expected. */",
          "new_line_content": "            luaSortArray(lua);",
          "content_same": false
        },
        {
          "line": 836,
          "old_api": null,
          "new_api": "getLongLongFromObjectOrReply",
          "old_text": null,
          "new_text": "getLongLongFromObjectOrReply(c,c->argv[2],&numkeys,NULL)",
          "old_line_content": "    server.lua_write_dirty = 0;",
          "new_line_content": "    if (getLongLongFromObjectOrReply(c,c->argv[2],&numkeys,NULL) != REDIS_OK)",
          "content_same": false
        },
        {
          "line": 325,
          "old_api": null,
          "new_api": "sdsfree",
          "old_text": null,
          "new_text": "sdsfree(reply)",
          "old_line_content": "        (reply[0] == '*' && reply[1] != '-')) {",
          "new_line_content": "    sdsfree(reply);",
          "content_same": false
        },
        {
          "line": 332,
          "old_api": null,
          "new_api": "decrRefCount",
          "old_text": null,
          "new_text": "decrRefCount(c->argv[j])",
          "old_line_content": "    /* Clean up. Command code may have changed argv/argc so we use the",
          "new_line_content": "        decrRefCount(c->argv[j]);",
          "content_same": false
        },
        {
          "line": 333,
          "old_api": null,
          "new_api": "zfree",
          "old_text": null,
          "new_text": "zfree(c->argv)",
          "old_line_content": "     * argv/argc of the client instead of the local variables. */",
          "new_line_content": "    zfree(c->argv);",
          "content_same": false
        },
        {
          "line": 849,
          "old_api": null,
          "new_api": "sdslen",
          "old_text": null,
          "new_text": "sdslen(c->argv[1]->ptr)",
          "old_line_content": "    funcname[1] = '_';",
          "new_line_content": "        sha1hex(funcname+2,c->argv[1]->ptr,sdslen(c->argv[1]->ptr));",
          "content_same": false
        },
        {
          "line": 339,
          "old_api": null,
          "new_api": "lua_pushstring",
          "old_text": null,
          "new_text": "lua_pushstring(lua,\"err\")",
          "old_line_content": "        /* If we are here we should have an error in the stack, in the",
          "new_line_content": "        lua_pushstring(lua,\"err\");",
          "content_same": false
        },
        {
          "line": 340,
          "old_api": null,
          "new_api": "lua_gettable",
          "old_text": null,
          "new_text": "lua_gettable(lua,-2)",
          "old_line_content": "         * form of a table with an \"err\" field. Extract the string to",
          "new_line_content": "        lua_gettable(lua,-2);",
          "content_same": false
        },
        {
          "line": 341,
          "old_api": null,
          "new_api": "lua_error",
          "old_text": null,
          "new_text": "lua_error(lua)",
          "old_line_content": "         * return the plain error. */",
          "new_line_content": "        return lua_error(lua);",
          "content_same": false
        },
        {
          "line": 856,
          "old_api": null,
          "new_api": "tolower",
          "old_text": null,
          "new_text": "tolower(sha[j])",
          "old_line_content": "        char *sha = c->argv[1]->ptr;",
          "new_line_content": "            funcname[j+2] = tolower(sha[j]);",
          "content_same": false
        },
        {
          "line": 347,
          "old_api": null,
          "new_api": "luaRedisGenericCommand",
          "old_text": null,
          "new_text": "luaRedisGenericCommand(lua,1)",
          "old_line_content": "}",
          "new_line_content": "    return luaRedisGenericCommand(lua,1);",
          "content_same": false
        },
        {
          "line": 861,
          "old_api": null,
          "new_api": "lua_getglobal",
          "old_text": null,
          "new_text": "lua_getglobal(lua, \"__redis__err__handler\")",
          "old_line_content": "    }",
          "new_line_content": "    lua_getglobal(lua, \"__redis__err__handler\");",
          "content_same": false
        },
        {
          "line": 351,
          "old_api": null,
          "new_api": "luaRedisGenericCommand",
          "old_text": null,
          "new_text": "luaRedisGenericCommand(lua,0)",
          "old_line_content": "}",
          "new_line_content": "    return luaRedisGenericCommand(lua,0);",
          "content_same": false
        },
        {
          "line": 865,
          "old_api": null,
          "new_api": "lua_isnil",
          "old_text": null,
          "new_text": "lua_isnil(lua,-1)",
          "old_line_content": "",
          "new_line_content": "    if (lua_isnil(lua,-1)) {",
          "content_same": false
        },
        {
          "line": 866,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "    /* Try to lookup the Lua function */",
          "new_line_content": "        lua_pop(lua,1); /* remove the nil from the stack */",
          "content_same": false
        },
        {
          "line": 357,
          "old_api": null,
          "new_api": "lua_gettop",
          "old_text": null,
          "new_text": "lua_gettop(lua)",
          "old_line_content": "/* This adds redis.sha1hex(string) to Lua scripts using the same hashing",
          "new_line_content": "    int argc = lua_gettop(lua);",
          "content_same": false
        },
        {
          "line": 871,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "         * body of the function. If this is an EVALSHA call we can just",
          "new_line_content": "            lua_pop(lua,1); /* remove the error handler from the stack. */",
          "content_same": false
        },
        {
          "line": 872,
          "old_api": null,
          "new_api": "addReply",
          "old_text": null,
          "new_text": "addReply(c, shared.noscripterr)",
          "old_line_content": "         * return an error. */",
          "new_line_content": "            addReply(c, shared.noscripterr);",
          "content_same": false
        },
        {
          "line": 363,
          "old_api": null,
          "new_api": "luaPushError",
          "old_text": null,
          "new_text": "luaPushError(lua, \"wrong number of arguments\")",
          "old_line_content": "    char *s;",
          "new_line_content": "        luaPushError(lua, \"wrong number of arguments\");",
          "content_same": false
        },
        {
          "line": 876,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "            return;",
          "new_line_content": "            lua_pop(lua,1); /* remove the error handler from the stack. */",
          "content_same": false
        },
        {
          "line": 367,
          "old_api": null,
          "new_api": "lua_tolstring",
          "old_text": null,
          "new_text": "lua_tolstring(lua,1,&len)",
          "old_line_content": "        return 1;",
          "new_line_content": "    s = (char*)lua_tolstring(lua,1,&len);",
          "content_same": false
        },
        {
          "line": 368,
          "old_api": null,
          "new_api": "sha1hex",
          "old_text": null,
          "new_text": "sha1hex(digest,s,len)",
          "old_line_content": "    }",
          "new_line_content": "    sha1hex(digest,s,len);",
          "content_same": false
        },
        {
          "line": 369,
          "old_api": null,
          "new_api": "lua_pushstring",
          "old_text": null,
          "new_text": "lua_pushstring(lua,digest)",
          "old_line_content": "",
          "new_line_content": "    lua_pushstring(lua,digest);",
          "content_same": false
        },
        {
          "line": 882,
          "old_api": null,
          "new_api": "lua_getglobal",
          "old_text": null,
          "new_text": "lua_getglobal(lua, funcname)",
          "old_line_content": "            return;",
          "new_line_content": "        lua_getglobal(lua, funcname);",
          "content_same": false
        },
        {
          "line": 883,
          "old_api": null,
          "new_api": "lua_isnil",
          "old_text": null,
          "new_text": "lua_isnil(lua,-1)",
          "old_line_content": "        }",
          "new_line_content": "        redisAssert(!lua_isnil(lua,-1));",
          "content_same": false
        },
        {
          "line": 888,
          "old_api": null,
          "new_api": "luaSetGlobalArray",
          "old_text": null,
          "new_text": "luaSetGlobalArray(lua,\"KEYS\",c->argv+3,numkeys)",
          "old_line_content": "",
          "new_line_content": "    luaSetGlobalArray(lua,\"KEYS\",c->argv+3,numkeys);",
          "content_same": false
        },
        {
          "line": 889,
          "old_api": null,
          "new_api": "luaSetGlobalArray",
          "old_text": null,
          "new_text": "luaSetGlobalArray(lua,\"ARGV\",c->argv+3+numkeys,c->argc-3-numkeys)",
          "old_line_content": "    /* Populate the argv and keys table accordingly to the arguments that",
          "new_line_content": "    luaSetGlobalArray(lua,\"ARGV\",c->argv+3+numkeys,c->argc-3-numkeys);",
          "content_same": false
        },
        {
          "line": 381,
          "old_api": null,
          "new_api": "lua_type",
          "old_text": null,
          "new_text": "lua_type(lua,-1)",
          "old_line_content": " * return redis.status_reply(\"ERR Some Error\")",
          "new_line_content": "    if (lua_gettop(lua) != 1 || lua_type(lua,-1) != LUA_TSTRING) {",
          "content_same": false
        },
        {
          "line": 382,
          "old_api": null,
          "new_api": "luaPushError",
          "old_text": null,
          "new_text": "luaPushError(lua, \"wrong number or type of arguments\")",
          "old_line_content": " */",
          "new_line_content": "        luaPushError(lua, \"wrong number or type of arguments\");",
          "content_same": false
        },
        {
          "line": 386,
          "old_api": null,
          "new_api": "lua_newtable",
          "old_text": null,
          "new_text": "lua_newtable(lua)",
          "old_line_content": "        return 1;",
          "new_line_content": "    lua_newtable(lua);",
          "content_same": false
        },
        {
          "line": 387,
          "old_api": null,
          "new_api": "lua_pushstring",
          "old_text": null,
          "new_text": "lua_pushstring(lua, field)",
          "old_line_content": "    }",
          "new_line_content": "    lua_pushstring(lua, field);",
          "content_same": false
        },
        {
          "line": 388,
          "old_api": null,
          "new_api": "lua_pushvalue",
          "old_text": null,
          "new_text": "lua_pushvalue(lua, -3)",
          "old_line_content": "",
          "new_line_content": "    lua_pushvalue(lua, -3);",
          "content_same": false
        },
        {
          "line": 899,
          "old_api": null,
          "new_api": "mstime",
          "old_text": null,
          "new_text": "mstime()",
          "old_line_content": "     * We set the hook only if the time limit is enabled as the hook will",
          "new_line_content": "    server.lua_time_start = mstime();",
          "content_same": false
        },
        {
          "line": 394,
          "old_api": null,
          "new_api": "luaRedisReturnSingleFieldTable",
          "old_text": null,
          "new_text": "luaRedisReturnSingleFieldTable(lua,\"err\")",
          "old_line_content": "}",
          "new_line_content": "    return luaRedisReturnSingleFieldTable(lua,\"err\");",
          "content_same": false
        },
        {
          "line": 909,
          "old_api": null,
          "new_api": "lua_pcall",
          "old_text": null,
          "new_text": "lua_pcall(lua,0,1,-2)",
          "old_line_content": "    /* At this point whether this script was never seen before or if it was",
          "new_line_content": "    err = lua_pcall(lua,0,1,-2);",
          "content_same": false
        },
        {
          "line": 398,
          "old_api": null,
          "new_api": "luaRedisReturnSingleFieldTable",
          "old_text": null,
          "new_text": "luaRedisReturnSingleFieldTable(lua,\"ok\")",
          "old_line_content": "}",
          "new_line_content": "    return luaRedisReturnSingleFieldTable(lua,\"ok\");",
          "content_same": false
        },
        {
          "line": 402,
          "old_api": null,
          "new_api": "lua_gettop",
          "old_text": null,
          "new_text": "lua_gettop(lua)",
          "old_line_content": "}",
          "new_line_content": "    int j, argc = lua_gettop(lua);",
          "content_same": false
        },
        {
          "line": 917,
          "old_api": null,
          "new_api": "aeCreateFileEvent",
          "old_text": null,
          "new_text": "aeCreateFileEvent(server.el,c->fd,AE_READABLE,\n                          readQueryFromClient,c)",
          "old_line_content": "        server.lua_timedout = 0;",
          "new_line_content": "        aeCreateFileEvent(server.el,c->fd,AE_READABLE,",
          "content_same": false
        },
        {
          "line": 407,
          "old_api": null,
          "new_api": "log",
          "old_text": null,
          "new_text": "luaPushError(lua, \"redis.log() requires two arguments or more.\")",
          "old_line_content": "    sds log;",
          "new_line_content": "        luaPushError(lua, \"redis.log() requires two arguments or more.\");",
          "content_same": false
        },
        {
          "line": 409,
          "old_api": null,
          "new_api": "lua_isnumber",
          "old_text": null,
          "new_text": "lua_isnumber(lua,-argc)",
          "old_line_content": "    if (argc < 2) {",
          "new_line_content": "    } else if (!lua_isnumber(lua,-argc)) {",
          "content_same": false
        },
        {
          "line": 921,
          "old_api": null,
          "new_api": "selectDb",
          "old_text": null,
          "new_text": "selectDb(c,server.lua_client->db->id)",
          "old_line_content": "                          readQueryFromClient,c);",
          "new_line_content": "    selectDb(c,server.lua_client->db->id); /* set DB ID from Lua client */",
          "content_same": false
        },
        {
          "line": 922,
          "old_api": null,
          "new_api": "lua_gc",
          "old_text": null,
          "new_text": "lua_gc(lua,LUA_GCSTEP,1)",
          "old_line_content": "    }",
          "new_line_content": "    lua_gc(lua,LUA_GCSTEP,1);",
          "content_same": false
        },
        {
          "line": 926,
          "old_api": null,
          "new_api": "lua_tostring",
          "old_text": null,
          "new_text": "lua_tostring(lua,-1)",
          "old_line_content": "",
          "new_line_content": "            funcname, lua_tostring(lua,-1));",
          "content_same": false
        },
        {
          "line": 415,
          "old_api": null,
          "new_api": "luaPushError",
          "old_text": null,
          "new_text": "luaPushError(lua, \"Invalid debug level.\")",
          "old_line_content": "    }",
          "new_line_content": "        luaPushError(lua, \"Invalid debug level.\");",
          "content_same": false
        },
        {
          "line": 927,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,2)",
          "old_line_content": "    if (err) {",
          "new_line_content": "        lua_pop(lua,2); /* Consume the Lua reply and remove error handler. */",
          "content_same": false
        },
        {
          "line": 931,
          "old_api": null,
          "new_api": "luaReplyToRedisReply",
          "old_text": null,
          "new_text": "luaReplyToRedisReply(c,lua)",
          "old_line_content": "    } else {",
          "new_line_content": "        luaReplyToRedisReply(c,lua); /* Convert and consume the reply. */",
          "content_same": false
        },
        {
          "line": 420,
          "old_api": null,
          "new_api": "sdsempty",
          "old_text": null,
          "new_text": "sdsempty()",
          "old_line_content": "    }",
          "new_line_content": "    log = sdsempty();",
          "content_same": false
        },
        {
          "line": 932,
          "old_api": null,
          "new_api": "lua_pop",
          "old_text": null,
          "new_text": "lua_pop(lua,1)",
          "old_line_content": "        /* On success convert the Lua return value into Redis protocol, and",
          "new_line_content": "        lua_pop(lua,1); /* Remove the error handler. */",
          "content_same": false
        },
        {
          "line": 425,
          "old_api": null,
          "new_api": "lua_tolstring",
          "old_text": null,
          "new_text": "lua_tolstring(lua,(-argc)+j,&len)",
          "old_line_content": "        size_t len;",
          "new_line_content": "        s = (char*)lua_tolstring(lua,(-argc)+j,&len);",
          "content_same": false
        },
        {
          "line": 427,
          "old_api": null,
          "new_api": "sdscatlen",
          "old_text": null,
          "new_text": "sdscatlen(log,\" \",1)",
          "old_line_content": "",
          "new_line_content": "            if (j != 1) log = sdscatlen(log,\" \",1);",
          "content_same": false
        },
        {
          "line": 432,
          "old_api": null,
          "new_api": "sdsfree",
          "old_text": null,
          "new_text": "sdsfree(log)",
          "old_line_content": "        }",
          "new_line_content": "    sdsfree(log);",
          "content_same": false
        },
        {
          "line": 946,
          "old_api": null,
          "new_api": "replicationScriptCacheExists",
          "old_text": null,
          "new_text": "replicationScriptCacheExists(c->argv[1]->ptr)",
          "old_line_content": "     * flush our cache of scripts that can be replicated as EVALSHA, while",
          "new_line_content": "        if (!replicationScriptCacheExists(c->argv[1]->ptr)) {",
          "content_same": false
        },
        {
          "line": 438,
          "old_api": null,
          "new_api": "REDIS_NOTUSED",
          "old_text": null,
          "new_text": "REDIS_NOTUSED(ar)",
          "old_line_content": "",
          "new_line_content": "    REDIS_NOTUSED(ar);",
          "content_same": false
        },
        {
          "line": 439,
          "old_api": null,
          "new_api": "REDIS_NOTUSED",
          "old_text": null,
          "new_text": "REDIS_NOTUSED(lua)",
          "old_line_content": "void luaMaskCountHook(lua_State *lua, lua_Debug *ar) {",
          "new_line_content": "    REDIS_NOTUSED(lua);",
          "content_same": false
        },
        {
          "line": 950,
          "old_api": null,
          "new_api": "dictFetchValue",
          "old_text": null,
          "new_text": "dictFetchValue(server.lua_scripts,c->argv[1]->ptr)",
          "old_line_content": "            /* This script is not in our script cache, replicate it as",
          "new_line_content": "            robj *script = dictFetchValue(server.lua_scripts,c->argv[1]->ptr);",
          "content_same": false
        },
        {
          "line": 952,
          "old_api": null,
          "new_api": "replicationScriptCacheAdd",
          "old_text": null,
          "new_text": "replicationScriptCacheAdd(c->argv[1]->ptr)",
          "old_line_content": "             * slaves and AOF know about it. */",
          "new_line_content": "            replicationScriptCacheAdd(c->argv[1]->ptr);",
          "content_same": false
        },
        {
          "line": 954,
          "old_api": null,
          "new_api": "rewriteClientCommandArgument",
          "old_text": null,
          "new_text": "rewriteClientCommandArgument(c,0,\n                resetRefCount(createStringObject(\"EVAL\",4)))",
          "old_line_content": "",
          "new_line_content": "            rewriteClientCommandArgument(c,0,",
          "content_same": false
        },
        {
          "line": 443,
          "old_api": null,
          "new_api": "redisLog",
          "old_text": null,
          "new_text": "redisLog(REDIS_WARNING,\"Lua slow script detected: still in execution after %lld milliseconds. You can try killing the script using the SCRIPT KILL command.\",elapsed)",
          "old_line_content": "",
          "new_line_content": "        redisLog(REDIS_WARNING,\"Lua slow script detected: still in execution after %lld milliseconds. You can try killing the script using the SCRIPT KILL command.\",elapsed);",
          "content_same": false
        },
        {
          "line": 450,
          "old_api": null,
          "new_api": "aeDeleteFileEvent",
          "old_text": null,
          "new_text": "aeDeleteFileEvent(server.el, server.lua_caller->fd, AE_READABLE)",
          "old_line_content": "         * we need to mask the client executing the script from the event loop.",
          "new_line_content": "         aeDeleteFileEvent(server.el, server.lua_caller->fd, AE_READABLE);",
          "content_same": false
        },
        {
          "line": 963,
          "old_api": null,
          "new_api": "evalGenericCommand",
          "old_text": null,
          "new_text": "evalGenericCommand(c,0)",
          "old_line_content": "}",
          "new_line_content": "    evalGenericCommand(c,0);",
          "content_same": false
        },
        {
          "line": 452,
          "old_api": null,
          "new_api": "processEventsWhileBlocked",
          "old_text": null,
          "new_text": "processEventsWhileBlocked()",
          "old_line_content": "         * here when the EVAL command will return. */",
          "new_line_content": "    if (server.lua_timedout) processEventsWhileBlocked();",
          "content_same": false
        },
        {
          "line": 454,
          "old_api": null,
          "new_api": "redisLog",
          "old_text": null,
          "new_text": "redisLog(REDIS_WARNING,\"Lua script killed by user with SCRIPT KILL.\")",
          "old_line_content": "    }",
          "new_line_content": "        redisLog(REDIS_WARNING,\"Lua script killed by user with SCRIPT KILL.\");",
          "content_same": false
        },
        {
          "line": 967,
          "old_api": null,
          "new_api": "sdslen",
          "old_text": null,
          "new_text": "sdslen(c->argv[1]->ptr)",
          "old_line_content": "}",
          "new_line_content": "    if (sdslen(c->argv[1]->ptr) != 40) {",
          "content_same": false
        },
        {
          "line": 456,
          "old_api": null,
          "new_api": "lua_error",
          "old_text": null,
          "new_text": "lua_error(lua)",
          "old_line_content": "    if (server.lua_kill) {",
          "new_line_content": "        lua_error(lua);",
          "content_same": false
        },
        {
          "line": 972,
          "old_api": null,
          "new_api": "addReply",
          "old_text": null,
          "new_text": "addReply(c, shared.noscripterr)",
          "old_line_content": "         * not the right length. So we return an error ASAP, this way",
          "new_line_content": "        addReply(c, shared.noscripterr);",
          "content_same": false
        },
        {
          "line": 461,
          "old_api": null,
          "new_api": "lua_pushcfunction",
          "old_text": null,
          "new_text": "lua_pushcfunction(lua, luafunc)",
          "old_line_content": "}",
          "new_line_content": "  lua_pushcfunction(lua, luafunc);",
          "content_same": false
        },
        {
          "line": 462,
          "old_api": null,
          "new_api": "lua_pushstring",
          "old_text": null,
          "new_text": "lua_pushstring(lua, libname)",
          "old_line_content": "",
          "new_line_content": "  lua_pushstring(lua, libname);",
          "content_same": false
        },
        {
          "line": 463,
          "old_api": null,
          "new_api": "lua_call",
          "old_text": null,
          "new_text": "lua_call(lua, 1, 0)",
          "old_line_content": "void luaLoadLib(lua_State *lua, const char *libname, lua_CFunction luafunc) {",
          "new_line_content": "  lua_call(lua, 1, 0);",
          "content_same": false
        },
        {
          "line": 471,
          "old_api": null,
          "new_api": "luaLoadLib",
          "old_text": null,
          "new_text": "luaLoadLib(lua, \"\", luaopen_base)",
          "old_line_content": "LUALIB_API int (luaopen_cmsgpack) (lua_State *L);",
          "new_line_content": "    luaLoadLib(lua, \"\", luaopen_base);",
          "content_same": false
        },
        {
          "line": 472,
          "old_api": null,
          "new_api": "luaLoadLib",
          "old_text": null,
          "new_text": "luaLoadLib(lua, LUA_TABLIBNAME, luaopen_table)",
          "old_line_content": "",
          "new_line_content": "    luaLoadLib(lua, LUA_TABLIBNAME, luaopen_table);",
          "content_same": false
        },
        {
          "line": 473,
          "old_api": null,
          "new_api": "luaLoadLib",
          "old_text": null,
          "new_text": "luaLoadLib(lua, LUA_STRLIBNAME, luaopen_string)",
          "old_line_content": "void luaLoadLibraries(lua_State *lua) {",
          "new_line_content": "    luaLoadLib(lua, LUA_STRLIBNAME, luaopen_string);",
          "content_same": false
        },
        {
          "line": 987,
          "old_api": null,
          "new_api": "redisLrand48",
          "old_text": null,
          "new_text": "redisLrand48()",
          "old_line_content": "int redis_math_random (lua_State *L) {",
          "new_line_content": "  lua_Number r = (lua_Number)(redisLrand48()%REDIS_LRAND48_MAX) /",
          "content_same": false
        },
        {
          "line": 989,
          "old_api": null,
          "new_api": "lua_gettop",
          "old_text": null,
          "new_text": "lua_gettop(L)",
          "old_line_content": "     some systems (SunOS!) `rand()' may return a value larger than RAND_MAX */",
          "new_line_content": "  switch (lua_gettop(L)) {  /* check number of arguments */",
          "content_same": false
        },
        {
          "line": 991,
          "old_api": null,
          "new_api": "lua_pushnumber",
          "old_text": null,
          "new_text": "lua_pushnumber(L, r)",
          "old_line_content": "                                (lua_Number)REDIS_LRAND48_MAX;",
          "new_line_content": "      lua_pushnumber(L, r);  /* Number between 0 and 1 */",
          "content_same": false
        },
        {
          "line": 482,
          "old_api": null,
          "new_api": "luaLoadLib",
          "old_text": null,
          "new_text": "luaLoadLib(lua, LUA_OSLIBNAME, luaopen_os)",
          "old_line_content": "",
          "new_line_content": "    luaLoadLib(lua, LUA_OSLIBNAME, luaopen_os);",
          "content_same": false
        },
        {
          "line": 995,
          "old_api": null,
          "new_api": "luaL_checkint",
          "old_text": null,
          "new_text": "luaL_checkint(L, 1)",
          "old_line_content": "      break;",
          "new_line_content": "      int u = luaL_checkint(L, 1);",
          "content_same": false
        },
        {
          "line": 996,
          "old_api": null,
          "new_api": "luaL_argcheck",
          "old_text": null,
          "new_text": "luaL_argcheck(L, 1<=u, 1, \"interval is empty\")",
          "old_line_content": "    }",
          "new_line_content": "      luaL_argcheck(L, 1<=u, 1, \"interval is empty\");",
          "content_same": false
        },
        {
          "line": 997,
          "old_api": null,
          "new_api": "floor",
          "old_text": null,
          "new_text": "floor(r*u)",
          "old_line_content": "    case 1: {  /* only upper limit */",
          "new_line_content": "      lua_pushnumber(L, floor(r*u)+1);  /* int between 1 and `u' */",
          "content_same": false
        },
        {
          "line": 489,
          "old_api": null,
          "new_api": "lua_pushnil",
          "old_text": null,
          "new_text": "lua_pushnil(lua)",
          "old_line_content": "/* Remove a functions that we don't want to expose to the Redis scripting",
          "new_line_content": "    lua_pushnil(lua);",
          "content_same": false
        },
        {
          "line": 490,
          "old_api": null,
          "new_api": "lua_setglobal",
          "old_text": null,
          "new_text": "lua_setglobal(lua,\"loadfile\")",
          "old_line_content": " * environment. */",
          "new_line_content": "    lua_setglobal(lua,\"loadfile\");",
          "content_same": false
        },
        {
          "line": 1001,
          "old_api": null,
          "new_api": "luaL_checkint",
          "old_text": null,
          "new_text": "luaL_checkint(L, 1)",
          "old_line_content": "      break;",
          "new_line_content": "      int l = luaL_checkint(L, 1);",
          "content_same": false
        },
        {
          "line": 1002,
          "old_api": null,
          "new_api": "luaL_checkint",
          "old_text": null,
          "new_text": "luaL_checkint(L, 2)",
          "old_line_content": "    }",
          "new_line_content": "      int u = luaL_checkint(L, 2);",
          "content_same": false
        },
        {
          "line": 1003,
          "old_api": null,
          "new_api": "luaL_argcheck",
          "old_text": null,
          "new_text": "luaL_argcheck(L, l<=u, 2, \"interval is empty\")",
          "old_line_content": "    case 2: {  /* lower and upper limits */",
          "new_line_content": "      luaL_argcheck(L, l<=u, 2, \"interval is empty\");",
          "content_same": false
        },
        {
          "line": 500,
          "old_api": null,
          "new_api": "sdsempty",
          "old_text": null,
          "new_text": "sdsempty()",
          "old_line_content": " * sequence, because it may interact with creation of globals. */",
          "new_line_content": "    sds code = sdsempty();",
          "content_same": false
        },
        {
          "line": 1013,
          "old_api": null,
          "new_api": "luaL_checkint",
          "old_text": null,
          "new_text": "luaL_checkint(L, 1)",
          "old_line_content": "}",
          "new_line_content": "  redisSrand48(luaL_checkint(L, 1));",
          "content_same": false
        },
        {
          "line": 1022,
          "old_api": null,
          "new_api": "strcasecmp",
          "old_text": null,
          "new_text": "strcasecmp(c->argv[1]->ptr,\"flush\")",
          "old_line_content": " * ------------------------------------------------------------------------- */",
          "new_line_content": "    if (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\"flush\")) {",
          "content_same": false
        },
        {
          "line": 1023,
          "old_api": null,
          "new_api": "scriptingReset",
          "old_text": null,
          "new_text": "scriptingReset()",
          "old_line_content": "",
          "new_line_content": "        scriptingReset();",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 1026,
          "old_api": "scriptingReset",
          "new_api": null,
          "old_text": "scriptingReset()",
          "new_text": null,
          "old_line_content": "        scriptingReset();",
          "new_line_content": "        server.dirty++; /* Propagating this command is a good idea. */",
          "content_same": false
        },
        {
          "line": 1028,
          "old_api": "replicationScriptCacheFlush",
          "new_api": null,
          "old_text": "replicationScriptCacheFlush()",
          "new_text": null,
          "old_line_content": "        replicationScriptCacheFlush();",
          "new_line_content": "        int j;",
          "content_same": false
        },
        {
          "line": 1036,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c,shared.cone)",
          "new_text": null,
          "old_line_content": "                addReply(c,shared.cone);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 1038,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c,shared.czero)",
          "new_text": null,
          "old_line_content": "                addReply(c,shared.czero);",
          "new_line_content": "        char funcname[43];",
          "content_same": false
        },
        {
          "line": 528,
          "old_api": "sdslen",
          "new_api": null,
          "old_text": "sdslen(code)",
          "new_text": null,
          "old_line_content": "    luaL_loadbuffer(lua,code,sdslen(code),\"@enable_strict_lua\");",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 529,
          "old_api": "lua_pcall",
          "new_api": null,
          "old_text": "lua_pcall(lua,0,0,0)",
          "new_text": null,
          "old_line_content": "    lua_pcall(lua,0,0,0);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 530,
          "old_api": "sdsfree",
          "new_api": null,
          "old_text": "sdsfree(code)",
          "new_text": null,
          "old_line_content": "    sdsfree(code);",
          "new_line_content": "/* Initialize the scripting environment.",
          "content_same": false
        },
        {
          "line": 1040,
          "old_api": "strcasecmp",
          "new_api": null,
          "old_text": "strcasecmp(c->argv[1]->ptr,\"load\")",
          "new_text": null,
          "old_line_content": "    } else if (c->argc == 3 && !strcasecmp(c->argv[1]->ptr,\"load\")) {",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 1047,
          "old_api": "sdsnewlen",
          "new_api": null,
          "old_text": "sdsnewlen(funcname+2,40)",
          "new_text": null,
          "old_line_content": "        sha = sdsnewlen(funcname+2,40);",
          "new_line_content": "                    == REDIS_ERR) {",
          "content_same": false
        },
        {
          "line": 1049,
          "old_api": "luaCreateFunction",
          "new_api": null,
          "old_text": "luaCreateFunction(c,server.lua,funcname,c->argv[2])",
          "new_text": null,
          "old_line_content": "            if (luaCreateFunction(c,server.lua,funcname,c->argv[2])",
          "new_line_content": "                return;",
          "content_same": false
        },
        {
          "line": 1051,
          "old_api": "sdsfree",
          "new_api": null,
          "old_text": "sdsfree(sha)",
          "new_text": null,
          "old_line_content": "                sdsfree(sha);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 540,
          "old_api": "luaLoadLibraries",
          "new_api": null,
          "old_text": "luaLoadLibraries(lua)",
          "new_text": null,
          "old_line_content": "    luaLoadLibraries(lua);",
          "new_line_content": "    /* Initialize a dictionary we use to map SHAs to scripts.",
          "content_same": false
        },
        {
          "line": 541,
          "old_api": "luaRemoveUnsupportedFunctions",
          "new_api": null,
          "old_text": "luaRemoveUnsupportedFunctions(lua)",
          "new_text": null,
          "old_line_content": "    luaRemoveUnsupportedFunctions(lua);",
          "new_line_content": "     * This is useful for replication, as we need to replicate EVALSHA",
          "content_same": false
        },
        {
          "line": 1056,
          "old_api": "sdsfree",
          "new_api": null,
          "old_text": "sdsfree(sha)",
          "new_text": null,
          "old_line_content": "        sdsfree(sha);",
          "new_line_content": "        if (server.lua_caller == NULL) {",
          "content_same": false
        },
        {
          "line": 1058,
          "old_api": "strcasecmp",
          "new_api": null,
          "old_text": "strcasecmp(c->argv[1]->ptr,\"kill\")",
          "new_text": null,
          "old_line_content": "    } else if (c->argc == 2 && !strcasecmp(c->argv[1]->ptr,\"kill\")) {",
          "new_line_content": "        } else if (server.lua_write_dirty) {",
          "content_same": false
        },
        {
          "line": 1060,
          "old_api": "sdsnew",
          "new_api": null,
          "old_text": "sdsnew(\"-NOTBUSY No scripts in execution right now.\\r\\n\")",
          "new_text": null,
          "old_line_content": "            addReplySds(c,sdsnew(\"-NOTBUSY No scripts in execution right now.\\r\\n\"));",
          "new_line_content": "        } else {",
          "content_same": false
        },
        {
          "line": 552,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"call\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"call\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 553,
          "old_api": "lua_pushcfunction",
          "new_api": null,
          "old_text": "lua_pushcfunction(lua,luaRedisCallCommand)",
          "new_text": null,
          "old_line_content": "    lua_pushcfunction(lua,luaRedisCallCommand);",
          "new_line_content": "    /* redis.pcall */",
          "content_same": false
        },
        {
          "line": 1068,
          "old_api": "addReplyError",
          "new_api": null,
          "old_text": "addReplyError(c, \"Unknown SCRIPT subcommand or wrong # of args.\")",
          "new_text": null,
          "old_line_content": "        addReplyError(c, \"Unknown SCRIPT subcommand or wrong # of args.\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 557,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"pcall\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"pcall\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 558,
          "old_api": "lua_pushcfunction",
          "new_api": null,
          "old_text": "lua_pushcfunction(lua,luaRedisPCallCommand)",
          "new_text": null,
          "old_line_content": "    lua_pushcfunction(lua,luaRedisPCallCommand);",
          "new_line_content": "    /* redis.log and log levels. */",
          "content_same": false
        },
        {
          "line": 562,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"log\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"log\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 566,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"LOG_DEBUG\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"LOG_DEBUG\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 570,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"LOG_VERBOSE\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"LOG_VERBOSE\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 574,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"LOG_NOTICE\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"LOG_NOTICE\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 578,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"LOG_WARNING\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"LOG_WARNING\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 579,
          "old_api": "lua_pushnumber",
          "new_api": null,
          "old_text": "lua_pushnumber(lua,REDIS_WARNING)",
          "new_text": null,
          "old_line_content": "    lua_pushnumber(lua,REDIS_WARNING);",
          "new_line_content": "    /* redis.sha1hex */",
          "content_same": false
        },
        {
          "line": 583,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua, \"sha1hex\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua, \"sha1hex\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 584,
          "old_api": "lua_pushcfunction",
          "new_api": null,
          "old_text": "lua_pushcfunction(lua, luaRedisSha1hexCommand)",
          "new_text": null,
          "old_line_content": "    lua_pushcfunction(lua, luaRedisSha1hexCommand);",
          "new_line_content": "    /* redis.error_reply and redis.status_reply */",
          "content_same": false
        },
        {
          "line": 591,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua, \"status_reply\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua, \"status_reply\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 592,
          "old_api": "lua_pushcfunction",
          "new_api": null,
          "old_text": "lua_pushcfunction(lua, luaRedisStatusReplyCommand)",
          "new_text": null,
          "old_line_content": "    lua_pushcfunction(lua, luaRedisStatusReplyCommand);",
          "new_line_content": "    /* Finally set the table as 'redis' global var. */",
          "content_same": false
        },
        {
          "line": 601,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"random\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"random\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 605,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"randomseed\")",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,\"randomseed\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 607,
          "old_api": "lua_settable",
          "new_api": null,
          "old_text": "lua_settable(lua,-3)",
          "new_text": null,
          "old_line_content": "    lua_settable(lua,-3);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 609,
          "old_api": "lua_setglobal",
          "new_api": null,
          "old_text": "lua_setglobal(lua,\"math\")",
          "new_text": null,
          "old_line_content": "    lua_setglobal(lua,\"math\");",
          "new_line_content": "     * deterministic commands, when containing 'false' elements. */",
          "content_same": false
        },
        {
          "line": 619,
          "old_api": "strlen",
          "new_api": null,
          "old_text": "strlen(compare_func)",
          "new_text": null,
          "old_line_content": "        luaL_loadbuffer(lua,compare_func,strlen(compare_func),\"@cmp_func_def\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 620,
          "old_api": "lua_pcall",
          "new_api": null,
          "old_text": "lua_pcall(lua,0,0,0)",
          "new_text": null,
          "old_line_content": "        lua_pcall(lua,0,0,0);",
          "new_line_content": "    /* Add a helper function we use for pcall error reporting.",
          "content_same": false
        },
        {
          "line": 639,
          "old_api": "strlen",
          "new_api": null,
          "old_text": "strlen(errh_func)",
          "new_text": null,
          "old_line_content": "        luaL_loadbuffer(lua,errh_func,strlen(errh_func),\"@err_handler_def\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 640,
          "old_api": "lua_pcall",
          "new_api": null,
          "old_text": "lua_pcall(lua,0,0,0)",
          "new_text": null,
          "old_line_content": "        lua_pcall(lua,0,0,0);",
          "new_line_content": "    /* Create the (non connected) client that we use to execute Redis commands",
          "content_same": false
        },
        {
          "line": 648,
          "old_api": "createClient",
          "new_api": null,
          "old_text": "createClient(-1)",
          "new_text": null,
          "old_line_content": "        server.lua_client = createClient(-1);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 655,
          "old_api": "scriptingEnableGlobalsProtection",
          "new_api": null,
          "old_text": "scriptingEnableGlobalsProtection(lua)",
          "new_text": null,
          "old_line_content": "    scriptingEnableGlobalsProtection(lua);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 663,
          "old_api": "dictRelease",
          "new_api": null,
          "old_text": "dictRelease(server.lua_scripts)",
          "new_text": null,
          "old_line_content": "    dictRelease(server.lua_scripts);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 664,
          "old_api": "lua_close",
          "new_api": null,
          "old_text": "lua_close(server.lua)",
          "new_text": null,
          "old_line_content": "    lua_close(server.lua);",
          "new_line_content": "void scriptingReset(void) {",
          "content_same": false
        },
        {
          "line": 668,
          "old_api": "scriptingRelease",
          "new_api": null,
          "old_text": "scriptingRelease()",
          "new_text": null,
          "old_line_content": "    scriptingRelease();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 669,
          "old_api": "scriptingInit",
          "new_api": null,
          "old_text": "scriptingInit()",
          "new_text": null,
          "old_line_content": "    scriptingInit();",
          "new_line_content": "/* Perform the SHA1 of the input string. We use this both for hashing script",
          "content_same": false
        },
        {
          "line": 684,
          "old_api": "SHA1Init",
          "new_api": null,
          "old_text": "SHA1Init(&ctx)",
          "new_text": null,
          "old_line_content": "    SHA1Init(&ctx);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 685,
          "old_api": "SHA1Update",
          "new_api": null,
          "old_text": "SHA1Update(&ctx,(unsigned char*)script,len)",
          "new_text": null,
          "old_line_content": "    SHA1Update(&ctx,(unsigned char*)script,len);",
          "new_line_content": "    for (j = 0; j < 20; j++) {",
          "content_same": false
        },
        {
          "line": 686,
          "old_api": "SHA1Final",
          "new_api": null,
          "old_text": "SHA1Final(hash,&ctx)",
          "new_text": null,
          "old_line_content": "    SHA1Final(hash,&ctx);",
          "new_line_content": "        digest[j*2] = cset[((hash[j]&0xF0)>>4)];",
          "content_same": false
        },
        {
          "line": 696,
          "old_api": "lua_type",
          "new_api": null,
          "old_text": "lua_type(lua,-1)",
          "new_text": null,
          "old_line_content": "    int t = lua_type(lua,-1);",
          "new_line_content": "    case LUA_TSTRING:",
          "content_same": false
        },
        {
          "line": 706,
          "old_api": "lua_tonumber",
          "new_api": null,
          "old_text": "lua_tonumber(lua,-1)",
          "new_text": null,
          "old_line_content": "        addReplyLongLong(c,(long long)lua_tonumber(lua,-1));",
          "new_line_content": "        /* We need to check if it is an array, an error, or a status reply.",
          "content_same": false
        },
        {
          "line": 712,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"err\")",
          "new_text": null,
          "old_line_content": "        lua_pushstring(lua,\"err\");",
          "new_line_content": "        if (t == LUA_TSTRING) {",
          "content_same": false
        },
        {
          "line": 718,
          "old_api": "sdsempty",
          "new_api": null,
          "old_text": "sdsempty()",
          "new_text": null,
          "old_line_content": "            addReplySds(c,sdscatprintf(sdsempty(),\"-%s\\r\\n\",err));",
          "new_line_content": "            return;",
          "content_same": false
        },
        {
          "line": 719,
          "old_api": "sdsfree",
          "new_api": null,
          "old_text": "sdsfree(err)",
          "new_text": null,
          "old_line_content": "            sdsfree(err);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 720,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,2)",
          "new_text": null,
          "old_line_content": "            lua_pop(lua,2);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 725,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"ok\")",
          "new_text": null,
          "old_line_content": "        lua_pushstring(lua,\"ok\");",
          "new_line_content": "        if (t == LUA_TSTRING) {",
          "content_same": false
        },
        {
          "line": 731,
          "old_api": "sdsempty",
          "new_api": null,
          "old_text": "sdsempty()",
          "new_text": null,
          "old_line_content": "            addReplySds(c,sdscatprintf(sdsempty(),\"+%s\\r\\n\",ok));",
          "new_line_content": "        } else {",
          "content_same": false
        },
        {
          "line": 733,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "            lua_pop(lua,1);",
          "new_line_content": "            int j = 1, mbulklen = 0;",
          "content_same": false
        },
        {
          "line": 740,
          "old_api": "lua_pushnumber",
          "new_api": null,
          "old_text": "lua_pushnumber(lua,j++)",
          "new_text": null,
          "old_line_content": "                lua_pushnumber(lua,j++);",
          "new_line_content": "                if (t == LUA_TNIL) {",
          "content_same": false
        },
        {
          "line": 742,
          "old_api": "lua_type",
          "new_api": null,
          "old_text": "lua_type(lua,-1)",
          "new_text": null,
          "old_line_content": "                t = lua_type(lua,-1);",
          "new_line_content": "                    break;",
          "content_same": false
        },
        {
          "line": 750,
          "old_api": "setDeferredMultiBulkLength",
          "new_api": null,
          "old_text": "setDeferredMultiBulkLength(c,replylen,mbulklen)",
          "new_text": null,
          "old_line_content": "            setDeferredMultiBulkLength(c,replylen,mbulklen);",
          "new_line_content": "    default:",
          "content_same": false
        },
        {
          "line": 754,
          "old_api": "addReply",
          "new_api": null,
          "old_text": "addReply(c,shared.nullbulk)",
          "new_text": null,
          "old_line_content": "        addReply(c,shared.nullbulk);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 756,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "    lua_pop(lua,1);",
          "new_line_content": "/* Set an array of Redis String Objects as a Lua array (table) stored into a",
          "content_same": false
        },
        {
          "line": 767,
          "old_api": "lua_rawseti",
          "new_api": null,
          "old_text": "lua_rawseti(lua,-2,j+1)",
          "new_text": null,
          "old_line_content": "        lua_rawseti(lua,-2,j+1);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 769,
          "old_api": "lua_setglobal",
          "new_api": null,
          "old_text": "lua_setglobal(lua,var)",
          "new_text": null,
          "old_line_content": "    lua_setglobal(lua,var);",
          "new_line_content": "/* Define a lua function with the specified function name and body.",
          "content_same": false
        },
        {
          "line": 786,
          "old_api": "sdscatlen",
          "new_api": null,
          "old_text": "sdscatlen(funcdef,\"() \",3)",
          "new_text": null,
          "old_line_content": "    funcdef = sdscatlen(funcdef,\"() \",3);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 792,
          "old_api": "lua_tostring",
          "new_api": null,
          "old_text": "lua_tostring(lua,-1)",
          "new_text": null,
          "old_line_content": "            lua_tostring(lua,-1));",
          "new_line_content": "        return REDIS_ERR;",
          "content_same": false
        },
        {
          "line": 793,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "        lua_pop(lua,1);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 799,
          "old_api": "addReplyErrorFormat",
          "new_api": null,
          "old_text": "addReplyErrorFormat(c,\"Error running script (new function): %s\\n\",\n            lua_tostring(lua,-1))",
          "new_text": null,
          "old_line_content": "        addReplyErrorFormat(c,\"Error running script (new function): %s\\n\",",
          "new_line_content": "        return REDIS_ERR;",
          "content_same": false
        },
        {
          "line": 800,
          "old_api": "lua_tostring",
          "new_api": null,
          "old_text": "lua_tostring(lua,-1)",
          "new_text": null,
          "old_line_content": "            lua_tostring(lua,-1));",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 801,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "        lua_pop(lua,1);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 810,
          "old_api": "sdsnewlen",
          "new_api": null,
          "old_text": "sdsnewlen(funcname+2,40)",
          "new_text": null,
          "old_line_content": "                             sdsnewlen(funcname+2,40),body);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 811,
          "old_api": "redisAssertWithInfo",
          "new_api": null,
          "old_text": "redisAssertWithInfo(c,NULL,retval == DICT_OK)",
          "new_text": null,
          "old_line_content": "        redisAssertWithInfo(c,NULL,retval == DICT_OK);",
          "new_line_content": "    return REDIS_OK;",
          "content_same": false
        },
        {
          "line": 812,
          "old_api": "incrRefCount",
          "new_api": null,
          "old_text": "incrRefCount(body)",
          "new_text": null,
          "old_line_content": "        incrRefCount(body);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 825,
          "old_api": "redisSrand48",
          "new_api": null,
          "old_text": "redisSrand48(0)",
          "new_text": null,
          "old_line_content": "    redisSrand48(0);",
          "new_line_content": "     * was called. This way we can allow the user to call commands like",
          "content_same": false
        },
        {
          "line": 317,
          "old_api": "sdslen",
          "new_api": null,
          "old_text": "sdslen(o->ptr)",
          "new_text": null,
          "old_line_content": "        reply = sdscatlen(reply,o->ptr,sdslen(o->ptr));",
          "new_line_content": "    if (raise_error && reply[0] != '-') raise_error = 0;",
          "content_same": false
        },
        {
          "line": 321,
          "old_api": "redisProtocolToLuaType",
          "new_api": null,
          "old_text": "redisProtocolToLuaType(lua,reply)",
          "new_text": null,
          "old_line_content": "    redisProtocolToLuaType(lua,reply);",
          "new_line_content": "    if ((cmd->flags & REDIS_CMD_SORT_FOR_SCRIPT) &&",
          "content_same": false
        },
        {
          "line": 326,
          "old_api": "luaSortArray",
          "new_api": null,
          "old_text": "luaSortArray(lua)",
          "new_text": null,
          "old_line_content": "            luaSortArray(lua);",
          "new_line_content": "    c->reply_bytes = 0;",
          "content_same": false
        },
        {
          "line": 328,
          "old_api": "sdsfree",
          "new_api": null,
          "old_text": "sdsfree(reply)",
          "new_text": null,
          "old_line_content": "    sdsfree(reply);",
          "new_line_content": "cleanup:",
          "content_same": false
        },
        {
          "line": 842,
          "old_api": "addReplyError",
          "new_api": null,
          "old_text": "addReplyError(c,\"Number of keys can't be greater than number of args\")",
          "new_text": null,
          "old_line_content": "        addReplyError(c,\"Number of keys can't be greater than number of args\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 335,
          "old_api": "decrRefCount",
          "new_api": null,
          "old_text": "decrRefCount(c->argv[j])",
          "new_text": null,
          "old_line_content": "        decrRefCount(c->argv[j]);",
          "new_line_content": "    if (raise_error) {",
          "content_same": false
        },
        {
          "line": 336,
          "old_api": "zfree",
          "new_api": null,
          "old_text": "zfree(c->argv)",
          "new_text": null,
          "old_line_content": "    zfree(c->argv);",
          "new_line_content": "        /* If we are here we should have an error in the stack, in the",
          "content_same": false
        },
        {
          "line": 852,
          "old_api": "sdslen",
          "new_api": null,
          "old_text": "sdslen(c->argv[1]->ptr)",
          "new_text": null,
          "old_line_content": "        sha1hex(funcname+2,c->argv[1]->ptr,sdslen(c->argv[1]->ptr));",
          "new_line_content": "        int j;",
          "content_same": false
        },
        {
          "line": 342,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"err\")",
          "new_text": null,
          "old_line_content": "        lua_pushstring(lua,\"err\");",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 343,
          "old_api": "lua_gettable",
          "new_api": null,
          "old_text": "lua_gettable(lua,-2)",
          "new_text": null,
          "old_line_content": "        lua_gettable(lua,-2);",
          "new_line_content": "    return 1;",
          "content_same": false
        },
        {
          "line": 344,
          "old_api": "lua_error",
          "new_api": null,
          "old_text": "lua_error(lua)",
          "new_text": null,
          "old_line_content": "        return lua_error(lua);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 859,
          "old_api": "tolower",
          "new_api": null,
          "old_text": "tolower(sha[j])",
          "new_text": null,
          "old_line_content": "            funcname[j+2] = tolower(sha[j]);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 350,
          "old_api": "luaRedisGenericCommand",
          "new_api": null,
          "old_text": "luaRedisGenericCommand(lua,1)",
          "new_text": null,
          "old_line_content": "    return luaRedisGenericCommand(lua,1);",
          "new_line_content": "int luaRedisPCallCommand(lua_State *lua) {",
          "content_same": false
        },
        {
          "line": 354,
          "old_api": "luaRedisGenericCommand",
          "new_api": null,
          "old_text": "luaRedisGenericCommand(lua,0)",
          "new_text": null,
          "old_line_content": "    return luaRedisGenericCommand(lua,0);",
          "new_line_content": "/* This adds redis.sha1hex(string) to Lua scripts using the same hashing",
          "content_same": false
        },
        {
          "line": 867,
          "old_api": "lua_getglobal",
          "new_api": null,
          "old_text": "lua_getglobal(lua, funcname)",
          "new_text": null,
          "old_line_content": "    lua_getglobal(lua, funcname);",
          "new_line_content": "        /* Function not defined... let's define it if we have the",
          "content_same": false
        },
        {
          "line": 868,
          "old_api": "lua_isnil",
          "new_api": null,
          "old_text": "lua_isnil(lua,-1)",
          "new_text": null,
          "old_line_content": "    if (lua_isnil(lua,-1)) {",
          "new_line_content": "         * body of the function. If this is an EVALSHA call we can just",
          "content_same": false
        },
        {
          "line": 869,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "        lua_pop(lua,1); /* remove the nil from the stack */",
          "new_line_content": "         * return an error. */",
          "content_same": false
        },
        {
          "line": 360,
          "old_api": "lua_gettop",
          "new_api": null,
          "old_text": "lua_gettop(lua)",
          "new_text": null,
          "old_line_content": "    int argc = lua_gettop(lua);",
          "new_line_content": "    char *s;",
          "content_same": false
        },
        {
          "line": 874,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "            lua_pop(lua,1); /* remove the error handler from the stack. */",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 366,
          "old_api": "luaPushError",
          "new_api": null,
          "old_text": "luaPushError(lua, \"wrong number of arguments\")",
          "new_text": null,
          "old_line_content": "        luaPushError(lua, \"wrong number of arguments\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 878,
          "old_api": "luaCreateFunction",
          "new_api": null,
          "old_text": "luaCreateFunction(c,lua,funcname,c->argv[1])",
          "new_text": null,
          "old_line_content": "        if (luaCreateFunction(c,lua,funcname,c->argv[1]) == REDIS_ERR) {",
          "new_line_content": "             * itself when it returns REDIS_ERR. */",
          "content_same": false
        },
        {
          "line": 879,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "            lua_pop(lua,1); /* remove the error handler from the stack. */",
          "new_line_content": "            return;",
          "content_same": false
        },
        {
          "line": 370,
          "old_api": "lua_tolstring",
          "new_api": null,
          "old_text": "lua_tolstring(lua,1,&len)",
          "new_text": null,
          "old_line_content": "    s = (char*)lua_tolstring(lua,1,&len);",
          "new_line_content": "    return 1;",
          "content_same": false
        },
        {
          "line": 371,
          "old_api": "sha1hex",
          "new_api": null,
          "old_text": "sha1hex(digest,s,len)",
          "new_text": null,
          "old_line_content": "    sha1hex(digest,s,len);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 372,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,digest)",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua,digest);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 885,
          "old_api": "lua_getglobal",
          "new_api": null,
          "old_text": "lua_getglobal(lua, funcname)",
          "new_text": null,
          "old_line_content": "        lua_getglobal(lua, funcname);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 886,
          "old_api": "lua_isnil",
          "new_api": null,
          "old_text": "lua_isnil(lua,-1)",
          "new_text": null,
          "old_line_content": "        redisAssert(!lua_isnil(lua,-1));",
          "new_line_content": "    /* Populate the argv and keys table accordingly to the arguments that",
          "content_same": false
        },
        {
          "line": 891,
          "old_api": "luaSetGlobalArray",
          "new_api": null,
          "old_text": "luaSetGlobalArray(lua,\"KEYS\",c->argv+3,numkeys)",
          "new_text": null,
          "old_line_content": "    luaSetGlobalArray(lua,\"KEYS\",c->argv+3,numkeys);",
          "new_line_content": "    /* Select the right DB in the context of the Lua client */",
          "content_same": false
        },
        {
          "line": 895,
          "old_api": "selectDb",
          "new_api": null,
          "old_text": "selectDb(server.lua_client,c->db->id)",
          "new_text": null,
          "old_line_content": "    selectDb(server.lua_client,c->db->id);",
          "new_line_content": "     * is running for too much time.",
          "content_same": false
        },
        {
          "line": 384,
          "old_api": "lua_type",
          "new_api": null,
          "old_text": "lua_type(lua,-1)",
          "new_text": null,
          "old_line_content": "    if (lua_gettop(lua) != 1 || lua_type(lua,-1) != LUA_TSTRING) {",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 385,
          "old_api": "luaPushError",
          "new_api": null,
          "old_text": "luaPushError(lua, \"wrong number or type of arguments\")",
          "new_text": null,
          "old_line_content": "        luaPushError(lua, \"wrong number or type of arguments\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 390,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua, field)",
          "new_text": null,
          "old_line_content": "    lua_pushstring(lua, field);",
          "new_line_content": "    return 1;",
          "content_same": false
        },
        {
          "line": 391,
          "old_api": "lua_pushvalue",
          "new_api": null,
          "old_text": "lua_pushvalue(lua, -3)",
          "new_text": null,
          "old_line_content": "    lua_pushvalue(lua, -3);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 392,
          "old_api": "lua_settable",
          "new_api": null,
          "old_text": "lua_settable(lua, -3)",
          "new_text": null,
          "old_line_content": "    lua_settable(lua, -3);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 905,
          "old_api": "lua_sethook",
          "new_api": null,
          "old_text": "lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000)",
          "new_text": null,
          "old_line_content": "        lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 397,
          "old_api": "luaRedisReturnSingleFieldTable",
          "new_api": null,
          "old_text": "luaRedisReturnSingleFieldTable(lua,\"err\")",
          "new_text": null,
          "old_line_content": "    return luaRedisReturnSingleFieldTable(lua,\"err\");",
          "new_line_content": "int luaRedisStatusReplyCommand(lua_State *lua) {",
          "content_same": false
        },
        {
          "line": 401,
          "old_api": "luaRedisReturnSingleFieldTable",
          "new_api": null,
          "old_text": "luaRedisReturnSingleFieldTable(lua,\"ok\")",
          "new_text": null,
          "old_line_content": "    return luaRedisReturnSingleFieldTable(lua,\"ok\");",
          "new_line_content": "int luaLogCommand(lua_State *lua) {",
          "content_same": false
        },
        {
          "line": 915,
          "old_api": "lua_sethook",
          "new_api": null,
          "old_text": "lua_sethook(lua,luaMaskCountHook,0,0)",
          "new_text": null,
          "old_line_content": "    if (delhook) lua_sethook(lua,luaMaskCountHook,0,0); /* Disable hook */",
          "new_line_content": "        /* Restore the readable handler that was unregistered when the",
          "content_same": false
        },
        {
          "line": 405,
          "old_api": "lua_gettop",
          "new_api": null,
          "old_text": "lua_gettop(lua)",
          "new_text": null,
          "old_line_content": "    int j, argc = lua_gettop(lua);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 920,
          "old_api": "aeCreateFileEvent",
          "new_api": null,
          "old_text": "aeCreateFileEvent(server.el,c->fd,AE_READABLE,\n                          readQueryFromClient,c)",
          "new_text": null,
          "old_line_content": "        aeCreateFileEvent(server.el,c->fd,AE_READABLE,",
          "new_line_content": "    server.lua_caller = NULL;",
          "content_same": false
        },
        {
          "line": 412,
          "old_api": "lua_isnumber",
          "new_api": null,
          "old_text": "lua_isnumber(lua,-argc)",
          "new_text": null,
          "old_line_content": "    } else if (!lua_isnumber(lua,-argc)) {",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 924,
          "old_api": "selectDb",
          "new_api": null,
          "old_text": "selectDb(c,server.lua_client->db->id)",
          "new_text": null,
          "old_line_content": "    selectDb(c,server.lua_client->db->id); /* set DB ID from Lua client */",
          "new_line_content": "    if (err) {",
          "content_same": false
        },
        {
          "line": 416,
          "old_api": "lua_tonumber",
          "new_api": null,
          "old_text": "lua_tonumber(lua,-argc)",
          "new_text": null,
          "old_line_content": "    level = lua_tonumber(lua,-argc);",
          "new_line_content": "        return 1;",
          "content_same": false
        },
        {
          "line": 928,
          "old_api": "addReplyErrorFormat",
          "new_api": null,
          "old_text": "addReplyErrorFormat(c,\"Error running script (call to %s): %s\\n\",\n            funcname, lua_tostring(lua,-1))",
          "new_text": null,
          "old_line_content": "        addReplyErrorFormat(c,\"Error running script (call to %s): %s\\n\",",
          "new_line_content": "    } else {",
          "content_same": false
        },
        {
          "line": 418,
          "old_api": "luaPushError",
          "new_api": null,
          "old_text": "luaPushError(lua, \"Invalid debug level.\")",
          "new_text": null,
          "old_line_content": "        luaPushError(lua, \"Invalid debug level.\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 929,
          "old_api": "lua_tostring",
          "new_api": null,
          "old_text": "lua_tostring(lua,-1)",
          "new_text": null,
          "old_line_content": "            funcname, lua_tostring(lua,-1));",
          "new_line_content": "        /* On success convert the Lua return value into Redis protocol, and",
          "content_same": false
        },
        {
          "line": 930,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,2)",
          "new_text": null,
          "old_line_content": "        lua_pop(lua,2); /* Consume the Lua reply and remove error handler. */",
          "new_line_content": "         * send it to * the client. */",
          "content_same": false
        },
        {
          "line": 934,
          "old_api": "luaReplyToRedisReply",
          "new_api": null,
          "old_text": "luaReplyToRedisReply(c,lua)",
          "new_text": null,
          "old_line_content": "        luaReplyToRedisReply(c,lua); /* Convert and consume the reply. */",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 423,
          "old_api": "sdsempty",
          "new_api": null,
          "old_text": "sdsempty()",
          "new_text": null,
          "old_line_content": "    log = sdsempty();",
          "new_line_content": "        char *s;",
          "content_same": false
        },
        {
          "line": 935,
          "old_api": "lua_pop",
          "new_api": null,
          "old_text": "lua_pop(lua,1)",
          "new_text": null,
          "old_line_content": "        lua_pop(lua,1); /* Remove the error handler. */",
          "new_line_content": "    /* EVALSHA should be propagated to Slave and AOF file as full EVAL, unless",
          "content_same": false
        },
        {
          "line": 430,
          "old_api": "sdscatlen",
          "new_api": null,
          "old_text": "sdscatlen(log,\" \",1)",
          "new_text": null,
          "old_line_content": "            if (j != 1) log = sdscatlen(log,\" \",1);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 434,
          "old_api": "redisLogRaw",
          "new_api": null,
          "old_text": "redisLogRaw(level,log)",
          "new_text": null,
          "old_line_content": "    redisLogRaw(level,log);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 435,
          "old_api": "sdsfree",
          "new_api": null,
          "old_text": "sdsfree(log)",
          "new_text": null,
          "old_line_content": "    sdsfree(log);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 949,
          "old_api": "replicationScriptCacheExists",
          "new_api": null,
          "old_text": "replicationScriptCacheExists(c->argv[1]->ptr)",
          "new_text": null,
          "old_line_content": "        if (!replicationScriptCacheExists(c->argv[1]->ptr)) {",
          "new_line_content": "             * slaves and AOF know about it. */",
          "content_same": false
        },
        {
          "line": 442,
          "old_api": "REDIS_NOTUSED",
          "new_api": null,
          "old_text": "REDIS_NOTUSED(lua)",
          "new_text": null,
          "old_line_content": "    REDIS_NOTUSED(lua);",
          "new_line_content": "    if (elapsed >= server.lua_time_limit && server.lua_timedout == 0) {",
          "content_same": false
        },
        {
          "line": 444,
          "old_api": "mstime",
          "new_api": null,
          "old_text": "mstime()",
          "new_text": null,
          "old_line_content": "    elapsed = mstime() - server.lua_time_start;",
          "new_line_content": "        server.lua_timedout = 1;",
          "content_same": false
        },
        {
          "line": 446,
          "old_api": "redisLog",
          "new_api": null,
          "old_text": "redisLog(REDIS_WARNING,\"Lua slow script detected: still in execution after %lld milliseconds. You can try killing the script using the SCRIPT KILL command.\",elapsed)",
          "new_text": null,
          "old_line_content": "        redisLog(REDIS_WARNING,\"Lua slow script detected: still in execution after %lld milliseconds. You can try killing the script using the SCRIPT KILL command.\",elapsed);",
          "new_line_content": "         * to call SCRIPT KILL or SHUTDOWN NOSAVE if needed. For this reason",
          "content_same": false
        },
        {
          "line": 958,
          "old_api": "createStringObject",
          "new_api": null,
          "old_text": "createStringObject(\"EVAL\",4)",
          "new_text": null,
          "old_line_content": "                resetRefCount(createStringObject(\"EVAL\",4)));",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 959,
          "old_api": "rewriteClientCommandArgument",
          "new_api": null,
          "old_text": "rewriteClientCommandArgument(c,1,script)",
          "new_text": null,
          "old_line_content": "            rewriteClientCommandArgument(c,1,script);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 960,
          "old_api": "forceCommandPropagation",
          "new_api": null,
          "old_text": "forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF)",
          "new_text": null,
          "old_line_content": "            forceCommandPropagation(c,REDIS_PROPAGATE_REPL|REDIS_PROPAGATE_AOF);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 453,
          "old_api": "aeDeleteFileEvent",
          "new_api": null,
          "old_text": "aeDeleteFileEvent(server.el, server.lua_caller->fd, AE_READABLE)",
          "new_text": null,
          "old_line_content": "         aeDeleteFileEvent(server.el, server.lua_caller->fd, AE_READABLE);",
          "new_line_content": "    if (server.lua_kill) {",
          "content_same": false
        },
        {
          "line": 966,
          "old_api": "evalGenericCommand",
          "new_api": null,
          "old_text": "evalGenericCommand(c,0)",
          "new_text": null,
          "old_line_content": "    evalGenericCommand(c,0);",
          "new_line_content": "void evalShaCommand(redisClient *c) {",
          "content_same": false
        },
        {
          "line": 457,
          "old_api": "redisLog",
          "new_api": null,
          "old_text": "redisLog(REDIS_WARNING,\"Lua script killed by user with SCRIPT KILL.\")",
          "new_text": null,
          "old_line_content": "        redisLog(REDIS_WARNING,\"Lua script killed by user with SCRIPT KILL.\");",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 458,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua,\"Script killed by user with SCRIPT KILL...\")",
          "new_text": null,
          "old_line_content": "        lua_pushstring(lua,\"Script killed by user with SCRIPT KILL...\");",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 459,
          "old_api": "lua_error",
          "new_api": null,
          "old_text": "lua_error(lua)",
          "new_text": null,
          "old_line_content": "        lua_error(lua);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 970,
          "old_api": "sdslen",
          "new_api": null,
          "old_text": "sdslen(c->argv[1]->ptr)",
          "new_text": null,
          "old_line_content": "    if (sdslen(c->argv[1]->ptr) != 40) {",
          "new_line_content": "         * evalGenericCommand() can be implemented without string length",
          "content_same": false
        },
        {
          "line": 464,
          "old_api": "lua_pushcfunction",
          "new_api": null,
          "old_text": "lua_pushcfunction(lua, luafunc)",
          "new_text": null,
          "old_line_content": "  lua_pushcfunction(lua, luafunc);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 465,
          "old_api": "lua_pushstring",
          "new_api": null,
          "old_text": "lua_pushstring(lua, libname)",
          "new_text": null,
          "old_line_content": "  lua_pushstring(lua, libname);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 466,
          "old_api": "lua_call",
          "new_api": null,
          "old_text": "lua_call(lua, 1, 0)",
          "new_text": null,
          "old_line_content": "  lua_call(lua, 1, 0);",
          "new_line_content": "LUALIB_API int (luaopen_cjson) (lua_State *L);",
          "content_same": false
        },
        {
          "line": 978,
          "old_api": "evalGenericCommand",
          "new_api": null,
          "old_text": "evalGenericCommand(c,1)",
          "new_text": null,
          "old_line_content": "    evalGenericCommand(c,1);",
          "new_line_content": "/* We replace math.random() with our implementation that is not affected",
          "content_same": false
        },
        {
          "line": 990,
          "old_api": "redisLrand48",
          "new_api": null,
          "old_text": "redisLrand48()",
          "new_text": null,
          "old_line_content": "  lua_Number r = (lua_Number)(redisLrand48()%REDIS_LRAND48_MAX) /",
          "new_line_content": "    case 0: {  /* no arguments */",
          "content_same": false
        },
        {
          "line": 479,
          "old_api": "luaLoadLib",
          "new_api": null,
          "old_text": "luaLoadLib(lua, \"cjson\", luaopen_cjson)",
          "new_text": null,
          "old_line_content": "    luaLoadLib(lua, \"cjson\", luaopen_cjson);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 480,
          "old_api": "luaLoadLib",
          "new_api": null,
          "old_text": "luaLoadLib(lua, \"struct\", luaopen_struct)",
          "new_text": null,
          "old_line_content": "    luaLoadLib(lua, \"struct\", luaopen_struct);",
          "new_line_content": "#if 0 /* Stuff that we don't load currently, for sandboxing concerns. */",
          "content_same": false
        },
        {
          "line": 992,
          "old_api": "lua_gettop",
          "new_api": null,
          "old_text": "lua_gettop(L)",
          "new_text": null,
          "old_line_content": "  switch (lua_gettop(L)) {  /* check number of arguments */",
          "new_line_content": "      break;",
          "content_same": false
        },
        {
          "line": 994,
          "old_api": "lua_pushnumber",
          "new_api": null,
          "old_text": "lua_pushnumber(L, r)",
          "new_text": null,
          "old_line_content": "      lua_pushnumber(L, r);  /* Number between 0 and 1 */",
          "new_line_content": "    case 1: {  /* only upper limit */",
          "content_same": false
        },
        {
          "line": 484,
          "old_api": "luaLoadLib",
          "new_api": null,
          "old_text": "luaLoadLib(lua, LUA_LOADLIBNAME, luaopen_package)",
          "new_text": null,
          "old_line_content": "    luaLoadLib(lua, LUA_LOADLIBNAME, luaopen_package);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 485,
          "old_api": "luaLoadLib",
          "new_api": null,
          "old_text": "luaLoadLib(lua, LUA_OSLIBNAME, luaopen_os)",
          "new_text": null,
          "old_line_content": "    luaLoadLib(lua, LUA_OSLIBNAME, luaopen_os);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 998,
          "old_api": "luaL_checkint",
          "new_api": null,
          "old_text": "luaL_checkint(L, 1)",
          "new_text": null,
          "old_line_content": "      int u = luaL_checkint(L, 1);",
          "new_line_content": "      break;",
          "content_same": false
        },
        {
          "line": 999,
          "old_api": "luaL_argcheck",
          "new_api": null,
          "old_text": "luaL_argcheck(L, 1<=u, 1, \"interval is empty\")",
          "new_text": null,
          "old_line_content": "      luaL_argcheck(L, 1<=u, 1, \"interval is empty\");",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 1000,
          "old_api": "floor",
          "new_api": null,
          "old_text": "floor(r*u)",
          "new_text": null,
          "old_line_content": "      lua_pushnumber(L, floor(r*u)+1);  /* int between 1 and `u' */",
          "new_line_content": "    case 2: {  /* lower and upper limits */",
          "content_same": false
        },
        {
          "line": 492,
          "old_api": "lua_pushnil",
          "new_api": null,
          "old_text": "lua_pushnil(lua)",
          "new_text": null,
          "old_line_content": "    lua_pushnil(lua);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 493,
          "old_api": "lua_setglobal",
          "new_api": null,
          "old_text": "lua_setglobal(lua,\"loadfile\")",
          "new_text": null,
          "old_line_content": "    lua_setglobal(lua,\"loadfile\");",
          "new_line_content": "/* This function installs metamethods in the global table _G that prevent",
          "content_same": false
        },
        {
          "line": 1005,
          "old_api": "luaL_checkint",
          "new_api": null,
          "old_text": "luaL_checkint(L, 2)",
          "new_text": null,
          "old_line_content": "      int u = luaL_checkint(L, 2);",
          "new_line_content": "      break;",
          "content_same": false
        },
        {
          "line": 1006,
          "old_api": "luaL_argcheck",
          "new_api": null,
          "old_text": "luaL_argcheck(L, l<=u, 2, \"interval is empty\")",
          "new_text": null,
          "old_line_content": "      luaL_argcheck(L, l<=u, 2, \"interval is empty\");",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 1010,
          "old_api": "luaL_error",
          "new_api": null,
          "old_text": "luaL_error(L, \"wrong number of arguments\")",
          "new_text": null,
          "old_line_content": "    default: return luaL_error(L, \"wrong number of arguments\");",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 503,
          "old_api": "sdsempty",
          "new_api": null,
          "old_text": "sdsempty()",
          "new_text": null,
          "old_line_content": "    sds code = sdsempty();",
          "new_line_content": "    /* strict.lua from: http://metalua.luaforge.net/src/lib/strict.lua.html.",
          "content_same": false
        },
        {
          "line": 1016,
          "old_api": "luaL_checkint",
          "new_api": null,
          "old_text": "luaL_checkint(L, 1)",
          "new_text": null,
          "old_line_content": "  redisSrand48(luaL_checkint(L, 1));",
          "new_line_content": "",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 84,
      "total_additions": 160,
      "total_deletions": 161,
      "total_api_changes": 405
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 5,
        "api_related_lines": 405,
        "non_api_lines": 2,
        "non_api_line_numbers": [
          313,
          310
        ]
      }
    },
    "api_calls_before": 361,
    "api_calls_after": 360,
    "diff_info": {
      "added_lines": 2,
      "removed_lines": 5,
      "total_diff_lines": 19
    }
  }
}