{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/2fec7d9c6c630db3bcb13a07a08c39404abad447",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/2fec7d9c6c630db3bcb13a07a08c39404abad447/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/2fec7d9c6c630db3bcb13a07a08c39404abad447/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/redis/modified_file/2fec7d9c6c630db3bcb13a07a08c39404abad447/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 790,
          "old_api": "malloc_mutex_lock",
          "new_api": "malloc_mutex_trylock",
          "old_text": "malloc_mutex_lock(tsdn, &info->mtx)",
          "new_text": "malloc_mutex_trylock(tsdn, &info->mtx)",
          "old_line_content": "\t\tmalloc_mutex_lock(tsdn, &info->mtx);",
          "new_line_content": "\t\tif (malloc_mutex_trylock(tsdn, &info->mtx)) {",
          "content_same": false
        },
        {
          "line": 799,
          "old_api": "nstime_idivide",
          "new_api": "nstime_add",
          "old_text": "nstime_idivide(&stats->run_interval, num_runs)",
          "new_text": "nstime_add(&stats->run_interval, &info->tot_sleep_time)",
          "old_line_content": "\t\tnstime_idivide(&stats->run_interval, num_runs);",
          "new_line_content": "\t\t\tnstime_add(&stats->run_interval, &info->tot_sleep_time);",
          "content_same": false
        },
        {
          "line": 821,
          "old_api": "abort",
          "new_api": "dlsym",
          "old_text": "abort()",
          "new_text": "dlsym(RTLD_NEXT, \"pthread_create\")",
          "old_line_content": "\t\t\tabort();",
          "new_line_content": "\tpthread_create_fptr = dlsym(RTLD_NEXT, \"pthread_create\");",
          "content_same": false
        },
        {
          "line": 856,
          "old_api": "pthread_create_fptr_init",
          "new_api": "malloc_printf",
          "old_text": "pthread_create_fptr_init()",
          "new_text": "malloc_printf(\"<jemalloc>: option background_thread currently \"\n\t\t    \"supports pthread only\\n\")",
          "old_line_content": "\t    pthread_create_fptr_init()) {",
          "new_line_content": "\t\tmalloc_printf(\"<jemalloc>: option background_thread currently \"",
          "content_same": false
        },
        {
          "line": 904,
          "old_api": "malloc_mutex_unlock",
          "new_api": "pthread_cond_init",
          "old_text": "malloc_mutex_unlock(tsdn, &info->mtx)",
          "new_text": "pthread_cond_init(&info->cond, NULL)",
          "old_line_content": "\t\tmalloc_mutex_unlock(tsdn, &info->mtx);",
          "new_line_content": "\t\tif (pthread_cond_init(&info->cond, NULL)) {",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 899,
          "old_api": null,
          "new_api": "malloc_mutex_init",
          "old_text": null,
          "new_text": "malloc_mutex_init(&info->mtx, \"background_thread\",\n\t\t    WITNESS_RANK_BACKGROUND_THREAD,\n\t\t    malloc_mutex_address_ordered)",
          "old_line_content": "\t\t\treturn true;",
          "new_line_content": "\t\tif (malloc_mutex_init(&info->mtx, \"background_thread\",",
          "content_same": false
        },
        {
          "line": 805,
          "old_api": null,
          "new_api": "nstime_idivide",
          "old_text": null,
          "new_text": "nstime_idivide(&stats->run_interval, num_runs)",
          "old_line_content": "",
          "new_line_content": "\t\tnstime_idivide(&stats->run_interval, num_runs);",
          "content_same": false
        },
        {
          "line": 807,
          "old_api": null,
          "new_api": "malloc_mutex_unlock",
          "old_text": null,
          "new_text": "malloc_mutex_unlock(tsdn, &background_thread_lock)",
          "old_line_content": "#undef BILLION",
          "new_line_content": "\tmalloc_mutex_unlock(tsdn, &background_thread_lock);",
          "content_same": false
        },
        {
          "line": 872,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(have_background_thread)",
          "old_line_content": "\t}",
          "new_line_content": "\tassert(have_background_thread);",
          "content_same": false
        },
        {
          "line": 873,
          "old_api": null,
          "new_api": "narenas_total_get",
          "old_text": null,
          "new_text": "narenas_total_get()",
          "old_line_content": "\tmax_background_threads = opt_max_background_threads;",
          "new_line_content": "\tassert(narenas_total_get() > 0);",
          "content_same": false
        },
        {
          "line": 907,
          "old_api": null,
          "new_api": "malloc_mutex_lock",
          "old_text": null,
          "new_text": "malloc_mutex_lock(tsdn, &info->mtx)",
          "old_line_content": "",
          "new_line_content": "\t\tmalloc_mutex_lock(tsdn, &info->mtx);",
          "content_same": false
        },
        {
          "line": 844,
          "old_api": null,
          "new_api": "malloc_mutex_assert_not_owner",
          "old_text": null,
          "new_text": "malloc_mutex_assert_not_owner(tsdn, &background_thread_lock)",
          "old_line_content": "",
          "new_line_content": "\tmalloc_mutex_assert_not_owner(tsdn, &background_thread_lock);",
          "content_same": false
        },
        {
          "line": 909,
          "old_api": null,
          "new_api": "background_thread_info_init",
          "old_text": null,
          "new_text": "background_thread_info_init(tsdn, info)",
          "old_line_content": "}",
          "new_line_content": "\t\tbackground_thread_info_init(tsdn, info);",
          "content_same": false
        },
        {
          "line": 846,
          "old_api": null,
          "new_api": "pthread_create_fptr_init",
          "old_text": null,
          "new_text": "pthread_create_fptr_init()",
          "old_line_content": "",
          "new_line_content": "\tpthread_create_fptr_init();",
          "content_same": false
        },
        {
          "line": 847,
          "old_api": null,
          "new_api": "pthread_create_wrapper_init",
          "old_text": null,
          "new_text": "pthread_create_wrapper_init()",
          "old_line_content": "bool",
          "new_line_content": "\tpthread_create_wrapper_init();",
          "content_same": false
        },
        {
          "line": 910,
          "old_api": null,
          "new_api": "malloc_mutex_unlock",
          "old_text": null,
          "new_text": "malloc_mutex_unlock(tsdn, &info->mtx)",
          "old_line_content": "",
          "new_line_content": "\t\tmalloc_mutex_unlock(tsdn, &info->mtx);",
          "content_same": false
        },
        {
          "line": 881,
          "old_api": null,
          "new_api": "background_thread_enabled_set",
          "old_text": null,
          "new_text": "background_thread_enabled_set(tsdn, opt_background_thread)",
          "old_line_content": "\t}",
          "new_line_content": "\tbackground_thread_enabled_set(tsdn, opt_background_thread);",
          "content_same": false
        },
        {
          "line": 882,
          "old_api": null,
          "new_api": "malloc_mutex_init",
          "old_text": null,
          "new_text": "malloc_mutex_init(&background_thread_lock,\n\t    \"background_thread_global\",\n\t    WITNESS_RANK_BACKGROUND_THREAD_GLOBAL,\n\t    malloc_mutex_rank_exclusive)",
          "old_line_content": "",
          "new_line_content": "\tif (malloc_mutex_init(&background_thread_lock,",
          "content_same": false
        },
        {
          "line": 889,
          "old_api": null,
          "new_api": "base_alloc",
          "old_text": null,
          "new_text": "base_alloc(tsdn,\n\t    b0get(), opt_max_background_threads *\n\t    sizeof(background_thread_info_t), CACHELINE)",
          "old_line_content": "",
          "new_line_content": "\tbackground_thread_info = (background_thread_info_t *)base_alloc(tsdn,",
          "content_same": false
        },
        {
          "line": 825,
          "old_api": null,
          "new_api": "malloc_write",
          "old_text": null,
          "new_text": "malloc_write(\"<jemalloc>: Error in dlsym(RTLD_NEXT, \"\n\t\t\t    \"\\\"pthread_create\\\")\\n\")",
          "old_line_content": "\t}",
          "new_line_content": "\t\t\tmalloc_write(\"<jemalloc>: Error in dlsym(RTLD_NEXT, \"",
          "content_same": false
        },
        {
          "line": 890,
          "old_api": null,
          "new_api": "b0get",
          "old_text": null,
          "new_text": "b0get()",
          "old_line_content": "\tfor (unsigned i = 0; i < max_background_threads; i++) {",
          "new_line_content": "\t    b0get(), opt_max_background_threads *",
          "content_same": false
        },
        {
          "line": 827,
          "old_api": null,
          "new_api": "abort",
          "old_text": null,
          "new_text": "abort()",
          "old_line_content": "\treturn false;",
          "new_line_content": "\t\t\tabort();",
          "content_same": false
        },
        {
          "line": 862,
          "old_api": null,
          "new_api": "pthread_create_fptr_init",
          "old_text": null,
          "new_text": "pthread_create_fptr_init()",
          "old_line_content": "",
          "new_line_content": "\t    pthread_create_fptr_init()) {",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 866,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(have_background_thread)",
          "new_text": null,
          "old_line_content": "\tassert(have_background_thread);",
          "new_line_content": "\treturn false;",
          "content_same": false
        },
        {
          "line": 867,
          "old_api": "narenas_total_get",
          "new_api": null,
          "old_text": "narenas_total_get()",
          "new_text": null,
          "old_line_content": "\tassert(narenas_total_get() > 0);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 898,
          "old_api": "pthread_cond_init",
          "new_api": null,
          "old_text": "pthread_cond_init(&info->cond, NULL)",
          "new_text": null,
          "old_line_content": "\t\tif (pthread_cond_init(&info->cond, NULL)) {",
          "new_line_content": "\t\t/* Thread mutex is rank_inclusive because of thread0. */",
          "content_same": false
        },
        {
          "line": 901,
          "old_api": "malloc_mutex_lock",
          "new_api": null,
          "old_text": "malloc_mutex_lock(tsdn, &info->mtx)",
          "new_text": null,
          "old_line_content": "\t\tmalloc_mutex_lock(tsdn, &info->mtx);",
          "new_line_content": "\t\t    malloc_mutex_address_ordered)) {",
          "content_same": false
        },
        {
          "line": 838,
          "old_api": "malloc_mutex_assert_not_owner",
          "new_api": null,
          "old_text": "malloc_mutex_assert_not_owner(tsdn, &background_thread_lock)",
          "new_text": null,
          "old_line_content": "\tmalloc_mutex_assert_not_owner(tsdn, &background_thread_lock);",
          "new_line_content": " * taking any background_thread locks.  This is called early in ctl (instead of",
          "content_same": false
        },
        {
          "line": 903,
          "old_api": "background_thread_info_init",
          "new_api": null,
          "old_text": "background_thread_info_init(tsdn, info)",
          "new_text": null,
          "old_line_content": "\t\tbackground_thread_info_init(tsdn, info);",
          "new_line_content": "\t\t}",
          "content_same": false
        },
        {
          "line": 840,
          "old_api": "pthread_create_fptr_init",
          "new_api": null,
          "old_text": "pthread_create_fptr_init()",
          "new_text": null,
          "old_line_content": "\tpthread_create_fptr_init();",
          "new_line_content": " * before creating background threads.",
          "content_same": false
        },
        {
          "line": 841,
          "old_api": "pthread_create_wrapper_init",
          "new_api": null,
          "old_text": "pthread_create_wrapper_init()",
          "new_text": null,
          "old_line_content": "\tpthread_create_wrapper_init();",
          "new_line_content": " */",
          "content_same": false
        },
        {
          "line": 875,
          "old_api": "background_thread_enabled_set",
          "new_api": null,
          "old_text": "background_thread_enabled_set(tsdn, opt_background_thread)",
          "new_text": null,
          "old_line_content": "\tbackground_thread_enabled_set(tsdn, opt_background_thread);",
          "new_line_content": "\tif (opt_max_background_threads == MAX_BACKGROUND_THREAD_LIMIT &&",
          "content_same": false
        },
        {
          "line": 876,
          "old_api": "malloc_mutex_init",
          "new_api": null,
          "old_text": "malloc_mutex_init(&background_thread_lock,\n\t    \"background_thread_global\",\n\t    WITNESS_RANK_BACKGROUND_THREAD_GLOBAL,\n\t    malloc_mutex_rank_exclusive)",
          "new_text": null,
          "old_line_content": "\tif (malloc_mutex_init(&background_thread_lock,",
          "new_line_content": "\t    ncpus < MAX_BACKGROUND_THREAD_LIMIT) {",
          "content_same": false
        },
        {
          "line": 815,
          "old_api": "dlsym",
          "new_api": null,
          "old_text": "dlsym(RTLD_NEXT, \"pthread_create\")",
          "new_text": null,
          "old_line_content": "\tpthread_create_fptr = dlsym(RTLD_NEXT, \"pthread_create\");",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 850,
          "old_api": "malloc_printf",
          "new_api": null,
          "old_text": "malloc_printf(\"<jemalloc>: option background_thread currently \"\n\t\t    \"supports pthread only\\n\")",
          "new_text": null,
          "old_line_content": "\t\tmalloc_printf(\"<jemalloc>: option background_thread currently \"",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 819,
          "old_api": "malloc_write",
          "new_api": null,
          "old_text": "malloc_write(\"<jemalloc>: Error in dlsym(RTLD_NEXT, \"\n\t\t\t    \"\\\"pthread_create\\\")\\n\")",
          "new_text": null,
          "old_line_content": "\t\t\tmalloc_write(\"<jemalloc>: Error in dlsym(RTLD_NEXT, \"",
          "new_line_content": "\t\treturn false;",
          "content_same": false
        },
        {
          "line": 883,
          "old_api": "base_alloc",
          "new_api": null,
          "old_text": "base_alloc(tsdn,\n\t    b0get(), opt_max_background_threads *\n\t    sizeof(background_thread_info_t), CACHELINE)",
          "new_text": null,
          "old_line_content": "\tbackground_thread_info = (background_thread_info_t *)base_alloc(tsdn,",
          "new_line_content": "\t    \"background_thread_global\",",
          "content_same": false
        },
        {
          "line": 884,
          "old_api": "b0get",
          "new_api": null,
          "old_text": "b0get()",
          "new_text": null,
          "old_line_content": "\t    b0get(), opt_max_background_threads *",
          "new_line_content": "\t    WITNESS_RANK_BACKGROUND_THREAD_GLOBAL,",
          "content_same": false
        },
        {
          "line": 793,
          "old_api": "nstime_add",
          "new_api": null,
          "old_text": "nstime_add(&stats->run_interval, &info->tot_sleep_time)",
          "new_text": null,
          "old_line_content": "\t\t\tnstime_add(&stats->run_interval, &info->tot_sleep_time);",
          "new_line_content": "\t\t\t * avoid waiting on the stats if the thread is active.",
          "content_same": false
        },
        {
          "line": 795,
          "old_api": "malloc_mutex_unlock",
          "new_api": null,
          "old_text": "malloc_mutex_unlock(tsdn, &info->mtx)",
          "new_text": null,
          "old_line_content": "\t\tmalloc_mutex_unlock(tsdn, &info->mtx);",
          "new_line_content": "\t\t\tcontinue;",
          "content_same": false
        },
        {
          "line": 893,
          "old_api": "malloc_mutex_init",
          "new_api": null,
          "old_text": "malloc_mutex_init(&info->mtx, \"background_thread\",\n\t\t    WITNESS_RANK_BACKGROUND_THREAD,\n\t\t    malloc_mutex_address_ordered)",
          "new_text": null,
          "old_line_content": "\t\tif (malloc_mutex_init(&info->mtx, \"background_thread\",",
          "new_line_content": "\t\treturn true;",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 5,
      "total_additions": 18,
      "total_deletions": 18,
      "total_api_changes": 41
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 7,
        "api_related_lines": 41,
        "non_api_lines": 4,
        "non_api_line_numbers": [
          792,
          794,
          796,
          791
        ]
      }
    },
    "api_calls_before": 245,
    "api_calls_after": 245,
    "diff_info": {
      "added_lines": 7,
      "removed_lines": 1,
      "total_diff_lines": 20
    }
  }
}