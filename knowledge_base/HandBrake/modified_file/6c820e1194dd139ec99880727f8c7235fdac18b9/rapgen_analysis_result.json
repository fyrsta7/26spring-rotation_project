{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/HandBrake/modified_file/6c820e1194dd139ec99880727f8c7235fdac18b9",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/HandBrake/modified_file/6c820e1194dd139ec99880727f8c7235fdac18b9/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/HandBrake/modified_file/6c820e1194dd139ec99880727f8c7235fdac18b9/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/HandBrake/modified_file/6c820e1194dd139ec99880727f8c7235fdac18b9/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 216,
          "old_api": "hb_log",
          "new_api": "x264_encoder_open",
          "old_text": "hb_log( \"encx264: opening libx264 (pass %d)\", job->pass )",
          "new_text": "x264_encoder_open( &param )",
          "old_line_content": "    hb_log( \"encx264: opening libx264 (pass %d)\", job->pass );",
          "new_line_content": "    pv->x264 = x264_encoder_open( &param );",
          "content_same": false
        },
        {
          "line": 243,
          "old_api": "x264_picture_clean",
          "new_api": "x264_encoder_close",
          "old_text": "x264_picture_clean( &pv->pic_in )",
          "new_text": "x264_encoder_close( pv->x264 )",
          "old_line_content": "    x264_picture_clean( &pv->pic_in );",
          "new_line_content": "    x264_encoder_close( pv->x264 );",
          "content_same": false
        },
        {
          "line": 244,
          "old_api": "x264_encoder_close",
          "new_api": "free",
          "old_text": "x264_encoder_close( pv->x264 )",
          "new_text": "free( pv )",
          "old_line_content": "    x264_encoder_close( pv->x264 );",
          "new_line_content": "    free( pv );",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 130,
          "old_api": null,
          "new_api": "strcmp",
          "old_text": null,
          "new_text": "strcmp( name, \"bframes\" )",
          "old_line_content": "",
          "new_line_content": "            if( !( strcmp( name, \"bframes\" ) ) )",
          "content_same": false
        },
        {
          "line": 132,
          "old_api": null,
          "new_api": "atoi",
          "old_text": null,
          "new_text": "atoi( value )",
          "old_line_content": "            {",
          "new_line_content": "                if( atoi( value ) > 0 )",
          "content_same": false
        },
        {
          "line": 264,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy( pv->pic_in.img.plane[0], in->data, job->width * job->height )",
          "old_line_content": "        /* XXX avoid this memcpy ? */",
          "new_line_content": "        memcpy( pv->pic_in.img.plane[0], in->data, job->width * job->height );",
          "content_same": false
        },
        {
          "line": 139,
          "old_api": null,
          "new_api": "strcmp",
          "old_text": null,
          "new_text": "strcmp( name, \"b-pyramid\" )",
          "old_line_content": "            /* Note b-pyramid here, so the initial delay can be doubled */",
          "new_line_content": "            if( !( strcmp( name, \"b-pyramid\" ) ) )",
          "content_same": false
        },
        {
          "line": 268,
          "old_api": null,
          "new_api": "memset",
          "old_text": null,
          "new_text": "memset( pv->pic_in.img.plane[1], 0x80, job->width * job->height / 4 )",
          "old_line_content": "            /* XXX x264 has currently no option for grayscale encoding */",
          "new_line_content": "            memset( pv->pic_in.img.plane[1], 0x80, job->width * job->height / 4 );",
          "content_same": false
        },
        {
          "line": 143,
          "old_api": null,
          "new_api": "atoi",
          "old_text": null,
          "new_text": "atoi( value )",
          "old_line_content": "                {",
          "new_line_content": "                    if( atoi( value ) > 0 )",
          "content_same": false
        },
        {
          "line": 273,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy( pv->pic_in.img.plane[1], in->data + job->width * job->height,\n                    job->width * job->height / 4 )",
          "old_line_content": "        {",
          "new_line_content": "            memcpy( pv->pic_in.img.plane[1], in->data + job->width * job->height,",
          "content_same": false
        },
        {
          "line": 275,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy( pv->pic_in.img.plane[2], in->data + 5 * job->width *\n                    job->height / 4, job->width * job->height / 4 )",
          "old_line_content": "                    job->width * job->height / 4 );",
          "new_line_content": "            memcpy( pv->pic_in.img.plane[2], in->data + 5 * job->width *",
          "content_same": false
        },
        {
          "line": 155,
          "old_api": null,
          "new_api": "x264_param_parse",
          "old_text": null,
          "new_text": "x264_param_parse( &param, name, value )",
          "old_line_content": "            /* Here's where the strings are passed to libx264 for parsing. */",
          "new_line_content": "            ret = x264_param_parse( &param, name, value );",
          "content_same": false
        },
        {
          "line": 159,
          "old_api": null,
          "new_api": "hb_log",
          "old_text": null,
          "new_text": "hb_log( \"x264 options: Unknown suboption %s\", name )",
          "old_line_content": "            if( ret == X264_PARAM_BAD_NAME )",
          "new_line_content": "                hb_log( \"x264 options: Unknown suboption %s\", name );",
          "content_same": false
        },
        {
          "line": 161,
          "old_api": null,
          "new_api": "hb_log",
          "old_text": null,
          "new_text": "hb_log( \"x264 options: Bad argument %s=%s\", name, value ? value : \"(null)\" )",
          "old_line_content": "            if( ret == X264_PARAM_BAD_VALUE )",
          "new_line_content": "                hb_log( \"x264 options: Bad argument %s=%s\", name, value ? value : \"(null)\" );",
          "content_same": false
        },
        {
          "line": 290,
          "old_api": null,
          "new_api": "x264_encoder_encode",
          "old_text": null,
          "new_text": "x264_encoder_encode( pv->x264, &nal, &i_nal,\n                             &pv->pic_in, &pic_out )",
          "old_line_content": "",
          "new_line_content": "        x264_encoder_encode( pv->x264, &nal, &i_nal,",
          "content_same": false
        },
        {
          "line": 295,
          "old_api": null,
          "new_api": "x264_encoder_encode",
          "old_text": null,
          "new_text": "x264_encoder_encode( pv->x264, &nal, &i_nal,\n                             NULL, &pic_out )",
          "old_line_content": "    {",
          "new_line_content": "        x264_encoder_encode( pv->x264, &nal, &i_nal,",
          "content_same": false
        },
        {
          "line": 171,
          "old_api": null,
          "new_api": "hb_log",
          "old_text": null,
          "new_text": "hb_log( \"encx264: encoding with stored aspect %d/%d\",\n                param.vui.i_sar_width, param.vui.i_sar_height )",
          "old_line_content": "",
          "new_line_content": "        hb_log( \"encx264: encoding with stored aspect %d/%d\",",
          "content_same": false
        },
        {
          "line": 308,
          "old_api": null,
          "new_api": "hb_buffer_init",
          "old_text": null,
          "new_text": "hb_buffer_init(0)",
          "old_line_content": "            until we stop getting frames out of the encoder. */",
          "new_line_content": "            hb_fifo_push(w->fifo_in, hb_buffer_init(0));",
          "content_same": false
        },
        {
          "line": 184,
          "old_api": null,
          "new_api": "hb_log",
          "old_text": null,
          "new_text": "hb_log( \"encx264: Encoding at constant RF %f\",\n                        param.rc.f_rf_constant )",
          "old_line_content": "                param.rc.f_rf_constant = 51 - job->vquality * 51;",
          "new_line_content": "                hb_log( \"encx264: Encoding at constant RF %f\",",
          "content_same": false
        },
        {
          "line": 315,
          "old_api": null,
          "new_api": "hb_buffer_init",
          "old_text": null,
          "new_text": "hb_buffer_init( 3 * job->width * job->height / 2 )",
          "old_line_content": "        /* Should be way too large */",
          "new_line_content": "        buf        = hb_buffer_init( 3 * job->width * job->height / 2 );",
          "content_same": false
        },
        {
          "line": 192,
          "old_api": null,
          "new_api": "hb_log",
          "old_text": null,
          "new_text": "hb_log( \"encx264: encoding at constant QP %d\",\n                        param.rc.i_qp_constant )",
          "old_line_content": "                param.rc.i_qp_constant = 51 - job->vquality * 51;",
          "new_line_content": "                hb_log( \"encx264: encoding at constant QP %d\",",
          "content_same": false
        },
        {
          "line": 77,
          "old_api": null,
          "new_api": "hb_log",
          "old_text": null,
          "new_text": "hb_log( \"encx264: encoding at level %i\",\n                param.i_level_idc )",
          "old_line_content": "        param.i_level_idc = job->h264_level;",
          "new_line_content": "        hb_log( \"encx264: encoding at level %i\",",
          "content_same": false
        },
        {
          "line": 333,
          "old_api": null,
          "new_api": "x264_nal_encode",
          "old_text": null,
          "new_text": "x264_nal_encode( buf->data + buf->size, &data,\n                                          1, &nal[i] )",
          "old_line_content": "            data = buf->alloc - buf->size;",
          "new_line_content": "            if( ( size = x264_nal_encode( buf->data + buf->size, &data,",
          "content_same": false
        },
        {
          "line": 215,
          "old_api": null,
          "new_api": "hb_log",
          "old_text": null,
          "new_text": "hb_log( \"encx264: opening libx264 (pass %d)\", job->pass )",
          "old_line_content": "",
          "new_line_content": "    hb_log( \"encx264: opening libx264 (pass %d)\", job->pass );",
          "content_same": false
        },
        {
          "line": 218,
          "old_api": null,
          "new_api": "x264_encoder_headers",
          "old_text": null,
          "new_text": "x264_encoder_headers( pv->x264, &nal, &nal_count )",
          "old_line_content": "",
          "new_line_content": "    x264_encoder_headers( pv->x264, &nal, &nal_count );",
          "content_same": false
        },
        {
          "line": 223,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy( &w->config->h264.sps[1], nal[1].p_payload, nal[1].i_payload )",
          "old_line_content": "    w->config->h264.sps[0] = 0x67;",
          "new_line_content": "    memcpy( &w->config->h264.sps[1], nal[1].p_payload, nal[1].i_payload );",
          "content_same": false
        },
        {
          "line": 228,
          "old_api": null,
          "new_api": "memcpy",
          "old_text": null,
          "new_text": "memcpy( &w->config->h264.pps[1], nal[2].p_payload, nal[2].i_payload )",
          "old_line_content": "    w->config->h264.pps[0] = 0x68;",
          "new_line_content": "    memcpy( &w->config->h264.pps[1], nal[2].p_payload, nal[2].i_payload );",
          "content_same": false
        },
        {
          "line": 230,
          "old_api": null,
          "new_api": "x264_picture_alloc",
          "old_text": null,
          "new_text": "x264_picture_alloc( &pv->pic_in, X264_CSP_I420,\n            job->width, job->height )",
          "old_line_content": "",
          "new_line_content": "    x264_picture_alloc( &pv->pic_in, X264_CSP_I420,",
          "content_same": false
        },
        {
          "line": 108,
          "old_api": null,
          "new_api": "strcspn",
          "old_text": null,
          "new_text": "strcspn( x264opts, \":\" )",
          "old_line_content": "",
          "new_line_content": "            x264opts += strcspn( x264opts, \":\" );",
          "content_same": false
        },
        {
          "line": 242,
          "old_api": null,
          "new_api": "x264_picture_clean",
          "old_text": null,
          "new_text": "x264_picture_clean( &pv->pic_in )",
          "old_line_content": "    hb_work_private_t * pv = w->private_data;",
          "new_line_content": "    x264_picture_clean( &pv->pic_in );",
          "content_same": false
        },
        {
          "line": 115,
          "old_api": null,
          "new_api": "strchr",
          "old_text": null,
          "new_text": "strchr( name, '=' )",
          "old_line_content": "",
          "new_line_content": "            value = strchr( name, '=' );",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 131,
          "old_api": "strcmp",
          "new_api": null,
          "old_text": "strcmp( name, \"bframes\" )",
          "new_text": null,
          "old_line_content": "            if( !( strcmp( name, \"bframes\" ) ) )",
          "new_line_content": "            {",
          "content_same": false
        },
        {
          "line": 133,
          "old_api": "atoi",
          "new_api": null,
          "old_text": "atoi( value )",
          "new_text": null,
          "old_line_content": "                if( atoi( value ) > 0 )",
          "new_line_content": "                {",
          "content_same": false
        },
        {
          "line": 265,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy( pv->pic_in.img.plane[0], in->data, job->width * job->height )",
          "new_text": null,
          "old_line_content": "        memcpy( pv->pic_in.img.plane[0], in->data, job->width * job->height );",
          "new_line_content": "        if( job->grayscale )",
          "content_same": false
        },
        {
          "line": 140,
          "old_api": "strcmp",
          "new_api": null,
          "old_text": "strcmp( name, \"b-pyramid\" )",
          "new_text": null,
          "old_line_content": "            if( !( strcmp( name, \"b-pyramid\" ) ) )",
          "new_line_content": "            {",
          "content_same": false
        },
        {
          "line": 270,
          "old_api": "memset",
          "new_api": null,
          "old_text": "memset( pv->pic_in.img.plane[2], 0x80, job->width * job->height / 4 )",
          "new_text": null,
          "old_line_content": "            memset( pv->pic_in.img.plane[2], 0x80, job->width * job->height / 4 );",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 144,
          "old_api": "atoi",
          "new_api": null,
          "old_text": "atoi( value )",
          "new_text": null,
          "old_line_content": "                    if( atoi( value ) > 0 )",
          "new_line_content": "                    {",
          "content_same": false
        },
        {
          "line": 274,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy( pv->pic_in.img.plane[1], in->data + job->width * job->height,\n                    job->width * job->height / 4 )",
          "new_text": null,
          "old_line_content": "            memcpy( pv->pic_in.img.plane[1], in->data + job->width * job->height,",
          "new_line_content": "                    job->width * job->height / 4 );",
          "content_same": false
        },
        {
          "line": 276,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy( pv->pic_in.img.plane[2], in->data + 5 * job->width *\n                    job->height / 4, job->width * job->height / 4 )",
          "new_text": null,
          "old_line_content": "            memcpy( pv->pic_in.img.plane[2], in->data + 5 * job->width *",
          "new_line_content": "                    job->height / 4, job->width * job->height / 4 );",
          "content_same": false
        },
        {
          "line": 156,
          "old_api": "x264_param_parse",
          "new_api": null,
          "old_text": "x264_param_parse( &param, name, value )",
          "new_text": null,
          "old_line_content": "            ret = x264_param_parse( &param, name, value );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 160,
          "old_api": "hb_log",
          "new_api": null,
          "old_text": "hb_log( \"x264 options: Unknown suboption %s\", name )",
          "new_text": null,
          "old_line_content": "                hb_log( \"x264 options: Unknown suboption %s\", name );",
          "new_line_content": "            if( ret == X264_PARAM_BAD_VALUE )",
          "content_same": false
        },
        {
          "line": 162,
          "old_api": "hb_log",
          "new_api": null,
          "old_text": "hb_log( \"x264 options: Bad argument %s=%s\", name, value ? value : \"(null)\" )",
          "new_text": null,
          "old_line_content": "                hb_log( \"x264 options: Bad argument %s=%s\", name, value ? value : \"(null)\" );",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 291,
          "old_api": "x264_encoder_encode",
          "new_api": null,
          "old_text": "x264_encoder_encode( pv->x264, &nal, &i_nal,\n                             &pv->pic_in, &pic_out )",
          "new_text": null,
          "old_line_content": "        x264_encoder_encode( pv->x264, &nal, &i_nal,",
          "new_line_content": "                             &pv->pic_in, &pic_out );        ",
          "content_same": false
        },
        {
          "line": 296,
          "old_api": "x264_encoder_encode",
          "new_api": null,
          "old_text": "x264_encoder_encode( pv->x264, &nal, &i_nal,\n                             NULL, &pic_out )",
          "new_text": null,
          "old_line_content": "        x264_encoder_encode( pv->x264, &nal, &i_nal,",
          "new_line_content": "                             NULL, &pic_out );",
          "content_same": false
        },
        {
          "line": 172,
          "old_api": "hb_log",
          "new_api": null,
          "old_text": "hb_log( \"encx264: encoding with stored aspect %d/%d\",\n                param.vui.i_sar_width, param.vui.i_sar_height )",
          "new_text": null,
          "old_line_content": "        hb_log( \"encx264: encoding with stored aspect %d/%d\",",
          "new_line_content": "                param.vui.i_sar_width, param.vui.i_sar_height );",
          "content_same": false
        },
        {
          "line": 309,
          "old_api": "hb_buffer_init",
          "new_api": null,
          "old_text": "hb_buffer_init(0)",
          "new_text": null,
          "old_line_content": "            hb_fifo_push(w->fifo_in, hb_buffer_init(0));",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 185,
          "old_api": "hb_log",
          "new_api": null,
          "old_text": "hb_log( \"encx264: Encoding at constant RF %f\",\n                        param.rc.f_rf_constant )",
          "new_text": null,
          "old_line_content": "                hb_log( \"encx264: Encoding at constant RF %f\",",
          "new_line_content": "                        param.rc.f_rf_constant );",
          "content_same": false
        },
        {
          "line": 316,
          "old_api": "hb_buffer_init",
          "new_api": null,
          "old_text": "hb_buffer_init( 3 * job->width * job->height / 2 )",
          "new_text": null,
          "old_line_content": "        buf        = hb_buffer_init( 3 * job->width * job->height / 2 );",
          "new_line_content": "        buf->size  = 0;",
          "content_same": false
        },
        {
          "line": 193,
          "old_api": "hb_log",
          "new_api": null,
          "old_text": "hb_log( \"encx264: encoding at constant QP %d\",\n                        param.rc.i_qp_constant )",
          "new_text": null,
          "old_line_content": "                hb_log( \"encx264: encoding at constant QP %d\",",
          "new_line_content": "                        param.rc.i_qp_constant );",
          "content_same": false
        },
        {
          "line": 78,
          "old_api": "hb_log",
          "new_api": null,
          "old_text": "hb_log( \"encx264: encoding at level %i\",\n                param.i_level_idc )",
          "new_text": null,
          "old_line_content": "        hb_log( \"encx264: encoding at level %i\",",
          "new_line_content": "                param.i_level_idc );",
          "content_same": false
        },
        {
          "line": 334,
          "old_api": "x264_nal_encode",
          "new_api": null,
          "old_text": "x264_nal_encode( buf->data + buf->size, &data,\n                                          1, &nal[i] )",
          "new_text": null,
          "old_line_content": "            if( ( size = x264_nal_encode( buf->data + buf->size, &data,",
          "new_line_content": "                                          1, &nal[i] ) ) < 1 )",
          "content_same": false
        },
        {
          "line": 217,
          "old_api": "x264_encoder_open",
          "new_api": null,
          "old_text": "x264_encoder_open( &param )",
          "new_text": null,
          "old_line_content": "    pv->x264 = x264_encoder_open( &param );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 219,
          "old_api": "x264_encoder_headers",
          "new_api": null,
          "old_text": "x264_encoder_headers( pv->x264, &nal, &nal_count )",
          "new_text": null,
          "old_line_content": "    x264_encoder_headers( pv->x264, &nal, &nal_count );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 224,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy( &w->config->h264.sps[1], nal[1].p_payload, nal[1].i_payload )",
          "new_text": null,
          "old_line_content": "    memcpy( &w->config->h264.sps[1], nal[1].p_payload, nal[1].i_payload );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 229,
          "old_api": "memcpy",
          "new_api": null,
          "old_text": "memcpy( &w->config->h264.pps[1], nal[2].p_payload, nal[2].i_payload )",
          "new_text": null,
          "old_line_content": "    memcpy( &w->config->h264.pps[1], nal[2].p_payload, nal[2].i_payload );",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 231,
          "old_api": "x264_picture_alloc",
          "new_api": null,
          "old_text": "x264_picture_alloc( &pv->pic_in, X264_CSP_I420,\n            job->width, job->height )",
          "new_text": null,
          "old_line_content": "    x264_picture_alloc( &pv->pic_in, X264_CSP_I420,",
          "new_line_content": "            job->width, job->height );",
          "content_same": false
        },
        {
          "line": 109,
          "old_api": "strcspn",
          "new_api": null,
          "old_text": "strcspn( x264opts, \":\" )",
          "new_text": null,
          "old_line_content": "            x264opts += strcspn( x264opts, \":\" );",
          "new_line_content": "            if( *x264opts )",
          "content_same": false
        },
        {
          "line": 116,
          "old_api": "strchr",
          "new_api": null,
          "old_text": "strchr( name, '=' )",
          "new_text": null,
          "old_line_content": "            value = strchr( name, '=' );",
          "new_line_content": "            if( value )",
          "content_same": false
        },
        {
          "line": 245,
          "old_api": "free",
          "new_api": null,
          "old_text": "free( pv )",
          "new_text": null,
          "old_line_content": "    free( pv );",
          "new_line_content": "    w->private_data = NULL;",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 3,
      "total_additions": 28,
      "total_deletions": 28,
      "total_api_changes": 59
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 1,
        "api_related_lines": 59,
        "non_api_lines": 1,
        "non_api_line_numbers": [
          75
        ]
      }
    },
    "api_calls_before": 38,
    "api_calls_after": 38,
    "diff_info": {
      "added_lines": 0,
      "removed_lines": 1,
      "total_diff_lines": 13
    }
  }
}