[
    {
        "repository_name": "carbon-lang",
        "hash": "0e2b6c7f1acd55ffb5350144f4319be4721169f8",
        "author": "Chandler Carruth",
        "date": "2023-10-13T05:11:04+00:00",
        "message": "Optimize runs of horizontal whitespace. (#3288)\n\nSo, this is a somewhat fun, simple improvement. =] Just use a loop and\ncount runs of whitespace. I didn't even work all that hard to make the\nloop fast, but it seems great. Makes long runs of indentation more than\n2x faster at basically no code complexity.\n\nI thought about doing this for vertical whitespace as well but it's not\neasy to do, and didn't seem worth adding complexity. Huge runs of blank\nlines aren't nearly as common as lots of indentation. I do have a plan\nfor an analogous optimization for comment blocks, but want to simplify\nsome other code first.\n\nWe could also make this (hilariously) faster with some judicious use of\nSIMD or clever use of a string function, but it doesn't seem worth it\ngiven how fast the simple loop is already.\n\nI didn't work to get a high N count and so there's plenty of noise here,\nbut the benchmark data speaks for itself:\n\n```\nBM_ValidKeywords                               2.71ms \u00b1 1%  2.75ms \u00b1 1%   +1.32%  (p=0.016 n=5+5)\nBM_ValidIdentifiers<1, 64, false>              9.71ms \u00b1 2%  9.74ms \u00b1 1%     ~     (p=1.000 n=5+5)\nBM_ValidIdentifiers<1, 1, true>                3.17ms \u00b1 1%  3.22ms \u00b1 2%     ~     (p=0.151 n=5+5)\nBM_ValidIdentifiers<3, 5, true>                11.5ms \u00b1 2%  11.6ms \u00b1 3%     ~     (p=0.548 n=5+5)\nBM_ValidIdentifiers<3, 16, true>               11.3ms \u00b1 3%  11.6ms \u00b1 3%     ~     (p=0.095 n=5+5)\nBM_ValidIdentifiers<12, 64, true>              12.8ms \u00b1 1%  12.8ms \u00b1 1%     ~     (p=1.000 n=5+5)\nBM_HorizontalWhitespace/1                      11.6ms \u00b1 1%  11.7ms \u00b1 2%     ~     (p=0.310 n=5+5)\nBM_HorizontalWhitespace/4                      12.9ms \u00b1 1%  11.8ms \u00b1 0%   -8.50%  (p=0.008 n=5+5)\nBM_HorizontalWhitespace/16                     17.3ms \u00b1 4%  12.5ms \u00b1 1%  -27.69%  (p=0.008 n=5+5)\nBM_HorizontalWhitespace/64                     28.9ms \u00b1 3%  16.0ms \u00b1 2%  -44.88%  (p=0.008 n=5+5)\nBM_HorizontalWhitespace/128                    47.6ms \u00b1 3%  21.0ms \u00b1 0%  -55.88%  (p=0.016 n=5+4)\nBM_RandomSource                                7.92ms \u00b1 1%  7.70ms \u00b1 3%   -2.74%  (p=0.016 n=5+5)\nBM_GroupingSymbols/1/0/0                       5.92ms \u00b1 2%  5.86ms \u00b1 1%     ~     (p=0.310 n=5+5)\nBM_GroupingSymbols/2/0/0                       5.30ms \u00b1 1%  5.01ms \u00b1 1%   -5.52%  (p=0.008 n=5+5)\nBM_GroupingSymbols/3/0/0                       4.48ms \u00b1 0%  3.95ms \u00b1 1%  -11.69%  (p=0.008 n=5+5)\nBM_GroupingSymbols/4/0/0                       4.61ms \u00b1 1%  3.73ms \u00b1 1%  -19.12%  (p=0.008 n=5+5)\nBM_GroupingSymbols/8/0/0                       5.34ms \u00b1 6%  3.05ms \u00b1 1%  -42.82%  (p=0.008 n=5+5)\nBM_GroupingSymbols/16/0/0                      6.44ms \u00b1 1%  3.20ms \u00b1 2%  -50.24%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/0/0                      10.3ms \u00b1 5%   4.2ms \u00b1 1%  -59.81%  (p=0.008 n=5+5)\nBM_GroupingSymbols/0/1/0                       5.17ms \u00b1 2%  5.17ms \u00b1 1%     ~     (p=0.690 n=5+5)\nBM_GroupingSymbols/0/2/0                       4.04ms \u00b1 1%  4.04ms \u00b1 2%     ~     (p=1.000 n=5+5)\nBM_GroupingSymbols/0/3/0                       2.89ms \u00b1 1%  2.89ms \u00b1 1%     ~     (p=1.000 n=5+5)\nBM_GroupingSymbols/0/4/0                       2.54ms \u00b1 1%  2.55ms \u00b1 1%     ~     (p=0.421 n=5+5)\nBM_GroupingSymbols/0/8/0                       1.65ms \u00b1 2%  1.67ms \u00b1 1%     ~     (p=0.310 n=5+5)\nBM_GroupingSymbols/0/16/0                      1.18ms \u00b1 1%  1.19ms \u00b1 2%     ~     (p=0.222 n=5+5)\nBM_GroupingSymbols/0/32/0                       948\u00b5s \u00b1 1%   957\u00b5s \u00b1 2%     ~     (p=0.310 n=5+5)\nBM_GroupingSymbols/0/0/1                       5.17ms \u00b1 1%  5.16ms \u00b1 2%     ~     (p=0.841 n=5+5)\nBM_GroupingSymbols/0/0/2                       4.03ms \u00b1 2%  4.04ms \u00b1 2%     ~     (p=0.548 n=5+5)\nBM_GroupingSymbols/0/0/3                       2.89ms \u00b1 1%  2.88ms \u00b1 1%     ~     (p=0.841 n=5+5)\nBM_GroupingSymbols/0/0/4                       2.54ms \u00b1 1%  2.54ms \u00b1 2%     ~     (p=0.548 n=5+5)\nBM_GroupingSymbols/0/0/8                       1.66ms \u00b1 3%  1.67ms \u00b1 2%     ~     (p=0.690 n=5+5)\nBM_GroupingSymbols/0/0/16                      1.19ms \u00b1 1%  1.18ms \u00b1 2%     ~     (p=0.548 n=5+5)\nBM_GroupingSymbols/0/0/32                       949\u00b5s \u00b1 2%   955\u00b5s \u00b1 1%     ~     (p=0.310 n=5+5)\nBM_GroupingSymbols/32/1/0                      10.0ms \u00b1 1%   4.0ms \u00b1 1%  -59.76%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/2/0                      9.73ms \u00b1 2%  3.92ms \u00b1 2%  -59.73%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/3/0                      9.40ms \u00b1 2%  3.84ms \u00b1 3%  -59.10%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/4/0                      9.20ms \u00b1 2%  3.74ms \u00b1 1%  -59.35%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/8/0                      8.38ms \u00b1 2%  3.50ms \u00b1 1%  -58.22%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/16/0                     7.18ms \u00b1 2%  3.06ms \u00b1 3%  -57.41%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/32/0                     5.53ms \u00b1 1%  2.44ms \u00b1 2%  -55.99%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/32/1                     5.47ms \u00b1 2%  2.40ms \u00b1 2%  -56.08%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/32/2                     5.41ms \u00b1 3%  2.40ms \u00b1 2%  -55.66%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/32/3                     5.28ms \u00b1 2%  2.37ms \u00b1 2%  -55.18%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/32/4                     5.25ms \u00b1 2%  2.34ms \u00b1 2%  -55.52%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/32/8                     5.03ms \u00b1 3%  2.25ms \u00b1 1%  -55.29%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/32/16                    4.62ms \u00b1 1%  2.15ms \u00b1 3%  -53.41%  (p=0.008 n=5+5)\nBM_GroupingSymbols/32/32/32                    3.99ms \u00b1 1%  1.86ms \u00b1 1%  -53.24%  (p=0.008 n=5+5)\nBM_BlankLines/1                                12.8ms \u00b1 1%  12.6ms \u00b1 2%     ~     (p=0.310 n=5+5)\nBM_BlankLines/4                                16.0ms \u00b1 3%  15.8ms \u00b1 1%     ~     (p=0.310 n=5+5)\nBM_BlankLines/16                               33.1ms \u00b1 2%  32.1ms \u00b1 1%   -3.29%  (p=0.008 n=5+5)\nBM_BlankLines/64                               84.6ms \u00b1 3%  84.2ms \u00b1 3%     ~     (p=0.690 n=5+5)\nBM_BlankLines/128                               159ms \u00b1 4%   155ms \u00b1 3%     ~     (p=0.310 n=5+5)\nBM_CommentLines/1/0/0                          14.5ms \u00b1 2%  14.5ms \u00b1 2%     ~     (p=0.690 n=5+5)\nBM_CommentLines/4/0/0                          19.0ms \u00b1 1%  19.0ms \u00b1 1%     ~     (p=0.548 n=5+5)\nBM_CommentLines/128/0/0                         188ms \u00b1 2%   186ms \u00b1 1%     ~     (p=0.151 n=5+5)\nBM_CommentLines/1/30/0                         14.8ms \u00b1 3%  14.7ms \u00b1 2%     ~     (p=0.421 n=5+5)\nBM_CommentLines/4/30/0                         21.8ms \u00b1 1%  21.3ms \u00b1 4%     ~     (p=0.095 n=5+5)\nBM_CommentLines/128/30/0                        201ms \u00b1 1%   200ms \u00b1 2%     ~     (p=0.421 n=5+5)\nBM_CommentLines/1/70/0                         15.5ms \u00b1 3%  15.2ms \u00b1 4%     ~     (p=0.095 n=5+5)\nBM_CommentLines/4/70/0                         23.2ms \u00b1 1%  22.5ms \u00b1 2%   -2.76%  (p=0.008 n=5+5)\nBM_CommentLines/128/70/0                        213ms \u00b1 1%   209ms \u00b1 1%   -1.54%  (p=0.016 n=5+5)\nBM_CommentLines/1/0/2                          15.3ms \u00b1 1%  14.5ms \u00b1 1%   -4.99%  (p=0.008 n=5+5)\nBM_CommentLines/4/0/2                          21.4ms \u00b1 1%  20.2ms \u00b1 2%   -5.48%  (p=0.008 n=5+5)\nBM_CommentLines/128/0/2                         242ms \u00b1 2%   218ms \u00b1 5%  -10.13%  (p=0.008 n=5+5)\nBM_CommentLines/1/30/2                         15.7ms \u00b1 4%  15.1ms \u00b1 2%   -3.37%  (p=0.008 n=5+5)\nBM_CommentLines/4/30/2                         24.3ms \u00b1 1%  22.5ms \u00b1 3%   -7.42%  (p=0.008 n=5+5)\nBM_CommentLines/128/30/2                        268ms \u00b1 2%   240ms \u00b1 3%  -10.22%  (p=0.008 n=5+5)\nBM_CommentLines/1/70/2                         16.1ms \u00b1 2%  15.3ms \u00b1 3%   -5.24%  (p=0.008 n=5+5)\nBM_CommentLines/4/70/2                         25.7ms \u00b1 3%  24.0ms \u00b1 3%   -6.69%  (p=0.008 n=5+5)\nBM_CommentLines/128/70/2                        272ms \u00b1 1%   247ms \u00b1 1%   -9.21%  (p=0.008 n=5+5)\nBM_CommentLines/1/0/8                          17.2ms \u00b1 5%  14.8ms \u00b1 2%  -14.32%  (p=0.008 n=5+5)\nBM_CommentLines/4/0/8                          30.4ms \u00b1 2%  20.8ms \u00b1 2%  -31.47%  (p=0.008 n=5+5)\nBM_CommentLines/128/0/8                         463ms \u00b1 1%   260ms \u00b1 1%  -43.89%  (p=0.008 n=5+5)\nBM_CommentLines/1/30/8                         17.2ms \u00b1 2%  15.2ms \u00b1 2%  -12.01%  (p=0.008 n=5+5)\nBM_CommentLines/4/30/8                         32.4ms \u00b1 1%  23.2ms \u00b1 3%  -28.61%  (p=0.008 n=5+5)\nBM_CommentLines/128/30/8                        498ms \u00b1 3%   287ms \u00b1 2%  -42.32%  (p=0.008 n=5+5)\nBM_CommentLines/1/70/8                         17.6ms \u00b1 2%  15.5ms \u00b1 3%  -11.61%  (p=0.008 n=5+5)\nBM_CommentLines/4/70/8                         34.0ms \u00b1 4%  24.7ms \u00b1 3%  -27.31%  (p=0.008 n=5+5)\nBM_CommentLines/128/70/8                        497ms \u00b1 2%   297ms \u00b1 4%  -40.29%  (p=0.008 n=5+5)\n```\n\nStacked on top of #3287 -- only the last commit should be reviewed here.",
        "modified_files_count": 1,
        "modified_files": [
            "toolchain/lex/tokenized_buffer.cpp"
        ],
        "github_commit_url": "https://github.com/carbon-language/carbon-lang/commit/0e2b6c7f1acd55ffb5350144f4319be4721169f8",
        "contains_optimization_keyword": true,
        "modified_func_count": 1,
        "modified_other": false,
        "modified_func": [
            "LexHorizontalWhitespace"
        ],
        "added_lines": 12,
        "deleted_lines": 2,
        "total_changed_lines": 14,
        "net_line_change": 10,
        "modified_code_blocks": 1,
        "is_opt_ds_simple": "true"
    }
]