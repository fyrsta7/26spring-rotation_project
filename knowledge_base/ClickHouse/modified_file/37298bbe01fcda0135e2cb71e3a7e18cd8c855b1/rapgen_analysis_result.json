{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/37298bbe01fcda0135e2cb71e3a7e18cd8c855b1",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/37298bbe01fcda0135e2cb71e3a7e18cd8c855b1/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/37298bbe01fcda0135e2cb71e3a7e18cd8c855b1/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/37298bbe01fcda0135e2cb71e3a7e18cd8c855b1/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 115,
          "old_api": "else\n\t\t{\n\t\t\tif (isValidFunction(exp",
          "new_api": "push_back",
          "old_text": "\telse\n\t\t{\n\t\t\tif (isValidFunction(exp",
          "new_text": "{\n\t\tresult.push_back(expression->clone());\n\t}\n}\n\n/// Построить конъ",
          "old_line_content": "\t\t\tfor (size_t i = 0; i < function->arguments->children.size(); ++i)",
          "new_line_content": "\t\t\textractFunctions(function->arguments->children[i], columns, result);",
          "content_same": false
        },
        {
          "line": 129,
          "old_api": "typeid_cast<ASTF",
          "new_api": "unctions;\n\tnew_function.children.push_b",
          "old_text": "typeid_cast<ASTF",
          "new_text": "unctions;\n\tnew_function.children.push_b",
          "old_line_content": "\tif (functions.size() == 0) return nullptr;",
          "new_line_content": "\tASTFunction & new_function = typeid_cast<ASTFunction & >(*new_query);",
          "content_same": false
        },
        {
          "line": 153,
          "old_api": "pression_ast)\n\t\treturn false;\n\n\t/// Распарсим и вычислим выра",
          "new_api": "etActions",
          "old_text": "pression_ast)\n\t\treturn false;\n\n\t/// Распарсим и вычислим выра",
          "new_text": "etActions(false);\n\tactions->exe",
          "old_line_content": "\t\textractFunctions(select.where_expression, columns, functions);",
          "new_line_content": "\tASTPtr expression_ast = buildWhereExpression(functions);",
          "content_same": false
        },
        {
          "line": 163,
          "old_api": "lumn))\n\t\tfilter_column",
          "new_api": "= dynamic_cast<ColumnUInt8 &>(",
          "old_text": "lumn))\n\t\tfilter_column ",
          "new_text": " = dynamic_cast<ColumnUInt8 &>(",
          "old_line_content": "\tactions->execute(block);",
          "new_line_content": "\tString filter_column_name = expression_ast->getColumnName();",
          "content_same": false
        },
        {
          "line": 166,
          "old_api": "= dynamic_cast<ColumnUInt8 &>(",
          "new_api": "umnPtr & column = block.getByPositi",
          "old_text": " = dynamic_cast<ColumnUInt8 &>(",
          "new_text": "umnPtr & column = block.getByPositi",
          "old_line_content": "\tString filter_column_name = expression_ast->getColumnName();",
          "new_line_content": "\t\tfilter_column = const_column->convertToFullColumn();",
          "content_same": false
        },
        {
          "line": 167,
          "old_api": "begin",
          "new_api": "ter",
          "old_text": "if (std::accumulate(filter.begin(),",
          "new_text": "ter(filter);\n\t}\n\n\treturn true;\n}\n\n}\n\n}\n",
          "old_line_content": "\tColumnPtr filter_column = block.getByName(filter_column_name).column;",
          "new_line_content": "\tconst IColumn::Filter & filter = dynamic_cast<ColumnUInt8 &>(*filter_column).getData();",
          "content_same": false
        },
        {
          "line": 169,
          "old_api": "umnPtr & column = block.getByPositi",
          "new_api": "",
          "old_text": "umnPtr & column = block.getByPositi",
          "new_text": "",
          "old_line_content": "\t\tfilter_column = const_column->convertToFullColumn();",
          "new_line_content": "\tif (std::accumulate(filter.begin(), filter.end(), 0ul) == filter.size())",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 160,
          "old_api": null,
          "new_api": "lumn))\n\t\tfilter_column",
          "old_text": null,
          "new_text": "lumn))\n\t\tfilter_column ",
          "old_line_content": "\t/// Распарсим и вычислим выражение.",
          "new_line_content": "\tactions->execute(block);",
          "content_same": false
        },
        {
          "line": 164,
          "old_api": null,
          "new_api": "begin",
          "old_text": null,
          "new_text": "if (std::accumulate(filter.begin(),",
          "old_line_content": "",
          "new_line_content": "\tColumnPtr filter_column = block.getByName(filter_column_name).column;",
          "content_same": false
        },
        {
          "line": 133,
          "old_api": null,
          "new_api": ")\n{\n\tconst ASTSelectQuery & select = typeid_cast<ASTSel",
          "old_text": null,
          "new_text": ")\n{\n\tconst ASTSelectQuery & select = typeid_cast<ASTSel",
          "old_line_content": "\tnew_function.name = \"and\";",
          "new_line_content": "\tnew_function.children.push_back(new_function.arguments);",
          "content_same": false
        },
        {
          "line": 165,
          "old_api": null,
          "new_api": "rn false;\n\n\tfor (size_t i = 0; i < block.colu",
          "old_text": null,
          "new_text": "rn false;\n\n\tfor (size_t i = 0; i < block.colu",
          "old_line_content": "\t/// Отфильтруем блок.",
          "new_line_content": "\tif (IColumnConst * const_column = dynamic_cast<IColumnConst *>(&*filter_column))",
          "content_same": false
        },
        {
          "line": 139,
          "old_api": null,
          "new_api": "getColumnsList",
          "old_text": null,
          "new_text": "t : block.getColumnsList())\n\t\tcolumns.",
          "old_line_content": "",
          "new_line_content": "\tconst ASTSelectQuery & select = typeid_cast<ASTSelectQuery & >(*query);",
          "content_same": false
        },
        {
          "line": 174,
          "old_api": null,
          "new_api": "",
          "old_text": null,
          "new_text": "",
          "old_line_content": "",
          "new_line_content": "\t\tColumnPtr & column = block.getByPosition(i).column;",
          "content_same": false
        },
        {
          "line": 144,
          "old_api": null,
          "new_api": ".\n\tstd::vector<ASTPtr>",
          "old_text": null,
          "new_text": ".\n\tstd::vector<ASTPtr>",
          "old_line_content": "\t\treturn false;",
          "new_line_content": "\tfor (const auto & it : block.getColumnsList())",
          "content_same": false
        },
        {
          "line": 145,
          "old_api": null,
          "new_api": "ctions;\n\tif (select.whe",
          "old_text": null,
          "new_text": "ctions;\n\tif (select.whe",
          "old_line_content": "",
          "new_line_content": "\t\tcolumns.insert(it.name);",
          "content_same": false
        },
        {
          "line": 114,
          "old_api": null,
          "new_api": "se if (isValidFunction(expression, c",
          "old_text": null,
          "new_text": "se if (isValidFunction(expression, c",
          "old_line_content": "\t\t{",
          "new_line_content": "\t\tfor (size_t i = 0; i < function->arguments->children.size(); ++i)",
          "content_same": false
        },
        {
          "line": 117,
          "old_api": null,
          "new_api": "ных функций\nstatic ASTPtr buildWhere",
          "old_text": null,
          "new_text": "ных функций\nstatic ASTPtr buildWhere",
          "old_line_content": "\t\t}",
          "new_line_content": "\telse if (isValidFunction(expression, columns))",
          "content_same": false
        },
        {
          "line": 150,
          "old_api": null,
          "new_api": "pression_ast)\n\t\treturn false;\n\n\t/// Распарсим и вычислим выра",
          "old_text": null,
          "new_text": "pression_ast)\n\t\treturn false;\n\n\t/// Распарсим и вычислим выра",
          "old_line_content": "\t/// Составим выражение, вычисляющее выражения в WHERE и PREWHERE, зависящие только от имеющихся столбцов.",
          "new_line_content": "\t\textractFunctions(select.where_expression, columns, functions);",
          "content_same": false
        },
        {
          "line": 119,
          "old_api": null,
          "new_api": "functions)\n{\n\tif (f",
          "old_text": null,
          "new_text": "functions)\n{\n\tif (f",
          "old_line_content": "\t\t{",
          "new_line_content": "\t\tresult.push_back(expression->clone());",
          "content_same": false
        },
        {
          "line": 152,
          "old_api": null,
          "new_api": "getColumnsList",
          "old_text": null,
          "new_text": "xpression_ast, context, block.getColumnsList());\n\tExpressionActi",
          "old_line_content": "\tif (select.where_expression)",
          "new_line_content": "\t\textractFunctions(select.prewhere_expression, columns, functions);",
          "content_same": false
        },
        {
          "line": 126,
          "old_api": null,
          "new_api": "typeid_cast<ASTF",
          "old_text": null,
          "new_text": "typeid_cast<ASTF",
          "old_line_content": "/// Построить конъюнкцию из заданных функций",
          "new_line_content": "\tif (functions.size() == 0) return nullptr;",
          "content_same": false
        },
        {
          "line": 127,
          "old_api": null,
          "new_api": "w_function.name",
          "old_text": null,
          "new_text": "w_function.name ",
          "old_line_content": "static ASTPtr buildWhereExpression(const ASTs & functions)",
          "new_line_content": "\tif (functions.size() == 1) return functions[0];",
          "content_same": false
        },
        {
          "line": 158,
          "old_api": null,
          "new_api": "e).column;\n\tif (IColum",
          "old_text": null,
          "new_text": "e).column;\n\tif (IColum",
          "old_line_content": "\t\treturn false;",
          "new_line_content": "\tExpressionAnalyzer analyzer(expression_ast, context, block.getColumnsList());",
          "content_same": false
        },
        {
          "line": 159,
          "old_api": null,
          "new_api": "t<IColumnConst *>(&*filter",
          "old_text": null,
          "new_text": "t<IColumnConst *>(&*filter",
          "old_line_content": "",
          "new_line_content": "\tExpressionActionsPtr actions = analyzer.getActions(false);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 161,
          "old_api": "e).column;\n\tif (IColum",
          "new_api": null,
          "old_text": "e).column;\n\tif (IColum",
          "new_text": null,
          "old_line_content": "\tExpressionAnalyzer analyzer(expression_ast, context, block.getColumnsList());",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 130,
          "old_api": "w_function.name",
          "new_api": null,
          "old_text": "w_function.name ",
          "new_text": null,
          "old_line_content": "\tif (functions.size() == 1) return functions[0];",
          "new_line_content": "\tnew_function.name = \"and\";",
          "content_same": false
        },
        {
          "line": 162,
          "old_api": "t<IColumnConst *>(&*filter",
          "new_api": null,
          "old_text": "t<IColumnConst *>(&*filter",
          "new_text": null,
          "old_line_content": "\tExpressionActionsPtr actions = analyzer.getActions(false);",
          "new_line_content": "\t/// Отфильтруем блок.",
          "content_same": false
        },
        {
          "line": 132,
          "old_api": "unctions;\n\tnew_function.children.push_b",
          "new_api": null,
          "old_text": "unctions;\n\tnew_function.children.push_b",
          "new_text": null,
          "old_line_content": "\tASTFunction & new_function = typeid_cast<ASTFunction & >(*new_query);",
          "new_line_content": "\tnew_function.arguments->children = functions;",
          "content_same": false
        },
        {
          "line": 136,
          "old_api": ")\n{\n\tconst ASTSelectQuery & select = typeid_cast<ASTSel",
          "new_api": null,
          "old_text": ")\n{\n\tconst ASTSelectQuery & select = typeid_cast<ASTSel",
          "new_text": null,
          "old_line_content": "\tnew_function.children.push_back(new_function.arguments);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 168,
          "old_api": "rn false;\n\n\tfor (size_t i = 0; i < block.colu",
          "new_api": null,
          "old_text": "rn false;\n\n\tfor (size_t i = 0; i < block.colu",
          "new_text": null,
          "old_line_content": "\tif (IColumnConst * const_column = dynamic_cast<IColumnConst *>(&*filter_column))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 170,
          "old_api": "ter",
          "new_api": null,
          "old_text": "ter(filter);\n\t}\n\n\treturn true;\n}\n\n}\n\n}\n",
          "new_text": null,
          "old_line_content": "\tconst IColumn::Filter & filter = dynamic_cast<ColumnUInt8 &>(*filter_column).getData();",
          "new_line_content": "\t\treturn false;",
          "content_same": false
        },
        {
          "line": 142,
          "old_api": "getColumnsList",
          "new_api": null,
          "old_text": "t : block.getColumnsList())\n\t\tcolumns.",
          "new_text": null,
          "old_line_content": "\tconst ASTSelectQuery & select = typeid_cast<ASTSelectQuery & >(*query);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 177,
          "old_api": "",
          "new_api": null,
          "old_text": "",
          "new_text": null,
          "old_line_content": "\t\tColumnPtr & column = block.getByPosition(i).column;",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 178,
          "old_api": "",
          "new_api": null,
          "old_text": "",
          "new_text": null,
          "old_line_content": "\t\tcolumn = column->filter(filter);",
          "new_line_content": "\treturn true;",
          "content_same": false
        },
        {
          "line": 147,
          "old_api": ".\n\tstd::vector<ASTPtr>",
          "new_api": null,
          "old_text": ".\n\tstd::vector<ASTPtr>",
          "new_text": null,
          "old_line_content": "\tfor (const auto & it : block.getColumnsList())",
          "new_line_content": "\t/// Составим выражение, вычисляющее выражения в WHERE и PREWHERE, зависящие только от имеющихся столбцов.",
          "content_same": false
        },
        {
          "line": 148,
          "old_api": "ctions;\n\tif (select.whe",
          "new_api": null,
          "old_text": "ctions;\n\tif (select.whe",
          "new_text": null,
          "old_line_content": "\t\tcolumns.insert(it.name);",
          "new_line_content": "\tstd::vector<ASTPtr> functions;",
          "content_same": false
        },
        {
          "line": 116,
          "old_api": "push_back",
          "new_api": null,
          "old_text": "lumns))\n\t\t\t\tresult.push_back(expression->clone());\n\t\t}\n\t}\n}\n\n/// По",
          "new_text": null,
          "old_line_content": "\t\t\t\textractFunctions(function->arguments->children[i], columns, result);",
          "new_line_content": "\t}",
          "content_same": false
        },
        {
          "line": 120,
          "old_api": "данных функций\nstatic ASTPtr buildWh",
          "new_api": null,
          "old_text": "данных функций\nstatic ASTPtr buildWh",
          "new_text": null,
          "old_line_content": "\t\t\tif (isValidFunction(expression, columns))",
          "new_line_content": "\t}",
          "content_same": false
        },
        {
          "line": 121,
          "old_api": "s & functions)\n{\n\ti",
          "new_api": null,
          "old_text": "s & functions)\n{\n\ti",
          "new_text": null,
          "old_line_content": "\t\t\t\tresult.push_back(expression->clone());",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 155,
          "old_api": "getColumnsList",
          "new_api": null,
          "old_text": "xpression_ast, context, block.getColumnsList());\n\tExpressionActi",
          "new_text": null,
          "old_line_content": "\t\textractFunctions(select.prewhere_expression, columns, functions);",
          "new_line_content": "\t\treturn false;",
          "content_same": false
        },
        {
          "line": 156,
          "old_api": "etActions",
          "new_api": null,
          "old_text": "etActions(false);\n\tactions->exe",
          "new_text": null,
          "old_line_content": "\tASTPtr expression_ast = buildWhereExpression(functions);",
          "new_line_content": "",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 7,
      "total_additions": 17,
      "total_deletions": 17,
      "total_api_changes": 41
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 12,
        "api_related_lines": 41,
        "non_api_lines": 5,
        "non_api_line_numbers": [
          111,
          112,
          113,
          118,
          122
        ]
      }
    },
    "api_calls_before": 46,
    "api_calls_after": 46,
    "diff_info": {
      "added_lines": 8,
      "removed_lines": 11,
      "total_diff_lines": 32
    }
  }
}