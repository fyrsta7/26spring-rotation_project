{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/e4fddaa03a5c9f1593d4a9ba823c4953578d8e33",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/e4fddaa03a5c9f1593d4a9ba823c4953578d8e33/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/e4fddaa03a5c9f1593d4a9ba823c4953578d8e33/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/e4fddaa03a5c9f1593d4a9ba823c4953578d8e33/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 655,
          "old_api": "getSubcolumnNames",
          "new_api": "insert",
          "old_text": "type_in_storage->getSubcolumnNames()",
          "new_text": "IDataType::forEachSubcolumn([&](const auto &, const auto & subname, const auto & subdata)\n    {\n        auto subcolumn = NameAndTypePair(name_in_storage, subname, type_in_storage, subdata.type);\n\n        if (has(subcolumn.name))\n            throw Exception(ErrorCodes::ILLEGAL_COLUMN,\n                \"Cannot add subcolumn {}: column with this name already exists\", subcolumn.name);\n\n        subcolumns.get<0>().insert(std::move(subcolumn));\n    }, {type_in_storage->getDefaultSerialization(), type_in_storage, nullptr, nullptr})",
          "old_line_content": "    for (const auto & subcolumn_name : type_in_storage->getSubcolumnNames())",
          "new_line_content": "    IDataType::forEachSubcolumn([&](const auto &, const auto & subname, const auto & subdata)",
          "content_same": false
        },
        {
          "line": 657,
          "old_api": "getSubcolumnType",
          "new_api": "NameAndTypePair",
          "old_text": "NameAndTypePair(name_in_storage, subcolumn_name,\n            type_in_storage, type_in_storage->getSubcolumnType(subcolumn_name))",
          "new_text": "NameAndTypePair(name_in_storage, subname, type_in_storage, subdata.type)",
          "old_line_content": "        auto subcolumn = NameAndTypePair(name_in_storage, subcolumn_name,",
          "new_line_content": "        auto subcolumn = NameAndTypePair(name_in_storage, subname, type_in_storage, subdata.type);",
          "content_same": false
        },
        {
          "line": 660,
          "old_api": "has",
          "new_api": "Exception",
          "old_text": "has(subcolumn.name)",
          "new_text": "Exception(ErrorCodes::ILLEGAL_COLUMN,\n                \"Cannot add subcolumn {}: column with this name already exists\", subcolumn.name)",
          "old_line_content": "        if (has(subcolumn.name))",
          "new_line_content": "            throw Exception(ErrorCodes::ILLEGAL_COLUMN,",
          "content_same": false
        },
        {
          "line": 664,
          "old_api": "std::move(subcolumn)",
          "new_api": "getDefaultSerialization",
          "old_text": "std::move(subcolumn)",
          "new_text": "type_in_storage->getDefaultSerialization()",
          "old_line_content": "        subcolumns.get<0>().insert(std::move(subcolumn));",
          "new_line_content": "    }, {type_in_storage->getDefaultSerialization(), type_in_storage, nullptr, nullptr});",
          "content_same": false
        },
        {
          "line": 678,
          "old_api": "child->as<ASTSubquery>()",
          "new_api": "Exception",
          "old_text": "child->as<ASTSubquery>()",
          "new_text": "Exception(\"Select query is not allowed in columns DEFAULT expression\", ErrorCodes::THERE_IS_NO_DEFAULT_VALUE)",
          "old_line_content": "        if (child->as<ASTSelectQuery>() || child->as<ASTSelectWithUnionQuery>() || child->as<ASTSubquery>())",
          "new_line_content": "            throw Exception(\"Select query is not allowed in columns DEFAULT expression\", ErrorCodes::THERE_IS_NO_DEFAULT_VALUE);",
          "content_same": false
        },
        {
          "line": 683,
          "old_api": "analyze",
          "new_api": "getActions",
          "old_text": "TreeRewriter(context).analyze(default_expr_list, all_columns, {}, {}, false, /* allow_self_aliases = */ false)",
          "new_text": "ExpressionAnalyzer(default_expr_list, syntax_analyzer_result, context).getActions(true)",
          "old_line_content": "        auto syntax_analyzer_result = TreeRewriter(context).analyze(default_expr_list, all_columns, {}, {}, false, /* allow_self_aliases = */ false);",
          "new_line_content": "        const auto actions = ExpressionAnalyzer(default_expr_list, syntax_analyzer_result, context).getActions(true);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 677,
          "old_api": null,
          "new_api": "child->as<ASTSubquery>()",
          "old_text": null,
          "new_text": "child->as<ASTSubquery>()",
          "old_line_content": "    for (const auto & child : default_expr_list->children)",
          "new_line_content": "        if (child->as<ASTSelectQuery>() || child->as<ASTSelectWithUnionQuery>() || child->as<ASTSubquery>())",
          "content_same": false
        },
        {
          "line": 682,
          "old_api": null,
          "new_api": "analyze",
          "old_text": null,
          "new_text": "TreeRewriter(context).analyze(default_expr_list, all_columns, {}, {}, false, /* allow_self_aliases = */ false)",
          "old_line_content": "    {",
          "new_line_content": "        auto syntax_analyzer_result = TreeRewriter(context).analyze(default_expr_list, all_columns, {}, {}, false, /* allow_self_aliases = */ false);",
          "content_same": false
        },
        {
          "line": 686,
          "old_api": null,
          "new_api": "Exception",
          "old_text": null,
          "new_text": "Exception(\"Unsupported default value that requires ARRAY JOIN action\", ErrorCodes::THERE_IS_NO_DEFAULT_VALUE)",
          "old_line_content": "            if (action.node->type == ActionsDAG::ActionType::ARRAY_JOIN)",
          "new_line_content": "                throw Exception(\"Unsupported default value that requires ARRAY JOIN action\", ErrorCodes::THERE_IS_NO_DEFAULT_VALUE);",
          "content_same": false
        },
        {
          "line": 688,
          "old_api": null,
          "new_api": "getSampleBlock",
          "old_text": null,
          "new_text": "actions->getSampleBlock()",
          "old_line_content": "",
          "new_line_content": "        return actions->getSampleBlock();",
          "content_same": false
        },
        {
          "line": 659,
          "old_api": null,
          "new_api": "has",
          "old_text": null,
          "new_text": "has(subcolumn.name)",
          "old_line_content": "",
          "new_line_content": "        if (has(subcolumn.name))",
          "content_same": false
        },
        {
          "line": 692,
          "old_api": null,
          "new_api": "addMessage",
          "old_text": null,
          "new_text": "ex.addMessage(\"default expression and column type are incompatible.\")",
          "old_line_content": "    {",
          "new_line_content": "        ex.addMessage(\"default expression and column type are incompatible.\");",
          "content_same": false
        },
        {
          "line": 663,
          "old_api": null,
          "new_api": "std::move(subcolumn)",
          "old_text": null,
          "new_text": "std::move(subcolumn)",
          "old_line_content": "",
          "new_line_content": "        subcolumns.get<0>().insert(std::move(subcolumn));",
          "content_same": false
        },
        {
          "line": 669,
          "old_api": null,
          "new_api": "equal_range",
          "old_text": null,
          "new_text": "subcolumns.get<1>().equal_range(name_in_storage)",
          "old_line_content": "{",
          "new_line_content": "    auto range = subcolumns.get<1>().equal_range(name_in_storage);",
          "content_same": false
        },
        {
          "line": 671,
          "old_api": null,
          "new_api": "erase",
          "old_text": null,
          "new_text": "subcolumns.get<1>().erase(range.first, range.second)",
          "old_line_content": "    if (range.first != range.second)",
          "new_line_content": "        subcolumns.get<1>().erase(range.first, range.second);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 672,
          "old_api": "erase",
          "new_api": null,
          "old_text": "subcolumns.get<1>().erase(range.first, range.second)",
          "new_text": null,
          "old_line_content": "        subcolumns.get<1>().erase(range.first, range.second);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 679,
          "old_api": "Exception",
          "new_api": null,
          "old_text": "Exception(\"Select query is not allowed in columns DEFAULT expression\", ErrorCodes::THERE_IS_NO_DEFAULT_VALUE)",
          "new_text": null,
          "old_line_content": "            throw Exception(\"Select query is not allowed in columns DEFAULT expression\", ErrorCodes::THERE_IS_NO_DEFAULT_VALUE);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 685,
          "old_api": "getActions",
          "new_api": null,
          "old_text": "actions->getActions()",
          "new_text": null,
          "old_line_content": "        for (const auto & action : actions->getActions())",
          "new_line_content": "            if (action.node->type == ActionsDAG::ActionType::ARRAY_JOIN)",
          "content_same": false
        },
        {
          "line": 687,
          "old_api": "Exception",
          "new_api": null,
          "old_text": "Exception(\"Unsupported default value that requires ARRAY JOIN action\", ErrorCodes::THERE_IS_NO_DEFAULT_VALUE)",
          "new_text": null,
          "old_line_content": "                throw Exception(\"Unsupported default value that requires ARRAY JOIN action\", ErrorCodes::THERE_IS_NO_DEFAULT_VALUE);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 689,
          "old_api": "getSampleBlock",
          "new_api": null,
          "old_text": "actions->getSampleBlock()",
          "new_text": null,
          "old_line_content": "        return actions->getSampleBlock();",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 658,
          "old_api": "getSubcolumnType",
          "new_api": null,
          "old_text": "type_in_storage->getSubcolumnType(subcolumn_name)",
          "new_text": null,
          "old_line_content": "            type_in_storage, type_in_storage->getSubcolumnType(subcolumn_name));",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 661,
          "old_api": "Exception",
          "new_api": null,
          "old_text": "Exception(ErrorCodes::ILLEGAL_COLUMN,\n                \"Cannot add subcolumn {}: column with this name already exists\", subcolumn.name)",
          "new_text": null,
          "old_line_content": "            throw Exception(ErrorCodes::ILLEGAL_COLUMN,",
          "new_line_content": "                \"Cannot add subcolumn {}: column with this name already exists\", subcolumn.name);",
          "content_same": false
        },
        {
          "line": 693,
          "old_api": "addMessage",
          "new_api": null,
          "old_text": "ex.addMessage(\"default expression and column type are incompatible.\")",
          "new_text": null,
          "old_line_content": "        ex.addMessage(\"default expression and column type are incompatible.\");",
          "new_line_content": "        throw;",
          "content_same": false
        },
        {
          "line": 670,
          "old_api": "equal_range",
          "new_api": null,
          "old_text": "subcolumns.get<1>().equal_range(name_in_storage)",
          "new_text": null,
          "old_line_content": "    auto range = subcolumns.get<1>().equal_range(name_in_storage);",
          "new_line_content": "    if (range.first != range.second)",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 6,
      "total_additions": 9,
      "total_deletions": 9,
      "total_api_changes": 24
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 5,
        "api_related_lines": 24,
        "non_api_lines": 1,
        "non_api_line_numbers": [
          665
        ]
      }
    },
    "api_calls_before": 278,
    "api_calls_after": 278,
    "diff_info": {
      "added_lines": 3,
      "removed_lines": 4,
      "total_diff_lines": 26
    }
  }
}