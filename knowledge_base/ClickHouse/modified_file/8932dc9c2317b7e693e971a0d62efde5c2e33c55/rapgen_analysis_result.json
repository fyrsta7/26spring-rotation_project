{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/8932dc9c2317b7e693e971a0d62efde5c2e33c55",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/8932dc9c2317b7e693e971a0d62efde5c2e33c55/before.h",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/8932dc9c2317b7e693e971a0d62efde5c2e33c55/after.h",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/8932dc9c2317b7e693e971a0d62efde5c2e33c55/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 319,
          "old_api": "get",
          "new_api": "getNullMapColumn",
          "old_text": "key_columns[i].get()",
          "new_text": "nullable_col.getNullMapColumn()",
          "old_line_content": "                observed_column = key_columns[i].get();",
          "new_line_content": "                null_map = static_cast<ColumnUInt8 *>(&nullable_col.getNullMapColumn());",
          "content_same": false
        },
        {
          "line": 379,
          "old_api": "deserializeAndInsertFromArena",
          "new_api": "getFirst",
          "old_text": "column->deserializeAndInsertFromArena(pos)",
          "new_text": "value.getFirst()",
          "old_line_content": "            pos = column->deserializeAndInsertFromArena(pos);",
          "new_line_content": "        auto pos = value.getFirst().data;",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 655,
          "old_api": null,
          "new_api": "APPLY_FOR_VARIANTS_CONVERTIBLE_TO_TWO_LEVEL",
          "old_text": null,
          "new_text": "APPLY_FOR_VARIANTS_CONVERTIBLE_TO_TWO_LEVEL(M)",
          "old_line_content": "        #undef M",
          "new_line_content": "            APPLY_FOR_VARIANTS_CONVERTIBLE_TO_TWO_LEVEL(M)",
          "content_same": false
        },
        {
          "line": 527,
          "old_api": null,
          "new_api": "back",
          "old_text": null,
          "new_text": "aggregates_pools.back().get()",
          "old_line_content": "    void invalidate() { type = Type::EMPTY; }",
          "new_line_content": "    AggregatedDataVariants() : aggregates_pools(1, std::make_shared<Arena>()), aggregates_pool(aggregates_pools.back().get()) {}",
          "content_same": false
        },
        {
          "line": 542,
          "old_api": null,
          "new_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "old_text": null,
          "new_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "old_line_content": "        }",
          "new_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "content_same": false
        },
        {
          "line": 1199,
          "old_api": null,
          "new_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "old_text": null,
          "new_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "old_line_content": "#undef M",
          "new_line_content": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "content_same": false
        },
        {
          "line": 559,
          "old_api": null,
          "new_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "old_text": null,
          "new_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "old_line_content": "        }",
          "new_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "content_same": false
        },
        {
          "line": 563,
          "old_api": null,
          "new_api": "__builtin_unreachable",
          "old_text": null,
          "new_text": "__builtin_unreachable()",
          "old_line_content": "",
          "new_line_content": "        __builtin_unreachable();",
          "content_same": false
        },
        {
          "line": 947,
          "old_api": null,
          "new_api": "Logger::get(\"Aggregator\")",
          "old_text": null,
          "new_text": "Logger::get(\"Aggregator\")",
          "old_line_content": "    /** Dynamically compiled library for aggregation, if any.",
          "new_line_content": "    Logger * log = &Logger::get(\"Aggregator\");",
          "content_same": false
        },
        {
          "line": 312,
          "old_api": null,
          "new_api": "isColumnNullable",
          "old_text": null,
          "new_text": "isColumnNullable(*key_columns[i])",
          "old_line_content": "            {",
          "new_line_content": "                column_nullable = isColumnNullable(*key_columns[i]);",
          "content_same": false
        },
        {
          "line": 317,
          "old_api": null,
          "new_api": "static_cast<ColumnNullable &>(*key_columns[i])",
          "old_text": null,
          "new_text": "static_cast<ColumnNullable &>(*key_columns[i])",
          "old_line_content": "            else",
          "new_line_content": "                ColumnNullable & nullable_col = static_cast<ColumnNullable &>(*key_columns[i]);",
          "content_same": false
        },
        {
          "line": 318,
          "old_api": null,
          "new_api": "getNestedColumn",
          "old_text": null,
          "new_text": "nullable_col.getNestedColumn()",
          "old_line_content": "            {",
          "new_line_content": "                observed_column = &nullable_col.getNestedColumn();",
          "content_same": false
        },
        {
          "line": 576,
          "old_api": null,
          "new_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "old_text": null,
          "new_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "old_line_content": "        }",
          "new_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "content_same": false
        },
        {
          "line": 705,
          "old_api": null,
          "new_api": "APPLY_FOR_LOW_CARDINALITY_VARIANTS",
          "old_text": null,
          "new_text": "APPLY_FOR_LOW_CARDINALITY_VARIANTS(M)",
          "old_line_content": "            default:",
          "new_line_content": "            APPLY_FOR_LOW_CARDINALITY_VARIANTS(M)",
          "content_same": false
        },
        {
          "line": 323,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "key_columns[i].get()",
          "old_line_content": "            bool is_null;",
          "new_line_content": "                observed_column = key_columns[i].get();",
          "content_same": false
        },
        {
          "line": 580,
          "old_api": null,
          "new_api": "__builtin_unreachable",
          "old_text": null,
          "new_text": "__builtin_unreachable()",
          "old_line_content": "",
          "new_line_content": "        __builtin_unreachable();",
          "content_same": false
        },
        {
          "line": 334,
          "old_api": null,
          "new_api": "getFirst",
          "old_text": null,
          "new_text": "value.getFirst()",
          "old_line_content": "            else",
          "new_line_content": "                UInt8 val = (reinterpret_cast<const UInt8 *>(&value.getFirst())[bucket] >> offset) & 1;",
          "content_same": false
        },
        {
          "line": 335,
          "old_api": null,
          "new_api": "insertValue",
          "old_text": null,
          "new_text": "null_map->insertValue(val)",
          "old_line_content": "                is_null = false;",
          "new_line_content": "                null_map->insertValue(val);",
          "content_same": false
        },
        {
          "line": 592,
          "old_api": null,
          "new_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "old_text": null,
          "new_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "old_line_content": "        }",
          "new_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "content_same": false
        },
        {
          "line": 340,
          "old_api": null,
          "new_api": "insertDefault",
          "old_text": null,
          "new_text": "observed_column->insertDefault()",
          "old_line_content": "            {",
          "new_line_content": "                observed_column->insertDefault();",
          "content_same": false
        },
        {
          "line": 596,
          "old_api": null,
          "new_api": "__builtin_unreachable",
          "old_text": null,
          "new_text": "__builtin_unreachable()",
          "old_line_content": "",
          "new_line_content": "        __builtin_unreachable();",
          "content_same": false
        },
        {
          "line": 726,
          "old_api": null,
          "new_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "old_text": null,
          "new_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "old_line_content": "",
          "new_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "content_same": false
        },
        {
          "line": 344,
          "old_api": null,
          "new_api": "getFirst",
          "old_text": null,
          "new_text": "value.getFirst()",
          "old_line_content": "            }",
          "new_line_content": "                observed_column->insertData(reinterpret_cast<const char *>(&value.getFirst()) + pos, size);",
          "content_same": false
        },
        {
          "line": 730,
          "old_api": null,
          "new_api": "Exception",
          "old_text": null,
          "new_text": "Exception(\"Unknown aggregated data variant.\", ErrorCodes::UNKNOWN_AGGREGATED_DATA_VARIANT)",
          "old_line_content": "    }",
          "new_line_content": "                throw Exception(\"Unknown aggregated data variant.\", ErrorCodes::UNKNOWN_AGGREGATED_DATA_VARIANT);",
          "content_same": false
        },
        {
          "line": 608,
          "old_api": null,
          "new_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "old_text": null,
          "new_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "old_line_content": "        }",
          "new_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "content_same": false
        },
        {
          "line": 612,
          "old_api": null,
          "new_api": "__builtin_unreachable",
          "old_text": null,
          "new_text": "__builtin_unreachable()",
          "old_line_content": "",
          "new_line_content": "        __builtin_unreachable();",
          "content_same": false
        },
        {
          "line": 880,
          "old_api": null,
          "new_api": "empty",
          "old_text": null,
          "new_text": "temporary_files.empty()",
          "old_line_content": "    struct TemporaryFiles",
          "new_line_content": "    bool hasTemporaryFiles() const { return !temporary_files.empty(); }",
          "content_same": false
        },
        {
          "line": 381,
          "old_api": null,
          "new_api": "deserializeAndInsertFromArena",
          "old_text": null,
          "new_text": "column->deserializeAndInsertFromArena(pos)",
          "old_line_content": "};",
          "new_line_content": "            pos = column->deserializeAndInsertFromArena(pos);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 525,
          "old_api": "back",
          "new_api": null,
          "old_text": "aggregates_pools.back().get()",
          "new_text": null,
          "old_line_content": "    AggregatedDataVariants() : aggregates_pools(1, std::make_shared<Arena>()), aggregates_pool(aggregates_pools.back().get()) {}",
          "new_line_content": "    Type type = Type::EMPTY;",
          "content_same": false
        },
        {
          "line": 653,
          "old_api": "APPLY_FOR_VARIANTS_CONVERTIBLE_TO_TWO_LEVEL",
          "new_api": null,
          "old_text": "APPLY_FOR_VARIANTS_CONVERTIBLE_TO_TWO_LEVEL(M)",
          "new_text": null,
          "old_line_content": "            APPLY_FOR_VARIANTS_CONVERTIBLE_TO_TWO_LEVEL(M)",
          "new_line_content": "            case Type::NAME: return true;",
          "content_same": false
        },
        {
          "line": 540,
          "old_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "new_api": null,
          "old_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_text": null,
          "old_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_line_content": "        #define M(NAME, IS_TWO_LEVEL) \\",
          "content_same": false
        },
        {
          "line": 557,
          "old_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "new_api": null,
          "old_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_text": null,
          "old_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_line_content": "        #define M(NAME, IS_TWO_LEVEL) \\",
          "content_same": false
        },
        {
          "line": 1197,
          "old_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "new_api": null,
          "old_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_text": null,
          "old_line_content": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_line_content": "    template <> inline decltype(AggregatedDataVariants::NAME)::element_type & getDataVariant<decltype(AggregatedDataVariants::NAME)::element_type>(AggregatedDataVariants & variants) { return *variants.NAME; }",
          "content_same": false
        },
        {
          "line": 561,
          "old_api": "__builtin_unreachable",
          "new_api": null,
          "old_text": "__builtin_unreachable()",
          "new_text": null,
          "old_line_content": "        __builtin_unreachable();",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 945,
          "old_api": "Logger::get(\"Aggregator\")",
          "new_api": null,
          "old_text": "Logger::get(\"Aggregator\")",
          "new_text": null,
          "old_line_content": "    Logger * log = &Logger::get(\"Aggregator\");",
          "new_line_content": "    std::mutex mutex;",
          "content_same": false
        },
        {
          "line": 311,
          "old_api": "isColumnNullable",
          "new_api": null,
          "old_text": "isColumnNullable(*key_columns[i])",
          "new_text": null,
          "old_line_content": "            if (has_nullable_keys && isColumnNullable(*key_columns[i]))",
          "new_line_content": "            if constexpr (has_nullable_keys)",
          "content_same": false
        },
        {
          "line": 313,
          "old_api": "static_cast<ColumnNullable &>(*key_columns[i])",
          "new_api": null,
          "old_text": "static_cast<ColumnNullable &>(*key_columns[i])",
          "new_text": null,
          "old_line_content": "                ColumnNullable & nullable_col = static_cast<ColumnNullable &>(*key_columns[i]);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 314,
          "old_api": "getNestedColumn",
          "new_api": null,
          "old_text": "nullable_col.getNestedColumn()",
          "new_text": null,
          "old_line_content": "                observed_column = &nullable_col.getNestedColumn();",
          "new_line_content": "            /// If we have a nullable column, get its nested column and its null map.",
          "content_same": false
        },
        {
          "line": 315,
          "old_api": "getNullMapColumn",
          "new_api": null,
          "old_text": "nullable_col.getNullMapColumn()",
          "new_text": null,
          "old_line_content": "                null_map = static_cast<ColumnUInt8 *>(&nullable_col.getNullMapColumn());",
          "new_line_content": "            if (column_nullable)",
          "content_same": false
        },
        {
          "line": 574,
          "old_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "new_api": null,
          "old_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_text": null,
          "old_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_line_content": "            #define M(NAME, IS_TWO_LEVEL) \\",
          "content_same": false
        },
        {
          "line": 703,
          "old_api": "APPLY_FOR_LOW_CARDINALITY_VARIANTS",
          "new_api": null,
          "old_text": "APPLY_FOR_LOW_CARDINALITY_VARIANTS(M)",
          "new_text": null,
          "old_line_content": "            APPLY_FOR_LOW_CARDINALITY_VARIANTS(M)",
          "new_line_content": "            case Type::NAME: return true;",
          "content_same": false
        },
        {
          "line": 578,
          "old_api": "__builtin_unreachable",
          "new_api": null,
          "old_text": "__builtin_unreachable()",
          "new_text": null,
          "old_line_content": "        __builtin_unreachable();",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 324,
          "old_api": "isColumnNullable",
          "new_api": null,
          "old_text": "isColumnNullable(*key_columns[i])",
          "new_text": null,
          "old_line_content": "            if (has_nullable_keys && isColumnNullable(*key_columns[i]))",
          "new_line_content": "                null_map = nullptr;",
          "content_same": false
        },
        {
          "line": 330,
          "old_api": "getFirst",
          "new_api": null,
          "old_text": "value.getFirst()",
          "new_text": null,
          "old_line_content": "                UInt8 val = (reinterpret_cast<const UInt8 *>(&value.getFirst())[bucket] >> offset) & 1;",
          "new_line_content": "                /// The current column is nullable. Check if the value of the",
          "content_same": false
        },
        {
          "line": 331,
          "old_api": "insertValue",
          "new_api": null,
          "old_text": "null_map->insertValue(val)",
          "new_text": null,
          "old_line_content": "                null_map->insertValue(val);",
          "new_line_content": "                /// corresponding key is nullable. Update the null map accordingly.",
          "content_same": false
        },
        {
          "line": 590,
          "old_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "new_api": null,
          "old_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_text": null,
          "old_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_line_content": "        #define M(NAME, IS_TWO_LEVEL) \\",
          "content_same": false
        },
        {
          "line": 338,
          "old_api": "insertDefault",
          "new_api": null,
          "old_text": "observed_column->insertDefault()",
          "new_text": null,
          "old_line_content": "                observed_column->insertDefault();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 594,
          "old_api": "__builtin_unreachable",
          "new_api": null,
          "old_text": "__builtin_unreachable()",
          "new_text": null,
          "old_line_content": "        __builtin_unreachable();",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 724,
          "old_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "new_api": null,
          "old_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_text": null,
          "old_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_line_content": "            }",
          "content_same": false
        },
        {
          "line": 342,
          "old_api": "getFirst",
          "new_api": null,
          "old_text": "value.getFirst()",
          "new_text": null,
          "old_line_content": "                observed_column->insertData(reinterpret_cast<const char *>(&value.getFirst()) + pos, size);",
          "new_line_content": "            {",
          "content_same": false
        },
        {
          "line": 728,
          "old_api": "Exception",
          "new_api": null,
          "old_text": "Exception(\"Unknown aggregated data variant.\", ErrorCodes::UNKNOWN_AGGREGATED_DATA_VARIANT)",
          "new_text": null,
          "old_line_content": "                throw Exception(\"Unknown aggregated data variant.\", ErrorCodes::UNKNOWN_AGGREGATED_DATA_VARIANT);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 606,
          "old_api": "APPLY_FOR_AGGREGATED_VARIANTS",
          "new_api": null,
          "old_text": "APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_text": null,
          "old_line_content": "            APPLY_FOR_AGGREGATED_VARIANTS(M)",
          "new_line_content": "        #define M(NAME, IS_TWO_LEVEL) \\",
          "content_same": false
        },
        {
          "line": 610,
          "old_api": "__builtin_unreachable",
          "new_api": null,
          "old_text": "__builtin_unreachable()",
          "new_text": null,
          "old_line_content": "        __builtin_unreachable();",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 878,
          "old_api": "empty",
          "new_api": null,
          "old_text": "temporary_files.empty()",
          "new_text": null,
          "old_line_content": "    bool hasTemporaryFiles() const { return !temporary_files.empty(); }",
          "new_line_content": "    void writeToTemporaryFile(AggregatedDataVariants & data_variants);",
          "content_same": false
        },
        {
          "line": 377,
          "old_api": "getFirst",
          "new_api": null,
          "old_text": "value.getFirst()",
          "new_text": null,
          "old_line_content": "        auto pos = value.getFirst().data;",
          "new_line_content": "    static void insertKeyIntoColumns(const typename Data::value_type & value, MutableColumns & key_columns, const Sizes &)",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 2,
      "total_additions": 26,
      "total_deletions": 27,
      "total_api_changes": 55
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 11,
        "api_related_lines": 55,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          328,
          310,
          327
        ]
      }
    },
    "api_calls_before": 68,
    "api_calls_after": 67,
    "diff_info": {
      "added_lines": 7,
      "removed_lines": 5,
      "total_diff_lines": 39
    }
  }
}