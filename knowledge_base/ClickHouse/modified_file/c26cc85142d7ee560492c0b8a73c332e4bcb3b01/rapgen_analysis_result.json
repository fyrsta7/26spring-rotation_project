{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/c26cc85142d7ee560492c0b8a73c332e4bcb3b01",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/c26cc85142d7ee560492c0b8a73c332e4bcb3b01/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/c26cc85142d7ee560492c0b8a73c332e4bcb3b01/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/c26cc85142d7ee560492c0b8a73c332e4bcb3b01/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 550,
          "old_api": "LOG_TRACE",
          "new_api": "executeStepImpl",
          "old_text": "LOG_TRACE(log, \"Thread finished. Total time: {} sec. Execution time: {} sec. Processing time: {} sec. Wait time: {} sec.\", (context->total_time_ns / 1e9), (context->execution_time_ns / 1e9), (context->processing_time_ns / 1e9), (context->wait_time_ns / 1e9))",
          "new_text": "executeStepImpl(thread_num, num_threads)",
          "old_line_content": "    LOG_TRACE(log, \"Thread finished. Total time: {} sec. Execution time: {} sec. Processing time: {} sec. Wait time: {} sec.\", (context->total_time_ns / 1e9), (context->execution_time_ns / 1e9), (context->processing_time_ns / 1e9), (context->wait_time_ns / 1e9));",
          "new_line_content": "    executeStepImpl(thread_num, num_threads);",
          "content_same": false
        },
        {
          "line": 579,
          "old_api": "getAnyThreadWithTasks",
          "new_api": "pop",
          "old_text": "task_queue.getAnyThreadWithTasks(thread_num + 1 == num_threads ? 0 : (thread_num + 1))",
          "new_text": "task_queue.pop(thread_num)",
          "old_line_content": "                        auto thread_to_wake = task_queue.getAnyThreadWithTasks(thread_num + 1 == num_threads ? 0 : (thread_num + 1));",
          "new_line_content": "                    state = task_queue.pop(thread_num);",
          "content_same": false
        },
        {
          "line": 581,
          "old_api": "has",
          "new_api": "empty",
          "old_text": "threads_queue.has(thread_to_wake)",
          "new_text": "threads_queue.empty()",
          "old_line_content": "                        if (threads_queue.has(thread_to_wake))",
          "new_line_content": "                    if (!task_queue.empty() && !threads_queue.empty() /*&& task_queue.quota() > threads_queue.size()*/)",
          "content_same": false
        },
        {
          "line": 586,
          "old_api": "unlock",
          "new_api": "pop",
          "old_text": "lock.unlock()",
          "new_text": "threads_queue.pop(thread_to_wake)",
          "old_line_content": "                        lock.unlock();",
          "new_line_content": "                            threads_queue.pop(thread_to_wake);",
          "content_same": false
        },
        {
          "line": 600,
          "old_api": "push",
          "new_api": "finish",
          "old_text": "threads_queue.push(thread_num)",
          "new_text": "finish()",
          "old_line_content": "                threads_queue.push(thread_num);",
          "new_line_content": "                    finish();",
          "content_same": false
        },
        {
          "line": 657,
          "old_api": "std::unique_lock<std::mutex>(*graph[state->processors_id].status_mutex)",
          "new_api": "doExpandPipeline",
          "old_text": "std::unique_lock<std::mutex>(*graph[state->processors_id].status_mutex)",
          "new_text": "doExpandPipeline(task, true)",
          "old_line_content": "                    auto lock = std::unique_lock<std::mutex>(*graph[state->processors_id].status_mutex);",
          "new_line_content": "                    doExpandPipeline(task, true);",
          "content_same": false
        },
        {
          "line": 672,
          "old_api": "empty",
          "new_api": "pop",
          "old_text": "queue.empty()",
          "new_text": "queue.pop()",
          "old_line_content": "                if (!queue.empty())",
          "new_line_content": "                    queue.pop();",
          "content_same": false
        },
        {
          "line": 682,
          "old_api": "empty",
          "new_api": "front",
          "old_text": "threads_queue.empty()",
          "new_text": "queue.front()",
          "old_line_content": "                    if (!threads_queue.empty() && !finished /* && task_queue.quota() > threads_queue.size()*/)",
          "new_line_content": "                        task_queue.push(queue.front(), thread_num);",
          "content_same": false
        },
        {
          "line": 686,
          "old_api": "has",
          "new_api": "empty",
          "old_text": "threads_queue.has(thread_to_wake)",
          "new_text": "threads_queue.empty()",
          "old_line_content": "                        if (threads_queue.has(thread_to_wake))",
          "new_line_content": "                    if (!threads_queue.empty() && !finished /* && task_queue.quota() > threads_queue.size()*/)",
          "content_same": false
        },
        {
          "line": 691,
          "old_api": "unlock",
          "new_api": "pop",
          "old_text": "lock.unlock()",
          "new_text": "threads_queue.pop(thread_to_wake)",
          "old_line_content": "                        lock.unlock();",
          "new_line_content": "                            threads_queue.pop(thread_to_wake);",
          "content_same": false
        },
        {
          "line": 693,
          "old_api": "wakeUpExecutor",
          "new_api": "pop_any",
          "old_text": "wakeUpExecutor(thread_to_wake)",
          "new_text": "threads_queue.pop_any()",
          "old_line_content": "                        wakeUpExecutor(thread_to_wake);",
          "new_line_content": "                            thread_to_wake = threads_queue.pop_any();",
          "content_same": false
        },
        {
          "line": 703,
          "old_api": "elapsed",
          "new_api": "doExpandPipeline",
          "old_text": "processing_time_watch.elapsed()",
          "new_text": "doExpandPipeline(task, false)",
          "old_line_content": "            context->processing_time_ns += processing_time_watch.elapsed();",
          "new_line_content": "                    doExpandPipeline(task, false);",
          "content_same": false
        },
        {
          "line": 734,
          "old_api": "addChildlessProcessorsToStack",
          "new_api": "std::make_unique<ExecutorContext>()",
          "old_text": "addChildlessProcessorsToStack(stack)",
          "new_text": "std::make_unique<ExecutorContext>()",
          "old_line_content": "    addChildlessProcessorsToStack(stack);",
          "new_line_content": "            executor_contexts.emplace_back(std::make_unique<ExecutorContext>());",
          "content_same": false
        },
        {
          "line": 749,
          "old_api": "empty",
          "new_api": "pop",
          "old_text": "queue.empty()",
          "new_text": "stack.pop()",
          "old_line_content": "            while (!queue.empty())",
          "new_line_content": "            stack.pop();",
          "content_same": false
        },
        {
          "line": 751,
          "old_api": "front",
          "new_api": "std::unique_lock<std::mutex>(*graph[proc].status_mutex)",
          "old_text": "queue.front()",
          "new_text": "std::unique_lock<std::mutex>(*graph[proc].status_mutex)",
          "old_line_content": "                task_queue.push(queue.front(), next_thread);",
          "new_line_content": "            prepareProcessor(proc, 0, queue, std::unique_lock<std::mutex>(*graph[proc].status_mutex));",
          "content_same": false
        },
        {
          "line": 768,
          "old_api": "reserve",
          "new_api": "initializeExecution",
          "old_text": "threads.reserve(num_threads)",
          "new_text": "initializeExecution(num_threads)",
          "old_line_content": "    threads.reserve(num_threads);",
          "new_line_content": "    initializeExecution(num_threads);",
          "content_same": false
        },
        {
          "line": 772,
          "old_api": "joinable",
          "new_api": "reserve",
          "old_text": "SCOPE_EXIT(\n        if (!finished_flag)\n        {\n            finish();\n\n            for (auto & thread : threads)\n                if (thread.joinable())\n                    thread.join();\n        }\n    )",
          "new_text": "threads.reserve(num_threads)",
          "old_line_content": "    SCOPE_EXIT(",
          "new_line_content": "    threads.reserve(num_threads);",
          "content_same": false
        },
        {
          "line": 779,
          "old_api": "join",
          "new_api": "finish",
          "old_text": "thread.join()",
          "new_text": "finish()",
          "old_line_content": "                    thread.join();",
          "new_line_content": "            finish();",
          "content_same": false
        },
        {
          "line": 789,
          "old_api": "emplace_back",
          "new_api": "CurrentThread::getGroup()",
          "old_text": "threads.emplace_back([this, thread_group, thread_num = i, num_threads]\n            {\n                /// ThreadStatus thread_status;\n\n                setThreadName(\"QueryPipelineEx\");\n\n                if (thread_group)\n                    CurrentThread::attachTo(thread_group);\n\n                SCOPE_EXIT(\n                        if (thread_group)\n                            CurrentThread::detachQueryIfNotDetached();\n                );\n\n                executeSingleThread(thread_num, num_threads);\n            })",
          "new_text": "CurrentThread::getGroup()",
          "old_line_content": "            threads.emplace_back([this, thread_group, thread_num = i, num_threads]",
          "new_line_content": "        auto thread_group = CurrentThread::getGroup();",
          "content_same": false
        },
        {
          "line": 793,
          "old_api": "setThreadName",
          "new_api": "emplace_back",
          "old_text": "setThreadName(\"QueryPipelineEx\")",
          "new_text": "threads.emplace_back([this, thread_group, thread_num = i, num_threads]\n            {\n                /// ThreadStatus thread_status;\n\n                setThreadName(\"QueryPipelineEx\");\n\n                if (thread_group)\n                    CurrentThread::attachTo(thread_group);\n\n                SCOPE_EXIT(\n                        if (thread_group)\n                            CurrentThread::detachQueryIfNotDetached();\n                );\n\n                executeSingleThread(thread_num, num_threads);\n            })",
          "old_line_content": "                setThreadName(\"QueryPipelineEx\");",
          "new_line_content": "            threads.emplace_back([this, thread_group, thread_num = i, num_threads]",
          "content_same": false
        },
        {
          "line": 800,
          "old_api": "CurrentThread::detachQueryIfNotDetached()",
          "new_api": "CurrentThread::attachTo(thread_group)",
          "old_text": "CurrentThread::detachQueryIfNotDetached()",
          "new_text": "CurrentThread::attachTo(thread_group)",
          "old_line_content": "                            CurrentThread::detachQueryIfNotDetached();",
          "new_line_content": "                    CurrentThread::attachTo(thread_group);",
          "content_same": false
        },
        {
          "line": 812,
          "old_api": "executeSingleThread",
          "new_api": "joinable",
          "old_text": "executeSingleThread(0, num_threads)",
          "new_text": "thread.joinable()",
          "old_line_content": "        executeSingleThread(0, num_threads);",
          "new_line_content": "            if (thread.joinable())",
          "content_same": false
        },
        {
          "line": 843,
          "old_api": "emplace_back",
          "new_api": "size",
          "old_text": "proc_list.emplace_back(proc.processor)",
          "new_text": "graph.size()",
          "old_line_content": "        proc_list.emplace_back(proc.processor);",
          "new_line_content": "    proc_list.reserve(graph.size());",
          "content_same": false
        },
        {
          "line": 848,
          "old_api": "printPipeline",
          "new_api": "emplace_back",
          "old_text": "printPipeline(processors, statuses, out)",
          "new_text": "statuses.emplace_back(proc.last_processor_status)",
          "old_line_content": "    printPipeline(processors, statuses, out);",
          "new_line_content": "        statuses.emplace_back(proc.last_processor_status);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 642,
          "old_api": null,
          "new_api": "finish",
          "old_text": null,
          "new_text": "finish()",
          "old_line_content": "",
          "new_line_content": "                finish();",
          "content_same": false
        },
        {
          "line": 776,
          "old_api": null,
          "new_api": "joinable",
          "old_text": null,
          "new_text": "SCOPE_EXIT(\n        if (!finished_flag)\n        {\n            finish();\n\n            for (auto & thread : threads)\n                if (thread.joinable())\n                    thread.join();\n        }\n    )",
          "old_line_content": "",
          "new_line_content": "    SCOPE_EXIT(",
          "content_same": false
        },
        {
          "line": 782,
          "old_api": null,
          "new_api": "joinable",
          "old_text": null,
          "new_text": "thread.joinable()",
          "old_line_content": "",
          "new_line_content": "                if (thread.joinable())",
          "content_same": false
        },
        {
          "line": 783,
          "old_api": null,
          "new_api": "join",
          "old_text": null,
          "new_text": "thread.join()",
          "old_line_content": "    if (num_threads > 1)",
          "new_line_content": "                    thread.join();",
          "content_same": false
        },
        {
          "line": 656,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "expand_pipeline_task.load()",
          "old_line_content": "                {",
          "new_line_content": "                while (auto * task = expand_pipeline_task.load())",
          "content_same": false
        },
        {
          "line": 661,
          "old_api": null,
          "new_api": "std::unique_lock<std::mutex>(*graph[state->processors_id].status_mutex)",
          "old_text": null,
          "new_text": "std::unique_lock<std::mutex>(*graph[state->processors_id].status_mutex)",
          "old_line_content": "",
          "new_line_content": "                    auto lock = std::unique_lock<std::mutex>(*graph[state->processors_id].status_mutex);",
          "content_same": false
        },
        {
          "line": 662,
          "old_api": null,
          "new_api": "std::move(lock)",
          "old_text": null,
          "new_text": "std::move(lock)",
          "old_line_content": "                state = nullptr;",
          "new_line_content": "                    if (!prepareProcessor(state->processors_id, thread_num, queue, std::move(lock)))",
          "content_same": false
        },
        {
          "line": 663,
          "old_api": null,
          "new_api": "finish",
          "old_text": null,
          "new_text": "finish()",
          "old_line_content": "",
          "new_line_content": "                        finish();",
          "content_same": false
        },
        {
          "line": 538,
          "old_api": null,
          "new_api": "dumpPipeline",
          "old_text": null,
          "new_text": "dumpPipeline()",
          "old_line_content": "{",
          "new_line_content": "        throw Exception(\"Pipeline stuck. Current state:\\n\" + dumpPipeline(), ErrorCodes::LOGICAL_ERROR);",
          "content_same": false
        },
        {
          "line": 669,
          "old_api": null,
          "new_api": "empty",
          "old_text": null,
          "new_text": "queue.empty()",
          "old_line_content": "                }",
          "new_line_content": "                if (!queue.empty())",
          "content_same": false
        },
        {
          "line": 797,
          "old_api": null,
          "new_api": "setThreadName",
          "old_text": null,
          "new_text": "setThreadName(\"QueryPipelineEx\")",
          "old_line_content": "",
          "new_line_content": "                setThreadName(\"QueryPipelineEx\");",
          "content_same": false
        },
        {
          "line": 671,
          "old_api": null,
          "new_api": "front",
          "old_text": null,
          "new_text": "queue.front()",
          "old_line_content": "                /// Push other tasks to global queue.",
          "new_line_content": "                    state = queue.front();",
          "content_same": false
        },
        {
          "line": 545,
          "old_api": null,
          "new_api": "notify_one",
          "old_text": null,
          "new_text": "executor_contexts[thread_num]->condvar.notify_one()",
          "old_line_content": "{",
          "new_line_content": "    executor_contexts[thread_num]->condvar.notify_one();",
          "content_same": false
        },
        {
          "line": 802,
          "old_api": null,
          "new_api": "SCOPE_EXIT",
          "old_text": null,
          "new_text": "SCOPE_EXIT(\n                        if (thread_group)\n                            CurrentThread::detachQueryIfNotDetached();\n                )",
          "old_line_content": "",
          "new_line_content": "                SCOPE_EXIT(",
          "content_same": false
        },
        {
          "line": 804,
          "old_api": null,
          "new_api": "CurrentThread::detachQueryIfNotDetached()",
          "old_text": null,
          "new_text": "CurrentThread::detachQueryIfNotDetached()",
          "old_line_content": "            });",
          "new_line_content": "                            CurrentThread::detachQueryIfNotDetached();",
          "content_same": false
        },
        {
          "line": 807,
          "old_api": null,
          "new_api": "executeSingleThread",
          "old_text": null,
          "new_text": "executeSingleThread(thread_num, num_threads)",
          "old_line_content": "        for (auto & thread : threads)",
          "new_line_content": "                executeSingleThread(thread_num, num_threads);",
          "content_same": false
        },
        {
          "line": 680,
          "old_api": null,
          "new_api": "empty",
          "old_text": null,
          "new_text": "queue.empty()",
          "old_line_content": "                    }",
          "new_line_content": "                    while (!queue.empty() && !finished)",
          "content_same": false
        },
        {
          "line": 554,
          "old_api": null,
          "new_api": "LOG_TRACE",
          "old_text": null,
          "new_text": "LOG_TRACE(log, \"Thread finished. Total time: {} sec. Execution time: {} sec. Processing time: {} sec. Wait time: {} sec.\", (context->total_time_ns / 1e9), (context->execution_time_ns / 1e9), (context->processing_time_ns / 1e9), (context->wait_time_ns / 1e9))",
          "old_line_content": "void PipelineExecutor::executeStepImpl(size_t thread_num, size_t num_threads, std::atomic_bool * yield_flag)",
          "new_line_content": "    LOG_TRACE(log, \"Thread finished. Total time: {} sec. Execution time: {} sec. Processing time: {} sec. Wait time: {} sec.\", (context->total_time_ns / 1e9), (context->execution_time_ns / 1e9), (context->processing_time_ns / 1e9), (context->wait_time_ns / 1e9));",
          "content_same": false
        },
        {
          "line": 683,
          "old_api": null,
          "new_api": "pop",
          "old_text": null,
          "new_text": "queue.pop()",
          "old_line_content": "                    {",
          "new_line_content": "                        queue.pop();",
          "content_same": false
        },
        {
          "line": 813,
          "old_api": null,
          "new_api": "join",
          "old_text": null,
          "new_text": "thread.join()",
          "old_line_content": "",
          "new_line_content": "                thread.join();",
          "content_same": false
        },
        {
          "line": 688,
          "old_api": null,
          "new_api": "getAnyThreadWithTasks",
          "old_text": null,
          "new_text": "task_queue.getAnyThreadWithTasks(thread_num + 1 == num_threads ? 0 : (thread_num + 1))",
          "old_line_content": "                        else",
          "new_line_content": "                        auto thread_to_wake = task_queue.getAnyThreadWithTasks(thread_num + 1 == num_threads ? 0 : (thread_num + 1));",
          "content_same": false
        },
        {
          "line": 816,
          "old_api": null,
          "new_api": "executeSingleThread",
          "old_text": null,
          "new_text": "executeSingleThread(0, num_threads)",
          "old_line_content": "",
          "new_line_content": "        executeSingleThread(0, num_threads);",
          "content_same": false
        },
        {
          "line": 690,
          "old_api": null,
          "new_api": "has",
          "old_text": null,
          "new_text": "threads_queue.has(thread_to_wake)",
          "old_line_content": "",
          "new_line_content": "                        if (threads_queue.has(thread_to_wake))",
          "content_same": false
        },
        {
          "line": 695,
          "old_api": null,
          "new_api": "unlock",
          "old_text": null,
          "new_text": "lock.unlock()",
          "old_line_content": "                }",
          "new_line_content": "                        lock.unlock();",
          "content_same": false
        },
        {
          "line": 697,
          "old_api": null,
          "new_api": "wakeUpExecutor",
          "old_text": null,
          "new_text": "wakeUpExecutor(thread_to_wake)",
          "old_line_content": "                --num_processing_executors;",
          "new_line_content": "                        wakeUpExecutor(thread_to_wake);",
          "content_same": false
        },
        {
          "line": 702,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "expand_pipeline_task.load()",
          "old_line_content": "#ifndef NDEBUG",
          "new_line_content": "                while (auto * task = expand_pipeline_task.load())",
          "content_same": false
        },
        {
          "line": 707,
          "old_api": null,
          "new_api": "elapsed",
          "old_text": null,
          "new_text": "processing_time_watch.elapsed()",
          "old_line_content": "            if (yield_flag && *yield_flag)",
          "new_line_content": "            context->processing_time_ns += processing_time_watch.elapsed();",
          "content_same": false
        },
        {
          "line": 836,
          "old_api": null,
          "new_api": "str",
          "old_text": null,
          "new_text": "buffer.str()",
          "old_line_content": "    std::vector<IProcessor::Status> statuses;",
          "new_line_content": "            node.processor->setDescription(buffer.str());",
          "content_same": false
        },
        {
          "line": 583,
          "old_api": null,
          "new_api": "getAnyThreadWithTasks",
          "old_text": null,
          "new_text": "task_queue.getAnyThreadWithTasks(thread_num + 1 == num_threads ? 0 : (thread_num + 1))",
          "old_line_content": "                        else",
          "new_line_content": "                        auto thread_to_wake = task_queue.getAnyThreadWithTasks(thread_num + 1 == num_threads ? 0 : (thread_num + 1));",
          "content_same": false
        },
        {
          "line": 585,
          "old_api": null,
          "new_api": "has",
          "old_text": null,
          "new_text": "threads_queue.has(thread_to_wake)",
          "old_line_content": "",
          "new_line_content": "                        if (threads_queue.has(thread_to_wake))",
          "content_same": false
        },
        {
          "line": 842,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "graph.size()",
          "old_line_content": "    {",
          "new_line_content": "    statuses.reserve(graph.size());",
          "content_same": false
        },
        {
          "line": 588,
          "old_api": null,
          "new_api": "pop_any",
          "old_text": null,
          "new_text": "threads_queue.pop_any()",
          "old_line_content": "                    }",
          "new_line_content": "                            thread_to_wake = threads_queue.pop_any();",
          "content_same": false
        },
        {
          "line": 717,
          "old_api": null,
          "new_api": "elapsed",
          "old_text": null,
          "new_text": "total_time_watch.elapsed()",
          "old_line_content": "",
          "new_line_content": "    context->total_time_ns += total_time_watch.elapsed();",
          "content_same": false
        },
        {
          "line": 590,
          "old_api": null,
          "new_api": "unlock",
          "old_text": null,
          "new_text": "lock.unlock()",
          "old_line_content": "                    break;",
          "new_line_content": "                        lock.unlock();",
          "content_same": false
        },
        {
          "line": 591,
          "old_api": null,
          "new_api": "wakeUpExecutor",
          "old_text": null,
          "new_text": "wakeUpExecutor(thread_to_wake)",
          "old_line_content": "                }",
          "new_line_content": "                        wakeUpExecutor(thread_to_wake);",
          "content_same": false
        },
        {
          "line": 847,
          "old_api": null,
          "new_api": "emplace_back",
          "old_text": null,
          "new_text": "proc_list.emplace_back(proc.processor)",
          "old_line_content": "    WriteBufferFromOwnString out;",
          "new_line_content": "        proc_list.emplace_back(proc.processor);",
          "content_same": false
        },
        {
          "line": 852,
          "old_api": null,
          "new_api": "printPipeline",
          "old_text": null,
          "new_text": "printPipeline(processors, statuses, out)",
          "old_line_content": "}",
          "new_line_content": "    printPipeline(processors, statuses, out);",
          "content_same": false
        },
        {
          "line": 597,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "threads_queue.size()",
          "old_line_content": "                    break;",
          "new_line_content": "                if (threads_queue.size() + 1 == num_threads)",
          "content_same": false
        },
        {
          "line": 726,
          "old_api": null,
          "new_api": "init",
          "old_text": null,
          "new_text": "threads_queue.init(num_threads)",
          "old_line_content": "        std::lock_guard guard(executor_contexts_mutex);",
          "new_line_content": "    threads_queue.init(num_threads);",
          "content_same": false
        },
        {
          "line": 599,
          "old_api": null,
          "new_api": "unlock",
          "old_text": null,
          "new_text": "lock.unlock()",
          "old_line_content": "",
          "new_line_content": "                    lock.unlock();",
          "content_same": false
        },
        {
          "line": 727,
          "old_api": null,
          "new_api": "init",
          "old_text": null,
          "new_text": "task_queue.init(num_threads)",
          "old_line_content": "",
          "new_line_content": "    task_queue.init(num_threads);",
          "content_same": false
        },
        {
          "line": 853,
          "old_api": null,
          "new_api": "finalize",
          "old_text": null,
          "new_text": "out.finalize()",
          "old_line_content": "",
          "new_line_content": "    out.finalize();",
          "content_same": false
        },
        {
          "line": 855,
          "old_api": null,
          "new_api": "str",
          "old_text": null,
          "new_text": "out.str()",
          "old_line_content": "",
          "new_line_content": "    return out.str();",
          "content_same": false
        },
        {
          "line": 604,
          "old_api": null,
          "new_api": "push",
          "old_text": null,
          "new_text": "threads_queue.push(thread_num)",
          "old_line_content": "                std::unique_lock lock(context->mutex);",
          "new_line_content": "                threads_queue.push(thread_num);",
          "content_same": false
        },
        {
          "line": 732,
          "old_api": null,
          "new_api": "reserve",
          "old_text": null,
          "new_text": "executor_contexts.reserve(num_threads)",
          "old_line_content": "",
          "new_line_content": "        executor_contexts.reserve(num_threads);",
          "content_same": false
        },
        {
          "line": 610,
          "old_api": null,
          "new_api": "wait",
          "old_text": null,
          "new_text": "context->condvar.wait(lock, [&]\n                {\n                    return finished || context->wake_flag;\n                })",
          "old_line_content": "",
          "new_line_content": "                context->condvar.wait(lock, [&]",
          "content_same": false
        },
        {
          "line": 738,
          "old_api": null,
          "new_api": "addChildlessProcessorsToStack",
          "old_text": null,
          "new_text": "addChildlessProcessorsToStack(stack)",
          "old_line_content": "",
          "new_line_content": "    addChildlessProcessorsToStack(stack);",
          "content_same": false
        },
        {
          "line": 746,
          "old_api": null,
          "new_api": "empty",
          "old_text": null,
          "new_text": "stack.empty()",
          "old_line_content": "",
          "new_line_content": "        while (!stack.empty())",
          "content_same": false
        },
        {
          "line": 748,
          "old_api": null,
          "new_api": "top",
          "old_text": null,
          "new_text": "stack.top()",
          "old_line_content": "",
          "new_line_content": "            UInt64 proc = stack.top();",
          "content_same": false
        },
        {
          "line": 753,
          "old_api": null,
          "new_api": "empty",
          "old_text": null,
          "new_text": "queue.empty()",
          "old_line_content": "",
          "new_line_content": "            while (!queue.empty())",
          "content_same": false
        },
        {
          "line": 627,
          "old_api": null,
          "new_api": "addJob",
          "old_text": null,
          "new_text": "addJob(state)",
          "old_line_content": "                Stopwatch execution_time_watch;",
          "new_line_content": "            addJob(state);",
          "content_same": false
        },
        {
          "line": 755,
          "old_api": null,
          "new_api": "front",
          "old_text": null,
          "new_text": "queue.front()",
          "old_line_content": "                if (next_thread >= num_threads)",
          "new_line_content": "                task_queue.push(queue.front(), next_thread);",
          "content_same": false
        },
        {
          "line": 756,
          "old_api": null,
          "new_api": "pop",
          "old_text": null,
          "new_text": "queue.pop()",
          "old_line_content": "                    next_thread = 0;",
          "new_line_content": "                queue.pop();",
          "content_same": false
        },
        {
          "line": 634,
          "old_api": null,
          "new_api": "job",
          "old_text": null,
          "new_text": "state->job()",
          "old_line_content": "#endif",
          "new_line_content": "                state->job();",
          "content_same": false
        },
        {
          "line": 637,
          "old_api": null,
          "new_api": "elapsed",
          "old_text": null,
          "new_text": "execution_time_watch.elapsed()",
          "old_line_content": "            if (state->exception)",
          "new_line_content": "                context->execution_time_ns += execution_time_watch.elapsed();",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 775,
          "old_api": "finish",
          "new_api": null,
          "old_text": "finish()",
          "new_text": null,
          "old_line_content": "            finish();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 778,
          "old_api": "joinable",
          "new_api": null,
          "old_text": "thread.joinable()",
          "new_text": null,
          "old_line_content": "                if (thread.joinable())",
          "new_line_content": "        {",
          "content_same": false
        },
        {
          "line": 652,
          "old_api": "load",
          "new_api": null,
          "old_text": "expand_pipeline_task.load()",
          "new_text": null,
          "old_line_content": "                while (auto * task = expand_pipeline_task.load())",
          "new_line_content": "            {",
          "content_same": false
        },
        {
          "line": 653,
          "old_api": "doExpandPipeline",
          "new_api": null,
          "old_text": "doExpandPipeline(task, true)",
          "new_text": null,
          "old_line_content": "                    doExpandPipeline(task, true);",
          "new_line_content": "                Queue queue;",
          "content_same": false
        },
        {
          "line": 785,
          "old_api": "CurrentThread::getGroup()",
          "new_api": null,
          "old_text": "CurrentThread::getGroup()",
          "new_text": null,
          "old_line_content": "        auto thread_group = CurrentThread::getGroup();",
          "new_line_content": "    );",
          "content_same": false
        },
        {
          "line": 658,
          "old_api": "std::move(lock)",
          "new_api": null,
          "old_text": "std::move(lock)",
          "new_text": null,
          "old_line_content": "                    if (!prepareProcessor(state->processors_id, thread_num, queue, std::move(lock)))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 659,
          "old_api": "finish",
          "new_api": null,
          "old_text": "finish()",
          "new_text": null,
          "old_line_content": "                        finish();",
          "new_line_content": "                /// Prepare processor after execution.",
          "content_same": false
        },
        {
          "line": 534,
          "old_api": "dumpPipeline",
          "new_api": null,
          "old_text": "dumpPipeline()",
          "new_text": null,
          "old_line_content": "        throw Exception(\"Pipeline stuck. Current state:\\n\" + dumpPipeline(), ErrorCodes::LOGICAL_ERROR);",
          "new_line_content": "\t    }",
          "content_same": false
        },
        {
          "line": 665,
          "old_api": "empty",
          "new_api": null,
          "old_text": "queue.empty()",
          "new_text": null,
          "old_line_content": "                if (!queue.empty())",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 667,
          "old_api": "front",
          "new_api": null,
          "old_text": "queue.front()",
          "new_text": null,
          "old_line_content": "                    state = queue.front();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 668,
          "old_api": "pop",
          "new_api": null,
          "old_text": "queue.pop()",
          "new_text": null,
          "old_line_content": "                    queue.pop();",
          "new_line_content": "                /// Take local task from queue if has one.",
          "content_same": false
        },
        {
          "line": 541,
          "old_api": "notify_one",
          "new_api": null,
          "old_text": "executor_contexts[thread_num]->condvar.notify_one()",
          "new_text": null,
          "old_line_content": "    executor_contexts[thread_num]->condvar.notify_one();",
          "new_line_content": "void PipelineExecutor::wakeUpExecutor(size_t thread_num)",
          "content_same": false
        },
        {
          "line": 796,
          "old_api": "CurrentThread::attachTo(thread_group)",
          "new_api": null,
          "old_text": "CurrentThread::attachTo(thread_group)",
          "new_text": null,
          "old_line_content": "                    CurrentThread::attachTo(thread_group);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 798,
          "old_api": "SCOPE_EXIT",
          "new_api": null,
          "old_text": "SCOPE_EXIT(\n                        if (thread_group)\n                            CurrentThread::detachQueryIfNotDetached();\n                )",
          "new_text": null,
          "old_line_content": "                SCOPE_EXIT(",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 546,
          "old_api": "executeStepImpl",
          "new_api": null,
          "old_text": "executeStepImpl(thread_num, num_threads)",
          "new_text": null,
          "old_line_content": "    executeStepImpl(thread_num, num_threads);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 803,
          "old_api": "executeSingleThread",
          "new_api": null,
          "old_text": "executeSingleThread(thread_num, num_threads)",
          "new_text": null,
          "old_line_content": "                executeSingleThread(thread_num, num_threads);",
          "new_line_content": "                        if (thread_group)",
          "content_same": false
        },
        {
          "line": 678,
          "old_api": "front",
          "new_api": null,
          "old_text": "queue.front()",
          "new_text": null,
          "old_line_content": "                        task_queue.push(queue.front(), thread_num);",
          "new_line_content": "                    std::unique_lock lock(task_queue_mutex);",
          "content_same": false
        },
        {
          "line": 679,
          "old_api": "pop",
          "new_api": null,
          "old_text": "queue.pop()",
          "new_text": null,
          "old_line_content": "                        queue.pop();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 808,
          "old_api": "joinable",
          "new_api": null,
          "old_text": "thread.joinable()",
          "new_text": null,
          "old_line_content": "            if (thread.joinable())",
          "new_line_content": "            });",
          "content_same": false
        },
        {
          "line": 809,
          "old_api": "join",
          "new_api": null,
          "old_text": "thread.join()",
          "new_text": null,
          "old_line_content": "                thread.join();",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 684,
          "old_api": "getAnyThreadWithTasks",
          "new_api": null,
          "old_text": "task_queue.getAnyThreadWithTasks(thread_num + 1 == num_threads ? 0 : (thread_num + 1))",
          "new_text": null,
          "old_line_content": "                        auto thread_to_wake = task_queue.getAnyThreadWithTasks(thread_num + 1 == num_threads ? 0 : (thread_num + 1));",
          "new_line_content": "                    }",
          "content_same": false
        },
        {
          "line": 687,
          "old_api": "pop",
          "new_api": null,
          "old_text": "threads_queue.pop(thread_to_wake)",
          "new_text": null,
          "old_line_content": "                            threads_queue.pop(thread_to_wake);",
          "new_line_content": "                    {",
          "content_same": false
        },
        {
          "line": 689,
          "old_api": "pop_any",
          "new_api": null,
          "old_text": "threads_queue.pop_any()",
          "new_text": null,
          "old_line_content": "                            thread_to_wake = threads_queue.pop_any();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 698,
          "old_api": "load",
          "new_api": null,
          "old_text": "expand_pipeline_task.load()",
          "new_text": null,
          "old_line_content": "                while (auto * task = expand_pipeline_task.load())",
          "new_line_content": "                    }",
          "content_same": false
        },
        {
          "line": 699,
          "old_api": "doExpandPipeline",
          "new_api": null,
          "old_text": "doExpandPipeline(task, false)",
          "new_text": null,
          "old_line_content": "                    doExpandPipeline(task, false);",
          "new_line_content": "                }",
          "content_same": false
        },
        {
          "line": 573,
          "old_api": "empty",
          "new_api": null,
          "old_text": "task_queue.empty()",
          "new_text": null,
          "old_line_content": "                if (!task_queue.empty())",
          "new_line_content": "        {",
          "content_same": false
        },
        {
          "line": 575,
          "old_api": "pop",
          "new_api": null,
          "old_text": "task_queue.pop(thread_num)",
          "new_text": null,
          "old_line_content": "                    state = task_queue.pop(thread_num);",
          "new_line_content": "                std::unique_lock lock(task_queue_mutex);",
          "content_same": false
        },
        {
          "line": 832,
          "old_api": "str",
          "new_api": null,
          "old_text": "buffer.str()",
          "new_text": null,
          "old_line_content": "            node.processor->setDescription(buffer.str());",
          "new_line_content": "            buffer << \", preparation time: \" << node.execution_state->preparation_time_ns / 1e9 << \" sec.\";",
          "content_same": false
        },
        {
          "line": 582,
          "old_api": "pop",
          "new_api": null,
          "old_text": "threads_queue.pop(thread_to_wake)",
          "new_text": null,
          "old_line_content": "                            threads_queue.pop(thread_to_wake);",
          "new_line_content": "                    {",
          "content_same": false
        },
        {
          "line": 838,
          "old_api": "size",
          "new_api": null,
          "old_text": "graph.size()",
          "new_text": null,
          "old_line_content": "    statuses.reserve(graph.size());",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 584,
          "old_api": "pop_any",
          "new_api": null,
          "old_text": "threads_queue.pop_any()",
          "new_text": null,
          "old_line_content": "                            thread_to_wake = threads_queue.pop_any();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 713,
          "old_api": "elapsed",
          "new_api": null,
          "old_text": "total_time_watch.elapsed()",
          "new_text": null,
          "old_line_content": "    context->total_time_ns += total_time_watch.elapsed();",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 839,
          "old_api": "size",
          "new_api": null,
          "old_text": "graph.size()",
          "new_text": null,
          "old_line_content": "    proc_list.reserve(graph.size());",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 587,
          "old_api": "wakeUpExecutor",
          "new_api": null,
          "old_text": "wakeUpExecutor(thread_to_wake)",
          "new_text": null,
          "old_line_content": "                        wakeUpExecutor(thread_to_wake);",
          "new_line_content": "                        else",
          "content_same": false
        },
        {
          "line": 844,
          "old_api": "emplace_back",
          "new_api": null,
          "old_text": "statuses.emplace_back(proc.last_processor_status)",
          "new_text": null,
          "old_line_content": "        statuses.emplace_back(proc.last_processor_status);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 593,
          "old_api": "size",
          "new_api": null,
          "old_text": "threads_queue.size()",
          "new_text": null,
          "old_line_content": "                if (threads_queue.size() + 1 == num_threads)",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 722,
          "old_api": "init",
          "new_api": null,
          "old_text": "threads_queue.init(num_threads)",
          "new_text": null,
          "old_line_content": "    threads_queue.init(num_threads);",
          "new_line_content": "void PipelineExecutor::initializeExecution(size_t num_threads)",
          "content_same": false
        },
        {
          "line": 595,
          "old_api": "unlock",
          "new_api": null,
          "old_text": "lock.unlock()",
          "new_text": null,
          "old_line_content": "                    lock.unlock();",
          "new_line_content": "                }",
          "content_same": false
        },
        {
          "line": 596,
          "old_api": "finish",
          "new_api": null,
          "old_text": "finish()",
          "new_text": null,
          "old_line_content": "                    finish();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 723,
          "old_api": "init",
          "new_api": null,
          "old_text": "task_queue.init(num_threads)",
          "new_text": null,
          "old_line_content": "    task_queue.init(num_threads);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 849,
          "old_api": "finalize",
          "new_api": null,
          "old_text": "out.finalize()",
          "new_text": null,
          "old_line_content": "    out.finalize();",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 851,
          "old_api": "str",
          "new_api": null,
          "old_text": "out.str()",
          "new_text": null,
          "old_line_content": "    return out.str();",
          "new_line_content": "    WriteBufferFromOwnString out;",
          "content_same": false
        },
        {
          "line": 728,
          "old_api": "reserve",
          "new_api": null,
          "old_text": "executor_contexts.reserve(num_threads)",
          "new_text": null,
          "old_line_content": "        executor_contexts.reserve(num_threads);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 730,
          "old_api": "std::make_unique<ExecutorContext>()",
          "new_api": null,
          "old_text": "std::make_unique<ExecutorContext>()",
          "new_text": null,
          "old_line_content": "            executor_contexts.emplace_back(std::make_unique<ExecutorContext>());",
          "new_line_content": "        std::lock_guard guard(executor_contexts_mutex);",
          "content_same": false
        },
        {
          "line": 606,
          "old_api": "wait",
          "new_api": null,
          "old_text": "context->condvar.wait(lock, [&]\n                {\n                    return finished || context->wake_flag;\n                })",
          "new_text": null,
          "old_line_content": "                context->condvar.wait(lock, [&]",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 742,
          "old_api": "empty",
          "new_api": null,
          "old_text": "stack.empty()",
          "new_text": null,
          "old_line_content": "        while (!stack.empty())",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 744,
          "old_api": "top",
          "new_api": null,
          "old_text": "stack.top()",
          "new_text": null,
          "old_line_content": "            UInt64 proc = stack.top();",
          "new_line_content": "        size_t next_thread = 0;",
          "content_same": false
        },
        {
          "line": 745,
          "old_api": "pop",
          "new_api": null,
          "old_text": "stack.pop()",
          "new_text": null,
          "old_line_content": "            stack.pop();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 747,
          "old_api": "std::unique_lock<std::mutex>(*graph[proc].status_mutex)",
          "new_api": null,
          "old_text": "std::unique_lock<std::mutex>(*graph[proc].status_mutex)",
          "new_text": null,
          "old_line_content": "            prepareProcessor(proc, 0, queue, std::unique_lock<std::mutex>(*graph[proc].status_mutex));",
          "new_line_content": "        {",
          "content_same": false
        },
        {
          "line": 623,
          "old_api": "addJob",
          "new_api": null,
          "old_text": "addJob(state)",
          "new_text": null,
          "old_line_content": "            addJob(state);",
          "new_line_content": "        {",
          "content_same": false
        },
        {
          "line": 752,
          "old_api": "pop",
          "new_api": null,
          "old_text": "queue.pop()",
          "new_text": null,
          "old_line_content": "                queue.pop();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 630,
          "old_api": "job",
          "new_api": null,
          "old_text": "state->job()",
          "new_text": null,
          "old_line_content": "                state->job();",
          "new_line_content": "#ifndef NDEBUG",
          "content_same": false
        },
        {
          "line": 633,
          "old_api": "elapsed",
          "new_api": null,
          "old_text": "execution_time_watch.elapsed()",
          "new_text": null,
          "old_line_content": "                context->execution_time_ns += execution_time_watch.elapsed();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 764,
          "old_api": "initializeExecution",
          "new_api": null,
          "old_text": "initializeExecution(num_threads)",
          "new_text": null,
          "old_line_content": "    initializeExecution(num_threads);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 638,
          "old_api": "finish",
          "new_api": null,
          "old_text": "finish()",
          "new_text": null,
          "old_line_content": "                finish();",
          "new_line_content": "#endif",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 24,
      "total_additions": 55,
      "total_deletions": 55,
      "total_api_changes": 134
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 7,
        "api_related_lines": 134,
        "non_api_lines": 6,
        "non_api_line_numbers": [
          529,
          530,
          531,
          532,
          533,
          535
        ]
      }
    },
    "api_calls_before": 224,
    "api_calls_after": 224,
    "diff_info": {
      "added_lines": 7,
      "removed_lines": 3,
      "total_diff_lines": 22
    }
  }
}