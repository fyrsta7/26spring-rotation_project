{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/eeb78bf29172112ee832e2e46ed75271961717d9",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/eeb78bf29172112ee832e2e46ed75271961717d9/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/eeb78bf29172112ee832e2e46ed75271961717d9/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/eeb78bf29172112ee832e2e46ed75271961717d9/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 47,
          "old_api": "getMark",
          "new_api": "end",
          "old_text": "marks_loader.getMark(mark_range.end)",
          "new_text": "indices.end()",
          "old_line_content": "                && marks_loader.getMark(right_mark).offset_in_compressed_file == marks_loader.getMark(mark_range.end).offset_in_compressed_file)",
          "new_line_content": "            auto it = std::upper_bound(indices.begin(), indices.end(), right_mark, [this](size_t i, size_t j)",
          "content_same": false
        },
        {
          "line": 97,
          "old_api": "std::move(buffer)",
          "new_api": "setProfileCallback",
          "old_text": "std::move(buffer)",
          "new_text": "buffer->setProfileCallback(profile_callback, clock_type)",
          "old_line_content": "        cached_buffer = std::move(buffer);",
          "new_line_content": "            buffer->setProfileCallback(profile_callback, clock_type);",
          "content_same": false
        },
        {
          "line": 110,
          "old_api": "std::move(buffer)",
          "new_api": "setProfileCallback",
          "old_text": "std::move(buffer)",
          "new_text": "buffer->setProfileCallback(profile_callback, clock_type)",
          "old_line_content": "        non_cached_buffer = std::move(buffer);",
          "new_line_content": "            buffer->setProfileCallback(profile_callback, clock_type);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 132,
          "old_api": null,
          "new_api": "code",
          "old_text": null,
          "new_text": "e.code()",
          "old_line_content": "                         + \" of column \" + path_prefix + \"; offsets are: \"",
          "new_line_content": "        if (e.code() == ErrorCodes::ARGUMENT_OUT_OF_BOUND)",
          "content_same": false
        },
        {
          "line": 135,
          "old_api": null,
          "new_api": "toString",
          "old_text": null,
          "new_text": "toString(mark.offset_in_compressed_file)",
          "old_line_content": "",
          "new_line_content": "                         + toString(mark.offset_in_compressed_file) + \" \"",
          "content_same": false
        },
        {
          "line": 136,
          "old_api": null,
          "new_api": "toString",
          "old_text": null,
          "new_text": "toString(mark.offset_in_decompressed_block)",
          "old_line_content": "        throw;",
          "new_line_content": "                         + toString(mark.offset_in_decompressed_block) + \")\");",
          "content_same": false
        },
        {
          "line": 150,
          "old_api": null,
          "new_api": "seek",
          "old_text": null,
          "new_text": "non_cached_buffer->seek(0, 0)",
          "old_line_content": "    catch (Exception & e)",
          "new_line_content": "            non_cached_buffer->seek(0, 0);",
          "content_same": false
        },
        {
          "line": 155,
          "old_api": null,
          "new_api": "code",
          "old_text": null,
          "new_text": "e.code()",
          "old_line_content": "",
          "new_line_content": "        if (e.code() == ErrorCodes::ARGUMENT_OUT_OF_BOUND)",
          "content_same": false
        },
        {
          "line": 156,
          "old_api": null,
          "new_api": "addMessage",
          "old_text": null,
          "new_text": "e.addMessage(\"(while seeking to start of column \" + path_prefix + \")\")",
          "old_line_content": "        throw;",
          "new_line_content": "            e.addMessage(\"(while seeking to start of column \" + path_prefix + \")\");",
          "content_same": false
        },
        {
          "line": 46,
          "old_api": null,
          "new_api": "ext::range(right_mark, marks_count)",
          "old_text": null,
          "new_text": "ext::range(right_mark, marks_count)",
          "old_line_content": "            while (right_mark < marks_count",
          "new_line_content": "            auto indices = ext::range(right_mark, marks_count);",
          "content_same": false
        },
        {
          "line": 49,
          "old_api": null,
          "new_api": "getMark",
          "old_text": null,
          "new_text": "marks_loader.getMark(j)",
          "old_line_content": "                ++right_mark;",
          "new_line_content": "                return marks_loader.getMark(i).offset_in_compressed_file < marks_loader.getMark(j).offset_in_compressed_file;",
          "content_same": false
        },
        {
          "line": 52,
          "old_api": null,
          "new_api": "end",
          "old_text": null,
          "new_text": "indices.end()",
          "old_line_content": "",
          "new_line_content": "            right_mark = (it == indices.end() ? marks_count : *it);",
          "content_same": false
        },
        {
          "line": 62,
          "old_api": null,
          "new_api": "getMark",
          "old_text": null,
          "new_text": "marks_loader.getMark(left_mark)",
          "old_line_content": "        else",
          "new_line_content": "            mark_range_bytes = file_size - (left_mark < marks_count ? marks_loader.getMark(left_mark).offset_in_compressed_file : 0);",
          "content_same": false
        },
        {
          "line": 66,
          "old_api": null,
          "new_api": "getMark",
          "old_text": null,
          "new_text": "marks_loader.getMark(left_mark)",
          "old_line_content": "",
          "new_line_content": "            mark_range_bytes = marks_loader.getMark(right_mark).offset_in_compressed_file - marks_loader.getMark(left_mark).offset_in_compressed_file;",
          "content_same": false
        },
        {
          "line": 69,
          "old_api": null,
          "new_api": "std::max(max_mark_range_bytes, mark_range_bytes)",
          "old_text": null,
          "new_text": "std::max(max_mark_range_bytes, mark_range_bytes)",
          "old_line_content": "    }",
          "new_line_content": "        max_mark_range_bytes = std::max(max_mark_range_bytes, mark_range_bytes);",
          "content_same": false
        },
        {
          "line": 78,
          "old_api": null,
          "new_api": "std::min(settings.max_read_buffer_size, max_mark_range_bytes)",
          "old_text": null,
          "new_text": "std::min(settings.max_read_buffer_size, max_mark_range_bytes)",
          "old_line_content": "    /// Initialize the objects that shall be used to perform read operations.",
          "new_line_content": "    size_t buffer_size = std::min(settings.max_read_buffer_size, max_mark_range_bytes);",
          "content_same": false
        },
        {
          "line": 83,
          "old_api": null,
          "new_api": "readFile",
          "old_text": null,
          "new_text": "std::make_unique<CachedCompressedReadBuffer>(\n            fullPath(disk, path_prefix + data_file_extension),\n            [this, buffer_size, sum_mark_range_bytes, &settings]()\n            {\n                return disk->readFile(\n                    path_prefix + data_file_extension,\n                    buffer_size,\n                    sum_mark_range_bytes,\n                    settings.min_bytes_to_use_direct_io,\n                    settings.min_bytes_to_use_mmap_io);\n            },\n            uncompressed_cache)",
          "old_line_content": "            [this, buffer_size, sum_mark_range_bytes, &settings]()",
          "new_line_content": "        auto buffer = std::make_unique<CachedCompressedReadBuffer>(",
          "content_same": false
        },
        {
          "line": 84,
          "old_api": null,
          "new_api": "fullPath",
          "old_text": null,
          "new_text": "fullPath(disk, path_prefix + data_file_extension)",
          "old_line_content": "            {",
          "new_line_content": "            fullPath(disk, path_prefix + data_file_extension),",
          "content_same": false
        },
        {
          "line": 87,
          "old_api": null,
          "new_api": "readFile",
          "old_text": null,
          "new_text": "disk->readFile(\n                    path_prefix + data_file_extension,\n                    buffer_size,\n                    sum_mark_range_bytes,\n                    settings.min_bytes_to_use_direct_io,\n                    settings.min_bytes_to_use_mmap_io)",
          "old_line_content": "                    buffer_size,",
          "new_line_content": "                return disk->readFile(",
          "content_same": false
        },
        {
          "line": 99,
          "old_api": null,
          "new_api": "std::move(buffer)",
          "old_text": null,
          "new_text": "std::move(buffer)",
          "old_line_content": "    }",
          "new_line_content": "        cached_buffer = std::move(buffer);",
          "content_same": false
        },
        {
          "line": 100,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "cached_buffer.get()",
          "old_line_content": "    else",
          "new_line_content": "        data_buffer = cached_buffer.get();",
          "content_same": false
        },
        {
          "line": 104,
          "old_api": null,
          "new_api": "readFile",
          "old_text": null,
          "new_text": "std::make_unique<CompressedReadBufferFromFile>(\n            disk->readFile(path_prefix + data_file_extension, buffer_size,\n                sum_mark_range_bytes, settings.min_bytes_to_use_direct_io, settings.min_bytes_to_use_mmap_io)\n        )",
          "old_line_content": "                sum_mark_range_bytes, settings.min_bytes_to_use_direct_io, settings.min_bytes_to_use_mmap_io)",
          "new_line_content": "        auto buffer = std::make_unique<CompressedReadBufferFromFile>(",
          "content_same": false
        },
        {
          "line": 105,
          "old_api": null,
          "new_api": "readFile",
          "old_text": null,
          "new_text": "disk->readFile(path_prefix + data_file_extension, buffer_size,\n                sum_mark_range_bytes, settings.min_bytes_to_use_direct_io, settings.min_bytes_to_use_mmap_io)",
          "old_line_content": "        );",
          "new_line_content": "            disk->readFile(path_prefix + data_file_extension, buffer_size,",
          "content_same": false
        },
        {
          "line": 112,
          "old_api": null,
          "new_api": "std::move(buffer)",
          "old_text": null,
          "new_text": "std::move(buffer)",
          "old_line_content": "    }",
          "new_line_content": "        non_cached_buffer = std::move(buffer);",
          "content_same": false
        },
        {
          "line": 113,
          "old_api": null,
          "new_api": "get",
          "old_text": null,
          "new_text": "non_cached_buffer.get()",
          "old_line_content": "}",
          "new_line_content": "        data_buffer = non_cached_buffer.get();",
          "content_same": false
        },
        {
          "line": 120,
          "old_api": null,
          "new_api": "getMark",
          "old_text": null,
          "new_text": "marks_loader.getMark(index)",
          "old_line_content": "    try",
          "new_line_content": "    MarkInCompressedFile mark = marks_loader.getMark(index);",
          "content_same": false
        },
        {
          "line": 127,
          "old_api": null,
          "new_api": "seek",
          "old_text": null,
          "new_text": "non_cached_buffer->seek(mark.offset_in_compressed_file, mark.offset_in_decompressed_block)",
          "old_line_content": "    catch (Exception & e)",
          "new_line_content": "            non_cached_buffer->seek(mark.offset_in_compressed_file, mark.offset_in_decompressed_block);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 130,
          "old_api": "code",
          "new_api": null,
          "old_text": "e.code()",
          "new_text": null,
          "old_line_content": "        if (e.code() == ErrorCodes::ARGUMENT_OUT_OF_BOUND)",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 131,
          "old_api": "toString",
          "new_api": null,
          "old_text": "toString(index)",
          "new_text": null,
          "old_line_content": "            e.addMessage(\"(while seeking to mark \" + toString(index)",
          "new_line_content": "        /// Better diagnostics.",
          "content_same": false
        },
        {
          "line": 134,
          "old_api": "toString",
          "new_api": null,
          "old_text": "toString(mark.offset_in_decompressed_block)",
          "new_text": null,
          "old_line_content": "                         + toString(mark.offset_in_decompressed_block) + \")\");",
          "new_line_content": "                         + \" of column \" + path_prefix + \"; offsets are: \"",
          "content_same": false
        },
        {
          "line": 146,
          "old_api": "seek",
          "new_api": null,
          "old_text": "cached_buffer->seek(0, 0)",
          "new_text": null,
          "old_line_content": "            cached_buffer->seek(0, 0);",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 153,
          "old_api": "code",
          "new_api": null,
          "old_text": "e.code()",
          "new_text": null,
          "old_line_content": "        if (e.code() == ErrorCodes::ARGUMENT_OUT_OF_BOUND)",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 154,
          "old_api": "addMessage",
          "new_api": null,
          "old_text": "e.addMessage(\"(while seeking to start of column \" + path_prefix + \")\")",
          "new_text": null,
          "old_line_content": "            e.addMessage(\"(while seeking to start of column \" + path_prefix + \")\");",
          "new_line_content": "        /// Better diagnostics.",
          "content_same": false
        },
        {
          "line": 58,
          "old_api": "getMark",
          "new_api": null,
          "old_text": "marks_loader.getMark(mark_range.end)",
          "new_text": null,
          "old_line_content": "                && marks_loader.getMark(right_mark).offset_in_compressed_file == marks_loader.getMark(mark_range.end).offset_in_compressed_file))",
          "new_line_content": "        if (right_mark >= marks_count",
          "content_same": false
        },
        {
          "line": 64,
          "old_api": "getMark",
          "new_api": null,
          "old_text": "marks_loader.getMark(left_mark)",
          "new_text": null,
          "old_line_content": "            mark_range_bytes = marks_loader.getMark(right_mark).offset_in_compressed_file - marks_loader.getMark(left_mark).offset_in_compressed_file;",
          "new_line_content": "        else",
          "content_same": false
        },
        {
          "line": 67,
          "old_api": "std::max(max_mark_range_bytes, mark_range_bytes)",
          "new_api": null,
          "old_text": "std::max(max_mark_range_bytes, mark_range_bytes)",
          "new_text": null,
          "old_line_content": "        max_mark_range_bytes = std::max(max_mark_range_bytes, mark_range_bytes);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 76,
          "old_api": "std::min(settings.max_read_buffer_size, max_mark_range_bytes)",
          "new_api": null,
          "old_text": "std::min(settings.max_read_buffer_size, max_mark_range_bytes)",
          "new_text": null,
          "old_line_content": "    size_t buffer_size = std::min(settings.max_read_buffer_size, max_mark_range_bytes);",
          "new_line_content": "        max_mark_range_bytes = settings.max_read_buffer_size;",
          "content_same": false
        },
        {
          "line": 81,
          "old_api": "readFile",
          "new_api": null,
          "old_text": "std::make_unique<CachedCompressedReadBuffer>(\n            fullPath(disk, path_prefix + data_file_extension),\n            [this, buffer_size, sum_mark_range_bytes, &settings]()\n            {\n                return disk->readFile(\n                    path_prefix + data_file_extension,\n                    buffer_size,\n                    sum_mark_range_bytes,\n                    settings.min_bytes_to_use_direct_io,\n                    settings.min_bytes_to_use_mmap_io);\n            },\n            uncompressed_cache)",
          "new_text": null,
          "old_line_content": "        auto buffer = std::make_unique<CachedCompressedReadBuffer>(",
          "new_line_content": "    if (uncompressed_cache)",
          "content_same": false
        },
        {
          "line": 82,
          "old_api": "fullPath",
          "new_api": null,
          "old_text": "fullPath(disk, path_prefix + data_file_extension)",
          "new_text": null,
          "old_line_content": "            fullPath(disk, path_prefix + data_file_extension),",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 85,
          "old_api": "readFile",
          "new_api": null,
          "old_text": "disk->readFile(\n                    path_prefix + data_file_extension,\n                    buffer_size,\n                    sum_mark_range_bytes,\n                    settings.min_bytes_to_use_direct_io,\n                    settings.min_bytes_to_use_mmap_io)",
          "new_text": null,
          "old_line_content": "                return disk->readFile(",
          "new_line_content": "            [this, buffer_size, sum_mark_range_bytes, &settings]()",
          "content_same": false
        },
        {
          "line": 95,
          "old_api": "setProfileCallback",
          "new_api": null,
          "old_text": "buffer->setProfileCallback(profile_callback, clock_type)",
          "new_text": null,
          "old_line_content": "            buffer->setProfileCallback(profile_callback, clock_type);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 98,
          "old_api": "get",
          "new_api": null,
          "old_text": "cached_buffer.get()",
          "new_text": null,
          "old_line_content": "        data_buffer = cached_buffer.get();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 102,
          "old_api": "readFile",
          "new_api": null,
          "old_text": "std::make_unique<CompressedReadBufferFromFile>(\n            disk->readFile(path_prefix + data_file_extension, buffer_size,\n                sum_mark_range_bytes, settings.min_bytes_to_use_direct_io, settings.min_bytes_to_use_mmap_io)\n        )",
          "new_text": null,
          "old_line_content": "        auto buffer = std::make_unique<CompressedReadBufferFromFile>(",
          "new_line_content": "    else",
          "content_same": false
        },
        {
          "line": 103,
          "old_api": "readFile",
          "new_api": null,
          "old_text": "disk->readFile(path_prefix + data_file_extension, buffer_size,\n                sum_mark_range_bytes, settings.min_bytes_to_use_direct_io, settings.min_bytes_to_use_mmap_io)",
          "new_text": null,
          "old_line_content": "            disk->readFile(path_prefix + data_file_extension, buffer_size,",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 108,
          "old_api": "setProfileCallback",
          "new_api": null,
          "old_text": "buffer->setProfileCallback(profile_callback, clock_type)",
          "new_text": null,
          "old_line_content": "            buffer->setProfileCallback(profile_callback, clock_type);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 111,
          "old_api": "get",
          "new_api": null,
          "old_text": "non_cached_buffer.get()",
          "new_text": null,
          "old_line_content": "        data_buffer = non_cached_buffer.get();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 118,
          "old_api": "getMark",
          "new_api": null,
          "old_text": "marks_loader.getMark(index)",
          "new_text": null,
          "old_line_content": "    MarkInCompressedFile mark = marks_loader.getMark(index);",
          "new_line_content": "void MergeTreeReaderStream::seekToMark(size_t index)",
          "content_same": false
        },
        {
          "line": 123,
          "old_api": "seek",
          "new_api": null,
          "old_text": "cached_buffer->seek(mark.offset_in_compressed_file, mark.offset_in_decompressed_block)",
          "new_text": null,
          "old_line_content": "            cached_buffer->seek(mark.offset_in_compressed_file, mark.offset_in_decompressed_block);",
          "new_line_content": "    {",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 3,
      "total_additions": 24,
      "total_deletions": 21,
      "total_api_changes": 48
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 6,
        "api_related_lines": 48,
        "non_api_lines": 2,
        "non_api_line_numbers": [
          50,
          51
        ]
      }
    },
    "api_calls_before": 35,
    "api_calls_after": 40,
    "diff_info": {
      "added_lines": 6,
      "removed_lines": 4,
      "total_diff_lines": 23
    }
  }
}