{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/223c1230b6260faba055329f611a5ed03cbf6cee",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/223c1230b6260faba055329f611a5ed03cbf6cee/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/223c1230b6260faba055329f611a5ed03cbf6cee/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/223c1230b6260faba055329f611a5ed03cbf6cee/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 355,
          "old_api": "reset",
          "new_api": "std::move(thread_group->finished_threads_counters_memory)",
          "old_text": "thread_group.reset()",
          "new_text": "std::move(thread_group->finished_threads_counters_memory)",
          "old_line_content": "    thread_group.reset();",
          "new_line_content": "        auto stats = std::move(thread_group->finished_threads_counters_memory);",
          "content_same": false
        },
        {
          "line": 365,
          "old_api": "errnoToString",
          "new_api": "LOG_TRACE",
          "old_text": "errnoToString()",
          "new_text": "LOG_TRACE(log, \"Resetting nice\")",
          "old_line_content": "            LOG_ERROR(log, \"Cannot 'setpriority' back to zero: {}\", errnoToString());",
          "new_line_content": "        LOG_TRACE(log, \"Resetting nice\");",
          "content_same": false
        },
        {
          "line": 388,
          "old_api": "load",
          "new_api": "time_in_nanoseconds",
          "old_text": "progress_in.read_bytes.load(std::memory_order_relaxed)",
          "new_text": "time_in_nanoseconds(now)",
          "old_line_content": "    elem.read_bytes = progress_in.read_bytes.load(std::memory_order_relaxed);",
          "new_line_content": "    elem.query_duration_ms = (time_in_nanoseconds(now) - query_start_time_nanoseconds) / 1000000U;",
          "content_same": false
        },
        {
          "line": 393,
          "old_api": "getPeak",
          "new_api": "load",
          "old_text": "memory_tracker.getPeak()",
          "new_text": "progress_out.written_rows.load(std::memory_order_relaxed)",
          "old_line_content": "    elem.peak_memory_usage = memory_tracker.getPeak();",
          "new_line_content": "    elem.written_rows = progress_out.written_rows.load(std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 395,
          "old_api": "getThreadName",
          "new_api": "get",
          "old_text": "getThreadName()",
          "new_text": "memory_tracker.get()",
          "old_line_content": "    elem.thread_name = getThreadName();",
          "new_line_content": "    elem.memory_usage = memory_tracker.get();",
          "content_same": false
        },
        {
          "line": 413,
          "old_api": "getClientInfo",
          "new_api": "lock",
          "old_text": "query_context_ptr->getClientInfo()",
          "new_text": "query_context.lock()",
          "old_line_content": "        elem.client_info = query_context_ptr->getClientInfo();",
          "new_line_content": "    auto query_context_ptr = query_context.lock();",
          "content_same": false
        },
        {
          "line": 418,
          "old_api": "getPartiallyAtomicSnapshot",
          "new_api": "getSettingsRef",
          "old_text": "performance_counters.getPartiallyAtomicSnapshot()",
          "new_text": "query_context_ptr->getSettingsRef()",
          "old_line_content": "            elem.profile_counters = std::make_shared<ProfileEvents::Counters::Snapshot>(performance_counters.getPartiallyAtomicSnapshot());",
          "new_line_content": "        if (query_context_ptr->getSettingsRef().log_profile_events != 0)",
          "content_same": false
        },
        {
          "line": 431,
          "old_api": "getSettingsRef",
          "new_api": "SensitiveDataMasker::getInstance()",
          "old_text": "context->getSettingsRef()",
          "new_text": "SensitiveDataMasker::getInstance()",
          "old_line_content": "    res = res.substr(0, context->getSettingsRef().log_queries_cut_to_length);",
          "new_line_content": "    if (auto * masker = SensitiveDataMasker::getInstance())",
          "content_same": false
        },
        {
          "line": 441,
          "old_api": "getQueryViewsLog",
          "new_api": "lock",
          "old_text": "query_context_ptr->getQueryViewsLog()",
          "new_text": "query_context.lock()",
          "old_line_content": "    auto views_log = query_context_ptr->getQueryViewsLog();",
          "new_line_content": "    auto query_context_ptr = query_context.lock();",
          "content_same": false
        },
        {
          "line": 459,
          "old_api": "getPartiallyAtomicSnapshot",
          "new_api": "getCleanQueryAst",
          "old_text": "performance_counters.getPartiallyAtomicSnapshot()",
          "new_text": "getCleanQueryAst(vinfo.query, query_context_ptr)",
          "old_line_content": "    auto events = std::make_shared<ProfileEvents::Counters::Snapshot>(performance_counters.getPartiallyAtomicSnapshot());",
          "new_line_content": "        element.view_query = getCleanQueryAst(vinfo.query, query_context_ptr);",
          "content_same": false
        },
        {
          "line": 462,
          "old_api": "load",
          "new_api": "getPartiallyAtomicSnapshot",
          "old_text": "progress_out.written_rows.load(std::memory_order_relaxed)",
          "new_text": "performance_counters.getPartiallyAtomicSnapshot()",
          "old_line_content": "    element.written_rows = progress_out.written_rows.load(std::memory_order_relaxed);",
          "new_line_content": "    auto events = std::make_shared<ProfileEvents::Counters::Snapshot>(performance_counters.getPartiallyAtomicSnapshot());",
          "content_same": false
        },
        {
          "line": 464,
          "old_api": "getPeak",
          "new_api": "load",
          "old_text": "memory_tracker.getPeak()",
          "new_text": "progress_in.read_bytes.load(std::memory_order_relaxed)",
          "old_line_content": "    element.peak_memory_usage = memory_tracker.getPeak() > 0 ? memory_tracker.getPeak() : 0;",
          "new_line_content": "    element.read_bytes = progress_in.read_bytes.load(std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 465,
          "old_api": "getSettingsRef",
          "new_api": "load",
          "old_text": "query_context_ptr->getSettingsRef()",
          "new_text": "progress_out.written_rows.load(std::memory_order_relaxed)",
          "old_line_content": "    if (query_context_ptr->getSettingsRef().log_profile_events != 0)",
          "new_line_content": "    element.written_rows = progress_out.written_rows.load(std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 477,
          "old_api": "getExceptionStackTraceString",
          "new_api": "getExceptionErrorCode",
          "old_text": "getExceptionStackTraceString(vinfo.exception)",
          "new_text": "getExceptionErrorCode(vinfo.exception)",
          "old_line_content": "            element.stack_trace = getExceptionStackTraceString(vinfo.exception);",
          "new_line_content": "        element.exception_code = getExceptionErrorCode(vinfo.exception);",
          "content_same": false
        },
        {
          "line": 480,
          "old_api": "add",
          "new_api": "getExceptionStackTraceString",
          "old_text": "views_log->add(element)",
          "new_text": "getExceptionStackTraceString(vinfo.exception)",
          "old_line_content": "    views_log->add(element);",
          "new_line_content": "            element.stack_trace = getExceptionStackTraceString(vinfo.exception);",
          "content_same": false
        },
        {
          "line": 541,
          "old_api": "makeQueryContext",
          "new_api": "CurrentThread::initializeQuery()",
          "old_text": "query_context->makeQueryContext()",
          "new_text": "CurrentThread::initializeQuery()",
          "old_line_content": "        query_context->makeQueryContext();",
          "new_line_content": "    CurrentThread::initializeQuery();",
          "content_same": false
        },
        {
          "line": 550,
          "old_api": "CurrentThread::initializeQuery()",
          "new_api": "Exception",
          "old_text": "CurrentThread::initializeQuery()",
          "new_text": "Exception(\n            ErrorCodes::LOGICAL_ERROR, \"Cannot initialize query scope without query context\")",
          "old_line_content": "    CurrentThread::initializeQuery();",
          "new_line_content": "        throw Exception(",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 512,
          "old_api": null,
          "new_api": "unlikely",
          "old_text": null,
          "new_text": "unlikely(!current_thread)",
          "old_line_content": "}",
          "new_line_content": "    if (unlikely(!current_thread))",
          "content_same": false
        },
        {
          "line": 514,
          "old_api": null,
          "new_api": "attachQueryContext",
          "old_text": null,
          "new_text": "current_thread->attachQueryContext(query_context)",
          "old_line_content": "void CurrentThread::finalizePerformanceCounters()",
          "new_line_content": "    current_thread->attachQueryContext(query_context);",
          "content_same": false
        },
        {
          "line": 519,
          "old_api": null,
          "new_api": "unlikely",
          "old_text": null,
          "new_text": "unlikely(!current_thread)",
          "old_line_content": "}",
          "new_line_content": "    if (unlikely(!current_thread))",
          "content_same": false
        },
        {
          "line": 521,
          "old_api": null,
          "new_api": "finalizePerformanceCounters",
          "old_text": null,
          "new_text": "current_thread->finalizePerformanceCounters()",
          "old_line_content": "void CurrentThread::detachQuery()",
          "new_line_content": "    current_thread->finalizePerformanceCounters();",
          "content_same": false
        },
        {
          "line": 394,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "progress_out.written_bytes.load(std::memory_order_relaxed)",
          "old_line_content": "",
          "new_line_content": "    elem.written_bytes = progress_out.written_bytes.load(std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 396,
          "old_api": null,
          "new_api": "getPeak",
          "old_text": null,
          "new_text": "memory_tracker.getPeak()",
          "old_line_content": "    elem.thread_id = thread_id;",
          "new_line_content": "    elem.peak_memory_usage = memory_tracker.getPeak();",
          "content_same": false
        },
        {
          "line": 526,
          "old_api": null,
          "new_api": "unlikely",
          "old_text": null,
          "new_text": "unlikely(!current_thread)",
          "old_line_content": "}",
          "new_line_content": "    if (unlikely(!current_thread))",
          "content_same": false
        },
        {
          "line": 398,
          "old_api": null,
          "new_api": "getThreadName",
          "old_text": null,
          "new_text": "getThreadName()",
          "old_line_content": "    elem.current_database = current_database;",
          "new_line_content": "    elem.thread_name = getThreadName();",
          "content_same": false
        },
        {
          "line": 528,
          "old_api": null,
          "new_api": "detachQuery",
          "old_text": null,
          "new_text": "current_thread->detachQuery(false)",
          "old_line_content": "void CurrentThread::detachQueryIfNotDetached()",
          "new_line_content": "    current_thread->detachQuery(false);",
          "content_same": false
        },
        {
          "line": 533,
          "old_api": null,
          "new_api": "unlikely",
          "old_text": null,
          "new_text": "unlikely(!current_thread)",
          "old_line_content": "}",
          "new_line_content": "    if (unlikely(!current_thread))",
          "content_same": false
        },
        {
          "line": 535,
          "old_api": null,
          "new_api": "detachQuery",
          "old_text": null,
          "new_text": "current_thread->detachQuery(true)",
          "old_line_content": "",
          "new_line_content": "    current_thread->detachQuery(true);",
          "content_same": false
        },
        {
          "line": 542,
          "old_api": null,
          "new_api": "CurrentThread::attachQueryContext(query_context)",
          "old_text": null,
          "new_text": "CurrentThread::attachQueryContext(query_context)",
          "old_line_content": "}",
          "new_line_content": "    CurrentThread::attachQueryContext(query_context);",
          "content_same": false
        },
        {
          "line": 543,
          "old_api": null,
          "new_api": "hasQueryContext",
          "old_text": null,
          "new_text": "query_context->hasQueryContext()",
          "old_line_content": "",
          "new_line_content": "    if (!query_context->hasQueryContext())",
          "content_same": false
        },
        {
          "line": 544,
          "old_api": null,
          "new_api": "makeQueryContext",
          "old_text": null,
          "new_text": "query_context->makeQueryContext()",
          "old_line_content": "CurrentThread::QueryScope::QueryScope(ContextPtr query_context)",
          "new_line_content": "        query_context->makeQueryContext();",
          "content_same": false
        },
        {
          "line": 416,
          "old_api": null,
          "new_api": "getClientInfo",
          "old_text": null,
          "new_text": "query_context_ptr->getClientInfo()",
          "old_line_content": "        {",
          "new_line_content": "        elem.client_info = query_context_ptr->getClientInfo();",
          "content_same": false
        },
        {
          "line": 549,
          "old_api": null,
          "new_api": "hasQueryContext",
          "old_text": null,
          "new_text": "query_context->hasQueryContext()",
          "old_line_content": "",
          "new_line_content": "    if (!query_context->hasQueryContext())",
          "content_same": false
        },
        {
          "line": 421,
          "old_api": null,
          "new_api": "getPartiallyAtomicSnapshot",
          "old_text": null,
          "new_text": "performance_counters.getPartiallyAtomicSnapshot()",
          "old_line_content": "",
          "new_line_content": "            elem.profile_counters = std::make_shared<ProfileEvents::Counters::Snapshot>(performance_counters.getPartiallyAtomicSnapshot());",
          "content_same": false
        },
        {
          "line": 553,
          "old_api": null,
          "new_api": "CurrentThread::initializeQuery()",
          "old_text": null,
          "new_text": "CurrentThread::initializeQuery()",
          "old_line_content": "",
          "new_line_content": "    CurrentThread::initializeQuery();",
          "content_same": false
        },
        {
          "line": 554,
          "old_api": null,
          "new_api": "CurrentThread::attachQueryContext(query_context)",
          "old_text": null,
          "new_text": "CurrentThread::attachQueryContext(query_context)",
          "old_line_content": "void CurrentThread::QueryScope::logPeakMemoryUsage()",
          "new_line_content": "    CurrentThread::attachQueryContext(query_context);",
          "content_same": false
        },
        {
          "line": 425,
          "old_api": null,
          "new_api": "add",
          "old_text": null,
          "new_text": "thread_log.add(elem)",
          "old_line_content": "static String getCleanQueryAst(const ASTPtr q, ContextPtr context)",
          "new_line_content": "    thread_log.add(elem);",
          "content_same": false
        },
        {
          "line": 430,
          "old_api": null,
          "new_api": "serializeAST",
          "old_text": null,
          "new_text": "serializeAST(*q, true)",
          "old_line_content": "",
          "new_line_content": "    String res = serializeAST(*q, true);",
          "content_same": false
        },
        {
          "line": 559,
          "old_api": null,
          "new_api": "CurrentThread::getGroup()",
          "old_text": null,
          "new_text": "CurrentThread::getGroup()",
          "old_line_content": "",
          "new_line_content": "    auto group = CurrentThread::getGroup();",
          "content_same": false
        },
        {
          "line": 432,
          "old_api": null,
          "new_api": "wipeSensitiveData",
          "old_text": null,
          "new_text": "masker->wipeSensitiveData(res)",
          "old_line_content": "",
          "new_line_content": "        masker->wipeSensitiveData(res);",
          "content_same": false
        },
        {
          "line": 434,
          "old_api": null,
          "new_api": "getSettingsRef",
          "old_text": null,
          "new_text": "context->getSettingsRef()",
          "old_line_content": "}",
          "new_line_content": "    res = res.substr(0, context->getSettingsRef().log_queries_cut_to_length);",
          "content_same": false
        },
        {
          "line": 564,
          "old_api": null,
          "new_api": "logPeakMemoryUsage",
          "old_text": null,
          "new_text": "group->memory_tracker.logPeakMemoryUsage()",
          "old_line_content": "CurrentThread::QueryScope::~QueryScope()",
          "new_line_content": "    group->memory_tracker.logPeakMemoryUsage();",
          "content_same": false
        },
        {
          "line": 572,
          "old_api": null,
          "new_api": "logPeakMemoryUsage",
          "old_text": null,
          "new_text": "logPeakMemoryUsage()",
          "old_line_content": "    }",
          "new_line_content": "            logPeakMemoryUsage();",
          "content_same": false
        },
        {
          "line": 444,
          "old_api": null,
          "new_api": "getQueryViewsLog",
          "old_text": null,
          "new_text": "query_context_ptr->getQueryViewsLog()",
          "old_line_content": "",
          "new_line_content": "    auto views_log = query_context_ptr->getQueryViewsLog();",
          "content_same": false
        },
        {
          "line": 574,
          "old_api": null,
          "new_api": "CurrentThread::detachQueryIfNotDetached()",
          "old_text": null,
          "new_text": "CurrentThread::detachQueryIfNotDetached()",
          "old_line_content": "    {",
          "new_line_content": "        CurrentThread::detachQueryIfNotDetached();",
          "content_same": false
        },
        {
          "line": 578,
          "old_api": null,
          "new_api": "tryLogCurrentException",
          "old_text": null,
          "new_text": "tryLogCurrentException(\"CurrentThread\", __PRETTY_FUNCTION__)",
          "old_line_content": "",
          "new_line_content": "        tryLogCurrentException(\"CurrentThread\", __PRETTY_FUNCTION__);",
          "content_same": false
        },
        {
          "line": 450,
          "old_api": null,
          "new_api": "time_in_seconds",
          "old_text": null,
          "new_text": "time_in_seconds(vinfo.runtime_stats->event_time)",
          "old_line_content": "",
          "new_line_content": "    element.event_time = time_in_seconds(vinfo.runtime_stats->event_time);",
          "content_same": false
        },
        {
          "line": 451,
          "old_api": null,
          "new_api": "time_in_microseconds",
          "old_text": null,
          "new_text": "time_in_microseconds(vinfo.runtime_stats->event_time)",
          "old_line_content": "    element.initial_query_id = query_id;",
          "new_line_content": "    element.event_time_microseconds = time_in_microseconds(vinfo.runtime_stats->event_time);",
          "content_same": false
        },
        {
          "line": 455,
          "old_api": null,
          "new_api": "getFullTableName",
          "old_text": null,
          "new_text": "vinfo.table_id.getFullTableName()",
          "old_line_content": "    if (vinfo.query)",
          "new_line_content": "    element.view_name = vinfo.table_id.getFullTableName();",
          "content_same": false
        },
        {
          "line": 466,
          "old_api": null,
          "new_api": "load",
          "old_text": null,
          "new_text": "progress_out.written_bytes.load(std::memory_order_relaxed)",
          "old_line_content": "    {",
          "new_line_content": "    element.written_bytes = progress_out.written_bytes.load(std::memory_order_relaxed);",
          "content_same": false
        },
        {
          "line": 467,
          "old_api": null,
          "new_api": "getPeak",
          "old_text": null,
          "new_text": "memory_tracker.getPeak()",
          "old_line_content": "        element.profile_counters = events;",
          "new_line_content": "    element.peak_memory_usage = memory_tracker.getPeak() > 0 ? memory_tracker.getPeak() : 0;",
          "content_same": false
        },
        {
          "line": 468,
          "old_api": null,
          "new_api": "getSettingsRef",
          "old_text": null,
          "new_text": "query_context_ptr->getSettingsRef()",
          "old_line_content": "    }",
          "new_line_content": "    if (query_context_ptr->getSettingsRef().log_profile_events != 0)",
          "content_same": false
        },
        {
          "line": 478,
          "old_api": null,
          "new_api": "getExceptionMessage",
          "old_text": null,
          "new_text": "getExceptionMessage(vinfo.exception, false)",
          "old_line_content": "    }",
          "new_line_content": "        element.exception = getExceptionMessage(vinfo.exception, false);",
          "content_same": false
        },
        {
          "line": 479,
          "old_api": null,
          "new_api": "getSettingsRef",
          "old_text": null,
          "new_text": "query_context_ptr->getSettingsRef()",
          "old_line_content": "",
          "new_line_content": "        if (query_context_ptr->getSettingsRef().calculate_text_stack_trace)",
          "content_same": false
        },
        {
          "line": 483,
          "old_api": null,
          "new_api": "add",
          "old_text": null,
          "new_text": "views_log->add(element)",
          "old_line_content": "void CurrentThread::initializeQuery()",
          "new_line_content": "    views_log->add(element);",
          "content_same": false
        },
        {
          "line": 358,
          "old_api": null,
          "new_api": "reset",
          "old_text": null,
          "new_text": "thread_group.reset()",
          "old_line_content": "",
          "new_line_content": "    thread_group.reset();",
          "content_same": false
        },
        {
          "line": 488,
          "old_api": null,
          "new_api": "unlikely",
          "old_text": null,
          "new_text": "unlikely(!current_thread)",
          "old_line_content": "    current_thread->deleter = CurrentThread::defaultThreadDeleter;",
          "new_line_content": "    if (unlikely(!current_thread))",
          "content_same": false
        },
        {
          "line": 490,
          "old_api": null,
          "new_api": "initializeQuery",
          "old_text": null,
          "new_text": "current_thread->initializeQuery()",
          "old_line_content": "",
          "new_line_content": "    current_thread->initializeQuery();",
          "content_same": false
        },
        {
          "line": 367,
          "old_api": null,
          "new_api": "setpriority",
          "old_text": null,
          "new_text": "setpriority(PRIO_PROCESS, thread_id, 0)",
          "old_line_content": "        os_thread_priority = 0;",
          "new_line_content": "        if (0 != setpriority(PRIO_PROCESS, thread_id, 0))",
          "content_same": false
        },
        {
          "line": 368,
          "old_api": null,
          "new_api": "errnoToString",
          "old_text": null,
          "new_text": "errnoToString()",
          "old_line_content": "    }",
          "new_line_content": "            LOG_ERROR(log, \"Cannot 'setpriority' back to zero: {}\", errnoToString());",
          "content_same": false
        },
        {
          "line": 496,
          "old_api": null,
          "new_api": "unlikely",
          "old_text": null,
          "new_text": "unlikely(!current_thread)",
          "old_line_content": "    current_thread->deleter = CurrentThread::defaultThreadDeleter;",
          "new_line_content": "    if (unlikely(!current_thread))",
          "content_same": false
        },
        {
          "line": 498,
          "old_api": null,
          "new_api": "attachQuery",
          "old_text": null,
          "new_text": "current_thread->attachQuery(thread_group, true)",
          "old_line_content": "",
          "new_line_content": "    current_thread->attachQuery(thread_group, true);",
          "content_same": false
        },
        {
          "line": 504,
          "old_api": null,
          "new_api": "unlikely",
          "old_text": null,
          "new_text": "unlikely(!current_thread)",
          "old_line_content": "    current_thread->deleter = CurrentThread::defaultThreadDeleter;",
          "new_line_content": "    if (unlikely(!current_thread))",
          "content_same": false
        },
        {
          "line": 506,
          "old_api": null,
          "new_api": "attachQuery",
          "old_text": null,
          "new_text": "current_thread->attachQuery(thread_group, false)",
          "old_line_content": "",
          "new_line_content": "    current_thread->attachQuery(thread_group, false);",
          "content_same": false
        },
        {
          "line": 381,
          "old_api": null,
          "new_api": "time_in_seconds",
          "old_text": null,
          "new_text": "time_in_seconds(now)",
          "old_line_content": "    elem.event_time = current_time;",
          "new_line_content": "    auto current_time = time_in_seconds(now);",
          "content_same": false
        },
        {
          "line": 382,
          "old_api": null,
          "new_api": "time_in_microseconds",
          "old_text": null,
          "new_text": "time_in_microseconds(now)",
          "old_line_content": "    elem.event_time_microseconds = current_time_microseconds;",
          "new_line_content": "    auto current_time_microseconds = time_in_microseconds(now);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 385,
          "old_api": "time_in_nanoseconds",
          "new_api": null,
          "old_text": "time_in_nanoseconds(now)",
          "new_text": null,
          "old_line_content": "    elem.query_duration_ms = (time_in_nanoseconds(now) - query_start_time_nanoseconds) / 1000000U;",
          "new_line_content": "    elem.event_time_microseconds = current_time_microseconds;",
          "content_same": false
        },
        {
          "line": 387,
          "old_api": "load",
          "new_api": null,
          "old_text": "progress_in.read_rows.load(std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "    elem.read_rows = progress_in.read_rows.load(std::memory_order_relaxed);",
          "new_line_content": "    elem.query_start_time_microseconds = query_start_time_microseconds;",
          "content_same": false
        },
        {
          "line": 516,
          "old_api": "unlikely",
          "new_api": null,
          "old_text": "unlikely(!current_thread)",
          "new_text": null,
          "old_line_content": "    if (unlikely(!current_thread))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 518,
          "old_api": "finalizePerformanceCounters",
          "new_api": null,
          "old_text": "current_thread->finalizePerformanceCounters()",
          "new_text": null,
          "old_line_content": "    current_thread->finalizePerformanceCounters();",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 392,
          "old_api": "get",
          "new_api": null,
          "old_text": "memory_tracker.get()",
          "new_text": null,
          "old_line_content": "    elem.memory_usage = memory_tracker.get();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 523,
          "old_api": "unlikely",
          "new_api": null,
          "old_text": "unlikely(!current_thread)",
          "new_text": null,
          "old_line_content": "    if (unlikely(!current_thread))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 525,
          "old_api": "detachQuery",
          "new_api": null,
          "old_text": "current_thread->detachQuery(false)",
          "new_text": null,
          "old_line_content": "    current_thread->detachQuery(false);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 530,
          "old_api": "unlikely",
          "new_api": null,
          "old_text": "unlikely(!current_thread)",
          "new_text": null,
          "old_line_content": "    if (unlikely(!current_thread))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 532,
          "old_api": "detachQuery",
          "new_api": null,
          "old_text": "current_thread->detachQuery(true)",
          "new_text": null,
          "old_line_content": "    current_thread->detachQuery(true);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 538,
          "old_api": "CurrentThread::initializeQuery()",
          "new_api": null,
          "old_text": "CurrentThread::initializeQuery()",
          "new_text": null,
          "old_line_content": "    CurrentThread::initializeQuery();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 539,
          "old_api": "CurrentThread::attachQueryContext(query_context)",
          "new_api": null,
          "old_text": "CurrentThread::attachQueryContext(query_context)",
          "new_text": null,
          "old_line_content": "    CurrentThread::attachQueryContext(query_context);",
          "new_line_content": "CurrentThread::QueryScope::QueryScope(ContextMutablePtr query_context)",
          "content_same": false
        },
        {
          "line": 540,
          "old_api": "hasQueryContext",
          "new_api": null,
          "old_text": "query_context->hasQueryContext()",
          "new_text": null,
          "old_line_content": "    if (!query_context->hasQueryContext())",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 410,
          "old_api": "lock",
          "new_api": null,
          "old_text": "query_context.lock()",
          "new_text": null,
          "old_line_content": "    auto query_context_ptr = query_context.lock();",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 415,
          "old_api": "getSettingsRef",
          "new_api": null,
          "old_text": "query_context_ptr->getSettingsRef()",
          "new_text": null,
          "old_line_content": "        if (query_context_ptr->getSettingsRef().log_profile_events != 0)",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 546,
          "old_api": "hasQueryContext",
          "new_api": null,
          "old_text": "query_context->hasQueryContext()",
          "new_text": null,
          "old_line_content": "    if (!query_context->hasQueryContext())",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 547,
          "old_api": "Exception",
          "new_api": null,
          "old_text": "Exception(\n            ErrorCodes::LOGICAL_ERROR, \"Cannot initialize query scope without query context\")",
          "new_text": null,
          "old_line_content": "        throw Exception(",
          "new_line_content": "CurrentThread::QueryScope::QueryScope(ContextPtr query_context)",
          "content_same": false
        },
        {
          "line": 422,
          "old_api": "add",
          "new_api": null,
          "old_text": "thread_log.add(elem)",
          "new_text": null,
          "old_line_content": "    thread_log.add(elem);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 551,
          "old_api": "CurrentThread::attachQueryContext(query_context)",
          "new_api": null,
          "old_text": "CurrentThread::attachQueryContext(query_context)",
          "new_text": null,
          "old_line_content": "    CurrentThread::attachQueryContext(query_context);",
          "new_line_content": "            ErrorCodes::LOGICAL_ERROR, \"Cannot initialize query scope without query context\");",
          "content_same": false
        },
        {
          "line": 427,
          "old_api": "serializeAST",
          "new_api": null,
          "old_text": "serializeAST(*q, true)",
          "new_text": null,
          "old_line_content": "    String res = serializeAST(*q, true);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 556,
          "old_api": "CurrentThread::getGroup()",
          "new_api": null,
          "old_text": "CurrentThread::getGroup()",
          "new_text": null,
          "old_line_content": "    auto group = CurrentThread::getGroup();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 428,
          "old_api": "SensitiveDataMasker::getInstance()",
          "new_api": null,
          "old_text": "SensitiveDataMasker::getInstance()",
          "new_text": null,
          "old_line_content": "    if (auto * masker = SensitiveDataMasker::getInstance())",
          "new_line_content": "static String getCleanQueryAst(const ASTPtr q, ContextPtr context)",
          "content_same": false
        },
        {
          "line": 429,
          "old_api": "wipeSensitiveData",
          "new_api": null,
          "old_text": "masker->wipeSensitiveData(res)",
          "new_text": null,
          "old_line_content": "        masker->wipeSensitiveData(res);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 561,
          "old_api": "logPeakMemoryUsage",
          "new_api": null,
          "old_text": "group->memory_tracker.logPeakMemoryUsage()",
          "new_text": null,
          "old_line_content": "    group->memory_tracker.logPeakMemoryUsage();",
          "new_line_content": "        return;",
          "content_same": false
        },
        {
          "line": 438,
          "old_api": "lock",
          "new_api": null,
          "old_text": "query_context.lock()",
          "new_text": null,
          "old_line_content": "    auto query_context_ptr = query_context.lock();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 569,
          "old_api": "logPeakMemoryUsage",
          "new_api": null,
          "old_text": "logPeakMemoryUsage()",
          "new_text": null,
          "old_line_content": "            logPeakMemoryUsage();",
          "new_line_content": "    try",
          "content_same": false
        },
        {
          "line": 571,
          "old_api": "CurrentThread::detachQueryIfNotDetached()",
          "new_api": null,
          "old_text": "CurrentThread::detachQueryIfNotDetached()",
          "new_text": null,
          "old_line_content": "        CurrentThread::detachQueryIfNotDetached();",
          "new_line_content": "        if (log_peak_memory_usage_in_destructor)",
          "content_same": false
        },
        {
          "line": 575,
          "old_api": "tryLogCurrentException",
          "new_api": null,
          "old_text": "tryLogCurrentException(\"CurrentThread\", __PRETTY_FUNCTION__)",
          "new_text": null,
          "old_line_content": "        tryLogCurrentException(\"CurrentThread\", __PRETTY_FUNCTION__);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 447,
          "old_api": "time_in_seconds",
          "new_api": null,
          "old_text": "time_in_seconds(vinfo.runtime_stats->event_time)",
          "new_text": null,
          "old_line_content": "    element.event_time = time_in_seconds(vinfo.runtime_stats->event_time);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 448,
          "old_api": "time_in_microseconds",
          "new_api": null,
          "old_text": "time_in_microseconds(vinfo.runtime_stats->event_time)",
          "new_text": null,
          "old_line_content": "    element.event_time_microseconds = time_in_microseconds(vinfo.runtime_stats->event_time);",
          "new_line_content": "    QueryViewsLogElement element;",
          "content_same": false
        },
        {
          "line": 452,
          "old_api": "getFullTableName",
          "new_api": null,
          "old_text": "vinfo.table_id.getFullTableName()",
          "new_text": null,
          "old_line_content": "    element.view_name = vinfo.table_id.getFullTableName();",
          "new_line_content": "    element.view_duration_ms = vinfo.runtime_stats->elapsed_ms;",
          "content_same": false
        },
        {
          "line": 456,
          "old_api": "getCleanQueryAst",
          "new_api": null,
          "old_text": "getCleanQueryAst(vinfo.query, query_context_ptr)",
          "new_text": null,
          "old_line_content": "        element.view_query = getCleanQueryAst(vinfo.query, query_context_ptr);",
          "new_line_content": "    element.view_uuid = vinfo.table_id.uuid;",
          "content_same": false
        },
        {
          "line": 460,
          "old_api": "load",
          "new_api": null,
          "old_text": "progress_in.read_rows.load(std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "    element.read_rows = progress_in.read_rows.load(std::memory_order_relaxed);",
          "new_line_content": "    element.view_target = vinfo.runtime_stats->target_name;",
          "content_same": false
        },
        {
          "line": 461,
          "old_api": "load",
          "new_api": null,
          "old_text": "progress_in.read_bytes.load(std::memory_order_relaxed)",
          "new_text": null,
          "old_line_content": "    element.read_bytes = progress_in.read_bytes.load(std::memory_order_relaxed);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 474,
          "old_api": "getExceptionErrorCode",
          "new_api": null,
          "old_text": "getExceptionErrorCode(vinfo.exception)",
          "new_text": null,
          "old_line_content": "        element.exception_code = getExceptionErrorCode(vinfo.exception);",
          "new_line_content": "    element.exception_code = 0;",
          "content_same": false
        },
        {
          "line": 475,
          "old_api": "getExceptionMessage",
          "new_api": null,
          "old_text": "getExceptionMessage(vinfo.exception, false)",
          "new_text": null,
          "old_line_content": "        element.exception = getExceptionMessage(vinfo.exception, false);",
          "new_line_content": "    if (vinfo.exception)",
          "content_same": false
        },
        {
          "line": 476,
          "old_api": "getSettingsRef",
          "new_api": null,
          "old_text": "query_context_ptr->getSettingsRef()",
          "new_text": null,
          "old_line_content": "        if (query_context_ptr->getSettingsRef().calculate_text_stack_trace)",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 353,
          "old_api": "getProfileEventsCountersAndMemoryForThreads",
          "new_api": null,
          "old_text": "thread_group->getProfileEventsCountersAndMemoryForThreads()",
          "new_text": null,
          "old_line_content": "    thread_group->getProfileEventsCountersAndMemoryForThreads();",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 485,
          "old_api": "unlikely",
          "new_api": null,
          "old_text": "unlikely(!current_thread)",
          "new_text": null,
          "old_line_content": "    if (unlikely(!current_thread))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 487,
          "old_api": "initializeQuery",
          "new_api": null,
          "old_text": "current_thread->initializeQuery()",
          "new_text": null,
          "old_line_content": "    current_thread->initializeQuery();",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 362,
          "old_api": "LOG_TRACE",
          "new_api": null,
          "old_text": "LOG_TRACE(log, \"Resetting nice\")",
          "new_text": null,
          "old_line_content": "        LOG_TRACE(log, \"Resetting nice\");",
          "new_line_content": "#if defined(OS_LINUX)",
          "content_same": false
        },
        {
          "line": 364,
          "old_api": "setpriority",
          "new_api": null,
          "old_text": "setpriority(PRIO_PROCESS, thread_id, 0)",
          "new_text": null,
          "old_line_content": "        if (0 != setpriority(PRIO_PROCESS, thread_id, 0))",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 493,
          "old_api": "unlikely",
          "new_api": null,
          "old_text": "unlikely(!current_thread)",
          "new_text": null,
          "old_line_content": "    if (unlikely(!current_thread))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 495,
          "old_api": "attachQuery",
          "new_api": null,
          "old_text": "current_thread->attachQuery(thread_group, true)",
          "new_text": null,
          "old_line_content": "    current_thread->attachQuery(thread_group, true);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 501,
          "old_api": "unlikely",
          "new_api": null,
          "old_text": "unlikely(!current_thread)",
          "new_text": null,
          "old_line_content": "    if (unlikely(!current_thread))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 503,
          "old_api": "attachQuery",
          "new_api": null,
          "old_text": "current_thread->attachQuery(thread_group, false)",
          "new_text": null,
          "old_line_content": "    current_thread->attachQuery(thread_group, false);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 378,
          "old_api": "time_in_seconds",
          "new_api": null,
          "old_text": "time_in_seconds(now)",
          "new_text": null,
          "old_line_content": "    auto current_time = time_in_seconds(now);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 379,
          "old_api": "time_in_microseconds",
          "new_api": null,
          "old_text": "time_in_microseconds(now)",
          "new_text": null,
          "old_line_content": "    auto current_time_microseconds = time_in_microseconds(now);",
          "new_line_content": "    // construct current_time and current_time_microseconds using the same time point",
          "content_same": false
        },
        {
          "line": 509,
          "old_api": "unlikely",
          "new_api": null,
          "old_text": "unlikely(!current_thread)",
          "new_text": null,
          "old_line_content": "    if (unlikely(!current_thread))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 511,
          "old_api": "attachQueryContext",
          "new_api": null,
          "old_text": "current_thread->attachQueryContext(query_context)",
          "new_text": null,
          "old_line_content": "    current_thread->attachQueryContext(query_context);",
          "new_line_content": "{",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 17,
      "total_additions": 49,
      "total_deletions": 49,
      "total_api_changes": 115
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 4,
        "api_related_lines": 115,
        "non_api_lines": 2,
        "non_api_line_numbers": [
          354,
          356
        ]
      }
    },
    "api_calls_before": 169,
    "api_calls_after": 169,
    "diff_info": {
      "added_lines": 4,
      "removed_lines": 1,
      "total_diff_lines": 17
    }
  }
}