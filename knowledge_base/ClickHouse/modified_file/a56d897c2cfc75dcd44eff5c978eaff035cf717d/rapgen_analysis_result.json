{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/a56d897c2cfc75dcd44eff5c978eaff035cf717d",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/a56d897c2cfc75dcd44eff5c978eaff035cf717d/before.h",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/a56d897c2cfc75dcd44eff5c978eaff035cf717d/after.h",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/a56d897c2cfc75dcd44eff5c978eaff035cf717d/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 192,
          "old_api": "findCounter",
          "new_api": "emplace",
          "old_text": "findCounter(min->key, min->hash)",
          "new_text": "arena.emplace(key)",
          "old_line_content": "        counter = findCounter(min->key, min->hash);",
          "new_line_content": "        push(new Counter(arena.emplace(key), alpha + increment, alpha + error, hash));",
          "content_same": false
        },
        {
          "line": 211,
          "old_api": "capacity",
          "new_api": "back",
          "old_text": "capacity()",
          "new_text": "rhs.counter_list.back()",
          "old_line_content": "        if (size() == capacity())",
          "new_line_content": "            m2 = rhs.counter_list.back()->count;",
          "content_same": false
        },
        {
          "line": 270,
          "old_api": "size",
          "new_api": "destroyElements",
          "old_text": "alpha_map.size()",
          "new_text": "destroyElements()",
          "old_line_content": "        writeVarUInt(alpha_map.size(), wb);",
          "new_line_content": "        destroyElements();",
          "content_same": false
        },
        {
          "line": 272,
          "old_api": "writeVarUInt",
          "new_api": "readVarUInt",
          "old_text": "writeVarUInt(alpha, wb)",
          "new_text": "readVarUInt(count, rb)",
          "old_line_content": "            writeVarUInt(alpha, wb);",
          "new_line_content": "        readVarUInt(count, rb);",
          "content_same": false
        },
        {
          "line": 277,
          "old_api": "destroyElements",
          "new_api": "read",
          "old_text": "destroyElements()",
          "new_text": "counter->read(rb)",
          "old_line_content": "        destroyElements();",
          "new_line_content": "            counter->read(rb);",
          "content_same": false
        },
        {
          "line": 279,
          "old_api": "readVarUInt",
          "new_api": "push",
          "old_text": "readVarUInt(count, rb)",
          "new_text": "push(counter)",
          "old_line_content": "        readVarUInt(count, rb);",
          "new_line_content": "            push(counter);",
          "content_same": false
        },
        {
          "line": 300,
          "old_api": "push_back",
          "new_api": "size",
          "old_text": "alpha_map.push_back(alpha)",
          "new_text": "counter_list.size()",
          "old_line_content": "            alpha_map.push_back(alpha);",
          "new_line_content": "        counter->slot = counter_list.size();",
          "content_same": false
        },
        {
          "line": 335,
          "old_api": "clear",
          "new_api": "back",
          "old_text": "counter_map.clear()",
          "new_text": "counter_list.back()",
          "old_line_content": "        counter_map.clear();",
          "new_line_content": "        auto last_element = counter_list.back();",
          "content_same": false
        },
        {
          "line": 337,
          "old_api": "clear",
          "new_api": "pop_back",
          "old_text": "alpha_map.clear()",
          "new_text": "counter_list.pop_back()",
          "old_line_content": "        alpha_map.clear();",
          "new_line_content": "        counter_list.pop_back();",
          "content_same": false
        },
        {
          "line": 347,
          "old_api": "size",
          "new_api": "getSecond",
          "old_text": "counter_map.size()",
          "new_text": "it->getSecond()",
          "old_line_content": "        if (removed_keys * 2 > counter_map.size())",
          "new_line_content": "        if (it == counter_map.end() || it->getSecond()->slot == -1)",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 259,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "size()",
          "old_line_content": "                break;",
          "new_line_content": "        writeVarUInt(size(), wb);",
          "content_same": false
        },
        {
          "line": 261,
          "old_api": null,
          "new_api": "write",
          "old_text": null,
          "new_text": "counter->write(wb)",
          "old_line_content": "        return res;",
          "new_line_content": "            counter->write(wb);",
          "content_same": false
        },
        {
          "line": 263,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "alpha_map.size()",
          "old_line_content": "",
          "new_line_content": "        writeVarUInt(alpha_map.size(), wb);",
          "content_same": false
        },
        {
          "line": 265,
          "old_api": null,
          "new_api": "writeVarUInt",
          "old_text": null,
          "new_text": "writeVarUInt(alpha, wb)",
          "old_line_content": "    {",
          "new_line_content": "            writeVarUInt(alpha, wb);",
          "content_same": false
        },
        {
          "line": 278,
          "old_api": null,
          "new_api": "hash",
          "old_text": null,
          "new_text": "counter_map.hash(counter->key)",
          "old_line_content": "        size_t count = 0;",
          "new_line_content": "            counter->hash = counter_map.hash(counter->key);",
          "content_same": false
        },
        {
          "line": 282,
          "old_api": null,
          "new_api": "readAlphaMap",
          "old_text": null,
          "new_text": "readAlphaMap(rb)",
          "old_line_content": "        {",
          "new_line_content": "        readAlphaMap(rb);",
          "content_same": false
        },
        {
          "line": 288,
          "old_api": null,
          "new_api": "readVarUInt",
          "old_text": null,
          "new_text": "readVarUInt(alpha_size, rb)",
          "old_line_content": "",
          "new_line_content": "        readVarUInt(alpha_size, rb);",
          "content_same": false
        },
        {
          "line": 292,
          "old_api": null,
          "new_api": "readVarUInt",
          "old_text": null,
          "new_text": "readVarUInt(alpha, rb)",
          "old_line_content": "    void readAlphaMap(ReadBuffer & rb)",
          "new_line_content": "            readVarUInt(alpha, rb);",
          "content_same": false
        },
        {
          "line": 293,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "alpha_map.push_back(alpha)",
          "old_line_content": "    {",
          "new_line_content": "            alpha_map.push_back(alpha);",
          "content_same": false
        },
        {
          "line": 301,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "counter_list.push_back(counter)",
          "old_line_content": "        }",
          "new_line_content": "        counter_list.push_back(counter);",
          "content_same": false
        },
        {
          "line": 303,
          "old_api": null,
          "new_api": "percolate",
          "old_text": null,
          "new_text": "percolate(counter)",
          "old_line_content": "",
          "new_line_content": "        percolate(counter);",
          "content_same": false
        },
        {
          "line": 314,
          "old_api": null,
          "new_api": "std::swap(next->slot, counter->slot)",
          "old_text": null,
          "new_text": "std::swap(next->slot, counter->slot)",
          "old_line_content": "    void percolate(Counter * counter)",
          "new_line_content": "                std::swap(next->slot, counter->slot);",
          "content_same": false
        },
        {
          "line": 315,
          "old_api": null,
          "new_api": "std::swap(counter_list[next->slot], counter_list[counter->slot])",
          "old_text": null,
          "new_text": "std::swap(counter_list[next->slot], counter_list[counter->slot])",
          "old_line_content": "    {",
          "new_line_content": "                std::swap(counter_list[next->slot], counter_list[counter->slot]);",
          "content_same": false
        },
        {
          "line": 190,
          "old_api": null,
          "new_api": "destroyLastElement",
          "old_text": null,
          "new_text": "destroyLastElement()",
          "old_line_content": "",
          "new_line_content": "        destroyLastElement();",
          "content_same": false
        },
        {
          "line": 328,
          "old_api": null,
          "new_api": "clear",
          "old_text": null,
          "new_text": "counter_map.clear()",
          "old_line_content": "",
          "new_line_content": "        counter_map.clear();",
          "content_same": false
        },
        {
          "line": 329,
          "old_api": null,
          "new_api": "clear",
          "old_text": null,
          "new_text": "counter_list.clear()",
          "old_line_content": "private:",
          "new_line_content": "        counter_list.clear();",
          "content_same": false
        },
        {
          "line": 330,
          "old_api": null,
          "new_api": "clear",
          "old_text": null,
          "new_text": "alpha_map.clear()",
          "old_line_content": "    void destroyElements()",
          "new_line_content": "        alpha_map.clear();",
          "content_same": false
        },
        {
          "line": 204,
          "old_api": null,
          "new_api": "capacity",
          "old_text": null,
          "new_text": "capacity()",
          "old_line_content": "     *  https://arxiv.org/pdf/1401.0702.pdf",
          "new_line_content": "        if (size() == capacity())",
          "content_same": false
        },
        {
          "line": 206,
          "old_api": null,
          "new_api": "back",
          "old_text": null,
          "new_text": "counter_list.back()",
          "old_line_content": "    void merge(const Self & rhs)",
          "new_line_content": "            m1 = counter_list.back()->count;",
          "content_same": false
        },
        {
          "line": 209,
          "old_api": null,
          "new_api": "capacity",
          "old_text": null,
          "new_text": "rhs.capacity()",
          "old_line_content": "        UInt64 m2 = 0;",
          "new_line_content": "        if (rhs.size() == rhs.capacity())",
          "content_same": false
        },
        {
          "line": 340,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "counter_map.size()",
          "old_line_content": "    void destroyLastElement()",
          "new_line_content": "        if (removed_keys * 2 > counter_map.size())",
          "content_same": false
        },
        {
          "line": 341,
          "old_api": null,
          "new_api": "rebuildCounterMap",
          "old_text": null,
          "new_text": "rebuildCounterMap()",
          "old_line_content": "    {",
          "new_line_content": "            rebuildCounterMap();",
          "content_same": false
        },
        {
          "line": 346,
          "old_api": null,
          "new_api": "find",
          "old_text": null,
          "new_text": "counter_map.find(key, hash)",
          "old_line_content": "        ++removed_keys;",
          "new_line_content": "        auto it = counter_map.find(key, hash);",
          "content_same": false
        },
        {
          "line": 350,
          "old_api": null,
          "new_api": "getSecond",
          "old_text": null,
          "new_text": "it->getSecond()",
          "old_line_content": "",
          "new_line_content": "        return it->getSecond();",
          "content_same": false
        },
        {
          "line": 230,
          "old_api": null,
          "new_api": "boost::adaptors::reverse(rhs.counter_list)",
          "old_text": null,
          "new_text": "boost::adaptors::reverse(rhs.counter_list)",
          "old_line_content": "            {",
          "new_line_content": "        for (auto counter : boost::adaptors::reverse(rhs.counter_list))",
          "content_same": false
        },
        {
          "line": 358,
          "old_api": null,
          "new_api": "getSecond",
          "old_text": null,
          "new_text": "cell.getSecond()",
          "old_line_content": "    }",
          "new_line_content": "            auto counter = cell.getSecond();",
          "content_same": false
        },
        {
          "line": 232,
          "old_api": null,
          "new_api": "hash",
          "old_text": null,
          "new_text": "counter_map.hash(counter->key)",
          "old_line_content": "                counter->error += m2;",
          "new_line_content": "            if (findCounter(counter->key, counter_map.hash(counter->key)))",
          "content_same": false
        },
        {
          "line": 235,
          "old_api": null,
          "new_api": "insert",
          "old_text": null,
          "new_text": "insert(counter->key, counter->count - m2, counter->error - m2)",
          "old_line_content": "",
          "new_line_content": "                insert(counter->key, counter->count - m2, counter->error - m2);",
          "content_same": false
        },
        {
          "line": 363,
          "old_api": null,
          "new_api": "clear",
          "old_text": null,
          "new_text": "counter_map.clear()",
          "old_line_content": "        for (const auto & cell : counter_map)",
          "new_line_content": "        counter_map.clear();",
          "content_same": false
        },
        {
          "line": 240,
          "old_api": null,
          "new_api": "insert",
          "old_text": null,
          "new_text": "insert(counter->key, counter->count + m1, counter->error + m1)",
          "old_line_content": "            {",
          "new_line_content": "                insert(counter->key, counter->count + m1, counter->error + m1);",
          "content_same": false
        },
        {
          "line": 250,
          "old_api": null,
          "new_api": "push_back",
          "old_text": null,
          "new_text": "res.push_back(*counter)",
          "old_line_content": "    }",
          "new_line_content": "            res.push_back(*counter);",
          "content_same": false
        },
        {
          "line": 251,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "res.size()",
          "old_line_content": "",
          "new_line_content": "            if (res.size() == k)",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 257,
          "old_api": "push_back",
          "new_api": null,
          "old_text": "res.push_back(*counter)",
          "new_text": null,
          "old_line_content": "            res.push_back(*counter);",
          "new_line_content": "    void write(WriteBuffer & wb) const",
          "content_same": false
        },
        {
          "line": 258,
          "old_api": "size",
          "new_api": null,
          "old_text": "res.size()",
          "new_text": null,
          "old_line_content": "            if (res.size() == k)",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 266,
          "old_api": "size",
          "new_api": null,
          "old_text": "size()",
          "new_text": null,
          "old_line_content": "        writeVarUInt(size(), wb);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 268,
          "old_api": "write",
          "new_api": null,
          "old_text": "counter->write(wb)",
          "new_text": null,
          "old_line_content": "            counter->write(wb);",
          "new_line_content": "    void read(ReadBuffer & rb)",
          "content_same": false
        },
        {
          "line": 284,
          "old_api": "read",
          "new_api": null,
          "old_text": "counter->read(rb)",
          "new_text": null,
          "old_line_content": "            counter->read(rb);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 285,
          "old_api": "hash",
          "new_api": null,
          "old_text": "counter_map.hash(counter->key)",
          "new_text": null,
          "old_line_content": "            counter->hash = counter_map.hash(counter->key);",
          "new_line_content": "    void readAlphaMap(ReadBuffer & rb)",
          "content_same": false
        },
        {
          "line": 286,
          "old_api": "push",
          "new_api": null,
          "old_text": "push(counter)",
          "new_text": null,
          "old_line_content": "            push(counter);",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 289,
          "old_api": "readAlphaMap",
          "new_api": null,
          "old_text": "readAlphaMap(rb)",
          "new_text": null,
          "old_line_content": "        readAlphaMap(rb);",
          "new_line_content": "        for (size_t i = 0; i < alpha_size; ++i)",
          "content_same": false
        },
        {
          "line": 295,
          "old_api": "readVarUInt",
          "new_api": null,
          "old_text": "readVarUInt(alpha_size, rb)",
          "new_text": null,
          "old_line_content": "        readVarUInt(alpha_size, rb);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 299,
          "old_api": "readVarUInt",
          "new_api": null,
          "old_text": "readVarUInt(alpha, rb)",
          "new_text": null,
          "old_line_content": "            readVarUInt(alpha, rb);",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 307,
          "old_api": "size",
          "new_api": null,
          "old_text": "counter_list.size()",
          "new_text": null,
          "old_line_content": "        counter->slot = counter_list.size();",
          "new_line_content": "    void percolate(Counter * counter)",
          "content_same": false
        },
        {
          "line": 308,
          "old_api": "push_back",
          "new_api": null,
          "old_text": "counter_list.push_back(counter)",
          "new_text": null,
          "old_line_content": "        counter_list.push_back(counter);",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 310,
          "old_api": "percolate",
          "new_api": null,
          "old_text": "percolate(counter)",
          "new_text": null,
          "old_line_content": "        percolate(counter);",
          "new_line_content": "        {",
          "content_same": false
        },
        {
          "line": 191,
          "old_api": "pop_back",
          "new_api": null,
          "old_text": "counter_list.pop_back()",
          "new_text": null,
          "old_line_content": "        counter_list.pop_back();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 321,
          "old_api": "std::swap(next->slot, counter->slot)",
          "new_api": null,
          "old_text": "std::swap(next->slot, counter->slot)",
          "new_text": null,
          "old_line_content": "                std::swap(next->slot, counter->slot);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 322,
          "old_api": "std::swap(counter_list[next->slot], counter_list[counter->slot])",
          "new_api": null,
          "old_text": "std::swap(counter_list[next->slot], counter_list[counter->slot])",
          "new_text": null,
          "old_line_content": "                std::swap(counter_list[next->slot], counter_list[counter->slot]);",
          "new_line_content": "private:",
          "content_same": false
        },
        {
          "line": 196,
          "old_api": "size",
          "new_api": null,
          "old_text": "counter_map.size()",
          "new_text": null,
          "old_line_content": "        if (removed_keys * 2 > counter_map.size())",
          "new_line_content": "     * Parallel Space Saving reduction and combine step from:",
          "content_same": false
        },
        {
          "line": 197,
          "old_api": "rebuildCounterMap",
          "new_api": null,
          "old_text": "rebuildCounterMap()",
          "new_text": null,
          "old_line_content": "            rebuildCounterMap();",
          "new_line_content": "     *  https://arxiv.org/pdf/1401.0702.pdf",
          "content_same": false
        },
        {
          "line": 199,
          "old_api": "emplace",
          "new_api": null,
          "old_text": "arena.emplace(key)",
          "new_text": null,
          "old_line_content": "        push(new Counter(arena.emplace(key), alpha + increment, alpha + error, hash));",
          "new_line_content": "    void merge(const Self & rhs)",
          "content_same": false
        },
        {
          "line": 336,
          "old_api": "clear",
          "new_api": null,
          "old_text": "counter_list.clear()",
          "new_text": null,
          "old_line_content": "        counter_list.clear();",
          "new_line_content": "        last_element->slot = -1;",
          "content_same": false
        },
        {
          "line": 213,
          "old_api": "back",
          "new_api": null,
          "old_text": "counter_list.back()",
          "new_text": null,
          "old_line_content": "            m1 = counter_list.back()->count;",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 342,
          "old_api": "back",
          "new_api": null,
          "old_text": "counter_list.back()",
          "new_text": null,
          "old_line_content": "        auto last_element = counter_list.back();",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 216,
          "old_api": "capacity",
          "new_api": null,
          "old_text": "rhs.capacity()",
          "new_text": null,
          "old_line_content": "        if (rhs.size() == rhs.capacity())",
          "new_line_content": "         * without mutating rhs table or creating new one",
          "content_same": false
        },
        {
          "line": 344,
          "old_api": "pop_back",
          "new_api": null,
          "old_text": "counter_list.pop_back()",
          "new_text": null,
          "old_line_content": "        counter_list.pop_back();",
          "new_line_content": "    Counter * findCounter(const TKey & key, size_t hash)",
          "content_same": false
        },
        {
          "line": 218,
          "old_api": "back",
          "new_api": null,
          "old_text": "rhs.counter_list.back()",
          "new_text": null,
          "old_line_content": "            m2 = rhs.counter_list.back()->count;",
          "new_line_content": "         * and in the second sweep we correct the error if they do.",
          "content_same": false
        },
        {
          "line": 348,
          "old_api": "rebuildCounterMap",
          "new_api": null,
          "old_text": "rebuildCounterMap()",
          "new_text": null,
          "old_line_content": "            rebuildCounterMap();",
          "new_line_content": "            return nullptr;",
          "content_same": false
        },
        {
          "line": 353,
          "old_api": "find",
          "new_api": null,
          "old_text": "counter_map.find(key, hash)",
          "new_text": null,
          "old_line_content": "        auto it = counter_map.find(key, hash);",
          "new_line_content": "    void rebuildCounterMap()",
          "content_same": false
        },
        {
          "line": 354,
          "old_api": "getSecond",
          "new_api": null,
          "old_text": "it->getSecond()",
          "new_text": null,
          "old_line_content": "        if (it == counter_map.end() || it->getSecond()->slot == -1)",
          "new_line_content": "    {",
          "content_same": false
        },
        {
          "line": 357,
          "old_api": "getSecond",
          "new_api": null,
          "old_text": "it->getSecond()",
          "new_text": null,
          "old_line_content": "        return it->getSecond();",
          "new_line_content": "        {",
          "content_same": false
        },
        {
          "line": 237,
          "old_api": "boost::adaptors::reverse(rhs.counter_list)",
          "new_api": null,
          "old_text": "boost::adaptors::reverse(rhs.counter_list)",
          "new_text": null,
          "old_line_content": "        for (auto counter : boost::adaptors::reverse(rhs.counter_list))",
          "new_line_content": "            else",
          "content_same": false
        },
        {
          "line": 365,
          "old_api": "getSecond",
          "new_api": null,
          "old_text": "cell.getSecond()",
          "new_text": null,
          "old_line_content": "            auto counter = cell.getSecond();",
          "new_line_content": "            counter_map[counter->key] = counter;",
          "content_same": false
        },
        {
          "line": 239,
          "old_api": "hash",
          "new_api": null,
          "old_text": "counter_map.hash(counter->key)",
          "new_text": null,
          "old_line_content": "            if (findCounter(counter->key, counter_map.hash(counter->key)))",
          "new_line_content": "                // Counters not monitored in S1",
          "content_same": false
        },
        {
          "line": 242,
          "old_api": "insert",
          "new_api": null,
          "old_text": "insert(counter->key, counter->count - m2, counter->error - m2)",
          "new_text": null,
          "old_line_content": "                insert(counter->key, counter->count - m2, counter->error - m2);",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 370,
          "old_api": "clear",
          "new_api": null,
          "old_text": "counter_map.clear()",
          "new_text": null,
          "old_line_content": "        counter_map.clear();",
          "new_line_content": "    CounterMap counter_map;",
          "content_same": false
        },
        {
          "line": 247,
          "old_api": "insert",
          "new_api": null,
          "old_text": "insert(counter->key, counter->count + m1, counter->error + m1)",
          "new_text": null,
          "old_line_content": "                insert(counter->key, counter->count + m1, counter->error + m1);",
          "new_line_content": "        std::vector<Counter> res;",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 10,
      "total_additions": 32,
      "total_deletions": 35,
      "total_api_changes": 77
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 8,
        "api_related_lines": 77,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          193,
          194,
          195
        ]
      }
    },
    "api_calls_before": 79,
    "api_calls_after": 76,
    "diff_info": {
      "added_lines": 1,
      "removed_lines": 8,
      "total_diff_lines": 21
    }
  }
}