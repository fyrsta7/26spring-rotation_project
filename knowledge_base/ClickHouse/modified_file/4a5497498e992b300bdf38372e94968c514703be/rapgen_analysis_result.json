{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/4a5497498e992b300bdf38372e94968c514703be",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/4a5497498e992b300bdf38372e94968c514703be/before.cpp",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/4a5497498e992b300bdf38372e94968c514703be/after.cpp",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/ClickHouse/modified_file/4a5497498e992b300bdf38372e94968c514703be/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 59,
          "old_api": "readRow",
          "new_api": "clear",
          "old_text": "readRow(columns, info)",
          "new_text": "info.read_columns.clear()",
          "old_line_content": "                if (!readRow(columns, info))",
          "new_line_content": "                info.read_columns.clear();",
          "content_same": false
        },
        {
          "line": 71,
          "old_api": "setBit",
          "new_api": "Exception",
          "old_text": "block_missing_values.setBit(column_idx, column_size - 1)",
          "new_text": "Exception(\"Unexpected empty column\", ErrorCodes::INCORRECT_NUMBER_OF_COLUMNS)",
          "old_line_content": "                        block_missing_values.setBit(column_idx, column_size - 1);",
          "new_line_content": "                            throw Exception(\"Unexpected empty column\", ErrorCodes::INCORRECT_NUMBER_OF_COLUMNS);",
          "content_same": false
        },
        {
          "line": 144,
          "old_api": "LOG_TRACE",
          "new_api": "Logger::get(\"IRowInputFormat\")",
          "old_text": "LOG_TRACE(log, \"Skipped \" << num_errors << \" rows with errors while reading the input stream\")",
          "new_text": "Logger::get(\"IRowInputFormat\")",
          "old_line_content": "            LOG_TRACE(log, \"Skipped \" << num_errors << \" rows with errors while reading the input stream\");",
          "new_line_content": "            Logger * log = &Logger::get(\"IRowInputFormat\");",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 129,
          "old_api": null,
          "new_api": "getDiagnosticInfo",
          "old_text": null,
          "new_text": "getDiagnosticInfo()",
          "old_line_content": "        }",
          "new_line_content": "            verbose_diagnostic = getDiagnosticInfo();",
          "content_same": false
        },
        {
          "line": 136,
          "old_api": null,
          "new_api": "toString",
          "old_text": null,
          "new_text": "toString(total_rows)",
          "old_line_content": "        throw;",
          "new_line_content": "        e.addMessage(\"(at row \" + toString(total_rows) + \")\\n\" + verbose_diagnostic);",
          "content_same": false
        },
        {
          "line": 140,
          "old_api": null,
          "new_api": "empty",
          "old_text": null,
          "new_text": "columns[0]->empty()",
          "old_line_content": "    {",
          "new_line_content": "    if (columns.empty() || columns[0]->empty())",
          "content_same": false
        },
        {
          "line": 145,
          "old_api": null,
          "new_api": "LOG_TRACE",
          "old_text": null,
          "new_text": "LOG_TRACE(log, \"Skipped \" << num_errors << \" rows with errors while reading the input stream\")",
          "old_line_content": "        }",
          "new_line_content": "            LOG_TRACE(log, \"Skipped \" << num_errors << \" rows with errors while reading the input stream\");",
          "content_same": false
        },
        {
          "line": 148,
          "old_api": null,
          "new_api": "readSuffix",
          "old_text": null,
          "new_text": "readSuffix()",
          "old_line_content": "        return {};",
          "new_line_content": "        readSuffix();",
          "content_same": false
        },
        {
          "line": 152,
          "old_api": null,
          "new_api": "front",
          "old_text": null,
          "new_text": "columns.front()->size()",
          "old_line_content": "    Chunk chunk(std::move(columns), num_rows);",
          "new_line_content": "    auto num_rows = columns.front()->size();",
          "content_same": false
        },
        {
          "line": 160,
          "old_api": null,
          "new_api": "Exception",
          "old_text": null,
          "new_text": "Exception(\"Method syncAfterError is not implemented for input format\", ErrorCodes::NOT_IMPLEMENTED)",
          "old_line_content": "}",
          "new_line_content": "    throw Exception(\"Method syncAfterError is not implemented for input format\", ErrorCodes::NOT_IMPLEMENTED);",
          "content_same": false
        },
        {
          "line": 165,
          "old_api": null,
          "new_api": "IInputFormat::resetParser()",
          "old_text": null,
          "new_text": "IInputFormat::resetParser()",
          "old_line_content": "    total_rows = 0;",
          "new_line_content": "    IInputFormat::resetParser();",
          "content_same": false
        },
        {
          "line": 168,
          "old_api": null,
          "new_api": "clear",
          "old_text": null,
          "new_text": "block_missing_values.clear()",
          "old_line_content": "}",
          "new_line_content": "    block_missing_values.clear();",
          "content_same": false
        },
        {
          "line": 60,
          "old_api": null,
          "new_api": "readRow",
          "old_text": null,
          "new_text": "readRow(columns, info)",
          "old_line_content": "                    break;",
          "new_line_content": "                if (!readRow(columns, info))",
          "content_same": false
        },
        {
          "line": 63,
          "old_api": null,
          "new_api": "callback",
          "old_text": null,
          "new_text": "params.callback()",
          "old_line_content": "",
          "new_line_content": "                    params.callback();",
          "content_same": false
        },
        {
          "line": 65,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "info.read_columns.size()",
          "old_line_content": "                {",
          "new_line_content": "                for (size_t column_idx = 0; column_idx < info.read_columns.size(); ++column_idx)",
          "content_same": false
        },
        {
          "line": 69,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "columns[column_idx]->size()",
          "old_line_content": "                        if (column_size == 0)",
          "new_line_content": "                        size_t column_size = columns[column_idx]->size();",
          "content_same": false
        },
        {
          "line": 72,
          "old_api": null,
          "new_api": "setBit",
          "old_text": null,
          "new_text": "block_missing_values.setBit(column_idx, column_size - 1)",
          "old_line_content": "                    }",
          "new_line_content": "                        block_missing_values.setBit(column_idx, column_size - 1);",
          "content_same": false
        },
        {
          "line": 80,
          "old_api": null,
          "new_api": "code",
          "old_text": null,
          "new_text": "e.code()",
          "old_line_content": "                    throw;",
          "new_line_content": "                if (!isParseError(e.code()))",
          "content_same": false
        },
        {
          "line": 87,
          "old_api": null,
          "new_api": "static_cast<Float64>(num_errors)",
          "old_text": null,
          "new_text": "static_cast<Float64>(num_errors)",
          "old_line_content": "",
          "new_line_content": "                Float64 current_error_ratio = static_cast<Float64>(num_errors) / total_rows;",
          "content_same": false
        },
        {
          "line": 94,
          "old_api": null,
          "new_api": "toString",
          "old_text": null,
          "new_text": "toString(current_error_ratio)",
          "old_line_content": "                    throw;",
          "new_line_content": "                        \", which is \" + toString(current_error_ratio) + \" of all rows)\");",
          "content_same": false
        },
        {
          "line": 98,
          "old_api": null,
          "new_api": "allowSyncAfterError",
          "old_text": null,
          "new_text": "allowSyncAfterError()",
          "old_line_content": "                {",
          "new_line_content": "                if (!allowSyncAfterError())",
          "content_same": false
        },
        {
          "line": 100,
          "old_api": null,
          "new_api": "addMessage",
          "old_text": null,
          "new_text": "e.addMessage(\"(Input format doesn't allow to skip errors)\")",
          "old_line_content": "                    throw;",
          "new_line_content": "                    e.addMessage(\"(Input format doesn't allow to skip errors)\");",
          "content_same": false
        },
        {
          "line": 104,
          "old_api": null,
          "new_api": "syncAfterError",
          "old_text": null,
          "new_text": "syncAfterError()",
          "old_line_content": "",
          "new_line_content": "                syncAfterError();",
          "content_same": false
        },
        {
          "line": 108,
          "old_api": null,
          "new_api": "std::numeric_limits<size_t>::max()",
          "old_text": null,
          "new_text": "std::numeric_limits<size_t>::max()",
          "old_line_content": "                for (size_t column_idx = 0; column_idx < num_columns; ++column_idx)",
          "new_line_content": "                size_t min_size = std::numeric_limits<size_t>::max();",
          "content_same": false
        },
        {
          "line": 110,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "columns[column_idx]->size()",
          "old_line_content": "",
          "new_line_content": "                    min_size = std::min(min_size, columns[column_idx]->size());",
          "content_same": false
        },
        {
          "line": 116,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "column->size()",
          "old_line_content": "                }",
          "new_line_content": "                        column->popBack(column->size() - min_size);",
          "content_same": false
        },
        {
          "line": 123,
          "old_api": null,
          "new_api": "code",
          "old_text": null,
          "new_text": "e.code()",
          "old_line_content": "            throw;",
          "new_line_content": "        if (!isParseError(e.code()))",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 128,
          "old_api": "getDiagnosticInfo",
          "new_api": null,
          "old_text": "getDiagnosticInfo()",
          "new_text": null,
          "old_line_content": "            verbose_diagnostic = getDiagnosticInfo();",
          "new_line_content": "        {",
          "content_same": false
        },
        {
          "line": 135,
          "old_api": "toString",
          "new_api": null,
          "old_text": "toString(total_rows)",
          "new_text": null,
          "old_line_content": "        e.addMessage(\"(at row \" + toString(total_rows) + \")\\n\" + verbose_diagnostic);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 139,
          "old_api": "empty",
          "new_api": null,
          "old_text": "columns[0]->empty()",
          "new_text": null,
          "old_line_content": "    if (columns.empty() || columns[0]->empty())",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 143,
          "old_api": "Logger::get(\"IRowInputFormat\")",
          "new_api": null,
          "old_text": "Logger::get(\"IRowInputFormat\")",
          "new_text": null,
          "old_line_content": "            Logger * log = &Logger::get(\"IRowInputFormat\");",
          "new_line_content": "        {",
          "content_same": false
        },
        {
          "line": 147,
          "old_api": "readSuffix",
          "new_api": null,
          "old_text": "readSuffix()",
          "new_text": null,
          "old_line_content": "        readSuffix();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 151,
          "old_api": "front",
          "new_api": null,
          "old_text": "columns.front()->size()",
          "new_text": null,
          "old_line_content": "    auto num_rows = columns.front()->size();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 159,
          "old_api": "Exception",
          "new_api": null,
          "old_text": "Exception(\"Method syncAfterError is not implemented for input format\", ErrorCodes::NOT_IMPLEMENTED)",
          "new_text": null,
          "old_line_content": "    throw Exception(\"Method syncAfterError is not implemented for input format\", ErrorCodes::NOT_IMPLEMENTED);",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 164,
          "old_api": "IInputFormat::resetParser()",
          "new_api": null,
          "old_text": "IInputFormat::resetParser()",
          "new_text": null,
          "old_line_content": "    IInputFormat::resetParser();",
          "new_line_content": "{",
          "content_same": false
        },
        {
          "line": 167,
          "old_api": "clear",
          "new_api": null,
          "old_text": "block_missing_values.clear()",
          "new_text": null,
          "old_line_content": "    block_missing_values.clear();",
          "new_line_content": "    num_errors = 0;",
          "content_same": false
        },
        {
          "line": 62,
          "old_api": "callback",
          "new_api": null,
          "old_text": "params.callback()",
          "new_text": null,
          "old_line_content": "                    params.callback();",
          "new_line_content": "                if (params.callback)",
          "content_same": false
        },
        {
          "line": 64,
          "old_api": "size",
          "new_api": null,
          "old_text": "info.read_columns.size()",
          "new_text": null,
          "old_line_content": "                for (size_t column_idx = 0; column_idx < info.read_columns.size(); ++column_idx)",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 68,
          "old_api": "size",
          "new_api": null,
          "old_text": "columns[column_idx]->size()",
          "new_text": null,
          "old_line_content": "                        size_t column_size = columns[column_idx]->size();",
          "new_line_content": "                    {",
          "content_same": false
        },
        {
          "line": 70,
          "old_api": "Exception",
          "new_api": null,
          "old_text": "Exception(\"Unexpected empty column\", ErrorCodes::INCORRECT_NUMBER_OF_COLUMNS)",
          "new_text": null,
          "old_line_content": "                            throw Exception(\"Unexpected empty column\", ErrorCodes::INCORRECT_NUMBER_OF_COLUMNS);",
          "new_line_content": "                        if (column_size == 0)",
          "content_same": false
        },
        {
          "line": 79,
          "old_api": "code",
          "new_api": null,
          "old_text": "e.code()",
          "new_text": null,
          "old_line_content": "                if (!isParseError(e.code()))",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 86,
          "old_api": "static_cast<Float64>(num_errors)",
          "new_api": null,
          "old_text": "static_cast<Float64>(num_errors)",
          "new_text": null,
          "old_line_content": "                Float64 current_error_ratio = static_cast<Float64>(num_errors) / total_rows;",
          "new_line_content": "                ++num_errors;",
          "content_same": false
        },
        {
          "line": 91,
          "old_api": "toString",
          "new_api": null,
          "old_text": "toString(num_errors)",
          "new_text": null,
          "old_line_content": "                    e.addMessage(\"(Already have \" + toString(num_errors) + \" errors\"",
          "new_line_content": "                {",
          "content_same": false
        },
        {
          "line": 97,
          "old_api": "allowSyncAfterError",
          "new_api": null,
          "old_text": "allowSyncAfterError()",
          "new_text": null,
          "old_line_content": "                if (!allowSyncAfterError())",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 99,
          "old_api": "addMessage",
          "new_api": null,
          "old_text": "e.addMessage(\"(Input format doesn't allow to skip errors)\")",
          "new_text": null,
          "old_line_content": "                    e.addMessage(\"(Input format doesn't allow to skip errors)\");",
          "new_line_content": "                {",
          "content_same": false
        },
        {
          "line": 103,
          "old_api": "syncAfterError",
          "new_api": null,
          "old_text": "syncAfterError()",
          "new_text": null,
          "old_line_content": "                syncAfterError();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 107,
          "old_api": "std::numeric_limits<size_t>::max()",
          "new_api": null,
          "old_text": "std::numeric_limits<size_t>::max()",
          "new_text": null,
          "old_line_content": "                size_t min_size = std::numeric_limits<size_t>::max();",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 109,
          "old_api": "size",
          "new_api": null,
          "old_text": "columns[column_idx]->size()",
          "new_text": null,
          "old_line_content": "                    min_size = std::min(min_size, columns[column_idx]->size());",
          "new_line_content": "                for (size_t column_idx = 0; column_idx < num_columns; ++column_idx)",
          "content_same": false
        },
        {
          "line": 114,
          "old_api": "size",
          "new_api": null,
          "old_text": "column->size()",
          "new_text": null,
          "old_line_content": "                    if (column->size() > min_size)",
          "new_line_content": "                    auto & column = columns[column_idx];",
          "content_same": false
        },
        {
          "line": 122,
          "old_api": "code",
          "new_api": null,
          "old_text": "e.code()",
          "new_text": null,
          "old_line_content": "        if (!isParseError(e.code()))",
          "new_line_content": "    {",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 3,
      "total_additions": 24,
      "total_deletions": 23,
      "total_api_changes": 50
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 3,
        "api_related_lines": 50,
        "non_api_lines": 2,
        "non_api_line_numbers": [
          58,
          52
        ]
      }
    },
    "api_calls_before": 43,
    "api_calls_after": 44,
    "diff_info": {
      "added_lines": 2,
      "removed_lines": 1,
      "total_diff_lines": 21
    }
  }
}