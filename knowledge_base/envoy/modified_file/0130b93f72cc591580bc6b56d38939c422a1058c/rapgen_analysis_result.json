{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/envoy/modified_file/0130b93f72cc591580bc6b56d38939c422a1058c",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/envoy/modified_file/0130b93f72cc591580bc6b56d38939c422a1058c/before.cc",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/envoy/modified_file/0130b93f72cc591580bc6b56d38939c422a1058c/after.cc",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/envoy/modified_file/0130b93f72cc591580bc6b56d38939c422a1058c/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 350,
          "old_api": "key",
          "new_api": "getStringView",
          "old_text": "entry.key()",
          "new_text": "entry->value().getStringView()",
          "old_line_content": "      if (entry.key() == storage_header_name_view) {",
          "new_line_content": "        absl::string_view storage_header_value = entry->value().getStringView();",
          "content_same": false
        },
        {
          "line": 351,
          "old_api": "value",
          "new_api": "StringUtil::splitToken(\n            storage_header_value, \",\", /*keep_empty_string=*/false, /*trim_whitespace=*/true)",
          "old_text": "entry.value().getStringView()",
          "new_text": "StringUtil::splitToken(\n            storage_header_value, \",\", /*keep_empty_string=*/false, /*trim_whitespace=*/true)",
          "old_line_content": "        absl::string_view storage_header_value = entry.value().getStringView();",
          "new_line_content": "        std::vector<absl::string_view> header_names = StringUtil::splitToken(",
          "content_same": false
        },
        {
          "line": 367,
          "old_api": "enumToInt",
          "new_api": "upstreamHeaderToAppendMatchers",
          "old_text": "enumToInt(Http::Code::OK)",
          "new_text": "config_->upstreamHeaderToAppendMatchers()",
          "old_line_content": "  if (status_code == enumToInt(Http::Code::OK)) {",
          "new_line_content": "                       config_->upstreamHeaderToAppendMatchers(),",
          "content_same": false
        },
        {
          "line": 372,
          "old_api": "std::move(headers_to_remove)",
          "new_api": "std::move(ok.response_)",
          "old_text": "std::move(headers_to_remove)",
          "new_text": "std::move(ok.response_)",
          "old_line_content": "                                std::move(headers_to_remove), EMPTY_STRING, Http::Code::OK,",
          "new_line_content": "    return std::move(ok.response_);",
          "content_same": false
        },
        {
          "line": 387,
          "old_api": "static_cast<Http::Code>(status_code)",
          "new_api": "std::move(denied.response_)",
          "old_text": "static_cast<Http::Code>(status_code)",
          "new_text": "std::move(denied.response_)",
          "old_line_content": "                                  static_cast<Http::Code>(status_code),",
          "new_line_content": "  return std::move(denied.response_);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 384,
          "old_api": null,
          "new_api": "bodyAsString",
          "old_text": null,
          "new_text": "message->bodyAsString()",
          "old_line_content": "                                  Http::HeaderVector{},",
          "new_line_content": "                                  message->bodyAsString(),",
          "content_same": false
        },
        {
          "line": 353,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "header_names.size()",
          "old_line_content": "            storage_header_value, \",\", /*keep_empty_string=*/false, /*trim_whitespace=*/true);",
          "new_line_content": "        headers_to_remove.reserve(headers_to_remove.size() + header_names.size());",
          "content_same": false
        },
        {
          "line": 385,
          "old_api": null,
          "new_api": "static_cast<Http::Code>(status_code)",
          "old_text": null,
          "new_text": "static_cast<Http::Code>(status_code)",
          "old_line_content": "                                  {{}},",
          "new_line_content": "                                  static_cast<Http::Code>(status_code),",
          "content_same": false
        },
        {
          "line": 355,
          "old_api": null,
          "new_api": "std::string(header_name)",
          "old_text": null,
          "new_text": "std::string(header_name)",
          "old_line_content": "        for (const auto header_name : header_names) {",
          "new_line_content": "          headers_to_remove.push_back(Http::LowerCaseString(std::string(header_name)));",
          "content_same": false
        },
        {
          "line": 362,
          "old_api": null,
          "new_api": "remove",
          "old_text": null,
          "new_text": "message->headers().remove(storage_header_name)",
          "old_line_content": "  // Now remove the storage header from the authz server response headers before",
          "new_line_content": "  message->headers().remove(storage_header_name);",
          "content_same": false
        },
        {
          "line": 365,
          "old_api": null,
          "new_api": "enumToInt",
          "old_text": null,
          "new_text": "enumToInt(Http::Code::OK)",
          "old_line_content": "",
          "new_line_content": "  if (status_code == enumToInt(Http::Code::OK)) {",
          "content_same": false
        },
        {
          "line": 366,
          "old_api": null,
          "new_api": "upstreamHeaderMatchers",
          "old_text": null,
          "new_text": "config_->upstreamHeaderMatchers()",
          "old_line_content": "  // Create an Ok authorization response.",
          "new_line_content": "    SuccessResponse ok{message->headers(), config_->upstreamHeaderMatchers(),",
          "content_same": false
        },
        {
          "line": 370,
          "old_api": null,
          "new_api": "std::move(headers_to_remove)",
          "old_text": null,
          "new_text": "std::move(headers_to_remove)",
          "old_line_content": "                       Response{CheckStatus::OK, ErrorKind::Other, Http::HeaderVector{},",
          "new_line_content": "                                std::move(headers_to_remove), EMPTY_STRING, Http::Code::OK,",
          "content_same": false
        },
        {
          "line": 376,
          "old_api": null,
          "new_api": "clientHeaderMatchers",
          "old_text": null,
          "new_text": "config_->clientHeaderMatchers()",
          "old_line_content": "",
          "new_line_content": "  SuccessResponse denied{message->headers(), config_->clientHeaderMatchers(),",
          "content_same": false
        },
        {
          "line": 377,
          "old_api": null,
          "new_api": "upstreamHeaderToAppendMatchers",
          "old_text": null,
          "new_text": "config_->upstreamHeaderToAppendMatchers()",
          "old_line_content": "  // Create a Denied authorization response.",
          "new_line_content": "                         config_->upstreamHeaderToAppendMatchers(),",
          "content_same": false
        },
        {
          "line": 346,
          "old_api": null,
          "new_api": "getAll",
          "old_text": null,
          "new_text": "message->headers().getAll(storage_header_name)",
          "old_line_content": "    // iterate() over the headers rather than just get() in case the storage",
          "new_line_content": "    const auto& get_result = message->headers().getAll(storage_header_name);",
          "content_same": false
        },
        {
          "line": 347,
          "old_api": null,
          "new_api": "size",
          "old_text": null,
          "new_text": "get_result.size()",
          "old_line_content": "    // header occurs more than once.",
          "new_line_content": "    for (size_t i = 0; i < get_result.size(); ++i) {",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 352,
          "old_api": "StringUtil::splitToken(\n            storage_header_value, \",\", /*keep_empty_string=*/false, /*trim_whitespace=*/true)",
          "new_api": null,
          "old_text": "StringUtil::splitToken(\n            storage_header_value, \",\", /*keep_empty_string=*/false, /*trim_whitespace=*/true)",
          "new_text": null,
          "old_line_content": "        std::vector<absl::string_view> header_names = StringUtil::splitToken(",
          "new_line_content": "            storage_header_value, \",\", /*keep_empty_string=*/false, /*trim_whitespace=*/true);",
          "content_same": false
        },
        {
          "line": 354,
          "old_api": "size",
          "new_api": null,
          "old_text": "header_names.size()",
          "new_text": null,
          "old_line_content": "        headers_to_remove.reserve(headers_to_remove.size() + header_names.size());",
          "new_line_content": "        for (const auto header_name : header_names) {",
          "content_same": false
        },
        {
          "line": 386,
          "old_api": "bodyAsString",
          "new_api": null,
          "old_text": "message->bodyAsString()",
          "new_text": null,
          "old_line_content": "                                  message->bodyAsString(),",
          "new_line_content": "                                  ProtobufWkt::Struct{}}};",
          "content_same": false
        },
        {
          "line": 356,
          "old_api": "std::string(header_name)",
          "new_api": null,
          "old_text": "std::string(header_name)",
          "new_text": null,
          "old_line_content": "          headers_to_remove.push_back(Http::LowerCaseString(std::string(header_name)));",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 389,
          "old_api": "std::move(denied.response_)",
          "new_api": null,
          "old_text": "std::move(denied.response_)",
          "new_text": null,
          "old_line_content": "  return std::move(denied.response_);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 364,
          "old_api": "remove",
          "new_api": null,
          "old_text": "message->headers().remove(storage_header_name)",
          "new_text": null,
          "old_line_content": "  message->headers().remove(storage_header_name);",
          "new_line_content": "  // Create an Ok authorization response.",
          "content_same": false
        },
        {
          "line": 368,
          "old_api": "upstreamHeaderMatchers",
          "new_api": null,
          "old_text": "config_->upstreamHeaderMatchers()",
          "new_text": null,
          "old_line_content": "    SuccessResponse ok{message->headers(), config_->upstreamHeaderMatchers(),",
          "new_line_content": "                       Response{CheckStatus::OK, ErrorKind::Other, Http::HeaderVector{},",
          "content_same": false
        },
        {
          "line": 369,
          "old_api": "upstreamHeaderToAppendMatchers",
          "new_api": null,
          "old_text": "config_->upstreamHeaderToAppendMatchers()",
          "new_text": null,
          "old_line_content": "                       config_->upstreamHeaderToAppendMatchers(),",
          "new_line_content": "                                Http::HeaderVector{}, Http::HeaderVector{},",
          "content_same": false
        },
        {
          "line": 374,
          "old_api": "std::move(ok.response_)",
          "new_api": null,
          "old_text": "std::move(ok.response_)",
          "new_text": null,
          "old_line_content": "    return std::move(ok.response_);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 378,
          "old_api": "clientHeaderMatchers",
          "new_api": null,
          "old_text": "config_->clientHeaderMatchers()",
          "new_text": null,
          "old_line_content": "  SuccessResponse denied{message->headers(), config_->clientHeaderMatchers(),",
          "new_line_content": "                         Response{CheckStatus::Denied,",
          "content_same": false
        },
        {
          "line": 379,
          "old_api": "upstreamHeaderToAppendMatchers",
          "new_api": null,
          "old_text": "config_->upstreamHeaderToAppendMatchers()",
          "new_text": null,
          "old_line_content": "                         config_->upstreamHeaderToAppendMatchers(),",
          "new_line_content": "                                  ErrorKind::Other,",
          "content_same": false
        },
        {
          "line": 348,
          "old_api": "get",
          "new_api": null,
          "old_text": "storage_header_name.get()",
          "new_text": null,
          "old_line_content": "    absl::string_view storage_header_name_view = absl::string_view(storage_header_name.get());",
          "new_line_content": "      const Http::HeaderEntry* entry = get_result[i];",
          "content_same": false
        },
        {
          "line": 349,
          "old_api": "iterate",
          "new_api": null,
          "old_text": "message->headers().iterate([&](const Http::HeaderEntry& entry) {\n      if (entry.key() == storage_header_name_view) {\n        absl::string_view storage_header_value = entry.value().getStringView();\n        std::vector<absl::string_view> header_names = StringUtil::splitToken(\n            storage_header_value, \",\", /*keep_empty_string=*/false, /*trim_whitespace=*/true);\n        headers_to_remove.reserve(headers_to_remove.size() + header_names.size());\n        for (const auto header_name : header_names) {\n          headers_to_remove.push_back(Http::LowerCaseString(std::string(header_name)));\n        }\n      }\n      return Http::HeaderMap::Iterate::Continue;\n    })",
          "new_text": null,
          "old_line_content": "    message->headers().iterate([&](const Http::HeaderEntry& entry) {",
          "new_line_content": "      if (entry != nullptr) {",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 5,
      "total_additions": 12,
      "total_deletions": 13,
      "total_api_changes": 30
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 9,
        "api_related_lines": 30,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          360,
          358,
          359
        ]
      }
    },
    "api_calls_before": 225,
    "api_calls_after": 223,
    "diff_info": {
      "added_lines": 6,
      "removed_lines": 8,
      "total_diff_lines": 33
    }
  }
}