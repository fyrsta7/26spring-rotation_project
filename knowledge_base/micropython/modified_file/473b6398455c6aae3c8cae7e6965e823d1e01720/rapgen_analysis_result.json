{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/micropython/modified_file/473b6398455c6aae3c8cae7e6965e823d1e01720",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/micropython/modified_file/473b6398455c6aae3c8cae7e6965e823d1e01720/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/micropython/modified_file/473b6398455c6aae3c8cae7e6965e823d1e01720/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/micropython/modified_file/473b6398455c6aae3c8cae7e6965e823d1e01720/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 162,
          "old_api": "read",
          "new_api": "mp_get_stream_raise",
          "old_text": "sock_stream->read(self->sock, buf, size, errcode)",
          "new_text": "mp_get_stream_raise(self->sock, MP_STREAM_OP_READ)",
          "old_line_content": "    mp_uint_t out_sz = sock_stream->read(self->sock, buf, size, errcode);",
          "new_line_content": "    const mp_stream_p_t *sock_stream = mp_get_stream_raise(self->sock, MP_STREAM_OP_READ);",
          "content_same": false
        },
        {
          "line": 201,
          "old_api": "read",
          "new_api": "MIN",
          "old_text": "sock_stream->read(self->sock, filebuf + 1, to_read, errcode)",
          "new_text": "MIN(sizeof(filebuf) - 1, self->data_to_recv)",
          "old_line_content": "            mp_uint_t sz = sock_stream->read(self->sock, filebuf + 1, to_read, errcode);",
          "new_line_content": "            size_t to_read = MIN(sizeof(filebuf) - 1, self->data_to_recv);",
          "content_same": false
        },
        {
          "line": 220,
          "old_api": "write_webrepl_resp",
          "new_api": "DEBUG_printf",
          "old_text": "write_webrepl_resp(self->sock, 0)",
          "new_text": "DEBUG_printf(\"webrepl: Finished writing file\\n\")",
          "old_line_content": "            write_webrepl_resp(self->sock, 0);",
          "new_line_content": "            DEBUG_printf(\"webrepl: Finished writing file\\n\");",
          "content_same": false
        },
        {
          "line": 230,
          "old_api": "write",
          "new_api": "mp_get_stream_raise",
          "old_text": "stream_p->write(self->sock, buf, size, errcode)",
          "new_text": "mp_get_stream_raise(self->sock, MP_STREAM_OP_WRITE)",
          "old_line_content": "    return stream_p->write(self->sock, buf, size, errcode);",
          "new_line_content": "    const mp_stream_p_t *stream_p = mp_get_stream_raise(self->sock, MP_STREAM_OP_WRITE);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 136,
          "old_api": null,
          "new_api": "DEBUG_printf",
          "old_text": null,
          "new_text": "DEBUG_printf(\"webrepl: Sending %d bytes of file\\n\", out_sz)",
          "old_line_content": "                break;",
          "new_line_content": "            DEBUG_printf(\"webrepl: Sending %d bytes of file\\n\", out_sz);",
          "content_same": false
        },
        {
          "line": 137,
          "old_api": null,
          "new_api": "write_webrepl",
          "old_text": null,
          "new_text": "write_webrepl(self->sock, readbuf, 2 + out_sz)",
          "old_line_content": "            }",
          "new_line_content": "            write_webrepl(self->sock, readbuf, 2 + out_sz);",
          "content_same": false
        },
        {
          "line": 143,
          "old_api": null,
          "new_api": "write_webrepl_resp",
          "old_text": null,
          "new_text": "write_webrepl_resp(self->sock, 0)",
          "old_line_content": "        self->hdr_to_recv = sizeof(struct webrepl_file);",
          "new_line_content": "        write_webrepl_resp(self->sock, 0);",
          "content_same": false
        },
        {
          "line": 153,
          "old_api": null,
          "new_api": "_webrepl_read",
          "old_text": null,
          "new_text": "_webrepl_read(self_in, buf, size, errcode)",
          "old_line_content": "    } while (out_sz == -2);",
          "new_line_content": "        out_sz = _webrepl_read(self_in, buf, size, errcode);",
          "content_same": false
        },
        {
          "line": 160,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(size == 1)",
          "old_line_content": "    mp_obj_webrepl_t *self = self_in;",
          "new_line_content": "    assert(size == 1);",
          "content_same": false
        },
        {
          "line": 163,
          "old_api": null,
          "new_api": "read",
          "old_text": null,
          "new_text": "sock_stream->read(self->sock, buf, size, errcode)",
          "old_line_content": "    if (out_sz == 0 || out_sz == MP_STREAM_ERROR) {",
          "new_line_content": "    mp_uint_t out_sz = sock_stream->read(self->sock, buf, size, errcode);",
          "content_same": false
        },
        {
          "line": 169,
          "old_api": null,
          "new_api": "ioctl",
          "old_text": null,
          "new_text": "sock_stream->ioctl(self->sock, MP_STREAM_GET_DATA_OPTS, 0, &err)",
          "old_line_content": "        return out_sz;",
          "new_line_content": "    if (sock_stream->ioctl(self->sock, MP_STREAM_GET_DATA_OPTS, 0, &err) == 1) {",
          "content_same": false
        },
        {
          "line": 173,
          "old_api": null,
          "new_api": "DEBUG_printf",
          "old_text": null,
          "new_text": "DEBUG_printf(\"webrepl: received bin data, hdr_to_recv: %d, data_to_recv=%d\\n\", self->hdr_to_recv, self->data_to_recv)",
          "old_line_content": "",
          "new_line_content": "    DEBUG_printf(\"webrepl: received bin data, hdr_to_recv: %d, data_to_recv=%d\\n\", self->hdr_to_recv, self->data_to_recv);",
          "content_same": false
        },
        {
          "line": 179,
          "old_api": null,
          "new_api": "read",
          "old_text": null,
          "new_text": "sock_stream->read(self->sock, p, self->hdr_to_recv, errcode)",
          "old_line_content": "            if (hdr_sz == MP_STREAM_ERROR) {",
          "new_line_content": "            mp_uint_t hdr_sz = sock_stream->read(self->sock, p, self->hdr_to_recv, errcode);",
          "content_same": false
        },
        {
          "line": 189,
          "old_api": null,
          "new_api": "DEBUG_printf",
          "old_text": null,
          "new_text": "DEBUG_printf(\"webrepl: op: %d, file: %s, chunk @%x, sz=%d\\n\", self->hdr.type, self->hdr.fname, (uint32_t)self->hdr.offset, self->hdr.size)",
          "old_line_content": "",
          "new_line_content": "        DEBUG_printf(\"webrepl: op: %d, file: %s, chunk @%x, sz=%d\\n\", self->hdr.type, self->hdr.fname, (uint32_t)self->hdr.offset, self->hdr.size);",
          "content_same": false
        },
        {
          "line": 191,
          "old_api": null,
          "new_api": "handle_op",
          "old_text": null,
          "new_text": "handle_op(self)",
          "old_line_content": "",
          "new_line_content": "        handle_op(self);",
          "content_same": false
        },
        {
          "line": 202,
          "old_api": null,
          "new_api": "read",
          "old_text": null,
          "new_text": "sock_stream->read(self->sock, filebuf + 1, to_read, errcode)",
          "old_line_content": "            if (sz == MP_STREAM_ERROR) {",
          "new_line_content": "            mp_uint_t sz = sock_stream->read(self->sock, filebuf + 1, to_read, errcode);",
          "content_same": false
        },
        {
          "line": 210,
          "old_api": null,
          "new_api": "DEBUG_printf",
          "old_text": null,
          "new_text": "DEBUG_printf(\"webrepl: Writing %lu bytes to file\\n\", buf_sz)",
          "old_line_content": "        int err;",
          "new_line_content": "        DEBUG_printf(\"webrepl: Writing %lu bytes to file\\n\", buf_sz);",
          "content_same": false
        },
        {
          "line": 212,
          "old_api": null,
          "new_api": "mp_stream_writeall",
          "old_text": null,
          "new_text": "mp_stream_writeall(self->cur_file, filebuf, buf_sz, &err)",
          "old_line_content": "        if(res == MP_STREAM_ERROR) {",
          "new_line_content": "        mp_uint_t res = mp_stream_writeall(self->cur_file, filebuf, buf_sz, &err);",
          "content_same": false
        },
        {
          "line": 214,
          "old_api": null,
          "new_api": "assert",
          "old_text": null,
          "new_text": "assert(0)",
          "old_line_content": "        }",
          "new_line_content": "            assert(0);",
          "content_same": false
        },
        {
          "line": 218,
          "old_api": null,
          "new_api": "close_meth",
          "old_text": null,
          "new_text": "close_meth(self->cur_file)",
          "old_line_content": "            self->hdr_to_recv = sizeof(struct webrepl_file);",
          "new_line_content": "            close_meth(self->cur_file);",
          "content_same": false
        },
        {
          "line": 221,
          "old_api": null,
          "new_api": "write_webrepl_resp",
          "old_text": null,
          "new_text": "write_webrepl_resp(self->sock, 0)",
          "old_line_content": "        }",
          "new_line_content": "            write_webrepl_resp(self->sock, 0);",
          "content_same": false
        },
        {
          "line": 231,
          "old_api": null,
          "new_api": "write",
          "old_text": null,
          "new_text": "stream_p->write(self->sock, buf, size, errcode)",
          "old_line_content": "}",
          "new_line_content": "    return stream_p->write(self->sock, buf, size, errcode);",
          "content_same": false
        },
        {
          "line": 236,
          "old_api": null,
          "new_api": "MP_OBJ_NEW_QSTR",
          "old_text": null,
          "new_text": "MP_OBJ_NEW_QSTR(MP_QSTR_write)",
          "old_line_content": "};",
          "new_line_content": "    { MP_OBJ_NEW_QSTR(MP_QSTR_write), (mp_obj_t)&mp_stream_write_obj },",
          "content_same": false
        },
        {
          "line": 255,
          "old_api": null,
          "new_api": "MP_OBJ_NEW_QSTR",
          "old_text": null,
          "new_text": "MP_OBJ_NEW_QSTR(MP_QSTR__webrepl)",
          "old_line_content": "};",
          "new_line_content": "    { MP_OBJ_NEW_QSTR(MP_QSTR__webrepl), (mp_obj_t)&webrepl_type },",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 134,
          "old_api": "write_webrepl",
          "new_api": null,
          "old_text": "write_webrepl(self->sock, &out_sz, 2)",
          "new_text": null,
          "old_line_content": "            write_webrepl(self->sock, &out_sz, 2);",
          "new_line_content": "            readbuf[0] = out_sz;",
          "content_same": false
        },
        {
          "line": 138,
          "old_api": "DEBUG_printf",
          "new_api": null,
          "old_text": "DEBUG_printf(\"webrepl: Sending %d bytes of file\\n\", out_sz)",
          "new_text": null,
          "old_line_content": "            DEBUG_printf(\"webrepl: Sending %d bytes of file\\n\", out_sz);",
          "new_line_content": "            if (out_sz == 0) {",
          "content_same": false
        },
        {
          "line": 139,
          "old_api": "write_webrepl",
          "new_api": null,
          "old_text": "write_webrepl(self->sock, readbuf, out_sz)",
          "new_text": null,
          "old_line_content": "            write_webrepl(self->sock, readbuf, out_sz);",
          "new_line_content": "                break;",
          "content_same": false
        },
        {
          "line": 142,
          "old_api": "write_webrepl_resp",
          "new_api": null,
          "old_text": "write_webrepl_resp(self->sock, 0)",
          "new_text": null,
          "old_line_content": "        write_webrepl_resp(self->sock, 0);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 152,
          "old_api": "_webrepl_read",
          "new_api": null,
          "old_text": "_webrepl_read(self_in, buf, size, errcode)",
          "new_text": null,
          "old_line_content": "        out_sz = _webrepl_read(self_in, buf, size, errcode);",
          "new_line_content": "    do {",
          "content_same": false
        },
        {
          "line": 159,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(size == 1)",
          "new_text": null,
          "old_line_content": "    assert(size == 1);",
          "new_line_content": "    // We know that os.dupterm always calls with size = 1",
          "content_same": false
        },
        {
          "line": 161,
          "old_api": "mp_get_stream_raise",
          "new_api": null,
          "old_text": "mp_get_stream_raise(self->sock, MP_STREAM_OP_READ)",
          "new_text": null,
          "old_line_content": "    const mp_stream_p_t *sock_stream = mp_get_stream_raise(self->sock, MP_STREAM_OP_READ);",
          "new_line_content": "    mp_obj_webrepl_t *self = self_in;",
          "content_same": false
        },
        {
          "line": 168,
          "old_api": "ioctl",
          "new_api": null,
          "old_text": "sock_stream->ioctl(self->sock, MP_STREAM_GET_DATA_OPTS, 0, &err)",
          "new_text": null,
          "old_line_content": "    if (sock_stream->ioctl(self->sock, MP_STREAM_GET_DATA_OPTS, 0, &err) == 1) {",
          "new_line_content": "    int err;",
          "content_same": false
        },
        {
          "line": 172,
          "old_api": "DEBUG_printf",
          "new_api": null,
          "old_text": "DEBUG_printf(\"webrepl: received bin data, hdr_to_recv: %d, data_to_recv=%d\\n\", self->hdr_to_recv, self->data_to_recv)",
          "new_text": null,
          "old_line_content": "    DEBUG_printf(\"webrepl: received bin data, hdr_to_recv: %d, data_to_recv=%d\\n\", self->hdr_to_recv, self->data_to_recv);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 178,
          "old_api": "read",
          "new_api": null,
          "old_text": "sock_stream->read(self->sock, p, self->hdr_to_recv, errcode)",
          "new_text": null,
          "old_line_content": "            mp_uint_t hdr_sz = sock_stream->read(self->sock, p, self->hdr_to_recv, errcode);",
          "new_line_content": "        if (--self->hdr_to_recv != 0) {",
          "content_same": false
        },
        {
          "line": 188,
          "old_api": "DEBUG_printf",
          "new_api": null,
          "old_text": "DEBUG_printf(\"webrepl: op: %d, file: %s, chunk @%x, sz=%d\\n\", self->hdr.type, self->hdr.fname, (uint32_t)self->hdr.offset, self->hdr.size)",
          "new_text": null,
          "old_line_content": "        DEBUG_printf(\"webrepl: op: %d, file: %s, chunk @%x, sz=%d\\n\", self->hdr.type, self->hdr.fname, (uint32_t)self->hdr.offset, self->hdr.size);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 190,
          "old_api": "handle_op",
          "new_api": null,
          "old_text": "handle_op(self)",
          "new_text": null,
          "old_line_content": "        handle_op(self);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 200,
          "old_api": "MIN",
          "new_api": null,
          "old_text": "MIN(sizeof(filebuf) - 1, self->data_to_recv)",
          "new_text": null,
          "old_line_content": "            size_t to_read = MIN(sizeof(filebuf) - 1, self->data_to_recv);",
          "new_line_content": "        if (--self->data_to_recv != 0) {",
          "content_same": false
        },
        {
          "line": 209,
          "old_api": "DEBUG_printf",
          "new_api": null,
          "old_text": "DEBUG_printf(\"webrepl: Writing %lu bytes to file\\n\", buf_sz)",
          "new_text": null,
          "old_line_content": "        DEBUG_printf(\"webrepl: Writing %lu bytes to file\\n\", buf_sz);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 211,
          "old_api": "mp_stream_writeall",
          "new_api": null,
          "old_text": "mp_stream_writeall(self->cur_file, filebuf, buf_sz, &err)",
          "new_text": null,
          "old_line_content": "        mp_uint_t res = mp_stream_writeall(self->cur_file, filebuf, buf_sz, &err);",
          "new_line_content": "        int err;",
          "content_same": false
        },
        {
          "line": 213,
          "old_api": "assert",
          "new_api": null,
          "old_text": "assert(0)",
          "new_text": null,
          "old_line_content": "            assert(0);",
          "new_line_content": "        if(res == MP_STREAM_ERROR) {",
          "content_same": false
        },
        {
          "line": 217,
          "old_api": "close_meth",
          "new_api": null,
          "old_text": "close_meth(self->cur_file)",
          "new_text": null,
          "old_line_content": "            close_meth(self->cur_file);",
          "new_line_content": "        if (self->data_to_recv == 0) {",
          "content_same": false
        },
        {
          "line": 219,
          "old_api": "DEBUG_printf",
          "new_api": null,
          "old_text": "DEBUG_printf(\"webrepl: Finished writing file\\n\")",
          "new_text": null,
          "old_line_content": "            DEBUG_printf(\"webrepl: Finished writing file\\n\");",
          "new_line_content": "            self->hdr_to_recv = sizeof(struct webrepl_file);",
          "content_same": false
        },
        {
          "line": 229,
          "old_api": "mp_get_stream_raise",
          "new_api": null,
          "old_text": "mp_get_stream_raise(self->sock, MP_STREAM_OP_WRITE)",
          "new_text": null,
          "old_line_content": "    const mp_stream_p_t *stream_p = mp_get_stream_raise(self->sock, MP_STREAM_OP_WRITE);",
          "new_line_content": "    mp_obj_webrepl_t *self = self_in;",
          "content_same": false
        },
        {
          "line": 234,
          "old_api": "MP_OBJ_NEW_QSTR",
          "new_api": null,
          "old_text": "MP_OBJ_NEW_QSTR(MP_QSTR_read)",
          "new_text": null,
          "old_line_content": "    { MP_OBJ_NEW_QSTR(MP_QSTR_read), (mp_obj_t)&mp_stream_read_obj },",
          "new_line_content": "STATIC const mp_map_elem_t webrepl_locals_dict_table[] = {",
          "content_same": false
        },
        {
          "line": 253,
          "old_api": "MP_OBJ_NEW_QSTR",
          "new_api": null,
          "old_text": "MP_OBJ_NEW_QSTR(MP_QSTR_websocket)",
          "new_text": null,
          "old_line_content": "    { MP_OBJ_NEW_QSTR(MP_QSTR___name__), MP_OBJ_NEW_QSTR(MP_QSTR_websocket) },",
          "new_line_content": "STATIC const mp_map_elem_t webrepl_module_globals_table[] = {",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 4,
      "total_additions": 20,
      "total_deletions": 21,
      "total_api_changes": 45
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 8,
        "api_related_lines": 45,
        "non_api_lines": 3,
        "non_api_line_numbers": [
          132,
          127,
          135
        ]
      }
    },
    "api_calls_before": 50,
    "api_calls_after": 49,
    "diff_info": {
      "added_lines": 6,
      "removed_lines": 5,
      "total_diff_lines": 31
    }
  }
}