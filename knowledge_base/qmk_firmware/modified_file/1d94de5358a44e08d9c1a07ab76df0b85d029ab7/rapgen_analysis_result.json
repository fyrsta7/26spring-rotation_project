{
  "status": "completed",
  "commit_dir": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/qmk_firmware/modified_file/1d94de5358a44e08d9c1a07ab76df0b85d029ab7",
  "file_info": {
    "before_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/qmk_firmware/modified_file/1d94de5358a44e08d9c1a07ab76df0b85d029ab7/before.c",
    "after_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/qmk_firmware/modified_file/1d94de5358a44e08d9c1a07ab76df0b85d029ab7/after.c",
    "diff_file": "/home/zyw/llm_on_code/llm_on_code_optimization/knowledge_base/qmk_firmware/modified_file/1d94de5358a44e08d9c1a07ab76df0b85d029ab7/diff.txt"
  },
  "semgrep_analysis": {
    "is_api_change": false,
    "api_changes": {
      "replacements": [
        {
          "line": 295,
          "old_api": "palSetLineMode",
          "new_api": "dacStart",
          "old_text": "palSetLineMode(A5, PAL_MODE_INPUT_ANALOG)",
          "new_text": "dacStart(&DACD1, &dac_conf)",
          "old_line_content": "        palSetLineMode(A5, PAL_MODE_INPUT_ANALOG);",
          "new_line_content": "        dacStart(&DACD1, &dac_conf);",
          "content_same": false
        }
      ],
      "additions": [
        {
          "line": 225,
          "old_api": null,
          "new_api": "audio_get_number_of_active_tones",
          "old_text": null,
          "new_text": "audio_get_number_of_active_tones()",
          "old_line_content": "            // -> saves cpu cycles (?)",
          "new_line_content": "            uint8_t active_tones         = MIN(AUDIO_MAX_SIMULTANEOUS_TONES, audio_get_number_of_active_tones());",
          "content_same": false
        },
        {
          "line": 290,
          "old_api": null,
          "new_api": "DAC_TRG",
          "old_text": null,
          "new_text": "DAC_TRG(0b000)",
          "old_line_content": "    if ((AUDIO_PIN == A4) || (AUDIO_PIN_ALT == A4)) {",
          "new_line_content": "static const DACConversionGroup dac_conv_cfg = {.num_channels = 1U, .end_cb = dac_end, .error_cb = dac_error, .trigger = DAC_TRG(0b000)};",
          "content_same": false
        },
        {
          "line": 323,
          "old_api": null,
          "new_api": "dacPutChannelX",
          "old_text": null,
          "new_text": "dacPutChannelX(&DACD1, 0, AUDIO_DAC_OFF_VALUE)",
          "old_line_content": "    }",
          "new_line_content": "        dacPutChannelX(&DACD1, 0, AUDIO_DAC_OFF_VALUE);",
          "content_same": false
        },
        {
          "line": 325,
          "old_api": null,
          "new_api": "dacPutChannelX",
          "old_text": null,
          "new_text": "dacPutChannelX(&DACD2, 0, AUDIO_DAC_OFF_VALUE)",
          "old_line_content": "",
          "new_line_content": "        dacPutChannelX(&DACD2, 0, AUDIO_DAC_OFF_VALUE);",
          "content_same": false
        },
        {
          "line": 294,
          "old_api": null,
          "new_api": "palSetLineMode",
          "old_text": null,
          "new_text": "palSetLineMode(A4, PAL_MODE_INPUT_ANALOG)",
          "old_line_content": "    if ((AUDIO_PIN == A5) || (AUDIO_PIN_ALT == A5)) {",
          "new_line_content": "        palSetLineMode(A4, PAL_MODE_INPUT_ANALOG);",
          "content_same": false
        },
        {
          "line": 230,
          "old_api": null,
          "new_api": "audio_get_processed_frequency",
          "old_text": null,
          "new_text": "audio_get_processed_frequency(i)",
          "old_line_content": "                }",
          "new_line_content": "                float freq = audio_get_processed_frequency(i);",
          "content_same": false
        },
        {
          "line": 329,
          "old_api": null,
          "new_api": "gptStart",
          "old_text": null,
          "new_text": "gptStart(&GPTD6, &gpt6cfg1)",
          "old_line_content": "void audio_driver_stop(void) {",
          "new_line_content": "    gptStart(&GPTD6, &gpt6cfg1);",
          "content_same": false
        },
        {
          "line": 266,
          "old_api": null,
          "new_api": "chSysHalt",
          "old_text": null,
          "new_text": "chSysHalt(\"DAC failure. halp\")",
          "old_line_content": "static const GPTConfig gpt6cfg1 = {.frequency = AUDIO_DAC_SAMPLE_RATE * 3,",
          "new_line_content": "    chSysHalt(\"DAC failure. halp\");",
          "content_same": false
        },
        {
          "line": 299,
          "old_api": null,
          "new_api": "dacStart",
          "old_text": null,
          "new_text": "dacStart(&DACD2, &dac_conf)",
          "old_line_content": "    /* enable the output buffer, to directly drive external loads with no additional circuitry",
          "new_line_content": "        dacStart(&DACD2, &dac_conf);",
          "content_same": false
        },
        {
          "line": 298,
          "old_api": null,
          "new_api": "palSetLineMode",
          "old_text": null,
          "new_text": "palSetLineMode(A5, PAL_MODE_INPUT_ANALOG)",
          "old_line_content": "",
          "new_line_content": "        palSetLineMode(A5, PAL_MODE_INPUT_ANALOG);",
          "content_same": false
        },
        {
          "line": 337,
          "old_api": null,
          "new_api": "gptStartContinuous",
          "old_text": null,
          "new_text": "gptStartContinuous(&GPTD6, 2U)",
          "old_line_content": "        dac_if[i]                = 0.0f;",
          "new_line_content": "    gptStartContinuous(&GPTD6, 2U);",
          "content_same": false
        },
        {
          "line": 181,
          "old_api": null,
          "new_api": "dacIsBufferComplete",
          "old_text": null,
          "new_text": "dacIsBufferComplete(dacp)",
          "old_line_content": "",
          "new_line_content": "    if (dacIsBufferComplete(dacp)) {",
          "content_same": false
        },
        {
          "line": 246,
          "old_api": null,
          "new_api": "audio_update_state",
          "old_text": null,
          "new_text": "audio_update_state()",
          "old_line_content": "        }",
          "new_line_content": "    if (audio_update_state()) {",
          "content_same": false
        },
        {
          "line": 315,
          "old_api": null,
          "new_api": "dacStartConversion",
          "old_text": null,
          "new_text": "dacStartConversion(&DACD1, &dac_conv_cfg, dac_buffer_empty, AUDIO_DAC_BUFFER_SIZE)",
          "old_line_content": "    }",
          "new_line_content": "        dacStartConversion(&DACD1, &dac_conv_cfg, dac_buffer_empty, AUDIO_DAC_BUFFER_SIZE);",
          "content_same": false
        },
        {
          "line": 317,
          "old_api": null,
          "new_api": "dacStartConversion",
          "old_text": null,
          "new_text": "dacStartConversion(&DACD2, &dac_conv_cfg, dac_buffer_empty, AUDIO_DAC_BUFFER_SIZE)",
          "old_line_content": "    // no inverted/out-of-phase waveform (yet?), only pulling AUDIO_PIN_ALT to AUDIO_DAC_OFF_VALUE",
          "new_line_content": "        dacStartConversion(&DACD2, &dac_conv_cfg, dac_buffer_empty, AUDIO_DAC_BUFFER_SIZE);",
          "content_same": false
        },
        {
          "line": 190,
          "old_api": null,
          "new_api": "dac_value_generate",
          "old_text": null,
          "new_text": "dac_value_generate()",
          "old_line_content": "        /* zero crossing (or approach, whereas zero == DAC_OFF_VALUE, which can be configured to anything from 0 to DAC_SAMPLE_MAX)",
          "new_line_content": "            sample_p[s] = dac_value_generate();",
          "content_same": false
        },
        {
          "line": 255,
          "old_api": null,
          "new_api": "gptStopTimer",
          "old_text": null,
          "new_text": "gptStopTimer(&GPTD6)",
          "old_line_content": "        }",
          "new_line_content": "            gptStopTimer(&GPTD6);",
          "content_same": false
        }
      ],
      "deletions": [
        {
          "line": 320,
          "old_api": "dacPutChannelX",
          "new_api": null,
          "old_text": "dacPutChannelX(&DACD1, 0, AUDIO_DAC_OFF_VALUE)",
          "new_text": null,
          "old_line_content": "        dacPutChannelX(&DACD1, 0, AUDIO_DAC_OFF_VALUE);",
          "new_line_content": "    // no inverted/out-of-phase waveform (yet?), only pulling AUDIO_PIN_ALT to AUDIO_DAC_OFF_VALUE",
          "content_same": false
        },
        {
          "line": 322,
          "old_api": "dacPutChannelX",
          "new_api": null,
          "old_text": "dacPutChannelX(&DACD2, 0, AUDIO_DAC_OFF_VALUE)",
          "new_text": null,
          "old_line_content": "        dacPutChannelX(&DACD2, 0, AUDIO_DAC_OFF_VALUE);",
          "new_line_content": "    if (AUDIO_PIN_ALT == A4) {",
          "content_same": false
        },
        {
          "line": 291,
          "old_api": "palSetLineMode",
          "new_api": null,
          "old_text": "palSetLineMode(A4, PAL_MODE_INPUT_ANALOG)",
          "new_text": null,
          "old_line_content": "        palSetLineMode(A4, PAL_MODE_INPUT_ANALOG);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 292,
          "old_api": "dacStart",
          "new_api": null,
          "old_text": "dacStart(&DACD1, &dac_conf)",
          "new_text": null,
          "old_line_content": "        dacStart(&DACD1, &dac_conf);",
          "new_line_content": "void audio_driver_initialize(void) {",
          "content_same": false
        },
        {
          "line": 227,
          "old_api": "audio_get_processed_frequency",
          "new_api": null,
          "old_text": "audio_get_processed_frequency(i)",
          "new_text": null,
          "old_line_content": "                float freq = audio_get_processed_frequency(i);",
          "new_line_content": "            // update the snapshot - once, and only on occasion that something changed;",
          "content_same": false
        },
        {
          "line": 326,
          "old_api": "gptStart",
          "new_api": null,
          "old_text": "gptStart(&GPTD6, &gpt6cfg1)",
          "new_text": null,
          "old_line_content": "    gptStart(&GPTD6, &gpt6cfg1);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 263,
          "old_api": "chSysHalt",
          "new_api": null,
          "old_text": "chSysHalt(\"DAC failure. halp\")",
          "new_text": null,
          "old_line_content": "    chSysHalt(\"DAC failure. halp\");",
          "new_line_content": "    (void)dacp;",
          "content_same": false
        },
        {
          "line": 296,
          "old_api": "dacStart",
          "new_api": null,
          "old_text": "dacStart(&DACD2, &dac_conf)",
          "new_text": null,
          "old_line_content": "        dacStart(&DACD2, &dac_conf);",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 138,
          "old_api": "fmodf",
          "new_api": null,
          "old_text": "fmodf(dac_if[i], AUDIO_DAC_BUFFER_SIZE)",
          "new_text": null,
          "old_line_content": "        dac_if[i] = fmodf(dac_if[i], AUDIO_DAC_BUFFER_SIZE);",
          "new_line_content": "",
          "content_same": false
        },
        {
          "line": 334,
          "old_api": "gptStartContinuous",
          "new_api": null,
          "old_text": "gptStartContinuous(&GPTD6, 2U)",
          "new_text": null,
          "old_line_content": "    gptStartContinuous(&GPTD6, 2U);",
          "new_line_content": "}",
          "content_same": false
        },
        {
          "line": 178,
          "old_api": "dacIsBufferComplete",
          "new_api": null,
          "old_text": "dacIsBufferComplete(dacp)",
          "new_text": null,
          "old_line_content": "    if (dacIsBufferComplete(dacp)) {",
          "new_line_content": "    dacsample_t *sample_p = (dacp)->samples;",
          "content_same": false
        },
        {
          "line": 243,
          "old_api": "audio_update_state",
          "new_api": null,
          "old_text": "audio_update_state()",
          "new_text": null,
          "old_line_content": "    if (audio_update_state()) {",
          "new_line_content": "    }",
          "content_same": false
        },
        {
          "line": 312,
          "old_api": "dacStartConversion",
          "new_api": null,
          "old_text": "dacStartConversion(&DACD1, &dac_conv_cfg, dac_buffer_empty, AUDIO_DAC_BUFFER_SIZE)",
          "new_text": null,
          "old_line_content": "        dacStartConversion(&DACD1, &dac_conv_cfg, dac_buffer_empty, AUDIO_DAC_BUFFER_SIZE);",
          "new_line_content": "    DACD2.params->dac->CR &= ~DAC_CR_BOFF2;",
          "content_same": false
        },
        {
          "line": 314,
          "old_api": "dacStartConversion",
          "new_api": null,
          "old_text": "dacStartConversion(&DACD2, &dac_conv_cfg, dac_buffer_empty, AUDIO_DAC_BUFFER_SIZE)",
          "new_text": null,
          "old_line_content": "        dacStartConversion(&DACD2, &dac_conv_cfg, dac_buffer_empty, AUDIO_DAC_BUFFER_SIZE);",
          "new_line_content": "    if (AUDIO_PIN == A4) {",
          "content_same": false
        },
        {
          "line": 187,
          "old_api": "dac_value_generate",
          "new_api": null,
          "old_text": "dac_value_generate()",
          "new_text": null,
          "old_line_content": "            sample_p[s] = dac_value_generate();",
          "new_line_content": "            sample_p[s] = AUDIO_DAC_OFF_VALUE;",
          "content_same": false
        },
        {
          "line": 252,
          "old_api": "gptStopTimer",
          "new_api": null,
          "old_text": "gptStopTimer(&GPTD6)",
          "new_text": null,
          "old_line_content": "            gptStopTimer(&GPTD6);",
          "new_line_content": "    if (OUTPUT_OFF <= state) {",
          "content_same": false
        },
        {
          "line": 222,
          "old_api": "audio_get_number_of_active_tones",
          "new_api": null,
          "old_text": "audio_get_number_of_active_tones()",
          "new_text": null,
          "old_line_content": "            uint8_t active_tones         = MIN(AUDIO_MAX_SIMULTANEOUS_TONES, audio_get_number_of_active_tones());",
          "new_line_content": "        }",
          "content_same": false
        },
        {
          "line": 287,
          "old_api": "DAC_TRG",
          "new_api": null,
          "old_text": "DAC_TRG(0b000)",
          "new_text": null,
          "old_line_content": "static const DACConversionGroup dac_conv_cfg = {.num_channels = 1U, .end_cb = dac_end, .error_cb = dac_error, .trigger = DAC_TRG(0b000)};",
          "new_line_content": " * EXTI9      0b110",
          "content_same": false
        }
      ]
    },
    "api_summary": {
      "total_replacements": 1,
      "total_additions": 17,
      "total_deletions": 18,
      "total_api_changes": 36
    },
    "non_api_changes": {
      "has_non_api_changes": true,
      "evidence": {
        "total_diff_lines": 10,
        "api_related_lines": 36,
        "non_api_lines": 9,
        "non_api_line_numbers": [
          132,
          133,
          139,
          140,
          141,
          144,
          124,
          125,
          127
        ]
      }
    },
    "api_calls_before": 21,
    "api_calls_after": 20,
    "diff_info": {
      "added_lines": 9,
      "removed_lines": 6,
      "total_diff_lines": 39
    }
  }
}